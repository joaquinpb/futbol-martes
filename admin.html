<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración Fútbol 5</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter para una mejor legibilidad */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Un gris claro para el fondo */
            min-height: 100vh; /* Asegura que el cuerpo ocupe toda la altura del viewport */
            margin: 0; /* Elimina el margen predeterminado del body */
            padding: 0; /* Elimina el padding predeterminado del body */
            /* REMOVED: display: flex; - Removed to simplify layout with fixed sidebar */
            /* REMOVED: align-items: start; - Removed with flex */
        }
        /* Estilos para el efecto de arrastre */
        .player-draggable {
            @apply bg-white p-2 rounded-md shadow-sm mb-2 flex justify-between items-center;
            cursor: grab; /* Cambia el cursor a una mano al pasar el ratón */
        }
        .player-draggable:active {
            cursor: grabbing; /* Cambia el cursor a una mano agarrando al hacer clic */
        }
        /* Nueva clase para feedback visual al arrastrar con toque */
        .player-draggable.dragging-touch {
            opacity: 0.7;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        /* Estilo para el botón de cerrar sesión (Cruz) */
        .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #ef4444; /* Rojo 500 de Tailwind */
            cursor: pointer;
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem;
            border-radius: 9999px; /* Fully rounded */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .close-button:hover {
            background-color: #fecaca; /* Rojo 100 de Tailwind */
            color: #dc2626; /* Rojo 600 de Tailwind */
        }
        /* Estilo para los elementos de la lista de partidos seleccionables */
        .match-item {
            @apply bg-white p-3 rounded-md shadow-sm mb-2 cursor-pointer hover:bg-gray-100 transition duration-150 ease-in-out;
        }
        .match-item.selected {
            @apply bg-indigo-100 border-l-4 border-indigo-500;
        }
        /* Nuevos estilos para el sombreado de partidos */
        .match-item.no-result {
            background-color: #fee2e2; /* bg-red-100 pastel */
        }
        .match-item.has-result {
            background-color: #dcfce7; /* bg-green-100 pastel */
        }

        /* Estilos para la tabla de posiciones (tomados de index.html) - Mantenidos por si se usan en otra parte, aunque la sección principal se elimina */
        #leaderboard-table-admin {
            @apply min-w-full bg-white rounded-lg shadow-md;
        }
        #leaderboard-table-admin th, #leaderboard-table-admin td {
            @apply py-3 px-6 text-left;
        }
        /* Encabezado de la tabla: fondo negro, texto blanco */
        #leaderboard-table-admin thead th {
            background-color: #1a202c !important; /* Fondo negro (bg-gray-900) */
            color: #ffffff !important; /* Texto blanco (text-white) */
            text-transform: uppercase;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* leading-normal */
        }
        #leaderboard-table-admin tbody tr:nth-child(odd) {
            background-color: #f7fafc !important; /* Gris muy claro (bg-gray-100) */
        }
        #leaderboard-table-admin tbody tr:nth-child(even) {
            background-color: #edf2f7 !important; /* Gris ligeramente más oscuro (bg-gray-200) */
        }
        #leaderboard-table-admin tbody tr {
            border-bottom: 1px solid #cbd5e0; /* border-gray-300 */
            transition: background-color 150ms ease-in-out; /* transition duration-150 ease-in-out */
        }
        #leaderboard-table-admin tbody tr:hover {
            background-color: #e2e8f0 !important; /* Tono de gris al pasar el cursor (hover:bg-gray-300) */
        }
        #leaderboard-table-admin tbody tr:last-child {
            border-bottom: 0; /* Eliminar borde inferior de la última fila */
        }
        #leaderboard-table-admin tbody td {
            color: #4a5568; /* text-gray-600 */
        }

        /* --- Estilos para el menú lateral responsivo --- */
        #side-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 256px; /* w-64 */
            background-color: #312e81; /* indigo-800 */
            color: white;
            transform: translateX(-100%); /* Hidden by default */
            transition: transform 0.3s ease-in-out;
            z-index: 40;
            display: flex; /* Use flex for vertical layout of tabs */
            flex-direction: column;
            padding-top: 1rem; /* Add some padding at the top */
        }

        #side-menu.open {
            transform: translateX(0); /* Show when open */
        }

        #overlay {
            position: fixed;
            inset: 0; /* top:0, right:0, bottom:0, left:0 */
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            display: none; /* Hidden by default */
        }

        #overlay.open {
            display: block; /* Show when side menu is open (mobile only) */
        }

        #hamburger-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 50;
            padding: 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
        }

        #close-side-menu-button {
            background: none;
            border: none;
            font-size: 2rem; /* text-2xl */
            color: white;
            cursor: pointer;
            padding: 0.5rem;
        }

        #side-menu .tab-button, #side-menu .sidebar-link {
            padding-left: 1.5rem; /* px-6 */
            padding-right: 1.5rem; /* px-6 */
            text-align: left;
            width: 100%; /* Full width within sidebar */
            border-radius: 0; /* No rounded corners for vertical tabs */
            margin-bottom: 0.25rem; /* mb-1 */
            color: white; /* Text white for dark sidebar */
            transition: background-color 0.15s ease-in-out;
            display: flex; /* Para alinear el texto y el icono */
            align-items: center; /* Para alinear el texto y el icono */
            gap: 0.5rem; /* Espacio entre texto e icono */
        }
        #side-menu .tab-button.active {
            background-color: #4338ca; /* indigo-700 */
        }
        #side-menu .tab-button:hover, #side-menu .sidebar-link:hover {
            background-color: #4f46e5; /* indigo-600 */
        }

        #signout_button_sidebar,
        #signout_button_mobile_sidebar {
            margin-bottom: 2rem; /* Unificado: 2rem de separación del borde inferior */
        }

        @media (min-width: 768px) {
            #side-menu.open {
                width: 256px; /* Wider for desktop */
                background-color: #312e81; /* indigo-800 - Corrected color */
                color: white; /* Ensure text remains white on dark background */
                border-right: 1px solid #e2e8f0; /* border-gray-200 */
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
                transform: translateX(0) !important; /* Always open on desktop when 'open' class is present */
            }

            #side-menu.open .tab-button, #side-menu.open .sidebar-link {
                color: white; /* Ensure text remains white on dark background */
            }
            #side-menu.open .tab-button.active {
                background-color: #4338ca; /* indigo-700 */
                color: white; /* Ensure text remains white on dark background */
                border-left: 4px solid #4f46e5; /* border-indigo-500 */
            }
            #side-menu.open .tab-button:hover, #side-menu.open .sidebar-link:hover {
                background-color: #4f46e5; /* indigo-600 */
            }

            .main-admin-content-container {
                margin: 2rem; /* Add some margin around the main content */
                /* Adjusted max-width to account for sidebar and margins */
                max-width: calc(100% - 256px - 4rem); /* Sidebar width + 2rem left + 2rem right margin */
            }
            #signout_button_mobile_sidebar {
                display: none !important;
            }
            #signout_button_sidebar {
                display: block !important;
            }
            #overlay {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-0">
    <!-- Hamburger Button (visible on all screens) -->
    <button id="hamburger-button" class="fixed top-4 left-4 z-50 p-2 rounded-md bg-indigo-600 text-white shadow-lg hidden">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <!-- Side Navigation Menu (fixed, slides in/out on all screens) -->
    <nav id="side-menu" class="fixed top-0 left-0 h-full w-64 bg-indigo-800 text-white transform -translate-x-full transition-transform duration-300 ease-in-out z-40 hidden">
        <div class="p-4 text-right">
            <button id="close-side-menu-button" class="text-white text-2xl">&times;</button>
        </div>
        <div class="flex flex-col p-4 md:p-0 md:space-y-2 flex-1">
            <!-- Reordered tab buttons -->
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="team-formation">Armar Equipos</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="players-management">Gestionar Jugadores</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="match-results">Resultados</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="chamigo-management">Chamigo</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="tt-attendance">TT</button>
            <!-- ENLACE A TABLA DE POSICIONES EXTERNA -->
            <a href="index.html" target="_blank" rel="noopener noreferrer" class="sidebar-link py-2 px-4 text-white font-medium hover:bg-indigo-700">
                <span>Tabla de Posiciones</span>
                <!-- Icono de nueva pestaña (SVG) -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1">
                    <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 18h-8.5A2.25 2.25 0 012 15.25v-8.5C2 4.75 3.25 3.5 4.75 3.5h4a.75.75 0 010 1.5h-4z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M15.75 3a.75.75 0 01.75.75V9a.75.75 0 01-1.5 0V5.06L10.22 10.53a.75.75 0 01-1.06-1.06l5.47-5.47H12a.75.75 0 010-1.5h3.75z" clip-rule="evenodd" />
                </svg>
            </a>
        </div>
        <!-- Signout button for mobile sidebar -->
        <button id="signout_button_mobile_sidebar" class="md:hidden mx-4 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 hidden">
            Cerrar Sesión
        </button>
        <!-- Signout button inside sidebar for desktop -->
        <button id="signout_button_sidebar" class="hidden mx-4 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
            Cerrar Sesión
        </button>
    </nav>

    <!-- Overlay for when side menu is open (visible on mobile only) -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

    <!-- Main Content Area -->
    <div class="main-admin-content-container bg-white p-8 rounded-xl shadow-lg w-full max-w-5xl relative md:ml-64 mx-auto">
        <h1 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">Panel de Administración</h1>

        <!-- Authentication buttons (only authorize button remains here) -->
        <div class="flex justify-center space-x-4 mb-8">
            <button id="authorize_button" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                Autorizar Google Sheets
            </button>
        </div>

        <!-- Message for auth status -->
        <p id="auth-status" class="text-center text-red-500 mb-6">Por favor, autoriza la aplicación para acceder a los datos.</p>

        <!-- Admin Content -->
        <div id="admin-content" class="hidden">
            <!-- Tab contents go here -->
            <div id="team-formation" class="tab-content hidden"> <!-- Default active tab -->
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Armar Equipos</h2>
                <div class="mb-4">
                    <label for="team-match-date" class="block text-sm font-medium text-gray-700">Fecha del Partido:</label>
                    <input type="date" id="team-match-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <p class="text-gray-500 mb-4">Selecciona 10 jugadores para formar los equipos Claros y Oscuros.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-medium text-gray-800 mb-3">Jugadores Disponibles</h3>
                        <div id="titulares-players" class="border border-gray-300 rounded-lg p-4 bg-gray-50 flex flex-wrap gap-2 min-h-[120px]">
                            <!-- Jugadores titulares se cargarán aquí -->
                            <p class="text-gray-500">Cargando titulares...</p>
                        </div>
                        <h4 class="font-semibold text-gray-700 mb-2 mt-4">Suplentes</h4>
                        <div id="suplentes-players" class="border border-gray-300 rounded-lg p-4 bg-gray-50 flex flex-wrap gap-2 min-h-[120px]">
                            <!-- Jugadores suplentes se cargarán aquí -->
                            <p class="text-gray-500">Cargando suplentes...</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium text-gray-800 mb-3">Equipos Seleccionados (10/10)</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">Claros (<span id="claros-count">0</span>)</h4>
                                <div id="team-claros" class="border border-blue-300 rounded-lg p-3 bg-blue-50 flex flex-wrap content-start gap-2 min-h-[120px]">
                                    <!-- Jugadores del equipo Claros -->
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">Oscuros (<span id="oscuros-count">0</span>)</h4>
                                <div id="team-oscuros" class="border border-red-300 rounded-lg p-3 bg-red-50 flex flex-wrap content-start gap-2 min-h-[120px]">
                                    <!-- Jugadores del equipo Oscuros -->
                                </div>
                            </div>
                        </div>
                        <button id="save-teams-button" class="mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 w-full" disabled>
                            Guardar Equipos para Partido
                        </button>
                    </div>
                </div>
            </div>

            <div id="players-management" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gestionar Jugadores</h2>
                <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-800 mb-3">Añadir/Modificar Jugador</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="player-id" class="block text-sm font-medium text-gray-700">ID Jugador (para modificar):</label>
                            <input type="text" id="player-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Dejar vacío para nuevo">
                        </div>
                        <div>
                            <label for="player-name" class="block text-sm font-medium text-gray-700">Nombre:</label>
                            <input type="text" id="player-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="player-status" class="block text-sm font-medium text-gray-700">Estado:</label>
                            <select id="player-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                            </select>
                        </div>
                        <!-- Nuevo campo para el Rol (Titular/Suplente) -->
                        <div>
                            <label for="player-role" class="block text-sm font-medium text-gray-700">Rol:</label>
                            <select id="player-role" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="Titular">Titular</option>
                                <option value="Suplente">Suplente</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-3">
                        <button id="save-player-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                            Guardar Jugador
                        </button>
                        <button id="delete-player-button" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                            Eliminar Jugador
                        </button>
                    </div>
                </div>

                <h3 class="text-xl font-medium text-gray-800 mb-3">Listado de Jugadores</h3>
                <!-- Nuevos filtros para la tabla de jugadores -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="player-list-name-filter" class="block text-sm font-medium text-gray-700">Buscar por Nombre:</label>
                        <input type="text" id="player-list-name-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Ej: Mati">
                    </div>
                    <div>
                        <label for="player-list-status-filter" class="block text-sm font-medium text-gray-700">Filtrar por Estado:</label>
                        <select id="player-list-status-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="Todos">Todos</option>
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                    <div>
                        <label for="player-list-role-filter" class="block text-sm font-medium text-gray-700">Filtrar por Rol:</label>
                        <select id="player-list-role-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="Todos">Todos</option>
                            <option value="Titular">Titular</option>
                            <option value="Suplente">Suplente</option>
                        </select>
                    </div>
                </div>

                <div id="players-list-admin" class="overflow-x-auto">
                    <p id="players-loading-message-admin" class="text-gray-500 text-center">Cargando jugadores...</p>
                    <table class="min-w-full bg-white rounded-lg shadow hidden">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">ID</th>
                                <th class="py-3 px-6 text-left">Nombre</th>
                                <th class="py-3 px-6 text-left">Estado</th>
                                <th class="py-3 px-6 text-left">Rol</th> <!-- Nueva columna para Rol -->
                                <th class="py-3 px-6 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">
                            <!-- Filas de jugadores se cargarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="match-results" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Resultados</h2>
                <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                    <!-- Sección de Detalles del Partido Seleccionado - MOVIDA ARRIBA -->
                    <h3 class="text-xl font-medium text-gray-800 mb-3">Partido Seleccionado</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="match-date" class="block text-sm font-medium text-gray-700">Fecha del Partido:</label>
                            <input type="date" id="match-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" readonly>
                        </div>
                        <div>
                            <label for="match-result" class="block text-sm font-medium text-gray-700">Resultado:</label>
                            <select id="match-result" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="">Seleccionar resultado</option>
                                <option value="Claros">Claros</option>
                                <option value="Oscuros">Oscuros</option>
                                <option value="Empate">Empate</option>
                                <option value="Suspendido">Suspendido</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button id="register-match-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex-1">
                            Registrar Resultado y Puntos
                        </button>
                        <button id="delete-match-button" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 flex-1">
                            Eliminar Partido
                        </button>
                    </div>

                    <h3 class="text-xl font-medium text-gray-800 mb-3 mt-6">Seleccionar Partido</h3>
                    <!-- Filtros para seleccionar partido -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="results-match-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                            <select id="results-match-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <!-- Opciones de año se generarán dinámicamente -->
                            </select>
                        </div>
                        <div>
                            <label for="results-match-month-select" class="block text-sm font-medium text-gray-700">Mes:</label>
                            <select id="results-match-month-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="all">Todos</option>
                                <option value="0">Enero</option>
                                <option value="1">Febrero</option>
                                <option value="2">Marzo</option>
                                <option value="3">Abril</option>
                                <option value="4">Mayo</option>
                                <option value="5">Junio</option>
                                <option value="6">Julio</option>
                                <option value="7">Agosto</option>
                                <option value="8">Septiembre</option>
                                <option value="9">Octubre</option>
                                <option value="10">Noviembre</option>
                                <option value="11">Diciembre</option>
                            </select>
                        </div>
                    </div>
                    <!-- Este div ahora contendrá la lista de partidos dinámicamente -->
                    <label class="block text-sm font-medium text-gray-700 mt-4">Partidos Disponibles:</label>
                    <div id="results-match-list" class="mt-1 border border-gray-300 rounded-md shadow-sm max-h-80 overflow-y-auto p-2 bg-white grid grid-cols-1 md:grid-cols-2 gap-2">
                        <p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>
                        <!-- Los partidos se cargarán aquí dinámicamente como divs clickeables -->
                    </div>
                </div>
            </div>

            <div id="chamigo-management" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Chamigo</h2>
                <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-800 mb-3">Registrar Votos de Chamigo</h3>
                    <div id="chamigo-voting-players" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        <!-- Jugadores para votar por Chamigo se cargarán aquí -->
                        <p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>
                    </div>
                    <button id="register-chamigo-button" class="px-6 py-3 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700 transition duration-300 w-full">
                        Registrar Chamigo(s)
                    </button>
                </div>

                <h3 class="text-xl font-medium text-gray-800 mb-3 mt-6">Seleccionar Partido</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="chamigo-match-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                        <select id="chamigo-match-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <!-- Opciones de año se generarán dinámicamente -->
                        </select>
                    </div>
                    <div>
                        <label for="chamigo-match-month-select" class="block text-sm font-medium text-gray-700">Mes:</label>
                        <select id="chamigo-match-month-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="all">Todos</option>
                                <option value="0">Enero</option>
                                <option value="1">Febrero</option>
                                <option value="2">Marzo</option>
                                <option value="3">Abril</option>
                                <option value="4">Mayo</option>
                                <option value="5">Junio</option>
                                <option value="6">Julio</option>
                                <option value="7">Agosto</option>
                                <option value="8">Septiembre</option>
                                <option value="9">Octubre</option>
                                <option value="10">Noviembre</option>
                                <option value="11">Diciembre</option>
                        </select>
                    </div>
                </div>
                <label class="block text-sm font-medium text-gray-700 mt-4">Partidos Disponibles:</label>
                <div id="chamigo-match-list" class="mt-1 border border-gray-300 rounded-md shadow-sm max-h-80 overflow-y-auto p-2 bg-white grid grid-cols-1 md:grid-cols-2 gap-2">
                    <p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>
                </div>
            </div>

            <div id="tt-attendance" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">TT</h2>
                <div class="p-4 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-800 mb-3">Registrar Asistencia TT</h3>
                    <div id="tt-attendance-players" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        <!-- Jugadores para asistencia TT se cargarán aquí -->
                        <p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>
                    </div>
                    <button id="register-tt-button" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 w-full">
                        Registrar Asistencia TT
                    </button>
                </div>

                <h3 class="text-xl font-medium text-gray-800 mb-3 mt-6">Seleccionar Partido</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="tt-match-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                        <select id="tt-match-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <!-- Opciones de año se generarán dinámicamente -->
                        </select>
                    </div>
                    <div>
                        <label for="tt-match-month-select" class="block text-sm font-medium text-gray-700">Mes:</label>
                        <select id="tt-match-month-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="all">Todos</option>
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                    </div>
                </div>
                <label class="block text-sm font-medium text-gray-700 mt-4">Partidos Disponibles:</label>
                <div id="tt-match-list" class="mt-1 border border-gray-300 rounded-md shadow-sm max-h-80 overflow-y-auto p-2 bg-white grid grid-cols-1 md:grid-cols-2 gap-2">
                    <p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>
                </div>
            </div>

            <!-- La pestaña de Tabla de Posiciones se ha eliminado de aquí -->
        </div>
    </div>

    <!-- Custom Modal for Confirmation -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-semibold text-gray-800 mb-4" id="modal-title">Confirmar Acción</h3>
            <p class="text-gray-700 mb-6" id="modal-message">¿Estás seguro de que quieres realizar esta acción?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Cancelar</button>
                <button id="modal-confirm-button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Script de la API de Google -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <script>
        // ¡IMPORTANTE! Reemplaza 'TU_CLIENT_ID' con tu ID de Cliente de OAuth 2.0
        const CLIENT_ID = '490772160476-4cmd0dse3b74o65g1n9s1q5itlbjavbb.apps.googleusercontent.com';
        // ¡IMPORTANTE! Reemplaza 'TU_ID_DE_HOJA_DE_CALCULO' con el ID de tu Google Sheet
        const SPREADSHEET_ID = '1bpNKl-UVHzbqsow4zOHE7-y5Cunm2xtpgyIodEQBi2E';

        // Ámbitos de autorización necesarios para leer y escribir en Google Sheets
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let allPlayersData = []; // Cache de todos los jugadores
        let allMatchesData = []; // Cache de todos los partidos
        let sheetIds = {}; // Nuevo: Almacena los sheetIds por nombre de hoja

        // Variables para el drag-and-drop táctil
        let currentDraggedPlayer = null;
        let originalParentOfDraggedPlayer = null;
        let initialTouchX, initialTouchY;
        let initialElementX, initialElementY;
        let isDraggingTouch = false;

        // Elementos del DOM
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButtonSidebar = document.getElementById('signout_button_sidebar'); // Nuevo botón de cerrar sesión en sidebar (desktop)
        const signoutButtonMobileSidebar = document.getElementById('signout_button_mobile_sidebar'); // Nuevo botón de cerrar sesión en sidebar (mobile)
        const authStatus = document.getElementById('auth-status');
        const adminContent = document.getElementById('admin-content');
        const mainAdminContentContainer = document.querySelector('.main-admin-content-container'); // Referencia al contenedor principal

        // Nuevos elementos para el menú lateral
        const hamburgerButton = document.getElementById('hamburger-button');
        const sideMenu = document.getElementById('side-menu');
        const closeSideMenuButton = document.getElementById('close-side-menu-button');
        const overlay = document.getElementById('overlay');
        const tabButtons = document.querySelectorAll('.tab-button'); // Obtener todos los botones de pestaña
        const tabContents = document.querySelectorAll('.tab-content'); // Obtener todos los contenidos de las pestañas

        // Custom Confirmation Modal elements
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCancelButton = document.getElementById('modal-cancel-button');
        const modalConfirmButton = document.getElementById('modal-confirm-button');

        // Gestión de Jugadores
        const playerIdInput = document.getElementById('player-id');
        const playerNameInput = document.getElementById('player-name');
        const playerStatusSelect = document.getElementById('player-status');
        const playerRoleSelect = document.getElementById('player-role'); // Nuevo: Selector de Rol
        const savePlayerButton = document.getElementById('save-player-button');
        const deletePlayerButton = document.getElementById('delete-player-button');
        const playersListAdminTableBody = document.querySelector('#players-list-admin table tbody');
        const playersLoadingMessageAdmin = document.getElementById('players-loading-message-admin'); // Mensaje de carga
        // Nuevos filtros de Gestión de Jugadores
        const playerListNameFilter = document.getElementById('player-list-name-filter');
        const playerListStatusFilter = document.getElementById('player-list-status-filter');
        const playerListRoleFilter = document.getElementById('player-list-role-filter');


        // Armar Equipos
        const teamMatchDateInput = document.getElementById('team-match-date'); // Nuevo: Fecha en Armar Equipos
        const titularesPlayersDiv = document.getElementById('titulares-players'); // Nuevo: Jugadores Titulares
        const suplentesPlayersDiv = document.getElementById('suplentes-players'); // Nuevo: Jugadores Suplentes
        const teamClarosDiv = document.getElementById('team-claros');
        const teamOscurosDiv = document.getElementById('team-oscuros');
        const clarosCountSpan = document.getElementById('claros-count');
        const oscurosCountSpan = document.getElementById('oscuros-count');
        const saveTeamsButton = document.getElementById('save-teams-button');

        // Resultados
        const matchDateInput = document.getElementById('match-date');
        const matchResultSelect = document.getElementById('match-result');
        const resultsMatchYearSelect = document.getElementById('results-match-year-select');
        const resultsMatchMonthSelect = document.getElementById('results-match-month-select');
        const resultsMatchListDiv = document.getElementById('results-match-list'); // Ahora es un div, no un select
        const registerMatchButton = document.getElementById('register-match-button');
        const deleteMatchButton = document.getElementById('delete-match-button'); // Nuevo botón de eliminar partido

        // Chamigo
        const chamigoVotingPlayersDiv = document.getElementById('chamigo-voting-players');
        const registerChamigoButton = document.getElementById('register-chamigo-button');
        const chamigoMatchYearSelect = document.getElementById('chamigo-match-year-select'); // Nuevo
        const chamigoMatchMonthSelect = document.getElementById('chamigo-match-month-select'); // Nuevo
        const chamigoMatchListDiv = document.getElementById('chamigo-match-list'); // Nuevo

        // TT
        const ttAttendancePlayersDiv = document.getElementById('tt-attendance-players');
        const registerTtButton = document.getElementById('register-tt-button');
        const ttMatchYearSelect = document.getElementById('tt-match-year-select'); // Nuevo
        const ttMatchMonthSelect = document.getElementById('tt-match-month-select'); // Nuevo
        const ttMatchListDiv = document.getElementById('tt-match-list'); // Nuevo


        // --- Funciones de Autenticación ---

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                gapiInited = true;
                maybeEnableAuthButtons();
            } catch (err) {
                console.error("Error al inicializar gapi.client:", err);
                authStatus.textContent = `Error al inicializar la API de Google: ${err.message || err.error_description || JSON.stringify(err)}. Revisa la consola.`;
                authStatus.classList.remove('hidden');
            }
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Se define en handleAuthClick
            });
            gisInited = true;
            maybeEnableAuthButtons();
        }

        function maybeEnableAuthButtons() {
            if (gapiInited && gisInited) {
                authorizeButton.style.display = 'block';
                if (gapi.client.getToken() !== null) {
                    handleAuthSuccess();
                } else {
                    authStatus.textContent = 'Por favor, autoriza la aplicación para acceder a los datos.';
                    authStatus.classList.remove('hidden');
                    // Asegurarse de que el menú y el botón estén ocultos si no hay token
                    sideMenu.classList.add('hidden');
                    hamburgerButton.classList.add('hidden');
                    signoutButtonMobileSidebar.classList.add('hidden');
                    signoutButtonSidebar.classList.add('hidden');
                    adminContent.classList.add('hidden'); // Asegurarse que el contenido admin esté oculto
                }
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) {
                    console.error('Error de autenticación:', resp);
                    authStatus.textContent = `Error de autenticación: ${resp.error_description || resp.error}`;
                    authStatus.classList.remove('hidden');
                    return;
                }
                handleAuthSuccess();
            };

            if (gapi.client.getToken() === null) {
                // Si no hay token, solicita uno
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                // Si ya hay token, úsalo para solicitar un nuevo token (refrescar)
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function handleAuthSuccess() {
            authorizeButton.style.display = 'none';
            signoutButtonSidebar.classList.remove('hidden');
            signoutButtonMobileSidebar.classList.remove('hidden');
            authStatus.classList.add('hidden');
            adminContent.classList.remove('hidden'); // Mostrar el contenido de administración
            
            // Mostrar menú lateral y botón de hamburguesa
            sideMenu.classList.remove('hidden'); 
            // Controlar la visibilidad del botón de hamburguesa según el tamaño de la pantalla
            if (window.innerWidth < 768) {
                 hamburgerButton.classList.remove('hidden'); // Mostrar hamburguesa en móvil
            } else {
                 hamburgerButton.classList.add('hidden'); // Ocultar hamburguesa en escritorio
            }

            await loadAllDataAndDisplayAllContent(); // Cargar todos los datos y renderizar todo
            setupTabNavigation();
            
            // Establecer "Armar Equipos" como la pestaña activa por defecto
            const defaultTabButton = document.querySelector('.tab-button[data-tab="team-formation"]');
            const defaultTabContent = document.getElementById('team-formation');

            tabContents.forEach(content => content.classList.add('hidden'));
            tabButtons.forEach(button => button.classList.remove('active'));

            if (defaultTabButton && defaultTabContent) {
                defaultTabButton.classList.add('active');
                defaultTabContent.classList.remove('hidden');
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                authorizeButton.style.display = 'block';
                signoutButtonSidebar.classList.add('hidden');
                signoutButtonMobileSidebar.classList.add('hidden');
                adminContent.classList.add('hidden'); // Ocultar el contenido de administración
                
                sideMenu.classList.add('hidden');
                hamburgerButton.classList.add('hidden');
                overlay.classList.add('hidden');
                sideMenu.classList.remove('open');
                overlay.classList.remove('open');
                document.body.classList.remove('overflow-hidden');

                authStatus.textContent = 'Sesión cerrada. Por favor, autoriza de nuevo.';
                authStatus.classList.remove('hidden');
                // Limpiar todas las interfaces
                playersListAdminTableBody.innerHTML = '';
                playersLoadingMessageAdmin.textContent = 'Cargando jugadores...';
                titularesPlayersDiv.innerHTML = '<p class="text-gray-500">Cargando titulares...</p>';
                suplentesPlayersDiv.innerHTML = '<p class="text-gray-500">Cargando suplentes...</p>';
                teamClarosDiv.innerHTML = '';
                teamOscurosDiv.innerHTML = '';
                clarosCountSpan.textContent = '0';
                oscurosCountSpan.textContent = '0';
                resultsMatchListDiv.innerHTML = '<p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>';
                chamigoVotingPlayersDiv.innerHTML = '<p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>';
                chamigoMatchListDiv.innerHTML = '<p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>';
                ttAttendancePlayersDiv.innerHTML = '<p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>';
                ttMatchListDiv.innerHTML = '<p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>';
            }
        }

        // --- Custom Confirmation Modal ---
        function showCustomConfirm(title, message) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');

                const onConfirm = () => {
                    hideCustomConfirm();
                    resolve(true);
                };

                const onCancel = () => {
                    hideCustomConfirm();
                    resolve(false);
                };

                modalConfirmButton.onclick = onConfirm;
                modalCancelButton.onclick = onCancel;

                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        onCancel();
                        document.removeEventListener('keydown', handleKeyDown);
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
            });
        }

        function hideCustomConfirm() {
            customConfirmModal.classList.add('hidden');
            modalConfirmButton.onclick = null;
            modalCancelButton.onclick = null;
        }


        // --- Funciones de Carga de Datos ---

        async function loadAllData() {
            try {
                if (!gapi.client.sheets) {
                    console.error("gapi.client.sheets no está disponible. ¿Se inicializó correctamente el cliente de la API de Google?");
                    throw new Error("API de Google Sheets no cargada correctamente.");
                }

                const metadataResponse = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: SPREADSHEET_ID,
                    fields: 'sheets.properties',
                });

                if (metadataResponse.result && metadataResponse.result.sheets) {
                    metadataResponse.result.sheets.forEach(sheet => {
                        sheetIds[sheet.properties.title] = sheet.properties.sheetId;
                    });
                    console.log("IDs de hojas cargados:", sheetIds);
                } else {
                    console.warn("No se pudo recuperar la metadata de las hojas. Usando IDs por defecto (0).");
                    sheetIds['Partidos'] = 0;
                    sheetIds['Jugadores'] = 0;
                }

                const playersResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Jugadores!A:H',
                });
                allPlayersData = playersResponse.result.values ? playersResponse.result.values.slice(1) : [];

                const matchesResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Partidos!A:G',
                });
                allMatchesData = matchesResponse.result.values ? matchesResponse.result.values.slice(1) : [];

            } catch (err) {
                console.error('Error al cargar todos los datos:', err);
                let userErrorMessage = 'Error desconocido al cargar datos.';
                if (err && err.result && err.result.error && err.result.error.message) {
                    userErrorMessage = `Error al cargar datos: ${err.result.error.message}. Revisa la consola para más detalles.`;
                } else if (err && err.message) {
                    userErrorMessage = `Error al cargar datos: ${err.message}. Revisa la consola para más detalles.`;
                }
                alert(userErrorMessage);
            }
        }

        async function loadAllDataAndDisplayAllContent() {
            await loadAllData();
            renderPlayersListAdmin();
            renderAvailablePlayersForTeams();
            populateResultsMatchYearSelect();
            populateMatchSelects();
            populateChamigoTtMatchYearSelect();
            populateChamigoTtMatchLists();
        }

        // --- Funciones de Pestañas ---
        function setupTabNavigation() {
            tabButtons.forEach(button => {
                button.removeEventListener('click', handleTabButtonClick);
                button.addEventListener('click', handleTabButtonClick);
            });
        }

        function handleTabButtonClick(event) {
            const clickedButton = event.currentTarget;
            
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.add('hidden'));

            clickedButton.classList.add('active');
            document.getElementById(clickedButton.dataset.tab).classList.remove('hidden');

            if (window.innerWidth < 768) {
                toggleSideMenu();
            }

            if (clickedButton.dataset.tab === 'players-management') {
                renderPlayersListAdmin();
            } else if (clickedButton.dataset.tab === 'team-formation') {
                renderAvailablePlayersForTeams();
                teamClarosDiv.innerHTML = '';
                teamOscurosDiv.innerHTML = '';
                clarosCountSpan.textContent = '0';
                oscurosCountSpan.textContent = '0';
                saveTeamsButton.disabled = true;
                teamMatchDateInput.value = '';
            } else if (clickedButton.dataset.tab === 'match-results') {
                populateResultsMatchYearSelect();
                resultsMatchMonthSelect.value = 'all';
                populateMatchSelects();
                matchDateInput.value = '';
                matchResultSelect.value = '';
            } else if (clickedButton.dataset.tab === 'chamigo-management') {
                populateChamigoTtMatchYearSelect();
                chamigoMatchMonthSelect.value = 'all';
                populateChamigoTtMatchLists();
                chamigoVotingPlayersDiv.innerHTML = '<p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>';
            } else if (clickedButton.dataset.tab === 'tt-attendance') {
                populateChamigoTtMatchYearSelect();
                ttMatchMonthSelect.value = 'all';
                populateChamigoTtMatchLists();
                ttAttendancePlayersDiv.innerHTML = '<p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>';
            }
        }

        // --- Toggle Side Menu Functionality ---
        function toggleSideMenu() {
            sideMenu.classList.toggle('open');
            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                overlay.classList.toggle('open');
                document.body.classList.toggle('overflow-hidden');
                if (sideMenu.classList.contains('open')) {
                    hamburgerButton.classList.add('hidden');
                } else {
                    hamburgerButton.classList.remove('hidden');
                }
            } else {
                hamburgerButton.classList.add('hidden');
                overlay.classList.remove('open');
                document.body.classList.remove('overflow-hidden');
            }
        }

        // --- Gestión de Jugadores (AMB) ---

        function renderPlayersListAdmin() {
            playersListAdminTableBody.innerHTML = '';
            document.querySelector('#players-list-admin table').classList.add('hidden');
            playersLoadingMessageAdmin.classList.remove('hidden');
            playersLoadingMessageAdmin.textContent = 'Cargando jugadores...';

            const nameFilter = playerListNameFilter.value.toLowerCase();
            const statusFilter = playerListStatusFilter.value;
            const roleFilter = playerListRoleFilter.value;

            const filteredPlayers = allPlayersData.filter(player => {
                const [id, nombre, estado, puntos, partidos, chamigos, tt, rol = 'Titular'] = player;
                const matchesName = nameFilter === '' || nombre.toLowerCase().includes(nameFilter);
                const matchesStatus = statusFilter === 'Todos' || estado === statusFilter;
                const matchesRole = roleFilter === 'Todos' || rol === roleFilter;
                return matchesName && matchesStatus && matchesRole;
            });

            if (filteredPlayers.length === 0) {
                playersLoadingMessageAdmin.textContent = 'No hay jugadores que coincidan con los filtros.';
                return;
            }

            filteredPlayers.forEach((player, index) => {
                const [id, nombre, estado, puntos, partidos, chamigos, tt, rol = 'Titular'] = player;
                const row = `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6 text-left">${id}</td>
                        <td class="py-3 px-6 text-left">${nombre}</td>
                        <td class="py-3 px-6 text-left">${estado}</td>
                        <td class="py-3 px-6 text-left">${rol}</td>
                        <td class="py-3 px-6 text-center">
                            <button class="edit-player-button px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 text-xs"
                                data-id="${id}"
                                data-name="${nombre}"
                                data-status="${estado}"
                                data-role="${rol}">Editar</button>
                        </td>
                    </tr>
                `;
                playersListAdminTableBody.innerHTML += row;
            });

            document.querySelectorAll('.edit-player-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    playerIdInput.value = e.target.dataset.id;
                    playerNameInput.value = e.target.dataset.name;
                    playerStatusSelect.value = e.target.dataset.status;
                    playerRoleSelect.value = e.target.dataset.role;
                });
            });
            playersLoadingMessageAdmin.classList.add('hidden');
            document.querySelector('#players-list-admin table').classList.remove('hidden');
        }

        playerListNameFilter.addEventListener('input', renderPlayersListAdmin);
        playerListStatusFilter.addEventListener('change', renderPlayersListAdmin);
        playerListRoleFilter.addEventListener('change', renderPlayersListAdmin);


        savePlayerButton.addEventListener('click', async () => {
            const id = playerIdInput.value.trim();
            const name = playerNameInput.value.trim();
            const status = playerStatusSelect.value;
            const role = playerRoleSelect.value;

            if (!name) {
                alert('El nombre del jugador no puede estar vacío.');
                return;
            }

            const normalizedNewName = name.toLowerCase();
            const isEditingExistingPlayer = id !== '';

            const duplicatePlayer = allPlayersData.find(p => {
                const existingId = p[0];
                const existingName = p[1].toLowerCase();
                return existingName === normalizedNewName && (!isEditingExistingPlayer || existingId !== id);
            });

            if (duplicatePlayer) {
                alert(`Ya existe un jugador con el nombre "${name}". Por favor, elige un nombre diferente.`);
                return;
            }

            try {
                let rowToUpdateIndex = allPlayersData.findIndex(p => p[0] === id);
                let newPlayerId = id;

                if (rowToUpdateIndex === -1) {
                    const maxIdNum = allPlayersData.reduce((max, p) => {
                        const num = parseInt(p[0]?.replace('J', '') || 0);
                        return Math.max(max, num);
                    }, 0);
                    newPlayerId = 'J' + String(maxIdNum + 1).padStart(3, '0');
                    const newPlayerRow = [newPlayerId, name, status, 0, 0, 0, 0, role];
                    allPlayersData.push(newPlayerRow);
                    rowToUpdateIndex = allPlayersData.length - 1;
                } else {
                    allPlayersData[rowToUpdateIndex][1] = name;
                    allPlayersData[rowToUpdateIndex][2] = status;
                    allPlayersData[rowToUpdateIndex][7] = role;
                }

                const values = [allPlayersData[rowToUpdateIndex]];
                const range = `Jugadores!A${rowToUpdateIndex + 2}:H${rowToUpdateIndex + 2}`;

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                    valueInputOption: 'RAW',
                    resource: { values: values },
                });

                alert('Jugador guardado exitosamente.');
                playerIdInput.value = '';
                playerNameInput.value = '';
                playerStatusSelect.value = 'Activo';
                playerRoleSelect.value = 'Titular';
                await loadAllDataAndDisplayAllContent();
            } catch (err) {
                console.error('Error al guardar jugador:', err);
                alert(`Error al guardar jugador: ${err.message}. Revisa la consola.`);
            }
        });

        deletePlayerButton.addEventListener('click', async () => {
            const idToDelete = playerIdInput.value.trim();
            if (!idToDelete) {
                alert('Por favor, selecciona un jugador para eliminar usando su ID.');
                return;
            }

            const confirmed = await showCustomConfirm('Confirmar Eliminación', `¿Estás seguro de que quieres marcar al jugador con ID ${idToDelete} como Inactivo? Esto no se puede deshacer fácilmente.`);
            if (!confirmed) {
                return;
            }

            try {
                const rowIndex = allPlayersData.findIndex(p => p[0] === idToDelete);
                if (rowIndex === -1) {
                    alert('Jugador no encontrado.');
                    return;
                }

                allPlayersData[rowIndex][2] = 'Inactivo';
                const values = [allPlayersData[rowIndex]];
                const range = `Jugadores!A${rowIndex + 2}:H${rowIndex + 2}`;

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                    valueInputOption: 'RAW',
                    resource: { values: values },
                });

                alert(`Jugador con ID ${idToDelete} marcado como Inactivo.`);
                playerIdInput.value = '';
                playerNameInput.value = '';
                playerStatusSelect.value = 'Activo';
                playerRoleSelect.value = 'Titular';
                await loadAllDataAndDisplayAllContent();
            } catch (err) {
                console.error('Error al eliminar jugador:', err);
                alert(`Error al eliminar jugador: ${err.message}. Revisa la consola.`);
            }
        });

        // --- Armar Equipos ---

        function renderAvailablePlayersForTeams() {
            titularesPlayersDiv.innerHTML = '<p class="text-gray-500">Cargando titulares...</p>';
            suplentesPlayersDiv.innerHTML = '<p class="text-gray-500">Cargando suplentes...</p>';

            const activePlayers = allPlayersData.filter(p => p[2] === 'Activo');

            if (activePlayers.length === 0) {
                titularesPlayersDiv.innerHTML = '<p class="text-gray-500">No hay jugadores activos.</p>';
                suplentesPlayersDiv.innerHTML = '';
                return;
            }
            
            titularesPlayersDiv.innerHTML = '';
            suplentesPlayersDiv.innerHTML = '';

            activePlayers.forEach(player => {
                const [id, nombre, estado, puntos, partidos, chamigos, tt, rol = 'Titular'] = player;
                const playerElement = document.createElement('div');
                playerElement.className = 'player-draggable';
                playerElement.draggable = true;
                playerElement.dataset.id = id;
                playerElement.dataset.name = nombre;
                playerElement.textContent = nombre;
                playerElement.addEventListener('dragstart', handleDragStart);
                playerElement.addEventListener('touchstart', handleTouchStart);
                
                if (rol === 'Titular') {
                    titularesPlayersDiv.appendChild(playerElement);
                } else {
                    suplentesPlayersDiv.appendChild(playerElement);
                }
            });

            if (titularesPlayersDiv.children.length === 0) {
                titularesPlayersDiv.innerHTML = '<p class="text-gray-500">No hay titulares activos.</p>';
            }
            if (suplentesPlayersDiv.children.length === 0) {
                suplentesPlayersDiv.innerHTML = '<p class="text-gray-500">No hay suplentes activos.</p>';
            }
        }

        // --- Desktop Drag-and-Drop Handlers ---
        function handleDragStart(e) {
            console.log('Drag started for player (Desktop):', e.target.dataset.name);
            e.dataTransfer.setData('text/plain', JSON.stringify({
                id: e.target.dataset.id,
                name: e.target.dataset.name,
                source: e.target.parentNode.id
            }));
            e.dataTransfer.effectAllowed = 'move';
        }

        [titularesPlayersDiv, suplentesPlayersDiv, teamClarosDiv, teamOscurosDiv].forEach(dropZone => {
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
        });

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e) {
            e.preventDefault();
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const playerId = data.id;
            const sourceId = data.source;
            const targetId = e.currentTarget.id;

            console.log('Drop event (Desktop) on', e.currentTarget.id, 'for player:', data.name);

            if ((sourceId === 'titulares-players' && targetId === 'suplentes-players') ||
                (sourceId === 'suplentes-players' && targetId === 'titulares-players')) {
                console.log('Arrastre no permitido entre Titulares y Suplentes.');
                return;
            }

            if (sourceId === targetId) return;

            const draggedElement = document.querySelector(`#${sourceId} .player-draggable[data-id="${playerId}"]`);
            if (draggedElement) {
                document.getElementById(targetId).appendChild(draggedElement);
            }
            updateTeamCounts();
        }

        // --- Touch Drag-and-Drop Handlers ---
        function handleTouchStart(e) {
            if (e.touches.length === 1) {
                isDraggingTouch = true;
                currentDraggedPlayer = e.target;
                originalParentOfDraggedPlayer = e.target.parentNode;
                currentDraggedPlayer.classList.add('dragging-touch');

                initialTouchX = e.touches[0].clientX;
                initialTouchY = e.touches[0].clientY;

                const rect = currentDraggedPlayer.getBoundingClientRect();
                initialElementX = rect.left;
                initialElementY = rect.top;

                currentDraggedPlayer.style.position = 'fixed';
                currentDraggedPlayer.style.zIndex = '1000';
                currentDraggedPlayer.style.pointerEvents = 'none';

                currentDraggedPlayer.style.left = initialElementX + 'px';
                currentDraggedPlayer.style.top = initialElementY + 'px';

                document.addEventListener('touchmove', handleTouchMove, { passive: false });
                document.addEventListener('touchend', handleTouchEnd);
            }
        }

        function handleTouchMove(e) {
            if (!isDraggingTouch) return;
            e.preventDefault();

            const currentTouchX = e.touches[0].clientX;
            const currentTouchY = e.touches[0].clientY;

            const deltaX = currentTouchX - initialTouchX;
            const deltaY = currentTouchY - initialTouchY;

            currentDraggedPlayer.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
        }

        function handleTouchEnd(e) {
            if (!isDraggingTouch) return;

            isDraggingTouch = false;
            currentDraggedPlayer.classList.remove('dragging-touch');
            currentDraggedPlayer.style.position = '';
            currentDraggedPlayer.style.zIndex = '';
            currentDraggedPlayer.style.pointerEvents = '';
            currentDraggedPlayer.style.transform = '';

            document.removeEventListener('touchmove', handleTouchMove);
            document.removeEventListener('touchend', handleTouchEnd);

            const touch = e.changedTouches[0];
            const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);

            if (targetElement) {
                let dropZone = null;
                let current = targetElement;
                while (current && current !== document.body) {
                    if (current.id === 'titulares-players' ||
                        current.id === 'suplentes-players' ||
                        current.id === 'team-claros' ||
                        current.id === 'team-oscuros') {
                        dropZone = current;
                        break;
                    }
                    current = current.parentNode;
                }

                if (dropZone) {
                    handleTouchDrop(currentDraggedPlayer, dropZone);
                } else {
                    if (originalParentOfDraggedPlayer) {
                        originalParentOfDraggedPlayer.appendChild(currentDraggedPlayer);
                    }
                }
            } else {
                if (originalParentOfDraggedPlayer) {
                    originalParentOfDraggedPlayer.appendChild(currentDraggedPlayer);
                }
            }
            currentDraggedPlayer = null;
            originalParentOfDraggedPlayer = null;
        }

        function handleTouchDrop(draggedElement, dropZone) {
            const sourceId = originalParentOfDraggedPlayer.id;
            const targetId = dropZone.id;

            console.log('Touch Drop event on', targetId, 'for player:', draggedElement.dataset.name);

            if ((sourceId === 'titulares-players' && targetId === 'suplentes-players') ||
                (sourceId === 'suplentes-players' && targetId === 'titulares-players')) {
                console.log('Arrastre no permitido entre Titulares y Suplentes.');
                if (originalParentOfDraggedPlayer) {
                    originalParentOfDraggedPlayer.appendChild(draggedElement);
                }
                return;
            }

            if (sourceId === targetId) {
                return;
            }

            if (originalParentOfDraggedPlayer && originalParentOfDraggedPlayer.contains(draggedElement)) {
                originalParentOfDraggedPlayer.removeChild(draggedElement);
            }

            dropZone.appendChild(draggedElement);

            updateTeamCounts();
        }

        function updateTeamCounts() {
            const clarosPlayers = Array.from(teamClarosDiv.children).map(el => el.dataset.id);
            const oscurosPlayers = Array.from(teamOscurosDiv.children).map(el => el.dataset.id);

            clarosCountSpan.textContent = clarosPlayers.length;
            oscurosCountSpan.textContent = oscurosPlayers.length;

            if (clarosPlayers.length === 5 && oscurosPlayers.length === 5) {
                saveTeamsButton.disabled = false;
            } else {
                saveTeamsButton.disabled = true;
            }
        }

        saveTeamsButton.addEventListener('click', async () => {
            const clarosPlayers = Array.from(teamClarosDiv.children).map(el => el.dataset.id);
            const oscurosPlayers = Array.from(teamOscurosDiv.children).map(el => el.dataset.id);
            const matchDateInputVal = teamMatchDateInput.value;

            if (!matchDateInputVal) {
                alert('Por favor, selecciona la fecha del partido.');
                return;
            }

            if (clarosPlayers.length !== 5 || oscurosPlayers.length !== 5) {
                alert('Debes seleccionar exactamente 5 jugadores para cada equipo.');
                return;
            }

            const formattedDate = formatDateToDDMMYYYY(parseYYYYMMDDToLocalDate(matchDateInputVal));

            const existingMatch = allMatchesData.find(match => match[1] === formattedDate);
            if (existingMatch) {
                alert(`Ya existe un partido registrado para la fecha ${formattedDate}. Por favor, elige otra fecha.`);
                return;
            }

            try {
                const maxIdNum = allMatchesData.reduce((max, m) => {
                    const num = parseInt(m[0]?.replace('P', '') || 0);
                    return Math.max(max, num);
                }, 0);
                const newMatchId = 'P' + String(maxIdNum + 1).padStart(3, '0');

                const newMatchRow = [
                    newMatchId,
                    formattedDate,
                    clarosPlayers.join(','),
                    oscurosPlayers.join(','),
                    '',
                    '',
                    ''
                ];

                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Partidos!A:G',
                    valueInputOption: 'RAW',
                    resource: { values: [newMatchRow] },
                });

                alert(`Equipos guardados para el partido ${newMatchId} en la fecha ${formattedDate}.`);
                await loadAllDataAndDisplayAllContent();
                titularesPlayersDiv.innerHTML = '';
                suplentesPlayersDiv.innerHTML = '';
                teamClarosDiv.innerHTML = '';
                teamOscurosDiv.innerHTML = '';
                clarosCountSpan.textContent = '0';
                oscurosCountSpan.textContent = '0';
                saveTeamsButton.disabled = true;
                teamMatchDateInput.value = '';
            } catch (err) {
                console.error('Error al guardar equipos:', err);
                alert(`Error al guardar equipos: ${err.message}. Revisa la consola.`);
            }
        });

        // --- Funciones para poblar selectores de partidos (Resultados, Chamigo, TT) ---
        function populateResultsMatchYearSelect() {
            const years = new Set();
            allMatchesData.forEach(match => {
                const dateString = match[1];
                if (dateString) {
                    const date = parseDate(dateString);
                    years.add(date.getFullYear());
                }
            });

            const sortedYears = Array.from(years).sort((a, b) => b - a);

            resultsMatchYearSelect.innerHTML = '';
            const currentYear = new Date().getFullYear();
            if (sortedYears.length > 0) {
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    resultsMatchYearSelect.appendChild(option);
                });
                if (sortedYears.includes(currentYear)) {
                    resultsMatchYearSelect.value = currentYear;
                } else {
                    resultsMatchYearSelect.value = sortedYears[0];
                }
            } else {
                const option = document.createElement('option');
                option.value = currentYear;
                option.textContent = currentYear;
                resultsMatchYearSelect.appendChild(option);
            }
        }

        function populateMatchSelects() {
            const selectedYear = resultsMatchYearSelect.value;
            const selectedMonth = resultsMatchMonthSelect.value;

            resultsMatchListDiv.innerHTML = '';

            const filteredMatches = allMatchesData.filter(match => {
                const dateString = match[1];
                if (!dateString) return false;
                const matchDate = parseDate(dateString);
                const matchYear = matchDate.getFullYear();
                const matchMonth = matchDate.getMonth();

                const yearMatch = selectedYear === 'all' || matchYear === parseInt(selectedYear);
                const monthMatch = selectedMonth === 'all' || matchMonth === parseInt(selectedMonth);

                return yearMatch && monthMatch;
            });

            const sortedMatches = [...filteredMatches].sort((a, b) => {
                const dateA = parseDate(a[1]);
                const dateB = parseDate(b[1]);
                return dateB - dateA;
            });

            if (sortedMatches.length === 0) {
                resultsMatchListDiv.innerHTML = '<p class="text-gray-500">No hay partidos para los filtros seleccionados.</p>';
                return;
            }

            sortedMatches.forEach(match => {
                const [id, fecha, clarosIDs, oscurosIDs, resultado] = match;
                const matchItem = document.createElement('div');
                if (resultado && resultado.trim() !== '') {
                    matchItem.className = 'match-item has-result';
                } else {
                    matchItem.className = 'match-item no-result';
                }
                matchItem.dataset.matchId = id;

                const clarosNames = clarosIDs.split(',').map(id => {
                    const player = allPlayersData.find(p => p[0] === id);
                    return player ? player[1] : `ID:${id}`;
                }).join(', ');
                const oscurosNames = oscurosIDs.split(',').map(id => {
                    const player = allPlayersData.find(p => p[0] === id);
                    return player ? player[1] : `ID:${id}`;
                }).join(', ');
                
                matchItem.innerHTML = `
                    <p class="font-semibold">${fecha}</p>
                    <p class="text-sm text-gray-700">Claros: ${clarosNames}</p>
                    <p class="text-sm text-gray-700">Oscuros: ${oscurosNames}</p>
                    ${resultado ? `<p class="text-xs text-gray-500">Resultado: ${resultado}</p>` : '<p class="text-xs text-gray-500">Sin resultado</p>'}
                `;
                resultsMatchListDiv.appendChild(matchItem);

                matchItem.addEventListener('click', () => {
                    document.querySelectorAll('#results-match-list .match-item').forEach(item => item.classList.remove('selected'));
                    matchItem.classList.add('selected');

                    const selectedMatch = allMatchesData.find(m => m[0] === id);
                    if (selectedMatch) {
                        const [mId, mFecha, mClarosIDs, mOscurosIDs, mResultado] = selectedMatch;
                        const [day, month, year] = mFecha.split('/');
                        matchDateInput.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        matchResultSelect.value = mResultado || '';
                    }
                });
            });
        }

        // --- NUEVAS FUNCIONES PARA CHAMIGO Y TT ---

        function populateChamigoTtMatchYearSelect() {
            const years = new Set();
            allMatchesData.forEach(match => {
                const dateString = match[1];
                if (dateString) {
                    const date = parseDate(dateString);
                    years.add(date.getFullYear());
                }
            });

            const sortedYears = Array.from(years).sort((a, b) => b - a);

            [chamigoMatchYearSelect, ttMatchYearSelect].forEach(selectElement => {
                selectElement.innerHTML = '';
                const currentYear = new Date().getFullYear();
                if (sortedYears.length > 0) {
                    sortedYears.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        selectElement.appendChild(option);
                    });
                    if (sortedYears.includes(currentYear)) {
                        selectElement.value = currentYear;
                    } else {
                        selectElement.value = sortedYears[0];
                    }
                } else {
                    const option = document.createElement('option');
                    option.value = currentYear;
                    option.textContent = currentYear;
                    selectElement.appendChild(option);
                }
            });
        }

        function populateMatchListForTab(targetListDiv, yearSelect, monthSelect, onMatchClickCallback, tabName) {
            const selectedYear = yearSelect.value;
            const selectedMonth = monthSelect.value;

            targetListDiv.innerHTML = '';

            const filteredMatches = allMatchesData.filter(match => {
                const dateString = match[1];
                if (!dateString) return false;
                const matchDate = parseDate(dateString);
                const matchYear = matchDate.getFullYear();
                const matchMonth = matchDate.getMonth();

                const yearMatch = selectedYear === 'all' || matchYear === parseInt(selectedYear);
                const monthMatch = selectedMonth === 'all' || matchMonth === parseInt(selectedMonth);

                return yearMatch && monthMatch;
            });

            const sortedMatches = [...filteredMatches].sort((a, b) => {
                const dateA = parseDate(a[1]);
                const dateB = parseDate(b[1]);
                return dateB - dateA;
            });

            if (sortedMatches.length === 0) {
                targetListDiv.innerHTML = '<p class="text-gray-500">No hay partidos para los filtros seleccionados.</p>';
                return;
            }

            sortedMatches.forEach(match => {
                const [id, fecha, clarosIDs, oscurosIDs, resultado, chamigoVotos, ttAttendees] = match;
                const matchItem = document.createElement('div');
                
                let shouldBeGreen = false;
                if (tabName === 'chamigo') {
                    shouldBeGreen = (chamigoVotos && chamigoVotos.trim() !== '');
                } else if (tabName === 'tt') {
                    shouldBeGreen = (ttAttendees && ttAttendees.trim() !== '');
                } else {
                    shouldBeGreen = (resultado && resultado.trim() !== '');
                }

                if (shouldBeGreen) {
                    matchItem.className = 'match-item has-result';
                } else {
                    matchItem.className = 'match-item no-result';
                }

                matchItem.dataset.matchId = id;

                const clarosNames = clarosIDs.split(',').map(id => {
                    const player = allPlayersData.find(p => p[0] === id);
                    return player ? player[1] : `ID:${id}`;
                }).join(', ');
                const oscurosNames = oscurosIDs.split(',').map(id => {
                    const player = allPlayersData.find(p => p[0] === id);
                    return player ? player[1] : `ID:${id}`;
                }).join(', ');
                
                matchItem.innerHTML = `
                    <p class="font-semibold">${fecha}</p>
                    <p class="text-sm text-gray-700">Claros: ${clarosNames}</p>
                    <p class="text-sm text-gray-700">Oscuros: ${oscurosNames}</p>
                    ${resultado ? `<p class="text-xs text-gray-500">Resultado: ${resultado}</p>` : '<p class="text-xs text-gray-500">Sin resultado</p>'}
                `;
                targetListDiv.appendChild(matchItem);

                matchItem.addEventListener('click', () => {
                    document.querySelectorAll(`#${tabName}-match-list .match-item`).forEach(item => item.classList.remove('selected'));
                    matchItem.classList.add('selected');

                    onMatchClickCallback(id);
                });
            });
        }

        function populateChamigoTtMatchLists() {
            populateMatchListForTab(chamigoMatchListDiv, chamigoMatchYearSelect, chamigoMatchMonthSelect, handleChamigoMatchSelection, 'chamigo');
            populateMatchListForTab(ttMatchListDiv, ttMatchYearSelect, ttMatchMonthSelect, handleTtMatchSelection, 'tt');
        }

        resultsMatchYearSelect.addEventListener('change', populateMatchSelects);
        resultsMatchMonthSelect.addEventListener('change', populateMatchSelects);

        chamigoMatchYearSelect.addEventListener('change', () => populateChamigoTtMatchLists());
        chamigoMatchMonthSelect.addEventListener('change', () => populateChamigoTtMatchLists());

        ttMatchYearSelect.addEventListener('change', () => populateChamigoTtMatchLists());
        ttMatchMonthSelect.addEventListener('change', () => populateChamigoTtMatchLists());


        // --- Resultados ---

        registerMatchButton.addEventListener('click', async () => {
            const selectedMatchItem = document.querySelector('#results-match-list .match-item.selected');
            if (!selectedMatchItem) {
                alert('Por favor, selecciona un partido de la lista.');
                return;
            }
            const selectedMatchId = selectedMatchItem.dataset.matchId;
            const result = matchResultSelect.value;
            const matchDateInputVal = matchDateInput.value;

            if (!selectedMatchId || !result || !matchDateInputVal) {
                alert('Por favor, selecciona un partido, ingresa la fecha y el resultado.');
                return;
            }

            try {
                const matchIndex = allMatchesData.findIndex(m => m[0] === selectedMatchId);
                if (matchIndex === -1) {
                    alert('Partido no encontrado.');
                    return;
                }

                const currentMatch = allMatchesData[matchIndex];
                const [id, oldDate, clarosIDsStr, oscurosIDsStr, oldResult, chamigoVotosStr, ttAttendeesStr] = currentMatch;

                if (oldResult && oldResult.trim() !== '' && oldResult !== 'Suspendido') {
                    const playersInOldMatchIDs = [...new Set([...(clarosIDsStr.split(',').filter(Boolean)), ...(oscurosIDsStr.split(',').filter(Boolean))])];
                    const oldPlayerUpdates = {};

                    playersInOldMatchIDs.forEach(pId => {
                        oldPlayerUpdates[pId] = oldPlayerUpdates[pId] || { pointsChange: 0, gamesChange: 0 };
                        oldPlayerUpdates[pId].gamesChange -= 1;
                    });

                    if (oldResult === 'Claros') {
                        (clarosIDsStr.split(',').filter(Boolean)).forEach(pId => {
                            oldPlayerUpdates[pId].pointsChange -= 3;
                        });
                    } else if (oldResult === 'Oscuros') {
                        (oscurosIDsStr.split(',').filter(Boolean)).forEach(pId => {
                            oldPlayerUpdates[pId].pointsChange -= 3;
                        });
                    } else if (oldResult === 'Empate') {
                        playersInOldMatchIDs.forEach(pId => {
                            oldPlayerUpdates[pId].pointsChange -= 1;
                        });
                    }

                    const batchRevertRequests = [];
                    for (const playerId of Object.keys(oldPlayerUpdates)) {
                        const playerUpdate = oldPlayerUpdates[playerId];
                        const playerGlobalIndex = allPlayersData.findIndex(p => p[0] === playerId);
                        if (playerGlobalIndex !== -1) {
                            const currentPlayer = allPlayersData[playerGlobalIndex];
                            currentPlayer[3] = parseInt(currentPlayer[3] || 0) + playerUpdate.pointsChange;
                            currentPlayer[4] = parseInt(currentPlayer[4] || 0) + playerUpdate.gamesChange;

                            batchRevertRequests.push({
                                range: `Jugadores!D${playerGlobalIndex + 2}:E${playerGlobalIndex + 2}`,
                                values: [[currentPlayer[3], currentPlayer[4]]]
                            });
                        }
                    }
                    if (batchRevertRequests.length > 0) {
                        await gapi.client.sheets.spreadsheets.values.batchUpdate({
                            spreadsheetId: SPREADSHEET_ID,
                            resource: {
                                data: batchRevertRequests,
                                valueInputOption: 'RAW'
                            }
                        });
                    }
                }

                currentMatch[1] = formatDateToDDMMYYYY(parseYYYYMMDDToLocalDate(matchDateInputVal));
                currentMatch[4] = result;

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `Partidos!A${matchIndex + 2}:G${matchIndex + 2}`,
                    valueInputOption: 'RAW',
                    resource: { values: [currentMatch] },
                });

                const clarosPlayers = clarosIDsStr.split(',').filter(Boolean);
                const oscurosPlayers = oscurosIDsStr.split(',').filter(Boolean);

                let playersToUpdate = {};

                if (result !== 'Suspendido') {
                    [...clarosPlayers, ...oscurosPlayers].forEach(pId => {
                        playersToUpdate[pId] = playersToUpdate[pId] || { points: 0, games: 0 };
                        playersToUpdate[pId].games += 1;
                    });
                }

                if (result === 'Claros') {
                    clarosPlayers.forEach(pId => {
                        playersToUpdate[pId] = playersToUpdate[pId] || { points: 0, games: 0 };
                        playersToUpdate[pId].points += 3;
                    });
                } else if (result === 'Oscuros') {
                    oscurosPlayers.forEach(pId => {
                        playersToUpdate[pId] = playersToUpdate[pId] || { points: 0, games: 0 };
                        playersToUpdate[pId].points += 3;
                    });
                } else if (result === 'Empate') {
                    [...clarosPlayers, ...oscurosPlayers].forEach(pId => {
                        playersToUpdate[pId] = playersToUpdate[pId] || { points: 0, games: 0 };
                        playersToUpdate[pId].points += 1;
                    });
                }

                const updateRequests = [];
                for (const pId of Object.keys(playersToUpdate)) {
                    const playerUpdate = playersToUpdate[pId];
                    const playerGlobalIndex = allPlayersData.findIndex(p => p[0] === pId);
                    if (playerGlobalIndex !== -1) {
                        const currentPlayer = allPlayersData[playerGlobalIndex];
                        currentPlayer[3] = parseInt(currentPlayer[3] || 0) + playerUpdate.points;
                        currentPlayer[4] = parseInt(currentPlayer[4] || 0) + playerUpdate.games;

                        updateRequests.push({
                            range: `Jugadores!D${playerGlobalIndex + 2}:E${playerGlobalIndex + 2}`,
                            values: [[currentPlayer[3], currentPlayer[4]]]
                        });
                    }
                }

                if (updateRequests.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            data: updateRequests,
                            valueInputOption: 'RAW'
                        }
                    });
                }

                alert('Resultado del partido y puntos actualizados exitosamente.');
                matchDateInput.value = '';
                matchResultSelect.value = '';
                document.querySelectorAll('#results-match-list .match-item').forEach(item => item.classList.remove('selected'));
                await loadAllDataAndDisplayAllContent();
            } catch (err) {
                console.error('Error al registrar partido:', err);
                alert(`Error al registrar partido: ${err.message}. Revisa la consola.`);
            }
        });

        async function deleteMatchButtonClickHandler() {
            const selectedMatchItem = document.querySelector('#results-match-list .match-item.selected');
            if (!selectedMatchItem) {
                alert('Por favor, selecciona un partido de la lista para eliminar.');
                return;
            }
            const selectedMatchId = selectedMatchItem.dataset.matchId;

            const confirmed = await showCustomConfirm(
                'Confirmar Eliminación de Partido',
                `¿Estás seguro de que quieres eliminar el partido seleccionado (ID: ${selectedMatchId})? Esto revertirá todos los puntos, chamigos y asistencias TT asociados a este partido. Esta acción es irreversible.`
            );

            if (!confirmed) {
                return;
            }

            try {
                const matchIndex = allMatchesData.findIndex(m => m[0] === selectedMatchId);
                if (matchIndex === -1) {
                    alert('Partido no encontrado.');
                    return;
                }

                const matchToDelete = allMatchesData[matchIndex];
                const [id, date, clarosIDsStr = '', oscurosIDsStr = '', result, chamigoVotosStr = '', ttAttendeesStr = ''] = matchToDelete;

                const playersInMatchIDs = [...new Set([...(clarosIDsStr.split(',').filter(Boolean)), ...(oscurosIDsStr.split(',').filter(Boolean))])];
                const playerUpdates = {};

                if (result && result.trim() !== '' && result !== 'Suspendido') {
                    playersInMatchIDs.forEach(pId => {
                        playerUpdates[pId] = playerUpdates[pId] || { pointsChange: 0, gamesChange: 0, chamigoChange: 0, ttChange: 0 };
                        playerUpdates[pId].gamesChange -= 1;
                    });
                }

                if (result === 'Claros') {
                    (clarosIDsStr.split(',').filter(Boolean)).forEach(pId => {
                        playerUpdates[pId] = playerUpdates[pId] || { pointsChange: 0, gamesChange: 0, chamigoChange: 0, ttChange: 0 };
                        playerUpdates[pId].pointsChange -= 3;
                    });
                } else if (result === 'Oscuros') {
                    (oscurosIDsStr.split(',').filter(Boolean)).forEach(pId => {
                        playerUpdates[pId] = playerUpdates[pId] || { pointsChange: 0, gamesChange: 0, chamigoChange: 0, ttChange: 0 };
                        playerUpdates[pId].pointsChange -= 3;
                    });
                } else if (result === 'Empate') {
                    playersInMatchIDs.forEach(pId => {
                        playerUpdates[pId] = playerUpdates[pId] || { pointsChange: 0, gamesChange: 0, chamigoChange: 0, ttChange: 0 };
                        playerUpdates[pId].pointsChange -= 1;
                    });
                }

                if (chamigoVotosStr) {
                    try {
                        const chamigoVotos = JSON.parse(chamigoVotosStr);
                        const maxVotes = chamigoVotos.length > 0 ? Math.max(...chamigoVotos.map(v => v.votos)) : 0;
                        const chamigosDelPartido = chamigoVotos.filter(v => v.votos === maxVotes);
                        chamigosDelPartido.forEach(chamigo => {
                            playerUpdates[chamigo.id] = playerUpdates[chamigo.id] || { pointsChange: 0, gamesChange: 0, chamigoChange: 0, ttChange: 0 };
                            playerUpdates[chamigo.id].chamigoChange -= 1;
                        });
                    } catch (e) {
                        console.warn('Error al parsear votos de chamigo al eliminar:', chamigoVotosStr, e);
                    }
                }

                if (ttAttendeesStr) {
                    const ttAttendees = ttAttendeesStr.split(',').filter(Boolean);
                    ttAttendees.forEach(pId => {
                        playerUpdates[pId] = playerUpdates[pId] || { pointsChange: 0, gamesChange: 0, chamigoChange: 0, ttChange: 0 };
                        playerUpdates[pId].ttChange -= 1;
                    });
                }

                const batchUpdatePlayerRequests = [];
                for (const playerId of Object.keys(playerUpdates)) {
                    const playerUpdate = playerUpdates[playerId];
                    const playerGlobalIndex = allPlayersData.findIndex(p => p[0] === playerId);
                    if (playerGlobalIndex !== -1) {
                        const currentPlayer = allPlayersData[playerGlobalIndex];
                        currentPlayer[3] = parseInt(currentPlayer[3] || 0) + playerUpdate.pointsChange;
                        currentPlayer[4] = parseInt(currentPlayer[4] || 0) + playerUpdate.gamesChange;
                        currentPlayer[5] = parseInt(currentPlayer[5] || 0) + playerUpdate.chamigoChange;
                        currentPlayer[6] = parseInt(currentPlayer[6] || 0) + playerUpdate.ttChange;

                        batchUpdatePlayerRequests.push({
                            range: `Jugadores!D${playerGlobalIndex + 2}:G${playerGlobalIndex + 2}`,
                            values: [[currentPlayer[3], currentPlayer[4], currentPlayer[5], currentPlayer[6]]]
                        });
                    }
                }

                if (batchUpdatePlayerRequests.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            data: batchUpdatePlayerRequests,
                            valueInputOption: 'RAW'
                        }
                    });
                }

                const sheetRowIndex = matchIndex + 2;

                if (sheetIds['Partidos'] === undefined) {
                    console.error("Sheet ID for 'Partidos' not found. Cannot delete row.");
                    alert("Error: No se pudo encontrar la hoja 'Partidos'. Por favor, recarga la página e intenta de nuevo.");
                    return;
                }

                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            deleteDimension: {
                                range: {
                                    sheetId: sheetIds['Partidos'],
                                    dimension: 'ROWS',
                                    startIndex: sheetRowIndex - 1,
                                    endIndex: sheetRowIndex
                                }
                            }
                        }]
                    }
                });

                alert('Partido eliminado y estadísticas revertidas exitosamente.');
                matchDateInput.value = '';
                matchResultSelect.value = '';
                document.querySelectorAll('#results-match-list .match-item').forEach(item => item.classList.remove('selected'));
                await loadAllDataAndDisplayAllContent();
            } catch (err) {
                console.error('Error al eliminar partido:', err);
                alert(`Error al eliminar partido: ${err.message}. Revisa la consola.`);
            }
        }


        // --- Funciones de Chamigo ---

        function handleChamigoMatchSelection(selectedMatchId) {
            chamigoVotingPlayersDiv.innerHTML = '';
            if (selectedMatchId) {
                const match = allMatchesData.find(m => m[0] === selectedMatchId);
                if (match) {
                    const clarosIDs = match[2] ? match[2].split(',') : [];
                    const oscurosIDs = match[3] ? match[3].split(',') : [];
                    const playersInMatchIDs = [...new Set([...clarosIDs, ...oscurosIDs])];

                    const playersInMatch = playersInMatchIDs.map(id => {
                        const player = allPlayersData.find(p => p[0] === id);
                        return { id: id, name: player ? player[1] : `ID:${id}` };
                    });
                    renderChamigoVotingPlayers(playersInMatch);

                    if (match[5]) {
                        try {
                            const existingVotes = JSON.parse(match[5]);
                            existingVotes.forEach(vote => {
                                const input = chamigoVotingPlayersDiv.querySelector(`input[data-id="${vote.id}"]`);
                                if (input) {
                                    input.value = vote.votos;
                                }
                            });
                        } catch (e) {
                            console.warn("Error al parsear votos de chamigo existentes:", e);
                        }
                    }
                }
            } else {
                chamigoVotingPlayersDiv.innerHTML = '<p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>';
            }
        }

        function renderChamigoVotingPlayers(playersInMatch) {
            chamigoVotingPlayersDiv.innerHTML = '';
            if (playersInMatch.length === 0) {
                chamigoVotingPlayersDiv.innerHTML = '<p class="text-gray-500">No hay jugadores para votar por Chamigo en este partido.</p>';
                return;
            }

            playersInMatch.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center space-x-2';
                playerDiv.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">${player.name}:</label>
                    <input type="number" data-id="${player.id}" class="chamigo-vote-input mt-1 block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" value="0" min="0">
                `;
                chamigoVotingPlayersDiv.appendChild(playerDiv);
            });
        }

        registerChamigoButton.addEventListener('click', async () => {
            const selectedMatchItem = document.querySelector('#chamigo-match-list .match-item.selected');
            if (!selectedMatchItem) {
                alert('Por favor, selecciona un partido de la lista para registrar el Chamigo.');
                return;
            }
            const selectedMatchId = selectedMatchItem.dataset.matchId;

            const matchIndex = allMatchesData.findIndex(m => m[0] === selectedMatchId);
            if (matchIndex === -1) {
                alert('Partido no encontrado.');
                return;
            }

            const currentMatch = allMatchesData[matchIndex];
            const voteInputs = document.querySelectorAll('.chamigo-vote-input');
            let votes = [];
            voteInputs.forEach(input => {
                const playerId = input.dataset.id;
                const numVotes = parseInt(input.value || 0);
                if (numVotes > 0) {
                    votes.push({ id: playerId, votos: numVotes });
                }
            });

            if (votes.length === 0) {
                alert('No se han ingresado votos para Chamigo.');
                return;
            }

            const maxVotes = Math.max(...votes.map(v => v.votos));
            const chamigosDelPartido = votes.filter(v => v.votos === maxVotes);

            currentMatch[5] = JSON.stringify(votes);

            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `Partidos!F${matchIndex + 2}`,
                    valueInputOption: 'RAW',
                    resource: { values: [[currentMatch[5]]] },
                });

                const updateRequests = [];
                chamigosDelPartido.forEach(chamigo => {
                    const playerGlobalIndex = allPlayersData.findIndex(p => p[0] === chamigo.id);
                    if (playerGlobalIndex !== -1) {
                        const currentPlayer = allPlayersData[playerGlobalIndex];
                        const currentChamigos = parseInt(currentPlayer[5] || 0);
                        currentPlayer[5] = currentChamigos + 1;

                        updateRequests.push({
                            range: `Jugadores!F${playerGlobalIndex + 2}`,
                            values: [[currentPlayer[5]]]
                        });
                    }
                });

                if (updateRequests.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            data: updateRequests,
                            valueInputOption: 'RAW'
                        }
                    });
                }

                alert('Chamigo(s) registrado(s) exitosamente.');
                document.querySelectorAll('.chamigo-vote-input').forEach(input => input.value = '0');
                await loadAllDataAndDisplayAllContent();
            } catch (err) {
                console.error('Error al registrar Chamigo:', err);
                alert(`Error al registrar Chamigo: ${err.message}. Revisa la consola.`);
            }
        });

        // --- Funciones de Asistencia TT ---

        function handleTtMatchSelection(selectedMatchId) {
            ttAttendancePlayersDiv.innerHTML = '';
            if (selectedMatchId) {
                const match = allMatchesData.find(m => m[0] === selectedMatchId);
                if (match) {
                    renderTtAttendancePlayers(allPlayersData.filter(p => p[2] === 'Activo').map(p => ({id: p[0], name: p[1]})));

                    if (match[6]) {
                        const existingAttendees = match[6].split(',');
                        existingAttendees.forEach(id => {
                            const checkbox = ttAttendancePlayersDiv.querySelector(`input[data-id="${id}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    }
                }
            } else {
                ttAttendancePlayersDiv.innerHTML = '<p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>';
            }
        }

        function renderTtAttendancePlayers(playersToRender) {
            ttAttendancePlayersDiv.innerHTML = '';
            if (playersToRender.length === 0) {
                ttAttendancePlayersDiv.innerHTML = '<p class="text-gray-500">No hay jugadores activos disponibles para registrar asistencia TT.</p>';
                return;
            }

            playersToRender.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center space-x-2';
                playerDiv.innerHTML = `
                    <input type="checkbox" id="tt-player-${player.id}" data-id="${player.id}" class="tt-checkbox h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label for="tt-player-${player.id}" class="text-sm font-medium text-gray-700">${player.name}</label>
                `;
                ttAttendancePlayersDiv.appendChild(playerDiv);
            });
        }

        registerTtButton.addEventListener('click', async () => {
            const selectedMatchItem = document.querySelector('#tt-match-list .match-item.selected');
            if (!selectedMatchItem) {
                alert('Por favor, selecciona un partido de la lista para registrar la asistencia TT.');
                return;
            }
            const selectedMatchId = selectedMatchItem.dataset.matchId;

            const matchIndex = allMatchesData.findIndex(m => m[0] === selectedMatchId);
            if (matchIndex === -1) {
                alert('Partido no encontrado.');
                return;
            }

            const currentMatch = allMatchesData[matchIndex];
            const ttAttendees = Array.from(document.querySelectorAll('.tt-checkbox:checked')).map(cb => cb.dataset.id);

            const prevTtAttendees = currentMatch[6] ? currentMatch[6].split(',').filter(Boolean) : [];
            const newAttendeesForPoints = ttAttendees.filter(id => !prevTtAttendees.includes(id));
            const removedAttendeesForPoints = prevTtAttendees.filter(id => !ttAttendees.includes(id));


            currentMatch[6] = ttAttendees.join(',');

            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `Partidos!G${matchIndex + 2}`,
                    valueInputOption: 'RAW',
                    resource: { values: [[currentMatch[6]]] },
                });

                const updateRequests = [];
                newAttendeesForPoints.forEach(playerId => {
                    const playerGlobalIndex = allPlayersData.findIndex(p => p[0] === playerId);
                    if (playerGlobalIndex !== -1) {
                        const currentPlayer = allPlayersData[playerGlobalIndex];
                        const currentTtAsistencias = parseInt(currentPlayer[6] || 0);
                        currentPlayer[6] = currentTtAsistencias + 1;

                        updateRequests.push({
                            range: `Jugadores!G${playerGlobalIndex + 2}`,
                            values: [[currentPlayer[6]]]
                        });
                    }
                });

                removedAttendeesForPoints.forEach(playerId => {
                    const playerGlobalIndex = allPlayersData.findIndex(p => p[0] === playerId);
                    if (playerGlobalIndex !== -1) {
                        const currentPlayer = allPlayersData[playerGlobalIndex];
                        const currentTtAsistencias = parseInt(currentPlayer[6] || 0);
                        currentPlayer[6] = currentTtAsistencias - 1;

                        updateRequests.push({
                            range: `Jugadores!G${playerGlobalIndex + 2}`,
                            values: [[currentPlayer[6]]]
                        });
                    }
                });


                if (updateRequests.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            data: updateRequests,
                            valueInputOption: 'RAW'
                        }
                    });
                }

                alert('Asistencia al Tercer Tiempo registrada exitosamente.');
                await loadAllDataAndDisplayAllContent();
            } catch (err) {
                console.error('Error al registrar asistencia TT:', err);
                alert(`Error al registrar asistencia TT: ${err.message}. Revisa la consola.`);
            }
        });


        // --- Utilidades ---
        function parseDate(dateString) {
            const [day, month, year] = dateString.split('/').map(Number);
            return new Date(year, month - 1, day);
        }

        function parseYYYYMMDDToLocalDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function formatDateToDDMMYYYY(date) {
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const yyyy = date.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }


        // --- Inicialización ---
        authorizeButton.addEventListener('click', handleAuthClick);
        signoutButtonSidebar.addEventListener('click', handleSignoutClick);
        signoutButtonMobileSidebar.addEventListener('click', handleSignoutClick);
        deleteMatchButton.addEventListener('click', deleteMatchButtonClickHandler);

        hamburgerButton.addEventListener('click', toggleSideMenu);
        closeSideMenuButton.addEventListener('click', toggleSideMenu);
        overlay.addEventListener('click', () => {
            if (window.innerWidth < 768) {
                toggleSideMenu();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Panel de Administración de Fútbol 5 cargado!');
            // Asegurarse de que el menú lateral y el botón de hamburguesa estén ocultos al inicio
            sideMenu.classList.add('hidden');
            hamburgerButton.classList.add('hidden');
            signoutButtonMobileSidebar.classList.add('hidden');
            signoutButtonSidebar.classList.add('hidden');
            adminContent.classList.add('hidden'); // Asegurarse que el contenido admin esté oculto

            gapiLoaded();
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.async = true;
            script.defer = true;
            script.onload = gisLoaded;
            document.head.appendChild(script);
        });
    </script>
</body>
</html>
