<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - LA CLANDE</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚽</text></svg>">

    <style>
        :root {
            --bg-primary: #f4f7fe;
            --bg-secondary: #ffffff;
            --bg-muted: #f9fafb;
            --sidebar-bg: #111827;
            --sidebar-text: #e5e7eb;
            --sidebar-active-bg: #4f46e5;
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #374151;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --accent-color: #4f46e5;
            --accent-color-hover: #4338ca;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }

        html.dark {
            --bg-primary: #030712;
            --bg-secondary: #1f2937;
            --bg-muted: #111827;
            --sidebar-bg: #111827;
            --sidebar-text: #e5e7eb;
            --sidebar-active-bg: #4f46e5;
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
            --accent-color: #6366f1;
            --accent-color-hover: #818cf8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        
        input, select {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        html.dark input, html.dark select {
             background-color: var(--bg-primary);
        }

        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        html.dark ::-webkit-scrollbar-thumb { background: #555; }
        html.dark ::-webkit-scrollbar-thumb:hover { background: #888; }

        /* Sidebar active link text color */
        .nav-link.active {
            background-color: var(--sidebar-active-bg);
            color: var(--sidebar-active-text) !important;
        }

        /* Player Draggable Styles */
        .player-draggable {
            transition: all 0.2s ease;
            cursor: grab;
        }
        .player-draggable:active {
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        .player-list-container {
             background-color: var(--bg-muted);
        }

        .player-drop-zone.drag-over {
            border-style: dashed;
            border-color: var(--accent-color);
            background-color: rgba(79, 70, 229, 0.05);
        }
        html.dark .player-drop-zone.drag-over {
            background-color: rgba(99, 102, 241, 0.1);
        }
        
        /* Match list item styles */
        .match-item {
            background-color: var(--bg-secondary);
        }
        .match-item.no-result { border-left-color: var(--danger-color); }
        .match-item.has-result { border-left-color: var(--success-color); }
        html.dark .match-item.no-result { background-color: rgba(239, 68, 68, 0.1); }
        html.dark .match-item.has-result { background-color: rgba(16, 185, 129, 0.1); }
        .match-item.selected { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color); }
        
        /* Table row selection style */
        .selectable-row.selected {
            background-color: rgba(79, 70, 229, 0.1) !important;
            --tw-ring-color: var(--accent-color);
            outline: 2px solid transparent;
            outline-offset: 2px;
            outline-color: var(--accent-color);
        }
        html.dark .selectable-row.selected {
             background-color: rgba(99, 102, 241, 0.2) !important;
        }
        
        /* TT Player Item Style */
        .tt-player-item.selected {
            background-color: var(--accent-color);
            color: var(--sidebar-active-text);
            border-color: var(--accent-color-hover);
        }
        .tt-player-item.selected span {
            color: var(--sidebar-active-text);
        }
        .tt-player-item.selected i {
            color: var(--sidebar-active-text);
        }

    </style>
</head>
<body class="antialiased">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-sidebar-bg text-sidebar-text flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40 flex">
            <div class="px-6 py-4 flex items-center justify-between">
                <a href="#" class="text-xl font-bold flex items-center gap-2">
                    <span class="text-2xl">⚽</span>
                    <span>LA CLANDE</span>
                </a>
                <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-sidebar-hover-bg">
                    <i class="fas fa-moon text-lg"></i>
                </button>
            </div>
            
            <nav id="main-nav" class="flex-1 px-4 space-y-2 overflow-y-auto">
                <!-- Nav items will be injected by JS -->
            </nav>

            <div class="px-4 py-4 mt-auto">
                <button id="signout_button" class="w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-sidebar-hover-bg transition-colors duration-200">
                    <i class="fas fa-sign-out-alt w-5 text-center"></i>
                    <span>Cerrar Sesión</span>
                </button>
            </div>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between p-4 border-b border-border-color bg-secondary md:hidden">
                <button id="sidebar-toggle" class="p-2 rounded-md">
                    <i class="fas fa-bars text-lg"></i>
                </button>
                 <button id="dark-mode-toggle-header" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fas fa-moon text-lg"></i>
                </button>
            </header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-primary p-4 sm:p-6 lg:p-8">
                <div id="admin-content-area" class="max-w-7xl mx-auto">
                    <!-- Loading State -->
                    <div id="loading-container" class="flex items-center justify-center h-64">
                        <i class="fas fa-spinner fa-spin text-4xl text-accent-color"></i>
                    </div>

                    <!-- Auth State -->
                    <div id="auth-container" class="hidden max-w-md mx-auto mt-16">
                        <div class="card rounded-xl shadow-lg p-8">
                            <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2>
                            <form id="login-form" class="space-y-4">
                                <div>
                                    <label for="email" class="block text-sm font-medium mb-1">Email</label>
                                    <input type="email" id="email" class="w-full p-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="password" class="block text-sm font-medium mb-1">Contraseña</label>
                                    <input type="password" id="password" class="w-full p-2 border rounded-md" required>
                                </div>
                                <button id="login-button" type="submit" class="w-full px-6 py-3 bg-accent-color text-white font-semibold rounded-lg shadow-md hover:bg-accent-color-hover transition duration-300">
                                    Entrar
                                </button>
                                <p id="auth-status" class="text-center text-danger-color mt-4 h-5"></p>
                            </form>
                        </div>
                    </div>

                    <!-- Main Admin Content (hidden by default) -->
                    <div id="admin-content" class="hidden">
                        <!-- Tab contents will be injected here -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

    <!-- Toast Notification -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <!-- Modal -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card rounded-lg shadow-xl max-w-sm w-full p-6">
            <h3 class="text-lg font-semibold mb-2" id="modal-title">Confirmar Acción</h3>
            <p class="text-secondary mb-6" id="modal-message">¿Estás seguro?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-button" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">Cancelar</button>
                <button id="modal-confirm-button" class="px-4 py-2 bg-danger-color text-white font-semibold rounded-md hover:opacity-90 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Main Admin Script -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & STATE ---
        const SUPABASE_URL = 'https://ezoqqzequstrzemlbsoa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6b3FxemVxdXN0cnplbWxic29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3Mjc4MzEsImV4cCI6MjA2ODMwMzgzMX0.v_i5kI1dXB4FEt-f8I6Fe5MetcktYnOyt7809un0VlQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const AppState = {
            players: [],
            matches: [],
            users: [],
            userRole: null,
            selectedMatchId: null,
            currentDraggedPlayerId: null,
            isInitialized: false, // Flag to check if initial data load is complete
        };

        const NAV_ITEMS = {
            main: [
                { id: 'team-formation', name: 'Armar Equipos', icon: 'fa-users-cog' },
                { id: 'match-results', name: 'Resultados', icon: 'fa-trophy' },
                { id: 'chamigo-management', name: 'Chamigo', icon: 'fa-star' },
                { id: 'tt-attendance', name: 'Asistencia TT', icon: 'fa-beer' },
            ],
            admin: [
                { id: 'edit-match', name: 'Editar Partido', icon: 'fa-edit' },
                { id: 'players-management', name: 'ABM Jugadores', icon: 'fa-user-plus' },
                { id: 'user-management', name: 'ABM Usuarios', icon: 'fa-user-shield' },
            ],
            links: [
                { href: 'index.html', name: 'Ver Estadísticas', icon: 'fa-chart-line' }
            ]
        };

        // --- DOM ELEMENTS ---
        const DOMElements = {
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            mainNav: document.getElementById('main-nav'),
            authContainer: document.getElementById('auth-container'),
            adminContent: document.getElementById('admin-content'),
            loadingContainer: document.getElementById('loading-container'),
            loginForm: document.getElementById('login-form'),
            signoutButton: document.getElementById('signout_button'),
            authStatus: document.getElementById('auth-status'),
            toastContainer: document.getElementById('toast-container'),
            modal: document.getElementById('custom-confirm-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirm: document.getElementById('modal-confirm-button'),
            modalCancel: document.getElementById('modal-cancel-button'),
        };

        // --- INITIALIZATION ---
        function init() {
            setupTheme();
            setupEventListeners();
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    if (!AppState.isInitialized) loadAdminPanel(session);
                } 
                else if (event === 'INITIAL_SESSION' && session) {
                    if (AppState.isInitialized) return; 
                    loadAdminPanel(session);
                } 
                else if (event === 'SIGNED_OUT' || (event === 'INITIAL_SESSION' && !session)) {
                    showLoginScreen();
                }
            });
        }

        async function loadAdminPanel(session) {
            if (AppState.isInitializing) return;
            AppState.isInitializing = true;
            
            DOMElements.authContainer.classList.add('hidden');
            DOMElements.loadingContainer.classList.remove('hidden');
            DOMElements.adminContent.classList.add('hidden');
            
            try {
                const { data: profile } = await supabase.from('profiles').select('role').eq('id', session.user.id).single();
                AppState.userRole = profile ? profile.role : null;

                const [playersRes, matchesRes, usersRes] = await Promise.allSettled([
                    supabase.from('players').select('*').order('id', { ascending: true }),
                    supabase.from('matches').select('*').order('match_date', { ascending: false }),
                    AppState.userRole === 'Admin' ? supabase.rpc('get_all_users_with_roles') : Promise.resolve({ data: [], error: null })
                ]);

                AppState.players = (playersRes.status === 'fulfilled' && !playersRes.value.error) ? (playersRes.value.data || []) : [];
                if (playersRes.status === 'rejected' || (playersRes.value && playersRes.value.error)) showToast("Error al cargar jugadores.", "error");

                AppState.matches = (matchesRes.status === 'fulfilled' && !matchesRes.value.error) ? (matchesRes.value.data || []) : [];
                if (matchesRes.status === 'rejected' || (matchesRes.value && matchesRes.value.error)) showToast("Error al cargar partidos.", "error");
                
                if (AppState.userRole === 'Admin') {
                    AppState.users = (usersRes.status === 'fulfilled' && usersRes.value && !usersRes.value.error) ? (usersRes.value.data || []) : [];
                    if (usersRes.status === 'rejected' || (usersRes.value && usersRes.value.error)) showToast("Error al cargar usuarios (Admin).", "error");
                }

                setupUI();
                
                const savedTab = localStorage.getItem('lastAdminTab');
                const allNavItems = [...NAV_ITEMS.main, ...NAV_ITEMS.admin];
                const isValidTab = allNavItems.some(item => item.id === savedTab);
                let initialTab = NAV_ITEMS.main[0].id;

                if (isValidTab) {
                    const isAdminTab = NAV_ITEMS.admin.some(item => item.id === savedTab);
                    if (!isAdminTab || (isAdminTab && AppState.userRole === 'Admin')) {
                        initialTab = savedTab;
                    }
                }
                navigateTo(initialTab);

            } catch (error) {
                console.error("Fatal error during admin panel setup:", error);
                showToast("Ocurrió un error inesperado al cargar el panel.", "error");
                await supabase.auth.signOut();
            } finally {
                DOMElements.loadingContainer.classList.add('hidden');
                DOMElements.adminContent.classList.remove('hidden');
                AppState.isInitializing = false;
                AppState.isInitialized = true;
            }
        }
        
        function showLoginScreen() {
            AppState.isInitialized = false;
            DOMElements.loadingContainer.classList.add('hidden');
            DOMElements.adminContent.classList.add('hidden');
            DOMElements.authContainer.classList.remove('hidden');
            DOMElements.sidebar.classList.add('-translate-x-full');
            DOMElements.sidebar.classList.remove('md:relative');
        }

        // --- UI & THEME ---
        function setupTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            document.getElementById('dark-mode-toggle').addEventListener('click', toggleTheme);
            document.getElementById('dark-mode-toggle-header').addEventListener('click', toggleTheme);
        }

        function toggleTheme() {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
        }

        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            document.querySelectorAll('#dark-mode-toggle, #dark-mode-toggle-header').forEach(btn => {
                btn.querySelector('i').classList.toggle('fa-moon', theme !== 'dark');
                btn.querySelector('i').classList.toggle('fa-sun', theme === 'dark');
            });
            localStorage.setItem('theme', theme);
        }

        function setupUI() {
            let navHtml = `
                <div>
                    <span class="px-4 text-xs font-semibold uppercase text-gray-400">Principal</span>
                    <div class="mt-2 space-y-1">
                        ${NAV_ITEMS.main.map(item => `
                            <a href="#" data-tab="${item.id}" class="nav-link w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-sidebar-hover-bg transition-colors duration-200">
                                <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                            </a>`).join('')}
                    </div>
                </div>`;
            
            if (AppState.userRole === 'Admin') {
                navHtml += `
                    <div class="mt-6">
                        <span class="px-4 text-xs font-semibold uppercase text-gray-400">Administración</span>
                        <div class="mt-2 space-y-1">
                            ${NAV_ITEMS.admin.map(item => `
                                <a href="#" data-tab="${item.id}" class="nav-link w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-sidebar-hover-bg transition-colors duration-200">
                                    <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                                </a>`).join('')}
                        </div>
                    </div>`;
            }

            navHtml += `
                <div class="mt-6">
                    <span class="px-4 text-xs font-semibold uppercase text-gray-400">Enlaces</span>
                    <div class="mt-2 space-y-1">
                        ${NAV_ITEMS.links.map(item => `
                            <a href="${item.href}" target="_blank" rel="noopener noreferrer" class="w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-sidebar-hover-bg transition-colors duration-200">
                                <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                            </a>`).join('')}
                    </div>
                </div>`;

            DOMElements.mainNav.innerHTML = navHtml;
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(e.currentTarget.dataset.tab);
                    if (window.innerWidth < 768) {
                        DOMElements.sidebar.classList.add('-translate-x-full');
                        DOMElements.sidebarOverlay.classList.add('hidden');
                    }
                });
            });
        }
        
        function navigateTo(tabId) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.tab === tabId);
            });
            
            const renderFunction = window[`render_${tabId.replace(/-/g, '_')}`];
            if (typeof renderFunction === 'function') {
                renderFunction();
                localStorage.setItem('lastAdminTab', tabId);
            } else {
                DOMElements.adminContent.innerHTML = `<h1 class="text-2xl font-bold">Contenido para ${tabId} no implementado.</h1>`;
            }
        }

        // --- EVENT LISTENERS & AUTH ---
        function setupEventListeners() {
            DOMElements.sidebarToggle.addEventListener('click', () => {
                DOMElements.sidebar.classList.remove('-translate-x-full');
                DOMElements.sidebarOverlay.classList.remove('hidden');
            });
            DOMElements.sidebarOverlay.addEventListener('click', () => {
                DOMElements.sidebar.classList.add('-translate-x-full');
                DOMElements.sidebarOverlay.classList.add('hidden');
            });
            DOMElements.loginForm.addEventListener('submit', handleLogin);
            DOMElements.signoutButton.addEventListener('click', () => supabase.auth.signOut());
        }

        async function handleLogin(e) {
            e.preventDefault();
            const loginButton = document.getElementById('login-button');
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
            
            const { error } = await supabase.auth.signInWithPassword({ 
                email: document.getElementById('email').value, 
                password: document.getElementById('password').value 
            });

            if (error) {
                DOMElements.authStatus.textContent = 'Email o contraseña incorrectos.';
                loginButton.disabled = false;
                loginButton.textContent = 'Entrar';
            }
        }

        // --- RENDER FUNCTIONS FOR TABS ---
        const tabContentTemplate = (title, content) => `
            <div class="space-y-6">
                <h1 class="text-3xl font-bold tracking-tight">${title}</h1>
                ${content}
            </div>`;

        window.render_team_formation = () => {
            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card rounded-xl shadow-sm p-6 space-y-4">
                        <h3 class="text-xl font-semibold">Jugadores Disponibles</h3>
                        <div>
                            <h4 class="font-medium mb-2 text-secondary">Titulares</h4>
                            <div id="titulares-players" class="player-list-container player-drop-zone border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-2 text-secondary">Suplentes</h4>
                            <div id="suplentes-players" class="player-list-container player-drop-zone border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                        </div>
                    </div>
                    <div class="card rounded-xl shadow-sm p-6 space-y-4">
                        <h3 class="text-xl font-semibold">Equipos (<span id="total-selected-players">0</span>/10)</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold mb-2">Claros (<span id="claros-count">0</span>)</h4>
                                <div id="team-claros" class="player-drop-zone border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-white"></div>
                            </div>
                             <div>
                                <h4 class="font-semibold mb-2">Oscuros (<span id="oscuros-count">0</span>)</h4>
                                <div id="team-oscuros" class="player-drop-zone border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-gray-800"></div>
                            </div>
                        </div>
                        <div class="pt-4">
                            <label for="team-match-date" class="block text-sm font-medium mb-1">Fecha del Partido</label>
                            <input type="date" id="team-match-date" class="w-full p-2 border rounded-md">
                        </div>
                        <button id="save-teams-button" class="w-full px-6 py-3 bg-accent-color text-white font-semibold rounded-lg shadow-md hover:bg-accent-color-hover transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Guardar Partido
                        </button>
                    </div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Armar Equipos', content);
            
            const titularesDiv = document.getElementById('titulares-players');
            const suplentesDiv = document.getElementById('suplentes-players');
            AppState.players.filter(p => p.status === 'Activo').forEach(player => {
                const playerEl = createDraggablePlayer(player);
                if (player.role === 'Titular') titularesDiv.appendChild(playerEl);
                else suplentesDiv.appendChild(playerEl);
            });
            setupDragAndDrop();
            document.getElementById('save-teams-button').addEventListener('click', handleSaveTeams);
        };

        const renderMatchSelectionTemplate = (prefix, panelContent) => `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 card rounded-xl shadow-sm p-6">
                    <h3 class="text-xl font-semibold mb-4">Seleccionar Partido</h3>
                    <div class="flex gap-2 mb-4">
                        <select id="${prefix}-year-select" class="w-full p-2 border rounded-md"></select>
                        <select id="${prefix}-month-select" class="w-full p-2 border rounded-md"></select>
                    </div>
                    <div id="${prefix}-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                       <p class="text-secondary">Cargando partidos...</p>
                    </div>
                </div>
                 <div id="${prefix}-selection-panel" class="lg:col-span-2 card rounded-xl shadow-sm p-6 hidden">
                    ${panelContent}
                </div>
            </div>`;

        window.render_match_results = () => {
            const panelContent = `
                <h3 class="text-xl font-semibold mb-4">Registrar Resultado</h3>
                <div class="space-y-4">
                     <div>
                        <label class="block text-sm font-medium mb-1">Fecha del Partido</label>
                        <input type="date" id="match-date" class="w-full p-2 border rounded-md bg-gray-100 dark:bg-gray-800" readonly>
                     </div>
                     <div>
                        <label for="match-result" class="block text-sm font-medium mb-1">Resultado</label>
                        <select id="match-result" class="w-full p-2 border rounded-md">
                             <option value="">Seleccionar resultado</option>
                             <option value="Claros">Claros</option>
                             <option value="Oscuros">Oscuros</option>
                             <option value="Empate">Empate</option>
                             <option value="Suspendido">Suspendido</option>
                        </select>
                     </div>
                     <div class="flex gap-4 pt-4">
                        <button id="register-match-button" class="flex-1 px-6 py-3 bg-success-color text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition">
                         Registrar Resultado
                        </button>
                        <button id="delete-match-button" class="flex-1 px-6 py-3 bg-danger-color text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition">
                         Eliminar Partido
                        </button>
                     </div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Resultados de Partidos', renderMatchSelectionTemplate('results', panelContent));
            populateMatchFilters('results');
        };
        
        window.render_chamigo_management = () => {
            const panelContent = `
                <h3 class="text-xl font-semibold mb-4">Registrar Votos de Chamigo</h3>
                <div id="chamigo-voting-players" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 max-h-[50vh] overflow-y-auto">
                    <p class="text-secondary col-span-full">Selecciona un partido para cargar los jugadores.</p>
                </div>
                <button id="register-chamigo-button" class="w-full mt-4 px-6 py-3 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition">
                    Registrar Chamigo(s)
                </button>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Gestión de Chamigo', renderMatchSelectionTemplate('chamigo', panelContent));
            populateMatchFilters('chamigo');
        };

        window.render_tt_attendance = () => {
             const panelContent = `
                <h3 class="text-xl font-semibold mb-4">Registrar Asistencia a Tercer Tiempo</h3>
                <div id="tt-attendance-players" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-4 max-h-[50vh] overflow-y-auto">
                    <p class="text-secondary col-span-full">Selecciona un partido para cargar los jugadores.</p>
                </div>
                <button id="register-tt-button" class="w-full mt-4 px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition">
                    Registrar Asistencia
                </button>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Asistencia a TT', renderMatchSelectionTemplate('tt', panelContent));
            populateMatchFilters('tt');
        };

        window.render_edit_match = () => {
            const panelContent = `
                <div id="edit-match-content" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card rounded-xl shadow-sm p-6 space-y-4">
                        <h3 class="text-xl font-semibold">Jugadores Disponibles</h3>
                        <div id="edit-available-players" class="player-list-container player-drop-zone border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                    </div>
                    <div class="card rounded-xl shadow-sm p-6 space-y-4">
                        <h3 class="text-xl font-semibold">Equipos del Partido</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold mb-2">Claros</h4>
                                <div id="edit-team-claros" class="player-drop-zone border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-white"></div>
                            </div>
                             <div>
                                <h4 class="font-semibold mb-2">Oscuros</h4>
                                <div id="edit-team-oscuros" class="player-drop-zone border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-gray-800"></div>
                            </div>
                        </div>
                        <div class="pt-4">
                            <label for="edit-match-date" class="block text-sm font-medium mb-1">Fecha del Partido</label>
                            <input type="date" id="edit-match-date" class="w-full p-2 border rounded-md">
                        </div>
                        <button id="update-match-button" class="w-full px-6 py-3 bg-accent-color text-white font-semibold rounded-lg shadow-md hover:bg-accent-color-hover transition">
                            Actualizar Partido
                        </button>
                    </div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Editar Partido', renderMatchSelectionTemplate('edit', panelContent));
            populateMatchFilters('edit');
        };

        window.render_players_management = () => {
            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold mb-4">Añadir/Modificar Jugador</h3>
                        <form id="player-form" class="space-y-4">
                            <input type="hidden" id="player-id">
                            <div>
                                <label for="player-name" class="block text-sm font-medium mb-1">Nombre</label>
                                <input type="text" id="player-name" class="w-full p-2 border rounded-md" required>
                            </div>
                            <div>
                                <label for="player-status" class="block text-sm font-medium mb-1">Estado</label>
                                <select id="player-status" class="w-full p-2 border rounded-md">
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                </select>
                            </div>
                            <div>
                                <label for="player-role" class="block text-sm font-medium mb-1">Rol</label>
                                <select id="player-role" class="w-full p-2 border rounded-md">
                                    <option value="Titular">Titular</option>
                                    <option value="Suplente">Suplente</option>
                                </select>
                            </div>
                            <div class="flex gap-3 pt-2">
                                <button type="submit" class="flex-1 px-4 py-2 bg-success-color text-white font-semibold rounded-lg shadow-md hover:opacity-90">Guardar</button>
                                <button type="button" id="clear-player-form-button" class="flex-1 px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:opacity-90">Limpiar</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold mb-4">Listado de Jugadores</h3>
                        <div class="overflow-x-auto max-h-[60vh]">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs uppercase bg-gray-50 dark:bg-gray-800">
                                    <tr>
                                        <th class="p-4">ID</th>
                                        <th class="p-4">Nombre</th>
                                        <th class="p-4">Estado</th>
                                        <th class="p-4">Rol</th>
                                    </tr>
                                </thead>
                                <tbody id="players-list-admin"></tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Gestión de Jugadores', content);
            renderPlayersListAdmin();
            document.getElementById('player-form').addEventListener('submit', handleSavePlayer);
            document.getElementById('clear-player-form-button').addEventListener('click', clearPlayerForm);
        };
        
        window.render_user_management = () => {
             const content = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold mb-4">Editar Usuario</h3>
                        <form id="user-form" class="space-y-4">
                            <input type="hidden" id="user-id">
                            <div>
                                <label for="user-email" class="block text-sm font-medium mb-1">Email</label>
                                <input type="email" id="user-email" class="w-full p-2 border rounded-md bg-gray-100 dark:bg-gray-800" readonly>
                            </div>
                            <div>
                                <label for="user-name" class="block text-sm font-medium mb-1">Nombre</label>
                                <input type="text" id="user-name" class="w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="user-role" class="block text-sm font-medium mb-1">Rol</label>
                                <select id="user-role" class="w-full p-2 border rounded-md">
                                    <option value="Operador">Operador</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div class="flex gap-3 pt-2">
                                <button type="submit" class="flex-1 px-4 py-2 bg-success-color text-white font-semibold rounded-lg shadow-md hover:opacity-90">Guardar</button>
                                <button type="button" id="clear-user-form-button" class="flex-1 px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:opacity-90">Limpiar</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold mb-4">Listado de Usuarios</h3>
                        <div class="overflow-x-auto max-h-[60vh]">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs uppercase bg-gray-50 dark:bg-gray-800">
                                    <tr>
                                        <th class="p-4">Email</th>
                                        <th class="p-4">Nombre</th>
                                        <th class="p-4">Rol</th>
                                    </tr>
                                </thead>
                                <tbody id="users-list-admin"></tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Gestión de Usuarios', content);
            renderUsersListAdmin();
            document.getElementById('user-form').addEventListener('submit', handleSaveUser);
            document.getElementById('clear-user-form-button').addEventListener('click', clearUserForm);
        };

        // --- HELPERS & LOGIC ---
        function createDraggablePlayer(player) {
            const el = document.createElement('div');
            el.className = 'player-draggable bg-gray-200 dark:bg-gray-700 text-sm font-medium px-3 py-1 rounded-full shadow-sm';
            el.draggable = true;
            el.dataset.id = player.id;
            el.textContent = player.name;
            el.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', player.id);
                e.target.classList.add('opacity-50');
            });
            el.addEventListener('dragend', (e) => e.target.classList.remove('opacity-50'));
            return el;
        }

        function setupDragAndDrop() {
            document.querySelectorAll('.player-drop-zone').forEach(zone => {
                zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', e => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    const playerId = e.dataTransfer.getData('text/plain');
                    const playerEl = document.querySelector(`.player-draggable[data-id="${playerId}"]`);
                    if (zone.id.startsWith('team-') && zone.children.length >= 5) {
                        showToast('El equipo ya tiene 5 jugadores.', 'warning');
                        return;
                    }
                    zone.appendChild(playerEl);
                    if (window.updateTeamCounts) updateTeamCounts();
                    if (window.updateEditTeamCounts) updateEditTeamCounts();
                });
            });
        }
        
        function updateTeamCounts() {
            const clarosCount = document.getElementById('team-claros').children.length;
            const oscurosCount = document.getElementById('team-oscuros').children.length;
            document.getElementById('claros-count').textContent = clarosCount;
            document.getElementById('oscuros-count').textContent = oscurosCount;
            document.getElementById('total-selected-players').textContent = clarosCount + oscurosCount;
            document.getElementById('save-teams-button').disabled = !(clarosCount === 5 && oscurosCount === 5);
        }

        async function handleSaveTeams() {
            const matchDate = document.getElementById('team-match-date').value;
            if (!matchDate) {
                showToast('Por favor, selecciona la fecha del partido.', 'warning');
                return;
            }
            const teamWhitePlayers = Array.from(document.getElementById('team-claros').children).map(el => el.dataset.id);
            const teamDarkPlayers = Array.from(document.getElementById('team-oscuros').children).map(el => el.dataset.id);

            const { data, error } = await supabase.from('matches').insert([{ 
                match_date: matchDate,
                team_white_players: teamWhitePlayers,
                team_dark_players: teamDarkPlayers,
                chamigo_votes: {},
                tt_attendees: []
            }]).select().single();

            if (error) {
                showToast(`Error al crear el partido: ${error.message}`, 'error');
            } else {
                showToast('Partido creado exitosamente!', 'success');
                AppState.matches.unshift(data);
                navigateTo('team-formation');
            }
        }
        
        function populateMatchFilters(prefix) {
            const yearSelect = document.getElementById(`${prefix}-year-select`);
            const monthSelect = document.getElementById(`${prefix}-month-select`);
            
            const years = [...new Set(AppState.matches.map(m => new Date(m.match_date).getFullYear()))].sort((a,b) => b-a);
            yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
            
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            monthSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            
            const today = new Date();
            if (years.includes(today.getFullYear())) yearSelect.value = today.getFullYear();
            monthSelect.value = today.getMonth();

            const renderList = () => {
                const listContainer = document.getElementById(`${prefix}-list`);
                const selectedYear = yearSelect.value;
                const selectedMonth = monthSelect.value;
                const filteredMatches = AppState.matches.filter(m => {
                    const d = new Date(m.match_date);
                    return d.getFullYear() == selectedYear && d.getMonth() == selectedMonth;
                });
                
                if (filteredMatches.length === 0) {
                    listContainer.innerHTML = '<p class="text-secondary">No hay partidos para este mes.</p>';
                    document.getElementById(`${prefix}-selection-panel`).classList.add('hidden');
                    return;
                }

                listContainer.innerHTML = filteredMatches.map(match => {
                    const d = new Date(match.match_date);
                    const formattedDate = d.toLocaleDateString('es-AR', {day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC'});
                    return `
                        <div class="match-item border-l-4 p-3 rounded-r-lg cursor-pointer transition" data-match-id="${match.id}">
                            <p class="font-semibold">${formattedDate}</p>
                            <p class="text-xs text-secondary">Resultado: ${match.result || 'Pendiente'}</p>
                        </div>`;
                }).join('');

                listContainer.querySelectorAll('.match-item').forEach(item => {
                    const match = AppState.matches.find(m => m.id == item.dataset.matchId);
                    item.classList.toggle('has-result', !!match.result);
                    item.classList.toggle('no-result', !match.result);
                    
                    item.addEventListener('click', (e) => {
                        listContainer.querySelectorAll('.match-item').forEach(i => i.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        handleMatchSelection(e.currentTarget.dataset.matchId, prefix);
                    });
                });
            };
            
            yearSelect.addEventListener('change', renderList);
            monthSelect.addEventListener('change', renderList);
            renderList();
        }

        function handleMatchSelection(matchId, prefix) {
            AppState.selectedMatchId = matchId;
            const match = AppState.matches.find(m => m.id == matchId);
            if (!match) return;
            
            const panel = document.getElementById(`${prefix}-selection-panel`);
            panel.classList.remove('hidden');

            const handlerMap = {
                'results': setupResultsPanel,
                'chamigo': setupChamigoPanel,
                'tt': setupTtPanel,
                'edit': setupEditMatchPanel,
            };

            if(handlerMap[prefix]) handlerMap[prefix](panel, match);
        }
        
        // --- PANEL SETUP FUNCTIONS ---
        function setupResultsPanel(panel, match) {
            panel.querySelector('#match-date').value = match.match_date;
            panel.querySelector('#match-result').value = match.result || '';
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#register-match-button').addEventListener('click', handleRegisterResult);
                panel.querySelector('#delete-match-button').addEventListener('click', handleDeleteMatch);
                panel.dataset.listenersAdded = 'true';
            }
        }

        function setupChamigoPanel(panel, match) {
            renderChamigoVotingPlayers(match);
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#register-chamigo-button').addEventListener('click', handleRegisterChamigo);
                panel.dataset.listenersAdded = 'true';
            }
        }

        function setupTtPanel(panel, match) {
            renderTtAttendancePlayers(match);
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#register-tt-button').addEventListener('click', handleRegisterTt);
                panel.dataset.listenersAdded = 'true';
            }
        }
        
        function setupEditMatchPanel(panel, match) {
            renderEditMatchPlayers(match);
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#update-match-button').addEventListener('click', handleUpdateMatch);
                panel.dataset.listenersAdded = 'true';
            }
        }

        // --- ACTION HANDLERS ---
        async function handleRegisterResult() {
            const result = document.getElementById('match-result').value;
            const { error } = await supabase.from('matches').update({ result }).eq('id', AppState.selectedMatchId);
            if(error) { showToast('Error al registrar resultado', 'error'); } 
            else {
                 showToast('Resultado registrado!', 'success');
                 const matchInState = AppState.matches.find(m => m.id == AppState.selectedMatchId);
                 if (matchInState) matchInState.result = result;
                 populateMatchFilters('results');
            }
        }
        
        async function handleDeleteMatch() {
            const confirmed = await showModal('Confirmar Eliminación', '¿Seguro que quieres eliminar este partido? Esta acción no se puede deshacer.');
            if (confirmed) {
                const { error } = await supabase.from('matches').delete().eq('id', AppState.selectedMatchId);
                if(error) { showToast('Error al eliminar partido', 'error'); } 
                else {
                    showToast('Partido eliminado.', 'success');
                    AppState.matches = AppState.matches.filter(m => m.id != AppState.selectedMatchId);
                    document.getElementById('results-selection-panel').classList.add('hidden');
                    populateMatchFilters('results');
                }
            }
        }
        
        function renderChamigoVotingPlayers(match) {
            const container = document.getElementById('chamigo-voting-players');
            container.innerHTML = '';
            const playerIDs = [...new Set([...(match.team_white_players||[]), ...(match.team_dark_players||[])])];
            const currentVotes = match.chamigo_votes || {};

            playerIDs.forEach(id => {
                const player = AppState.players.find(p => p.id === id);
                if (!player) return;
                
                const voteCount = currentVotes[id] || 0;
                const playerDiv = document.createElement('div');
                playerDiv.className = 'chamigo-player-item flex items-center justify-between p-2 border border-border-color rounded-lg';
                playerDiv.dataset.id = id;
                playerDiv.innerHTML = `
                    <span class="player-name">${player.name}</span>
                    <div class="chamigo-vote-controls flex items-center gap-2">
                        <button class="chamigo-vote-btn subtract-vote w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-600">-</button>
                        <span class="chamigo-vote-counter font-bold w-6 text-center">${voteCount}</span>
                        <button class="chamigo-vote-btn add-vote w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-600">+</button>
                    </div>`;
                
                playerDiv.querySelector('.add-vote').addEventListener('click', () => {
                    const counter = playerDiv.querySelector('.chamigo-vote-counter');
                    counter.textContent = parseInt(counter.textContent) + 1;
                });
                playerDiv.querySelector('.subtract-vote').addEventListener('click', () => {
                    const counter = playerDiv.querySelector('.chamigo-vote-counter');
                    counter.textContent = Math.max(0, parseInt(counter.textContent) - 1);
                });
                container.appendChild(playerDiv);
            });
        }
        
        async function handleRegisterChamigo() {
            const votes = {};
            document.querySelectorAll('.chamigo-player-item').forEach(item => {
                const count = parseInt(item.querySelector('.chamigo-vote-counter').textContent);
                if (count > 0) votes[item.dataset.id] = count;
            });
            
            const { error } = await supabase.from('matches').update({ chamigo_votes: votes }).eq('id', AppState.selectedMatchId);
            if (error) { showToast('Error al guardar votos de Chamigo', 'error'); } 
            else {
                showToast('Votos de Chamigo guardados!', 'success');
                const matchInState = AppState.matches.find(m => m.id == AppState.selectedMatchId);
                if (matchInState) matchInState.chamigo_votes = votes;
            }
        }
        
        function renderTtAttendancePlayers(match) {
            const container = document.getElementById('tt-attendance-players');
            container.innerHTML = '';
            const activePlayers = AppState.players.filter(p => p.status === 'Activo');
            const existingAttendees = match.tt_attendees || [];

            activePlayers.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'tt-player-item p-2 border border-border-color rounded-lg cursor-pointer text-center flex items-center justify-center gap-2';
                if (existingAttendees.includes(player.id)) {
                    playerDiv.classList.add('selected');
                }
                playerDiv.dataset.id = player.id;
                playerDiv.innerHTML = `<i class="fas fa-check-circle hidden"></i><span>${player.name}</span>`;
                
                const icon = playerDiv.querySelector('i');
                icon.style.display = playerDiv.classList.contains('selected') ? 'inline' : 'none';

                playerDiv.addEventListener('click', () => {
                    playerDiv.classList.toggle('selected');
                    icon.style.display = playerDiv.classList.contains('selected') ? 'inline' : 'none';
                });
                container.appendChild(playerDiv);
            });
        }
        
        async function handleRegisterTt() {
            const attendees = Array.from(document.querySelectorAll('#tt-attendance-players .selected')).map(el => el.dataset.id);
            const { error } = await supabase.from('matches').update({ tt_attendees: attendees }).eq('id', AppState.selectedMatchId);
            if (error) { showToast('Error al guardar asistencia a TT', 'error'); } 
            else {
                showToast('Asistencia a TT guardada!', 'success');
                const matchInState = AppState.matches.find(m => m.id == AppState.selectedMatchId);
                if (matchInState) matchInState.tt_attendees = attendees;
            }
        }
        
        function renderPlayersListAdmin() {
            const tableBody = document.getElementById('players-list-admin');
            tableBody.innerHTML = AppState.players.map(p => `
                <tr class="selectable-row border-b border-border-color hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer" data-player-id="${p.id}">
                    <td class="p-4">${p.id}</td><td class="p-4">${p.name}</td>
                    <td class="p-4">${p.status}</td><td class="p-4">${p.role}</td>
                </tr>`).join('');
            
            tableBody.querySelectorAll('.selectable-row').forEach(row => {
                row.addEventListener('click', () => {
                    tableBody.querySelectorAll('.selectable-row').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    populatePlayerForm(AppState.players.find(p => p.id === row.dataset.playerId));
                });
            });
        }

        function populatePlayerForm(player) {
            document.getElementById('player-id').value = player.id;
            document.getElementById('player-name').value = player.name;
            document.getElementById('player-status').value = player.status;
            document.getElementById('player-role').value = player.role;
        }
        
        function clearPlayerForm() {
            document.getElementById('player-form').reset();
            document.getElementById('player-id').value = '';
            document.querySelectorAll('#players-list-admin .selectable-row').forEach(r => r.classList.remove('selected'));
        }

        async function handleSavePlayer(e) {
            e.preventDefault();
            const id = document.getElementById('player-id').value;
            const playerData = {
                name: document.getElementById('player-name').value,
                status: document.getElementById('player-status').value,
                role: document.getElementById('player-role').value,
            };

            const { data, error } = id
                ? await supabase.from('players').update(playerData).eq('id', id).select().single()
                : await supabase.from('players').insert(playerData).select().single();

            if (error) {
                showToast(`Error al guardar jugador: ${error.message}`, 'error');
            } else {
                showToast('Jugador guardado exitosamente.', 'success');
                await refreshDataAndRender('players-management');
                clearPlayerForm();
            }
        }

        function renderUsersListAdmin() {
            const tableBody = document.getElementById('users-list-admin');
            tableBody.innerHTML = AppState.users.map(u => `
                <tr class="selectable-row border-b border-border-color hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer" data-user-id="${u.id}">
                    <td class="p-4">${u.email}</td>
                    <td class="p-4">${u.name || 'N/A'}</td>
                    <td class="p-4">${u.role || 'Sin Rol'}</td>
                </tr>`).join('');
            
            tableBody.querySelectorAll('.selectable-row').forEach(row => {
                row.addEventListener('click', () => {
                    tableBody.querySelectorAll('.selectable-row').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    populateUserForm(AppState.users.find(u => u.id === row.dataset.userId));
                });
            });
        }

        function populateUserForm(user) {
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-email').value = user.email;
            document.getElementById('user-name').value = user.name || '';
            document.getElementById('user-role').value = user.role || 'Operador';
        }

        function clearUserForm() {
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.querySelectorAll('#users-list-admin .selectable-row').forEach(r => r.classList.remove('selected'));
        }

        async function handleSaveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            if (!id) { showToast('Selecciona un usuario de la lista.', 'warning'); return; }
            const userData = {
                name: document.getElementById('user-name').value,
                role: document.getElementById('user-role').value,
            };
            const { error } = await supabase.from('profiles').update(userData).eq('id', id);
            if (error) { showToast(`Error al guardar usuario: ${error.message}`, 'error'); }
            else {
                showToast('Usuario guardado.', 'success');
                await refreshDataAndRender('user-management');
                clearUserForm();
            }
        }
        
        function renderEditMatchPlayers(match) {
            document.getElementById('edit-match-date').value = match.match_date;
            const availablePlayersDiv = document.getElementById('edit-available-players');
            const teamClarosDiv = document.getElementById('edit-team-claros');
            const teamOscurosDiv = document.getElementById('edit-team-oscuros');
            
            [availablePlayersDiv, teamClarosDiv, teamOscurosDiv].forEach(div => div.innerHTML = '');

            const matchPlayerIds = new Set([...(match.team_white_players || []), ...(match.team_dark_players || [])]);
            
            AppState.players.filter(p => p.status === 'Activo' && !matchPlayerIds.has(p.id))
                .forEach(p => availablePlayersDiv.appendChild(createDraggablePlayer(p)));

            (match.team_white_players || []).forEach(id => {
                const player = AppState.players.find(p => p.id === id);
                if (player) teamClarosDiv.appendChild(createDraggablePlayer(player));
            });
            (match.team_dark_players || []).forEach(id => {
                const player = AppState.players.find(p => p.id === id);
                if (player) teamOscurosDiv.appendChild(createDraggablePlayer(player));
            });
            
            setupDragAndDrop();
        }

        async function handleUpdateMatch() {
            const newDate = document.getElementById('edit-match-date').value;
            const newTeamWhite = Array.from(document.getElementById('edit-team-claros').children).map(el => el.dataset.id);
            const newTeamDark = Array.from(document.getElementById('edit-team-oscuros').children).map(el => el.dataset.id);
            
            if (newTeamWhite.length + newTeamDark.length !== 10) {
                showToast('Deben haber 10 jugadores en total.', 'warning');
                return;
            }

            const { error } = await supabase.from('matches').update({
                match_date: newDate,
                team_white_players: newTeamWhite,
                team_dark_players: newTeamDark
            }).eq('id', AppState.selectedMatchId);
            
            if (error) { showToast('Error al actualizar el partido.', 'error'); }
            else {
                showToast('Partido actualizado.', 'success');
                await refreshDataAndRender('edit-match');
            }
        }

        async function refreshDataAndRender(tabToRender) {
            const { data: players, pError } = await supabase.from('players').select('*').order('id');
            if (!pError) AppState.players = players;
            
            const { data: matches, mError } = await supabase.from('matches').select('*').order('match_date', { ascending: false });
            if (!mError) AppState.matches = matches;

            if(AppState.userRole === 'Admin') {
                const { data: users, uError } = await supabase.rpc('get_all_users_with_roles');
                if (!uError) AppState.users = users;
            }
            
            navigateTo(tabToRender);
        }

        function showToast(message, type = 'info') {
            const colors = { success: 'bg-success-color', error: 'bg-danger-color', warning: 'bg-warning-color', info: 'bg-blue-500' };
            const toast = document.createElement('div');
            toast.className = `w-full max-w-sm p-4 rounded-lg shadow-lg text-white ${colors[type]} mb-2`;
            toast.textContent = message;
            DOMElements.toastContainer.prepend(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function showModal(title, message) {
            return new Promise(resolve => {
                DOMElements.modalTitle.textContent = title;
                DOMElements.modalMessage.textContent = message;
                DOMElements.modal.classList.remove('hidden');
                const confirmHandler = () => { cleanup(); resolve(true); };
                const cancelHandler = () => { cleanup(); resolve(false); };
                const cleanup = () => {
                    DOMElements.modal.classList.add('hidden');
                    DOMElements.modalConfirm.removeEventListener('click', confirmHandler);
                    DOMElements.modalCancel.removeEventListener('click', cancelHandler);
                };
                DOMElements.modalConfirm.addEventListener('click', confirmHandler);
                DOMElements.modalCancel.addEventListener('click', cancelHandler);
            });
        }

        // --- RUN APP ---
        init();
    });
    </script>
</body>
</html>
