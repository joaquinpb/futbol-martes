
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - LA CLANDE</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚽</text></svg>">

    <style>
        :root {
            --bg-primary: #f4f7fe;
            --bg-secondary: #ffffff;
            --bg-muted: #f9fafb;
            --sidebar-bg: #111827;
            --sidebar-text: #e5e7eb;
            --sidebar-active-bg: #4f46e5;
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #374151;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --accent-color: #4f46e5;
            --accent-color-hover: #4338ca;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --button-text-color: #ffffff;
        }

        html.dark {
            --bg-primary: #030712;
            --bg-secondary: #1f2937;
            --bg-muted: #111827;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
            --accent-color: #6366f1;
            --accent-color-hover: #818cf8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        body:has(#mobile-menu.translate-x-0),
        body:has(#custom-confirm-modal:not(.hidden)),
        body:has(#player-assignment-modal:not(.hidden)),
        body:has(#notification-modal:not(.hidden)),
        body:has(#profile-modal:not(.hidden)) {
            overflow: hidden;
        }

        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        
        input, select {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        html.dark input, html.dark select {
             background-color: var(--bg-secondary);
             color: var(--text-primary);
        }
        
        html.dark input:-webkit-autofill,
        html.dark input:-webkit-autofill:hover, 
        html.dark input:-webkit-autofill:focus, 
        html.dark input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px var(--bg-secondary) inset !important;
            -webkit-text-fill-color: var(--text-primary) !important;
        }

        input[readonly] {
            background-color: var(--bg-muted) !important;
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        html.dark ::-webkit-scrollbar-thumb { background: #555; }
        html.dark ::-webkit-scrollbar-thumb:hover { background: #888; }

        .nav-link.active {
            background-color: var(--sidebar-active-bg);
            color: var(--sidebar-active-text) !important;
        }
        
        .player-element {
            background-color: #374151;
            color: #ffffff;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            white-space: nowrap; 
            width: auto; 
            display: inline-flex;
            align-items: center;
            flex-grow: 0;
            user-select: none;
        }
        .player-element:hover {
            transform: scale(1.05);
        }
        
        .player-list-container {
             background-color: var(--bg-muted);
             align-content: flex-start;
        }
        
        .match-item.no-result { border-left-color: var(--danger-color); }
        .match-item.has-result { border-left-color: var(--success-color); }
        html.dark .match-item.no-result { background-color: rgba(239, 68, 68, 0.1); }
        html.dark .match-item.has-result { background-color: rgba(16, 185, 129, 0.1); }
        .match-item.selected { 
            border-color: var(--accent-color); 
            box-shadow: 0 0 0 2px var(--accent-color);
        }
        
        .selectable-row:hover { background-color: #f9fafb !important; }
        html.dark .selectable-row:hover { background-color: #1f2937 !important; }
        .selectable-row.selected { background-color: #eef2ff !important; }
        html.dark .selectable-row.selected { background-color: #3730a3 !important; }
        
        .tt-player-item.selected {
            background-color: var(--accent-color);
            color: var(--sidebar-active-text);
            border-color: var(--accent-color-hover);
        }
        .tt-player-item.selected span, .tt-player-item.selected i {
            color: var(--sidebar-active-text);
        }
        
        thead th { color: var(--text-secondary); }
        html.dark thead th { color: var(--sidebar-text); }
        
        .button-primary { background-color: var(--accent-color); color: var(--button-text-color); }
        .button-primary:hover { background-color: var(--accent-color-hover); }
        .button-success { background-color: var(--success-color); color: var(--button-text-color); }
        .button-danger { background-color: var(--danger-color); color: var(--button-text-color); }
        .button-warning { background-color: var(--warning-color); color: var(--button-text-color); }
        .button-secondary { background-color: var(--text-secondary); color: var(--button-text-color); }
        .button-purple { background-color: #9333ea; color: var(--button-text-color); }
        .button-purple:hover { background-color: #7e22ce; }

        .bg-success-color { background-color: var(--success-color); }
        .bg-danger-color { background-color: var(--danger-color); }
        .bg-warning-color { background-color: var(--warning-color); }

        body.logged-out #app-container { display: none; }
        .login-bg { background: #f0f2f5; }
        html.dark .login-bg { background: linear-gradient(165deg, #0f172a 0%, #1e293b 100%); }
        
        #mobile-menu {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
        }
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            background-color: var(--bg-muted);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main Application Container -->
    <div id="app-container" class="flex min-h-screen hidden">
        <!-- Sidebar for Desktop -->
        <aside id="sidebar" class="w-64 bg-sidebar-bg text-sidebar-text flex-col hidden md:flex">
            <div class="px-6 py-4 flex items-center">
                <a href="#" class="text-xl font-bold flex items-center gap-2">
                    <span class="text-2xl">⚽</span>
                    <span>LA CLANDE</span>
                </a>
            </div>
            
            <nav id="main-nav" class="flex-1 px-4 space-y-2 overflow-y-auto">
                <!-- Desktop nav items will be injected by JS -->
            </nav>

            <div class="px-4 py-4 mt-auto">
                 <button id="desktop-dark-mode-toggle" class="w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-sidebar-hover-bg transition-colors duration-200">
                    <i class="fas fa-moon w-5 text-center"></i>
                    <span>Modo Oscuro</span>
                </button>
            </div>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col relative">
            <!-- Header for Mobile -->
            <header class="flex items-center justify-between p-4 border-b border-border-color bg-bg-secondary sticky top-0 z-30 md:hidden">
                <button id="mobile-menu-toggle" class="p-2 rounded-md -ml-2">
                    <i class="fas fa-bars text-lg"></i>
                </button>
                <a href="#" class="text-xl font-bold flex items-center gap-2 justify-center">
                    <span class="text-2xl">⚽</span>
                    <span>LA CLANDE</span>
                </a>
                <!-- Spacer -->
                <div class="w-8"></div>
            </header>
            
            <main class="bg-primary p-4 sm:p-6 lg:p-8">
                <div id="admin-content-area" class="max-w-7xl mx-auto">
                    <!-- Loading State -->
                    <div id="loading-container" class="flex items-center justify-center h-64">
                        <i class="fas fa-spinner fa-spin text-4xl text-accent-color"></i>
                    </div>

                    <!-- Main Admin Content (hidden by default) -->
                    <div id="admin-content" class="hidden">
                        <!-- Tab contents will be injected here -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Mobile Menu -->
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>
    <div id="mobile-menu" class="hidden fixed top-0 left-0 h-full w-64 bg-secondary shadow-xl z-50 transform -translate-x-full transition-transform duration-300 ease-in-out">
        <!-- Mobile menu content injected here -->
    </div>


    <!-- Authentication Container -->
    <div id="auth-container" class="hidden fixed inset-0 z-50 flex items-center justify-center login-bg">
        <div class="w-full max-w-md p-4">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-text-secondary">Panel de Administración</h1>
                <h2 class="text-4xl font-extrabold text-text-primary mt-2 flex items-center justify-center gap-3">
                    <span>LA CLANDE ⚽</span>
                </h2>
            </div>
            <div class="card rounded-xl shadow-lg p-8 relative">
                <div class="absolute top-4 right-4">
                    <button id="login-dark-mode-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fas fa-moon text-lg text-text-secondary"></i>
                    </button>
                </div>
                <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="email" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium mb-1">Contraseña</label>
                        <div class="relative">
                            <input type="password" id="password" class="w-full p-2 border rounded-md pr-10" required>
                            <button type="button" id="password-toggle" class="absolute inset-y-0 right-0 px-3 flex items-center text-text-secondary">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-right">
                        <a href="recuperar-pass.html" class="text-sm font-medium text-accent-color hover:text-accent-color-hover">¿Olvidaste tu contraseña?</a>
                    </div>
                    <button id="login-button" type="submit" class="w-full px-6 py-3 button-primary font-semibold rounded-lg shadow-md transition duration-300">
                        Entrar
                    </button>
                    <p id="auth-status" class="text-center text-danger-color mt-4 h-5"></p>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Notification Modal -->
    <div id="notification-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-[100] p-4">
        <div id="notification-content" class="flex items-center gap-4 text-white font-semibold p-6 rounded-lg shadow-xl max-w-sm w-full">
            <i id="notification-icon" class="fas fa-2x"></i>
            <span id="notification-message"></span>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card rounded-lg shadow-xl max-w-sm w-full p-6">
            <h3 class="text-lg font-semibold mb-2" id="modal-title">Confirmar Acción</h3>
            <p class="text-secondary mb-6" id="modal-message">¿Estás seguro?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-button" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">Cancelar</button>
                <button id="modal-confirm-button" class="px-4 py-2 button-danger font-semibold rounded-md hover:opacity-90 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Player Assignment Modal -->
    <div id="player-assignment-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card rounded-lg shadow-xl max-w-xs w-full p-6 text-center">
            <h3 class="text-lg font-semibold mb-2" id="assign-modal-title">Asignar Jugador</h3>
            <p class="text-secondary mb-6" id="assign-modal-player-name">Nombre del Jugador</p>
            <div class="flex flex-col space-y-3">
                <button id="assign-to-claros" class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-100 text-black font-semibold rounded-md hover:opacity-90 transition">Mover a Claros</button>
                <button id="assign-to-oscuros" class="w-full px-4 py-2 bg-gray-800 text-white font-semibold rounded-md hover:opacity-90 transition">Mover a Oscuros</button>
                <button id="assign-modal-cancel" class="mt-4 text-sm text-secondary hover:underline">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card rounded-lg shadow-xl max-w-md w-full p-6 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">Editar Perfil</h3>
                <button id="profile-modal-close-button" class="p-2 -mr-2 rounded-full hover:bg-bg-muted"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="profile-form" class="space-y-4">
                <h4 class="font-semibold text-text-secondary border-b border-border-color pb-2">Mis Datos</h4>
                <div class="flex flex-col items-center space-y-4">
                    <div id="profile-avatar-preview" class="avatar-preview border-2 border-border-color"></div>
                    <input type="file" id="profile-avatar-input" class="hidden" accept="image/png, image/jpeg">
                    <button type="button" id="profile-avatar-button" class="px-4 py-2 text-sm border border-border-color rounded-md hover:bg-bg-muted">
                        Cambiar foto
                    </button>
                </div>
                <div>
                    <label for="profile-email" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="profile-email" class="w-full p-2 border rounded-md" readonly>
                </div>
                <div>
                    <label for="profile-name" class="block text-sm font-medium mb-1">Nombre</label>
                    <input type="text" id="profile-name" class="w-full p-2 border rounded-md" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 button-success font-semibold rounded-lg shadow-md hover:opacity-90">Guardar Cambios</button>
                <p id="profile-message" class="text-center h-5 mt-2"></p>
            </form>

            <div class="border-t border-border-color my-6"></div>

            <form id="password-form-modal" class="space-y-4">
                <h4 class="font-semibold text-text-secondary border-b border-border-color pb-2">Cambiar Contraseña</h4>
                <div>
                    <label for="modal-new-password" class="block text-sm font-medium mb-1">Nueva Contraseña</label>
                    <input type="password" id="modal-new-password" class="w-full p-2 border rounded-md" required placeholder="Mínimo 6 caracteres">
                </div>
                <button type="submit" class="w-full px-4 py-2 button-primary font-semibold rounded-lg shadow-md hover:opacity-90">Actualizar Contraseña</button>
                 <p id="password-message" class="text-center h-5 mt-2"></p>
            </form>
        </div>
    </div>


    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Main Admin Script -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & STATE ---
        const SUPABASE_URL = 'https://ezoqqzequstrzemlbsoa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6b3FxemVxdXN0cnplbWxic29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3Mjc4MzEsImV4cCI6MjA2ODMwMzgzMX0.v_i5kI1dXB4FEt-f8I6Fe5MetcktYnOyt7809un0VlQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const AppState = {
            players: [],
            matches: [],
            users: [],
            currentUser: null,
            userProfile: null,
            userRole: null,
            selectedMatchId: null,
            isInitialized: false,
            activePlayerElement: null,
        };

        const NAV_ITEMS = {
            main: [
                { id: 'team-formation', name: 'Armar Equipos', icon: 'fa-users-cog' },
                { id: 'match-results', name: 'Resultados', icon: 'fa-trophy' },
                { id: 'chamigo-management', name: 'Chamigo', icon: 'fa-star' },
                { id: 'tt-attendance', name: 'Asistencia TT', icon: 'fa-beer' },
            ],
            admin: [
                { id: 'edit-match', name: 'Editar Partido', icon: 'fa-edit' },
                { id: 'players-management', name: 'ABM Jugadores', icon: 'fa-user-plus' },
                { id: 'user-management', name: 'ABM Usuarios', icon: 'fa-user-shield' },
            ],
            links: [
                { href: 'index.html', name: 'Ver Estadísticas', icon: 'fa-chart-line' }
            ]
        };

        // --- DOM ELEMENTS ---
        const DOMElements = {
            body: document.body,
            appContainer: document.getElementById('app-container'),
            mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
            mobileMenu: document.getElementById('mobile-menu'),
            mobileMenuOverlay: document.getElementById('mobile-menu-overlay'),
            mainNav: document.getElementById('main-nav'),
            authContainer: document.getElementById('auth-container'),
            adminContent: document.getElementById('admin-content'),
            loadingContainer: document.getElementById('loading-container'),
            loginForm: document.getElementById('login-form'),
            desktopDarkModeToggle: document.getElementById('desktop-dark-mode-toggle'),
            loginDarkModeToggle: document.getElementById('login-dark-mode-toggle'),
            authStatus: document.getElementById('auth-status'),
            // Profile Modal
            profileModal: document.getElementById('profile-modal'),
            profileModalCloseButton: document.getElementById('profile-modal-close-button'),
            profileForm: document.getElementById('profile-form'),
            passwordFormModal: document.getElementById('password-form-modal'),
            profileMessage: document.getElementById('profile-message'),
            passwordMessage: document.getElementById('password-message'),
            profileAvatarPreview: document.getElementById('profile-avatar-preview'),
            profileAvatarInput: document.getElementById('profile-avatar-input'),
            profileAvatarButton: document.getElementById('profile-avatar-button'),
            // Confirmation Modal
            modal: document.getElementById('custom-confirm-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirm: document.getElementById('modal-confirm-button'),
            modalCancel: document.getElementById('modal-cancel-button'),
            // Player Assignment Modal
            playerAssignmentModal: document.getElementById('player-assignment-modal'),
            assignModalPlayerName: document.getElementById('assign-modal-player-name'),
            assignToClarosBtn: document.getElementById('assign-to-claros'),
            assignToOscurosBtn: document.getElementById('assign-to-oscuros'),
            assignModalCancelBtn: document.getElementById('assign-modal-cancel'),
            // Notification Modal
            notificationModal: document.getElementById('notification-modal'),
            notificationContent: document.getElementById('notification-content'),
            notificationIcon: document.getElementById('notification-icon'),
            notificationMessage: document.getElementById('notification-message'),
        };

        // --- INITIALIZATION ---
        function init() {
            setupTheme();
            setupEventListeners();
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' || (event === 'INITIAL_SESSION' && session)) {
                    AppState.currentUser = session.user;
                    if (!AppState.isInitialized) loadAdminPanel(session);
                } 
                else if (event === 'SIGNED_OUT' || (event === 'INITIAL_SESSION' && !session)) {
                    AppState.currentUser = null;
                    showLoginScreen();
                }
            });
        }

        async function loadAdminPanel(session) {
            if (AppState.isInitializing) return;
            AppState.isInitializing = true;
            DOMElements.body.classList.remove('logged-out');
            
            DOMElements.authContainer.classList.add('hidden');
            DOMElements.appContainer.classList.remove('hidden');
            DOMElements.loadingContainer.classList.remove('hidden');
            DOMElements.adminContent.classList.add('hidden');
            
            try {
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('role, name, status, avatar_url')
                    .eq('id', session.user.id)
                    .single();

                if (profileError) throw profileError;
                
                if (profile.status === 'inactive') {
                    showNotification('Tu cuenta ha sido desactivada.', 'error');
                    await supabase.auth.signOut();
                    return; 
                }

                AppState.userProfile = profile;
                AppState.userRole = profile ? profile.role : null;
                
                const [playersRes, matchesRes, usersRes] = await Promise.allSettled([
                    supabase.from('players').select('*').order('id', { ascending: true }),
                    supabase.from('matches').select('*').order('match_date', { ascending: false }),
                    // CAMBIO AQUI: Se pasa un objeto vacío {} como segundo argumento a rpc
                    AppState.userRole === 'Admin' ? supabase.rpc('get_all_users_with_roles', {}) : Promise.resolve({ data: [], error: null })
                ]);

                AppState.players = (playersRes.status === 'fulfilled' && !playersRes.value.error) ? (playersRes.value.data || []) : [];
                if (playersRes.value?.error) showNotification("Error al cargar jugadores.", "error");

                AppState.matches = (matchesRes.status === 'fulfilled' && !matchesRes.value.error) ? (matchesRes.value.data || []) : [];
                if (matchesRes.value?.error) showNotification("Error al cargar partidos.", "error");
                
                if (AppState.userRole === 'Admin') {
                    AppState.users = (usersRes.status === 'fulfilled' && usersRes.value && !usersRes.value.error) ? (usersRes.value.data || []) : [];
                    if (usersRes.value?.error) showNotification("Error al cargar usuarios (Admin).", "error");
                }

                setupUI();
                
                const savedTab = localStorage.getItem('lastAdminTab');
                const allNavItems = [...NAV_ITEMS.main, ...NAV_ITEMS.admin];
                const isValidTab = allNavItems.some(item => item.id === savedTab);
                let initialTab = NAV_ITEMS.main[0].id;

                if (isValidTab) {
                    const isAdminTab = NAV_ITEMS.admin.some(item => item.id === savedTab);
                    if (!isAdminTab || (isAdminTab && AppState.userRole === 'Admin')) {
                        initialTab = savedTab;
                    }
                }
                navigateTo(initialTab);

            } catch (error) {
                console.error("Fatal error during admin panel setup:", error);
                showNotification(`Ocurrió un error inesperado: ${error.message}`, "error");
                await supabase.auth.signOut();
            } finally {
                DOMElements.loadingContainer.classList.add('hidden');
                DOMElements.adminContent.classList.remove('hidden');
                AppState.isInitializing = false;
                AppState.isInitialized = true;
                window.scrollTo(0, 0);
            }
        }
        
        function showLoginScreen() {
            AppState.isInitialized = false;
            DOMElements.body.classList.add('logged-out');
            DOMElements.appContainer.classList.add('hidden');
            DOMElements.loadingContainer.classList.add('hidden');
            DOMElements.adminContent.classList.add('hidden');
            DOMElements.authContainer.classList.remove('hidden');
            DOMElements.mobileMenu.classList.remove('translate-x-0');
            DOMElements.mobileMenu.classList.add('-translate-x-full');
            DOMElements.mobileMenuOverlay.classList.add('hidden');

            const loginButton = document.getElementById('login-button');
            if (loginButton) {
                loginButton.disabled = false;
                loginButton.innerHTML = 'Entrar';
            }
            DOMElements.loginForm.reset();
            DOMElements.authStatus.textContent = '';
        }

        // --- UI & THEME ---
        function setupTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            }
            DOMElements.desktopDarkModeToggle.addEventListener('click', toggleTheme);
            DOMElements.loginDarkModeToggle.addEventListener('click', toggleTheme);
        }

        function toggleTheme() {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
        }

        function updateThemeToggleIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            const toggleButtons = [
                DOMElements.desktopDarkModeToggle, 
                DOMElements.loginDarkModeToggle,
                document.getElementById('mobile-dark-mode-toggle')
            ];

            toggleButtons.forEach(btn => {
                if (btn) {
                    const icon = btn.querySelector('i');
                    icon.classList.toggle('fa-moon', !isDark);
                    icon.classList.toggle('fa-sun', isDark);
                }
            });
        }

        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            localStorage.setItem('theme', theme);
            updateThemeToggleIcons();
        }

        function setupUI() {
            setupDesktopNav();
            setupMobileMenu();
        }
        
        function setupDesktopNav() {
            let navHtml = `
                <div>
                    <span class="px-4 text-xs font-semibold uppercase text-gray-400">Principal</span>
                    <div class="mt-2 space-y-1">
                        ${NAV_ITEMS.main.map(item => `
                            <a href="#" data-tab="${item.id}" class="nav-link w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-sidebar-hover-bg transition-colors duration-200">
                                <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                            </a>`).join('')}
                    </div>
                </div>`;
            
            if (AppState.userRole === 'Admin') {
                navHtml += `
                    <div class="mt-6" data-role="Admin">
                        <span class="px-4 text-xs font-semibold uppercase text-gray-400">Administración</span>
                        <div class="mt-2 space-y-1">
                            ${NAV_ITEMS.admin.map(item => `
                                <a href="#" data-tab="${item.id}" class="nav-link w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-sidebar-hover-bg transition-colors duration-200">
                                    <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                                </a>`).join('')}
                        </div>
                    </div>`;
            }

            navHtml += `
                <div class="mt-6">
                    <span class="px-4 text-xs font-semibold uppercase text-gray-400">Enlaces</span>
                    <div class="mt-2 space-y-1">
                        ${NAV_ITEMS.links.map(item => `
                            <a href="${item.href}" target="_blank" rel="noopener noreferrer" class="w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-sidebar-hover-bg transition-colors duration-200">
                                <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                            </a>`).join('')}
                    </div>
                </div>`;

            DOMElements.mainNav.innerHTML = navHtml;
            
            document.querySelectorAll('#main-nav .nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(e.currentTarget.dataset.tab);
                });
            });
        }
        
        function setupMobileMenu() {
            const adminItemsHtml = AppState.userRole === 'Admin' ? NAV_ITEMS.admin.map(item => `<li><a href="#" data-tab="${item.id}" class="nav-link block px-4 py-2 text-sm text-text-secondary hover:bg-bg-muted rounded-md">${item.name}</a></li>`).join('') : '';

            const menuHtml = `
                <div class="p-4 flex justify-between items-center border-b border-border-color">
                    <span class="font-bold">Menú</span>
                    <button id="close-mobile-menu" class="p-2 -mr-2"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-2 space-y-1">
                    <div>
                        <button id="mobile-main-trigger" class="collapsible-trigger w-full flex justify-between items-center px-2 py-2 text-left font-semibold text-text-primary rounded-md hover:bg-bg-muted">
                            <span>Principal</span>
                            <i class="fas fa-chevron-down transform transition-transform"></i>
                        </button>
                        <ul id="mobile-main-content" class="collapsible-content mt-1 space-y-1 pl-4">
                            ${NAV_ITEMS.main.map(item => `<li><a href="#" data-tab="${item.id}" class="nav-link block px-4 py-2 text-sm text-text-secondary hover:bg-bg-muted rounded-md">${item.name}</a></li>`).join('')}
                        </ul>
                    </div>
                    ${AppState.userRole === 'Admin' ? `
                    <div>
                        <button class="collapsible-trigger w-full flex justify-between items-center px-2 py-2 text-left font-semibold text-text-primary rounded-md hover:bg-bg-muted">
                            <span>Administración</span>
                            <i class="fas fa-chevron-down transform transition-transform"></i>
                        </button>
                        <ul class="collapsible-content hidden mt-1 space-y-1 pl-4">
                            ${adminItemsHtml}
                        </ul>
                    </div>` : ''}
                    <div class="border-t border-border-color my-1"></div>
                    <div>
                        <a href="${NAV_ITEMS.links[0].href}" target="_blank" rel="noopener noreferrer" class="w-full flex items-center gap-3 px-2 py-2 text-left font-semibold text-text-primary rounded-md hover:bg-bg-muted">
                            <i class="fas ${NAV_ITEMS.links[0].icon} w-5 text-center"></i>
                            <span>${NAV_ITEMS.links[0].name}</span>
                        </a>
                    </div>
                    <div class="border-t border-border-color my-1"></div>
                    <button id="mobile-dark-mode-toggle" class="w-full flex items-center gap-3 px-2 py-2 text-left text-text-secondary rounded-md hover:bg-bg-muted">
                        <i class="fas fa-moon w-5 text-center"></i>
                        <span>Modo Oscuro</span>
                    </button>
                </div>
            `;
            DOMElements.mobileMenu.innerHTML = menuHtml;
            
            const mainContent = document.getElementById('mobile-main-content');
            const mainTriggerIcon = document.getElementById('mobile-main-trigger').querySelector('i');
            mainContent.classList.remove('hidden');
            mainTriggerIcon.classList.add('rotate-180');
            
            DOMElements.mobileMenu.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    e.stopPropagation();
                    navigateTo(e.currentTarget.dataset.tab);
                    closeMobileMenu();
                });
            });
            
            DOMElements.mobileMenu.querySelectorAll('.collapsible-trigger').forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const content = trigger.nextElementSibling;
                    const icon = trigger.querySelector('i');
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                });
            });
            
            document.getElementById('mobile-dark-mode-toggle').addEventListener('click', toggleTheme);
            document.getElementById('close-mobile-menu').addEventListener('click', closeMobileMenu);
            
            updateThemeToggleIcons();
        }
        
        function navigateTo(tabId) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.tab === tabId);
            });
            
            const renderFunction = window[`render_${tabId.replace(/-/g, '_')}`];
            if (typeof renderFunction === 'function') {
                renderFunction();
                localStorage.setItem('lastAdminTab', tabId);
                setupDynamicHeaderContent();
            } else {
                DOMElements.adminContent.innerHTML = `<h1 class="text-2xl font-bold">Contenido para ${tabId} no implementado.</h1>`;
            }
        }

        // --- EVENT LISTENERS & AUTH ---
        function openMobileMenu() {
            DOMElements.mobileMenuOverlay.classList.remove('hidden');
            DOMElements.mobileMenu.classList.remove('hidden');
            setTimeout(() => {
                 DOMElements.mobileMenu.classList.remove('-translate-x-full');
                 DOMElements.mobileMenu.classList.add('translate-x-0');
            }, 10);
        }

        function closeMobileMenu() {
            DOMElements.mobileMenu.classList.add('-translate-x-full');
            DOMElements.mobileMenu.classList.remove('translate-x-0');
            DOMElements.mobileMenuOverlay.classList.add('hidden');
        }

        function setupEventListeners() {
            DOMElements.mobileMenuToggle.addEventListener('click', openMobileMenu);
            DOMElements.mobileMenuOverlay.addEventListener('click', closeMobileMenu);
            
            DOMElements.loginForm.addEventListener('submit', handleLogin);
            
            // Profile Modal Listeners
            DOMElements.profileModalCloseButton.addEventListener('click', () => DOMElements.profileModal.classList.add('hidden'));
            DOMElements.profileForm.addEventListener('submit', handleUpdateProfile);
            DOMElements.passwordFormModal.addEventListener('submit', handleUpdatePassword);
            DOMElements.profileAvatarButton.addEventListener('click', () => DOMElements.profileAvatarInput.click());
            DOMElements.profileAvatarInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        DOMElements.profileAvatarPreview.style.backgroundImage = `url('${e.target.result}')`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Global click listener
            document.addEventListener('click', (e) => {
                if (e.target.closest('.signout-trigger')) {
                     supabase.auth.signOut().catch(err => showNotification(`Error: ${err.message}`, 'error'));
                }
                
                const userMenuButton = document.getElementById('user-menu-button-main');
                const userMenuDropdown = document.getElementById('user-menu-dropdown-main');
                if (userMenuButton && userMenuDropdown && !userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) {
                    userMenuDropdown.classList.add('hidden');
                }
            });

            const passwordInput = document.getElementById('password');
            const passwordToggle = document.getElementById('password-toggle');
            if (passwordToggle && passwordInput) {
                passwordToggle.addEventListener('click', () => {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    passwordToggle.querySelector('i').classList.toggle('fa-eye-slash');
                });
            }

            // Player Assignment Modal Listeners
            DOMElements.assignToClarosBtn.addEventListener('click', () => movePlayerToTeam('team-claros'));
            DOMElements.assignToOscurosBtn.addEventListener('click', () => movePlayerToTeam('team-oscuros'));
            DOMElements.assignModalCancelBtn.addEventListener('click', hidePlayerAssignmentModal);
            DOMElements.playerAssignmentModal.addEventListener('click', (e) => {
                if (e.target.id === 'player-assignment-modal') {
                    hidePlayerAssignmentModal();
                }
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            const loginButton = document.getElementById('login-button');
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
            DOMElements.authStatus.textContent = '';
            
            const { data: { session }, error } = await supabase.auth.signInWithPassword({ 
                email: document.getElementById('email').value, 
                password: document.getElementById('password').value 
            });

            if (error) {
                DOMElements.authStatus.textContent = 'Email o contraseña incorrectos.';
                loginButton.disabled = false;
                loginButton.textContent = 'Entrar';
                return;
            }
            
            if (session) {
                 const { data: profile } = await supabase
                    .from('profiles')
                    .select('status')
                    .eq('id', session.user.id)
                    .single();
                
                if (profile && profile.status === 'inactive') {
                    DOMElements.authStatus.textContent = 'Tu cuenta está desactivada. Contacta al administrador.';
                    loginButton.disabled = false;
                    loginButton.textContent = 'Entrar';
                    await supabase.auth.signOut();
                }
            }
        }

        // --- PROFILE & PASSWORD LOGIC ---
        async function openProfileModal() {
            if (!AppState.currentUser) return;
            
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('name, avatar_url')
                .eq('id', AppState.currentUser.id)
                .single();
                
            if (error) {
                showNotification('No se pudo cargar tu perfil.', 'error');
                return;
            }
            
            document.getElementById('profile-email').value = AppState.currentUser.email;
            document.getElementById('profile-name').value = profile.name || '';
            DOMElements.profileAvatarPreview.style.backgroundImage = profile.avatar_url ? `url('${profile.avatar_url}')` : 'none';
            DOMElements.profileAvatarInput.value = '';
            
            DOMElements.profileMessage.textContent = '';
            DOMElements.passwordMessage.textContent = '';
            document.getElementById('modal-new-password').value = '';

            DOMElements.profileModal.classList.remove('hidden');
        }

        async function handleUpdateProfile(e) {
            e.preventDefault();
            DOMElements.profileMessage.textContent = 'Guardando...';
            
            const newName = document.getElementById('profile-name').value;
            const avatarFile = DOMElements.profileAvatarInput.files[0];
            let avatarUrl = AppState.userProfile.avatar_url;

            try {
                if (avatarFile) {
                    const fileExt = avatarFile.name.split('.').pop();
                    const fileName = `${AppState.currentUser.id}-${Date.now()}.${fileExt}`;
                    const filePath = `${fileName}`;

                    const { error: uploadError } = await supabase.storage
                        .from('avatars')
                        .upload(filePath, avatarFile, {
                            cacheControl: '3600',
                            upsert: true
                        });

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage.from('avatars').getPublicUrl(filePath);
                    avatarUrl = urlData.publicUrl;
                }

                const { data: updatedProfile, error: updateError } = await supabase
                    .from('profiles')
                    .update({ name: newName, avatar_url: avatarUrl })
                    .eq('id', AppState.currentUser.id)
                    .select()
                    .single();

                if (updateError) throw updateError;
                
                AppState.userProfile = updatedProfile;
                document.getElementById('user-menu-name-main').textContent = updatedProfile.name;
                const userAvatarMain = document.getElementById('user-avatar-main');
                if(userAvatarMain) userAvatarMain.src = updatedProfile.avatar_url;
                
                DOMElements.profileMessage.textContent = 'Perfil actualizado.';
                DOMElements.profileMessage.style.color = 'var(--success-color)';

            } catch (error) {
                 DOMElements.profileMessage.textContent = `Error: ${error.message}`;
                 DOMElements.profileMessage.style.color = 'var(--danger-color)';
            }
        }

        async function handleUpdatePassword(e) {
            e.preventDefault();
            const newPassword = document.getElementById('modal-new-password').value;
            if (newPassword.length < 6) {
                 DOMElements.passwordMessage.textContent = 'La contraseña debe tener al menos 6 caracteres.';
                 DOMElements.passwordMessage.style.color = 'var(--danger-color)';
                 return;
            }
            DOMElements.passwordMessage.textContent = 'Actualizando...';

            const { error } = await supabase.auth.updateUser({
                password: newPassword
            });

            if (error) {
                DOMElements.passwordMessage.textContent = `Error: ${error.message}`;
                DOMElements.passwordMessage.style.color = 'var(--danger-color)';
            } else {
                DOMElements.passwordMessage.textContent = 'Contraseña actualizada con éxito.';
                DOMElements.passwordMessage.style.color = 'var(--success-color)';
                DOMElements.passwordFormModal.reset();
            }
        }


        // --- RENDER FUNCTIONS FOR TABS ---
        const tabContentTemplate = (title, content) => { 
            const avatarSrc = AppState.userProfile?.avatar_url;
            const avatarDisplay = avatarSrc 
                ? `<img id="user-avatar-main" src="${avatarSrc}" class="w-8 h-8 rounded-full object-cover">`
                : `<i class="fas fa-user-circle text-2xl"></i>`;

            return `
            <div class="space-y-6">
                <div class="p-4 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 dark:from-indigo-700 dark:to-purple-700 text-white shadow-lg flex items-center justify-between">
                    <h1 class="text-2xl font-bold tracking-tight uppercase">${title}</h1>
                    <div class="relative">
                        <button id="user-menu-button-main" class="flex items-center gap-2 p-1 rounded-full hover:bg-white/20 transition-colors">
                            <span id="user-menu-name-main" class="hidden md:inline font-semibold text-sm"></span>
                            ${avatarDisplay}
                        </button>
                        <div id="user-menu-dropdown-main" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 z-50 border border-gray-200 dark:border-gray-700">
                            <a href="#" id="edit-profile-button-main" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Editar Perfil</a>
                            <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>
                            <a href="#" class="signout-trigger block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Cerrar Sesión</a>
                        </div>
                    </div>
                </div>
                ${content}
            </div>`;
        }
            
        function setupDynamicHeaderContent() {
            const userMenuButton = document.getElementById('user-menu-button-main');
            const userMenuDropdown = document.getElementById('user-menu-dropdown-main');
            const editProfileButton = document.getElementById('edit-profile-button-main');
            const userMenuName = document.getElementById('user-menu-name-main');
            const userAvatar = document.getElementById('user-avatar-main');

            if (userMenuButton) {
                userMenuButton.addEventListener('click', () => userMenuDropdown.classList.toggle('hidden'));
            }
            if (editProfileButton) {
                editProfileButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    userMenuDropdown.classList.add('hidden');
                    openProfileModal();
                });
            }
            if (userMenuName && AppState.userProfile) {
                userMenuName.textContent = AppState.userProfile.name || AppState.currentUser.email;
            }
            if (userAvatar && AppState.userProfile?.avatar_url) {
                userAvatar.src = AppState.userProfile.avatar_url;
            }
        }

        window.render_team_formation = () => {
            const content = `
                <div id="team-formation-container" class="flex flex-col lg:grid lg:grid-cols-2 gap-6">
                    <div class="card rounded-xl shadow-sm p-6 space-y-4">
                        <h3 class="text-xl font-semibold">Jugadores Disponibles</h3>
                        <div>
                            <h4 class="font-medium mb-2 text-secondary">Titulares</h4>
                            <div id="titulares-players" class="player-list-container border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-2 text-secondary">Suplentes</h4>
                            <div id="suplentes-players" class="player-list-container border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                        </div>
                    </div>
                    <div class="card rounded-xl shadow-sm p-6 space-y-4">
                        <h3 class="text-xl font-semibold">Equipos (<span id="total-selected-players">0</span>/10)</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold mb-2">Claros (<span id="claros-count">0</span>)</h4>
                                <div id="team-claros" class="border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-white dark:bg-gray-200"></div>
                            </div>
                             <div>
                                <h4 class="font-semibold mb-2">Oscuros (<span id="oscuros-count">0</span>)</h4>
                                <div id="team-oscuros" class="border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-gray-800"></div>
                            </div>
                        </div>
                        <div class="pt-4">
                            <label for="team-match-date" class="block text-sm font-medium mb-1">Fecha del Partido</label>
                            <input type="date" id="team-match-date" class="w-full p-2 border rounded-md">
                        </div>
                        <button id="save-teams-button" class="w-full px-6 py-3 button-primary font-semibold rounded-lg shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Guardar Partido
                        </button>
                    </div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Armar Equipos', content);
            
            const titularesDiv = document.getElementById('titulares-players');
            const suplentesDiv = document.getElementById('suplentes-players');
            AppState.players.filter(p => p.status === 'Activo').forEach(player => {
                const playerEl = createPlayerElement(player);
                if (player.role === 'Titular') titularesDiv.appendChild(playerEl);
                else suplentesDiv.appendChild(playerEl);
            });

            setupPlayerInteractions('team-formation-container');
            document.getElementById('team-match-date').addEventListener('click', function() {
                this.showPicker();
            });
            document.getElementById('team-match-date').addEventListener('change', updateTeamCounts);
            document.getElementById('save-teams-button').addEventListener('click', handleSaveTeams);
        };

        const renderMatchSelectionTemplate = (prefix, panelContent) => `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 card rounded-xl shadow-sm p-6">
                    <h3 class="text-xl font-semibold mb-4">Seleccionar Partido</h3>
                    <div class="flex gap-2 mb-4">
                        <select id="${prefix}-year-select" class="w-full p-2 border rounded-md"></select>
                        <select id="${prefix}-month-select" class="w-full p-2 border rounded-md"></select>
                    </div>
                    <div id="${prefix}-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-1 py-1">
                       <p class="text-secondary">Cargando partidos...</p>
                    </div>
                </div>
                 <div id="${prefix}-selection-panel" class="lg:col-span-2 card rounded-xl shadow-sm p-6 hidden">
                    ${panelContent}
                </div>
            </div>`;

        window.render_match_results = () => {
            const panelContent = `
                <h3 class="text-xl font-semibold mb-4">Registrar Resultado</h3>
                <div class="space-y-4">
                     <div>
                        <label class="block text-sm font-medium mb-1">Fecha del Partido</label>
                        <input type="date" id="match-date" class="w-full p-2 border rounded-md" readonly>
                     </div>
                     <div>
                        <label for="match-result" class="block text-sm font-medium mb-1">Resultado</label>
                        <select id="match-result" class="w-full p-2 border rounded-md">
                             <option value="">Seleccionar resultado</option>
                             <option value="Claros">Claros</option>
                             <option value="Oscuros">Oscuros</option>
                             <option value="Empate">Empate</option>
                             <option value="Suspendido">Suspendido</option>
                        </select>
                     </div>
                     <div class="flex gap-4 pt-4">
                        <button id="register-match-button" class="flex-1 px-6 py-3 button-success font-semibold rounded-lg shadow-md hover:opacity-90 transition">
                         Registrar Resultado
                        </button>
                        <button id="delete-match-button" class="flex-1 px-6 py-3 button-danger font-semibold rounded-lg shadow-md hover:opacity-90 transition">
                         Eliminar Partido
                        </button>
                     </div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Resultados de Partidos', renderMatchSelectionTemplate('results', panelContent));
            populateMatchFilters('results');
        };
        
        window.render_chamigo_management = () => {
            const panelContent = `
                <h3 class="text-xl font-semibold mb-4">Registrar Votos de Chamigo</h3>
                <div id="chamigo-voting-players" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 max-h-[50vh] overflow-y-auto">
                    <p class="text-secondary col-span-full">Selecciona un partido para cargar los jugadores.</p>
                </div>
                <button id="register-chamigo-button" class="w-full mt-4 px-6 py-3 button-warning font-semibold rounded-lg shadow-md hover:opacity-90 transition">
                    Registrar Chamigo(s)
                </button>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Gestión de Chamigo', renderMatchSelectionTemplate('chamigo', panelContent));
            populateMatchFilters('chamigo');
        };

        window.render_tt_attendance = () => {
             const panelContent = `
                <h3 class="text-xl font-semibold mb-4">Registrar Asistencia a Tercer Tiempo</h3>
                <div id="tt-attendance-players" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-4 max-h-[50vh] overflow-y-auto">
                    <p class="text-secondary col-span-full">Selecciona un partido para cargar los jugadores.</p>
                </div>
                <button id="register-tt-button" class="w-full mt-4 px-6 py-3 button-purple font-semibold rounded-lg shadow-md hover:opacity-90 transition">
                    Registrar Asistencia
                </button>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Asistencia a TT', renderMatchSelectionTemplate('tt', panelContent));
            populateMatchFilters('tt');
        };

        window.render_edit_match = () => {
            const panelContent = `
                <div id="edit-match-content" class="flex flex-col lg:grid lg:grid-cols-2 gap-6">
                    <div class="card rounded-xl shadow-sm p-6 space-y-4">
                        <h3 class="text-xl font-semibold">Jugadores Disponibles</h3>
                        <div>
                            <h4 class="font-medium mb-2 text-secondary">Titulares</h4>
                            <div id="edit-titulares-players" class="player-list-container border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-2 text-secondary">Suplentes</h4>
                            <div id="edit-suplentes-players" class="player-list-container border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                        </div>
                    </div>
                    <div class="card rounded-xl shadow-sm p-6 space-y-4">
                        <h3 class="text-xl font-semibold">Equipos del Partido</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold mb-2">Claros</h4>
                                <div id="edit-team-claros" class="border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-white dark:bg-gray-200"></div>
                            </div>
                             <div>
                                <h4 class="font-semibold mb-2">Oscuros</h4>
                                <div id="edit-team-oscuros" class="border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-gray-800"></div>
                            </div>
                        </div>
                        <div class="pt-4">
                            <label for="edit-match-date" class="block text-sm font-medium mb-1">Fecha del Partido</label>
                            <input type="date" id="edit-match-date" class="w-full p-2 border rounded-md">
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 pt-4">
                            <button id="update-match-button" class="w-full px-6 py-3 button-primary font-semibold rounded-lg shadow-md transition">
                                Actualizar Partido
                            </button>
                            <button id="delete-match-from-edit-button" class="w-full px-6 py-3 button-danger font-semibold rounded-lg shadow-md transition">
                                Eliminar Partido
                            </button>
                        </div>
                    </div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Editar Partido', renderMatchSelectionTemplate('edit', panelContent));
            populateMatchFilters('edit');
        };

        window.render_players_management = () => {
            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold mb-4">Añadir/Modificar Jugador</h3>
                        <form id="player-form" class="space-y-4">
                            <input type="hidden" id="player-id">
                            <div>
                                <label for="player-name" class="block text-sm font-medium mb-1">Nombre</label>
                                <input type="text" id="player-name" class="w-full p-2 border rounded-md" required>
                            </div>
                            <div>
                                <label for="player-status" class="block text-sm font-medium mb-1">Estado</label>
                                <select id="player-status" class="w-full p-2 border rounded-md">
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                </select>
                            </div>
                            <div>
                                <label for="player-role" class="block text-sm font-medium mb-1">Rol</label>
                                <select id="player-role" class="w-full p-2 border rounded-md">
                                    <option value="Titular">Titular</option>
                                    <option value="Suplente">Suplente</option>
                                </select>
                            </div>
                            <div class="flex gap-3 pt-2">
                                <button type="submit" class="flex-1 px-4 py-2 button-success font-semibold rounded-lg shadow-md hover:opacity-90">Guardar</button>
                                <button type="button" id="clear-player-form-button" class="flex-1 px-4 py-2 button-secondary font-semibold rounded-lg shadow-md hover:opacity-90">Limpiar</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold mb-4">Listado de Jugadores</h3>
                        <div class="overflow-x-auto max-h-[60vh]">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs uppercase bg-muted">
                                    <tr>
                                        <th class="p-4">ID</th>
                                        <th class="p-4">Nombre</th>
                                        <th class="p-4">Estado</th>
                                        <th class="p-4">Rol</th>
                                    </tr>
                                </thead>
                                <tbody id="players-list-admin"></tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Gestión de Jugadores', content);
            renderPlayersListAdmin();
            document.getElementById('player-form').addEventListener('submit', handleSavePlayer);
            document.getElementById('clear-player-form-button').addEventListener('click', clearPlayerForm);
        };
        
        window.render_user_management = () => {
             const content = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold mb-4">Editar Usuario</h3>
                        <form id="user-form" class="space-y-4">
                            <input type="hidden" id="user-id">
                            <div>
                                <label for="user-email" class="block text-sm font-medium mb-1">Email</label>
                                <input type="email" id="user-email" class="w-full p-2 border rounded-md" readonly>
                            </div>
                            <div>
                                <label for="user-name" class="block text-sm font-medium mb-1">Nombre</label>
                                <input type="text" id="user-name" class="w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="user-role" class="block text-sm font-medium mb-1">Rol</label>
                                <select id="user-role" class="w-full p-2 border rounded-md">
                                    <option value="Operador">Operador</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div>
                                <label for="user-status" class="block text-sm font-medium mb-1">Estado</label>
                                <select id="user-status" class="w-full p-2 border rounded-md">
                                    <option value="active">Activo</option>
                                    <option value="inactive">Inactivo</option>
                                </select>
                            </div>
                            <div class="flex gap-3 pt-2">
                                <button type="submit" class="flex-1 px-4 py-2 button-success font-semibold rounded-lg shadow-md hover:opacity-90">Guardar</button>
                                <button type="button" id="clear-user-form-button" class="flex-1 px-4 py-2 button-secondary font-semibold rounded-lg shadow-md hover:opacity-90">Limpiar</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-semibold mb-4">Listado de Usuarios</h3>
                        <div class="overflow-x-auto max-h-[60vh]">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs uppercase bg-muted">
                                    <tr>
                                        <th class="p-4">Email</th>
                                        <th class="p-4">Nombre</th>
                                        <th class="p-4">Rol</th>
                                        <th class="p-4">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="users-list-admin"></tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Gestión de Usuarios', content);
            renderUsersListAdmin();
            document.getElementById('user-form').addEventListener('submit', handleSaveUser);
            document.getElementById('clear-user-form-button').addEventListener('click', clearUserForm);
        };

        // --- TEAM FORMATION & EDIT MATCH LOGIC (REUSABLE) ---
        function createPlayerElement(player) {
            const el = document.createElement('div');
            el.className = 'player-element flex-grow-0 text-sm font-medium px-3 py-1.5 rounded-full shadow-sm';
            el.dataset.id = player.id;
            el.textContent = player.name;
            return el;
        }

        function setupPlayerInteractions(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const returnPlayerToOrigin = (playerEl) => {
                if (!playerEl) return;
                const playerId = playerEl.dataset.id;
                const player = AppState.players.find(p => p.id == playerId);
                const isEditMode = containerId === 'edit-match-content';

                const suplentesList = document.getElementById(isEditMode ? 'edit-suplentes-players' : 'suplentes-players');
                const titularesList = document.getElementById(isEditMode ? 'edit-titulares-players' : 'titulares-players');

                if (player && player.role === 'Suplente') {
                    suplentesList.appendChild(playerEl);
                } else if (player) {
                    titularesList.appendChild(playerEl);
                }
                if (!isEditMode) updateTeamCounts();
            };

            const onClick = (e) => {
                const playerEl = e.target.closest('.player-element');
                if (!playerEl) return;

                const parentId = playerEl.parentElement.id;
                
                if (parentId.includes('titulares-players') || parentId.includes('suplentes-players')) {
                    showPlayerAssignmentModal(playerEl);
                } 
                else if (parentId.includes('team-claros') || parentId.includes('team-oscuros')) {
                    returnPlayerToOrigin(playerEl);
                }
            };

            container.addEventListener('click', onClick);
        }
        
        function showPlayerAssignmentModal(playerEl) {
            AppState.activePlayerElement = playerEl;
            DOMElements.assignModalPlayerName.textContent = playerEl.textContent;
            DOMElements.playerAssignmentModal.classList.remove('hidden');
        }

        function hidePlayerAssignmentModal() {
            AppState.activePlayerElement = null;
            DOMElements.playerAssignmentModal.classList.add('hidden');
        }
        
        function movePlayerToTeam(teamId) {
            if (!AppState.activePlayerElement) return;
            
            const isEditMode = AppState.activePlayerElement.closest('#edit-match-content');
            const finalTeamId = isEditMode ? `edit-${teamId}` : teamId;
            
            const teamContainer = document.getElementById(finalTeamId);
            if (teamContainer.children.length >= 5) {
                showNotification(`El equipo ${teamId.includes('claros') ? 'Claros' : 'Oscuros'} ya está lleno.`, 'warning');
                return;
            }
            
            teamContainer.appendChild(AppState.activePlayerElement);
            hidePlayerAssignmentModal();
            if (!isEditMode) updateTeamCounts();
        }
        
        function updateTeamCounts() {
            const clarosCount = document.getElementById('team-claros').children.length;
            const oscurosCount = document.getElementById('team-oscuros').children.length;
            const matchDate = document.getElementById('team-match-date').value;

            document.getElementById('claros-count').textContent = clarosCount;
            document.getElementById('oscuros-count').textContent = oscurosCount;
            document.getElementById('total-selected-players').textContent = clarosCount + oscurosCount;
            
            document.getElementById('save-teams-button').disabled = !(clarosCount === 5 && oscurosCount === 5 && matchDate);
        }

        async function handleSaveTeams() {
            const matchDate = document.getElementById('team-match-date').value;
            if (!matchDate) { 
                showNotification('Por favor, selecciona la fecha del partido.', 'warning');
                return;
            }
            const teamWhitePlayers = Array.from(document.getElementById('team-claros').children).map(el => el.dataset.id);
            const teamDarkPlayers = Array.from(document.getElementById('team-oscuros').children).map(el => el.dataset.id);

            const { data, error } = await supabase.from('matches').insert([{ 
                match_date: matchDate,
                team_white_players: teamWhitePlayers,
                team_dark_players: teamDarkPlayers,
                chamigo_votes: {},
                tt_attendees: []
            }]).select().single();

            if (error) {
                showNotification(`Error al crear el partido: ${error.message}`, 'error');
            } else {
                showNotification('Partido creado exitosamente!', 'success');
                AppState.matches.unshift(data);
                navigateTo('team-formation');
            }
        }
        
        // --- OTHER TAB LOGIC ---
        function populateMatchFilters(prefix) {
            const yearSelect = document.getElementById(`${prefix}-year-select`);
            const monthSelect = document.getElementById(`${prefix}-month-select`);
            
            const years = [...new Set(AppState.matches.map(m => new Date(m.match_date).getFullYear()))].sort((a,b) => b-a);
            yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
            
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            monthSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            
            const mostRecentMatchDate = AppState.matches.length > 0 ? new Date(AppState.matches[0].match_date) : new Date();
            
            if (years.includes(mostRecentMatchDate.getFullYear())) yearSelect.value = mostRecentMatchDate.getFullYear();
            monthSelect.value = mostRecentMatchDate.getMonth();

            const renderList = () => {
                const listContainer = document.getElementById(`${prefix}-list`);
                const selectedYear = yearSelect.value;
                const selectedMonth = monthSelect.value;
                const filteredMatches = AppState.matches.filter(m => {
                    const d = new Date(m.match_date);
                    return d.getFullYear() == selectedYear && d.getMonth() == selectedMonth;
                });
                
                if (filteredMatches.length === 0) {
                    listContainer.innerHTML = '<p class="text-secondary p-2">No hay partidos para este mes.</p>';
                    document.getElementById(`${prefix}-selection-panel`).classList.add('hidden');
                    return;
                }

                listContainer.innerHTML = filteredMatches.map(match => {
                    const d = new Date(match.match_date);
                    const formattedDate = d.toLocaleDateString('es-AR', {day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC'});
                    return `
                        <div class="match-item border-l-4 p-3 rounded-r-lg cursor-pointer transition" data-match-id="${match.id}">
                            <p class="font-semibold">${formattedDate}</p>
                            <p class="text-xs text-secondary">Resultado: ${match.result || 'Pendiente'}</p>
                        </div>`;
                }).join('');

                listContainer.querySelectorAll('.match-item').forEach(item => {
                    const match = AppState.matches.find(m => m.id == item.dataset.matchId);
                    item.classList.toggle('has-result', !!match.result);
                    item.classList.toggle('no-result', !match.result);
                    
                    item.addEventListener('click', (e) => {
                        listContainer.querySelectorAll('.match-item').forEach(i => i.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        handleMatchSelection(e.currentTarget.dataset.matchId, prefix);
                    });
                });
                
                const firstItem = listContainer.querySelector('.match-item');
                if (firstItem) {
                    firstItem.click();
                }
            };
            
            yearSelect.addEventListener('change', renderList);
            monthSelect.addEventListener('change', renderList);
            renderList();
        }

        function handleMatchSelection(matchId, prefix) {
            AppState.selectedMatchId = matchId;
            const match = AppState.matches.find(m => m.id == matchId);
            if (!match) return;
            
            const panel = document.getElementById(`${prefix}-selection-panel`);
            panel.classList.remove('hidden');

            const handlerMap = {
                'results': setupResultsPanel,
                'chamigo': setupChamigoPanel,
                'tt': setupTtPanel,
                'edit': setupEditMatchPanel,
            };

            if(handlerMap[prefix]) handlerMap[prefix](panel, match);
        }
        
        function setupResultsPanel(panel, match) {
            panel.querySelector('#match-date').value = match.match_date;
            panel.querySelector('#match-result').value = match.result || '';
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#register-match-button').addEventListener('click', handleRegisterResult);
                panel.querySelector('#delete-match-button').addEventListener('click', handleDeleteMatch);
                panel.dataset.listenersAdded = 'true';
            }
        }

        function setupChamigoPanel(panel, match) {
            renderChamigoVotingPlayers(match);
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#register-chamigo-button').addEventListener('click', handleRegisterChamigo);
                panel.dataset.listenersAdded = 'true';
            }
        }

        function setupTtPanel(panel, match) {
            renderTtAttendancePlayers(match);
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#register-tt-button').addEventListener('click', handleRegisterTt);
                panel.dataset.listenersAdded = 'true';
            }
        }
        
        function setupEditMatchPanel(panel, match) {
            renderEditMatchPlayers(match);
            
            const updateBtn = panel.querySelector('#update-match-button');
            const deleteBtn = panel.querySelector('#delete-match-from-edit-button');

            const newUpdateBtn = updateBtn.cloneNode(true);
            updateBtn.parentNode.replaceChild(newUpdateBtn, updateBtn);
            newUpdateBtn.addEventListener('click', handleUpdateMatch);

            const newDeleteBtn = deleteBtn.cloneNode(true);
            deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
            newDeleteBtn.addEventListener('click', handleDeleteMatchFromEdit);

            panel.querySelector('#edit-match-date').addEventListener('click', function() {
                this.showPicker();
            });
        }

        async function handleRegisterResult() {
            const result = document.getElementById('match-result').value;
            const { error } = await supabase.from('matches').update({ result }).eq('id', AppState.selectedMatchId);
            if(error) { showNotification('Error al registrar resultado', 'error'); } 
            else {
                 showNotification('Resultado registrado!', 'success');
                 const matchInState = AppState.matches.find(m => m.id == AppState.selectedMatchId);
                 if (matchInState) matchInState.result = result;
                 populateMatchFilters('results');
            }
        }
        
        async function handleDeleteMatch() {
            const confirmed = await showModal('Confirmar Eliminación', '¿Seguro que quieres eliminar este partido? Esta acción no se puede deshacer.');
            if (confirmed) {
                const { error } = await supabase.from('matches').delete().eq('id', AppState.selectedMatchId);
                if(error) { showNotification('Error al eliminar partido', 'error'); } 
                else {
                    showNotification('Partido eliminado.', 'success');
                    AppState.matches = AppState.matches.filter(m => m.id != AppState.selectedMatchId);
                    document.getElementById('results-selection-panel').classList.add('hidden');
                    populateMatchFilters('results');
                }
            }
        }

        async function handleDeleteMatchFromEdit() {
            const confirmed = await showModal('Confirmar Eliminación', '¿Seguro que quieres eliminar este partido? Esta acción no se puede deshacer.');
            if (confirmed) {
                const { error } = await supabase.from('matches').delete().eq('id', AppState.selectedMatchId);
                if(error) { showNotification('Error al eliminar partido', 'error'); } 
                else {
                    showNotification('Partido eliminado.', 'success');
                    AppState.matches = AppState.matches.filter(m => m.id != AppState.selectedMatchId);
                    document.getElementById('edit-selection-panel').classList.add('hidden');
                    populateMatchFilters('edit');
                }
            }
        }
        
        function renderChamigoVotingPlayers(match) {
            const container = document.getElementById('chamigo-voting-players');
            container.innerHTML = '';
            const playerIDs = [...new Set([...(match.team_white_players||[]), ...(match.team_dark_players||[])])];
            const currentVotes = match.chamigo_votes || {};

            playerIDs.forEach(id => {
                const player = AppState.players.find(p => p.id == id);
                if (!player) return;
                
                const voteCount = currentVotes[id] || 0;
                const playerDiv = document.createElement('div');
                playerDiv.className = 'chamigo-player-item flex items-center justify-between p-2 border border-border-color rounded-lg';
                playerDiv.dataset.id = id;
                playerDiv.innerHTML = `
                    <span class="player-name">${player.name}</span>
                    <div class="chamigo-vote-controls flex items-center gap-2">
                        <button class="chamigo-vote-btn subtract-vote w-8 h-8 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition-colors flex items-center justify-center text-lg font-bold">-</button>
                        <span class="chamigo-vote-counter font-bold w-8 text-center text-lg">${voteCount}</span>
                        <button class="chamigo-vote-btn add-vote w-8 h-8 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition-colors flex items-center justify-center text-lg font-bold">+</button>
                    </div>`;
                
                playerDiv.querySelector('.add-vote').addEventListener('click', () => {
                    const counter = playerDiv.querySelector('.chamigo-vote-counter');
                    counter.textContent = parseInt(counter.textContent) + 1;
                });
                playerDiv.querySelector('.subtract-vote').addEventListener('click', () => {
                    const counter = playerDiv.querySelector('.chamigo-vote-counter');
                    counter.textContent = Math.max(0, parseInt(counter.textContent) - 1);
                });
                container.appendChild(playerDiv);
            });
        }
        
        async function handleRegisterChamigo() {
            const votes = {};
            document.querySelectorAll('.chamigo-player-item').forEach(item => {
                const count = parseInt(item.querySelector('.chamigo-vote-counter').textContent);
                if (count > 0) votes[item.dataset.id] = count;
            });
            
            const { error } = await supabase.from('matches').update({ chamigo_votes: votes }).eq('id', AppState.selectedMatchId);
            if (error) { showNotification('Error al guardar votos de Chamigo', 'error'); } 
            else {
                showNotification('Votos de Chamigo guardados!', 'success');
                const matchInState = AppState.matches.find(m => m.id == AppState.selectedMatchId);
                if (matchInState) matchInState.chamigo_votes = votes;
            }
        }
        
        function renderTtAttendancePlayers(match) {
            const container = document.getElementById('tt-attendance-players');
            container.innerHTML = '';
            const activePlayers = AppState.players.filter(p => p.status === 'Activo');
            const existingAttendees = match.tt_attendees || [];

            activePlayers.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'tt-player-item p-2 border border-border-color rounded-lg cursor-pointer text-center flex items-center justify-center gap-2';
                if (existingAttendees.includes(player.id)) {
                    playerDiv.classList.add('selected');
                }
                playerDiv.dataset.id = player.id;
                playerDiv.innerHTML = `<i class="fas fa-check-circle hidden"></i><span>${player.name}</span>`;
                
                const icon = playerDiv.querySelector('i');
                icon.style.display = playerDiv.classList.contains('selected') ? 'inline' : 'none';

                playerDiv.addEventListener('click', () => {
                    playerDiv.classList.toggle('selected');
                    icon.style.display = playerDiv.classList.contains('selected') ? 'inline' : 'none';
                });
                container.appendChild(playerDiv);
            });
        }
        
        async function handleRegisterTt() {
            const attendees = Array.from(document.querySelectorAll('#tt-attendance-players .selected')).map(el => el.dataset.id);
            const { error } = await supabase.from('matches').update({ tt_attendees: attendees }).eq('id', AppState.selectedMatchId);
            if (error) { showNotification('Error al guardar asistencia a TT', 'error'); } 
            else {
                showNotification('Asistencia a TT guardada!', 'success');
                const matchInState = AppState.matches.find(m => m.id == AppState.selectedMatchId);
                if (matchInState) matchInState.tt_attendees = attendees;
            }
        }
        
        function renderPlayersListAdmin() {
            const tableBody = document.getElementById('players-list-admin');
            tableBody.innerHTML = AppState.players.map(p => `
                <tr class="selectable-row border-b border-border-color cursor-pointer" data-player-id="${p.id}">
                    <td class="p-4">${p.id}</td><td class="p-4">${p.name}</td>
                    <td class="p-4">${p.status}</td><td class="p-4">${p.role}</td>
                </tr>`).join('');
            
            tableBody.querySelectorAll('.selectable-row').forEach(row => {
                row.addEventListener('click', () => {
                    tableBody.querySelectorAll('.selectable-row').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    populatePlayerForm(AppState.players.find(p => p.id == row.dataset.playerId));
                });
            });
        }

        function populatePlayerForm(player) {
            document.getElementById('player-id').value = player.id;
            document.getElementById('player-name').value = player.name;
            document.getElementById('player-status').value = player.status;
            document.getElementById('player-role').value = player.role;
        }
        
        function clearPlayerForm() {
            document.getElementById('player-form').reset();
            document.getElementById('player-id').value = '';
            document.querySelectorAll('#players-list-admin .selectable-row').forEach(r => r.classList.remove('selected'));
        }

        async function handleSavePlayer(e) {
            e.preventDefault();
            const id = document.getElementById('player-id').value;
            const playerData = {
                name: document.getElementById('player-name').value,
                status: document.getElementById('player-status').value,
                role: document.getElementById('player-role').value,
            };

            const { data, error } = id
                ? await supabase.from('players').update(playerData).eq('id', id).select().single()
                : await supabase.from('players').insert(playerData).select().single();

            if (error) {
                showNotification(`Error al guardar jugador: ${error.message}`, 'error');
            } else {
                showNotification('Jugador guardado exitosamente.', 'success');
                await refreshDataAndRender('players-management');
                clearPlayerForm();
            }
        }

        function renderUsersListAdmin() {
            const tableBody = document.getElementById('users-list-admin');
            tableBody.innerHTML = AppState.users.map(u => {
                // CORRECCIÓN: Se hace la comprobación insensible a mayúsculas y minúsculas y se maneja el caso de que `status` sea nulo.
                const isActive = (u.status || '').toLowerCase() === 'active';
                const statusColor = isActive ? 'text-green-500' : 'text-red-500';
                const statusText = isActive ? 'Activo' : 'Inactivo';
                return `
                <tr class="selectable-row border-b border-border-color cursor-pointer" data-user-id="${u.id}">
                    <td class="p-4">${u.email}</td>
                    <td class="p-4">${u.name || 'N/A'}</td>
                    <td class="p-4">${u.role || 'Sin Rol'}</td>
                    <td class="p-4 font-semibold ${statusColor}">${statusText}</td>
                </tr>`
            }).join('');
            
            tableBody.querySelectorAll('.selectable-row').forEach(row => {
                row.addEventListener('click', () => {
                    tableBody.querySelectorAll('.selectable-row').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    populateUserForm(AppState.users.find(u => u.id === row.dataset.userId));
                });
            });
        }

        function populateUserForm(user) {
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-email').value = user.email;
            document.getElementById('user-name').value = user.name || '';
            document.getElementById('user-role').value = user.role || 'Operador';
            // CORRECCIÓN: Se asegura de que el valor por defecto sea 'active' si no hay un estado definido.
            document.getElementById('user-status').value = user.status || 'active';
        }

        function clearUserForm() {
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.querySelectorAll('#users-list-admin .selectable-row').forEach(r => r.classList.remove('selected'));
        }

        async function handleSaveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            if (!id) { showNotification('Selecciona un usuario de la lista.', 'warning'); return; }
            const userData = {
                name: document.getElementById('user-name').value,
                role: document.getElementById('user-role').value,
                status: document.getElementById('user-status').value,
            };
            const { error } = await supabase.from('profiles').update(userData).eq('id', id);
            if (error) { showNotification(`Error al guardar usuario: ${error.message}`, 'error'); }
            else {
                showNotification('Usuario guardado.', 'success');
                await refreshDataAndRender('user-management');
                clearUserForm();
            }
        }
        
        function renderEditMatchPlayers(match) {
            document.getElementById('edit-match-date').value = match.match_date;
            const titularesDiv = document.getElementById('edit-titulares-players');
            const suplentesDiv = document.getElementById('edit-suplentes-players');
            const teamClarosDiv = document.getElementById('edit-team-claros');
            const teamOscurosDiv = document.getElementById('edit-team-oscuros');
            
            [titularesDiv, suplentesDiv, teamClarosDiv, teamOscurosDiv].forEach(div => div.innerHTML = '');

            const matchPlayerIds = new Set([
                ...(match.team_white_players || []).map(String), 
                ...(match.team_dark_players || []).map(String)
            ]);

            AppState.players.filter(p => p.status === 'Activo' && !matchPlayerIds.has(String(p.id)))
                .forEach(p => {
                    const playerEl = createPlayerElement(p);
                    if (p.role === 'Suplente') {
                        suplentesDiv.appendChild(playerEl);
                    } else {
                        titularesDiv.appendChild(playerEl);
                    }
                });

            (match.team_white_players || []).forEach(id => {
                const player = AppState.players.find(p => p.id == id);
                if (player) teamClarosDiv.appendChild(createPlayerElement(player));
            });
            (match.team_dark_players || []).forEach(id => {
                const player = AppState.players.find(p => p.id == id);
                if (player) teamOscurosDiv.appendChild(createPlayerElement(player));
            });
            
            setupPlayerInteractions('edit-match-content');
        }

        async function handleUpdateMatch() {
            const newDate = document.getElementById('edit-match-date').value;
            const newTeamWhite = Array.from(document.getElementById('edit-team-claros').children).map(el => el.dataset.id);
            const newTeamDark = Array.from(document.getElementById('edit-team-oscuros').children).map(el => el.dataset.id);
            
            if (newTeamWhite.length + newTeamDark.length !== 10) {
                showNotification('Deben haber 10 jugadores en total para conformar los equipos.', 'warning');
                return;
            }

            const { error } = await supabase.from('matches').update({
                match_date: newDate,
                team_white_players: newTeamWhite,
                team_dark_players: newTeamDark
            }).eq('id', AppState.selectedMatchId);
            
            if (error) { showNotification('Error al actualizar el partido.', 'error'); }
            else {
                showNotification('Partido actualizado.', 'success');
                await refreshDataAndRender('edit-match');
            }
        }

        async function refreshDataAndRender(tabToRender) {
            const { data: players, pError } = await supabase.from('players').select('*').order('id');
            if (!pError) AppState.players = players;
            
            const { data: matches, mError } = await supabase.from('matches').select('*').order('match_date', { ascending: false });
            if (!mError) AppState.matches = matches;

            if(AppState.userRole === 'Admin') {
                // CAMBIO AQUI: Se pasa un objeto vacío {} como segundo argumento a rpc
                const { data: users, uError } = await supabase.rpc('get_all_users_with_roles', {}); 
                if (!uError) AppState.users = users;
            }
            
            navigateTo(tabToRender);
        }

        function showNotification(message, type = 'success') {
            const { notificationModal, notificationContent, notificationIcon, notificationMessage } = DOMElements;
            
            notificationMessage.textContent = message;
            notificationContent.classList.remove('bg-success-color', 'bg-danger-color', 'bg-warning-color');
            notificationIcon.classList.remove('fa-check-circle', 'fa-exclamation-triangle', 'fa-times-circle');

            if (type === 'success') {
                notificationContent.classList.add('bg-success-color');
                notificationIcon.classList.add('fa-check-circle');
            } else {
                notificationContent.classList.add('bg-danger-color');
                notificationIcon.classList.add('fa-times-circle');
            }

            notificationModal.classList.remove('hidden');

            setTimeout(() => {
                notificationModal.classList.add('hidden');
            }, 3000);
        }

        function showModal(title, message) {
            return new Promise(resolve => {
                DOMElements.modalTitle.textContent = title;
                DOMElements.modalMessage.textContent = message;
                DOMElements.modal.classList.remove('hidden');
                const confirmHandler = () => { cleanup(); resolve(true); };
                const cancelHandler = () => { cleanup(); resolve(false); };
                const cleanup = () => {
                    DOMElements.modal.classList.add('hidden');
                    DOMElements.modalConfirm.removeEventListener('click', confirmHandler);
                    DOMElements.modalCancel.removeEventListener('click', cancelHandler);
                };
                DOMElements.modalConfirm.addEventListener('click', confirmHandler);
                DOMElements.modalCancel.addEventListener('click', cancelHandler);
            });
        }

        // --- RUN APP ---
        init();
    });
    </script>
</body>
</html>
