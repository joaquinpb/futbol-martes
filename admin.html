

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración Fútbol 5</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Font Awesome para los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Carga de la fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Favicon de pelota de fútbol -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22%3E⚽%3C/text%3E%3C/svg%3E">
    <style>
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        /* --- ESTILOS BASE (MODO CLARO) --- */
        body {
            background-color: #f0f2f5;
        }
        .main-admin-content-container {
            background-color: #ffffff;
            color: #1f2937;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #374151;
        }
        label, .text-gray-700 {
            color: #374151;
        }
        .text-gray-500 {
            color: #6b7280;
        }
        input, select {
            background-color: #ffffff;
            border-color: #d1d5db;
            color: #1f2937;
        }
        input::placeholder {
            color: #9ca3af;
        }
        .tab-content, .p-4.border {
            border-color: #e5e7eb;
        }
        .match-item {
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
        }
        .match-item.no-result {
            background-color: #fee2e2;
        }
        .match-item.has-result {
            background-color: #dcfce7;
        }
        .match-item:hover {
            background-color: #f3f4f6;
        }
        .match-item.selected {
            background-color: #e0e7ff;
            border-color: #6366f1;
        }
        #players-list-admin table {
             background-color: #ffffff;
        }
        #players-list-admin thead tr {
            background-color: #f3f4f6;
            color: #374151;
        }
        #players-list-admin tbody tr {
            border-color: #e5e7eb;
        }
        #players-list-admin tbody tr:hover {
            background-color: #f9fafb;
        }
        #players-list-admin tbody td {
            color: #4b5563;
        }
        #custom-confirm-modal .bg-white {
            background-color: #ffffff;
        }
        /* --- ESTILOS MODO OSCURO --- */
        html.dark body {
            background-color: #111827;
        }
        html.dark .main-admin-content-container {
            background-color: #1f2937;
            color: #d1d5db;
        }
        html.dark h1, html.dark h2, html.dark h3, html.dark h4, html.dark h5, html.dark h6 {
            color: #f9fafb;
        }
        html.dark .text-indigo-800 {
            color: #a5b4fc;
        }
        html.dark .border-indigo-500 {
            border-color: #818cf8;
        }
        html.dark label, html.dark .text-gray-700 {
            color: #d1d5db;
        }
        html.dark .text-gray-500 {
            color: #9ca3af;
        }
        html.dark .text-gray-800 {
           color: #f9fafb;
        }
        html.dark input, html.dark select {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        html.dark input::placeholder {
            color: #9ca3af;
        }
        html.dark .tab-content, html.dark .p-4.border {
            border-color: #4b5563;
        }
        html.dark .match-item.no-result {
            background-color: #5c2b2b;
        }
        html.dark .match-item.has-result {
            background-color: #2a553a;
        }
        html.dark .match-item:hover {
            background-color: #374151;
        }
        html.dark .match-item.selected {
            background-color: #3730a3;
            border-color: #a5b4fc;
        }
        html.dark .match-item p {
            color: #e5e7eb;
        }
         html.dark .match-item .text-gray-500 {
            color: #9ca3af;
        }
        html.dark #players-list-admin table {
           background-color: #1f2937;
        }
        html.dark #players-list-admin thead tr {
            background-color: #374151;
            color: #e5e7eb;
        }
        html.dark #players-list-admin tbody tr {
            border-color: #4b5563;
        }
        html.dark #players-list-admin tbody tr:hover {
            background-color: #374151;
        }
        html.dark #players-list-admin tbody td {
            color: #d1d5db;
        }
        html.dark #titulares-players, html.dark #suplentes-players, html.dark #edit-titulares-players, html.dark #edit-suplentes-players {
            background-color: #374151;
            border-color: #4b5563;
        }
        html.dark #chamigo-match-list, html.dark #tt-match-list, html.dark #results-list, html.dark #edit-list {
            background-color: #1f2937;
            border-color: #4b5563;
        }
        html.dark #custom-confirm-modal .bg-white {
            background-color: #1f2937;
        }
        /* Estilos que NO cambian con el modo oscuro */
        .player-draggable {
            background-color: #ffffff;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 0.25rem;
            cursor: grab;
            display: inline-block !important;
            width: auto !important;
            height: auto !important;
            flex: none !important;
            white-space: nowrap !important;
            color: #000000 !important;
        }
        .player-draggable:active {
            cursor: grabbing;
        }
        #team-oscuros .player-draggable, #edit-team-oscuros .player-draggable {
            background-color: #000000 !important;
            color: #ffffff !important;
        }
        #team-claros, #edit-team-claros {
            background-color: #ffffff !important;
        }
        #team-oscuros, #edit-team-oscuros {
            background-color: #1a202c !important;
        }
        /* --- Resto de los estilos --- */
        .player-draggable.dragging-touch {
            opacity: 0.7;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #side-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 256px;
            background-color: #312e81;
            color: white;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 40;
            display: flex;
            flex-direction: column;
        }
        #side-menu.open {
            transform: translateX(0);
        }
        #side-menu.hidden-truly {
            display: none !important;
        }
        #overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            display: none;
        }
        #overlay.open {
            display: block;
        }
        #hamburger-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 50;
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        #side-menu .tab-button, #side-menu .sidebar-link {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            text-align: left;
            width: 100%;
            border-radius: 0;
            margin-bottom: 0.25rem;
            color: white;
            transition: background-color 0.15s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            white-space: nowrap;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        #side-menu .tab-button.active {
            background-color: #4338ca;
        }
        #side-menu .tab-button:hover, #side-menu .sidebar-link:hover {
            background-color: #4f46e5;
        }
        .menu-title-container {
            padding: 0.5rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            flex-shrink: 0; 
        }
        .menu-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #dark-mode-toggle {
            background-color: #4338ca;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.15s ease-in-out;
        }
        #dark-mode-toggle:hover {
            background-color: #4f46e5;
        }
        #sidebar-button-container {
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 1rem; 
        }
        .sidebar-footer {
            flex-shrink: 0;
            padding: 1rem;
        }
        .sidebar-footer #signout_button {
            width: 100%;
        }
        @media (min-width: 768px) {
            body {
                flex-direction: row;
                align-items: flex-start;
            }
            #side-menu {
                position: relative;
                transform: translateX(0);
                flex-shrink: 0;
                height: 100vh;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            #overlay, #hamburger-button {
                display: none !important;
            }
            .main-admin-content-container {
                flex-grow: 1;
                margin: 2rem;
                padding: 2rem;
                width: auto;
            }
        }
        /* Clases de utilidad para ocultar/mostrar */
        .hidden {
            display: none !important;
        }
        
        /* --- NUEVOS ESTILOS --- */
        .date-input-wrapper {
            cursor: pointer;
        }
        .tt-player-item, .chamigo-player-item {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            text-align: center;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tt-player-item:hover, .chamigo-player-item:hover {
            background-color: #f3f4f6;
        }
        .tt-player-item.selected {
            background-color: #4f46e5;
            border-color: #4f46e5;
            color: white;
        }
        .chamigo-vote-counter {
            background-color: #e0e7ff;
            color: #3730a3;
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            min-width: 2rem;
            text-align: center;
        }
        .chamigo-vote-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chamigo-vote-btn {
            background-color: #c7d2fe;
            color: #4338ca;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            line-height: 1;
            border: none;
        }
        html.dark .tt-player-item, html.dark .chamigo-player-item {
            background-color: #374151;
            border-color: #4b5563;
        }
        html.dark .tt-player-item:hover, html.dark .chamigo-player-item:hover {
            background-color: #4b5563;
        }
        html.dark .tt-player-item.selected {
            background-color: #6366f1;
            border-color: #6366f1;
            color: white;
        }
        html.dark .chamigo-vote-counter {
            background-color: #3730a3;
            color: #e0e7ff;
        }
        html.dark .chamigo-vote-btn {
            background-color: #4f46e5;
            color: #e0e7ff;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row">
    <!-- Hamburger Button (visible on mobile) -->
    <button id="hamburger-button" class="fixed top-4 left-4 z-50 p-2 rounded-md bg-indigo-600 text-white shadow-lg hidden">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <!-- Side Navigation Menu -->
    <nav id="side-menu" class="hidden-truly">
        <div class="menu-title-container">
            <h2 class="menu-title">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
                MENÚ
            </h2>
            <button id="dark-mode-toggle">
                <i class="fas fa-moon" id="dark-mode-icon"></i>
            </button>
        </div>
        
        <div id="sidebar-button-container">
            <!-- Botones de las pestañas -->
            <button class="tab-button" data-tab="team-formation">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-4.5-7.5l-2.25 2.25m0 0l-2.25 2.25M18 15l-2.25 2.25m0 0l-2.25 2.25M15.75 12a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" /></svg>
                Armar Equipos
            </button>
            <button class="tab-button" data-tab="match-results">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25H2.25A2.25 2.25 0 0 1 0 19.5V12A2.25 2.25 0 0 1 2.25 9.75h19.5A2.25 2.25 0 0 1 24 12v7.5a2.25 2.25 0 0 1-2.25 2.25H16.5" /></svg>
                Resultados
            </button>
            <button class="tab-button" data-tab="chamigo-management">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .472.334l5.64.423a.563.563 0 0 1 .314.976l-4.067 3.323a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.563.563 0 0 0-.582 0l-4.725 2.885a.562.562 0 0 1-.84-.61l1.285-5.385a.563.563 0 0 0-.182-.557L3.92 9.345a.563.563 0 0 1 .313-.976l5.64-.423a.563.563 0 0 0 .472-.334L11.48 3.5Z" /></svg>
                Chamigo
            </button>
            <button class="tab-button" data-tab="tt-attendance">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-beer"><path d="M18 19V2h-1M6 19V2h1M2 19h20v3H2zM12 19V2a4 4 0 0 0-4 4v13" /></svg>
                TT
            </button>
            <!-- CAMBIO: Se añade data-role="Admin" para el control de visibilidad -->
            <button class="tab-button" data-tab="players-management" data-role="Admin">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                ABM Jugadores
            </button>
            <button class="tab-button" data-tab="edit-match" data-role="Admin">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                Editar Partido
            </button>
            <a href="index.html" target="_blank" rel="noopener noreferrer" class="sidebar-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-line-chart"><path d="M3 3v18h18" /><path d="m18 21-8-8-4 4-3-3" /><path d="m18 14 4-4H18V6" /></svg>
                Estadísticas
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-auto"><path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 18h-8.5A2.25 2.25 0 012 15.25v-8.5C2 4.75 3.25 3.5 4.75 3.5h4a.75.75 0 010 1.5h-4z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M15.75 3a.75.75 0 01.75.75V9a.75.75 0 01-1.5 0V5.06L10.22 10.53a.75.75 0 01-1.06-1.06l5.47-5.47H12a.75.75 0 010-1.5h3.75z" clip-rule="evenodd" /></svg>
            </a>
        </div>
        
        <div class="sidebar-footer">
             <button id="signout_button" class="w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                Cerrar Sesión
            </button>
        </div>
    </nav>

    <!-- Overlay for when side menu is open (visible on mobile only) -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

    <!-- Main Content Area -->
    <main class="main-admin-content-container p-4 md:p-8 rounded-xl shadow-lg w-full max-w-5xl relative mx-auto my-4 md:my-8">
        <h1 class="text-3xl md:text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500">Panel de Administración</h1>

        <!-- Contenedor de carga inicial -->
        <div id="loading-container" class="text-center p-8">
            <p class="text-lg">Cargando...</p>
        </div>

        <!-- Contenedor de autenticación, oculto por defecto -->
        <div id="auth-container" class="max-w-md mx-auto hidden">
            <div class="p-8 border rounded-lg shadow-sm bg-white dark:bg-gray-800 dark:border-gray-700">
                <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2>
                <form id="login-form">
                    <div class="space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" id="email" class="w-full p-2 border rounded-md" placeholder="tu@email.com" autocomplete="email">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium mb-1">Contraseña</label>
                            <input type="password" id="password" class="w-full p-2 border rounded-md" placeholder="••••••••" autocomplete="current-password">
                        </div>
                        <button id="login-button" type="submit" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                            Entrar
                        </button>
                    </div>
                </form>
                <p id="auth-status" class="text-center text-red-500 mt-4 h-4"></p>
            </div>
        </div>

        <!-- Admin Content (sigue oculto por defecto) -->
        <div id="admin-content" class="hidden">
            <!-- Tab contents go here -->
            <div id="team-formation" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4">Armar Equipos</h2>
                <p class="text-gray-500 mb-4">Arrastra 10 jugadores para formar los equipos Claros y Oscuros.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-medium mb-3">Jugadores Disponibles</h3>
                        <div id="titulares-players" class="player-drop-zone border border-gray-300 rounded-lg p-4 bg-gray-50 flex flex-wrap gap-1 min-h-[120px]">
                            <p class="text-gray-500">Cargando titulares...</p>
                        </div>
                        <h4 class="font-semibold mb-2 mt-4">Suplentes</h4>
                        <div id="suplentes-players" class="player-drop-zone border border-gray-300 rounded-lg p-4 bg-gray-50 flex flex-wrap gap-1 min-h-[120px]">
                            <p class="text-gray-500">Cargando suplentes...</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-3">Jugadores Seleccionados (<span id="total-selected-players">0</span>/10)</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold mb-2">Claros (<span id="claros-count">0</span>)</h4>
                                <div id="team-claros" class="player-drop-zone border border-gray-300 rounded-lg p-3 flex flex-wrap content-start gap-1 min-h-[120px]">
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">Oscuros (<span id="oscuros-count">0</span>)</h4>
                                <div id="team-oscuros" class="player-drop-zone border border-gray-300 rounded-lg p-3 flex flex-wrap content-start gap-1 min-h-[120px]"></div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <label for="team-match-date" class="block text-sm font-medium">Fecha del Partido:</label>
                            <div id="team-match-date-wrapper" class="date-input-wrapper mt-1">
                                <input type="date" id="team-match-date" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                        </div>

                        <button id="save-teams-button" class="mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 w-full" disabled>
                            Guardar Equipos para Partido
                        </button>
                    </div>
                </div>
            </div>

            <div id="players-management" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4">Gestionar Jugadores</h2>
                <div class="mb-6 p-4 border rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium mb-3">Añadir/Modificar Jugador</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="player-id" class="block text-sm font-medium">ID Jugador (para modificar):</label>
                            <input type="text" id="player-id" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2" placeholder="Se genera automáticamente" readonly>
                        </div>
                        <div>
                            <label for="player-name" class="block text-sm font-medium">Nombre:</label>
                            <input type="text" id="player-name" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="player-status" class="block text-sm font-medium">Estado:</label>
                            <select id="player-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                            </select>
                        </div>
                        <div>
                            <label for="player-role" class="block text-sm font-medium">Rol:</label>
                            <select id="player-role" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                <option value="Titular">Titular</option>
                                <option value="Suplente">Suplente</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-3">
                        <button id="save-player-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                            Guardar Jugador
                        </button>
                        <button id="delete-player-button" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                            Eliminar Jugador
                        </button>
                         <button id="clear-player-form-button" class="px-6 py-3 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 transition duration-300">
                            Limpiar
                        </button>
                    </div>
                </div>

                <h3 class="text-xl font-medium mb-3">Listado de Jugadores</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="player-list-name-filter" class="block text-sm font-medium">Buscar por Nombre:</label>
                        <input type="text" id="player-list-name-filter" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2" placeholder="Ej: Mati">
                    </div>
                    <div>
                        <label for="player-list-status-filter" class="block text-sm font-medium">Filtrar por Estado:</label>
                        <select id="player-list-status-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                            <option value="Todos">Todos</option>
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                    <div>
                        <label for="player-list-role-filter" class="block text-sm font-medium">Filtrar por Rol:</label>
                        <select id="player-list-role-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                            <option value="Todos">Todos</option>
                            <option value="Titular">Titular</option>
                            <option value="Suplente">Suplente</option>
                        </select>
                    </div>
                </div>

                <div id="players-list-admin" class="overflow-x-auto">
                    <p id="players-loading-message-admin" class="text-center">Cargando jugadores...</p>
                    <table class="min-w-full rounded-lg shadow hidden">
                        <thead>
                            <tr class="uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">ID</th>
                                <th class="py-3 px-6 text-left">Nombre</th>
                                <th class="py-3 px-6 text-left">Estado</th>
                                <th class="py-3 px-6 text-left">Rol</th>
                                <th class="py-3 px-6 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm font-light">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="match-results" class="tab-content hidden">
                 <h2 class="text-2xl font-semibold mb-4">Resultados</h2>
                 <div class="mb-6 p-4 border rounded-lg shadow-sm">
                     <div id="results-selection-panel" class="hidden">
                        <h3 class="text-xl font-medium mb-3">Partido Seleccionado</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="match-date" class="block text-sm font-medium">Fecha del Partido:</label>
                                <input type="date" id="match-date" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2" readonly>
                            </div>
                            <div>
                                <label for="match-result" class="block text-sm font-medium">Resultado:</label>
                                <select id="match-result" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                    <option value="">Seleccionar resultado</option>
                                    <option value="Claros">Claros</option>
                                    <option value="Oscuros">Oscuros</option>
                                    <option value="Empate">Empate</option>
                                    <option value="Suspendido">Suspendido</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button id="register-match-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex-1">
                                Registrar Resultado
                            </button>
                            <button id="delete-match-button" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 flex-1">
                                Eliminar Partido
                            </button>
                        </div>
                     </div>

                     <h3 class="text-xl font-medium mb-3 mt-6">Seleccionar Partido</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                         <div>
                             <label for="results-year-select" class="block text-sm font-medium">Año:</label>
                             <select id="results-year-select" class="match-year-select mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                             </select>
                         </div>
                         <div>
                             <label for="results-month-select" class="block text-sm font-medium">Mes:</label>
                             <select id="results-month-select" class="match-month-select mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                 <option value="all">Todos</option>
                                 <option value="0">Enero</option>
                                 <option value="1">Febrero</option>
                                 <option value="2">Marzo</option>
                                 <option value="3">Abril</option>
                                 <option value="4">Mayo</option>
                                 <option value="5">Junio</option>
                                 <option value="6">Julio</option>
                                 <option value="7">Agosto</option>
                                 <option value="8">Septiembre</option>
                                 <option value="9">Octubre</option>
                                 <option value="10">Noviembre</option>
                                 <option value="11">Diciembre</option>
                             </select>
                         </div>
                     </div>
                     <label class="block text-sm font-medium mt-4">Partidos Disponibles:</label>
                     <div id="results-list" class="match-list mt-1 border rounded-md shadow-sm max-h-80 overflow-y-auto p-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                         <p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>
                     </div>
                 </div>
            </div>

            <div id="chamigo-management" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4">Chamigo</h2>
                <div class="mb-6 p-4 border rounded-lg shadow-sm">
                    <div id="chamigo-selection-panel" class="hidden">
                        <h3 class="text-xl font-medium mb-3">Registrar Votos de Chamigo</h3>
                        <div id="chamigo-voting-players" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <p class="text-gray-500 col-span-full">Selecciona un partido para cargar los jugadores.</p>
                        </div>
                        <button id="register-chamigo-button" class="px-6 py-3 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-300 w-full">
                            Registrar Chamigo(s)
                        </button>
                    </div>

                    <h3 class="text-xl font-medium mb-3 mt-6">Seleccionar Partido</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="chamigo-year-select" class="block text-sm font-medium">Año:</label>
                            <select id="chamigo-year-select" class="match-year-select mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                            </select>
                        </div>
                        <div>
                            <label for="chamigo-month-select" class="block text-sm font-medium">Mes:</label>
                            <select id="chamigo-month-select" class="match-month-select mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                <option value="all">Todos</option>
                                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                            </select>
                        </div>
                    </div>
                    <label class="block text-sm font-medium mt-4">Partidos Disponibles:</label>
                    <div id="chamigo-list" class="match-list mt-1 border rounded-md shadow-sm max-h-80 overflow-y-auto p-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                        <p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>
                    </div>
                </div>
            </div>

            <div id="tt-attendance" class="tab-content hidden">
                 <h2 class="text-2xl font-semibold mb-4">TT</h2>
                 <div class="p-4 border rounded-lg shadow-sm">
                     <div id="tt-selection-panel" class="hidden">
                        <h3 class="text-xl font-medium mb-3">Registrar Asistencia TT</h3>
                        <div id="tt-attendance-players" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4">
                            <p class="text-gray-500 col-span-full">Selecciona un partido para cargar los jugadores.</p>
                        </div>
                        <button id="register-tt-button" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 w-full">
                            Registrar Asistencia TT
                        </button>
                     </div>

                     <h3 class="text-xl font-medium mb-3 mt-6">Seleccionar Partido</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                         <div>
                             <label for="tt-year-select" class="block text-sm font-medium">Año:</label>
                             <select id="tt-year-select" class="match-year-select mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                             </select>
                         </div>
                         <div>
                             <label for="tt-month-select" class="block text-sm font-medium">Mes:</label>
                             <select id="tt-month-select" class="match-month-select mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                <option value="all">Todos</option>
                                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                             </select>
                         </div>
                     </div>
                     <label class="block text-sm font-medium mt-4">Partidos Disponibles:</label>
                     <div id="tt-list" class="match-list mt-1 border rounded-md shadow-sm max-h-80 overflow-y-auto p-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                         <p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>
                     </div>
                 </div>
            </div>
            
            <div id="edit-match" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4">Editar Partido</h2>
                <div class="mb-6 p-4 border rounded-lg shadow-sm">
                    <div id="edit-match-panel" class="hidden">
                        <h3 class="text-xl font-medium mb-3">Editando Partido</h3>
                        <p class="text-gray-500 mb-4">Arrastra jugadores para modificar los equipos o haz clic en un jugador del equipo para devolverlo a la lista.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-xl font-medium mb-3">Jugadores Disponibles</h3>
                                <div id="edit-titulares-players" class="player-drop-zone border border-gray-300 rounded-lg p-4 bg-gray-50 flex flex-wrap gap-1 min-h-[120px]"></div>
                                <h4 class="font-semibold mb-2 mt-4">Suplentes</h4>
                                <div id="edit-suplentes-players" class="player-drop-zone border border-gray-300 rounded-lg p-4 bg-gray-50 flex flex-wrap gap-1 min-h-[120px]"></div>
                            </div>
                            <div>
                                <h3 class="text-xl font-medium mb-3">Equipos del Partido (<span id="edit-total-selected-players">0</span>)</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <h4 class="font-semibold mb-2">Claros (<span id="edit-claros-count">0</span>)</h4>
                                        <div id="edit-team-claros" class="player-drop-zone border border-gray-300 rounded-lg p-3 flex flex-wrap content-start gap-1 min-h-[120px]"></div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold mb-2">Oscuros (<span id="edit-oscuros-count">0</span>)</h4>
                                        <div id="edit-team-oscuros" class="player-drop-zone border border-gray-300 rounded-lg p-3 flex flex-wrap content-start gap-1 min-h-[120px]"></div>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <label for="edit-match-date" class="block text-sm font-medium">Fecha del Partido:</label>
                                    <div id="edit-match-date-wrapper" class="date-input-wrapper mt-1">
                                        <input type="date" id="edit-match-date" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    </div>
                                </div>
                                <button id="update-match-button" class="mt-6 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 w-full">
                                    Guardar Cambios
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-medium mb-3 mt-6">Seleccionar Partido para Editar</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="edit-year-select" class="block text-sm font-medium">Año:</label>
                            <select id="edit-year-select" class="match-year-select mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm"></select>
                        </div>
                        <div>
                            <label for="edit-month-select" class="block text-sm font-medium">Mes:</label>
                            <select id="edit-month-select" class="match-month-select mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                <option value="all">Todos</option>
                                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                            </select>
                        </div>
                    </div>
                    <label class="block text-sm font-medium mt-4">Partidos Disponibles:</label>
                    <div id="edit-list" class="match-list mt-1 border rounded-md shadow-sm max-h-80 overflow-y-auto p-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                        <p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Custom Modal for Confirmation -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-semibold mb-4" id="modal-title">Confirmar Acción</h3>
            <p class="mb-6" id="modal-message">¿Estás seguro de que quieres realizar esta acción?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Cancelar</button>
                <button id="modal-confirm-button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- 1. Carga de la librería de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 2. Tu script principal -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURACIÓN INICIAL Y ESTADO DE LA APLICACIÓN ---
        const SUPABASE_URL = 'https://ezoqqzequstrzemlbsoa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6b3FxemVxdXN0cnplbWxic29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3Mjc4MzEsImV4cCI6MjA2ODMwMzgzMX0.v_i5kI1dXB4FEt-f8I6Fe5MetcktYnOyt7809un0VlQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const AppState = {
            players: [],
            matches: [],
            userRole: null, // CAMBIO: Para guardar el rol del usuario
            selectedMatchIds: {
                results: null,
                chamigo: null,
                tt: null,
                edit: null,
            },
            chamigoCurrentVotes: {},
            currentDraggedPlayer: null,
            originalParentOfDraggedPlayer: null,
            isInitializing: false, 
        };

        const DOMElements = {
            authContainer: document.getElementById('auth-container'),
            adminContent: document.getElementById('admin-content'),
            loadingContainer: document.getElementById('loading-container'),
            loginForm: document.getElementById('login-form'),
            sideMenu: document.getElementById('side-menu'),
            hamburgerButton: document.getElementById('hamburger-button'),
            overlay: document.getElementById('overlay'),
            loginButton: document.getElementById('login-button'),
            signoutButton: document.getElementById('signout_button'),
            emailInput: document.getElementById('email'),
            passwordInput: document.getElementById('password'),
            authStatus: document.getElementById('auth-status'),
            tabButtons: document.querySelectorAll('.tab-button'),
            tabContents: document.querySelectorAll('.tab-content'),
            customConfirmModal: document.getElementById('custom-confirm-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalCancelButton: document.getElementById('modal-cancel-button'),
            modalConfirmButton: document.getElementById('modal-confirm-button'),
            playerIdInput: document.getElementById('player-id'),
            playerNameInput: document.getElementById('player-name'),
            playerStatusSelect: document.getElementById('player-status'),
            playerRoleSelect: document.getElementById('player-role'),
            savePlayerButton: document.getElementById('save-player-button'),
            deletePlayerButton: document.getElementById('delete-player-button'),
            clearPlayerFormButton: document.getElementById('clear-player-form-button'),
            playersListAdminTableBody: document.querySelector('#players-list-admin table tbody'),
            playersLoadingMessageAdmin: document.getElementById('players-loading-message-admin'),
            playerListNameFilter: document.getElementById('player-list-name-filter'),
            playerListStatusFilter: document.getElementById('player-list-status-filter'),
            playerListRoleFilter: document.getElementById('player-list-role-filter'),
            teamMatchDateInput: document.getElementById('team-match-date'),
            teamMatchDateWrapper: document.getElementById('team-match-date-wrapper'),
            titularesPlayersDiv: document.getElementById('titulares-players'),
            suplentesPlayersDiv: document.getElementById('suplentes-players'),
            teamClarosDiv: document.getElementById('team-claros'),
            teamOscurosDiv: document.getElementById('team-oscuros'),
            clarosCountSpan: document.getElementById('claros-count'),
            oscurosCountSpan: document.getElementById('oscuros-count'),
            totalSelectedPlayersSpan: document.getElementById('total-selected-players'),
            saveTeamsButton: document.getElementById('save-teams-button'),
            matchDateInput: document.getElementById('match-date'),
            matchResultSelect: document.getElementById('match-result'),
            matchYearSelects: document.querySelectorAll('.match-year-select'),
            matchMonthSelects: document.querySelectorAll('.match-month-select'),
            matchLists: document.querySelectorAll('.match-list'),
            registerMatchButton: document.getElementById('register-match-button'),
            deleteMatchButton: document.getElementById('delete-match-button'),
            chamigoVotingPlayersDiv: document.getElementById('chamigo-voting-players'),
            registerChamigoButton: document.getElementById('register-chamigo-button'),
            ttAttendancePlayersDiv: document.getElementById('tt-attendance-players'),
            registerTtButton: document.getElementById('register-tt-button'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            darkModeIcon: document.getElementById('dark-mode-icon'),
            htmlElement: document.documentElement,
            resultsSelectionPanel: document.getElementById('results-selection-panel'),
            chamigoSelectionPanel: document.getElementById('chamigo-selection-panel'),
            ttSelectionPanel: document.getElementById('tt-selection-panel'),
            editMatchPanel: document.getElementById('edit-match-panel'),
            editMatchDateInput: document.getElementById('edit-match-date'),
            editMatchDateWrapper: document.getElementById('edit-match-date-wrapper'),
            editTeamClarosDiv: document.getElementById('edit-team-claros'),
            editTeamOscurosDiv: document.getElementById('edit-team-oscuros'),
            editTitularesPlayersDiv: document.getElementById('edit-titulares-players'),
            editSuplentesPlayersDiv: document.getElementById('edit-suplentes-players'),
            editClarosCountSpan: document.getElementById('edit-claros-count'),
            editOscurosCountSpan: document.getElementById('edit-oscuros-count'),
            editTotalSelectedPlayersSpan: document.getElementById('edit-total-selected-players'),
            updateMatchButton: document.getElementById('update-match-button'),
        };

        // --- MANEJO DE AUTENTICACIÓN Y CICLO DE VIDA ---
        
        const showLoginScreen = () => {
            DOMElements.loadingContainer.classList.add('hidden');
            DOMElements.authContainer.classList.remove('hidden');
            DOMElements.adminContent.classList.add('hidden');
            DOMElements.sideMenu.classList.add('hidden-truly');
            DOMElements.sideMenu.classList.remove('open');
            DOMElements.hamburgerButton.classList.add('hidden');
            DOMElements.overlay.classList.remove('open');
            document.body.classList.remove('overflow-hidden');
            AppState.players = [];
            AppState.matches = [];
            AppState.userRole = null;
            AppState.isInitializing = false;
        };

        const loadAdminPanel = async (session) => {
            if (AppState.isInitializing) return;
            AppState.isInitializing = true;
            
            DOMElements.authContainer.classList.add('hidden');
            DOMElements.adminContent.classList.add('hidden');
            DOMElements.loadingContainer.classList.remove('hidden');

            try {
                const [players, matches, profile] = await Promise.all([
                    fetchData('players', { column: 'id', ascending: true }),
                    fetchData('matches', { column: 'match_date', ascending: false }),
                    fetchData('profiles', { column: 'id', ascending: true }, session.user.id) // Fetch user role
                ]);
                AppState.players = players || [];
                AppState.matches = matches || [];
                AppState.userRole = profile ? profile.role : null;
                
                renderAllContent();
                
                DOMElements.loadingContainer.classList.add('hidden');
                DOMElements.adminContent.classList.remove('hidden');
                updateUIForAuth();

            } catch (error) {
                console.error("Error fatal durante la inicialización del panel:", error);
                showToast("Error al cargar datos. Intente refrescar.", "error");
                showLoginScreen();
            } finally {
                AppState.isInitializing = false;
            }
        };

        const handleLogin = async (event) => {
            event.preventDefault();
            DOMElements.loginButton.disabled = true;
            DOMElements.loginButton.textContent = "Entrando...";
            const email = DOMElements.emailInput.value.trim();
            const password = DOMElements.passwordInput.value.trim();
            DOMElements.authStatus.textContent = '';

            if (!email || !password) {
                DOMElements.authStatus.textContent = 'Por favor, ingresa email y contraseña.';
                DOMElements.loginButton.disabled = false;
                DOMElements.loginButton.textContent = "Entrar";
                return;
            }

            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                DOMElements.authStatus.textContent = 'Email o contraseña incorrectos.';
            }
            DOMElements.loginButton.disabled = false;
            DOMElements.loginButton.textContent = "Entrar";
        };

        const handleSignout = async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Signout error:", error);
                showToast("Error al cerrar sesión.", "error");
            }
        };

        // --- LÓGICA DE DATOS (SUPABASE) ---
        const fetchData = async (tableName, orderOptions, userId = null) => {
            try {
                let query = supabase.from(tableName).select('*');
                if (userId) {
                    query = query.eq('id', userId).single();
                } else {
                    query = query.order(orderOptions.column, { ascending: orderOptions.ascending });
                }
                const { data, error } = await query;
                if (error) throw error;
                return data;
            } catch (error) {
                // Silenciar el error si es porque el perfil no existe, es un caso esperado.
                if (error.code === 'PGRST116' && tableName === 'profiles') {
                    console.warn("El usuario no tiene un perfil de rol definido.");
                    return null;
                }
                console.error(`Error cargando ${tableName}:`, error);
                showToast(`Error al cargar ${tableName}. Revisa la consola.`, 'error');
                return userId ? null : [];
            }
        };
        
        const refreshDataAndRender = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if(session) {
                await loadAdminPanel(session);
            }
        };

        // --- LÓGICA DE RENDERIZADO ---
        const renderAllContent = () => {
            populateMatchYearSelects();
            setInitialDateFilters();
            populateFilteredMatchLists();

            let activeTab = document.querySelector('.tab-button.active')?.dataset.tab;
            if (!activeTab || (AppState.userRole !== 'Admin' && document.querySelector('.tab-button.active')?.dataset.role === 'Admin')) {
                const firstTabButton = DOMElements.tabButtons[0];
                if (firstTabButton) {
                    DOMElements.tabButtons.forEach(btn => btn.classList.remove('active'));
                    DOMElements.tabContents.forEach(content => content.classList.add('hidden'));
                    
                    firstTabButton.classList.add('active');
                    document.getElementById(firstTabButton.dataset.tab).classList.remove('hidden');
                    activeTab = firstTabButton.dataset.tab;
                }
            }
            if(activeTab) {
                renderTabContent(activeTab);
            }
        };

        const renderTabContent = (tabId) => {
             switch (tabId) {
                case 'players-management':
                    renderPlayersListAdmin();
                    break;
                case 'team-formation':
                    renderAvailablePlayersForTeams();
                    break;
                case 'results':
                case 'chamigo-management':
                case 'tt-attendance':
                case 'edit-match':
                    populateFilteredMatchLists();
                    DOMElements.resultsSelectionPanel.classList.add('hidden');
                    DOMElements.chamigoSelectionPanel.classList.add('hidden');
                    DOMElements.ttSelectionPanel.classList.add('hidden');
                    DOMElements.editMatchPanel.classList.add('hidden');
                    break;
            }
        };

        // --- GESTIÓN DE JUGADORES (ABM) ---
        const renderPlayersListAdmin = () => {
            const tableBody = DOMElements.playersListAdminTableBody;
            const loadingMsg = DOMElements.playersLoadingMessageAdmin;
            const table = tableBody.parentElement;

            tableBody.innerHTML = '';
            loadingMsg.classList.remove('hidden');
            table.classList.add('hidden');

            const nameFilter = DOMElements.playerListNameFilter.value.toLowerCase();
            const statusFilter = DOMElements.playerListStatusFilter.value;
            const roleFilter = DOMElements.playerListRoleFilter.value;

            const filteredPlayers = AppState.players.filter(player => 
                (nameFilter === '' || player.name.toLowerCase().includes(nameFilter)) &&
                (statusFilter === 'Todos' || player.status === statusFilter) &&
                (roleFilter === 'Todos' || player.role === roleFilter)
            );

            if (filteredPlayers.length === 0) {
                loadingMsg.textContent = 'No hay jugadores que coincidan con los filtros.';
                return;
            }

            loadingMsg.classList.add('hidden');
            table.classList.remove('hidden');

            filteredPlayers.forEach(player => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left">${player.id}</td>
                    <td class="py-3 px-6 text-left">${player.name}</td>
                    <td class="py-3 px-6 text-left">${player.status}</td>
                    <td class="py-3 px-6 text-left">${player.role}</td>
                    <td class="py-3 px-6 text-center">
                        <button class="edit-player-button px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 text-xs">Editar</button>
                    </td>
                `;
                row.querySelector('.edit-player-button').addEventListener('click', () => populatePlayerForm(player));
                tableBody.appendChild(row);
            });
        };
        
        const populatePlayerForm = (player) => {
            DOMElements.playerIdInput.value = player.id;
            DOMElements.playerNameInput.value = player.name;
            DOMElements.playerStatusSelect.value = player.status;
            DOMElements.playerRoleSelect.value = player.role;
        };

        const clearPlayerForm = () => {
            DOMElements.playerIdInput.value = '';
            DOMElements.playerNameInput.value = '';
            DOMElements.playerStatusSelect.value = 'Activo';
            DOMElements.playerRoleSelect.value = 'Titular';
        };

        const handleSavePlayer = async () => {
            const id = DOMElements.playerIdInput.value.trim();
            const name = DOMElements.playerNameInput.value.trim();
            if (!name) {
                showToast('El nombre del jugador no puede estar vacío.', 'error');
                return;
            }

            const playerData = { 
                name, 
                status: DOMElements.playerStatusSelect.value, 
                role: DOMElements.playerRoleSelect.value 
            };

            try {
                let error, successMessage;
                if (id) { // Update
                    const { error: updateError } = await supabase.from('players').update(playerData).eq('id', id);
                    error = updateError;
                    successMessage = 'Jugador actualizado exitosamente.';
                } else { // Insert
                    const { data: lastPlayer, error: idError } = await supabase.from('players').select('id').order('id', { ascending: false }).limit(1).single();
                    if (idError && idError.code !== 'PGRST116') throw idError;
                    
                    const lastIdNum = lastPlayer ? parseInt(lastPlayer.id.replace('J', '')) : 0;
                    playerData.id = 'J' + String(lastIdNum + 1).padStart(3, '0');

                    const { error: insertError } = await supabase.from('players').insert([playerData]);
                    error = insertError;
                    successMessage = 'Jugador creado exitosamente.';
                }

                if (error) throw error;
                showToast(successMessage, 'success');
                clearPlayerForm();
                await refreshDataAndRender();
            } catch (error) {
                console.error('Error al guardar jugador:', error);
                showToast(`Error al guardar jugador: ${error.message}`, 'error');
            }
        };

        const handleDeletePlayer = async () => {
            const idToDelete = DOMElements.playerIdInput.value.trim();
            if (!idToDelete) {
                showToast('Selecciona un jugador para eliminar.', 'warning');
                return;
            }

            const confirmed = await showCustomConfirm('Confirmar Eliminación', `¿Estás seguro de que quieres marcar al jugador con ID ${idToDelete} como Inactivo?`);
            if (!confirmed) return;

            try {
                const { error } = await supabase.from('players').update({ status: 'Inactivo' }).eq('id', idToDelete);
                if (error) throw error;
                showToast(`Jugador con ID ${idToDelete} marcado como Inactivo.`, 'success');
                clearPlayerForm();
                await refreshDataAndRender();
            } catch (error) {
                console.error('Error al eliminar jugador:', error);
                showToast(`Error al eliminar jugador: ${error.message}`, 'error');
            }
        };

        // --- ARMADO DE EQUIPOS ---
        const renderAvailablePlayersForTeams = () => {
            DOMElements.titularesPlayersDiv.innerHTML = '';
            DOMElements.suplentesPlayersDiv.innerHTML = '';
            const activePlayers = AppState.players.filter(p => p.status === 'Activo');

            if (activePlayers.length === 0) {
                DOMElements.titularesPlayersDiv.innerHTML = '<p class="text-gray-500">No hay jugadores activos.</p>';
                return;
            }
            
            activePlayers.forEach(player => {
                const playerElement = createDraggablePlayer(player);
                if (player.role === 'Titular') {
                    DOMElements.titularesPlayersDiv.appendChild(playerElement);
                } else {
                    DOMElements.suplentesPlayersDiv.appendChild(playerElement);
                }
            });
        };

        const createDraggablePlayer = (player) => {
            const el = document.createElement('div');
            el.className = 'player-draggable';
            el.draggable = true;
            el.dataset.id = player.id;
            el.dataset.name = player.name;
            el.dataset.role = player.role;
            el.textContent = player.name;
            el.addEventListener('dragstart', handleDragStart);
            el.addEventListener('touchstart', handleTouchStart, { passive: false });
            return el;
        };
        
        const updateTeamCounts = () => {
            const clarosCount = DOMElements.teamClarosDiv.children.length;
            const oscurosCount = DOMElements.teamOscurosDiv.children.length;
            DOMElements.clarosCountSpan.textContent = clarosCount;
            DOMElements.oscurosCountSpan.textContent = oscurosCount;
            DOMElements.totalSelectedPlayersSpan.textContent = clarosCount + oscurosCount;
            DOMElements.saveTeamsButton.disabled = !(clarosCount === 5 && oscurosCount === 5);
        };
        
        const handleSaveTeams = async () => {
            const matchDate = DOMElements.teamMatchDateInput.value;
            if (!matchDate) {
                showToast('Por favor, selecciona la fecha del partido.', 'warning');
                return;
            }
            
            const teamWhitePlayers = Array.from(DOMElements.teamClarosDiv.children).map(el => el.dataset.id);
            const teamDarkPlayers = Array.from(DOMElements.teamOscurosDiv.children).map(el => el.dataset.id);

            if (teamWhitePlayers.length !== 5 || teamDarkPlayers.length !== 5) {
                showToast('Debes seleccionar 5 jugadores por equipo.', 'warning');
                return;
            }

            try {
                const { error } = await supabase.from('matches').insert([{ 
                    match_date: matchDate,
                    team_white_players: teamWhitePlayers,
                    team_dark_players: teamDarkPlayers,
                    chamigo_votes: {},
                    tt_attendees: []
                }]);
                if (error) throw error;
                showToast('Partido creado exitosamente!', 'success');
                DOMElements.teamMatchDateInput.value = '';
                DOMElements.teamClarosDiv.innerHTML = '';
                DOMElements.teamOscurosDiv.innerHTML = '';
                updateTeamCounts();
                await refreshDataAndRender();
            } catch(error) {
                console.error('Error creando partido:', error);
                showToast(`Error al crear el partido: ${error.message}`, 'error');
            }
        };

        // --- MANEJO DE PARTIDOS (Resultados, Chamigo, TT) ---
        const populateMatchYearSelects = () => {
            const years = AppState.matches.length > 0 
                ? [...new Set(AppState.matches.map(m => new Date(m.match_date).getFullYear()))].sort((a,b) => b-a)
                : [new Date().getFullYear()];
            
            DOMElements.matchYearSelects.forEach(select => {
                select.innerHTML = '';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                });
            });
        };

        const setInitialDateFilters = () => {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();

            DOMElements.matchYearSelects.forEach(select => {
                if (Array.from(select.options).some(opt => opt.value == currentYear)) {
                    select.value = currentYear;
                }
            });
            DOMElements.matchMonthSelects.forEach(select => select.value = currentMonth);
        };

        const populateFilteredMatchLists = () => {
            populateMatchListForTab('results');
            populateMatchListForTab('chamigo');
            populateMatchListForTab('tt');
            populateMatchListForTab('edit');
        };
        
        const populateMatchListForTab = (tabId) => {
            const listDiv = document.getElementById(`${tabId}-list`);
            const yearSelect = document.getElementById(`${tabId}-year-select`);
            const monthSelect = document.getElementById(`${tabId}-month-select`);
            
            if (!listDiv || !yearSelect || !monthSelect) return;

            const selectedYear = yearSelect.value;
            const selectedMonth = monthSelect.value;
            listDiv.innerHTML = '';

            const filteredMatches = AppState.matches.filter(match => {
                const matchDate = new Date(match.match_date);
                const yearMatch = selectedYear ? matchDate.getFullYear() == selectedYear : true;
                const monthMatch = selectedMonth !== 'all' ? matchDate.getMonth() == selectedMonth : true;
                return yearMatch && monthMatch;
            }).sort((a,b) => new Date(b.match_date) - new Date(a.match_date));

            if (filteredMatches.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500">No hay partidos para los filtros seleccionados.</p>';
                return;
            }

            filteredMatches.forEach(match => {
                const matchItem = createMatchItem(match, tabId);
                matchItem.addEventListener('click', (e) => {
                    const isSelected = e.currentTarget.classList.contains('selected');
                    document.querySelectorAll(`#${tabId}-list .match-item`).forEach(item => item.classList.remove('selected', 'border-indigo-500'));
                    
                    if (isSelected) {
                        AppState.selectedMatchIds[tabId] = null;
                        handleMatchSelection(null, tabId);
                    } else {
                        e.currentTarget.classList.add('selected', 'border-indigo-500');
                        AppState.selectedMatchIds[tabId] = match.id;
                        handleMatchSelection(match, tabId);
                    }
                });
                listDiv.appendChild(matchItem);
            });
        };
        
        const createMatchItem = (match, tabId) => {
            const item = document.createElement('div');
            let isComplete = false;
            let statusText = 'Pendiente';

            switch (tabId) {
                case 'results':
                    isComplete = !!match.result;
                    statusText = `Resultado: ${match.result || 'Pendiente'}`;
                    break;
                case 'chamigo':
                    isComplete = match.chamigo_votes && Object.keys(match.chamigo_votes).length > 0;
                    statusText = `Votos: ${isComplete ? 'Registrados' : 'Pendiente'}`;
                    break;
                case 'tt':
                    isComplete = match.tt_attendees && match.tt_attendees.length > 0;
                    statusText = `Asistencia: ${isComplete ? 'Registrada' : 'Pendiente'}`;
                    break;
                case 'edit':
                    statusText = `Equipos: ${match.team_white_players?.length || 0} vs ${match.team_dark_players?.length || 0}`;
                    isComplete = true;
                    break;
            }

            item.className = `match-item p-2 border rounded-md cursor-pointer ${isComplete ? 'has-result' : 'no-result'}`;
            item.dataset.matchId = match.id;
            item.innerHTML = `<p class="font-semibold">${formatDateToDDMMYYYY(match.match_date)}</p><p class="text-xs text-gray-500">${statusText}</p>`;
            return item;
        };

        const handleMatchSelection = (match, tabId) => {
            const panels = {
                results: DOMElements.resultsSelectionPanel,
                chamigo: DOMElements.chamigoSelectionPanel,
                tt: DOMElements.ttSelectionPanel,
                edit: DOMElements.editMatchPanel,
            };

            const panel = panels[tabId];
            if (!panel) return;

            if (!match) {
                panel.classList.add('hidden');
                return;
            }
            
            panel.classList.remove('hidden');

            switch (tabId) {
                case 'results':
                    DOMElements.matchDateInput.value = match.match_date;
                    DOMElements.matchResultSelect.value = match.result || '';
                    break;
                case 'chamigo':
                    renderChamigoVotingPlayers(match);
                    break;
                case 'tt':
                    renderTtAttendancePlayers(match);
                    break;
                case 'edit':
                    renderEditMatchPanel(match);
                    break;
            }
        };

        const handleRegisterResult = async () => {
            const matchId = AppState.selectedMatchIds.results;
            if (!matchId) {
                showToast('Por favor, selecciona un partido.', 'warning');
                return;
            }
            const result = DOMElements.matchResultSelect.value;
            try {
                const { error } = await supabase.from('matches').update({ result }).eq('id', matchId);
                if (error) throw error;
                showToast('Resultado actualizado!', 'success');
                await refreshDataAndRender();
            } catch (error) {
                console.error('Error actualizando resultado:', error);
                showToast(`Error al actualizar el resultado: ${error.message}`, 'error');
            }
        };

        const handleDeleteMatch = async () => {
            const matchId = AppState.selectedMatchIds.results;
            if (!matchId) {
                showToast('Por favor, selecciona un partido para eliminar.', 'warning');
                return;
            }
            const confirmed = await showCustomConfirm('Confirmar Eliminación', `¿Seguro que quieres eliminar este partido? Esta acción es irreversible.`);
            if (!confirmed) return;

            try {
                const { error } = await supabase.from('matches').delete().eq('id', matchId);
                if (error) throw error;
                showToast('Partido eliminado exitosamente.', 'success');
                DOMElements.resultsSelectionPanel.classList.add('hidden');
                AppState.selectedMatchIds.results = null;
                await refreshDataAndRender();
            } catch (error) {
                console.error('Error al eliminar partido:', error);
                showToast(`Error al eliminar el partido: ${error.message}`, 'error');
            }
        };

        const renderChamigoVotingPlayers = (match) => {
            const container = DOMElements.chamigoVotingPlayersDiv;
            container.innerHTML = '';
            const playerIDs = [...new Set([...(match.team_white_players||[]), ...(match.team_dark_players||[])])].filter(Boolean);
            AppState.chamigoCurrentVotes = match.chamigo_votes || {};

            playerIDs.forEach(id => {
                const player = AppState.players.find(p => p.id === id);
                if (!player) return;
                
                const voteCount = AppState.chamigoCurrentVotes[id] || 0;
                
                const playerDiv = document.createElement('div');
                playerDiv.className = 'chamigo-player-item';
                playerDiv.dataset.id = id;
                playerDiv.innerHTML = `
                    <span class="player-name flex-grow text-left">${player.name}</span>
                    <div class="chamigo-vote-controls">
                        <button class="chamigo-vote-btn subtract-vote">-</button>
                        <span class="chamigo-vote-counter">${voteCount}</span>
                    </div>
                `;
                
                playerDiv.querySelector('.player-name').addEventListener('click', () => {
                    let currentVotes = AppState.chamigoCurrentVotes[id] || 0;
                    currentVotes++;
                    AppState.chamigoCurrentVotes[id] = currentVotes;
                    playerDiv.querySelector('.chamigo-vote-counter').textContent = currentVotes;
                });

                playerDiv.querySelector('.subtract-vote').addEventListener('click', (e) => {
                    e.stopPropagation();
                    let currentVotes = AppState.chamigoCurrentVotes[id] || 0;
                    currentVotes = Math.max(0, currentVotes - 1);
                    AppState.chamigoCurrentVotes[id] = currentVotes;
                    playerDiv.querySelector('.chamigo-vote-counter').textContent = currentVotes;
                });
                
                container.appendChild(playerDiv);
            });
        };

        const handleRegisterChamigo = async () => {
            const matchId = AppState.selectedMatchIds.chamigo;
            if (!matchId) {
                showToast('Por favor, selecciona un partido.', 'warning');
                return;
            }
            
            const finalVotes = {};
            for (const playerId in AppState.chamigoCurrentVotes) {
                if (AppState.chamigoCurrentVotes[playerId] > 0) {
                    finalVotes[playerId] = AppState.chamigoCurrentVotes[playerId];
                }
            }

            try {
                const { error } = await supabase.from('matches').update({ chamigo_votes: finalVotes }).eq('id', matchId);
                if (error) throw error;
                showToast('Votos de Chamigo guardados!', 'success');
                DOMElements.chamigoSelectionPanel.classList.add('hidden');
                AppState.selectedMatchIds.chamigo = null;
                await refreshDataAndRender();
            } catch (error) {
                console.error('Error guardando votos de Chamigo:', error);
                showToast(`Error al guardar los votos: ${error.message}`, 'error');
            }
        };

        const renderTtAttendancePlayers = (match) => {
            const container = DOMElements.ttAttendancePlayersDiv;
            container.innerHTML = '';
            const activePlayers = AppState.players.filter(p => p.status === 'Activo');
            const existingAttendees = match.tt_attendees || [];
            
            if (activePlayers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full">No hay jugadores activos.</p>';
                return;
            }

            activePlayers.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'tt-player-item';
                if (existingAttendees.includes(player.id)) {
                    playerDiv.classList.add('selected');
                }
                playerDiv.dataset.id = player.id;
                playerDiv.textContent = player.name;
                
                playerDiv.addEventListener('click', (e) => {
                    e.currentTarget.classList.toggle('selected');
                });

                container.appendChild(playerDiv);
            });
        };

        const handleRegisterTt = async () => {
            const matchId = AppState.selectedMatchIds.tt;
            if (!matchId) {
                showToast('Por favor, selecciona un partido.', 'warning');
                return;
            }
            const attendees = Array.from(document.querySelectorAll('#tt-attendance-players .tt-player-item.selected')).map(el => el.dataset.id);

            try {
                const { error } = await supabase.from('matches').update({ tt_attendees: attendees }).eq('id', matchId);
                if (error) throw error;
                showToast('Asistencia a TT guardada!', 'success');
                DOMElements.ttSelectionPanel.classList.add('hidden');
                AppState.selectedMatchIds.tt = null;
                await refreshDataAndRender();
            } catch (error) {
                console.error('Error guardando asistencia a TT:', error);
                showToast(`Error al guardar la asistencia: ${error.message}`, 'error');
            }
        };

        // --- LÓGICA PARA EDITAR PARTIDO ---
        const renderEditMatchPanel = (match) => {
            DOMElements.editMatchDateInput.value = match.match_date;
            
            const teamWhiteIDs = match.team_white_players || [];
            const teamDarkIDs = match.team_dark_players || [];

            [DOMElements.editTeamClarosDiv, DOMElements.editTeamOscurosDiv, DOMElements.editTitularesPlayersDiv, DOMElements.editSuplentesPlayersDiv].forEach(el => el.innerHTML = '');

            AppState.players.forEach(player => {
                if (player.status !== 'Activo') return;

                const playerEl = createDraggablePlayer(player);
                
                playerEl.addEventListener('click', (e) => {
                    const clickedPlayer = e.currentTarget;
                    const destination = clickedPlayer.dataset.role === 'Titular' ? DOMElements.editTitularesPlayersDiv : DOMElements.editSuplentesPlayersDiv;
                    destination.appendChild(clickedPlayer);
                    updateEditTeamCounts();
                });

                if (teamWhiteIDs.includes(player.id)) {
                    DOMElements.editTeamClarosDiv.appendChild(playerEl);
                } else if (teamDarkIDs.includes(player.id)) {
                    DOMElements.editTeamOscurosDiv.appendChild(playerEl);
                } else {
                    if (player.role === 'Titular') {
                         DOMElements.editTitularesPlayersDiv.appendChild(playerEl);
                    } else {
                         DOMElements.editSuplentesPlayersDiv.appendChild(playerEl);
                    }
                }
            });
            updateEditTeamCounts();
        };

        const updateEditTeamCounts = () => {
            const clarosCount = DOMElements.editTeamClarosDiv.children.length;
            const oscurosCount = DOMElements.editTeamOscurosDiv.children.length;
            DOMElements.editClarosCountSpan.textContent = clarosCount;
            DOMElements.editOscurosCountSpan.textContent = oscurosCount;
            DOMElements.editTotalSelectedPlayersSpan.textContent = clarosCount + oscurosCount;
            DOMElements.updateMatchButton.disabled = (clarosCount + oscurosCount) !== 10;
        };

        const handleUpdateMatch = async () => {
            const matchId = AppState.selectedMatchIds.edit;
            if (!matchId) {
                showToast('No hay un partido seleccionado para actualizar.', 'error');
                return;
            }

            const newDate = DOMElements.editMatchDateInput.value;
            const newTeamWhite = Array.from(DOMElements.editTeamClarosDiv.children).map(el => el.dataset.id);
            const newTeamDark = Array.from(DOMElements.editTeamOscurosDiv.children).map(el => el.dataset.id);

            if (!newDate) {
                showToast('La fecha del partido no puede estar vacía.', 'warning');
                return;
            }

            try {
                const { error } = await supabase.from('matches').update({
                    match_date: newDate,
                    team_white_players: newTeamWhite,
                    team_dark_players: newTeamDark
                }).eq('id', matchId);

                if (error) throw error;

                showToast('Partido actualizado exitosamente.', 'success');
                DOMElements.editMatchPanel.classList.add('hidden');
                AppState.selectedMatchIds.edit = null;
                await refreshDataAndRender();

            } catch (error) {
                console.error('Error al actualizar el partido:', error);
                showToast(`Error al actualizar el partido: ${error.message}`, 'error');
            }
        };


        // --- MANEJO DE UI GENERAL Y EVENTOS ---
        const setupEventListeners = () => {
            // Autenticación
            DOMElements.loginForm.addEventListener('submit', handleLogin);
            DOMElements.signoutButton.addEventListener('click', handleSignout);
            
            // Navegación y UI
            DOMElements.hamburgerButton.addEventListener('click', toggleSideMenu);
            DOMElements.overlay.addEventListener('click', toggleSideMenu);
            window.addEventListener('resize', handleResize);
            DOMElements.darkModeToggle.addEventListener('click', toggleTheme);
            DOMElements.tabButtons.forEach(button => button.addEventListener('click', handleTabButtonClick));

            [DOMElements.teamMatchDateWrapper, DOMElements.editMatchDateWrapper].forEach(wrapper => {
                wrapper.addEventListener('click', () => {
                    try {
                        wrapper.querySelector('input[type="date"]').showPicker();
                    } catch (error) {
                        console.log("showPicker() no es soportado en este navegador.");
                    }
                });
            });

            // ABM Jugadores
            DOMElements.savePlayerButton.addEventListener('click', handleSavePlayer);
            DOMElements.deletePlayerButton.addEventListener('click', handleDeletePlayer);
            DOMElements.clearPlayerFormButton.addEventListener('click', clearPlayerForm);
            [DOMElements.playerListNameFilter, DOMElements.playerListStatusFilter, DOMElements.playerListRoleFilter].forEach(el => {
                el.addEventListener('input', renderPlayersListAdmin);
            });

            // Drag & Drop
            const dropZones = [
                DOMElements.titularesPlayersDiv, DOMElements.suplentesPlayersDiv, 
                DOMElements.teamClarosDiv, DOMElements.teamOscurosDiv,
                DOMElements.editTitularesPlayersDiv, DOMElements.editSuplentesPlayersDiv,
                DOMElements.editTeamClarosDiv, DOMElements.editTeamOscurosDiv
            ];
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => e.preventDefault());
                zone.addEventListener('drop', handleDrop);
            });
            DOMElements.saveTeamsButton.addEventListener('click', handleSaveTeams);

            // Filtros de Partidos
            [...DOMElements.matchYearSelects, ...DOMElements.matchMonthSelects].forEach(select => {
                select.addEventListener('change', populateFilteredMatchLists);
            });
            
            // Acciones de Partidos
            DOMElements.registerMatchButton.addEventListener('click', handleRegisterResult);
            DOMElements.deleteMatchButton.addEventListener('click', handleDeleteMatch);
            DOMElements.registerChamigoButton.addEventListener('click', handleRegisterChamigo);
            DOMElements.registerTtButton.addEventListener('click', handleRegisterTt);
            DOMElements.updateMatchButton.addEventListener('click', handleUpdateMatch);
        };
        
        const handleTabButtonClick = (event) => {
            const clickedButton = event.currentTarget;
            DOMElements.tabButtons.forEach(btn => btn.classList.remove('active'));
            DOMElements.tabContents.forEach(content => content.classList.add('hidden'));
            
            clickedButton.classList.add('active');
            const tabId = clickedButton.dataset.tab;
            document.getElementById(tabId).classList.remove('hidden');
            
            if (window.innerWidth < 768) {
                toggleSideMenu();
            }
            renderTabContent(tabId);
        };
        
        const updateUIForAuth = () => {
            // Control de visibilidad de menú por rol
            const userRole = AppState.userRole;
            DOMElements.tabButtons.forEach(button => {
                const requiredRole = button.dataset.role;
                if (requiredRole && requiredRole !== userRole) {
                    button.classList.add('hidden');
                } else {
                    button.classList.remove('hidden');
                }
            });

            if (window.innerWidth >= 768) {
                DOMElements.sideMenu.classList.remove('hidden-truly');
                DOMElements.sideMenu.classList.add('open');
                DOMElements.hamburgerButton.classList.add('hidden');
            } else {
                DOMElements.sideMenu.classList.add('hidden-truly');
                DOMElements.sideMenu.classList.remove('open');
                DOMElements.hamburgerButton.classList.remove('hidden');
            }
        };

        // --- DRAG & DROP (CON SOPORTE TÁCTIL) ---
        const handleDragStart = (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
            e.dataTransfer.effectAllowed = 'move';
        };

        const handleDrop = (e) => {
            e.preventDefault();
            const playerId = e.dataTransfer.getData('text/plain');
            const draggedElement = document.querySelector(`[data-id="${playerId}"]`);
            const dropZone = e.currentTarget;
            handleDropLogic(draggedElement, dropZone);
        };
        
        const handleTouchStart = (e) => {
            if (e.touches.length !== 1) return;
            e.preventDefault();
            const target = e.target;
            AppState.currentDraggedPlayer = target;
            AppState.originalParentOfDraggedPlayer = target.parentNode;
            
            const rect = target.getBoundingClientRect();
            Object.assign(target.style, {
                position: 'fixed', left: `${rect.left}px`, top: `${rect.top}px`,
                width: `${rect.width}px`, height: `${rect.height}px`,
                pointerEvents: 'none', zIndex: '1000'
            });
            target.classList.add('dragging-touch');
            
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);
        };

        const handleTouchMove = (e) => {
            if (!AppState.currentDraggedPlayer) return;
            e.preventDefault();
            const touch = e.touches[0];
            Object.assign(AppState.currentDraggedPlayer.style, {
                left: `${touch.clientX - AppState.currentDraggedPlayer.offsetWidth / 2}px`,
                top: `${touch.clientY - AppState.currentDraggedPlayer.offsetHeight / 2}px`
            });
        };

        const handleTouchEnd = (e) => {
            const dragged = AppState.currentDraggedPlayer;
            if (!dragged) return;
            
            dragged.style.visibility = 'hidden';
            const touch = e.changedTouches[0];
            const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
            dragged.style.visibility = 'visible';
            
            Object.assign(dragged.style, {
                position: '', left: '', top: '', width: '', height: '',
                pointerEvents: '', zIndex: ''
            });
            dragged.classList.remove('dragging-touch');

            const dropZone = dropTarget ? dropTarget.closest('.player-drop-zone') : null;
            if (dropZone) {
                handleDropLogic(dragged, dropZone);
            } else {
                AppState.originalParentOfDraggedPlayer.appendChild(dragged);
            }
            
            document.removeEventListener('touchmove', handleTouchMove);
            document.removeEventListener('touchend', handleTouchEnd);
            AppState.currentDraggedPlayer = null;
            AppState.originalParentOfDraggedPlayer = null;
        };

        const handleDropLogic = (draggedElement, dropZone) => {
            const sourceId = draggedElement.parentNode.id;
            const targetId = dropZone.id;
            if (sourceId === targetId) return;

            if (targetId.includes('team-')) {
                if (dropZone.children.length >= 5) {
                    showToast(`El equipo ya tiene 5 jugadores.`, 'warning');
                    return;
                }
            }
            
            dropZone.appendChild(draggedElement);
            updateTeamCounts();
            updateEditTeamCounts();
        };

        // --- UTILIDADES ---
        const formatDateToDDMMYYYY = (date) => {
            if (!date) return 'N/A';
            const d = new Date(date);
            const correctedDate = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
            const dd = String(correctedDate.getDate()).padStart(2, '0');
            const mm = String(correctedDate.getMonth() + 1).padStart(2, '0');
            const yyyy = correctedDate.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        };

        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500',
            };
            toast.className = `fixed bottom-5 right-5 ${colors[type]} text-white py-2 px-4 rounded-lg shadow-lg`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        };
        
        const showCustomConfirm = (title, message) => {
            return new Promise((resolve) => {
                DOMElements.modalTitle.textContent = title;
                DOMElements.modalMessage.textContent = message;
                DOMElements.customConfirmModal.classList.remove('hidden');
                
                DOMElements.modalConfirmButton.onclick = () => {
                    DOMElements.customConfirmModal.classList.add('hidden');
                    resolve(true);
                };
                DOMElements.modalCancelButton.onclick = () => {
                    DOMElements.customConfirmModal.classList.add('hidden');
                    resolve(false);
                };
            });
        };

        const applyTheme = (theme) => {
            DOMElements.htmlElement.classList.toggle('dark', theme === 'dark');
            DOMElements.darkModeIcon.classList.toggle('fa-sun', theme === 'dark');
            DOMElements.darkModeIcon.classList.toggle('fa-moon', theme !== 'dark');
            localStorage.setItem('theme', theme);
        };

        const toggleTheme = () => {
            const currentTheme = DOMElements.htmlElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(currentTheme);
        };

        const toggleSideMenu = () => {
            if (window.innerWidth < 768) {
                const isOpen = DOMElements.sideMenu.classList.toggle('open');
                DOMElements.overlay.classList.toggle('open', isOpen);
                document.body.classList.toggle('overflow-hidden', isOpen);
                if (isOpen) {
                    DOMElements.sideMenu.classList.remove('hidden-truly');
                } else {
                    setTimeout(() => DOMElements.sideMenu.classList.add('hidden-truly'), 300);
                }
            }
        };

        const handleResize = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) return;
            updateUIForAuth();
        };

        // --- INICIALIZACIÓN DE LA APP ---
        const main = () => {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
            setupEventListeners();
            
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'INITIAL_SESSION') {
                    if (session) {
                        loadAdminPanel(session);
                    } else {
                        showLoginScreen();
                    }
                } else if (event === 'SIGNED_IN') {
                    loadAdminPanel(session);
                } else if (event === 'SIGNED_OUT') {
                    showLoginScreen();
                }
            });
        };

        main();
    });
    </script>
</body>
</html>
