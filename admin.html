<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración Fútbol 5</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Font Awesome para los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Carga de la fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            overflow-x: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- ESTILOS BASE (MODO CLARO) --- */
        body {
            background-color: #f0f2f5;
        }
        .main-admin-content-container, #login-screen {
            background-color: #ffffff;
            color: #1f2937;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #374151;
        }
        label, .text-gray-700 {
            color: #374151;
        }
        .text-gray-500 {
            color: #6b7280;
        }
        input, select {
            background-color: #ffffff;
            border-color: #d1d5db;
            color: #1f2937;
        }
        input::placeholder {
            color: #9ca3af;
        }
        .tab-content, .p-4.border {
            border-color: #e5e7eb;
        }
        .match-item {
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
        }
        .match-item.no-result { background-color: #fee2e2; }
        .match-item.has-result { background-color: #dcfce7; }
        .match-item:hover { background-color: #f3f4f6; }
        .match-item.selected { background-color: #e0e7ff; border-color: #6366f1; }
        #players-list-admin table { background-color: #ffffff; }
        #players-list-admin thead tr { background-color: #f3f4f6; color: #374151; }
        #players-list-admin tbody tr { border-color: #e5e7eb; }
        #players-list-admin tbody tr:hover { background-color: #f9fafb; }
        #players-list-admin tbody td { color: #4b5563; }
        #custom-confirm-modal .bg-white { background-color: #ffffff; }

        /* --- ESTILOS MODO OSCURO --- */
        html.dark body { background-color: #111827; }
        html.dark .main-admin-content-container, html.dark #login-screen { background-color: #1f2937; color: #d1d5db; }
        html.dark h1, html.dark h2, html.dark h3, html.dark h4, html.dark h5, html.dark h6 { color: #f9fafb; }
        html.dark .text-indigo-800 { color: #a5b4fc; }
        html.dark .border-indigo-500 { border-color: #818cf8; }
        html.dark label, html.dark .text-gray-700 { color: #d1d5db; }
        html.dark .text-gray-500 { color: #9ca3af; }
        html.dark .text-gray-800 { color: #f9fafb; }
        html.dark input, html.dark select { background-color: #374151; border-color: #4b5563; color: #f9fafb; }
        html.dark input::placeholder { color: #9ca3af; }
        html.dark .tab-content, html.dark .p-4.border { border-color: #4b5563; }
        html.dark .match-item.no-result { background-color: #5c2b2b; }
        html.dark .match-item.has-result { background-color: #2a553a; }
        html.dark .match-item:hover { background-color: #374151; }
        html.dark .match-item.selected { background-color: #3730a3; border-color: #a5b4fc; }
        html.dark .match-item p { color: #e5e7eb; }
        html.dark .match-item .text-gray-500 { color: #9ca3af; }
        html.dark #players-list-admin table { background-color: #1f2937; }
        html.dark #players-list-admin thead tr { background-color: #374151; color: #e5e7eb; }
        html.dark #players-list-admin tbody tr { border-color: #4b5563; }
        html.dark #players-list-admin tbody tr:hover { background-color: #374151; }
        html.dark #players-list-admin tbody td { color: #d1d5db; }
        html.dark #titulares-players, html.dark #suplentes-players { background-color: #374151; border-color: #4b5563; }
        html.dark #chamigo-match-list, html.dark #tt-match-list, html.dark #results-match-list { background-color: #1f2937; border-color: #4b5563; }
        html.dark #custom-confirm-modal .bg-white { background-color: #1f2937; }

        /* Estilos que NO cambian con el modo oscuro */
        .player-draggable { background-color: #ffffff; padding: 0.25rem 0.5rem; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); margin-bottom: 0.25rem; cursor: grab; display: inline-block !important; width: auto !important; height: auto !important; flex: none !important; white-space: nowrap !important; color: #000000 !important; }
        .player-draggable:active { cursor: grabbing; }
        #team-oscuros .player-draggable { background-color: #000000 !important; color: #ffffff !important; }
        #team-claros { background-color: #ffffff !important; }
        #team-oscuros { background-color: #1a202c !important; }
        
        /* --- Resto de los estilos --- */
        .player-draggable.dragging-touch { opacity: 0.7; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        #side-menu { position: fixed; top: 0; left: 0; height: 100%; width: 256px; background-color: #312e81; color: white; transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 40; display: flex; flex-direction: column; }
        #side-menu.open { transform: translateX(0); }
        #overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 30; display: none; }
        #overlay.open { display: block; }
        #hamburger-button { position: fixed; top: 1rem; left: 1rem; z-index: 50; padding: 0.5rem; border-radius: 0.375rem; background-color: #4f46e5; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        #side-menu .tab-button, #side-menu .sidebar-link { padding-left: 1.5rem; padding-right: 1.5rem; text-align: left; width: 100%; border-radius: 0; margin-bottom: 0.25rem; color: white; transition: background-color 0.15s ease-in-out; display: flex; align-items: center; gap: 0.75rem; white-space: nowrap; padding-top: 0.75rem; padding-bottom: 0.75rem; }
        #side-menu .tab-button.active { background-color: #4338ca; }
        #side-menu .tab-button:hover, #side-menu .sidebar-link:hover { background-color: #4f46e5; }
        .menu-title-container { padding: 0.5rem 1.5rem; display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.25rem; flex-shrink: 0; }
        .menu-title { font-size: 1.25rem; font-weight: bold; color: white; display: flex; align-items: center; gap: 0.5rem; }
        #dark-mode-toggle { background-color: #4338ca; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: background-color 0.15s ease-in-out; }
        #dark-mode-toggle:hover { background-color: #4f46e5; }
        #sidebar-button-container { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .sidebar-footer { flex-shrink: 0; padding: 1rem; }
        .sidebar-footer #signout_button { width: 100%; }

        @media (min-width: 768px) {
            body { flex-direction: row; align-items: flex-start; }
            #side-menu { position: relative; transform: translateX(0); flex-shrink: 0; height: 100vh; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
            #overlay, #hamburger-button { display: none !important; }
            .main-admin-content-container { flex-grow: 1; margin: 2rem; padding: 2rem; width: auto; }
            #login-screen { max-width: 400px; margin: 8rem auto; }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login (inicialmente visible) -->
    <div id="login-screen" class="p-8 rounded-xl shadow-lg w-full max-w-md mx-auto my-auto">
        <h1 class="text-3xl font-extrabold text-center text-indigo-800 mb-8">Acceso Administrador</h1>
        <form id="login-form">
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium mb-1">Usuario</label>
                <input type="text" id="username" name="username" autocomplete="username" required class="w-full p-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium mb-1">Contraseña</label>
                <input type="password" id="password" name="password" autocomplete="current-password" required class="w-full p-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                Ingresar
            </button>
            <p id="login-error" class="text-red-500 text-center mt-4 hidden"></p>
        </form>
    </div>

    <!-- Contenido Principal y Menú (inicialmente ocultos) -->
    <div id="app-container" class="hidden w-full h-full md:flex">
        <nav id="side-menu">
            <div class="menu-title-container">
                <h2 class="menu-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                    MENÚ
                </h2>
                <button id="dark-mode-toggle">
                    <i class="fas fa-moon" id="dark-mode-icon"></i>
                </button>
            </div>
            
            <div id="sidebar-button-container">
                <button class="tab-button" data-tab="team-formation">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-4.5-7.5l-2.25 2.25m0 0l-2.25 2.25M18 15l-2.25 2.25m0 0l-2.25 2.25M15.75 12a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" /></svg>
                    Armar Equipos
                </button>
                <button class="tab-button" data-tab="match-results">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25H2.25A2.25 2.25 0 0 1 0 19.5V12A2.25 2.25 0 0 1 2.25 9.75h19.5A2.25 2.25 0 0 1 24 12v7.5a2.25 2.25 0 0 1-2.25 2.25H16.5" /></svg>
                    Resultados
                </button>
                <button class="tab-button" data-tab="chamigo-management">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .472.334l5.64.423a.563.563 0 0 1 .314.976l-4.067 3.323a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.563.563 0 0 0-.582 0l-4.725 2.885a.562.562 0 0 1-.84-.61l1.285-5.385a.563.563 0 0 0-.182-.557L3.92 9.345a.563.563 0 0 1 .313-.976l5.64-.423a.563.563 0 0 0 .472-.334L11.48 3.5Z" /></svg>
                    Chamigo
                </button>
                <button class="tab-button" data-tab="tt-attendance">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-beer"><path d="M18 19V2h-1M6 19V2h1M2 19h20v3H2zM12 19V2a4 4 0 0 0-4 4v13" /></svg>
                    TT
                </button>
                <button class="tab-button" data-tab="players-management">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                    ABM Jugadores
                </button>
                <a href="index.html" target="_blank" rel="noopener noreferrer" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-line-chart"><path d="M3 3v18h18" /><path d="m18 21-8-8-4 4-3-3" /><path d="m18 14 4-4H18V6" /></svg>
                    Estadísticas
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-auto"><path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 18h-8.5A2.25 2.25 0 012 15.25v-8.5C2 4.75 3.25 3.5 4.75 3.5h4a.75.75 0 010 1.5h-4z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M15.75 3a.75.75 0 01.75.75V9a.75.75 0 01-1.5 0V5.06L10.22 10.53a.75.75 0 01-1.06-1.06l5.47-5.47H12a.75.75 0 010-1.5h3.75z" clip-rule="evenodd" /></svg>
                </a>
            </div>
            
            <div class="sidebar-footer">
                 <button id="signout_button" class="w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                    Cerrar Sesión
                </button>
            </div>
        </nav>

        <main class="main-admin-content-container p-4 md:p-8 rounded-xl shadow-lg w-full max-w-5xl relative mx-auto my-4 md:my-8">
            <h1 class="text-3xl md:text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500">Panel de Administración</h1>
            <div id="admin-content">
                <!-- Contenido de las pestañas se insertará aquí -->
            </div>
        </main>
    </div>

    <!-- Overlay y Modales -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
    <div id="custom-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-semibold mb-4" id="modal-title">Confirmar Acción</h3>
            <p class="mb-6" id="modal-message">¿Estás seguro de que quieres realizar esta acción?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Cancelar</button>
                <button id="modal-confirm-button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Confirmar</button>
            </div>
        </div>
    </div>


    <script>
        // ¡¡¡IMPORTANTE!!!
        // 1. Reemplaza 'TU_API_KEY_DE_GOOGLE_SHEETS' con tu Clave de API de Google Cloud.
        //    - Ve a https://console.cloud.google.com/apis/credentials
        //    - Crea o selecciona un proyecto.
        //    - Haz clic en "+ CREAR CREDENCIALES" -> "Clave de API".
        //    - Habilita la API de Google Sheets para tu proyecto.
        // 2. Asegúrate de que tu Google Sheet esté compartida como "Cualquier persona con el enlace puede ver".
        const API_KEY = 'AIzaSyDNLwReGrX5FKBwjjKsMS9cz-hZNMIvAlM';
        const SPREADSHEET_ID = '1bpNKl-UVHzbqsow4zOHE7-y5Cunm2xtpgyIodEQBi2E';

        let gapiInited = false;
        let allPlayersData = [];
        let allMatchesData = [];
        let allAdminsData = [];
        
        // --- Elementos del DOM ---
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const signoutButton = document.getElementById('signout_button');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const darkModeIcon = document.getElementById('dark-mode-icon');
        const htmlElement = document.documentElement;
        const adminContentContainer = document.getElementById('admin-content');
        const hamburgerButton = document.getElementById('hamburger-button');
        const sideMenu = document.getElementById('side-menu');
        const overlay = document.getElementById('overlay');
        
        // --- Lógica de Autenticación y Sesión ---
        
        function checkSession() {
            const loggedInUser = sessionStorage.getItem('adminUser');
            if (loggedInUser) {
                showApp();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            loginScreen.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        async function showApp() {
            loginScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            
            if (allPlayersData.length === 0) {
                await loadAllDataAndDisplayAllContent();
            }
            setupTabNavigation();
            if (!document.querySelector('.tab-button.active')) {
                const defaultTabButton = document.querySelector('.tab-button[data-tab="team-formation"]');
                if (defaultTabButton) {
                    defaultTabButton.click();
                }
            }
        }


        async function handleLogin(event) {
            event.preventDefault();
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            loginError.classList.add('hidden');

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Admins!A:D',
                });
                allAdminsData = response.result.values ? response.result.values.slice(1) : [];
                
                const admin = allAdminsData.find(row => row[1] === username && row[2] === password);

                if (admin) {
                    const adminUser = {
                        id: admin[0],
                        username: admin[1],
                        role: admin[3]
                    };
                    sessionStorage.setItem('adminUser', JSON.stringify(adminUser));
                    showApp();
                } else {
                    loginError.textContent = 'Usuario o contraseña incorrectos.';
                    loginError.classList.remove('hidden');
                }
            } catch (err) {
                console.error('Error durante el inicio de sesión:', err);
                loginError.textContent = 'Error al conectar. Verifica la API Key y que la hoja sea pública.';
                loginError.classList.remove('hidden');
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('adminUser');
            window.location.reload();
        }

        // --- Funciones de Modo Oscuro ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                darkModeIcon.classList.remove('fa-moon');
                darkModeIcon.classList.add('fa-sun');
            } else {
                htmlElement.classList.remove('dark');
                darkModeIcon.classList.remove('fa-sun');
                darkModeIcon.classList.add('fa-moon');
            }
            localStorage.setItem('theme', theme);
        }

        function toggleTheme() {
            const currentTheme = htmlElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(currentTheme);
        }

        // --- Funciones de Carga de Datos ---
        async function loadAllData() {
            try {
                const playersResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Jugadores!A:D',
                });
                allPlayersData = playersResponse.result.values ? playersResponse.result.values.slice(1) : [];

                const matchesResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Partidos!A:G',
                });
                allMatchesData = matchesResponse.result.values ? matchesResponse.result.values.slice(1) : [];

            } catch (err) {
                console.error('Error al cargar datos:', err);
                alert(`Error al cargar datos: ${err.result?.error?.message || err.message}`);
            }
        }

        async function loadAllDataAndDisplayAllContent() {
            await loadAllData();
            // Las funciones de renderizado se llaman al cambiar de pestaña
        }
        
        // --- Inicialización de Google API ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                gapiInited = true;
                checkSession(); 
            } catch (err) {
                console.error("Error al inicializar gapi.client:", err);
                loginError.textContent = 'No se pudo conectar con Google Sheets. Verifica la API Key.';
                loginError.classList.remove('hidden');
            }
        }
        
        // --- Lógica de Pestañas y Contenido Dinámico ---
        
        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', handleTabButtonClick);
            });
        }

        async function handleTabButtonClick(event) {
            const clickedButton = event.currentTarget;
            const tabId = clickedButton.dataset.tab;
            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');

            await loadTabContent(tabId);

            if (window.innerWidth < 768) {
                toggleSideMenu();
            }
        }

        async function loadTabContent(tabId) {
            const contentMap = {
                'team-formation': getTeamFormationHTML(),
                'players-management': getPlayersManagementHTML(),
                'match-results': getMatchResultsHTML(),
                'chamigo-management': getChamigoManagementHTML(),
                'tt-attendance': getTtAttendanceHTML()
            };
            
            adminContentContainer.innerHTML = contentMap[tabId] || '<div>Contenido no encontrado</div>';
            
            if (tabId === 'team-formation') initTeamFormation();
            else if (tabId === 'players-management') initPlayersManagement();
            else if (tabId === 'match-results') initMatchResults();
            else if (tabId === 'chamigo-management') initChamigoManagement();
            else if (tabId === 'tt-attendance') initTtAttendance();
        }

        // --- Funciones para obtener el HTML de cada pestaña ---
        function getTeamFormationHTML() {
            return `<div id="team-formation" class="tab-content">...</div>`.replace('...', `
                    <h2 class="text-2xl font-semibold mb-4">Armar Equipos</h2>
                    <div class="mb-4">
                        <label for="team-match-date" class="block text-sm font-medium">Fecha del Partido:</label>
                        <input type="date" id="team-match-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    </div>
                    <p class="text-gray-500 mb-4">Selecciona 10 jugadores para formar los equipos Claros y Oscuros.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-medium mb-3">Jugadores Disponibles</h3>
                            <div id="titulares-players" class="border border-gray-300 rounded-lg p-4 bg-gray-50 flex flex-wrap gap-1 min-h-[120px]"></div>
                            <h4 class="font-semibold mb-2 mt-4">Suplentes</h4>
                            <div id="suplentes-players" class="border border-gray-300 rounded-lg p-4 bg-gray-50 flex flex-wrap gap-1 min-h-[120px]"></div>
                        </div>
                        <div>
                            <h3 class="text-xl font-medium mb-3">Jugadores Seleccionados (<span id="total-selected-players">0</span>/10)</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <h4 class="font-semibold mb-2">Claros (<span id="claros-count">0</span>)</h4>
                                    <div id="team-claros" class="border border-gray-300 rounded-lg p-3 flex flex-wrap content-start gap-1 min-h-[120px]"></div>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-2">Oscuros (<span id="oscuros-count">0</span>)</h4>
                                    <div id="team-oscuros" class="border border-gray-300 rounded-lg p-3 flex flex-wrap content-start gap-1 min-h-[120px]"></div>
                                </div>
                            </div>
                            <button id="save-teams-button" class="mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 w-full" disabled>Guardar Equipos</button>
                        </div>
                    </div>`);
        }
        
        function getPlayersManagementHTML() {
            return `<div id="players-management" class="tab-content">...</div>`.replace('...', `
                    <h2 class="text-2xl font-semibold mb-4">Gestionar Jugadores</h2>
                    <div class="mb-6 p-4 border rounded-lg shadow-sm">
                        <h3 class="text-xl font-medium mb-3">Añadir/Modificar Jugador</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="player-id" class="block text-sm font-medium">ID Jugador (para modificar):</label>
                                <input type="text" id="player-id" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2" placeholder="Dejar vacío para nuevo">
                            </div>
                            <div>
                                <label for="player-name" class="block text-sm font-medium">Nombre:</label>
                                <input type="text" id="player-name" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="player-status" class="block text-sm font-medium">Estado:</label>
                                <select id="player-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                </select>
                            </div>
                            <div>
                                <label for="player-role" class="block text-sm font-medium">Rol:</label>
                                <select id="player-role" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                    <option value="Titular">Titular</option>
                                    <option value="Suplente">Suplente</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 flex space-x-3">
                            <button id="save-player-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300">Guardar Jugador</button>
                            <button id="delete-player-button" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">Eliminar Jugador</button>
                        </div>
                    </div>
                    <h3 class="text-xl font-medium mb-3">Listado de Jugadores</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                         <div>
                            <label for="player-list-name-filter" class="block text-sm font-medium">Buscar por Nombre:</label>
                            <input type="text" id="player-list-name-filter" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2" placeholder="Ej: Mati">
                        </div>
                        <div>
                            <label for="player-list-status-filter" class="block text-sm font-medium">Filtrar por Estado:</label>
                            <select id="player-list-status-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                <option value="Todos">Todos</option>
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                            </select>
                        </div>
                        <div>
                            <label for="player-list-role-filter" class="block text-sm font-medium">Filtrar por Rol:</label>
                            <select id="player-list-role-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                <option value="Todos">Todos</option>
                                <option value="Titular">Titular</option>
                                <option value="Suplente">Suplente</option>
                            </select>
                        </div>
                    </div>
                    <div id="players-list-admin" class="overflow-x-auto">
                        <p id="players-loading-message-admin" class="text-center">Cargando jugadores...</p>
                        <table class="min-w-full rounded-lg shadow hidden">
                            <thead>
                                <tr class="uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">ID</th>
                                    <th class="py-3 px-6 text-left">Nombre</th>
                                    <th class="py-3 px-6 text-left">Estado</th>
                                    <th class="py-3 px-6 text-left">Rol</th>
                                    <th class="py-3 px-6 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm font-light"></tbody>
                        </table>
                    </div>`);
        }

        function getMatchResultsHTML() {
            return `<div id="match-results" class="tab-content">...</div>`.replace('...', `
                        <h2 class="text-2xl font-semibold mb-4">Resultados</h2>
                        <div class="mb-6 p-4 border rounded-lg shadow-sm">
                            <h3 class="text-xl font-medium mb-3">Partido Seleccionado</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="match-date" class="block text-sm font-medium">Fecha del Partido:</label>
                                    <input type="date" id="match-date" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2" readonly>
                                </div>
                                <div>
                                    <label for="match-result" class="block text-sm font-medium">Resultado:</label>
                                    <select id="match-result" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                        <option value="">Seleccionar resultado</option>
                                        <option value="Claros">Claros</option>
                                        <option value="Oscuros">Oscuros</option>
                                        <option value="Empate">Empate</option>
                                        <option value="Suspendido">Suspendido</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex space-x-3 mt-6">
                                <button id="register-match-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex-1">Registrar Resultado</button>
                                <button id="delete-match-button" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 flex-1">Eliminar Partido</button>
                            </div>
                            <h3 class="text-xl font-medium mb-3 mt-6">Seleccionar Partido</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="results-match-year-select" class="block text-sm font-medium">Año:</label>
                                    <select id="results-match-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm"></select>
                                </div>
                                <div>
                                    <label for="results-match-month-select" class="block text-sm font-medium">Mes:</label>
                                    <select id="results-match-month-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                        <option value="all">Todos</option>
                                        <option value="0">Enero</option>
                                        <option value="1">Febrero</option>
                                        <option value="2">Marzo</option>
                                        <option value="3">Abril</option>
                                        <option value="4">Mayo</option>
                                        <option value="5">Junio</option>
                                        <option value="6">Julio</option>
                                        <option value="7">Agosto</option>
                                        <option value="8">Septiembre</option>
                                        <option value="9">Octubre</option>
                                        <option value="10">Noviembre</option>
                                        <option value="11">Diciembre</option>
                                    </select>
                                </div>
                            </div>
                            <label class="block text-sm font-medium mt-4">Partidos Disponibles:</label>
                            <div id="results-match-list" class="mt-1 border rounded-md shadow-sm max-h-80 overflow-y-auto p-2 grid grid-cols-1 md:grid-cols-2 gap-2"></div>
                        </div>`);
        }

        function getChamigoManagementHTML() {
            return `<div id="chamigo-management" class="tab-content">...</div>`.replace('...', `
                        <h2 class="text-2xl font-semibold mb-4">Chamigo</h2>
                        <div class="mb-6 p-4 border rounded-lg shadow-sm">
                            <h3 class="text-xl font-medium mb-3">Registrar Votos de Chamigo</h3>
                            <div id="chamigo-voting-players" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4"></div>
                            <button id="register-chamigo-button" class="px-6 py-3 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-300 w-full">Registrar Chamigo(s)</button>
                        </div>
                        <h3 class="text-xl font-medium mb-3 mt-6">Seleccionar Partido</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="chamigo-match-year-select" class="block text-sm font-medium">Año:</label>
                                <select id="chamigo-match-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="chamigo-match-month-select" class="block text-sm font-medium">Mes:</label>
                                <select id="chamigo-match-month-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                    <option value="all">Todos</option>
                                    <option value="0">Enero</option>
                                    <option value="1">Febrero</option>
                                    <option value="2">Marzo</option>
                                    <option value="3">Abril</option>
                                    <option value="4">Mayo</option>
                                    <option value="5">Junio</option>
                                    <option value="6">Julio</option>
                                    <option value="7">Agosto</option>
                                    <option value="8">Septiembre</option>
                                    <option value="9">Octubre</option>
                                    <option value="10">Noviembre</option>
                                    <option value="11">Diciembre</option>
                                </select>
                            </div>
                        </div>
                        <label class="block text-sm font-medium mt-4">Partidos Disponibles:</label>
                        <div id="chamigo-match-list" class="mt-1 border rounded-md shadow-sm max-h-80 overflow-y-auto p-2 grid grid-cols-1 md:grid-cols-2 gap-2"></div>`);
        }
        
        function getTtAttendanceHTML() {
            return `<div id="tt-attendance" class="tab-content">...</div>`.replace('...', `
                        <h2 class="text-2xl font-semibold mb-4">TT</h2>
                        <div class="p-4 border rounded-lg shadow-sm">
                            <h3 class="text-xl font-medium mb-3">Registrar Asistencia TT</h3>
                            <div id="tt-attendance-players" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4"></div>
                            <button id="register-tt-button" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 w-full">Registrar Asistencia TT</button>
                        </div>
                        <h3 class="text-xl font-medium mb-3 mt-6">Seleccionar Partido</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="tt-match-year-select" class="block text-sm font-medium">Año:</label>
                                <select id="tt-match-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="tt-match-month-select" class="block text-sm font-medium">Mes:</label>
                                <select id="tt-match-month-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                   <option value="all">Todos</option>
                                    <option value="0">Enero</option>
                                    <option value="1">Febrero</option>
                                    <option value="2">Marzo</option>
                                    <option value="3">Abril</option>
                                    <option value="4">Mayo</option>
                                    <option value="5">Junio</option>
                                    <option value="6">Julio</option>
                                    <option value="7">Agosto</option>
                                    <option value="8">Septiembre</option>
                                    <option value="9">Octubre</option>
                                    <option value="10">Noviembre</option>
                                    <option value="11">Diciembre</option>
                                </select>
                            </div>
                        </div>
                        <label class="block text-sm font-medium mt-4">Partidos Disponibles:</label>
                        <div id="tt-match-list" class="mt-1 border rounded-md shadow-sm max-h-80 overflow-y-auto p-2 grid grid-cols-1 md:grid-cols-2 gap-2"></div>`);
        }

        // --- Lógica de la aplicación (resto de funciones) ---
        
        function setInitialFilters() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-indexed (0 for January)

            const selectsToUpdate = [
                { year: 'results-match-year-select', month: 'results-match-month-select' },
                { year: 'chamigo-match-year-select', month: 'chamigo-match-month-select' },
                { year: 'tt-match-year-select', month: 'tt-match-month-select' }
            ];

            selectsToUpdate.forEach(pair => {
                const yearSelect = document.getElementById(pair.year);
                const monthSelect = document.getElementById(pair.month);

                if (Array.from(yearSelect.options).some(opt => opt.value == currentYear)) {
                    yearSelect.value = currentYear;
                }
                
                monthSelect.value = currentMonth;

                yearSelect.dispatchEvent(new Event('change'));
                monthSelect.dispatchEvent(new Event('change'));
            });
        }
        
        function toggleSideMenu() {
            if (window.innerWidth < 768) {
                const isOpen = sideMenu.classList.toggle('open');
                overlay.classList.toggle('open', isOpen);
                document.body.classList.toggle('overflow-hidden', isOpen);
                if (isOpen) {
                    sideMenu.classList.remove('hidden');
                } else {
                    setTimeout(() => sideMenu.classList.add('hidden'), 300);
                }
            }
        }
        
        function populateResultsMatchYearSelect() {
            const resultsMatchYearSelect = document.getElementById('results-match-year-select');
            const years = [...new Set(allMatchesData.map(m => parseDate(m[1]).getFullYear()))].sort((a,b) => b-a);
            resultsMatchYearSelect.innerHTML = '';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                resultsMatchYearSelect.appendChild(option);
            });
        }

        function populateMatchSelects() {
            const resultsMatchYearSelect = document.getElementById('results-match-year-select');
            const resultsMatchMonthSelect = document.getElementById('results-match-month-select');
            const resultsMatchListDiv = document.getElementById('results-match-list');
            const selectedYear = resultsMatchYearSelect.value;
            const selectedMonth = resultsMatchMonthSelect.value;
            resultsMatchListDiv.innerHTML = '';

            const filteredMatches = allMatchesData.filter(match => {
                const matchDate = parseDate(match[1]);
                const yearMatch = selectedYear ? matchDate.getFullYear() == selectedYear : true;
                const monthMatch = selectedMonth !== 'all' ? matchDate.getMonth() == selectedMonth : true;
                return yearMatch && monthMatch;
            }).sort((a,b) => parseDate(b[1]) - parseDate(a[1]));

            if (filteredMatches.length === 0) {
                resultsMatchListDiv.innerHTML = '<p class="text-gray-500">No hay partidos para los filtros seleccionados.</p>';
                return;
            }

            filteredMatches.forEach(match => {
                const [id, fecha, clarosIDs, oscurosIDs, resultado] = match;
                const matchItem = document.createElement('div');
                matchItem.className = `match-item ${resultado ? 'has-result' : 'no-result'}`;
                matchItem.dataset.matchId = id;
                matchItem.innerHTML = `<p class="font-semibold">${fecha}</p><p class="text-xs text-gray-500">Resultado: ${resultado || 'Pendiente'}</p>`;
                resultsMatchListDiv.appendChild(matchItem);
                matchItem.addEventListener('click', () => {
                    document.querySelectorAll('#results-match-list .match-item').forEach(item => item.classList.remove('selected'));
                    matchItem.classList.add('selected');
                    const [day, month, year] = fecha.split('/');
                    document.getElementById('match-date').value = `${year}-${month}-${day}`;
                    document.getElementById('match-result').value = resultado || '';
                });
            });
        }

        async function registerMatchResult() {
            const selectedMatchItem = document.querySelector('#results-match-list .match-item.selected');
            if (!selectedMatchItem) {
                alert('Por favor, selecciona un partido.');
                return;
            }
            const selectedMatchId = selectedMatchItem.dataset.matchId;
            const result = document.getElementById('match-result').value;
            
            try {
                const matchIndex = allMatchesData.findIndex(m => m[0] === selectedMatchId);
                if (matchIndex === -1) throw new Error('Partido no encontrado');
                
                allMatchesData[matchIndex][4] = result;
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `Partidos!E${matchIndex + 2}`,
                    valueInputOption: 'RAW',
                    resource: { values: [[result]] },
                });

                alert('Resultado actualizado.');
                await loadAllData();
                populateMatchSelects();
                document.getElementById('match-date').value = '';
                document.getElementById('match-result').value = '';
            } catch (err) {
                console.error('Error al registrar resultado:', err);
                alert(`Error al registrar resultado: ${err.result?.error?.message || err.message}.`);
            }
        }

        async function deleteMatch() {
            const selectedMatchItem = document.querySelector('#results-match-list .match-item.selected');
            if (!selectedMatchItem) {
                alert('Por favor, selecciona un partido para eliminar.');
                return;
            }
            const selectedMatchId = selectedMatchItem.dataset.matchId;
            const confirmed = await showCustomConfirm('Confirmar Eliminación', `¿Seguro que quieres eliminar el partido ID ${selectedMatchId}? Esta acción es irreversible.`);
            if (!confirmed) return;

            try {
                const matchIndex = allMatchesData.findIndex(m => m[0] === selectedMatchId);
                if (matchIndex === -1) throw new Error('Partido no encontrado');
                
                const sheetRowIndex = matchIndex + 2;
                const sheetId = sheetIds['Partidos'];
                if (sheetId === undefined) throw new Error("No se pudo encontrar el ID de la hoja 'Partidos'.");
                
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            deleteDimension: {
                                range: {
                                    sheetId: sheetId,
                                    dimension: 'ROWS',
                                    startIndex: sheetRowIndex - 1,
                                    endIndex: sheetRowIndex
                                }
                            }
                        }]
                    }
                });

                alert('Partido eliminado exitosamente.');
                await loadAllData();
                populateMatchSelects();
                document.getElementById('match-date').value = '';
                document.getElementById('match-result').value = '';
            } catch (err) {
                console.error('Error al eliminar partido:', err);
                alert(`Error al eliminar partido: ${err.result?.error?.message || err.message}.`);
            }
        }
        
        function populateChamigoTtMatchYearSelect(selectId) {
            const select = document.getElementById(selectId);
            const years = [...new Set(allMatchesData.map(m => parseDate(m[1]).getFullYear()))].sort((a,b) => b-a);
            select.innerHTML = '';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            });
        }
        
        function populateChamigoTtMatchLists() {
            populateMatchListForTab('chamigo-match-list', 'chamigo-match-year-select', 'chamigo-match-month-select', handleChamigoMatchSelection, 'chamigo');
            populateMatchListForTab('tt-match-list', 'tt-match-year-select', 'tt-match-month-select', handleTtMatchSelection, 'tt');
        }

        function populateMatchListForTab(targetListDivId, yearSelectId, monthSelectId, onMatchClickCallback, tabName) {
            const targetListDiv = document.getElementById(targetListDivId);
            const yearSelect = document.getElementById(yearSelectId);
            const monthSelect = document.getElementById(monthSelectId);
            const selectedYear = yearSelect.value;
            const selectedMonth = monthSelect.value;
            targetListDiv.innerHTML = '';

            const filteredMatches = allMatchesData.filter(match => {
                const matchDate = parseDate(match[1]);
                const yearMatch = selectedYear ? matchDate.getFullYear() == selectedYear : true;
                const monthMatch = selectedMonth !== 'all' ? matchDate.getMonth() == selectedMonth : true;
                return yearMatch && monthMatch;
            }).sort((a,b) => parseDate(b[1]) - parseDate(a[1]));

            if (filteredMatches.length === 0) {
                targetListDiv.innerHTML = '<p class="text-gray-500">No hay partidos para los filtros seleccionados.</p>';
                return;
            }

            filteredMatches.forEach(match => {
                const [id, fecha, , , , chamigoVotos, ttAttendees] = match;
                const matchItem = document.createElement('div');
                let isComplete = false;
                if (tabName === 'chamigo') isComplete = chamigoVotos && chamigoVotos.trim() !== '';
                if (tabName === 'tt') isComplete = ttAttendees && ttAttendees.trim() !== '';
                matchItem.className = `match-item ${isComplete ? 'has-result' : 'no-result'}`;
                matchItem.dataset.matchId = id;
                matchItem.innerHTML = `<p class="font-semibold">${fecha}</p>`;
                targetListDiv.appendChild(matchItem);
                matchItem.addEventListener('click', () => {
                     document.querySelectorAll(`#${targetListDivId} .match-item`).forEach(item => item.classList.remove('selected'));
                     matchItem.classList.add('selected');
                     onMatchClickCallback(id);
                });
            });
        }
        
        function handleChamigoMatchSelection(selectedMatchId) {
            const chamigoVotingPlayersDiv = document.getElementById('chamigo-voting-players');
            chamigoVotingPlayersDiv.innerHTML = '';
            const match = allMatchesData.find(m => m[0] === selectedMatchId);
            if (!match) return;

            const playerIDs = [...new Set([...(match[2]||'').split(','), ...(match[3]||'').split(',')])].filter(Boolean);
            const existingVotes = match[5] ? JSON.parse(match[5]) : [];

            playerIDs.forEach(id => {
                const player = allPlayersData.find(p => p[0] === id);
                if (!player) return;
                const vote = existingVotes.find(v => v.id === id);
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center space-x-2';
                playerDiv.innerHTML = `
                    <label class="block text-sm font-medium w-24 truncate" title="${player[1]}">${player[1]}:</label>
                    <input type="number" data-id="${id}" class="chamigo-vote-input mt-1 block w-20 rounded-md shadow-sm sm:text-sm p-2" value="${vote ? vote.votos : 0}" min="0">
                `;
                chamigoVotingPlayersDiv.appendChild(playerDiv);
            });
        }
        
        async function registerChamigo() {
            const selectedMatchItem = document.querySelector('#chamigo-match-list .match-item.selected');
            if (!selectedMatchItem) {
                alert('Por favor, selecciona un partido.');
                return;
            }
            const selectedMatchId = selectedMatchItem.dataset.matchId;
            const matchIndex = allMatchesData.findIndex(m => m[0] === selectedMatchId);
            if (matchIndex === -1) return;

            const votes = Array.from(document.querySelectorAll('.chamigo-vote-input'))
                .map(input => ({ id: input.dataset.id, votos: parseInt(input.value) || 0 }))
                .filter(v => v.votos > 0);
            
            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `Partidos!F${matchIndex + 2}`,
                    valueInputOption: 'RAW',
                    resource: { values: [[JSON.stringify(votes)]] },
                });
                alert('Votos de Chamigo guardados.');
                await loadAllData();
                populateMatchListForTab('chamigo-match-list', 'chamigo-match-year-select', 'chamigo-match-month-select', handleChamigoMatchSelection, 'chamigo');
                document.getElementById('chamigo-voting-players').innerHTML = '<p class="text-gray-500">Selecciona un partido...</p>';
            } catch(err) {
                console.error("Error al guardar Chamigo:", err);
                alert(`Error: ${err.result?.error?.message || err.message}`);
            }
        }
        
        function handleTtMatchSelection(selectedMatchId) {
            const ttAttendancePlayersDiv = document.getElementById('tt-attendance-players');
            ttAttendancePlayersDiv.innerHTML = '';
            const match = allMatchesData.find(m => m[0] === selectedMatchId);
            if (!match) return;
            
            const activePlayers = allPlayersData.filter(p => p[2] === 'Activo');
            const existingAttendees = (match[6] || '').split(',');

            activePlayers.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center space-x-2';
                playerDiv.innerHTML = `
                    <input type="checkbox" id="tt-player-${player[0]}" data-id="${player[0]}" class="tt-checkbox h-4 w-4 rounded" ${existingAttendees.includes(player[0]) ? 'checked' : ''}>
                    <label for="tt-player-${player[0]}" class="text-sm font-medium">${player[1]}</label>
                `;
                ttAttendancePlayersDiv.appendChild(playerDiv);
            });
        }
        
        async function registerTt() {
            const selectedMatchItem = document.querySelector('#tt-match-list .match-item.selected');
            if (!selectedMatchItem) {
                alert('Por favor, selecciona un partido.');
                return;
            }
            const selectedMatchId = selectedMatchItem.dataset.matchId;
            const matchIndex = allMatchesData.findIndex(m => m[0] === selectedMatchId);
            if (matchIndex === -1) return;

            const attendees = Array.from(document.querySelectorAll('.tt-checkbox:checked')).map(cb => cb.dataset.id);

            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `Partidos!G${matchIndex + 2}`,
                    valueInputOption: 'RAW',
                    resource: { values: [[attendees.join(',')]] },
                });
                alert('Asistencia a TT guardada.');
                await loadAllData();
                populateMatchListForTab('tt-match-list', 'tt-match-year-select', 'tt-match-month-select', handleTtMatchSelection, 'tt');
                document.getElementById('tt-attendance-players').innerHTML = '<p class="text-gray-500">Selecciona un partido...</p>';
            } catch(err) {
                console.error("Error al guardar TT:", err);
                alert(`Error: ${err.result?.error?.message || err.message}`);
            }
        }

        function parseDate(dateString) {
            const [day, month, year] = dateString.split('/').map(Number);
            return new Date(year, month - 1, day);
        }

        function parseYYYYMMDDToLocalDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function formatDateToDDMMYYYY(date) {
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const yyyy = date.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }
        
        // --- Inicialización General (Final) ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);

            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.async = true;
            script.defer = true;
            script.onload = gapiLoaded;
            document.head.appendChild(script);

            loginForm.addEventListener('submit', handleLogin);
            signoutButton.addEventListener('click', handleLogout);
            darkModeToggle.addEventListener('click', toggleTheme);
            hamburgerButton.addEventListener('click', toggleSideMenu);
            overlay.addEventListener('click', toggleSideMenu);
        });

        window.addEventListener('resize', () => {
             if (appContainer.style.display !== 'none') {
                updateUIForAuth();
             }
        });

    </script>
</body>
</html>
