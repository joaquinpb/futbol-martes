<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración Fútbol 5</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter para una mejor legibilidad */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Un gris claro para el fondo */
        }
        .tab-button.active {
            @apply bg-indigo-700 text-white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Estilos para el efecto de arrastre */
        .player-draggable:hover {
            cursor: grab; /* Cambia el cursor a una mano al pasar el ratón */
        }
        .player-draggable:active {
            cursor: grabbing; /* Cambia el cursor a una mano agarrando al hacer clic */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-5xl">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">Panel de Administración</h1>

        <!-- Botones de Autenticación -->
        <div class="flex justify-center space-x-4 mb-8">
            <button id="authorize_button" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                Autorizar Google Sheets
            </button>
            <button id="signout_button" class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-300 hidden">
                Cerrar Sesión
            </button>
        </div>

        <!-- Mensaje de estado de autenticación -->
        <p id="auth-status" class="text-center text-red-500 mb-6">Por favor, autoriza la aplicación para acceder a los datos.</p>

        <!-- Contenido del Panel de Administración (oculto hasta la autenticación) -->
        <div id="admin-content" class="hidden">
            <!-- Navegación por pestañas -->
            <div class="flex border-b border-gray-200 mb-6">
                <button class="tab-button py-2 px-4 text-gray-600 font-medium hover:text-indigo-700 active" data-tab="players-management">Gestión de Jugadores</button>
                <button class="tab-button py-2 px-4 text-gray-600 font-medium hover:text-indigo-700" data-tab="team-formation">Armar Equipos</button>
                <button class="tab-button py-2 px-4 text-gray-600 font-medium hover:text-indigo-700" data-tab="match-results">Resultados</button>
                <button class="tab-button py-2 px-4 text-gray-600 font-medium hover:text-indigo-700" data-tab="chamigo-management">Chamigo</button>
                <button class="tab-button py-2 px-4 text-gray-600 font-medium hover:text-indigo-700" data-tab="tt-attendance">TT</button>
                <button class="tab-button py-2 px-4 text-gray-600 font-medium hover:text-indigo-700" data-tab="leaderboard-tab">Tabla de Posiciones</button>
            </div>

            <!-- Contenido de las pestañas -->
            <div id="players-management" class="tab-content active">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gestión de Jugadores</h2>
                <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-800 mb-3">Añadir/Modificar Jugador</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="player-id" class="block text-sm font-medium text-gray-700">ID Jugador (para modificar):</label>
                            <input type="text" id="player-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Dejar vacío para nuevo">
                        </div>
                        <div>
                            <label for="player-name" class="block text-sm font-medium text-gray-700">Nombre:</label>
                            <input type="text" id="player-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="player-status" class="block text-sm font-medium text-gray-700">Estado:</label>
                            <select id="player-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-3">
                        <button id="save-player-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                            Guardar Jugador
                        </button>
                        <button id="delete-player-button" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                            Eliminar Jugador
                        </button>
                    </div>
                </div>

                <h3 class="text-xl font-medium text-gray-800 mb-3">Listado de Jugadores</h3>
                <div id="players-list-admin" class="overflow-x-auto">
                    <p class="text-gray-500 text-center">Cargando jugadores...</p>
                    <table class="min-w-full bg-white rounded-lg shadow hidden">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">ID</th>
                                <th class="py-3 px-6 text-left">Nombre</th>
                                <th class="py-3 px-6 text-left">Estado</th>
                                <th class="py-3 px-6 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">
                            <!-- Filas de jugadores se cargarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="team-formation" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Armar Equipos</h2>
                <p class="text-gray-500 mb-4">Selecciona 10 jugadores para formar los equipos Claros y Oscuros.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-medium text-gray-800 mb-3">Jugadores Disponibles</h3>
                        <div id="available-players" class="border border-gray-300 rounded-lg p-4 h-64 overflow-y-auto bg-gray-50">
                            <!-- Jugadores disponibles se cargarán aquí -->
                            <p class="text-gray-500">Cargando jugadores...</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium text-gray-800 mb-3">Equipos Seleccionados (10/10)</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">Claros (<span id="claros-count">0</span>)</h4>
                                <div id="team-claros" class="border border-blue-300 rounded-lg p-3 h-28 overflow-y-auto bg-blue-50">
                                    <!-- Jugadores del equipo Claros -->
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">Oscuros (<span id="oscuros-count">0</span>)</h4>
                                <div id="team-oscuros" class="border border-red-300 rounded-lg p-3 h-28 overflow-y-auto bg-red-50">
                                    <!-- Jugadores del equipo Oscuros -->
                                </div>
                            </div>
                        </div>
                        <button id="save-teams-button" class="mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 w-full" disabled>
                            Guardar Equipos para Partido
                        </button>
                    </div>
                </div>
            </div>

            <div id="match-results" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Resultados</h2>
                <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-800 mb-3">Detalles del Partido</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="match-date" class="block text-sm font-medium text-gray-700">Fecha del Partido:</label>
                            <input type="date" id="match-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="match-result" class="block text-sm font-medium text-gray-700">Resultado:</label>
                            <select id="match-result" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="">Seleccionar resultado</option>
                                <option value="Claros">Claros</option>
                                <option value="Oscuros">Oscuros</option>
                                <option value="Empate">Empate</option>
                                <option value="Suspendido">Suspendido</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="results-match-select" class="block text-sm font-medium text-gray-700">Seleccionar Partido:</label>
                        <select id="results-match-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="">Seleccionar partido (fecha - Claros vs Oscuros)</option>
                            <!-- Opciones se cargarán dinámicamente -->
                        </select>
                    </div>
                    <button id="register-match-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 w-full">
                        Registrar Resultado y Puntos
                    </button>
                </div>
            </div>

            <div id="chamigo-management" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Chamigo</h2>
                <div class="mb-4">
                    <label for="chamigo-match-select" class="block text-sm font-medium text-gray-700">Seleccionar Partido:</label>
                    <select id="chamigo-match-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="">Seleccionar partido (fecha - Claros vs Oscuros)</option>
                        <!-- Opciones se cargarán dinámicamente -->
                    </select>
                </div>
                <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-800 mb-3">Registrar Votos de Chamigo</h3>
                    <div id="chamigo-voting-players" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        <!-- Jugadores para votar por Chamigo se cargarán aquí -->
                        <p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>
                    </div>
                    <button id="register-chamigo-button" class="px-6 py-3 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700 transition duration-300 w-full">
                        Registrar Chamigo(s)
                    </button>
                </div>
            </div>

            <div id="tt-attendance" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">TT</h2>
                <div class="mb-4">
                    <label for="tt-match-select" class="block text-sm font-medium text-gray-700">Seleccionar Partido:</label>
                    <select id="tt-match-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="">Seleccionar partido (fecha - Claros vs Oscuros)</option>
                        <!-- Opciones se cargarán dinámicamente -->
                    </select>
                </div>
                <div class="p-4 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-800 mb-3">Registrar Asistencia TT</h3>
                    <div id="tt-attendance-players" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        <!-- Jugadores para asistencia TT se cargarán aquí -->
                        <p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>
                    </div>
                    <button id="register-tt-button" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 w-full">
                        Registrar Asistencia TT
                    </button>
                </div>
            </div>

            <!-- Nueva Pestaña: Tabla de Posiciones -->
            <div id="leaderboard-tab" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tabla de Posiciones</h2>
                <!-- Controles de Filtro para la tabla de posiciones -->
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <div>
                        <label for="leaderboard-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                        <select id="leaderboard-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <!-- Opciones de año se generarán dinámicamente -->
                        </select>
                    </div>
                    <div>
                        <label for="leaderboard-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                        <select id="leaderboard-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="totales">Totales</option>
                            <option value="apertura">Apertura</option>
                            <option value="clausura">Clausura</option>
                        </select>
                    </div>
                    <div>
                        <label for="leaderboard-criterion-select" class="block text-sm font-medium text-gray-700">Criterio:</label>
                        <select id="leaderboard-criterion-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="puntos">Puntos</option>
                            <option value="chamigos">Chamigo</option>
                            <option value="tt">TT</option>
                        </select>
                    </div>
                </div>

                <div id="leaderboard-container-admin" class="overflow-x-auto">
                    <p id="leaderboard-loading-message" class="text-gray-500 text-center">Cargando tabla de posiciones...</p>
                    <table id="leaderboard-table-admin" class="min-w-full bg-white rounded-lg shadow hidden">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Posición</th>
                                <th class="py-3 px-6 text-left">Jugador</th>
                                <th class="py-3 px-6 text-center">Puntos</th>
                                <th class="py-3 px-6 text-center">Partidos</th>
                                <th class="py-3 px-6 text-center">Chamigos</th>
                                <th class="py-3 px-6 text-center">TT</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">
                            <!-- Filas de jugadores se cargarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Script de la API de Google -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <script>
        // ¡IMPORTANTE! Reemplaza 'TU_CLIENT_ID' con tu ID de Cliente de OAuth 2.0
        const CLIENT_ID = '490772160476-4cmd0dse3b74o65g1n9s1q5itlbjavbb.apps.googleusercontent.com';
        // ¡IMPORTANTE! Reemplaza 'TU_ID_DE_HOJA_DE_CALCULO' con el ID de tu Google Sheet
        const SPREADSHEET_ID = '1bpNKl-UVHzbqsow4zOHE7-y5Cunm2xtpgyIodEQBi2E';

        // Ámbitos de autorización necesarios para leer y escribir en Google Sheets
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let allPlayersData = []; // Cache de todos los jugadores
        let allMatchesData = []; // Cache de todos los partidos

        // Elementos del DOM
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const authStatus = document.getElementById('auth-status');
        const adminContent = document.getElementById('admin-content');

        // Gestión de Jugadores
        const playerIdInput = document.getElementById('player-id');
        const playerNameInput = document.getElementById('player-name');
        const playerStatusSelect = document.getElementById('player-status');
        const savePlayerButton = document.getElementById('save-player-button');
        const deletePlayerButton = document.getElementById('delete-player-button');
        const playersListAdminTableBody = document.querySelector('#players-list-admin table tbody');

        // Armar Equipos
        const availablePlayersDiv = document.getElementById('available-players');
        const teamClarosDiv = document.getElementById('team-claros');
        const teamOscurosDiv = document.getElementById('team-oscuros');
        const clarosCountSpan = document.getElementById('claros-count');
        const oscurosCountSpan = document.getElementById('oscuros-count');
        const saveTeamsButton = document.getElementById('save-teams-button');

        // Resultados (antes Registrar Partido)
        const matchDateInput = document.getElementById('match-date');
        const matchResultSelect = document.getElementById('match-result');
        const resultsMatchSelect = document.getElementById('results-match-select');
        const registerMatchButton = document.getElementById('register-match-button');

        // Chamigo
        const chamigoMatchSelect = document.getElementById('chamigo-match-select');
        const chamigoVotingPlayersDiv = document.getElementById('chamigo-voting-players');
        const registerChamigoButton = document.getElementById('register-chamigo-button');

        // TT
        const ttMatchSelect = document.getElementById('tt-match-select');
        const ttAttendancePlayersDiv = document.getElementById('tt-attendance-players');
        const registerTtButton = document.getElementById('register-tt-button');

        // Tabla de Posiciones (nuevos elementos)
        const leaderboardLoadingMessage = document.getElementById('leaderboard-loading-message');
        const leaderboardTableAdmin = document.getElementById('leaderboard-table-admin');
        const leaderboardTableBodyAdmin = leaderboardTableAdmin.querySelector('tbody');
        const leaderboardYearSelect = document.getElementById('leaderboard-year-select');
        const leaderboardPeriodSelect = document.getElementById('leaderboard-period-select');
        const leaderboardCriterionSelect = document.getElementById('leaderboard-criterion-select');


        // --- Funciones de Autenticación ---

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    // No se necesita API_KEY aquí, ya que OAuth 2.0 proporciona la autorización.
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                gapiInited = true;
                maybeEnableAuthButtons();
            } catch (err) {
                console.error("Error al inicializar gapi.client:", err);
                authStatus.textContent = `Error al inicializar la API de Google: ${err.message || err.error_description || JSON.stringify(err)}. Revisa la consola.`;
                authStatus.classList.remove('hidden');
            }
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Se define en handleAuthClick
            });
            gisInited = true;
            maybeEnableAuthButtons();
        }

        function maybeEnableAuthButtons() {
            if (gapiInited && gisInited) {
                authorizeButton.style.display = 'block';
                if (gapi.client.getToken() !== null) {
                    handleAuthSuccess();
                } else {
                    authStatus.textContent = 'Por favor, autoriza la aplicación para acceder a los datos.';
                    authStatus.classList.remove('hidden');
                }
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) {
                    console.error('Error de autenticación:', resp);
                    authStatus.textContent = `Error de autenticación: ${resp.error_description || resp.error}`;
                    authStatus.classList.remove('hidden');
                    return;
                }
                handleAuthSuccess();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function handleAuthSuccess() {
            authorizeButton.style.display = 'none';
            signoutButton.style.display = 'block';
            authStatus.classList.add('hidden');
            adminContent.classList.remove('hidden');
            await loadAllDataAndDisplayAllContent(); // Cargar todos los datos y renderizar todo
            setupTabNavigation();
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                authorizeButton.style.display = 'block';
                signoutButton.style.display = 'none';
                adminContent.classList.add('hidden');
                authStatus.textContent = 'Sesión cerrada. Por favor, autoriza de nuevo.';
                authStatus.classList.remove('hidden');
                // Limpiar todas las interfaces
                playersListAdminTableBody.innerHTML = '';
                availablePlayersDiv.innerHTML = '';
                teamClarosDiv.innerHTML = '';
                teamOscurosDiv.innerHTML = '';
                clarosCountSpan.textContent = '0';
                oscurosCountSpan.textContent = '0';
                resultsMatchSelect.innerHTML = '<option value="">Seleccionar partido (fecha - Claros vs Oscuros)</option>';
                chamigoMatchSelect.innerHTML = '<option value="">Seleccionar partido (fecha - Claros vs Oscuros)</option>';
                ttMatchSelect.innerHTML = '<option value="">Seleccionar partido (fecha - Claros vs Oscuros)</option>';
                chamigoVotingPlayersDiv.innerHTML = '';
                ttAttendancePlayersDiv.innerHTML = '';
                leaderboardTableBodyAdmin.innerHTML = '';
            }
        }

        // --- Funciones de Carga de Datos ---

        async function loadAllData() {
            try {
                if (!gapi.client.sheets) {
                    console.error("gapi.client.sheets no está disponible. ¿Se inicializó correctamente el cliente de la API de Google?");
                    throw new Error("API de Google Sheets no cargada correctamente.");
                }

                const playersResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Jugadores!A:G',
                });
                allPlayersData = playersResponse.result.values ? playersResponse.result.values.slice(1) : [];

                const matchesResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Partidos!A:G',
                });
                allMatchesData = matchesResponse.result.values ? matchesResponse.result.values.slice(1) : [];

            } catch (err) {
                console.error('Error al cargar todos los datos:', err);
                let userErrorMessage = 'Error desconocido al cargar datos.';
                if (err && err.result && err.result.error && err.result.error.message) {
                    userErrorMessage = `Error al cargar datos: ${err.result.error.message}. Revisa la consola para más detalles.`;
                } else if (err && err.message) {
                    userErrorMessage = `Error al cargar datos: ${err.message}. Revisa la consola para más detalles.`;
                }
                alert(userErrorMessage);
            }
        }

        async function loadAllDataAndDisplayAllContent() {
            await loadAllData();
            renderPlayersListAdmin();
            renderAvailablePlayersForTeams();
            populateMatchSelects();
            populateLeaderboardYearSelect(); // Llama a la función para la tabla de posiciones
            setInitialLeaderboardPeriod(); // Establece el período inicial para la tabla de posiciones
            renderLeaderboard(); // Renderiza la tabla de posiciones inicial
        }

        // --- Funciones de Pestañas ---
        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    button.classList.add('active');
                    document.getElementById(button.dataset.tab).classList.add('active');

                    // Recargar datos específicos de la pestaña si es necesario
                    if (button.dataset.tab === 'players-management') {
                        renderPlayersListAdmin();
                    } else if (button.dataset.tab === 'team-formation') {
                        renderAvailablePlayersForTeams();
                        // Limpiar selecciones de equipos al cambiar de pestaña
                        teamClarosDiv.innerHTML = '';
                        teamOscurosDiv.innerHTML = '';
                        clarosCountSpan.textContent = '0';
                        oscurosCountSpan.textContent = '0';
                        saveTeamsButton.disabled = true;
                    } else if (button.dataset.tab === 'match-results') {
                        populateMatchSelects();
                        resultsMatchSelect.value = ''; // Limpiar selección
                        matchDateInput.value = '';
                        matchResultSelect.value = '';
                    } else if (button.dataset.tab === 'chamigo-management') {
                        populateMatchSelects();
                        chamigoMatchSelect.value = ''; // Limpiar selección
                        chamigoVotingPlayersDiv.innerHTML = '<p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>';
                    } else if (button.dataset.tab === 'tt-attendance') {
                        populateMatchSelects();
                        ttMatchSelect.value = ''; // Limpiar selección
                        ttAttendancePlayersDiv.innerHTML = '<p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>';
                    } else if (button.dataset.tab === 'leaderboard-tab') {
                        // Al activar la pestaña de la tabla de posiciones, renderizarla
                        populateLeaderboardYearSelect();
                        setInitialLeaderboardPeriod(); // Asegurarse de que el período se establezca al cambiar de pestaña
                        renderLeaderboard();
                    }
                });
            });
        }

        // --- Gestión de Jugadores (AMB) ---

        function renderPlayersListAdmin() {
            playersListAdminTableBody.innerHTML = ''; // Limpiar tabla
            if (allPlayersData.length === 0) {
                playersListAdminTableBody.innerHTML = '<tr><td colspan="4" class="py-3 px-6 text-center text-gray-500">No hay jugadores registrados.</td></tr>';
                return;
            }

            allPlayersData.forEach((player, index) => {
                const [id, nombre, estado] = player;
                const row = `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6 text-left">${id}</td>
                        <td class="py-3 px-6 text-left">${nombre}</td>
                        <td class="py-3 px-6 text-left">${estado}</td>
                        <td class="py-3 px-6 text-center">
                            <button class="edit-player-button px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 text-xs" data-id="${id}" data-name="${nombre}" data-status="${estado}">Editar</button>
                        </td>
                    </tr>
                `;
                playersListAdminTableBody.innerHTML += row;
            });

            // Añadir event listeners a los botones de edición
            document.querySelectorAll('.edit-player-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    playerIdInput.value = e.target.dataset.id;
                    playerNameInput.value = e.target.dataset.name;
                    playerStatusSelect.value = e.target.dataset.status;
                });
            });
            document.querySelector('#players-list-admin table').classList.remove('hidden');
        }

        savePlayerButton.addEventListener('click', async () => {
            const id = playerIdInput.value.trim();
            const name = playerNameInput.value.trim();
            const status = playerStatusSelect.value;

            if (!name) {
                alert('El nombre del jugador no puede estar vacío.');
                return;
            }

            try {
                let rowToUpdate = allPlayersData.findIndex(p => p[0] === id); // Buscar por ID
                let newPlayerId = id;

                if (rowToUpdate === -1) { // Si no se encuentra, es un nuevo jugador
                    // Generar un nuevo ID de jugador (ej. J001, J002...)
                    const maxIdNum = allPlayersData.reduce((max, p) => {
                        const num = parseInt(p[0]?.replace('J', '') || 0);
                        return Math.max(max, num);
                    }, 0);
                    newPlayerId = 'J' + String(maxIdNum + 1).padStart(3, '0');
                    // Valores iniciales para un nuevo jugador
                    const newPlayerRow = [newPlayerId, name, status, 0, 0, 0, 0];
                    allPlayersData.push(newPlayerRow);
                    rowToUpdate = allPlayersData.length - 1; // Índice del nuevo jugador
                } else {
                    // Modificar jugador existente
                    allPlayersData[rowToUpdate][1] = name; // Nombre
                    allPlayersData[rowToUpdate][2] = status; // Estado
                }

                // Actualizar la hoja de cálculo
                const values = [allPlayersData[rowToUpdate]];
                const range = `Jugadores!A${rowToUpdate + 2}:G${rowToUpdate + 2}`; // +2 porque es 1-indexado y hay encabezado

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                    valueInputOption: 'RAW',
                    resource: { values: values },
                });

                alert('Jugador guardado exitosamente.');
                playerIdInput.value = '';
                playerNameInput.value = '';
                playerStatusSelect.value = 'Activo';
                await loadAllDataAndDisplayAllContent(); // Recargar y renderizar la lista
            } catch (err) {
                console.error('Error al guardar jugador:', err);
                alert(`Error al guardar jugador: ${err.message}. Revisa la consola.`);
            }
        });

        deletePlayerButton.addEventListener('click', async () => {
            const idToDelete = playerIdInput.value.trim();
            if (!idToDelete) {
                alert('Por favor, selecciona un jugador para eliminar usando su ID.');
                return;
            }

            if (!confirm(`¿Estás seguro de que quieres eliminar al jugador con ID ${idToDelete}? Esto no se puede deshacer.`)) {
                return;
            }

            try {
                const rowIndex = allPlayersData.findIndex(p => p[0] === idToDelete);
                if (rowIndex === -1) {
                    alert('Jugador no encontrado.');
                    return;
                }

                // Opción más segura: cambiar estado a 'Inactivo'
                allPlayersData[rowIndex][2] = 'Inactivo'; // Cambiar estado a Inactivo
                const values = [allPlayersData[rowIndex]];
                const range = `Jugadores!A${rowIndex + 2}:G${rowIndex + 2}`;

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                    valueInputOption: 'RAW',
                    resource: { values: values },
                });

                alert(`Jugador con ID ${idToDelete} marcado como Inactivo.`);
                playerIdInput.value = '';
                playerNameInput.value = '';
                playerStatusSelect.value = 'Activo';
                await loadAllDataAndDisplayAllContent();
            } catch (err) {
                console.error('Error al eliminar jugador:', err);
                alert(`Error al eliminar jugador: ${err.message}. Revisa la consola.`);
            }
        });

        // --- Armar Equipos ---

        function renderAvailablePlayersForTeams() {
            availablePlayersDiv.innerHTML = '';
            const activePlayers = allPlayersData.filter(p => p[2] === 'Activo'); // Filtrar solo jugadores activos

            if (activePlayers.length === 0) {
                availablePlayersDiv.innerHTML = '<p class="text-gray-500">No hay jugadores activos disponibles.</p>';
                return;
            }

            activePlayers.forEach(player => {
                const [id, nombre] = player;
                const playerElement = document.createElement('div');
                playerElement.className = 'player-draggable cursor-grab bg-white p-2 rounded-md shadow-sm mb-2 flex justify-between items-center';
                playerElement.draggable = true;
                playerElement.dataset.id = id;
                playerElement.dataset.name = nombre;
                playerElement.textContent = nombre;
                playerElement.addEventListener('dragstart', handleDragStart);
                availablePlayersDiv.appendChild(playerElement);
            });
        }

        function handleDragStart(e) {
            console.log('Drag started for player:', e.target.dataset.name); // Log de depuración
            e.dataTransfer.setData('text/plain', JSON.stringify({
                id: e.target.dataset.id,
                name: e.target.dataset.name,
                source: e.target.parentNode.id // 'available-players', 'team-claros', 'team-oscuros'
            }));
            e.dataTransfer.effectAllowed = 'move';
        }

        [availablePlayersDiv, teamClarosDiv, teamOscurosDiv].forEach(dropZone => {
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
        });

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e) {
            e.preventDefault();
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const playerId = data.id;
            const playerName = data.name;
            const sourceId = data.source;
            const targetId = e.currentTarget.id;

            console.log('Drop event on', e.currentTarget.id, 'for player:', data.name); // Log de depuración

            // Evitar mover al mismo lugar
            if (sourceId === targetId) return;

            // Remover del origen
            const sourceElement = document.querySelector(`#${sourceId} .player-draggable[data-id="${playerId}"]`);
            if (sourceElement) sourceElement.remove();

            // Añadir al destino si no existe ya
            if (!document.querySelector(`#${targetId} .player-draggable[data-id="${playerId}"]`)) {
                const playerElement = document.createElement('div');
                playerElement.className = 'player-draggable cursor-grab bg-white p-2 rounded-md shadow-sm mb-2 flex justify-between items-center';
                playerElement.draggable = true;
                playerElement.dataset.id = playerId;
                playerElement.dataset.name = playerName;
                playerElement.textContent = playerName;
                playerElement.addEventListener('dragstart', handleDragStart);
                document.getElementById(targetId).appendChild(playerElement);
            }
            updateTeamCounts();
        }

        function updateTeamCounts() {
            const clarosPlayers = Array.from(teamClarosDiv.children).map(el => el.dataset.id);
            const oscurosPlayers = Array.from(teamOscurosDiv.children).map(el => el.dataset.id);

            clarosCountSpan.textContent = clarosPlayers.length;
            oscurosCountSpan.textContent = oscurosPlayers.length;

            // Habilitar botón de guardar equipos si hay 5 jugadores en cada equipo
            if (clarosPlayers.length === 5 && oscurosPlayers.length === 5) {
                saveTeamsButton.disabled = false;
            } else {
                saveTeamsButton.disabled = true;
            }
        }

        saveTeamsButton.addEventListener('click', async () => {
            const clarosPlayers = Array.from(teamClarosDiv.children).map(el => el.dataset.id);
            const oscurosPlayers = Array.from(teamOscurosDiv.children).map(el => el.dataset.id);

            if (clarosPlayers.length !== 5 || oscurosPlayers.length !== 5) {
                alert('Debes seleccionar exactamente 5 jugadores para cada equipo.');
                return;
            }

            try {
                // Generar un nuevo ID de partido
                const maxIdNum = allMatchesData.reduce((max, m) => {
                    const num = parseInt(m[0]?.replace('P', '') || 0);
                    return Math.max(max, num);
                }, 0);
                const newMatchId = 'P' + String(maxIdNum + 1).padStart(3, '0');

                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0'); // Enero es 0
                const yyyy = today.getFullYear();
                const formattedDate = `${dd}/${mm}/${yyyy}`;

                const newMatchRow = [
                    newMatchId,
                    formattedDate,
                    clarosPlayers.join(','),
                    oscurosPlayers.join(','),
                    '', // Resultado vacío inicialmente
                    '', // Chamigo_Votos vacío inicialmente
                    ''  // Asistencia_TT_IDs vacío inicialmente
                ];

                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Partidos!A:G',
                    valueInputOption: 'RAW',
                    resource: { values: [newMatchRow] },
                });

                alert(`Equipos guardados para el partido ${newMatchId} en la fecha ${formattedDate}.`);
                await loadAllDataAndDisplayAllContent(); // Recargar partidos para que aparezca en el selector
                // Limpiar la selección de equipos
                availablePlayersDiv.innerHTML = ''; // Se recargará con loadAllDataAndDisplayAllContent
                teamClarosDiv.innerHTML = '';
                teamOscurosDiv.innerHTML = '';
                clarosCountSpan.textContent = '0';
                oscurosCountSpan.textContent = '0';
                saveTeamsButton.disabled = true;
            } catch (err) {
                console.error('Error al guardar equipos:', err);
                alert(`Error al guardar equipos: ${err.message}. Revisa la consola.`);
            }
        });

        // --- Funciones para poblar selectores de partidos ---
        function populateMatchSelects() {
            const selectsToPopulate = [resultsMatchSelect, chamigoMatchSelect, ttMatchSelect];

            selectsToPopulate.forEach(selectElement => {
                selectElement.innerHTML = '<option value="">Seleccionar partido (fecha - Claros vs Oscuros)</option>';
                const sortedMatches = [...allMatchesData].sort((a, b) => {
                    const dateA = parseDate(a[1]);
                    const dateB = parseDate(b[1]);
                    return dateB - dateA;
                });

                sortedMatches.forEach(match => {
                    const [id, fecha, clarosIDs, oscurosIDs, resultado] = match;
                    const option = document.createElement('option');
                    option.value = id;
                    const clarosNames = clarosIDs.split(',').map(id => {
                        const player = allPlayersData.find(p => p[0] === id);
                        return player ? player[1] : `ID:${id}`;
                    }).join(', ');
                    const oscurosNames = oscurosIDs.split(',').map(id => {
                        const player = allPlayersData.find(p => p[0] === id);
                        return player ? player[1] : `ID:${id}`;
                    }).join(', ');
                    option.textContent = `${fecha} - Claros (${clarosNames}) vs Oscuros (${oscurosNames})`;
                    selectElement.appendChild(option);
                });
            });
        }


        // --- Resultados (antes Registrar Partido) ---

        resultsMatchSelect.addEventListener('change', () => {
            const selectedMatchId = resultsMatchSelect.value;
            if (selectedMatchId) {
                const match = allMatchesData.find(m => m[0] === selectedMatchId);
                if (match) {
                    // Pre-rellenar fecha del partido si está disponible
                    if (match[1]) { // Columna Fecha
                        const [day, month, year] = match[1].split('/');
                        matchDateInput.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    } else {
                        matchDateInput.value = '';
                    }
                    matchResultSelect.value = match[4] || ''; // Pre-rellenar resultado si ya existe
                }
            } else {
                matchDateInput.value = '';
                matchResultSelect.value = '';
            }
        });

        registerMatchButton.addEventListener('click', async () => {
            const selectedMatchId = resultsMatchSelect.value;
            const result = matchResultSelect.value;
            const matchDate = matchDateInput.value; // Formato YYYY-MM-DD

            if (!selectedMatchId || !result || !matchDate) {
                alert('Por favor, selecciona un partido, ingresa la fecha y el resultado.');
                return;
            }

            try {
                const matchIndex = allMatchesData.findIndex(m => m[0] === selectedMatchId);
                if (matchIndex === -1) {
                    alert('Partido no encontrado.');
                    return;
                }

                const currentMatch = allMatchesData[matchIndex];
                const [id, oldDate, clarosIDsStr, oscurosIDsStr, oldResult, chamigoVotosStr, ttAttendeesStr] = currentMatch;

                if (oldResult) {
                    alert('Este partido ya tiene un resultado registrado. Por favor, selecciona un partido sin resultado o edita el existente.');
                    return;
                }

                // Actualizar el resultado y la fecha en el array en memoria
                currentMatch[1] = formatDateToDDMMYYYY(new Date(matchDate)); // Actualizar fecha a DD/MM/YYYY
                currentMatch[4] = result; // Actualizar resultado

                // Actualizar la hoja de cálculo para el partido
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `Partidos!A${matchIndex + 2}:G${matchIndex + 2}`,
                    valueInputOption: 'RAW',
                    resource: { values: [currentMatch] },
                });

                // --- Lógica de Puntos ---
                const clarosPlayers = clarosIDsStr.split(',');
                const oscurosPlayers = oscurosIDsStr.split(',');

                let playersToUpdate = []; // [{id: 'J001', points: 3, games: 1}]

                // Incrementar partidos jugados para todos los participantes
                [...clarosPlayers, ...oscurosPlayers].forEach(pId => {
                    const player = allPlayersData.find(pl => pl[0] === pId);
                    if (player) {
                        const currentGames = parseInt(player[4] || 0); // Columna Partidos_Jugados
                        playersToUpdate.push({ id: pId, games: currentGames + 1, points: 0 }); // Puntos se añadirán después
                    }
                });

                if (result === 'Claros') {
                    clarosPlayers.forEach(pId => {
                        const player = playersToUpdate.find(pu => pu.id === pId);
                        if (player) player.points += 3;
                    });
                } else if (result === 'Oscuros') {
                    oscurosPlayers.forEach(pId => {
                        const player = playersToUpdate.find(pu => pu.id === pId);
                        if (player) player.points += 3;
                    });
                } else if (result === 'Empate') {
                    [...clarosPlayers, ...oscurosPlayers].forEach(pId => {
                        const player = playersToUpdate.find(pu => pu.id === pId);
                        if (player) player.points += 1;
                    });
                }

                // Actualizar puntos y partidos jugados en la hoja de Jugadores
                const updateRequests = [];
                playersToUpdate.forEach(playerUpdate => {
                    const playerGlobalIndex = allPlayersData.findIndex(p => p[0] === playerUpdate.id);
                    if (playerGlobalIndex !== -1) {
                        const currentPlayer = allPlayersData[playerGlobalIndex];
                        const currentPuntos = parseInt(currentPlayer[3] || 0); // Columna Puntos_Totales
                        currentPlayer[3] = currentPuntos + playerUpdate.points; // Sumar puntos
                        currentPlayer[4] = playerUpdate.games; // Actualizar partidos jugados

                        updateRequests.push({
                            range: `Jugadores!D${playerGlobalIndex + 2}:E${playerGlobalIndex + 2}`, // Columnas D (Puntos_Totales) y E (Partidos_Jugados)
                            values: [[currentPlayer[3], currentPlayer[4]]]
                        });
                    }
                });

                if (updateRequests.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            data: updateRequests,
                            valueInputOption: 'RAW'
                        }
                    });
                }

                alert('Resultado del partido y puntos actualizados exitosamente.');
                matchDateInput.value = '';
                matchResultSelect.value = '';
                await loadAllDataAndDisplayAllContent(); // Recargar todos los datos
            } catch (err) {
                console.error('Error al registrar partido:', err);
                alert(`Error al registrar partido: ${err.message}. Revisa la consola.`);
            }
        });

        // --- Funciones de Chamigo ---

        chamigoMatchSelect.addEventListener('change', () => {
            const selectedMatchId = chamigoMatchSelect.value;
            chamigoVotingPlayersDiv.innerHTML = '';
            if (selectedMatchId) {
                const match = allMatchesData.find(m => m[0] === selectedMatchId);
                if (match) {
                    const clarosIDs = match[2] ? match[2].split(',') : [];
                    const oscurosIDs = match[3] ? match[3].split(',') : [];
                    const playersInMatchIDs = [...new Set([...clarosIDs, ...oscurosIDs])]; // Unir y eliminar duplicados

                    const playersInMatch = playersInMatchIDs.map(id => {
                        const player = allPlayersData.find(p => p[0] === id);
                        return { id: id, name: player ? player[1] : `ID:${id}` };
                    });
                    renderChamigoVotingPlayers(playersInMatch);

                    // Precargar votos si ya existen
                    if (match[5]) { // Columna Chamigo_Votos
                        try {
                            const existingVotes = JSON.parse(match[5]);
                            existingVotes.forEach(vote => {
                                const input = chamigoVotingPlayersDiv.querySelector(`input[data-id="${vote.id}"]`);
                                if (input) {
                                    input.value = vote.votos;
                                }
                            });
                        } catch (e) {
                            console.warn("Error al parsear votos de chamigo existentes:", e);
                        }
                    }
                }
            } else {
                chamigoVotingPlayersDiv.innerHTML = '<p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>';
            }
        });

        function renderChamigoVotingPlayers(playersInMatch) {
            chamigoVotingPlayersDiv.innerHTML = '';
            if (playersInMatch.length === 0) {
                chamigoVotingPlayersDiv.innerHTML = '<p class="text-gray-500">No hay jugadores para votar por Chamigo en este partido.</p>';
                return;
            }

            playersInMatch.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center space-x-2';
                playerDiv.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">${player.name}:</label>
                    <input type="number" data-id="${player.id}" class="chamigo-vote-input mt-1 block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" value="0" min="0">
                `;
                chamigoVotingPlayersDiv.appendChild(playerDiv);
            });
        }

        registerChamigoButton.addEventListener('click', async () => {
            const selectedMatchId = chamigoMatchSelect.value;
            if (!selectedMatchId) {
                alert('Por favor, selecciona un partido para registrar el Chamigo.');
                return;
            }

            const matchIndex = allMatchesData.findIndex(m => m[0] === selectedMatchId);
            if (matchIndex === -1) {
                alert('Partido no encontrado.');
                return;
            }

            const currentMatch = allMatchesData[matchIndex];
            // Recopilar votos
            const voteInputs = document.querySelectorAll('.chamigo-vote-input');
            let votes = [];
            voteInputs.forEach(input => {
                const playerId = input.dataset.id;
                const numVotes = parseInt(input.value || 0);
                if (numVotes > 0) {
                    votes.push({ id: playerId, votos: numVotes });
                }
            });

            if (votes.length === 0) {
                alert('No se han ingresado votos para Chamigo.');
                return;
            }

            // Encontrar el/los Chamigo(s) con más votos
            const maxVotes = Math.max(...votes.map(v => v.votos));
            const chamigosDelPartido = votes.filter(v => v.votos === maxVotes);

            // Actualizar la columna Chamigo_Votos del partido
            currentMatch[5] = JSON.stringify(votes); // Guardar todos los votos como JSON

            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `Partidos!F${matchIndex + 2}`, // Columna F (Chamigo_Votos)
                    valueInputOption: 'RAW',
                    resource: { values: [[currentMatch[5]]] },
                });

                // Actualizar el contador de Chamigos_Ganados en la hoja de Jugadores
                const updateRequests = [];
                chamigosDelPartido.forEach(chamigo => {
                    const playerGlobalIndex = allPlayersData.findIndex(p => p[0] === chamigo.id);
                    if (playerGlobalIndex !== -1) {
                        const currentPlayer = allPlayersData[playerGlobalIndex];
                        const currentChamigos = parseInt(currentPlayer[5] || 0); // Columna Chamigos_Ganados
                        currentPlayer[5] = currentChamigos + 1; // Incrementar Chamigos_Ganados

                        updateRequests.push({
                            range: `Jugadores!F${playerGlobalIndex + 2}`, // Columna F (Chamigos_Ganados)
                            values: [[currentPlayer[5]]]
                        });
                    }
                });

                if (updateRequests.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            data: updateRequests,
                            valueInputOption: 'RAW'
                        }
                    });
                }

                alert('Chamigo(s) registrado(s) exitosamente.');
                // Limpiar inputs de votos
                document.querySelectorAll('.chamigo-vote-input').forEach(input => input.value = '0');
                await loadAllDataAndDisplayAllContent(); // Recargar todos los datos
            } catch (err) {
                console.error('Error al registrar Chamigo:', err);
                alert(`Error al registrar Chamigo: ${err.message}. Revisa la consola.`);
            }
        });

        // --- Funciones de Asistencia TT ---

        ttMatchSelect.addEventListener('change', () => {
            const selectedMatchId = ttMatchSelect.value;
            ttAttendancePlayersDiv.innerHTML = '';
            if (selectedMatchId) {
                const match = allMatchesData.find(m => m[0] === selectedMatchId);
                if (match) {
                    // Ahora renderiza TODOS los jugadores activos para TT
                    renderTtAttendancePlayers(allPlayersData.filter(p => p[2] === 'Activo').map(p => ({id: p[0], name: p[1]})));

                    // Precargar asistencia si ya existe para este partido
                    if (match[6]) { // Columna Asistencia_TT_IDs
                        const existingAttendees = match[6].split(',');
                        existingAttendees.forEach(id => {
                            const checkbox = ttAttendancePlayersDiv.querySelector(`input[data-id="${id}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    }
                }
            } else {
                ttAttendancePlayersDiv.innerHTML = '<p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>';
            }
        });

        function renderTtAttendancePlayers(playersToRender) { // Recibe la lista de jugadores a mostrar
            ttAttendancePlayersDiv.innerHTML = '';
            if (playersToRender.length === 0) {
                ttAttendancePlayersDiv.innerHTML = '<p class="text-gray-500">No hay jugadores activos disponibles para registrar asistencia TT.</p>';
                return;
            }

            playersToRender.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center space-x-2';
                playerDiv.innerHTML = `
                    <input type="checkbox" id="tt-player-${player.id}" data-id="${player.id}" class="tt-checkbox h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label for="tt-player-${player.id}" class="text-sm font-medium text-gray-700">${player.name}</label>
                `;
                ttAttendancePlayersDiv.appendChild(playerDiv);
            });
        }

        registerTtButton.addEventListener('click', async () => {
            const selectedMatchId = ttMatchSelect.value;
            if (!selectedMatchId) {
                alert('Por favor, selecciona un partido para registrar la asistencia TT.');
                return;
            }

            const matchIndex = allMatchesData.findIndex(m => m[0] === selectedMatchId);
            if (matchIndex === -1) {
                alert('Partido no encontrado.');
                return;
            }

            const currentMatch = allMatchesData[matchIndex];
            const ttAttendees = Array.from(document.querySelectorAll('.tt-checkbox:checked')).map(cb => cb.dataset.id);

            // Obtener asistentes TT previos para evitar doble conteo de puntos
            const prevTtAttendees = currentMatch[6] ? currentMatch[6].split(',') : [];
            const newAttendeesForPoints = ttAttendees.filter(id => !prevTtAttendees.includes(id));

            // Actualizar la columna Asistencia_TT_IDs del partido
            currentMatch[6] = ttAttendees.join(','); // Columna G (Asistencia_TT_IDs)

            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `Partidos!G${matchIndex + 2}`,
                    valueInputOption: 'RAW',
                    resource: { values: [[currentMatch[6]]] },
                });

                // Actualizar el contador de TT_Asistencias en la hoja de Jugadores
                const updateRequests = [];
                newAttendeesForPoints.forEach(playerId => { // Solo para los nuevos asistentes
                    const playerGlobalIndex = allPlayersData.findIndex(p => p[0] === playerId);
                    if (playerGlobalIndex !== -1) {
                        const currentPlayer = allPlayersData[playerGlobalIndex];
                        const currentTtAsistencias = parseInt(currentPlayer[6] || 0); // Columna TT_Asistencias
                        currentPlayer[6] = currentTtAsistencias + 1; // Incrementar TT_Asistencias

                        updateRequests.push({
                            range: `Jugadores!G${playerGlobalIndex + 2}`, // Columna G (TT_Asistencias)
                            values: [[currentPlayer[6]]]
                        });
                    }
                });

                if (updateRequests.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({
                        spreadsheetId: SPREADSHEET_ID,
                        resource: {
                            data: updateRequests,
                            valueInputOption: 'RAW'
                        }
                    });
                }

                alert('Asistencia al Tercer Tiempo registrada exitosamente.');
                // Limpiar checkboxes (se recargarán con loadAllDataAndDisplayAllContent)
                // document.querySelectorAll('.tt-checkbox').forEach(cb => cb.checked = false);
                await loadAllDataAndDisplayAllContent(); // Recargar todos los datos
            } catch (err) {
                console.error('Error al registrar asistencia TT:', err);
                alert(`Error al registrar asistencia TT: ${err.message}. Revisa la consola.`);
            }
        });


        // --- Funciones de Tabla de Posiciones (Copiadas y adaptadas de index.html) ---

        /**
         * Rellena el selector de año con los años disponibles en los partidos.
         * Selecciona el año actual por defecto si existe, o el más reciente.
         */
        function populateLeaderboardYearSelect() {
            const years = new Set();
            allMatchesData.forEach(match => {
                const dateString = match[1]; // Columna 'Fecha'
                if (dateString) {
                    const date = parseDate(dateString);
                    years.add(date.getFullYear());
                }
            });

            const sortedYears = Array.from(years).sort((a, b) => b - a); // Ordenar de más reciente a más antiguo

            leaderboardYearSelect.innerHTML = ''; // Limpiar opciones existentes
            if (sortedYears.length > 0) {
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    leaderboardYearSelect.appendChild(option);
                });
                // Seleccionar el año actual por defecto si existe, o el más reciente
                const currentYear = new Date().getFullYear();
                if (sortedYears.includes(currentYear)) {
                    leaderboardYearSelect.value = currentYear;
                } else {
                    leaderboardYearSelect.value = sortedYears[0];
                }
            } else {
                const option = document.createElement('option');
                option.value = new Date().getFullYear(); // Año actual si no hay datos
                option.textContent = new Date().getFullYear();
                leaderboardYearSelect.appendChild(option);
            }
        }

        /**
         * Establece el período inicial (Apertura/Clausura/Totales) para la tabla de posiciones
         * basado en la fecha actual.
         */
        function setInitialLeaderboardPeriod() {
            const currentMonth = new Date().getMonth(); // 0-indexed (Enero es 0)
            if (currentMonth >= 0 && currentMonth <= 5) { // Enero a Junio
                leaderboardPeriodSelect.value = 'apertura';
            } else if (currentMonth >= 6 && currentMonth <= 11) { // Julio a Diciembre
                leaderboardPeriodSelect.value = 'clausura';
            } else {
                leaderboardPeriodSelect.value = 'totales'; // Por defecto, si no cae en Apertura/Clausura
            }
        }

        /**
         * Filtra los partidos según el año y el período seleccionados.
         */
        function filterMatchesForLeaderboard(matches, selectedYear, selectedPeriod) {
            return matches.filter(match => {
                const dateString = match[1]; // Columna 'Fecha'
                if (!dateString) return false;

                const matchDate = parseDate(dateString);
                const matchYear = matchDate.getFullYear();
                const matchMonth = matchDate.getMonth(); // 0-indexed

                if (selectedYear !== 'all' && matchYear !== parseInt(selectedYear)) {
                    return false;
                }

                if (selectedPeriod === 'apertura') {
                    return matchMonth >= 0 && matchMonth <= 5; // Enero (0) a Junio (5)
                } else if (selectedPeriod === 'clausura') {
                    return matchMonth >= 6 && matchMonth <= 11; // Julio (6) a Diciembre (11)
                }
                return true; // "totales" o si no hay período seleccionado
            });
        }

        /**
         * Calcula las estadísticas de los jugadores basándose en los partidos filtrados.
         */
        function calculatePlayerStatsForLeaderboard(players, filteredMatches) {
            const playerStats = {};

            // Inicializar estadísticas para todos los jugadores activos
            players.forEach(player => {
                const [id, nombre, estado] = player;
                if (estado === 'Activo') {
                    playerStats[id] = {
                        id,
                        nombre,
                        puntos: 0,
                        partidos: 0,
                        chamigos: 0,
                        tt: 0
                    };
                }
            });

            filteredMatches.forEach(match => {
                const [idPartido, fecha, equipoClarosIDsStr, equipoOscurosIDsStr, resultado, chamigoVotosStr, asistenciaTTIDsStr] = match;

                const equipoClarosIDs = equipoClarosIDsStr ? equipoClarosIDsStr.split(',') : [];
                const equipoOscurosIDs = equipoOscurosIDsStr ? equipoOscurosIDsStr.split(',') : [];
                const allPlayersInMatch = new Set([...equipoClarosIDs, ...equipoOscurosIDs]);

                // Contar partidos jugados
                allPlayersInMatch.forEach(playerId => {
                    if (playerStats[playerId]) {
                        playerStats[playerId].partidos++;
                    }
                });

                // Asignar puntos por resultado
                if (resultado === 'Claros' || resultado === 'Oscuros') {
                    const winningTeam = resultado === 'Claros' ? equipoClarosIDs : equipoOscurosIDs;
                    const losingTeam = resultado === 'Claros' ? equipoOscurosIDs : equipoClarosIDs;

                    winningTeam.forEach(playerId => {
                        if (playerStats[playerId]) playerStats[playerId].puntos += 3;
                    });
                    losingTeam.forEach(playerId => {
                        // Los perdedores no suman puntos
                    });
                } else if (resultado === 'Empate') {
                    allPlayersInMatch.forEach(playerId => {
                        if (playerStats[playerId]) playerStats[playerId].puntos += 1;
                    });
                }

                // Contar Chamigos
                if (chamigoVotosStr) {
                    try {
                        const chamigoVotos = JSON.parse(chamigoVotosStr);
                        // Encontrar el/los chamigo(s) con más votos para este partido
                        if (chamigoVotos.length > 0) {
                            const maxVotes = Math.max(...chamigoVotos.map(v => v.votos));
                            const chamigosDelPartido = chamigoVotos.filter(v => v.votos === maxVotes);
                            chamigosDelPartido.forEach(chamigo => {
                                if (playerStats[chamigo.id]) playerStats[chamigo.id].chamigos++;
                            });
                        }
                    } catch (e) {
                        console.warn('Error al parsear votos de chamigo:', chamigoVotosStr, e);
                    }
                }

                // Contar asistencias a TT
                if (asistenciaTTIDsStr) {
                    const ttAttendees = asistenciaTTIDsStr.split(',');
                    ttAttendees.forEach(playerId => {
                        if (playerStats[playerId]) playerStats[playerId].tt++;
                    });
                }
            });

            return Object.values(playerStats); // Convertir a array de objetos
        }

        /**
         * Renderiza la tabla de posiciones con los datos filtrados y ordenados.
         */
        function renderLeaderboard() {
            leaderboardLoadingMessage.textContent = 'Calculando posiciones...';
            leaderboardLoadingMessage.classList.remove('hidden');
            leaderboardTableAdmin.classList.add('hidden');
            leaderboardTableBodyAdmin.innerHTML = ''; // Limpiar tabla

            const selectedYear = leaderboardYearSelect.value;
            const selectedPeriod = leaderboardPeriodSelect.value;
            const selectedCriterion = leaderboardCriterionSelect.value;

            // 1. Filtrar partidos
            const filteredMatches = filterMatchesForLeaderboard(allMatchesData, selectedYear, selectedPeriod);

            // 2. Calcular estadísticas de jugadores
            let playersWithStats = calculatePlayerStatsForLeaderboard(allPlayersData, filteredMatches);

            // 3. Ordenar jugadores
            playersWithStats.sort((a, b) => {
                if (selectedCriterion === 'puntos') {
                    return b.puntos - a.puntos;
                } else if (selectedCriterion === 'chamigos') {
                    return b.chamigos - a.chamigos;
                } else if (selectedCriterion === 'tt') {
                    return b.tt - a.tt;
                }
                return 0; // Por defecto no ordena si el criterio no es reconocido
            });

            // Filtrar jugadores con 0 partidos jugados si el criterio es puntos, chamigos o tt
            if (selectedCriterion === 'puntos' || selectedCriterion === 'chamigos' || selectedCriterion === 'tt') {
                playersWithStats = playersWithStats.filter(player => player.partidos > 0);
            }


            if (playersWithStats.length > 0) {
                playersWithStats.forEach((player, index) => {
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6 text-left whitespace-nowrap font-medium">${index + 1}</td>
                            <td class="py-3 px-6 text-left">${player.nombre}</td>
                            <td class="py-3 px-6 text-center">${player.puntos}</td>
                            <td class="py-3 px-6 text-center">${player.partidos}</td>
                            <td class="py-3 px-6 text-center">${player.chamigos}</td>
                            <td class="py-3 px-6 text-center">${player.tt}</td>
                        </tr>
                    `;
                    leaderboardTableBodyAdmin.innerHTML += row;
                });
                leaderboardLoadingMessage.classList.add('hidden');
                leaderboardTableAdmin.classList.remove('hidden');
            } else {
                leaderboardLoadingMessage.textContent = 'No hay datos disponibles para los filtros seleccionados.';
                leaderboardLoadingMessage.classList.remove('hidden');
                leaderboardTableAdmin.classList.add('hidden');
            }
        }

        // Event Listeners para los selectores de la tabla de posiciones
        leaderboardYearSelect.addEventListener('change', renderLeaderboard);
        leaderboardPeriodSelect.addEventListener('change', renderLeaderboard);
        leaderboardCriterionSelect.addEventListener('change', renderLeaderboard);


        // --- Utilidades ---
        function parseDate(dateString) {
            const [day, month, year] = dateString.split('/').map(Number);
            return new Date(year, month - 1, day); // month - 1 porque los meses en Date son 0-indexados
        }

        function formatDateToDDMMYYYY(date) {
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const yyyy = date.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }


        // --- Inicialización ---
        authorizeButton.addEventListener('click', handleAuthClick);
        signoutButton.addEventListener('click', handleSignoutClick);

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Panel de Administración de Fútbol 5 cargado!');
            // Cargar las librerías de Google
            gapiLoaded();
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.async = true;
            script.defer = true;
            script.onload = gisLoaded;
            document.head.appendChild(script);
        });
    </script>
</body>
</html>
