
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - LA CLANDE</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Cropper.js for image editing -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚽</text></svg>">

    <style>
        :root {
            --bg-primary: #f4f7fe;
            --bg-secondary: #ffffff;
            --bg-muted: #f9fafb;
            --sidebar-bg: #111827;
            --sidebar-text: #e5e7eb;
            --sidebar-active-bg: #4f46e5;
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #374151;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --accent-color: #4f46e5;
            --accent-color-hover: #4338ca;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --button-text-color: #ffffff;
        }

        html.dark {
            --bg-primary: #030712;
            --bg-secondary: #1f2937;
            --bg-muted: #111827;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
            --accent-color: #6366f1;
            --accent-color-hover: #818cf8;
        }
        
        html {
            background-color: var(--bg-primary);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        @media (min-width: 768px) {
            #app-container {
                height: 100vh;
            }
        }
        
        body:has(#mobile-menu.translate-x-0),
        body.modal-open {
            overflow: hidden;
        }

        .card {
            background-color: var(--bg-secondary);
        }

        .card-styled {
             border: 1px solid var(--border-color);
             border-radius: 0.75rem;
             box-shadow: 0 4px 6px -1px rgba(0,0,0,.05), 0 2px 4px -2px rgba(0,0,0,.05);
        }
        
        input, select {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        html.dark input, 
        html.dark select {
            background-color: #1f2937 !important;
            color: #f9fafb !important;
            -webkit-text-fill-color: #f9fafb !important;
            border-color: #374151 !important;
        }

        html.dark input:-webkit-autofill,
        html.dark input:-webkit-autofill:hover,
        html.dark input:-webkit-autofill:focus,
        html.dark input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1f2937 inset !important;
            -webkit-text-fill-color: #f9fafb !important;
        }

        input[readonly] {
            background-color: var(--bg-muted) !important;
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        html.dark ::-webkit-scrollbar-thumb { background: #555; }
        html.dark ::-webkit-scrollbar-thumb:hover { background: #888; }

        .nav-link.active {
            background-color: var(--sidebar-active-bg);
            color: var(--sidebar-active-text) !important;
        }
        
        .player-element {
            background-color: #374151;
            color: #ffffff;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            white-space: nowrap; 
            width: auto; 
            display: inline-flex;
            align-items: center;
            flex-grow: 0;
            user-select: none;
        }
        .player-element:hover {
            transform: scale(1.05);
        }
        
        .player-list-container {
             background-color: var(--bg-muted);
             align-content: flex-start;
        }
        
        .match-item.no-result { border-left-color: var(--danger-color); }
        .match-item.has-result { border-left-color: var(--success-color); }
        html.dark .match-item.no-result { background-color: rgba(239, 68, 68, 0.1); }
        html.dark .match-item.has-result { background-color: rgba(16, 185, 129, 0.1); }
        .match-item.selected { 
            border-color: var(--accent-color); 
            box-shadow: 0 0 0 2px var(--accent-color);
        }
        
        .selectable-row:hover { background-color: #f9fafb !important; }
        html.dark .selectable-row:hover { background-color: #1f2937 !important; }
        .selectable-row.selected { background-color: #eef2ff !important; }
        html.dark .selectable-row.selected { background-color: #3730a3 !important; }
        
        .tt-player-item.selected {
            background-color: var(--accent-color);
            color: var(--sidebar-active-text);
            border-color: var(--accent-color-hover);
        }
        .tt-player-item.selected span, .tt-player-item.selected i {
            color: var(--sidebar-active-text);
        }
        
        thead th { 
            color: var(--text-secondary); 
            position: sticky;
            top: 0;
            border-bottom: 2px solid var(--border-color);
        }
        html.dark thead th { color: var(--sidebar-text); }

        /* FIX: Solid background for sticky table header */
        #players-management-table-container thead th,
        #user-management-table-container thead th {
            background-color: var(--bg-muted);
        }
        html.dark #players-management-table-container thead th,
        html.dark #user-management-table-container thead th {
            background-color: #111827;
        }
        
        thead th[data-sort-by]:hover {
            background-color: var(--border-color);
        }
        html.dark thead th[data-sort-by]:hover {
            background-color: var(--sidebar-hover-bg);
        }
        
        .button-primary { background-color: var(--accent-color); color: var(--button-text-color); }
        .button-primary:hover { background-color: var(--accent-color-hover); }
        .button-success { background-color: var(--success-color); color: var(--button-text-color); }
        .button-danger { background-color: var(--danger-color); color: var(--button-text-color); }
        .button-warning { background-color: var(--warning-color); color: var(--button-text-color); }
        .button-secondary { background-color: var(--text-secondary); color: var(--button-text-color); }
        .button-purple { background-color: #9333ea; color: var(--button-text-color); }
        .button-purple:hover { background-color: #7e22ce; }

        .bg-success-color { background-color: var(--success-color); }
        .bg-danger-color { background-color: var(--danger-color); }
        .bg-warning-color { background-color: var(--warning-color); }

        body.logged-out #app-container { display: none; }
        .login-bg { background: #f0f2f5; }
        html.dark .login-bg { background: linear-gradient(165deg, #0f172a 0%, #1e293b 100%); }
        
        #mobile-menu {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
        }

        header.md\:hidden {
            background-color: var(--bg-secondary);
        }
        html.dark header.md\:hidden {
            background-color: var(--sidebar-bg);
        }

        .collapsible-toggle-button {
            background: linear-gradient(to right, var(--accent-color), var(--accent-color-hover));
            color: var(--button-text-color);
            transition: background 0.3s ease;
        }
        .collapsible-toggle-button.visible-content {
            background: linear-gradient(to right, #e53e3e, var(--danger-color));
        }

        html:not(.dark) .nav-link:not(.active):hover {
            background-color: #e5e7eb;
        }
        html:not(.dark) .dropdown-item:hover {
            background-color: #e5e7eb;
        }

        html.dark .nav-link:not(.active):hover {
            background-color: var(--sidebar-hover-bg);
        }
        html.dark .dropdown-item:hover {
            background-color: #374151;
        }
        
        .sidebar-group-header {
            background-color: var(--bg-muted);
            border-bottom: 1px solid var(--border-color);
        }
        html.dark .sidebar-group-header {
            background-color: #111827;
        }

        .nav-link-dashboard {
            background: linear-gradient(to right, var(--warning-color), #f97316);
            color: var(--button-text-color) !important;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-link-dashboard:hover {
            opacity: 0.9;
        }
        html.dark .nav-link-dashboard {
            background: linear-gradient(to right, #d97706, #ea580c);
        }
        
        .dashboard-card-body p {
            min-height: 40px;
        }
        
        #dashboard-modal-content {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .button-edit {
            background-color: var(--bg-muted);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            font-weight: 600;
        }
        .button-edit:hover {
            background-color: var(--border-color);
        }
        html.dark .button-edit {
            background-color: #374151;
            color: var(--sidebar-text);
            border-color: #4b5563;
        }
        html.dark .button-edit:hover {
            background-color: #4b5563;
        }

        .icon-resultado { color: var(--success-color); }
        .icon-chamigo { color: var(--warning-color); }
        .icon-tt { color: #9333ea; }

        /* Cropper.js specific styles */
        #cropper-container {
            width: 100%;
            height: 40vh;
            max-height: 300px;
            background-color: var(--bg-muted);
        }
        #cropper-image {
            display: block;
            max-width: 100%;
        }
        
    </style>
    
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="antialiased">

    <!-- Main Application Container -->
    <div id="app-container" class="flex min-h-screen hidden">
        <!-- Sidebar for Desktop -->
        <aside id="sidebar" class="w-64 flex-col hidden md:flex shrink-0">
            <div class="px-6 py-4 flex items-center">
                <a href="#" class="text-xl font-bold flex items-center gap-2">
                    <span class="text-2xl">⚽</span>
                    <span>LA CLANDE</span>
                </a>
            </div>
            
            <nav id="main-nav" class="flex-1 px-4 space-y-2 overflow-y-auto">
                <!-- Los enlaces de navegación se insertan aquí con JS -->
            </nav>
        </aside>

        <!-- Main content wrapper -->
        <div class="flex-1 flex flex-col">
            <!-- Mobile Header -->
            <header class="flex items-center justify-between p-4 border-b border-border-color md:hidden sticky top-0 z-30 bg-secondary dark:bg-sidebar-bg">
                <div class="w-10">
                     <button id="mobile-menu-toggle" class="p-2 rounded-md -ml-2">
                        <i class="fas fa-bars text-lg"></i>
                    </button>
                </div>
                <div class="flex-1 text-center">
                    <a href="#" class="text-xl font-bold flex items-center gap-2 justify-center">
                        <span class="text-2xl">⚽</span>
                        <span>LA CLANDE</span>
                    </a>
                </div>
                <div id="mobile-user-menu-container" class="w-10 relative flex justify-end items-center">
                    <!-- El menú de usuario para móvil se insertará aquí -->
                </div>
            </header>
            
            <!-- Desktop Header -->
            <header class="hidden md:flex items-center justify-between p-4 border-b border-border-color bg-gradient-to-r from-indigo-500 to-purple-500 dark:from-indigo-700 dark:to-purple-700 shadow-lg shrink-0">
                <div class="w-1/3"></div> <!-- Spacer -->
                <div class="w-1/3 text-center text-2xl font-bold text-white uppercase tracking-wider">
                    <span id="desktop-header-title"></span>
                </div>
                <div id="user-menu-container" class="w-1/3 relative flex justify-end">
                    <!-- El menú de usuario para desktop se insertará aquí -->
                </div>
            </header>

            <!-- Main content -->
            <main class="flex-1 bg-secondary overflow-y-auto">
                <div id="admin-content-area" class="h-full">
                    <div id="loading-container" class="flex items-center justify-center h-64 p-4">
                        <i class="fas fa-spinner fa-spin text-4xl text-accent-color"></i>
                    </div>
                    <div id="admin-content" class="hidden h-full">
                        <!-- El contenido dinámico de cada sección se renderiza aquí -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Menú móvil -->
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>
    <div id="mobile-menu" class="hidden fixed top-0 left-0 h-full w-64 bg-secondary shadow-xl z-50 transform -translate-x-full transition-transform duration-300 ease-in-out">
        <!-- El contenido del menú móvil se inserta aquí con JS -->
    </div>

    <!-- Contenedor de autenticación -->
    <div id="auth-container" class="hidden fixed inset-0 z-50 flex items-center justify-center login-bg">
        <div class="w-full max-w-md p-4">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-text-secondary">Panel de Administración</h1>
                <h2 class="text-4xl font-extrabold text-text-primary mt-2 flex items-center justify-center gap-3">
                    <span>LA CLANDE ⚽</span>
                </h2>
            </div>
            <div class="card card-styled p-8 relative">
                <div class="absolute top-4 right-4">
                    <button id="login-dark-mode-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 theme-toggle-button">
                        <i class="fas fa-moon text-lg text-text-secondary"></i>
                    </button>
                </div>
                <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="email" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium mb-1">Contraseña</label>
                        <div class="relative">
                            <input type="password" id="password" class="w-full p-2 border rounded-md pr-10" required>
                            <button type="button" id="password-toggle" class="absolute inset-y-0 right-0 px-3 flex items-center text-text-secondary">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button id="login-button" type="submit" class="w-full px-6 py-3 button-primary font-semibold rounded-lg shadow-md transition duration-300">
                        Entrar
                    </button>
                    <div class="text-center mt-4">
                        <a href="recuperar-pass.html" class="text-sm text-accent-color hover:underline">¿Olvidaste tu contraseña?</a>
                    </div>
                    <p id="auth-status" class="text-center text-danger-color mt-4 h-5"></p>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modales -->
    <div id="notification-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-[100] p-4">
        <div id="notification-content" class="flex items-center gap-4 text-white font-semibold p-6 rounded-lg shadow-xl max-w-sm w-full">
            <i id="notification-icon" class="fas fa-2x"></i>
            <span id="notification-message"></span>
        </div>
    </div>

    <div id="custom-confirm-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card card-styled p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-2" id="modal-title">Confirmar Acción</h3>
            <p class="text-secondary mb-6" id="modal-message">¿Estás seguro?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-button" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">Cancelar</button>
                <button id="modal-confirm-button" class="px-4 py-2 button-danger font-semibold rounded-md hover:opacity-90 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="player-assignment-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card card-styled p-6 text-center w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-2" id="assign-modal-title">Asignar Jugador</h3>
            <p class="text-secondary mb-6" id="assign-modal-player-name">Nombre del Jugador</p>
            <div class="flex flex-col space-y-3">
                <button id="assign-to-claros" class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-100 text-black font-semibold rounded-md hover:opacity-90 transition">Mover a Claros</button>
                <button id="assign-to-oscuros" class="w-full px-4 py-2 bg-gray-900 border border-gray-700 text-white font-semibold rounded-md hover:bg-gray-700 transition">Mover a Oscuros</button>
                <button id="assign-modal-cancel" class="mt-4 text-sm text-secondary hover:underline">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="player-team-options-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card card-styled p-6 text-center w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-2">Opciones de Jugador</h3>
            <p class="text-secondary mb-6" id="options-modal-player-name">Nombre del Jugador</p>
            <div class="flex flex-col space-y-3">
                <button id="move-between-teams-btn" class="w-full px-4 py-2 button-primary font-semibold rounded-md hover:opacity-90 transition">Mover a...</button>
                <button id="return-player-btn" class="w-full px-4 py-2 button-warning font-semibold rounded-md hover:opacity-90 transition">Devolver a Lista</button>
                <button id="cancel-player-options-btn" class="mt-4 text-sm text-secondary hover:underline">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="change-name-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card card-styled p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Cambiar Nombre</h3>
            <form id="change-name-form">
                <label for="new-user-name" class="block text-sm font-medium mb-1">Nuevo nombre de usuario</label>
                <input type="text" id="new-user-name" class="w-full p-2 border rounded-md mb-4" required>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="change-name-cancel" class="px-4 py-2 button-danger font-semibold rounded-md hover:opacity-90 transition">Cancelar</button>
                    <button type="submit" class="px-4 py-2 button-primary font-semibold rounded-md hover:opacity-90 transition">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="change-password-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card card-styled p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Cambiar Contraseña</h3>
            <form id="change-password-form" class="space-y-4">
                <div>
                    <label for="new-password-modal-input" class="block text-sm font-medium mb-1">Nueva Contraseña</label>
                    <div class="relative">
                        <input type="password" id="new-password-modal-input" class="w-full p-2 border rounded-md pr-10" required placeholder="Mínimo 8 caracteres">
                        <button type="button" class="password-modal-toggle absolute inset-y-0 right-0 px-3 flex items-center text-text-secondary">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="confirm-new-password-modal-input" class="block text-sm font-medium mb-1">Confirmar Nueva Contraseña</label>
                    <div class="relative">
                        <input type="password" id="confirm-new-password-modal-input" class="w-full p-2 border rounded-md pr-10" required>
                        <button type="button" class="password-modal-toggle absolute inset-y-0 right-0 px-3 flex items-center text-text-secondary">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="change-password-cancel" class="px-4 py-2 button-danger font-semibold rounded-md hover:opacity-90 transition">Cancelar</button>
                    <button type="submit" class="px-4 py-2 button-primary font-semibold rounded-md hover:opacity-90 transition">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Dashboard Modal -->
    <div id="dashboard-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card card-styled transform transition-all scale-95 opacity-0 w-full max-w-lg" id="dashboard-modal-content">
            <div class="flex justify-between items-center p-4 border-b border-border-color">
                <h3 class="text-xl font-semibold" id="dashboard-modal-title"></h3>
                <button id="dashboard-modal-close" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto" id="dashboard-modal-body">
                <!-- Dynamic content goes here -->
            </div>
            <div class="p-4 bg-muted flex justify-end space-x-3" id="dashboard-modal-footer">
                <!-- Dynamic buttons go here -->
            </div>
        </div>
    </div>

    <!-- Avatar Upload Modal -->
    <div id="avatar-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card card-styled p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">Cambiar Foto de Perfil</h3>
            
            <form id="avatar-upload-form">
                <label for="avatar-file-input" class="flex justify-center mb-4 cursor-pointer group">
                    <div class="relative">
                        <img id="avatar-preview" src="https://placehold.co/128x128/e2e8f0/64748b?text=Avatar" alt="Vista previa del avatar" class="w-32 h-32 rounded-full object-cover border-4 border-border-color group-hover:opacity-75 transition-opacity">
                        <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-camera text-white text-2xl"></i>
                        </div>
                    </div>
                </label>

                <input type="file" id="avatar-file-input" class="hidden" accept="image/png, image/jpeg">
                
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <button type="button" id="avatar-cancel-button" class="w-full px-4 py-2 button-danger font-semibold rounded-md hover:opacity-90 transition">Cancelar</button>
                    <button type="submit" id="avatar-save-button" class="w-full px-4 py-2 button-success font-semibold rounded-md hover:opacity-90 transition" disabled>Guardar Foto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- === INICIO: Modal para Recortar Imagen === -->
    <div id="cropper-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-[60] p-4">
        <div class="card card-styled p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Editar Foto</h3>
            <div id="cropper-container" class="mb-4">
                <img id="cropper-image" src="">
            </div>
            <div class="flex items-center justify-center space-x-4 mb-4">
                <label for="zoom-slider" class="text-sm font-medium">Zoom:</label>
                <input id="zoom-slider" type="range" min="0" max="1" step="0.01" class="w-full">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cropper-cancel-button" class="px-4 py-2 button-secondary font-semibold rounded-md">Cancelar</button>
                <button id="cropper-save-button" class="px-4 py-2 button-success font-semibold rounded-md">Recortar y Guardar</button>
            </div>
        </div>
    </div>
    <!-- === FIN: Modal para Recortar Imagen === -->
 
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & STATE ---
        const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        let cropper = null;
        let cropperContext = 'player'; // 'player' or 'avatar'
        
        const AppState = {
            players: [],
            matches: [],
            users: [],
            userRole: null,
            userName: null,
            userEmail: null,
            avatarUrl: null,
            selectedMatchId: null,
            isInitialized: false,
            isInitializing: false,
            activePlayerElement: null,
            realtimeChannel: null,
            heartbeatInterval: null,
            selectedPhotoFile: null,
            selectedAvatarFile: null // Para el archivo recortado del perfil de usuario
        };
        
        // Sorting state for tables
        let playerSortState = { key: 'id', dir: 'asc' };
        let userSortState = { key: 'email', dir: 'asc' };

        const NAV_ITEMS = {
            dashboard: [
                { id: 'dashboard', name: 'Dashboard', icon: 'fa-tachometer-alt' }
            ],
            main: [
                { id: 'team-formation', name: 'Armar Equipos', icon: 'fa-users-cog' },
                { id: 'match-results', name: 'Resultados', icon: 'fa-trophy' },
                { id: 'chamigo-management', name: 'Chamigo', icon: 'fa-star' },
                { id: 'tt-attendance', name: 'Asistencia TT', icon: 'fa-beer' },
            ],
            admin: [
                { id: 'edit-match', name: 'Editar Partido', icon: 'fa-edit' },
                { id: 'players-management', name: 'ABM Jugadores', icon: 'fa-user-plus' },
                { id: 'user-management', name: 'ABM Usuarios', icon: 'fa-user-shield' },
            ],
            links: [
                { href: 'index.html', name: 'Ver Estadísticas', icon: 'fa-chart-line' }
            ]
        };

        const DOMElements = {
            body: document.body,
            appContainer: document.getElementById('app-container'),
            mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
            mobileMenu: document.getElementById('mobile-menu'),
            mobileMenuOverlay: document.getElementById('mobile-menu-overlay'),
            mainNav: document.getElementById('main-nav'),
            authContainer: document.getElementById('auth-container'),
            adminContent: document.getElementById('admin-content'),
            loadingContainer: document.getElementById('loading-container'),
            loginForm: document.getElementById('login-form'),
            authStatus: document.getElementById('auth-status'),
            modal: document.getElementById('custom-confirm-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirm: document.getElementById('modal-confirm-button'),
            modalCancel: document.getElementById('modal-cancel-button'),
            playerAssignmentModal: document.getElementById('player-assignment-modal'),
            assignModalPlayerName: document.getElementById('assign-modal-player-name'),
            assignToClarosBtn: document.getElementById('assign-to-claros'),
            assignToOscurosBtn: document.getElementById('assign-to-oscuros'),
            assignModalCancelBtn: document.getElementById('assign-modal-cancel'),
            playerTeamOptionsModal: document.getElementById('player-team-options-modal'),
            optionsModalPlayerName: document.getElementById('options-modal-player-name'),
            moveBetweenTeamsBtn: document.getElementById('move-between-teams-btn'),
            returnPlayerBtn: document.getElementById('return-player-btn'),
            cancelPlayerOptionsBtn: document.getElementById('cancel-player-options-btn'),
            notificationModal: document.getElementById('notification-modal'),
            notificationContent: document.getElementById('notification-content'),
            notificationIcon: document.getElementById('notification-icon'),
            notificationMessage: document.getElementById('notification-message'),
            changeNameModal: document.getElementById('change-name-modal'),
            changePasswordModal: document.getElementById('change-password-modal'),
            changeNameForm: document.getElementById('change-name-form'),
            changePasswordForm: document.getElementById('change-password-form'),
            dashboardModal: document.getElementById('dashboard-modal'),
            dashboardModalContent: document.getElementById('dashboard-modal-content'),
            dashboardModalTitle: document.getElementById('dashboard-modal-title'),
            dashboardModalBody: document.getElementById('dashboard-modal-body'),
            dashboardModalFooter: document.getElementById('dashboard-modal-footer'),
            dashboardModalClose: document.getElementById('dashboard-modal-close'),
        };

        function init() {
            setupTheme();
            setupEventListeners();
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' || (event === 'INITIAL_SESSION' && session)) {
                    if (!AppState.isInitialized) loadAdminPanel(session);
                } 
                else if (event === 'SIGNED_OUT' || (event === 'INITIAL_SESSION' && !session)) {
                    showLoginScreen();
                    if (AppState.realtimeChannel) {
                        supabase.removeChannel(AppState.realtimeChannel);
                        AppState.realtimeChannel = null;
                        clearInterval(AppState.heartbeatInterval);
                    }
                }
            });
        }

        async function loadAdminPanel(session) {
            if (AppState.isInitializing) return;
            AppState.isInitializing = true;
            DOMElements.body.classList.remove('logged-out');
            
            DOMElements.authContainer.classList.add('hidden');
            DOMElements.appContainer.classList.remove('hidden');
            DOMElements.loadingContainer.classList.remove('hidden');
            DOMElements.adminContent.classList.add('hidden');
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                const { data: profile } = await supabase.from('profiles').select('role, name, avatar_url').eq('id', user.id).single();
                
                AppState.userRole = profile ? profile.role : null;
                AppState.userName = profile?.name || user.user_metadata?.name || user.email.split('@')[0];
                AppState.userEmail = user.email;
                AppState.avatarUrl = profile?.avatar_url || null;

                const [playersRes, matchesRes, usersRes] = await Promise.allSettled([
                    supabase.from('players').select('*').order('id', { ascending: true }),
                    supabase.from('matches').select('*').order('match_date', { ascending: false }),
                    AppState.userRole === 'Admin' ? supabase.rpc('get_all_users_with_roles') : Promise.resolve({ data: [], error: null })
                ]);

                AppState.players = (playersRes.status === 'fulfilled' && !playersRes.value.error) ? (playersRes.value.data || []) : [];
                if (playersRes.value?.error) showNotification("Error al cargar jugadores.", "error");

                AppState.matches = (matchesRes.status === 'fulfilled' && !matchesRes.value.error) ? (matchesRes.value.data || []) : [];
                if (matchesRes.value?.error) showNotification("Error al cargar partidos.", "error");
                
                if (AppState.userRole === 'Admin') {
                    AppState.users = (usersRes.status === 'fulfilled' && usersRes.value && !usersRes.value.error) ? (usersRes.value.data || []) : [];
                    if (usersRes.value?.error) showNotification("Error al cargar usuarios (Admin).", "error");
                }

                setupUI();
                
                setupRealtimeSubscriptions();
                
                const savedTab = localStorage.getItem('lastAdminTab');
                const allNavItems = [...NAV_ITEMS.dashboard, ...NAV_ITEMS.main, ...NAV_ITEMS.admin];
                const isValidTab = allNavItems.some(item => item.id === savedTab);
                let initialTab = NAV_ITEMS.dashboard[0].id;

                if (isValidTab) {
                    const isAdminTab = NAV_ITEMS.admin.some(item => item.id === savedTab);
                    if (!isAdminTab || (isAdminTab && AppState.userRole === 'Admin')) {
                        initialTab = savedTab;
                    }
                }
                await navigateTo(initialTab);

            } catch (error) {
                console.error("Fatal error during admin panel setup:", error);
                showNotification("Ocurrió un error inesperado al cargar el panel.", "error");
                await supabase.auth.signOut();
            } finally {
                DOMElements.loadingContainer.classList.add('hidden');
                DOMElements.adminContent.classList.remove('hidden');
                AppState.isInitializing = false;
                AppState.isInitialized = true;
                window.scrollTo(0, 0);
            }
        }
        
        async function refreshDataAndRender(tabToRender) {
            try {
                const [playersRes, matchesRes] = await Promise.all([
                    supabase.from('players').select('*').order('id', { ascending: true }),
                    supabase.from('matches').select('*').order('match_date', { ascending: false })
                ]);

                if (playersRes.error || matchesRes.error) {
                    throw playersRes.error || matchesRes.error;
                }

                AppState.players = playersRes.data || [];
                AppState.matches = matchesRes.data || [];
                
                if (AppState.userRole === 'Admin') {
                    const { data, error } = await supabase.rpc('get_all_users_with_roles');
                    if (!error) AppState.users = data || [];
                }

                if (tabToRender) {
                    await navigateTo(tabToRender);
                }

            } catch (error) {
                showNotification(`Error al refrescar los datos: ${error.message}`, 'error');
            }
        }

        function setupRealtimeSubscriptions() {
            if (AppState.realtimeChannel) {
                supabase.removeChannel(AppState.realtimeChannel);
                AppState.realtimeChannel = null;
            }
            clearInterval(AppState.heartbeatInterval);
            
            console.log('Setting up Realtime subscriptions...');

            const handleChanges = (payload) => {
                console.log('Change received!', payload);
                const { table, eventType, new: newRecord, old: oldRecord } = payload;
                
                let dataArray;
                
                switch(table) {
                    case 'players': dataArray = AppState.players; break;
                    case 'matches': dataArray = AppState.matches; break;
                    case 'profiles': dataArray = AppState.users; break;
                    default: return;
                }

                if (eventType === 'INSERT') {
                    if (!dataArray.some(item => item.id === newRecord.id)) {
                        dataArray.push(newRecord);
                    }
                } else if (eventType === 'UPDATE') {
                    const index = dataArray.findIndex(item => item.id === newRecord.id);
                    if (index !== -1) {
                        dataArray[index] = { ...dataArray[index], ...newRecord };
                    } else {
                        dataArray.push(newRecord);
                    }
                } else if (eventType === 'DELETE') {
                    const idToDelete = oldRecord.id;
                    const index = dataArray.findIndex(item => item.id === idToDelete);
                    if (index !== -1) {
                        dataArray.splice(index, 1);
                    }
                }

                if (table === 'matches') {
                    AppState.matches.sort((a, b) => new Date(b.match_date) - new Date(a.match_date));
                }
                
                const currentTab = localStorage.getItem('lastAdminTab');
                if (currentTab) {
                    navigateTo(currentTab);
                }
            };
            
            const channel = supabase.channel('public:admin_changes', {
                config: {
                    broadcast: { ack: true }
                }
            });

            const startHeartbeat = () => {
                clearInterval(AppState.heartbeatInterval);
                AppState.heartbeatInterval = setInterval(() => {
                    if (channel.state === 'joined') {
                        channel.send({
                            type: 'broadcast',
                            event: 'heartbeat',
                            payload: { message: 'alive' },
                        });
                        console.log('Realtime heartbeat sent.');
                    }
                }, 30000);
            };

            const stopHeartbeat = () => {
                clearInterval(AppState.heartbeatInterval);
            };

            channel
                .on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, handleChanges)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, handleChanges)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, handleChanges)
                .subscribe((status, err) => {
                    console.log(`Realtime status: ${status}`);
                    if (status === 'SUBSCRIBED') {
                        console.log('Realtime channel subscribed successfully!');
                        startHeartbeat();
                    } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                        console.error(`Realtime channel issue: ${status}`, err);
                        stopHeartbeat();
                        setTimeout(() => setupRealtimeSubscriptions(), 5000); 
                    } else if (status === 'CLOSED') {
                        console.warn('Realtime channel closed.');
                        stopHeartbeat();
                    }
                });

            AppState.realtimeChannel = channel;
        }
        
        function showLoginScreen() {
            AppState.isInitialized = false;
            DOMElements.body.classList.add('logged-out');
            DOMElements.appContainer.classList.add('hidden');
            DOMElements.loadingContainer.classList.add('hidden');
            DOMElements.adminContent.classList.add('hidden');
            DOMElements.authContainer.classList.remove('hidden');
            DOMElements.mobileMenu.classList.remove('translate-x-0');
            DOMElements.mobileMenu.classList.add('-translate-x-full');
            DOMElements.mobileMenuOverlay.classList.add('hidden');

            const loginButton = document.getElementById('login-button');
            if (loginButton) {
                loginButton.disabled = false;
                loginButton.innerHTML = 'Entrar';
            }
            DOMElements.loginForm.reset();
            DOMElements.authStatus.textContent = '';
        }

        function setupTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            }
            document.body.addEventListener('click', e => {
                if (e.target.closest('.theme-toggle-button')) {
                    toggleTheme();
                }
            });
        }

        function toggleTheme() {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
        }

        function updateThemeToggleIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            const toggleButtons = document.querySelectorAll('.theme-toggle-button');

            toggleButtons.forEach(btn => {
                if (btn) {
                    const icon = btn.querySelector('i');
                    const span = btn.querySelector('span');
                    if(icon) {
                        icon.classList.toggle('fa-moon', !isDark);
                        icon.classList.toggle('fa-sun', isDark);
                    }
                    if (span) {
                        span.textContent = isDark ? 'Modo Claro' : 'Modo Oscuro';
                    }
                }
            });
        }

        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            localStorage.setItem('theme', theme);
            updateThemeToggleIcons();

            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                if (theme === 'dark') {
                    sidebar.classList.add('bg-sidebar-bg', 'text-sidebar-text');
                    sidebar.classList.remove('bg-secondary', 'text-text-primary', 'border-r', 'border-border-color');
                } else {
                    sidebar.classList.remove('bg-sidebar-bg', 'text-sidebar-text');
                    sidebar.classList.add('bg-secondary', 'text-text-primary', 'border-r', 'border-border-color');
                }
            }
        }

        function setupUI() {
            setupDesktopNav();
            setupMobileMenu();
            setupUserMenu();
        }
        
        function setupDesktopNav() {
            let dashboardLink = NAV_ITEMS.dashboard.map(item => `
                <a href="#" data-tab="${item.id}" class="nav-link nav-link-dashboard w-full text-left flex items-center gap-3 px-4 py-3 mb-2 rounded-lg transition-colors duration-200">
                    <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                </a>
            `).join('');

            let navHtml = `${dashboardLink}
                <div>
                    <button class="collapsible-trigger sidebar-group-header w-full flex justify-between items-center px-4 py-2.5 text-left font-semibold rounded-lg">
                        <span class="flex items-center gap-3"><i class="fas fa-cogs w-5 text-center"></i>Principal</span>
                        <i class="fas fa-chevron-down transform transition-transform"></i>
                    </button>
                    <div class="collapsible-content mt-1 space-y-1 pl-4">
                        ${NAV_ITEMS.main.map(item => `
                            <a href="#" data-tab="${item.id}" class="nav-link w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200">
                                <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                            </a>`).join('')}
                    </div>
                </div>`;
            
            if (AppState.userRole === 'Admin') {
                navHtml += `
                    <div class="mt-2" data-role="Admin">
                        <button class="collapsible-trigger sidebar-group-header w-full flex justify-between items-center px-4 py-2.5 text-left font-semibold rounded-lg">
                            <span class="flex items-center gap-3"><i class="fas fa-user-shield w-5 text-center"></i>Administración</span>
                            <i class="fas fa-chevron-down transform transition-transform"></i>
                        </button>
                        <div class="collapsible-content hidden mt-1 space-y-1 pl-4">
                            ${NAV_ITEMS.admin.map(item => `
                                <a href="#" data-tab="${item.id}" class="nav-link w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200">
                                    <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                                </a>`).join('')}
                        </div>
                    </div>`;
            }

            navHtml += `
                <div class="mt-2">
                     <button class="collapsible-trigger sidebar-group-header w-full flex justify-between items-center px-4 py-2.5 text-left font-semibold rounded-lg">
                        <span class="flex items-center gap-3"><i class="fas fa-link w-5 text-center"></i>Enlaces</span>
                        <i class="fas fa-chevron-down transform transition-transform"></i>
                    </button>
                    <div class="collapsible-content hidden mt-1 space-y-1 pl-4">
                        ${NAV_ITEMS.links.map(item => `
                            <a href="${item.href}" target="_blank" rel="noopener noreferrer" class="nav-link w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200">
                                <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                            </a>`).join('')}
                    </div>
                </div>`;

            DOMElements.mainNav.innerHTML = navHtml;
            
            DOMElements.mainNav.querySelectorAll('.nav-link[data-tab]').forEach(link => {
                link.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await navigateTo(e.currentTarget.dataset.tab);
                });
            });

            DOMElements.mainNav.querySelectorAll('.collapsible-trigger').forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const content = trigger.nextElementSibling;
                    const icon = trigger.querySelector('i.fa-chevron-down');
                    content.classList.toggle('hidden');
                    icon?.classList.toggle('rotate-180');
                });
            });
            
            DOMElements.mainNav.querySelector('.collapsible-content').classList.remove('hidden');
            DOMElements.mainNav.querySelector('.collapsible-trigger i.fa-chevron-down').classList.add('rotate-180');
        }
        
        function setupMobileMenu() {
            const dashboardLinkMobile = NAV_ITEMS.dashboard.map(item => `
                <li>
                    <a href="#" data-tab="${item.id}" class="nav-link nav-link-dashboard block px-4 py-3 rounded-md mb-2">
                        ${item.name}
                    </a>
                </li>`).join('');

            const adminItemsHtml = AppState.userRole === 'Admin' ? `
                <div class="mt-2">
                    <button class="collapsible-trigger sidebar-group-header w-full flex justify-between items-center px-4 py-2.5 text-left font-semibold rounded-lg">
                        <span class="flex items-center gap-3"><i class="fas fa-user-shield w-5 text-center"></i>Administración</span>
                        <i class="fas fa-chevron-down transform transition-transform"></i>
                    </button>
                    <ul class="collapsible-content hidden mt-1 space-y-1 pl-4">
                        ${NAV_ITEMS.admin.map(item => `<li><a href="#" data-tab="${item.id}" class="nav-link block px-4 py-2.5 rounded-md">${item.name}</a></li>`).join('')}
                    </ul>
                </div>` : '';

            const menuHtml = `
                <div class="p-4 flex justify-between items-center border-b border-border-color">
                    <span class="font-bold">Menú</span>
                    <button id="close-mobile-menu" class="p-2 -mr-2"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-2 space-y-1">
                    <ul>${dashboardLinkMobile}</ul>
                    <div>
                        <button class="collapsible-trigger sidebar-group-header w-full flex justify-between items-center px-4 py-2.5 text-left font-semibold rounded-lg">
                            <span class="flex items-center gap-3"><i class="fas fa-cogs w-5 text-center"></i>Principal</span>
                            <i class="fas fa-chevron-down transform transition-transform rotate-180"></i>
                        </button>
                        <ul class="collapsible-content mt-1 space-y-1 pl-4">
                            ${NAV_ITEMS.main.map(item => `<li><a href="#" data-tab="${item.id}" class="nav-link block px-4 py-2.5 rounded-md">${item.name}</a></li>`).join('')}
                        </ul>
                    </div>
                    ${adminItemsHtml}
                    <div class="mt-2">
                         <button class="collapsible-trigger sidebar-group-header w-full flex justify-between items-center px-4 py-2.5 text-left font-semibold rounded-lg">
                            <span class="flex items-center gap-3"><i class="fas fa-link w-5 text-center"></i>Enlaces</span>
                            <i class="fas fa-chevron-down transform transition-transform"></i>
                        </button>
                        <ul class="collapsible-content hidden mt-1 space-y-1 pl-4">
                            ${NAV_ITEMS.links.map(item => `<li><a href="${item.href}" target="_blank" rel="noopener noreferrer" class="nav-link block px-4 py-2.5 rounded-md">${item.name}</a></li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            DOMElements.mobileMenu.innerHTML = menuHtml;
            
            DOMElements.mobileMenu.querySelectorAll('.nav-link[data-tab]').forEach(link => {
                link.addEventListener('click', async e => {
                    e.preventDefault();
                    e.stopPropagation();
                    await navigateTo(e.currentTarget.dataset.tab);
                    closeMobileMenu();
                });
            });
            
            DOMElements.mobileMenu.querySelectorAll('.collapsible-trigger').forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const content = trigger.nextElementSibling;
                    const icon = trigger.querySelector('i.fa-chevron-down');
                    content.classList.toggle('hidden');
                    icon?.classList.toggle('rotate-180');
                });
            });
            
            document.getElementById('close-mobile-menu').addEventListener('click', closeMobileMenu);
        }
        
        async function navigateTo(tabId) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.tab === tabId);
            });
            
            const desktopTitleEl = document.getElementById('desktop-header-title');
            const allNavItems = [...NAV_ITEMS.dashboard, ...NAV_ITEMS.main, ...NAV_ITEMS.admin];
            const currentItem = allNavItems.find(item => item.id === tabId);
            if (desktopTitleEl && currentItem) {
                desktopTitleEl.textContent = currentItem.name;
            }

            const renderFunction = window[`render_${tabId.replace(/-/g, '_')}`];
            if (typeof renderFunction === 'function') {
                renderFunction();
                localStorage.setItem('lastAdminTab', tabId);
            } else {
                DOMElements.adminContent.innerHTML = `<div class="p-4 sm:p-6 lg:p-8"><div class="card card-styled p-6"><h1 class="text-2xl font-bold">Contenido para ${tabId} no implementado.</h1></div></div>`;
            }
        }

        function openMobileMenu() {
            DOMElements.mobileMenuOverlay.classList.remove('hidden');
            DOMElements.mobileMenu.classList.remove('hidden');
            setTimeout(() => {
                 DOMElements.mobileMenu.classList.remove('-translate-x-full');
                 DOMElements.mobileMenu.classList.add('translate-x-0');
            }, 10);
        }

        function closeMobileMenu() {
            DOMElements.mobileMenu.classList.add('-translate-x-full');
            DOMElements.mobileMenu.classList.remove('translate-x-0');
            DOMElements.mobileMenuOverlay.classList.add('hidden');
        }

        function setupEventListeners() {
            DOMElements.mobileMenuToggle.addEventListener('click', openMobileMenu);
            DOMElements.mobileMenuOverlay.addEventListener('click', closeMobileMenu);
            
            DOMElements.loginForm.addEventListener('submit', handleLogin);
            
            document.addEventListener('click', async (e) => {
                if (e.target.closest('.signout-trigger')) {
                    await supabase.auth.signOut().catch(err => showNotification(`Error: ${err.message}`, 'error'));
                }
            });

            document.addEventListener('click', (e) => {
                const openDropdown = document.querySelector('.user-menu-dropdown:not(.hidden)');
                if (openDropdown && !e.target.closest('.user-menu-button') && !e.target.closest('.user-menu-dropdown')) {
                    openDropdown.classList.add('hidden');
                }
            });

            const passwordInput = document.getElementById('password');
            const passwordToggle = document.getElementById('password-toggle');
            if (passwordToggle && passwordInput) {
                passwordToggle.addEventListener('click', () => {
                    const isPassword = passwordInput.getAttribute('type') === 'password';
                    passwordInput.setAttribute('type', isPassword ? 'text' : 'password');
                    passwordToggle.querySelector('i').classList.toggle('fa-eye');
                    passwordToggle.querySelector('i').classList.toggle('fa-eye-slash');
                });
                passwordInput.addEventListener('blur', () => {
                    passwordInput.setAttribute('type', 'password');
                    passwordToggle.querySelector('i').classList.add('fa-eye');
                    passwordToggle.querySelector('i').classList.remove('fa-eye-slash');
                });
            }
            
            document.querySelectorAll('.password-modal-toggle').forEach(toggle => {
                const passwordInput = toggle.previousElementSibling;
                const icon = toggle.querySelector('i');
                if (passwordInput && icon) {
                    toggle.addEventListener('click', () => {
                        const isPassword = passwordInput.getAttribute('type') === 'password';
                        passwordInput.setAttribute('type', isPassword ? 'text' : 'password');
                        icon.classList.toggle('fa-eye');
                        icon.classList.toggle('fa-eye-slash');
                    });

                    passwordInput.addEventListener('blur', () => {
                        passwordInput.setAttribute('type', 'password');
                        icon.classList.add('fa-eye');
                        icon.classList.remove('fa-eye-slash');
                    });
                }
            });

            DOMElements.assignToClarosBtn.addEventListener('click', () => movePlayerToTeam('team-claros'));
            DOMElements.assignToOscurosBtn.addEventListener('click', () => movePlayerToTeam('team-oscuros'));
            DOMElements.assignModalCancelBtn.addEventListener('click', hidePlayerAssignmentModal);
            DOMElements.playerAssignmentModal.addEventListener('click', (e) => {
                if (e.target.id === 'player-assignment-modal') hidePlayerAssignmentModal();
            });

            DOMElements.playerTeamOptionsModal.addEventListener('click', (e) => {
                if (e.target.id === 'player-team-options-modal') hidePlayerTeamOptionsModal();
            });
            DOMElements.cancelPlayerOptionsBtn.addEventListener('click', hidePlayerTeamOptionsModal);
            DOMElements.returnPlayerBtn.addEventListener('click', handleReturnPlayer);
            DOMElements.moveBetweenTeamsBtn.addEventListener('click', handleMoveBetweenTeams);


            DOMElements.changeNameForm.addEventListener('submit', handleUpdateName);
            DOMElements.changePasswordForm.addEventListener('submit', handleUpdatePassword);
            document.getElementById('change-name-cancel').addEventListener('click', hideChangeNameModal);
            document.getElementById('change-password-cancel').addEventListener('click', hideChangePasswordModal);

            DOMElements.changeNameModal.addEventListener('click', (e) => {
                if (e.target.id === 'change-name-modal') hideChangeNameModal();
            });
            DOMElements.changePasswordModal.addEventListener('click', (e) => {
                if (e.target.id === 'change-password-modal') hideChangePasswordModal();
            });
            
            const avatarModal = document.getElementById('avatar-modal');
            if (avatarModal) {
                avatarModal.addEventListener('click', (e) => {
                    if (e.target.id === 'avatar-modal') {
                        hideAvatarModal();
                    }
                });

                document.getElementById('avatar-cancel-button').addEventListener('click', hideAvatarModal);
                document.getElementById('avatar-upload-form').addEventListener('submit', handleAvatarUpload);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const loginButton = document.getElementById('login-button');
            const passwordInput = document.getElementById('password');
            const passwordToggle = document.getElementById('password-toggle');

            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
            
            const { error } = await supabase.auth.signInWithPassword({ 
                email: document.getElementById('email').value, 
                password: passwordInput.value 
            });

            if (error) {
                DOMElements.authStatus.textContent = 'Email o contraseña incorrectos.';
                loginButton.disabled = false;
                loginButton.textContent = 'Entrar';
            }

            passwordInput.setAttribute('type', 'password');
            if (passwordToggle) {
                passwordToggle.querySelector('i').classList.add('fa-eye');
                passwordToggle.querySelector('i').classList.remove('fa-eye-slash');
            }
        }
        
        const cardTemplate = (title, body, additionalClasses = '') => `
            <div class="card overflow-hidden flex flex-col ${additionalClasses}">
                <h3 class="text-lg font-semibold text-center uppercase tracking-wider p-3 text-gray-800 bg-gray-200 dark:bg-gray-900 dark:text-gray-200 shrink-0">${title}</h3>
                <div class="p-6 flex-grow">${body}</div>
            </div>`;
        
        function setupUserMenu() {
            const desktopContainer = document.getElementById('user-menu-container');
            const mobileContainer = document.getElementById('mobile-user-menu-container');
            
            if (!desktopContainer || !mobileContainer) return;

            const userName = AppState.userName || 'Usuario';
            const userEmail = AppState.userEmail || 'email@example.com';
            const avatarPlaceholder = 'https://placehold.co/128x128/e2e8f0/64748b?text=⚽';
            const avatarSrc = AppState.avatarUrl ? `${AppState.avatarUrl}?t=${new Date().getTime()}` : avatarPlaceholder;

            const headerAvatarHTML = `<img src="${avatarSrc}" alt="Avatar de usuario" class="w-8 h-8 rounded-full object-cover border-2 border-white/50 hover:border-white transition-all">`;
            
            const dropdownAvatarHTML = `
                <div class="avatar-trigger mt-2 mb-3 flex justify-center cursor-pointer group">
                    <div class="relative">
                        <img src="${avatarSrc}" alt="Avatar de usuario" class="w-24 h-24 rounded-full object-cover border-4 border-border-color group-hover:opacity-75 transition-opacity">
                        <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-camera text-white text-3xl"></i>
                        </div>
                    </div>
                </div>
            `;

            const dropdownHTML = `
                <div class="user-menu-dropdown card card-styled hidden origin-top-right absolute right-0 top-full mt-2 w-64 rounded-md shadow-lg py-1 text-sm z-50">
                    <div class="px-4 py-2 border-b border-border-color text-center">
                        ${dropdownAvatarHTML}
                        <p class="font-semibold truncate text-text-primary text-base">${userName}</p>
                        <p class="text-xs text-text-secondary truncate">${userEmail}</p>
                    </div>
                    <div class="py-1">
                        <a href="#" class="change-name-trigger dropdown-item flex items-center gap-3 px-4 py-2 text-text-primary"><i class="fas fa-user-edit w-5 text-center"></i>Cambiar nombre</a>
                        <a href="#" class="change-password-trigger dropdown-item flex items-center gap-3 px-4 py-2 text-text-primary"><i class="fas fa-key w-5 text-center"></i>Cambiar contraseña</a>
                        <div class="border-t border-border-color my-1"></div>
                        <button class="theme-toggle-button dropdown-item w-full text-left flex items-center gap-3 px-4 py-2 text-text-primary">
                            <i class="fas fa-moon w-5 text-center"></i>
                            <span>Modo Oscuro</span>
                        </button>
                        <div class="border-t border-border-color my-1"></div>
                        <a href="#" class="signout-trigger dropdown-item flex items-center gap-3 px-4 py-2 text-danger-color">
                            <i class="fas fa-sign-out-alt w-5 text-center"></i>
                            <span>Cerrar Sesión</span>
                        </a>
                    </div>
                </div>
            `;

            desktopContainer.innerHTML = `
                <button class="user-menu-button flex items-center gap-3 p-1 rounded-full hover:bg-white/20 transition-colors">
                    <span class="font-semibold text-sm hidden sm:inline truncate max-w-[100px] text-white">${userName}</span>
                    ${headerAvatarHTML}
                </button>
                ${dropdownHTML}
            `;

            mobileContainer.innerHTML = `
                <button class="user-menu-button flex items-center">
                     ${headerAvatarHTML}
                </button>
                ${dropdownHTML}
            `;

            document.querySelectorAll('.user-menu-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.user-menu-dropdown').forEach(d => {
                        if (d !== button.nextElementSibling) d.classList.add('hidden');
                    });
                    button.nextElementSibling.classList.toggle('hidden');
                });
            });

            document.querySelectorAll('.avatar-trigger').forEach(trigger => {
                trigger.addEventListener('click', (e) => {
                    e.preventDefault();
                    trigger.closest('.user-menu-dropdown')?.classList.add('hidden');
                    showAvatarModal();
                });
            });

            document.querySelectorAll('.change-name-trigger').forEach(trigger => {
                trigger.addEventListener('click', (e) => {
                    e.preventDefault();
                    trigger.closest('.user-menu-dropdown').classList.add('hidden');
                    showChangeNameModal();
                });
            });
            
            document.querySelectorAll('.change-password-trigger').forEach(trigger => {
                 trigger.addEventListener('click', (e) => {
                    e.preventDefault();
                    trigger.closest('.user-menu-dropdown').classList.add('hidden');
                    showChangePasswordModal();
                });
            });
            
            updateThemeToggleIcons();
        }

        function showChangeNameModal() {
            const input = document.getElementById('new-user-name');
            input.value = AppState.userName;
            DOMElements.changeNameModal.classList.remove('hidden');
            DOMElements.body.classList.add('modal-open');
            setTimeout(() => input.select(), 50);
        }

        function hideChangeNameModal() {
            DOMElements.changeNameModal.classList.add('hidden');
            DOMElements.body.classList.remove('modal-open');
        }

        function showChangePasswordModal() {
            DOMElements.changePasswordForm.reset();
            DOMElements.changePasswordModal.classList.remove('hidden');
            DOMElements.body.classList.add('modal-open');
        }

        function hideChangePasswordModal() {
            DOMElements.changePasswordModal.classList.add('hidden');
            DOMElements.body.classList.remove('modal-open');
            const newPassInput = document.getElementById('new-password-modal-input');
            const confirmPassInput = document.getElementById('confirm-new-password-modal-input');
            newPassInput.setAttribute('type', 'password');
            confirmPassInput.setAttribute('type', 'password');
            document.querySelectorAll('.password-modal-toggle i').forEach(icon => {
                icon.classList.add('fa-eye');
                icon.classList.remove('fa-eye-slash');
            });
        }

        async function handleUpdateName(e) {
            e.preventDefault();
            const newName = document.getElementById('new-user-name').value.trim();
            if (!newName) {
                showNotification('El nombre no puede estar vacío.', 'error');
                return;
            }

            const { data: { user } } = await supabase.auth.getUser();

            const { error: profileError } = await supabase.from('profiles').update({ name: newName }).eq('id', user.id);
            const { data: updatedUser, error: authError } = await supabase.auth.updateUser({ data: { name: newName } });

            if (authError || profileError) {
                showNotification(`Error al actualizar el nombre: ${authError?.message || profileError?.message}`, 'error');
            } else {
                showNotification('Nombre actualizado con éxito.', 'success');
                AppState.userName = newName;
                hideChangeNameModal();
                setupUserMenu();
            }
        }

        async function handleUpdatePassword(e) {
            e.preventDefault();
            const newPassword = document.getElementById('new-password-modal-input').value;
            const confirmPassword = document.getElementById('confirm-new-password-modal-input').value;

            if (newPassword.length < 8) {
                showNotification('La contraseña debe tener al menos 8 caracteres.', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showNotification('Las contraseñas no coinciden.', 'error');
                return;
            }

            const { error } = await supabase.auth.updateUser({ password: newPassword });

            if (error) {
                if (error.message.toLowerCase().includes('password should contain') || error.message.includes('weak password')) {
                     const friendlyMessage = '<strong>La contraseña no es segura.</strong><br>Debe incluir mayúsculas, minúsculas, números y al menos un símbolo.';
                     showNotification(friendlyMessage, 'error');
                } else {
                     showNotification(`Error: ${error.message}`, 'error');
                }
            } else {
                showNotification('Contraseña actualizada con éxito.', 'success');
                hideChangePasswordModal();
            }
        }
        
        function insertPlayerAlphabetically(playerEl, listEl) {
            const playerName = playerEl.textContent;
            let inserted = false;
            for (const child of listEl.children) {
                if (playerName.localeCompare(child.textContent) < 0) {
                    listEl.insertBefore(playerEl, child);
                    inserted = true;
                    break;
                }
            }
            if (!inserted) {
                listEl.appendChild(playerEl);
            }
        }

        // --- Renderizado de Secciones ---

        window.render_dashboard = () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let targetMatch = AppState.matches
                .filter(m => new Date(m.match_date + 'T00:00:00') >= today)
                .sort((a, b) => new Date(a.match_date) - new Date(b.match_date))[0];

            if (!targetMatch && AppState.matches.length > 0) {
                targetMatch = AppState.matches[0];
            }
            
            if (!targetMatch) {
                DOMElements.adminContent.innerHTML = `<div class="p-4 sm:p-6 lg:p-8"><div class="card card-styled p-6"><h1 class="text-xl font-bold">No hay partidos cargados en el sistema.</h1></div></div>`;
                return;
            }

            AppState.selectedMatchId = targetMatch.id;
            let matchDate = new Date(targetMatch.match_date + 'T00:00:00').toLocaleDateString('es-AR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            matchDate = matchDate.charAt(0).toUpperCase() + matchDate.slice(1);

            const content = `
                <div class="p-4 sm:p-6 lg:p-8">
                    <div class="mb-6 rounded-xl shadow-lg overflow-hidden text-center card card-styled">
                        <div class="p-4 bg-muted">
                            <h1 class="text-3xl font-bold tracking-tight text-text-primary">Dashboard</h1>
                        </div>
                        <div class="p-3 bg-secondary border-t border-border-color">
                            <p class="text-text-secondary text-sm">${matchDate}</p>
                        </div>
                    </div>
                    <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                </div>
            `;
            DOMElements.adminContent.innerHTML = content;

            const grid = document.getElementById('dashboard-grid');
            
            grid.innerHTML += createDashboardCard({ id: 'resultado', icon: 'fa-trophy', title: 'Resultado del Partido', match: targetMatch, iconColorClass: 'icon-resultado' });
            grid.innerHTML += createDashboardCard({ id: 'chamigo', icon: 'fa-star', title: 'Votos Chamigo', match: targetMatch, iconColorClass: 'icon-chamigo' });
            grid.innerHTML += createDashboardCard({ id: 'tt', icon: 'fa-beer', title: 'Asistencia TT', match: targetMatch, iconColorClass: 'icon-tt' });
            
            setupDashboardEventListeners();
        };

        function createDashboardCard({ id, icon, title, match, iconColorClass }) {
            const getPlayerName = pid => (AppState.players.find(p => p.id == pid) || { name: '?' }).name;
            let status = 'pending';
            let summary = 'Datos pendientes de carga';
            let buttonText = 'Cargar';
            let buttonClass = 'button-primary';

            if (id === 'resultado') {
                if (match.result) {
                    status = 'completed';
                    summary = `Resultado: <strong>${match.result}</strong>`;
                    buttonText = 'Editar';
                    buttonClass = 'button-edit';
                }
            } else if (id === 'chamigo') {
                const hasVotes = match.chamigo_votes && Object.keys(match.chamigo_votes).length > 0;
                if (hasVotes) {
                    status = 'completed';
                    const votesArray = Object.entries(match.chamigo_votes);
                    const maxVotes = Math.max(...votesArray.map(([, v]) => v));
                    const chamigoNames = votesArray.filter(([, v]) => v === maxVotes).map(([pid]) => getPlayerName(pid)).join(', ');
                    summary = `Chamigo(s): <strong>${chamigoNames}</strong>`;
                    buttonText = 'Editar';
                    buttonClass = 'button-edit';
                }
            } else if (id === 'tt') {
                const hasAttendees = match.tt_attendees && match.tt_attendees.length > 0;
                if (hasAttendees) {
                    status = 'completed';
                    const attendeeNames = match.tt_attendees.map(getPlayerName);
                    if (attendeeNames.length > 3) {
                         summary = `<strong>${attendeeNames.slice(0, 3).join(', ')}</strong> y ${attendeeNames.length - 3} más.`;
                    } else {
                         summary = `Asistentes: <strong>${attendeeNames.join(', ')}</strong>`;
                    }
                    buttonText = 'Editar';
                    buttonClass = 'button-edit';
                }
            }

            return `
                <div class="dashboard-card card card-styled flex flex-col transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 border-l-4 ${status === 'completed' ? 'border-success-color' : 'border-danger-color'}">
                    <div class="dashboard-card-header p-4 flex items-center gap-4 border-b border-border-color">
                        <i class="fas ${icon} text-2xl ${iconColorClass}"></i>
                        <div>
                            <h3 class="font-bold text-lg">${title}</h3>
                            <span class="status-badge text-xs font-bold py-1 px-2 rounded-full ${status === 'completed' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">${status === 'completed' ? 'Completado' : 'Pendiente'}</span>
                        </div>
                    </div>
                    <div class="dashboard-card-body p-4 flex-grow">
                        <p class="text-secondary text-sm">${summary}</p>
                    </div>
                    <div class="dashboard-card-footer p-4 bg-muted mt-auto">
                        <button data-action="${id}" class="w-full py-2 font-semibold rounded-lg shadow-md transition ${buttonClass}">${buttonText}</button>
                    </div>
                </div>
            `;
        }

        function setupDashboardEventListeners() {
            document.getElementById('dashboard-grid').addEventListener('click', (e) => {
                const button = e.target.closest('button[data-action]');
                if (!button) return;

                const action = button.dataset.action;
                const match = AppState.matches.find(m => m.id === AppState.selectedMatchId);

                if (action === 'resultado') openResultadoModal(match);
                else if (action === 'chamigo') openChamigoModal(match);
                else if (action === 'tt') openTtModal(match);
            });

            DOMElements.dashboardModalClose.addEventListener('click', closeDashboardModal);
            DOMElements.dashboardModal.addEventListener('click', (e) => {
                if (e.target.id === 'dashboard-modal') closeDashboardModal();
            });
        }

        function openDashboardModal() {
            DOMElements.dashboardModal.classList.remove('hidden');
            DOMElements.body.classList.add('modal-open');
            setTimeout(() => {
                DOMElements.dashboardModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeDashboardModal() {
            DOMElements.dashboardModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                DOMElements.dashboardModal.classList.add('hidden');
                DOMElements.body.classList.remove('modal-open');
                DOMElements.dashboardModalBody.innerHTML = '';
                DOMElements.dashboardModalFooter.innerHTML = '';
            }, 200);
        }

        function openResultadoModal(match) {
            DOMElements.dashboardModalTitle.textContent = 'Registrar Resultado';
            DOMElements.dashboardModalBody.innerHTML = `
                <label for="modal-match-result" class="block text-sm font-medium mb-1">Resultado del Partido</label>
                <select id="modal-match-result" class="w-full p-2 border rounded-md">
                     <option value="">Seleccionar resultado</option>
                     <option value="Claros">Claros</option>
                     <option value="Oscuros">Oscuros</option>
                     <option value="Empate">Empate</option>
                     <option value="Suspendido">Suspendido</option>
                </select>
            `;
            document.getElementById('modal-match-result').value = match.result || '';
            
            DOMElements.dashboardModalFooter.innerHTML = `<button id="modal-save-result" class="px-6 py-2 button-success font-semibold rounded-lg">Guardar</button>`;
            document.getElementById('modal-save-result').addEventListener('click', async () => {
                const newValue = document.getElementById('modal-match-result').value;
                await handleRegisterResult(newValue);
                closeDashboardModal();
            });

            openDashboardModal();
        }

        function openChamigoModal(match) {
            DOMElements.dashboardModalTitle.textContent = 'Registrar Votos de Chamigo';
            DOMElements.dashboardModalBody.innerHTML = `<div id="modal-chamigo-players" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>`;
            renderChamigoVotingPlayers(match, document.getElementById('modal-chamigo-players'));
            
            DOMElements.dashboardModalFooter.innerHTML = `<button id="modal-save-chamigo" class="px-6 py-2 button-warning font-semibold rounded-lg">Guardar Votos</button>`;
            document.getElementById('modal-save-chamigo').addEventListener('click', async () => {
                const votes = {};
                document.querySelectorAll('#modal-chamigo-players .chamigo-player-item').forEach(item => {
                    const count = parseInt(item.querySelector('.chamigo-vote-counter').textContent);
                    if (count > 0) votes[item.dataset.id] = count;
                });
                await handleRegisterChamigo(votes);
                closeDashboardModal();
            });

            openDashboardModal();
        }

        function openTtModal(match) {
            DOMElements.dashboardModalTitle.textContent = 'Registrar Asistencia a TT';
            DOMElements.dashboardModalBody.innerHTML = `<div id="modal-tt-players" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>`;
            renderTtAttendancePlayers(match, document.getElementById('modal-tt-players'));

            DOMElements.dashboardModalFooter.innerHTML = `<button id="modal-save-tt" class="px-6 py-2 button-purple font-semibold rounded-lg">Guardar Asistencia</button>`;
            document.getElementById('modal-save-tt').addEventListener('click', async () => {
                const attendees = Array.from(document.querySelectorAll('#modal-tt-players .selected')).map(el => el.dataset.id);
                await handleRegisterTt(attendees);
                closeDashboardModal();
            });

            openDashboardModal();
        }

        window.render_team_formation = () => {
            const leftCardBody = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium mb-2 text-secondary">Titulares</h4>
                        <div id="titulares-players" class="player-list-container border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                    </div>
                    <div>
                        <h4 class="font-medium mb-2 text-secondary">Suplentes</h4>
                        <div id="suplentes-players" class="player-list-container border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                    </div>
                </div>`;

            const rightCardBody = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold mb-2">Claros (<span id="claros-count">0</span>)</h4>
                            <div id="team-claros" class="border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-white dark:bg-gray-200"></div>
                        </div>
                         <div>
                            <h4 class="font-semibold mb-2">Oscuros (<span id="oscuros-count">0</span>)</h4>
                            <div id="team-oscuros" class="border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-gray-800"></div>
                        </div>
                    </div>
                    <div class="pt-4">
                        <label for="team-match-date" class="block text-sm font-medium mb-1">Fecha del Partido</label>
                        <input type="date" id="team-match-date" class="w-full p-2 border rounded-md">
                    </div>
                    <div class="flex flex-col gap-2 pt-2">
                        <button id="save-teams-button" class="w-full px-6 py-3 button-primary font-semibold rounded-lg shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Guardar Partido
                        </button>
                        <button id="save-suspended-button" class="w-full px-6 py-2 button-danger font-semibold rounded-lg shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Partido Suspendido
                        </button>
                    </div>
                </div>`;

            const content = `
                <div id="team-formation-container" class="grid grid-cols-1 lg:grid-cols-2 h-full">
                    ${cardTemplate('JUGADORES', leftCardBody, 'border-b lg:border-b-0 lg:border-r border-border-color')}
                    ${cardTemplate('EQUIPOS (<span id="total-selected-players">0</span>/10)', rightCardBody)}
                </div>`;

            DOMElements.adminContent.innerHTML = content;
            
            const titularesDiv = document.getElementById('titulares-players');
            const suplentesDiv = document.getElementById('suplentes-players');
            
            const activePlayers = AppState.players.filter(p => p.status === 'Activo');
            activePlayers.sort((a, b) => a.name.localeCompare(b.name));

            activePlayers.forEach(player => {
                const playerEl = createPlayerElement(player);
                if (player.role === 'Titular') titularesDiv.appendChild(playerEl);
                else suplentesDiv.appendChild(playerEl);
            });

            setupPlayerInteractions('team-formation-container');
            document.getElementById('team-match-date').addEventListener('click', function() { this.showPicker(); });
            document.getElementById('team-match-date').addEventListener('change', updateTeamCounts);
            document.getElementById('save-teams-button').addEventListener('click', handleSaveTeams);
            document.getElementById('save-suspended-button').addEventListener('click', handleSaveSuspendedMatch);
        };

        const renderMatchSelectionTemplate = (prefix, panelTitle, panelContent) => {
            const selectionCardBody = `
                <div class="flex flex-col h-full">
                    <div class="flex gap-2 mb-4 shrink-0">
                        <select id="${prefix}-year-select" class="w-full p-2 border rounded-md"></select>
                        <select id="${prefix}-month-select" class="w-full p-2 border rounded-md"></select>
                    </div>
                    <div id="${prefix}-list" class="space-y-2 overflow-y-auto pr-1 py-1 flex-grow">
                       <p class="text-secondary">Cargando partidos...</p>
                    </div>
                </div>`;

            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-3 h-full">
                    <div class="lg:col-span-1 border-b lg:border-b-0 lg:border-r border-border-color">
                        ${cardTemplate('PARTIDO', selectionCardBody, 'h-full')}
                    </div>
                    <div class="lg:col-span-2" id="${prefix}-panel-container">
                        ${cardTemplate(panelTitle, panelContent, 'h-full')}
                    </div>
                </div>`;
            return content;
        };
        window.render_match_results = () => {
            const panelContent = `
                <div class="space-y-4">
                     <div>
                        <label class="block text-sm font-medium mb-1">Fecha del Partido</label>
                        <input type="date" id="match-date" class="w-full p-2 border rounded-md" readonly>
                     </div>
                     <div>
                        <label for="match-result" class="block text-sm font-medium mb-1">Resultado</label>
                        <select id="match-result" class="w-full p-2 border rounded-md">
                             <option value="">Seleccionar resultado</option>
                             <option value="Claros">Claros</option>
                             <option value="Oscuros">Oscuros</option>
                             <option value="Empate">Empate</option>
                             <option value="Suspendido">Suspendido</option>
                        </select>
                     </div>
                     <div class="flex gap-4 pt-4">
                        <button id="register-match-button" class="flex-1 px-6 py-3 button-success font-semibold rounded-lg shadow-md hover:opacity-90 transition">
                         Registrar Resultado
                        </button>
                     </div>
                </div>`;
            DOMElements.adminContent.innerHTML = renderMatchSelectionTemplate('results', 'RESULTADO', panelContent);
            populateMatchFilters('results');
        };
        window.render_chamigo_management = () => {
            const panelContent = `
                <div id="chamigo-voting-players" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 max-h-[50vh] overflow-y-auto">
                    <p class="text-secondary col-span-full">Selecciona un partido para cargar los jugadores.</p>
                </div>
                <button id="register-chamigo-button" class="w-full mt-4 px-6 py-3 button-warning font-semibold rounded-lg shadow-md hover:opacity-90 transition">
                    Registrar Chamigo(s)
                </button>
                <div class="mt-6 relative">
                    <button id="chamigo-whatsapp-toggle" class="collapsible-toggle-button p-3 rounded-md cursor-pointer flex items-center justify-center font-semibold w-full relative">
                        <span>Encuesta Whatsapp</span>
                        <i class="fas fa-chevron-down toggle-icon absolute right-3 top-1/2 -translate-y-1/2"></i>
                    </button>
                    <div id="chamigo-whatsapp-content" class="hidden card card-styled p-6 mt-4 space-y-4 relative">
                        <button id="copy-whatsapp-poll" class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-text-secondary">
                            <i class="fas fa-copy"></i>
                        </button>
                        <div class="whatsapp-poll-display whitespace-pre-wrap text-sm" id="whatsapp-poll-text"></div>
                    </div>
                </div>`;
            DOMElements.adminContent.innerHTML = renderMatchSelectionTemplate('chamigo', 'VOTOS CHAMIGO', panelContent);
            populateMatchFilters('chamigo');
        };
        window.render_tt_attendance = () => {
             const panelContent = `
                <div id="tt-attendance-players" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-4 max-h-[50vh] overflow-y-auto">
                    <p class="text-secondary col-span-full">Selecciona un partido para cargar los jugadores.</p>
                </div>
                <button id="register-tt-button" class="w-full mt-4 px-6 py-3 button-purple font-semibold rounded-lg shadow-md hover:opacity-90 transition">
                    Registrar Asistencia
                </button>`;
            DOMElements.adminContent.innerHTML = renderMatchSelectionTemplate('tt', 'ASISTENCIA TT', panelContent);
            populateMatchFilters('tt');
        };
        window.render_edit_match = () => {
            const leftCardBody = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium mb-2 text-secondary">Titulares</h4>
                        <div id="edit-titulares-players" class="player-list-container border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                    </div>
                    <div>
                        <h4 class="font-medium mb-2 text-secondary">Suplentes</h4>
                        <div id="edit-suplentes-players" class="player-list-container border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                    </div>
                </div>`;
            const rightCardBody = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold mb-2">Claros</h4>
                            <div id="edit-team-claros" class="border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-white dark:bg-gray-200"></div>
                        </div>
                         <div>
                            <h4 class="font-semibold mb-2">Oscuros</h4>
                            <div id="edit-team-oscuros" class="border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-gray-800"></div>
                        </div>
                    </div>
                    <div class="pt-4">
                        <label for="edit-match-date" class="block text-sm font-medium mb-1">Fecha del Partido</label>
                        <input type="date" id="edit-match-date" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="edit-match-result" class="block text-sm font-medium mb-1">Resultado</label>
                        <select id="edit-match-result" class="w-full p-2 border rounded-md">
                             <option value="">Seleccionar resultado</option>
                             <option value="Claros">Claros</option>
                             <option value="Oscuros">Oscuros</option>
                             <option value="Empate">Empate</option>
                             <option value="Suspendido">Suspendido</option>
                        </select>
                     </div>
                    <div class="flex flex-col sm:flex-row gap-4 pt-4">
                        <button id="update-match-button" class="w-full px-6 py-3 button-primary font-semibold rounded-lg shadow-md transition">
                            Actualizar Partido
                        </button>
                        <button id="delete-match-from-edit-button" class="w-full px-6 py-3 button-danger font-semibold rounded-lg shadow-md transition">
                            Eliminar Partido
                        </button>
                    </div>
                </div>`;

            const panelContent = `
                <div id="edit-match-container" class="grid grid-cols-1 lg:grid-cols-2 h-full">
                    ${cardTemplate('JUGADORES', leftCardBody, 'border-b lg:border-b-0 lg:border-r border-border-color')}
                    ${cardTemplate('EQUIPOS', rightCardBody)}
                </div>`;
            DOMElements.adminContent.innerHTML = renderMatchSelectionTemplate('edit', ' ', panelContent);
            document.querySelector('#edit-panel-container > .card > h3').remove();
            populateMatchFilters('edit');
        };
        
        window.render_players_management = () => {
            const formBody = `
                <form id="player-form" class="space-y-3">
                    <input type="hidden" id="player-id">
                    
                    <div>
                        <label class="block text-sm font-medium mb-2 text-center">Foto del Jugador</label>
                        <div class="flex justify-center">
                            <label for="player-photo-input" class="cursor-pointer group">
                                <div class="relative">
                                    <img id="player-photo-preview" src="https://placehold.co/128x128/e2e8f0/64748b?text=⚽" class="w-28 h-28 rounded-full object-cover border-4 border-border-color group-hover:opacity-75 transition-opacity">
                                    <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                                        <i class="fas fa-camera text-white text-2xl"></i>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <input type="file" id="player-photo-input" class="hidden" accept="image/png, image/jpeg">
                        <div class="text-center mt-2">
                            <button type="button" id="remove-photo-button" class="text-xs button-danger px-3 py-1 rounded-md hidden">Quitar Foto</button>
                        </div>
                    </div>

                    <div>
                        <label for="player-name" class="block text-sm font-medium mb-1">Nombre</label>
                        <input type="text" id="player-name" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="player-status" class="block text-sm font-medium mb-1">Estado</label>
                        <select id="player-status" class="w-full p-2 border rounded-md">
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                    <div>
                        <label for="player-role" class="block text-sm font-medium mb-1">Rol</label>
                        <select id="player-role" class="w-full p-2 border rounded-md">
                            <option value="Titular">Titular</option>
                            <option value="Suplente">Suplente</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-2 pt-2">
                        <button type="submit" id="save-player-button" class="w-full px-4 py-2.5 button-success font-semibold rounded-lg shadow-md hover:opacity-90">Guardar Jugador</button>
                        <button type="button" id="delete-player-button" class="w-full px-4 py-2 button-danger font-semibold rounded-lg shadow-md hover:opacity-90">Eliminar Jugador</button>
                        <button type="button" id="clear-player-form-button" class="w-full px-4 py-2 bg-gray-400 text-gray-800 hover:bg-gray-500 dark:bg-gray-600 dark:text-gray-100 dark:hover:bg-gray-500 font-semibold rounded-lg shadow-md transition">Limpiar Formulario</button>
                    </div>
                </form>`;
            const listBody = `
                <div class="mb-4 relative">
                    <input type="text" id="player-search-input" placeholder="Buscar por nombre..." class="w-full p-2 pl-10 border rounded-md">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div id="players-management-table-container" class="overflow-y-auto max-h-[70vh]">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase sticky top-0 z-10">
                            <tr>
                                <th class="p-4" data-sort-by="id" style="cursor:pointer;">ID</th>
                                <th class="p-4" data-sort-by="name" style="cursor:pointer;">Nombre</th>
                                <th class="p-4" data-sort-by="status" style="cursor:pointer;">Estado</th>
                                <th class="p-4" data-sort-by="role" style="cursor:pointer;">Rol</th>
                            </tr>
                        </thead>
                        <tbody id="players-list-admin"></tbody>
                    </table>
                </div>`;

            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-3 h-full">
                    <div class="lg:col-span-1 border-b lg:border-b-0 lg:border-r border-border-color">
                        ${cardTemplate('JUGADOR', formBody, 'h-full')}
                    </div>
                    <div class="lg:col-span-2">
                        ${cardTemplate('JUGADORES', listBody, 'h-full')}
                    </div>
                </div>`;
            DOMElements.adminContent.innerHTML = content;
            
            renderPlayersListAdmin();
            
            document.getElementById('player-search-input').addEventListener('input', (e) => {
                renderPlayersListAdmin(e.target.value);
            });

            document.querySelectorAll('#players-management-table-container th[data-sort-by]').forEach(header => {
                header.addEventListener('click', () => {
                    const key = header.dataset.sortBy;
                    if (playerSortState.key === key) {
                        playerSortState.dir = playerSortState.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        playerSortState.key = key;
                        playerSortState.dir = 'asc';
                    }
                    renderPlayersListAdmin(document.getElementById('player-search-input').value);
                });
            });

            document.getElementById('player-form').addEventListener('submit', handleSavePlayer);
            document.getElementById('delete-player-button').addEventListener('click', handleDeletePlayer);
            document.getElementById('clear-player-form-button').addEventListener('click', clearPlayerForm);
            document.getElementById('player-photo-input').addEventListener('change', handlePhotoPreview);
            document.getElementById('remove-photo-button').addEventListener('click', handleRemovePhoto);
        };

        window.render_user_management = () => {
             const formBody = `
                <form id="user-form" class="space-y-4">
                    <input type="hidden" id="user-id">
                    <div>
                        <label for="user-email" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="user-email" class="w-full p-2 border rounded-md" readonly>
                    </div>
                    <div>
                        <label for="user-name" class="block text-sm font-medium mb-1">Nombre</label>
                        <input type="text" id="user-name" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="user-role" class="block text-sm font-medium mb-1">Rol</label>
                        <select id="user-role" class="w-full p-2 border rounded-md">
                            <option value="Operador">Operador</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="submit" class="flex-1 px-4 py-2 button-success font-semibold rounded-lg shadow-md hover:opacity-90">Guardar</button>
                        <button type="button" id="clear-user-form-button" class="flex-1 px-4 py-2 bg-gray-400 text-gray-800 hover:bg-gray-500 dark:bg-gray-600 dark:text-gray-100 dark:hover:bg-gray-500 font-semibold rounded-lg shadow-md transition">Limpiar</button>
                    </div>
                </form>`;
            const listBody = `
                <div class="mb-4 relative">
                    <input type="text" id="user-search-input" placeholder="Buscar por nombre o email..." class="w-full p-2 pl-10 border rounded-md">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div id="user-management-table-container" class="overflow-y-auto max-h-[60vh]">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase sticky top-0 z-10">
                            <tr>
                                <th class="p-4" data-sort-by="email" style="cursor:pointer;">Email</th>
                                <th class="p-4" data-sort-by="name" style="cursor:pointer;">Nombre</th>
                                <th class="p-4" data-sort-by="role" style="cursor:pointer;">Rol</th>
                            </tr>
                        </thead>
                        <tbody id="users-list-admin"></tbody>
                    </table>
                </div>`;
            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-3 h-full">
                    <div class="lg:col-span-1 border-b lg:border-b-0 lg:border-r border-border-color">
                        ${cardTemplate('USUARIO', formBody, 'h-full')}
                    </div>
                    <div class="lg:col-span-2">
                        ${cardTemplate('USUARIOS', listBody, 'h-full')}
                    </div>
                </div>`;
            DOMElements.adminContent.innerHTML = content;
            
            renderUsersListAdmin();

            document.getElementById('user-search-input').addEventListener('input', (e) => {
                renderUsersListAdmin(e.target.value);
            });

            document.querySelectorAll('#user-management-table-container th[data-sort-by]').forEach(header => {
                header.addEventListener('click', () => {
                    const key = header.dataset.sortBy;
                    if (userSortState.key === key) {
                        userSortState.dir = userSortState.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        userSortState.key = key;
                        userSortState.dir = 'asc';
                    }
                    renderUsersListAdmin(document.getElementById('user-search-input').value);
                });
            });

            document.getElementById('user-form').addEventListener('submit', handleSaveUser);
            document.getElementById('clear-user-form-button').addEventListener('click', clearUserForm);
        };
        function createPlayerElement(player) {
            const el = document.createElement('div');
            el.className = 'player-element flex-grow-0 text-sm font-medium px-3 py-1.5 rounded-full shadow-sm';
            el.dataset.id = player.id;
            el.textContent = player.name;
            return el;
        }

        function returnPlayerToOrigin(playerEl) {
            if (!playerEl) return;
            const playerId = playerEl.dataset.id;
            const player = AppState.players.find(p => p.id == playerId);
            const isEditMode = playerEl.closest('#edit-match-container');

            const suplentesList = document.getElementById(isEditMode ? 'edit-suplentes-players' : 'suplentes-players');
            const titularesList = document.getElementById(isEditMode ? 'edit-titulares-players' : 'titulares-players');
            
            if (player && player.role === 'Suplente') {
                insertPlayerAlphabetically(playerEl, suplentesList);
            } else if (player) {
                insertPlayerAlphabetically(playerEl, titularesList);
            }
            if (!isEditMode) updateTeamCounts();
        };

        function setupPlayerInteractions(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const onClick = (e) => {
                const playerEl = e.target.closest('.player-element');
                if (!playerEl) return;

                const parentId = playerEl.parentElement.id;
                
                if (parentId.includes('titulares-players') || parentId.includes('suplentes-players')) {
                    showPlayerAssignmentModal(playerEl);
                } 
                else if (parentId.includes('team-claros') || parentId.includes('team-oscuros')) {
                    showPlayerTeamOptionsModal(playerEl);
                }
            };

            container.addEventListener('click', onClick);
        }
        function showPlayerAssignmentModal(playerEl) {
            AppState.activePlayerElement = playerEl;
            DOMElements.assignModalPlayerName.textContent = playerEl.textContent;
            DOMElements.playerAssignmentModal.classList.remove('hidden');
            DOMElements.body.classList.add('modal-open');
        }
        function hidePlayerAssignmentModal() {
            AppState.activePlayerElement = null;
            DOMElements.playerAssignmentModal.classList.add('hidden');
            DOMElements.body.classList.remove('modal-open');
        }

        function showPlayerTeamOptionsModal(playerEl) {
            AppState.activePlayerElement = playerEl;
            const parentId = playerEl.parentElement.id;
            const moveBtn = DOMElements.moveBetweenTeamsBtn;

            DOMElements.optionsModalPlayerName.textContent = playerEl.textContent;

            if (parentId.includes('claros')) {
                moveBtn.textContent = 'Mover a Oscuros';
                moveBtn.dataset.target = parentId.replace('claros', 'oscuros');
            } else {
                moveBtn.textContent = 'Mover a Claros';
                moveBtn.dataset.target = parentId.replace('oscuros', 'claros');
            }

            DOMElements.playerTeamOptionsModal.classList.remove('hidden');
            DOMElements.body.classList.add('modal-open');
        }

        function hidePlayerTeamOptionsModal() {
            AppState.activePlayerElement = null;
            DOMElements.playerTeamOptionsModal.classList.add('hidden');
            DOMElements.body.classList.remove('modal-open');
        }

        function handleReturnPlayer() {
            if (AppState.activePlayerElement) {
                returnPlayerToOrigin(AppState.activePlayerElement);
            }
            hidePlayerTeamOptionsModal();
        }

        function handleMoveBetweenTeams() {
            const playerEl = AppState.activePlayerElement;
            const targetId = DOMElements.moveBetweenTeamsBtn.dataset.target;
            if (!playerEl || !targetId) {
                hidePlayerTeamOptionsModal();
                return;
            }

            const targetContainer = document.getElementById(targetId);
            if (targetContainer) {
                targetContainer.appendChild(playerEl);
                if (!playerEl.closest('#edit-match-container')) {
                    updateTeamCounts();
                }
            }
            hidePlayerTeamOptionsModal();
        }

        function movePlayerToTeam(teamId) {
            if (!AppState.activePlayerElement) return;
            
            const isEditMode = !!AppState.activePlayerElement.closest('#edit-match-container');
            const finalTeamId = isEditMode ? `edit-${teamId}` : teamId;
            
            const teamContainer = document.getElementById(finalTeamId);
            if (teamContainer.children.length >= 5) {
                showNotification(`El equipo ${teamId.includes('claros') ? 'Claros' : 'Oscuros'} ya está lleno.`, 'warning');
                return;
            }
            
            teamContainer.appendChild(AppState.activePlayerElement);
            hidePlayerAssignmentModal();
            if (!isEditMode) updateTeamCounts();
        }
        
        function updateTeamCounts() {
            const clarosCount = document.getElementById('team-claros').children.length;
            const oscurosCount = document.getElementById('team-oscuros').children.length;
            const matchDate = document.getElementById('team-match-date').value;

            document.getElementById('claros-count').textContent = clarosCount;
            document.getElementById('oscuros-count').textContent = oscurosCount;
            document.querySelector('#total-selected-players').textContent = clarosCount + oscurosCount;
            
            document.getElementById('save-teams-button').disabled = !(clarosCount === 5 && oscurosCount === 5 && matchDate);
            document.getElementById('save-suspended-button').disabled = !matchDate;
        }
        
        async function handleSaveTeams() {
            const matchDate = document.getElementById('team-match-date').value;
            if (!matchDate) {
                showNotification('Por favor, selecciona la fecha del partido.', 'warning');
                return;
            }

            const existingMatch = AppState.matches.find(m => m.match_date === matchDate);
            if (existingMatch) {
                showNotification('Ya existe un partido en esta fecha. Por favor, elige otra.', 'error');
                return;
            }

            const dateObj = new Date(matchDate + 'T00:00:00');
            const dayOfWeek = dateObj.getDay();

            if (dayOfWeek !== 2) {
                const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                const dayName = dayNames[dayOfWeek];

                const confirmed = await showCustomConfirm({
                    title: 'Confirmar Creación',
                    message: `El partido está siendo creado un ${dayName}. ¿Estás seguro?`,
                    confirmText: 'Aceptar',
                    cancelText: 'Cancelar',
                    confirmClass: 'button-success',
                    cancelClass: 'button-danger'
                });

                if (!confirmed) {
                    return;
                }
            }

            const teamWhitePlayers = Array.from(document.getElementById('team-claros').children).map(el => el.dataset.id);
            const teamDarkPlayers = Array.from(document.getElementById('team-oscuros').children).map(el => el.dataset.id);

            const { error } = await supabase.rpc('create_new_match', {
                match_date_param: matchDate,
                team_white_players_param: teamWhitePlayers,
                team_dark_players_param: teamDarkPlayers
            });

            if (error) {
                showNotification(`Error al crear el partido: ${error.message}`, 'error');
            } else {
                showNotification('Partido creado exitosamente!', 'success');
                await refreshDataAndRender('team-formation');
            }
        }

        async function handleSaveSuspendedMatch() {
            const matchDate = document.getElementById('team-match-date').value;
            if (!matchDate) { 
                showNotification('Por favor, selecciona la fecha del partido.', 'warning');
                return;
            }

            const existingMatch = AppState.matches.find(m => m.match_date === matchDate);
            if (existingMatch) {
                showNotification('Ya existe un partido en esta fecha. Por favor, elige otra.', 'error');
                return;
            }

            const confirmed = await showModal(
                'Confirmar Suspensión', 
                `¿Estás seguro de que quieres registrar un partido suspendido para la fecha ${matchDate}?`
            );

            if (confirmed) {
                const { error } = await supabase.rpc('create_suspended_match', {
                    match_date_param: matchDate
                });

                if (error) {
                    showNotification(`Error al crear el partido suspendido: ${error.message}`, 'error');
                } else {
                    showNotification('Partido suspendido creado exitosamente!', 'success');
                    await refreshDataAndRender('team-formation');
                }
            }
        }

        function populateMatchFilters(prefix) {
            const yearSelect = document.getElementById(`${prefix}-year-select`);
            const monthSelect = document.getElementById(`${prefix}-month-select`);
            
            const years = [...new Set(AppState.matches.map(m => new Date(m.match_date).getUTCFullYear()))].sort((a,b) => b-a);
            yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
            
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            monthSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            
            const mostRecentMatchDate = AppState.matches.length > 0 ? new Date(AppState.matches[0].match_date) : new Date();
            
            if (years.includes(mostRecentMatchDate.getUTCFullYear())) yearSelect.value = mostRecentMatchDate.getUTCFullYear();
            monthSelect.value = mostRecentMatchDate.getUTCMonth();

            const renderList = () => {
                const listContainer = document.getElementById(`${prefix}-list`);
                const selectedYear = yearSelect.value;
                const selectedMonth = monthSelect.value;
                const filteredMatches = AppState.matches.filter(m => {
                    const d = new Date(m.match_date);
                    return d.getUTCFullYear() == selectedYear && d.getUTCMonth() == selectedMonth;
                });
                
                if (filteredMatches.length === 0) {
                    listContainer.innerHTML = '<p class="text-secondary p-2">No hay partidos para este mes.</p>';
                    document.getElementById(`${prefix}-panel-container`).classList.add('hidden');
                    return;
                }
                
                document.getElementById(`${prefix}-panel-container`).classList.remove('hidden');

                filteredMatches.sort((a, b) => new Date(b.match_date) - new Date(a.match_date));
                
                listContainer.innerHTML = filteredMatches.map(match => {
                    const d = new Date(match.match_date);
                    const formattedDate = d.toLocaleDateString('es-AR', {day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC'});
                    return `
                        <div class="match-item border-l-4 p-3 rounded-r-lg cursor-pointer transition" data-match-id="${match.id}">
                            <p class="font-semibold">${formattedDate}</p>
                            <p class="text-xs text-secondary">Resultado: ${match.result || 'Pendiente'}</p>
                        </div>`;
                }).join('');

                listContainer.querySelectorAll('.match-item').forEach(item => {
                    const match = AppState.matches.find(m => m.id == item.dataset.matchId);
                    let hasCompletion = false;

                    if (prefix === 'results') {
                        hasCompletion = !!match.result;
                    } else if (prefix === 'chamigo') {
                        hasCompletion = (match.chamigo_votes && Object.keys(match.chamigo_votes).length > 0);
                    } else if (prefix === 'tt') {
                        hasCompletion = (match.tt_attendees && match.tt_attendees.length > 0);
                    } else {
                        hasCompletion = !!match.result;
                    }

                    item.classList.toggle('has-result', hasCompletion);
                    item.classList.toggle('no-result', !hasCompletion);
                    
                    item.addEventListener('click', (e) => {
                        listContainer.querySelectorAll('.match-item').forEach(i => i.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        handleMatchSelection(e.currentTarget.dataset.matchId, prefix);
                    });
                });

                const firstMatchItem = listContainer.querySelector('.match-item');
                if (firstMatchItem) {
                    firstMatchItem.click(); 
                }
            };
            
            yearSelect.addEventListener('change', renderList);
            monthSelect.addEventListener('change', renderList);
            renderList();
        }
        function handleMatchSelection(matchId, prefix) {
            AppState.selectedMatchId = matchId;
            const match = AppState.matches.find(m => m.id == matchId);
            if (!match) return;
            
            const panelContainer = document.getElementById(`${prefix}-panel-container`);
            panelContainer.classList.remove('hidden');

            const handlerMap = {
                'results': setupResultsPanel,
                'chamigo': setupChamigoPanel,
                'tt': setupTtPanel,
                'edit': setupEditMatchPanel,
            };

            if(handlerMap[prefix]) handlerMap[prefix](panelContainer, match);
        }
        function setupResultsPanel(panel, match) {
            panel.querySelector('#match-date').value = match.match_date;
            const resultSelect = panel.querySelector('#match-result');
            resultSelect.value = match.result || '';
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#register-match-button').addEventListener('click', () => handleRegisterResult(resultSelect.value));
                panel.dataset.listenersAdded = 'true';
            }
        }
        function setupChamigoPanel(panel, match) {
            renderChamigoVotingPlayers(match, panel.querySelector('#chamigo-voting-players'));
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#register-chamigo-button').addEventListener('click', () => {
                    const votes = {};
                    panel.querySelectorAll('.chamigo-player-item').forEach(item => {
                        const count = parseInt(item.querySelector('.chamigo-vote-counter').textContent);
                        if (count > 0) votes[item.dataset.id] = count;
                    });
                    handleRegisterChamigo(votes);
                });
                panel.dataset.listenersAdded = 'true';
            }

            const whatsappPollTextDiv = document.getElementById('whatsapp-poll-text');
            const copyWhatsappPollBtn = document.getElementById('copy-whatsapp-poll');
            const toggleButton = document.getElementById('chamigo-whatsapp-toggle');
            const collapsibleContent = document.getElementById('chamigo-whatsapp-content');

            if (whatsappPollTextDiv && copyWhatsappPollBtn && toggleButton && collapsibleContent) {
                const getPlayerName = id => (AppState.players.find(p => p.id == id) || { name: 'Jugador Desconocido' }).name;

                const clarosPlayersNames = (match.team_white_players || []).map(getPlayerName).join(', ');
                const oscurosPlayersNames = (match.team_dark_players || []).map(getPlayerName).join(', ');

                const matchDate = new Date(match.match_date + 'T00:00:00');
                const day = matchDate.getUTCDate();
                const month = matchDate.getUTCMonth() + 1;
                const formattedDate = `${day}/${month}`;

                let pollText = `*Chamigo ${formattedDate}*\n`;
                if (oscurosPlayersNames) {
                    pollText += '*Oscuros*\n' + oscurosPlayersNames + '\n\n';
                }
                if (clarosPlayersNames) {
                    pollText += '*Claros*\n' + clarosPlayersNames;
                }

                whatsappPollTextDiv.textContent = pollText;

                copyWhatsappPollBtn.onclick = () => {
                    const textToCopy = whatsappPollTextDiv.textContent;
                    const el = document.createElement('textarea');
                    el.value = textToCopy;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    showNotification('Texto copiado al portapapeles!', 'success');
                };

                if (!toggleButton.dataset.listenerAdded) {
                    toggleButton.addEventListener('click', () => {
                        collapsibleContent.classList.toggle('hidden');
                        toggleButton.classList.toggle('visible-content');
                        toggleButton.querySelector('.toggle-icon')?.classList.toggle('fa-chevron-up');
                        toggleButton.querySelector('.toggle-icon')?.classList.toggle('fa-chevron-down');
                    });
                    toggleButton.dataset.listenerAdded = 'true';
                }
                collapsibleContent.classList.add('hidden');
                toggleButton.classList.remove('visible-content');
                toggleButton.querySelector('.toggle-icon')?.classList.remove('fa-chevron-up');
                toggleButton.querySelector('.toggle-icon')?.classList.add('fa-chevron-down');
            }
        }
        function setupTtPanel(panel, match) {
            renderTtAttendancePlayers(match, panel.querySelector('#tt-attendance-players'));
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#register-tt-button').addEventListener('click', () => {
                    const attendees = Array.from(panel.querySelectorAll('#tt-attendance-players .selected')).map(el => el.dataset.id);
                    handleRegisterTt(attendees);
                });
                panel.dataset.listenersAdded = 'true';
            }
        }
        function setupEditMatchPanel(panel, match) {
            renderEditMatchPlayers(match);
            
            panel.querySelector('#edit-match-result').value = match.result || '';
            
            const updateBtn = panel.querySelector('#update-match-button');
            const deleteBtn = panel.querySelector('#delete-match-from-edit-button');

            const newUpdateBtn = updateBtn.cloneNode(true);
            updateBtn.parentNode.replaceChild(newUpdateBtn, updateBtn);
            newUpdateBtn.addEventListener('click', handleUpdateMatch);

            const newDeleteBtn = deleteBtn.cloneNode(true);
            deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
            newDeleteBtn.addEventListener('click', handleDeleteMatchFromEdit);

            panel.querySelector('#edit-match-date').addEventListener('click', function() {
                this.showPicker();
            });
        }
        async function handleRegisterResult(resultValue) {
            if (resultValue === "") {
                resultValue = null;
            }
            const { error } = await supabase.rpc('update_match_result', {
                match_id_param: AppState.selectedMatchId,
                new_result: resultValue
            });
            if(error) { 
                showNotification('Error al registrar resultado', 'error'); 
            } else {
                showNotification('Resultado registrado!', 'success');
                await refreshDataAndRender('match-results');
            }
        }
        async function handleDeleteMatchFromEdit() {
            const confirmed = await showModal('Confirmar Eliminación', '¿Seguro que quieres eliminar este partido? Esta acción no se puede deshacer.');
            if (confirmed) {
                const { error } = await supabase.rpc('delete_match_by_id', {
                    match_id_param: AppState.selectedMatchId
                });
                if(error) { 
                    showNotification('Error al eliminar partido', 'error'); 
                } else {
                    showNotification('Partido eliminado.', 'success');
                    await refreshDataAndRender('edit-match');
                }
            }
        }
        function renderChamigoVotingPlayers(match, container) {
            if (!container) return;
            container.innerHTML = '';
            const playerIDs = [...new Set([...(match.team_white_players||[]), ...(match.team_dark_players||[])])];
            const currentVotes = match.chamigo_votes || {};

            playerIDs.forEach(id => {
                const player = AppState.players.find(p => p.id == id);
                if (!player) return;
                
                const voteCount = currentVotes[id] || 0;
                const playerDiv = document.createElement('div');
                playerDiv.className = 'chamigo-player-item flex items-center justify-between p-2 border border-border-color rounded-lg';
                playerDiv.dataset.id = id;
                playerDiv.innerHTML = `
                    <span class="player-name">${player.name}</span>
                    <div class="chamigo-vote-controls flex items-center gap-2">
                        <button class="chamigo-vote-btn subtract-vote w-8 h-8 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition-colors flex items-center justify-center text-lg font-bold">-</button>
                        <span class="chamigo-vote-counter font-bold w-8 text-center text-lg">${voteCount}</span>
                        <button class="chamigo-vote-btn add-vote w-8 h-8 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition-colors flex items-center justify-center text-lg font-bold">+</button>
                    </div>`;
                
                playerDiv.querySelector('.add-vote').addEventListener('click', () => {
                    const counter = playerDiv.querySelector('.chamigo-vote-counter');
                    counter.textContent = parseInt(counter.textContent) + 1;
                });
                playerDiv.querySelector('.subtract-vote').addEventListener('click', () => {
                    const counter = playerDiv.querySelector('.chamigo-vote-counter');
                    counter.textContent = Math.max(0, parseInt(counter.textContent) - 1);
                });
                container.appendChild(playerDiv);
            });
        }
        
        async function handleRegisterChamigo(votes) {
            const chamigoData = Object.keys(votes).length === 0 ? null : votes;

            const { error } = await supabase.rpc('update_chamigo_votes', {
                match_id_param: AppState.selectedMatchId,
                chamigo_votes_param: chamigoData
            });

            if (error) { 
                showNotification('Error al guardar votos de Chamigo', 'error');
            } else {
                showNotification('Votos de Chamigo guardados!', 'success');
                await refreshDataAndRender('chamigo-management');
            }
        }

        function renderTtAttendancePlayers(match, container) {
            if (!container) return;
            container.innerHTML = '';

            const matchPlayerIDs = new Set([
                ...(match.team_white_players || []),
                ...(match.team_dark_players || [])
            ]);

            const participants = [];
            const nonParticipants = [];

            AppState.players
                .filter(p => p.status === 'Activo')
                .forEach(player => {
                    if (matchPlayerIDs.has(player.id)) {
                        participants.push(player);
                    } else {
                        nonParticipants.push(player);
                    }
                });

            const sortByName = (a, b) => a.name.localeCompare(b.name);
            participants.sort(sortByName);
            nonParticipants.sort(sortByName);

            const sortedPlayers = [...participants, ...nonParticipants];
            const existingAttendees = match.tt_attendees || [];

            sortedPlayers.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'tt-player-item p-2 border border-border-color rounded-lg cursor-pointer text-center flex items-center justify-center gap-2';
                if (existingAttendees.includes(player.id)) {
                    playerDiv.classList.add('selected');
                }
                playerDiv.dataset.id = player.id;
                playerDiv.innerHTML = `<i class="fas fa-check-circle hidden"></i><span>${player.name}</span>`;
                
                const icon = playerDiv.querySelector('i');
                icon.style.display = playerDiv.classList.contains('selected') ? 'inline' : 'none';

                playerDiv.addEventListener('click', () => {
                    playerDiv.classList.toggle('selected');
                    icon.style.display = playerDiv.classList.contains('selected') ? 'inline' : 'none';
                });
                container.appendChild(playerDiv);
            });
        }
        
        async function handleRegisterTt(attendees) {
            const { error } = await supabase.rpc('update_tt_attendance', {
                match_id_param: AppState.selectedMatchId,
                tt_attendees_param: attendees
            });

            if (error) { 
                showNotification('Error al guardar asistencia a TT', 'error');
            } else {
                showNotification('Asistencia a TT guardada!', 'success');
                await refreshDataAndRender('tt-attendance');
            }
        }

        function renderPlayersListAdmin(searchTerm = '') {
            const tableBody = document.getElementById('players-list-admin');
            const normalizedSearch = searchTerm.toLowerCase();
            let filteredPlayers = AppState.players.filter(p => 
                p.name.toLowerCase().includes(normalizedSearch)
            );

            // Sorting logic
            const { key, dir } = playerSortState;
            filteredPlayers.sort((a, b) => {
                const valA = a[key];
                const valB = b[key];

                // Use localeCompare with numeric option for natural sorting on all columns
                const compareResult = String(valA).localeCompare(String(valB), undefined, { numeric: true });

                return dir === 'asc' ? compareResult : -compareResult;
            });

            tableBody.innerHTML = filteredPlayers.map(p => `
                <tr class="selectable-row border-b border-border-color cursor-pointer" data-player-id="${p.id}">
                    <td class="p-4">${p.id}</td><td class="p-4">${p.name}</td>
                    <td class="p-4">${p.status}</td><td class="p-4">${p.role}</td>
                </tr>`).join('');
            
            // Add visual indicators to headers
            document.querySelectorAll('#players-management-table-container th[data-sort-by]').forEach(th => {
                th.querySelector('.sort-icon')?.remove();
                if (th.dataset.sortBy === key) {
                    const icon = document.createElement('i');
                    icon.className = `fas fa-chevron-${dir === 'asc' ? 'up' : 'down'} ml-2 sort-icon`;
                    th.appendChild(icon);
                }
            });

            tableBody.querySelectorAll('.selectable-row').forEach(row => {
                row.addEventListener('click', () => {
                    tableBody.querySelectorAll('.selectable-row').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    populatePlayerForm(AppState.players.find(p => p.id == row.dataset.playerId));
                });
            });
        }
        
        function populatePlayerForm(player) {
            document.getElementById('player-id').value = player.id;
            document.getElementById('player-name').value = player.name;
            document.getElementById('player-status').value = player.status;
            document.getElementById('player-role').value = player.role;
            
            const photoPreview = document.getElementById('player-photo-preview');
            const removePhotoButton = document.getElementById('remove-photo-button');
            
            if (player.photo_url) {
                photoPreview.src = `${player.photo_url}?t=${new Date().getTime()}`; // Cache-busting
                removePhotoButton.classList.remove('hidden');
            } else {
                photoPreview.src = 'https://placehold.co/128x128/e2e8f0/64748b?text=⚽';
                removePhotoButton.classList.add('hidden');
            }
            AppState.selectedPhotoFile = null;
            document.getElementById('player-photo-input').value = '';
        }

        function clearPlayerForm() {
            document.getElementById('player-form').reset();
            document.getElementById('player-id').value = '';
            document.querySelectorAll('#players-list-admin .selectable-row').forEach(r => r.classList.remove('selected'));
            
            const photoPreview = document.getElementById('player-photo-preview');
            photoPreview.src = 'https://placehold.co/128x128/e2e8f0/64748b?text=⚽';
            document.getElementById('remove-photo-button').classList.add('hidden');
            AppState.selectedPhotoFile = null;
        }

        function handlePhotoPreview(event) {
            const file = event.target.files[0];
            if (!file) return;
            openCropperModal(file, 'player'); 
        }

        async function handleRemovePhoto() {
            const playerId = document.getElementById('player-id').value;
            if (!playerId) {
                showNotification('Selecciona un jugador primero.', 'warning');
                return;
            }

            const confirmed = await showModal('Confirmar Acción', '¿Estás seguro de que quieres restablecer la foto de este jugador a la imagen por defecto?');
            if (!confirmed) return;

            const { error } = await supabase.rpc('reset_player_photo', {
                player_id_to_reset: playerId
            });

            if (error) {
                showNotification(`Error al restablecer la foto: ${error.message}`, 'error');
            } else {
                showNotification('Foto restablecida a la imagen por defecto.', 'success');
                await refreshDataAndRender('players-management');
                
                const updatedPlayer = AppState.players.find(p => p.id == playerId);
                if (updatedPlayer) {
                    populatePlayerForm(updatedPlayer);
                } else {
                    clearPlayerForm();
                }
            }
        }

        async function handleSavePlayer(e) {
            e.preventDefault();
            const saveButton = document.getElementById('save-player-button');
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            let id = document.getElementById('player-id').value;
            const name = document.getElementById('player-name').value.trim();
            const playerData = {
                name: name,
                status: document.getElementById('player-status').value,
                role: document.getElementById('player-role').value,
            };

            // --- INICIO: Validación de nombre duplicado ---
            const normalizedName = name.toLowerCase();
            const existingPlayer = AppState.players.find(p => p.name.trim().toLowerCase() === normalizedName);

            if (existingPlayer && (!id || existingPlayer.id != id)) {
                showNotification('Ya existe un jugador con ese nombre.', 'error');
                saveButton.disabled = false;
                saveButton.textContent = 'Guardar Jugador';
                return;
            }
            // --- FIN: Validación de nombre duplicado ---

            try {
                let playerResponse;
                if (id) {
                    playerResponse = await supabase.from('players').update(playerData).eq('id', id).select().single();
                } else {
                    playerResponse = await supabase.from('players').insert(playerData).select().single();
                    id = playerResponse.data.id;
                }

                if (playerResponse.error) throw playerResponse.error;

                if (AppState.selectedPhotoFile) {
                    const file = AppState.selectedPhotoFile;
                    const filePath = `${id}/${Date.now()}_${file.name}`;

                    const { error: uploadError } = await supabase.storage
                        .from('player-photos')
                        .upload(filePath, file, { upsert: true });

                    if (uploadError) throw uploadError;

                    const { data: { publicUrl } } = supabase.storage
                        .from('player-photos')
                        .getPublicUrl(filePath);

                    const { error: urlError } = await supabase
                        .from('players')
                        .update({ photo_url: publicUrl })
                        .eq('id', id);
                    
                    if (urlError) throw urlError;
                }
                
                showNotification('Jugador guardado exitosamente.', 'success');
                await refreshDataAndRender('players-management');
                clearPlayerForm();

            } catch (error) {
                showNotification(`Error al guardar jugador: ${error.message}`, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Guardar Jugador';
            }
        }
        
        async function handleDeletePlayer() {
            const id = document.getElementById('player-id').value;
            if (!id) {
                showNotification('Por favor, selecciona un jugador de la lista para eliminarlo.', 'warning');
                return;
            }

            const player = AppState.players.find(p => p.id == id);
            const confirmed = await showModal(
                'Confirmar Eliminación', 
                `¿Estás seguro de que quieres eliminar a ${player ? player.name : 'este jugador'}? Esta acción no se puede deshacer.`
            );

            if (confirmed) {
                const { error } = await supabase.from('players').delete().eq('id', id);

                if (error) {
                    showNotification(`Error al eliminar jugador: ${error.message}`, 'error');
                } else {
                    showNotification('Jugador eliminado exitosamente.', 'success');
                    await refreshDataAndRender('players-management');
                    clearPlayerForm();
                }
            }
        }
        function renderUsersListAdmin(searchTerm = '') {
            const tableBody = document.getElementById('users-list-admin');
            const normalizedSearch = searchTerm.toLowerCase();
            let filteredUsers = AppState.users.filter(u =>
                (u.name && u.name.toLowerCase().includes(normalizedSearch)) ||
                u.email.toLowerCase().includes(normalizedSearch)
            );

            // Sorting logic
            const { key, dir } = userSortState;
            filteredUsers.sort((a, b) => {
                const valA = a[key] || '';
                const valB = b[key] || '';
                return dir === 'asc' 
                    ? String(valA).localeCompare(String(valB)) 
                    : String(valB).localeCompare(String(valA));
            });

            tableBody.innerHTML = filteredUsers.map(u => `
                <tr class="selectable-row border-b border-border-color cursor-pointer" data-user-id="${u.id}">
                    <td class="p-4">${u.email}</td>
                    <td class="p-4">${u.name || 'N/A'}</td>
                    <td class="p-4">${u.role || 'Sin Rol'}</td>
                </tr>`).join('');
            
            // Add visual indicators to headers
            document.querySelectorAll('#user-management-table-container th[data-sort-by]').forEach(th => {
                th.querySelector('.sort-icon')?.remove();
                if (th.dataset.sortBy === key) {
                    const icon = document.createElement('i');
                    icon.className = `fas fa-chevron-${dir === 'asc' ? 'up' : 'down'} ml-2 sort-icon`;
                    th.appendChild(icon);
                }
            });
            
            tableBody.querySelectorAll('.selectable-row').forEach(row => {
                row.addEventListener('click', () => {
                    tableBody.querySelectorAll('.selectable-row').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    populateUserForm(AppState.users.find(u => u.id === row.dataset.userId));
                });
            });
        }
        function populateUserForm(user) {
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-email').value = user.email;
            document.getElementById('user-name').value = user.name || '';
            document.getElementById('user-role').value = user.role || 'Operador';
        }
        function clearUserForm() {
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.querySelectorAll('#users-list-admin .selectable-row').forEach(r => r.classList.remove('selected'));
        }
        async function handleSaveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            if (!id) { showNotification('Selecciona un usuario de la lista.', 'warning'); return; }
            const userData = {
                name: document.getElementById('user-name').value,
                role: document.getElementById('user-role').value,
            };
            const { error } = await supabase.from('profiles').update(userData).eq('id', id);
            if (error) { 
                showNotification(`Error al guardar usuario: ${error.message}`, 'error'); 
            } else {
                showNotification('Usuario guardado.', 'success');
                await refreshDataAndRender('user-management');
                clearUserForm();
            }
        }
        function renderEditMatchPlayers(match) {
            document.getElementById('edit-match-date').value = match.match_date;
            const titularesDiv = document.getElementById('edit-titulares-players');
            const suplentesDiv = document.getElementById('edit-suplentes-players');
            const teamClarosDiv = document.getElementById('edit-team-claros');
            const teamOscurosDiv = document.getElementById('edit-team-oscuros');
            
            [titularesDiv, suplentesDiv, teamClarosDiv, teamOscurosDiv].forEach(div => div.innerHTML = '');

            const matchPlayerIds = new Set([
                ...(match.team_white_players || []).map(String), 
                ...(match.team_dark_players || []).map(String)
            ]);

            AppState.players.filter(p => p.status === 'Activo' && !matchPlayerIds.has(String(p.id)))
                .forEach(p => {
                    const playerEl = createPlayerElement(p);
                    if (p.role === 'Suplente') {
                        suplentesDiv.appendChild(playerEl);
                    } else {
                        titularesDiv.appendChild(playerEl);
                    }
                });

            (match.team_white_players || []).forEach(id => {
                const player = AppState.players.find(p => p.id == id);
                if (player) teamClarosDiv.appendChild(createPlayerElement(player));
            });
            (match.team_dark_players || []).forEach(id => {
                const player = AppState.players.find(p => p.id == id);
                if (player) teamOscurosDiv.appendChild(createPlayerElement(player));
            });
            
            setupPlayerInteractions('edit-match-container');
        }
        async function handleUpdateMatch() {
            const newDate = document.getElementById('edit-match-date').value;
            const newTeamWhite = Array.from(document.getElementById('edit-team-claros').children).map(el => el.dataset.id);
            const newTeamDark = Array.from(document.getElementById('edit-team-oscuros').children).map(el => el.dataset.id);
            let newResult = document.getElementById('edit-match-result').value;
            if (newResult === "") {
                newResult = null;
            }
            
            if (newTeamWhite.length + newTeamDark.length !== 10) {
                showNotification('Deben haber 10 jugadores en total para conformar los equipos.', 'warning');
                return;
            }

            const [teamsResult, resultResult] = await Promise.all([
                supabase.rpc('update_match_teams', {
                    match_id_param: AppState.selectedMatchId,
                    new_date_param: newDate,
                    new_team_white_param: newTeamWhite,
                    new_team_dark_param: newTeamDark
                }),
                supabase.rpc('update_match_result', {
                    match_id_param: AppState.selectedMatchId,
                    new_result: newResult
                })
            ]);

            const error = teamsResult.error || resultResult.error;
            
            if (error) { 
                showNotification(`Error al actualizar el partido: ${error.message}`, 'error');
            } else {
                showNotification('Partido actualizado.', 'success');
                await refreshDataAndRender('edit-match');
            }
        }
        
        function showNotification(message, type = 'success') {
            const { notificationModal, notificationContent, notificationIcon, notificationMessage } = DOMElements;
            
            notificationMessage.innerHTML = message;
            notificationContent.classList.remove('bg-success-color', 'bg-danger-color', 'bg-warning-color');
            notificationIcon.classList.remove('fa-check-circle', 'fa-exclamation-triangle', 'fa-times-circle');

            if (type === 'success') {
                notificationContent.classList.add('bg-success-color');
                notificationIcon.classList.add('fa-check-circle');
            } else {
                notificationContent.classList.add('bg-danger-color');
                notificationIcon.classList.add('fa-times-circle');
            }

            notificationModal.classList.remove('hidden');

            const timeoutId = setTimeout(() => {
                notificationModal.classList.add('hidden');
            }, 3000);

            const dismissNotification = (e) => {
                if (!notificationContent.contains(e.target)) {
                    notificationModal.classList.add('hidden');
                    clearTimeout(timeoutId);
                    notificationModal.removeEventListener('click', dismissNotification);
                }
            };
            notificationModal.addEventListener('click', dismissNotification);
        }

        function showCustomConfirm({ title, message, confirmText = 'Aceptar', cancelText = 'Cancelar', confirmClass = 'button-success', cancelClass = 'button-danger' }) {
            return new Promise(resolve => {
                DOMElements.modalTitle.textContent = title;
                DOMElements.modalMessage.textContent = message;

                const confirmBtn = DOMElements.modalConfirm;
                const cancelBtn = DOMElements.modalCancel;

                const originalState = {
                    confirm: { className: confirmBtn.className, textContent: confirmBtn.textContent },
                    cancel: { className: cancelBtn.className, textContent: cancelBtn.textContent },
                };

                confirmBtn.className = `px-4 py-2 font-semibold rounded-md hover:opacity-90 transition ${confirmClass}`;
                confirmBtn.textContent = confirmText;
                cancelBtn.className = `px-4 py-2 font-semibold rounded-md hover:opacity-90 transition ${cancelClass}`;
                cancelBtn.textContent = cancelText;
                
                DOMElements.modal.classList.remove('hidden');
                DOMElements.body.classList.add('modal-open');

                const cleanup = (result) => {
                    DOMElements.modal.classList.add('hidden');
                    DOMElements.body.classList.remove('modal-open');
                    
                    confirmBtn.className = originalState.confirm.className;
                    confirmBtn.textContent = originalState.confirm.textContent;
                    cancelBtn.className = originalState.cancel.className;
                    cancelBtn.textContent = originalState.cancel.textContent;
                    
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    DOMElements.modal.removeEventListener('click', dismissOnOverlayClick);
                    
                    resolve(result);
                };

                const confirmHandler = () => cleanup(true);
                const cancelHandler = () => cleanup(false);
                const dismissOnOverlayClick = (e) => {
                    if (e.target === DOMElements.modal) {
                        cleanup(false);
                    }
                };
                
                confirmBtn.addEventListener('click', confirmHandler);
                cancelBtn.addEventListener('click', cancelHandler);
                DOMElements.modal.addEventListener('click', dismissOnOverlayClick);
            });
        }
        
        function showModal(title, message) {
            return new Promise(resolve => {
                DOMElements.modalTitle.textContent = title;
                DOMElements.modalMessage.textContent = message;
                DOMElements.modal.classList.remove('hidden');
                DOMElements.body.classList.add('modal-open');

                const cleanup = (result) => {
                    DOMElements.modal.classList.add('hidden');
                    DOMElements.body.classList.remove('modal-open');
                    DOMElements.modalConfirm.removeEventListener('click', confirmHandler);
                    DOMElements.modalCancel.removeEventListener('click', cancelHandler);
                    DOMElements.modal.removeEventListener('click', dismissOnOverlayClick);
                    resolve(result);
                };

                const confirmHandler = () => cleanup(true);
                const cancelHandler = () => cleanup(false);
                const dismissOnOverlayClick = (e) => {
                    if (e.target === DOMElements.modal) {
                        cleanup(false);
                    }
                };
                
                DOMElements.modalConfirm.addEventListener('click', confirmHandler);
                DOMElements.modalCancel.addEventListener('click', cancelHandler);
                DOMElements.modal.addEventListener('click', dismissOnOverlayClick);
            });
        }

        function showAvatarModal() {
            const modal = document.getElementById('avatar-modal');
            const preview = document.getElementById('avatar-preview');
            const saveButton = document.getElementById('avatar-save-button');
            
            preview.src = AppState.avatarUrl ? `${AppState.avatarUrl}?t=${new Date().getTime()}` : 'https://placehold.co/128x128/e2e8f0/64748b?text=Avatar';
            saveButton.disabled = true;
            document.getElementById('avatar-upload-form').reset();

            modal.classList.remove('hidden');
            DOMElements.body.classList.add('modal-open');
        }

        function hideAvatarModal() {
            const modal = document.getElementById('avatar-modal');
            modal.classList.add('hidden');
            DOMElements.body.classList.remove('modal-open');
        }

        async function handleAvatarUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('avatar-file-input');
            const file = fileInput.files[0];
            if (!file) return;

            const saveButton = document.getElementById('avatar-save-button');
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            try {
                const { data: { user } } = await supabase.auth.getUser();
                const filePath = `${user.id}/${Date.now()}_${file.name}`;

                const { error: uploadError } = await supabase.storage
                    .from('avatars')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: true,
                    });

                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabase.storage
                    .from('avatars')
                    .getPublicUrl(filePath);

                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ avatar_url: publicUrl })
                    .eq('id', user.id);

                if (updateError) throw updateError;

                AppState.avatarUrl = publicUrl;
                setupUserMenu();
                hideAvatarModal();
                showNotification('Foto de perfil actualizada.', 'success');

            } catch (error) {
                console.error('Error al subir avatar:', error);
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = 'Guardar Foto';
            }
        }
        
        // --- INICIO: Funciones para el modal de recorte ---
        function openCropperModal(file, context) {
            cropperContext = context; // Guardamos el contexto
            const modal = document.getElementById('cropper-modal');
            const image = document.getElementById('cropper-image');
            const zoomSlider = document.getElementById('zoom-slider');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                image.src = e.target.result;
                modal.classList.remove('hidden');
                DOMElements.body.classList.add('modal-open');
                
                if (cropper) {
                    cropper.destroy();
                }
                
                cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    background: false,
                    autoCropArea: 0.8,
                    zoomable: true,
                    ready() {
                        zoomSlider.value = 0;
                        zoomSlider.oninput = () => {
                            cropper.zoomTo(zoomSlider.value);
                        };
                    }
                });
            };
            reader.readAsDataURL(file);
        }

        function closeCropperModal() {
            const modal = document.getElementById('cropper-modal');
            modal.classList.add('hidden');
            DOMElements.body.classList.remove('modal-open');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }
        
        function handleCropAndSave() {
            if (!cropper) return;
            
            cropper.getCroppedCanvas({
                width: 256,
                height: 256,
                imageSmoothingQuality: 'high',
            }).toBlob((blob) => {
                if (cropperContext === 'player') {
                    const preview = document.getElementById('player-photo-preview');
                    preview.src = URL.createObjectURL(blob);
                    
                    const originalFile = document.getElementById('player-photo-input').files[0];
                    const fileName = originalFile ? originalFile.name : 'cropped.png';
                    AppState.selectedPhotoFile = new File([blob], fileName, { type: blob.type });

                    document.getElementById('remove-photo-button').classList.remove('hidden');
                } else if (cropperContext === 'avatar') {
                    const preview = document.getElementById('avatar-preview');
                    preview.src = URL.createObjectURL(blob);

                    const originalFile = document.getElementById('avatar-file-input').files[0];
                    const fileName = originalFile ? originalFile.name : 'cropped.png';
                    AppState.selectedAvatarFile = new File([blob], fileName, { type: blob.type });

                    document.getElementById('avatar-save-button').disabled = false;
                }
                closeCropperModal();
            }, 'image/jpeg', 0.9);
        }

        document.getElementById('cropper-cancel-button').addEventListener('click', closeCropperModal);
        document.getElementById('cropper-save-button').addEventListener('click', handleCropAndSave);
        // --- FIN: Funciones para el modal de recorte ---


        document.getElementById('avatar-cancel-button').addEventListener('click', hideAvatarModal);
        document.getElementById('avatar-upload-form').addEventListener('submit', handleAvatarUpload);
        document.getElementById('avatar-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                openCropperModal(file, 'avatar'); // Llamamos al editor con el contexto 'avatar'
            }
        });

        async function handleAvatarUpload(e) {
            e.preventDefault();
            const file = AppState.selectedAvatarFile; // Usamos el archivo recortado
            if (!file) {
                showNotification("Por favor, selecciona y recorta una imagen primero.", "warning");
                return;
            }

            const saveButton = document.getElementById('avatar-save-button');
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            try {
                const { data: { user } } = await supabase.auth.getUser();
                const filePath = `${user.id}/${Date.now()}_${file.name}`;

                const { error: uploadError } = await supabase.storage
                    .from('avatars')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: true,
                    });

                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabase.storage
                    .from('avatars')
                    .getPublicUrl(filePath);

                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ avatar_url: publicUrl })
                    .eq('id', user.id);

                if (updateError) throw updateError;

                AppState.avatarUrl = publicUrl;
                AppState.selectedAvatarFile = null; // Limpiamos el estado
                setupUserMenu();
                hideAvatarModal();
                showNotification('Foto de perfil actualizada.', 'success');

            } catch (error) {
                console.error('Error al subir avatar:', error);
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = 'Guardar Foto';
            }
        }
        init();
    });
    </script>
</body>
</html>
