<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - LA CLANDE</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚽</text></svg>">

    <style>
        :root {
            --bg-primary: #f4f7fe;
            --bg-secondary: #ffffff;
            --bg-muted: #f9fafb;
            --sidebar-bg: #111827;
            --sidebar-text: #e5e7eb;
            --sidebar-active-bg: #4f46e5;
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #374151;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --accent-color: #4f46e5;
            --accent-color-hover: #4338ca;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --button-text-color: #ffffff;
        }

        html.dark {
            --bg-primary: #030712;
            --bg-secondary: #1f2937;
            --bg-muted: #111827;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
            --accent-color: #6366f1;
            --accent-color-hover: #818cf8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        body:has(#mobile-menu.translate-x-0),
        body.modal-open {
            overflow: hidden;
        }

        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        
        input, select {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        html.dark input, 
        html.dark select {
            background-color: #1f2937 !important;
            color: #f9fafb !important;
            -webkit-text-fill-color: #f9fafb !important;
            border-color: #374151 !important;
        }

        html.dark input:-webkit-autofill,
        html.dark input:-webkit-autofill:hover,
        html.dark input:-webkit-autofill:focus,
        html.dark input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1f2937 inset !important;
            -webkit-text-fill-color: #f9fafb !important;
        }

        input[readonly] {
            background-color: var(--bg-muted) !important;
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        html.dark ::-webkit-scrollbar-thumb { background: #555; }
        html.dark ::-webkit-scrollbar-thumb:hover { background: #888; }

        .nav-link.active {
            background-color: var(--sidebar-active-bg);
            color: var(--sidebar-active-text) !important;
        }
        
        .player-element {
            background-color: #374151;
            color: #ffffff;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            white-space: nowrap; 
            width: auto; 
            display: inline-flex;
            align-items: center;
            flex-grow: 0;
            user-select: none;
        }
        .player-element:hover {
            transform: scale(1.05);
        }
        
        .player-list-container {
             background-color: var(--bg-muted);
             align-content: flex-start;
        }
        
        .match-item.no-result { border-left-color: var(--danger-color); }
        .match-item.has-result { border-left-color: var(--success-color); }
        html.dark .match-item.no-result { background-color: rgba(239, 68, 68, 0.1); }
        html.dark .match-item.has-result { background-color: rgba(16, 185, 129, 0.1); }
        .match-item.selected { 
            border-color: var(--accent-color); 
            box-shadow: 0 0 0 2px var(--accent-color);
        }
        
        .selectable-row:hover { background-color: #f9fafb !important; }
        html.dark .selectable-row:hover { background-color: #1f2937 !important; }
        .selectable-row.selected { background-color: #eef2ff !important; }
        html.dark .selectable-row.selected { background-color: #3730a3 !important; }
        
        .tt-player-item.selected {
            background-color: var(--accent-color);
            color: var(--sidebar-active-text);
            border-color: var(--accent-color-hover);
        }
        .tt-player-item.selected span, .tt-player-item.selected i {
            color: var(--sidebar-active-text);
        }
        
        thead th { color: var(--text-secondary); }
        html.dark thead th { color: var(--sidebar-text); }
        
        .button-primary { background-color: var(--accent-color); color: var(--button-text-color); }
        .button-primary:hover { background-color: var(--accent-color-hover); }
        .button-success { background-color: var(--success-color); color: var(--button-text-color); }
        .button-danger { background-color: var(--danger-color); color: var(--button-text-color); }
        .button-warning { background-color: var(--warning-color); color: var(--button-text-color); }
        .button-secondary { background-color: var(--text-secondary); color: var(--button-text-color); }
        .button-purple { background-color: #9333ea; color: var(--button-text-color); }
        .button-purple:hover { background-color: #7e22ce; }

        .bg-success-color { background-color: var(--success-color); }
        .bg-danger-color { background-color: var(--danger-color); }
        .bg-warning-color { background-color: var(--warning-color); }

        body.logged-out #app-container { display: none; }
        .login-bg { background: #f0f2f5; }
        html.dark .login-bg { background: linear-gradient(165deg, #0f172a 0%, #1e293b 100%); }
        
        #mobile-menu {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
        }

        header.md\:hidden {
            background-color: var(--bg-secondary);
        }
        html.dark header.md\:hidden {
            background-color: var(--sidebar-bg);
        }

        .collapsible-toggle-button {
            background: linear-gradient(to right, var(--accent-color), var(--accent-color-hover));
            color: var(--button-text-color);
            transition: background 0.3s ease;
        }
        .collapsible-toggle-button.visible-content {
            background: linear-gradient(to right, #e53e3e, var(--danger-color));
        }

        html:not(.dark) .nav-link:not(.active):hover {
            background-color: #e5e7eb;
        }
        html:not(.dark) .dropdown-item:hover {
            background-color: #e5e7eb;
        }

        html.dark .nav-link:not(.active):hover {
            background-color: var(--sidebar-hover-bg);
        }
        html.dark .dropdown-item:hover {
            background-color: #374151;
        }
        
    </style>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="antialiased">

    <!-- Main Application Container -->
    <div id="app-container" class="flex min-h-screen hidden">
        <!-- Sidebar for Desktop -->
        <aside id="sidebar" class="w-64 flex-col hidden md:flex">
            <div class="px-6 py-4 flex items-center">
                <a href="#" class="text-xl font-bold flex items-center gap-2">
                    <span class="text-2xl">⚽</span>
                    <span>LA CLANDE</span>
                </a>
            </div>
            
            <nav id="main-nav" class="flex-1 px-4 space-y-2 overflow-y-auto">
                <!-- Los enlaces de navegación se insertan aquí con JS -->
            </nav>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col relative">
            <header class="flex items-center justify-between p-4 border-b border-border-color text-text-primary dark:text-sidebar-text md:hidden sticky top-0 z-30">
                <div class="w-10">
                     <button id="mobile-menu-toggle" class="p-2 rounded-md -ml-2">
                        <i class="fas fa-bars text-lg"></i>
                    </button>
                </div>
                <div class="flex-1 text-center">
                    <a href="#" class="text-xl font-bold flex items-center gap-2 justify-center">
                        <span class="text-2xl">⚽</span>
                        <span>LA CLANDE</span>
                    </a>
                </div>
                <div id="mobile-user-menu-container" class="w-10 relative flex justify-end items-center">
                    <!-- El menú de usuario para móvil se insertará aquí -->
                </div>
            </header>
            
            <main class="flex-1 bg-primary p-4 sm:p-6 lg:p-8 overflow-y-auto">
                <div id="admin-content-area" class="max-w-7xl mx-auto">
                    <div id="loading-container" class="flex items-center justify-center h-64">
                        <i class="fas fa-spinner fa-spin text-4xl text-accent-color"></i>
                    </div>
                    <div id="admin-content" class="hidden">
                        <!-- El contenido dinámico de cada sección se renderiza aquí -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Menú móvil -->
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>
    <div id="mobile-menu" class="hidden fixed top-0 left-0 h-full w-64 bg-secondary shadow-xl z-50 transform -translate-x-full transition-transform duration-300 ease-in-out">
        <!-- El contenido del menú móvil se inserta aquí con JS -->
    </div>

    <!-- Contenedor de autenticación -->
    <div id="auth-container" class="hidden fixed inset-0 z-50 flex items-center justify-center login-bg">
        <div class="w-full max-w-md p-4">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-text-secondary">Panel de Administración</h1>
                <h2 class="text-4xl font-extrabold text-text-primary mt-2 flex items-center justify-center gap-3">
                    <span>LA CLANDE ⚽</span>
                </h2>
            </div>
            <div class="card rounded-xl shadow-lg p-8 relative">
                <div class="absolute top-4 right-4">
                    <button id="login-dark-mode-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 theme-toggle-button">
                        <i class="fas fa-moon text-lg text-text-secondary"></i>
                    </button>
                </div>
                <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="email" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium mb-1">Contraseña</label>
                        <div class="relative">
                            <input type="password" id="password" class="w-full p-2 border rounded-md pr-10" required>
                            <button type="button" id="password-toggle" class="absolute inset-y-0 right-0 px-3 flex items-center text-text-secondary">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button id="login-button" type="submit" class="w-full px-6 py-3 button-primary font-semibold rounded-lg shadow-md transition duration-300">
                        Entrar
                    </button>
                    <div class="text-center mt-4">
                        <a href="recuperar-pass.html" class="text-sm text-accent-color hover:underline">¿Olvidaste tu contraseña?</a>
                    </div>
                    <p id="auth-status" class="text-center text-danger-color mt-4 h-5"></p>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modales -->
    <div id="notification-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-[100] p-4">
        <div id="notification-content" class="flex items-center gap-4 text-white font-semibold p-6 rounded-lg shadow-xl max-w-sm w-full">
            <i id="notification-icon" class="fas fa-2x"></i>
            <span id="notification-message"></span>
        </div>
    </div>

    <div id="custom-confirm-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card rounded-lg shadow-xl max-w-sm w-full p-6">
            <h3 class="text-lg font-semibold mb-2" id="modal-title">Confirmar Acción</h3>
            <p class="text-secondary mb-6" id="modal-message">¿Estás seguro?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-button" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">Cancelar</button>
                <button id="modal-confirm-button" class="px-4 py-2 button-danger font-semibold rounded-md hover:opacity-90 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="player-assignment-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card rounded-lg shadow-xl max-w-xs w-full p-6 text-center">
            <h3 class="text-lg font-semibold mb-2" id="assign-modal-title">Asignar Jugador</h3>
            <p class="text-secondary mb-6" id="assign-modal-player-name">Nombre del Jugador</p>
            <div class="flex flex-col space-y-3">
                <button id="assign-to-claros" class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-100 text-black font-semibold rounded-md hover:opacity-90 transition">Mover a Claros</button>
                <!-- CHANGE: Improved contrast for dark mode -->
                <button id="assign-to-oscuros" class="w-full px-4 py-2 bg-gray-900 border border-gray-700 text-white font-semibold rounded-md hover:bg-gray-700 transition">Mover a Oscuros</button>
                <button id="assign-modal-cancel" class="mt-4 text-sm text-secondary hover:underline">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="change-name-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card rounded-lg shadow-xl max-w-sm w-full p-6">
            <h3 class="text-lg font-semibold mb-4">Cambiar Nombre</h3>
            <form id="change-name-form">
                <label for="new-user-name" class="block text-sm font-medium mb-1">Nuevo nombre de usuario</label>
                <input type="text" id="new-user-name" class="w-full p-2 border rounded-md mb-4" required>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="change-name-cancel" class="px-4 py-2 button-danger font-semibold rounded-md hover:opacity-90 transition">Cancelar</button>
                    <button type="submit" class="px-4 py-2 button-primary font-semibold rounded-md hover:opacity-90 transition">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="change-password-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
        <div class="card rounded-lg shadow-xl max-w-sm w-full p-6">
            <h3 class="text-lg font-semibold mb-4">Cambiar Contraseña</h3>
            <form id="change-password-form" class="space-y-4">
                <div>
                    <label for="new-password-modal-input" class="block text-sm font-medium mb-1">Nueva Contraseña</label>
                    <input type="password" id="new-password-modal-input" class="w-full p-2 border rounded-md" required placeholder="Mínimo 8 caracteres">
                </div>
                <div>
                    <label for="confirm-new-password-modal-input" class="block text-sm font-medium mb-1">Confirmar Nueva Contraseña</label>
                    <input type="password" id="confirm-new-password-modal-input" class="w-full p-2 border rounded-md" required>
                </div>
                 <p id="password-change-status" class="text-center text-danger-color h-5"></p>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="change-password-cancel" class="px-4 py-2 button-danger font-semibold rounded-md hover:opacity-90 transition">Cancelar</button>
                    <button type="submit" class="px-4 py-2 button-primary font-semibold rounded-md hover:opacity-90 transition">Guardar</button>
                </div>
            </form>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & STATE ---
        const SUPABASE_URL = 'https://ccvfhajwlfhnrmftqpxs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjdmZoYWp3bGZobnJtZnRxcHhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMTQyMDksImV4cCI6MjA2ODc5MDIwOX0._7seIybO8-cvmj0qd4a86Cht63Yl2Y0OPGSenEv9emk';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const AppState = {
            players: [],
            matches: [],
            users: [],
            userRole: null,
            userName: null,
            userEmail: null,
            selectedMatchId: null,
            isInitialized: false,
            isInitializing: false,
            activePlayerElement: null,
            realtimeChannel: null,
            heartbeatInterval: null
        };

        const NAV_ITEMS = {
            main: [
                { id: 'team-formation', name: 'Armar Equipos', icon: 'fa-users-cog' },
                { id: 'match-results', name: 'Resultados', icon: 'fa-trophy' },
                { id: 'chamigo-management', name: 'Chamigo', icon: 'fa-star' },
                { id: 'tt-attendance', name: 'Asistencia TT', icon: 'fa-beer' },
            ],
            admin: [
                { id: 'edit-match', name: 'Editar Partido', icon: 'fa-edit' },
                { id: 'players-management', name: 'ABM Jugadores', icon: 'fa-user-plus' },
                { id: 'user-management', name: 'ABM Usuarios', icon: 'fa-user-shield' },
            ],
            links: [
                { href: 'index.html', name: 'Ver Estadísticas', icon: 'fa-chart-line' }
            ]
        };

        const DOMElements = {
            body: document.body,
            appContainer: document.getElementById('app-container'),
            mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
            mobileMenu: document.getElementById('mobile-menu'),
            mobileMenuOverlay: document.getElementById('mobile-menu-overlay'),
            mainNav: document.getElementById('main-nav'),
            authContainer: document.getElementById('auth-container'),
            adminContent: document.getElementById('admin-content'),
            loadingContainer: document.getElementById('loading-container'),
            loginForm: document.getElementById('login-form'),
            authStatus: document.getElementById('auth-status'),
            modal: document.getElementById('custom-confirm-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirm: document.getElementById('modal-confirm-button'),
            modalCancel: document.getElementById('modal-cancel-button'),
            playerAssignmentModal: document.getElementById('player-assignment-modal'),
            assignModalPlayerName: document.getElementById('assign-modal-player-name'),
            assignToClarosBtn: document.getElementById('assign-to-claros'),
            assignToOscurosBtn: document.getElementById('assign-to-oscuros'),
            assignModalCancelBtn: document.getElementById('assign-modal-cancel'),
            notificationModal: document.getElementById('notification-modal'),
            notificationContent: document.getElementById('notification-content'),
            notificationIcon: document.getElementById('notification-icon'),
            notificationMessage: document.getElementById('notification-message'),
            changeNameModal: document.getElementById('change-name-modal'),
            changePasswordModal: document.getElementById('change-password-modal'),
            changeNameForm: document.getElementById('change-name-form'),
            changePasswordForm: document.getElementById('change-password-form'),
        };

        function init() {
            setupTheme();
            setupEventListeners();
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' || (event === 'INITIAL_SESSION' && session)) {
                    if (!AppState.isInitialized) loadAdminPanel(session);
                } 
                else if (event === 'SIGNED_OUT' || (event === 'INITIAL_SESSION' && !session)) {
                    showLoginScreen();
                    if (AppState.realtimeChannel) {
                        supabase.removeChannel(AppState.realtimeChannel);
                        AppState.realtimeChannel = null;
                        clearInterval(AppState.heartbeatInterval);
                    }
                }
            });
        }

        async function loadAdminPanel(session) {
            if (AppState.isInitializing) return;
            AppState.isInitializing = true;
            DOMElements.body.classList.remove('logged-out');
            
            DOMElements.authContainer.classList.add('hidden');
            DOMElements.appContainer.classList.remove('hidden');
            DOMElements.loadingContainer.classList.remove('hidden');
            DOMElements.adminContent.classList.add('hidden');
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                const { data: profile } = await supabase.from('profiles').select('role, name').eq('id', user.id).single();
                
                AppState.userRole = profile ? profile.role : null;
                AppState.userName = profile?.name || user.user_metadata?.name || user.email.split('@')[0];
                AppState.userEmail = user.email;


                const [playersRes, matchesRes, usersRes] = await Promise.allSettled([
                    supabase.from('players').select('*').order('id', { ascending: true }),
                    supabase.from('matches').select('*').order('match_date', { ascending: false }),
                    AppState.userRole === 'Admin' ? supabase.rpc('get_all_users_with_roles') : Promise.resolve({ data: [], error: null })
                ]);

                AppState.players = (playersRes.status === 'fulfilled' && !playersRes.value.error) ? (playersRes.value.data || []) : [];
                if (playersRes.value?.error) showNotification("Error al cargar jugadores.", "error");

                AppState.matches = (matchesRes.status === 'fulfilled' && !matchesRes.value.error) ? (matchesRes.value.data || []) : [];
                if (matchesRes.value?.error) showNotification("Error al cargar partidos.", "error");
                
                if (AppState.userRole === 'Admin') {
                    AppState.users = (usersRes.status === 'fulfilled' && usersRes.value && !usersRes.value.error) ? (usersRes.value.data || []) : [];
                    if (usersRes.value?.error) showNotification("Error al cargar usuarios (Admin).", "error");
                }

                setupUI();
                
                setupRealtimeSubscriptions();
                
                const savedTab = localStorage.getItem('lastAdminTab');
                const allNavItems = [...NAV_ITEMS.main, ...NAV_ITEMS.admin];
                const isValidTab = allNavItems.some(item => item.id === savedTab);
                let initialTab = NAV_ITEMS.main[0].id;

                if (isValidTab) {
                    const isAdminTab = NAV_ITEMS.admin.some(item => item.id === savedTab);
                    if (!isAdminTab || (isAdminTab && AppState.userRole === 'Admin')) {
                        initialTab = savedTab;
                    }
                }
                await navigateTo(initialTab);

            } catch (error) {
                console.error("Fatal error during admin panel setup:", error);
                showNotification("Ocurrió un error inesperado al cargar el panel.", "error");
                await supabase.auth.signOut();
            } finally {
                DOMElements.loadingContainer.classList.add('hidden');
                DOMElements.adminContent.classList.remove('hidden');
                AppState.isInitializing = false;
                AppState.isInitialized = true;
                window.scrollTo(0, 0);
            }
        }
        
        function setupRealtimeSubscriptions() {
            // Si ya existe un canal, lo removemos para empezar de cero.
            if (AppState.realtimeChannel) {
                supabase.removeChannel(AppState.realtimeChannel);
                AppState.realtimeChannel = null;
            }
            // Detenemos cualquier heartbeat anterior.
            clearInterval(AppState.heartbeatInterval);
            
            console.log('Setting up Realtime subscriptions...');

            const handleChanges = (payload) => {
                console.log('Change received!', payload);
                const { table, eventType, new: newRecord, old: oldRecord } = payload;
                
                let dataArray;
                
                switch(table) {
                    case 'players': dataArray = AppState.players; break;
                    case 'matches': dataArray = AppState.matches; break;
                    case 'profiles': dataArray = AppState.users; break;
                    default: return;
                }

                if (eventType === 'INSERT') {
                    if (!dataArray.some(item => item.id === newRecord.id)) {
                        dataArray.push(newRecord);
                    }
                } else if (eventType === 'UPDATE') {
                    const index = dataArray.findIndex(item => item.id === newRecord.id);
                    if (index !== -1) {
                        dataArray[index] = { ...dataArray[index], ...newRecord };
                    } else {
                        dataArray.push(newRecord);
                    }
                } else if (eventType === 'DELETE') {
                    const idToDelete = oldRecord.id;
                    const index = dataArray.findIndex(item => item.id === idToDelete);
                    if (index !== -1) {
                        dataArray.splice(index, 1);
                    }
                }

                if (table === 'matches') {
                    AppState.matches.sort((a, b) => new Date(b.match_date) - new Date(a.match_date));
                }
                
                const currentTab = localStorage.getItem('lastAdminTab');
                if (currentTab) {
                    navigateTo(currentTab);
                }
            };
            
            const channel = supabase.channel('public:admin_changes', {
                config: {
                    broadcast: { ack: true }
                }
            });

            const startHeartbeat = () => {
                clearInterval(AppState.heartbeatInterval);
                AppState.heartbeatInterval = setInterval(() => {
                    if (channel.state === 'joined') {
                        channel.send({
                            type: 'broadcast',
                            event: 'heartbeat',
                            payload: { message: 'alive' },
                        });
                        console.log('Realtime heartbeat sent.');
                    }
                }, 30000);
            };

            const stopHeartbeat = () => {
                clearInterval(AppState.heartbeatInterval);
            };

            channel
                .on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, handleChanges)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, handleChanges)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, handleChanges)
                .subscribe((status, err) => {
                    console.log(`Realtime status: ${status}`);
                    if (status === 'SUBSCRIBED') {
                        console.log('Realtime channel subscribed successfully!');
                        startHeartbeat();
                    } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                        console.error(`Realtime channel issue: ${status}`, err);
                        stopHeartbeat();
                        // Intentamos reconectar después de 5 segundos
                        setTimeout(() => setupRealtimeSubscriptions(), 5000); 
                    } else if (status === 'CLOSED') {
                        console.warn('Realtime channel closed.');
                        stopHeartbeat();
                    }
                });

            AppState.realtimeChannel = channel;
        }
        
        function showLoginScreen() {
            AppState.isInitialized = false;
            DOMElements.body.classList.add('logged-out');
            DOMElements.appContainer.classList.add('hidden');
            DOMElements.loadingContainer.classList.add('hidden');
            DOMElements.adminContent.classList.add('hidden');
            DOMElements.authContainer.classList.remove('hidden');
            DOMElements.mobileMenu.classList.remove('translate-x-0');
            DOMElements.mobileMenu.classList.add('-translate-x-full');
            DOMElements.mobileMenuOverlay.classList.add('hidden');

            const loginButton = document.getElementById('login-button');
            if (loginButton) {
                loginButton.disabled = false;
                loginButton.innerHTML = 'Entrar';
            }
            DOMElements.loginForm.reset();
            DOMElements.authStatus.textContent = '';
        }

        function setupTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            }
            document.body.addEventListener('click', e => {
                if (e.target.closest('.theme-toggle-button')) {
                    toggleTheme();
                }
            });
        }

        function toggleTheme() {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
        }

        function updateThemeToggleIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            const toggleButtons = document.querySelectorAll('.theme-toggle-button');

            toggleButtons.forEach(btn => {
                if (btn) {
                    const icon = btn.querySelector('i');
                    const span = btn.querySelector('span');
                    if(icon) {
                        icon.classList.toggle('fa-moon', !isDark);
                        icon.classList.toggle('fa-sun', isDark);
                    }
                    if (span) {
                        span.textContent = isDark ? 'Modo Claro' : 'Modo Oscuro';
                    }
                }
            });
        }

        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            localStorage.setItem('theme', theme);
            updateThemeToggleIcons();

            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                if (theme === 'dark') {
                    sidebar.classList.add('bg-sidebar-bg', 'text-sidebar-text');
                    sidebar.classList.remove('bg-secondary', 'text-text-primary', 'border-r', 'border-border-color');
                } else {
                    sidebar.classList.remove('bg-sidebar-bg', 'text-sidebar-text');
                    sidebar.classList.add('bg-secondary', 'text-text-primary', 'border-r', 'border-border-color');
                }
            }
        }

        function setupUI() {
            setupDesktopNav();
            setupMobileMenu();
        }
        
        function setupDesktopNav() {
            let navHtml = `
                <div>
                    <span class="px-4 text-xs font-semibold uppercase text-gray-400">Principal</span>
                    <div class="mt-2 space-y-1">
                        ${NAV_ITEMS.main.map(item => `
                            <a href="#" data-tab="${item.id}" class="nav-link w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200">
                                <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                            </a>`).join('')}
                    </div>
                </div>`;
            
            if (AppState.userRole === 'Admin') {
                navHtml += `
                    <div class="mt-6" data-role="Admin">
                        <span class="px-4 text-xs font-semibold uppercase text-gray-400">Administración</span>
                        <div class="mt-2 space-y-1">
                            ${NAV_ITEMS.admin.map(item => `
                                <a href="#" data-tab="${item.id}" class="nav-link w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200">
                                    <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                                </a>`).join('')}
                        </div>
                    </div>`;
            }

            navHtml += `
                <div class="mt-6">
                    <span class="px-4 text-xs font-semibold uppercase text-gray-400">Enlaces</span>
                    <div class="mt-2 space-y-1">
                        ${NAV_ITEMS.links.map(item => `
                            <a href="${item.href}" target="_blank" rel="noopener noreferrer" class="nav-link w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200">
                                <i class="fas ${item.icon} w-5 text-center"></i><span>${item.name}</span>
                            </a>`).join('')}
                    </div>
                </div>`;

            DOMElements.mainNav.innerHTML = navHtml;
            
            document.querySelectorAll('#main-nav .nav-link').forEach(link => {
                link.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await navigateTo(e.currentTarget.dataset.tab);
                });
            });
        }
        
        function setupMobileMenu() {
            const adminItemsHtml = AppState.userRole === 'Admin' ? NAV_ITEMS.admin.map(item => `<li><a href="#" data-tab="${item.id}" class="nav-link block px-4 py-2 text-sm text-text-secondary hover:bg-bg-muted rounded-md">${item.name}</a></li>`).join('') : '';

            const menuHtml = `
                <div class="p-4 flex justify-between items-center border-b border-border-color">
                    <span class="font-bold">Menú</span>
                    <button id="close-mobile-menu" class="p-2 -mr-2"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-2 space-y-1">
                    <div>
                        <button id="mobile-main-trigger" class="collapsible-trigger w-full flex justify-between items-center px-2 py-2 text-left font-semibold text-text-primary rounded-md hover:bg-bg-muted">
                            <span>Principal</span>
                            <i class="fas fa-chevron-down transform transition-transform"></i>
                        </button>
                        <ul id="mobile-main-content" class="collapsible-content mt-1 space-y-1 pl-4">
                            ${NAV_ITEMS.main.map(item => `<li><a href="#" data-tab="${item.id}" class="nav-link block px-4 py-2 text-sm text-text-secondary hover:bg-bg-muted rounded-md">${item.name}</a></li>`).join('')}
                        </ul>
                    </div>
                    ${AppState.userRole === 'Admin' ? `
                    <div>
                        <button class="collapsible-trigger w-full flex justify-between items-center px-2 py-2 text-left font-semibold text-text-primary rounded-md hover:bg-bg-muted">
                            <span>Administración</span>
                            <i class="fas fa-chevron-down transform transition-transform"></i>
                        </button>
                        <ul class="collapsible-content hidden mt-1 space-y-1 pl-4">
                            ${adminItemsHtml}
                        </ul>
                    </div>` : ''}
                    <div class="border-t border-border-color my-1"></div>
                    <div>
                        <a href="${NAV_ITEMS.links[0].href}" target="_blank" rel="noopener noreferrer" class="w-full flex items-center gap-3 px-2 py-2 text-left font-semibold text-text-primary rounded-md hover:bg-bg-muted">
                            <i class="fas ${NAV_ITEMS.links[0].icon} w-5 text-center"></i>
                            <span>${NAV_ITEMS.links[0].name}</span>
                        </a>
                    </div>
                    <div class="border-t border-border-color my-1"></div>
                    <button id="mobile-dark-mode-toggle" class="theme-toggle-button w-full flex items-center gap-3 px-2 py-2 text-left text-text-secondary rounded-md hover:bg-bg-muted">
                        <i class="fas fa-moon w-5 text-center"></i>
                        <span>Modo Oscuro</span>
                    </button>
                </div>
            `;
            DOMElements.mobileMenu.innerHTML = menuHtml;
            
            const mainContent = document.getElementById('mobile-main-content');
            const mainTriggerIcon = document.getElementById('mobile-main-trigger').querySelector('i');
            mainContent.classList.remove('hidden');
            mainTriggerIcon.classList.add('rotate-180');
            
            DOMElements.mobileMenu.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', async e => {
                    e.preventDefault();
                    e.stopPropagation();
                    await navigateTo(e.currentTarget.dataset.tab);
                    closeMobileMenu();
                });
            });
            
            DOMElements.mobileMenu.querySelectorAll('.collapsible-trigger').forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const content = trigger.nextElementSibling;
                    const icon = trigger.querySelector('i');
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                });
            });
            
            document.getElementById('close-mobile-menu').addEventListener('click', closeMobileMenu);
            
            updateThemeToggleIcons();
        }
        
        async function navigateTo(tabId) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.tab === tabId);
            });
            
            const renderFunction = window[`render_${tabId.replace(/-/g, '_')}`];
            if (typeof renderFunction === 'function') {
                renderFunction();
                localStorage.setItem('lastAdminTab', tabId);
                setupUserMenu();
            } else {
                DOMElements.adminContent.innerHTML = `<h1 class="text-2xl font-bold">Contenido para ${tabId} no implementado.</h1>`;
            }
        }

        function openMobileMenu() {
            DOMElements.mobileMenuOverlay.classList.remove('hidden');
            DOMElements.mobileMenu.classList.remove('hidden');
            setTimeout(() => {
                 DOMElements.mobileMenu.classList.remove('-translate-x-full');
                 DOMElements.mobileMenu.classList.add('translate-x-0');
            }, 10);
        }

        function closeMobileMenu() {
            DOMElements.mobileMenu.classList.add('-translate-x-full');
            DOMElements.mobileMenu.classList.remove('translate-x-0');
            DOMElements.mobileMenuOverlay.classList.add('hidden');
        }

        function setupEventListeners() {
            DOMElements.mobileMenuToggle.addEventListener('click', openMobileMenu);
            DOMElements.mobileMenuOverlay.addEventListener('click', closeMobileMenu);
            
            DOMElements.loginForm.addEventListener('submit', handleLogin);
            
            document.addEventListener('click', async (e) => {
                if (e.target.closest('.signout-trigger')) {
                    await supabase.auth.signOut().catch(err => showNotification(`Error: ${err.message}`, 'error'));
                }
            });

            document.addEventListener('click', (e) => {
                const openDropdown = document.querySelector('.user-menu-dropdown:not(.hidden)');
                if (openDropdown && !e.target.closest('.user-menu-button') && !e.target.closest('.user-menu-dropdown')) {
                    openDropdown.classList.add('hidden');
                }
            });

            const passwordInput = document.getElementById('password');
            const passwordToggle = document.getElementById('password-toggle');
            if (passwordToggle && passwordInput) {
                passwordToggle.addEventListener('click', () => {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    passwordToggle.querySelector('i').classList.toggle('fa-eye-slash');
                });
            }

            DOMElements.assignToClarosBtn.addEventListener('click', () => movePlayerToTeam('team-claros'));
            DOMElements.assignToOscurosBtn.addEventListener('click', () => movePlayerToTeam('team-oscuros'));
            DOMElements.assignModalCancelBtn.addEventListener('click', hidePlayerAssignmentModal);
            DOMElements.playerAssignmentModal.addEventListener('click', (e) => {
                if (e.target.id === 'player-assignment-modal') hidePlayerAssignmentModal();
            });

            DOMElements.changeNameForm.addEventListener('submit', handleUpdateName);
            DOMElements.changePasswordForm.addEventListener('submit', handleUpdatePassword);
            document.getElementById('change-name-cancel').addEventListener('click', hideChangeNameModal);
            document.getElementById('change-password-cancel').addEventListener('click', hideChangePasswordModal);

            DOMElements.changeNameModal.addEventListener('click', (e) => {
                if (e.target.id === 'change-name-modal') hideChangeNameModal();
            });
            DOMElements.changePasswordModal.addEventListener('click', (e) => {
                if (e.target.id === 'change-password-modal') hideChangePasswordModal();
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            const loginButton = document.getElementById('login-button');
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
            
            const { error } = await supabase.auth.signInWithPassword({ 
                email: document.getElementById('email').value, 
                password: document.getElementById('password').value 
            });

            if (error) {
                DOMElements.authStatus.textContent = 'Email o contraseña incorrectos.';
                loginButton.disabled = false;
                loginButton.textContent = 'Entrar';
            }
        }
        
        const tabContentTemplate = (title, content) => `
            <div class="space-y-6">
                <div class="relative flex items-center justify-center md:justify-between p-4 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 dark:from-indigo-700 dark:to-purple-700 shadow-lg">
                    <div class="w-16 md:w-40 hidden md:block"></div>
                    <h1 class="flex-1 text-2xl font-bold tracking-tight uppercase text-center text-white">${title}</h1>
                    <div id="user-menu-container" class="relative w-16 md:w-40 hidden md:flex justify-end">
                    </div>
                </div>
                ${content}
            </div>`;

        const cardTemplate = (title, body) => `
            <div class="card rounded-xl shadow-sm overflow-hidden">
                <h3 class="text-lg font-semibold text-center uppercase tracking-wider p-3 text-gray-800 bg-gray-200 dark:bg-gray-900 dark:text-gray-200">${title}</h3>
                <div class="p-6">${body}</div>
            </div>`;
        
        function setupUserMenu() {
            const desktopContainer = document.getElementById('user-menu-container');
            const mobileContainer = document.getElementById('mobile-user-menu-container');
            
            if (!desktopContainer || !mobileContainer) return;

            const userName = AppState.userName || 'Usuario';
            const userEmail = AppState.userEmail || 'email@example.com';
            
            const dropdownHTML = `
                <div class="user-menu-dropdown card hidden origin-top-right absolute right-0 top-full mt-2 w-56 rounded-md shadow-lg py-1 text-sm z-50">
                    <div class="px-4 py-2 border-b border-border-color">
                        <p class="font-semibold truncate text-text-primary">${userName}</p>
                        <p class="text-xs text-text-secondary truncate">${userEmail}</p>
                    </div>
                    <a href="#" class="change-name-trigger dropdown-item block px-4 py-2 text-text-primary">Cambiar nombre</a>
                    <a href="#" class="change-password-trigger dropdown-item block px-4 py-2 text-text-primary">Cambiar contraseña</a>
                    <div class="border-t border-border-color my-1"></div>
                    <button class="theme-toggle-button dropdown-item w-full text-left flex items-center gap-2 px-4 py-2 text-text-primary">
                        <i class="fas fa-moon w-5 text-center"></i>
                        <span>Modo Oscuro</span>
                    </button>
                    <div class="border-t border-border-color my-1"></div>
                    <a href="#" class="signout-trigger dropdown-item flex items-center gap-2 px-4 py-2 text-danger-color">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Cerrar Sesión</span>
                    </a>
                </div>
            `;

            desktopContainer.innerHTML = `
                <button class="user-menu-button flex items-center gap-2 p-2 rounded-full hover:bg-white/20 transition-colors">
                    <span class="font-semibold text-sm hidden sm:inline truncate max-w-[100px] text-white">${userName}</span>
                    <i class="fas fa-user-circle text-2xl text-white"></i>
                </button>
                ${dropdownHTML}
            `;

            mobileContainer.innerHTML = `
                <button class="user-menu-button flex items-center">
                     <i class="fas fa-user-circle text-2xl"></i>
                </button>
                ${dropdownHTML}
            `;

            document.querySelectorAll('.user-menu-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.user-menu-dropdown').forEach(d => {
                        if (d !== button.nextElementSibling) d.classList.add('hidden');
                    });
                    button.nextElementSibling.classList.toggle('hidden');
                });
            });

            document.querySelectorAll('.change-name-trigger').forEach(trigger => {
                trigger.addEventListener('click', (e) => {
                    e.preventDefault();
                    trigger.closest('.user-menu-dropdown').classList.add('hidden');
                    showChangeNameModal();
                });
            });
            
            document.querySelectorAll('.change-password-trigger').forEach(trigger => {
                 trigger.addEventListener('click', (e) => {
                    e.preventDefault();
                    trigger.closest('.user-menu-dropdown').classList.add('hidden');
                    showChangePasswordModal();
                });
            });
            
            updateThemeToggleIcons();
        }

        function showChangeNameModal() {
            const input = document.getElementById('new-user-name');
            input.value = AppState.userName;
            DOMElements.changeNameModal.classList.remove('hidden');
            DOMElements.body.classList.add('modal-open');
            setTimeout(() => input.select(), 50);
        }

        function hideChangeNameModal() {
            DOMElements.changeNameModal.classList.add('hidden');
            DOMElements.body.classList.remove('modal-open');
        }

        function showChangePasswordModal() {
            DOMElements.changePasswordForm.reset();
            document.getElementById('password-change-status').textContent = '';
            DOMElements.changePasswordModal.classList.remove('hidden');
            DOMElements.body.classList.add('modal-open');
        }

        function hideChangePasswordModal() {
            DOMElements.changePasswordModal.classList.add('hidden');
            DOMElements.body.classList.remove('modal-open');
        }

        async function handleUpdateName(e) {
            e.preventDefault();
            const newName = document.getElementById('new-user-name').value.trim();
            if (!newName) {
                showNotification('El nombre no puede estar vacío.', 'error');
                return;
            }

            const { data: { user } } = await supabase.auth.getUser();

            const { error: profileError } = await supabase.from('profiles').update({ name: newName }).eq('id', user.id);
            const { data: updatedUser, error: authError } = await supabase.auth.updateUser({ data: { name: newName } });

            if (authError || profileError) {
                showNotification(`Error al actualizar el nombre: ${authError?.message || profileError?.message}`, 'error');
            } else {
                showNotification('Nombre actualizado con éxito.', 'success');
                AppState.userName = newName;
                hideChangeNameModal();
                setupUserMenu();
            }
        }

        async function handleUpdatePassword(e) {
            e.preventDefault();
            const newPassword = document.getElementById('new-password-modal-input').value;
            const confirmPassword = document.getElementById('confirm-new-password-modal-input').value;
            const statusEl = document.getElementById('password-change-status');

            statusEl.textContent = '';

            if (newPassword.length < 8) {
                statusEl.textContent = 'La contraseña debe tener al menos 8 caracteres.';
                return;
            }
            if (newPassword !== confirmPassword) {
                statusEl.textContent = 'Las contraseñas no coinciden.';
                return;
            }

            const { error } = await supabase.auth.updateUser({ password: newPassword });

            if (error) {
                 statusEl.textContent = error.message.includes('weak password') 
                    ? 'Contraseña débil. Usar mayúsculas, números y símbolos.'
                    : `Error: ${error.message}`;
            } else {
                showNotification('Contraseña actualizada con éxito.', 'success');
                hideChangePasswordModal();
            }
        }
        
        function insertPlayerAlphabetically(playerEl, listEl) {
            const playerName = playerEl.textContent;
            let inserted = false;
            for (const child of listEl.children) {
                if (playerName.localeCompare(child.textContent) < 0) {
                    listEl.insertBefore(playerEl, child);
                    inserted = true;
                    break;
                }
            }
            if (!inserted) {
                listEl.appendChild(playerEl);
            }
        }

        // --- Renderizado de Secciones ---
        window.render_team_formation = () => {
            const leftCardBody = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium mb-2 text-secondary">Titulares</h4>
                        <div id="titulares-players" class="player-list-container border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                    </div>
                    <div>
                        <h4 class="font-medium mb-2 text-secondary">Suplentes</h4>
                        <div id="suplentes-players" class="player-list-container border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                    </div>
                </div>`;

            const rightCardBody = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold mb-2">Claros (<span id="claros-count">0</span>)</h4>
                            <div id="team-claros" class="border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-white dark:bg-gray-200"></div>
                        </div>
                         <div>
                            <h4 class="font-semibold mb-2">Oscuros (<span id="oscuros-count">0</span>)</h4>
                            <div id="team-oscuros" class="border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-gray-800"></div>
                        </div>
                    </div>
                    <div class="pt-4">
                        <label for="team-match-date" class="block text-sm font-medium mb-1">Fecha del Partido</label>
                        <input type="date" id="team-match-date" class="w-full p-2 border rounded-md">
                    </div>
                    <button id="save-teams-button" class="w-full px-6 py-3 button-primary font-semibold rounded-lg shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Guardar Partido
                    </button>
                </div>`;

            const content = `
                <div id="team-formation-container" class="flex flex-col lg:grid lg:grid-cols-2 gap-6">
                    ${cardTemplate('JUGADORES', leftCardBody)}
                    ${cardTemplate('EQUIPOS (<span id="total-selected-players">0</span>/10)', rightCardBody)}
                </div>`;

            DOMElements.adminContent.innerHTML = tabContentTemplate('Armar Equipos', content);
            
            const titularesDiv = document.getElementById('titulares-players');
            const suplentesDiv = document.getElementById('suplentes-players');
            
            const activePlayers = AppState.players.filter(p => p.status === 'Activo');
            activePlayers.sort((a, b) => a.name.localeCompare(b.name));

            activePlayers.forEach(player => {
                const playerEl = createPlayerElement(player);
                if (player.role === 'Titular') titularesDiv.appendChild(playerEl);
                else suplentesDiv.appendChild(playerEl);
            });

            setupPlayerInteractions('team-formation-container');
            document.getElementById('team-match-date').addEventListener('click', function() { this.showPicker(); });
            document.getElementById('team-match-date').addEventListener('change', updateTeamCounts);
            document.getElementById('save-teams-button').addEventListener('click', handleSaveTeams);
        };
        const renderMatchSelectionTemplate = (prefix, panelTitle, panelContent) => {
            const selectionCardBody = `
                <div class="flex gap-2 mb-4">
                    <select id="${prefix}-year-select" class="w-full p-2 border rounded-md"></select>
                    <select id="${prefix}-month-select" class="w-full p-2 border rounded-md"></select>
                </div>
                <div id="${prefix}-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-1 py-1">
                   <p class="text-secondary">Cargando partidos...</p>
                </div>`;

            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        ${cardTemplate('PARTIDO', selectionCardBody)}
                    </div>
                    <div class="lg:col-span-2" id="${prefix}-panel-container">
                        ${cardTemplate(panelTitle, panelContent)}
                    </div>
                </div>`;
            return content;
        };
        window.render_match_results = () => {
            const panelContent = `
                <div class="space-y-4">
                     <div>
                        <label class="block text-sm font-medium mb-1">Fecha del Partido</label>
                        <input type="date" id="match-date" class="w-full p-2 border rounded-md" readonly>
                     </div>
                     <div>
                        <label for="match-result" class="block text-sm font-medium mb-1">Resultado</label>
                        <select id="match-result" class="w-full p-2 border rounded-md">
                             <option value="">Seleccionar resultado</option>
                             <option value="Claros">Claros</option>
                             <option value="Oscuros">Oscuros</option>
                             <option value="Empate">Empate</option>
                             <option value="Suspendido">Suspendido</option>
                        </select>
                     </div>
                     <div class="flex gap-4 pt-4">
                        <button id="register-match-button" class="flex-1 px-6 py-3 button-success font-semibold rounded-lg shadow-md hover:opacity-90 transition">
                         Registrar Resultado
                        </button>
                     </div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Resultados de Partidos', renderMatchSelectionTemplate('results', 'RESULTADO', panelContent));
            populateMatchFilters('results');
        };
        window.render_chamigo_management = () => {
            const panelContent = `
                <div id="chamigo-voting-players" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 max-h-[50vh] overflow-y-auto">
                    <p class="text-secondary col-span-full">Selecciona un partido para cargar los jugadores.</p>
                </div>
                <button id="register-chamigo-button" class="w-full mt-4 px-6 py-3 button-warning font-semibold rounded-lg shadow-md hover:opacity-90 transition">
                    Registrar Chamigo(s)
                </button>
                <div class="mt-6 relative">
                    <button id="chamigo-whatsapp-toggle" class="collapsible-toggle-button p-3 rounded-md cursor-pointer flex items-center justify-center font-semibold w-full relative">
                        <span>Encuesta Whatsapp</span>
                        <i class="fas fa-chevron-down toggle-icon absolute right-3 top-1/2 -translate-y-1/2"></i>
                    </button>
                    <div id="chamigo-whatsapp-content" class="hidden card rounded-xl shadow-sm p-6 mt-4 space-y-4 relative">
                        <button id="copy-whatsapp-poll" class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-text-secondary">
                            <i class="fas fa-copy"></i>
                        </button>
                        <div class="whatsapp-poll-display whitespace-pre-wrap text-sm" id="whatsapp-poll-text"></div>
                    </div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Gestión de Chamigo', renderMatchSelectionTemplate('chamigo', 'VOTOS CHAMIGO', panelContent));
            populateMatchFilters('chamigo');
        };
        window.render_tt_attendance = () => {
             const panelContent = `
                <div id="tt-attendance-players" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-4 max-h-[50vh] overflow-y-auto">
                    <p class="text-secondary col-span-full">Selecciona un partido para cargar los jugadores.</p>
                </div>
                <button id="register-tt-button" class="w-full mt-4 px-6 py-3 button-purple font-semibold rounded-lg shadow-md hover:opacity-90 transition">
                    Registrar Asistencia
                </button>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Asistencia a TT', renderMatchSelectionTemplate('tt', 'ASISTENCIA TT', panelContent));
            populateMatchFilters('tt');
        };
        window.render_edit_match = () => {
            const leftCardBody = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium mb-2 text-secondary">Titulares</h4>
                        <div id="edit-titulares-players" class="player-list-container border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                    </div>
                    <div>
                        <h4 class="font-medium mb-2 text-secondary">Suplentes</h4>
                        <div id="edit-suplentes-players" class="player-list-container border border-border-color rounded-lg p-3 flex flex-wrap gap-2 min-h-[120px]"></div>
                    </div>
                </div>`;
            const rightCardBody = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold mb-2">Claros</h4>
                            <div id="edit-team-claros" class="border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-white dark:bg-gray-200"></div>
                        </div>
                         <div>
                            <h4 class="font-semibold mb-2">Oscuros</h4>
                            <div id="edit-team-oscuros" class="border border-border-color rounded-lg p-3 flex flex-wrap content-start gap-2 min-h-[180px] bg-gray-800"></div>
                        </div>
                    </div>
                    <div class="pt-4">
                        <label for="edit-match-date" class="block text-sm font-medium mb-1">Fecha del Partido</label>
                        <input type="date" id="edit-match-date" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="edit-match-result" class="block text-sm font-medium mb-1">Resultado</label>
                        <select id="edit-match-result" class="w-full p-2 border rounded-md">
                             <option value="">Seleccionar resultado</option>
                             <option value="Claros">Claros</option>
                             <option value="Oscuros">Oscuros</option>
                             <option value="Empate">Empate</option>
                             <option value="Suspendido">Suspendido</option>
                        </select>
                     </div>
                    <div class="flex flex-col sm:flex-row gap-4 pt-4">
                        <button id="update-match-button" class="w-full px-6 py-3 button-primary font-semibold rounded-lg shadow-md transition">
                            Actualizar Partido
                        </button>
                        <button id="delete-match-from-edit-button" class="w-full px-6 py-3 button-danger font-semibold rounded-lg shadow-md transition">
                            Eliminar Partido
                        </button>
                    </div>
                </div>`;

            const panelContent = `
                <div id="edit-match-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${cardTemplate('JUGADORES', leftCardBody)}
                    ${cardTemplate('EQUIPOS', rightCardBody)}
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Editar Partido', renderMatchSelectionTemplate('edit', ' ', panelContent));
            document.querySelector('#edit-panel-container > .card > h3').remove();
            populateMatchFilters('edit');
        };
        window.render_players_management = () => {
            const formBody = `
                <form id="player-form" class="space-y-4">
                    <input type="hidden" id="player-id">
                    <div>
                        <label for="player-name" class="block text-sm font-medium mb-1">Nombre</label>
                        <input type="text" id="player-name" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="player-status" class="block text-sm font-medium mb-1">Estado</label>
                        <select id="player-status" class="w-full p-2 border rounded-md">
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                    <div>
                        <label for="player-role" class="block text-sm font-medium mb-1">Rol</label>
                        <select id="player-role" class="w-full p-2 border rounded-md">
                            <option value="Titular">Titular</option>
                            <option value="Suplente">Suplente</option>
                        </select>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="submit" class="flex-1 px-4 py-2 button-success font-semibold rounded-lg shadow-md hover:opacity-90">Guardar</button>
                        <button type="button" id="delete-player-button" class="flex-1 px-4 py-2 button-danger font-semibold rounded-lg shadow-md hover:opacity-90">Eliminar</button>
                    </div>
                </form>`;
            const listBody = `
                <div class="mb-4 relative">
                    <input type="text" id="player-search-input" placeholder="Buscar por nombre..." class="w-full p-2 pl-10 border rounded-md">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="overflow-x-auto max-h-[60vh]">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase bg-muted">
                            <tr>
                                <th class="p-4">ID</th>
                                <th class="p-4">Nombre</th>
                                <th class="p-4">Estado</th>
                                <th class="p-4">Rol</th>
                            </tr>
                        </thead>
                        <tbody id="players-list-admin"></tbody>
                    </table>
                </div>`;

            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">${cardTemplate('JUGADOR', formBody)}</div>
                    <div class="lg:col-span-2">${cardTemplate('JUGADORES', listBody)}</div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Gestión de Jugadores', content);
            
            renderPlayersListAdmin();
            
            document.getElementById('player-search-input').addEventListener('input', (e) => {
                renderPlayersListAdmin(e.target.value);
            });
            document.getElementById('player-form').addEventListener('submit', handleSavePlayer);
            document.getElementById('delete-player-button').addEventListener('click', handleDeletePlayer);
        };
        window.render_user_management = () => {
             const formBody = `
                <form id="user-form" class="space-y-4">
                    <input type="hidden" id="user-id">
                    <div>
                        <label for="user-email" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="user-email" class="w-full p-2 border rounded-md" readonly>
                    </div>
                    <div>
                        <label for="user-name" class="block text-sm font-medium mb-1">Nombre</label>
                        <input type="text" id="user-name" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="user-role" class="block text-sm font-medium mb-1">Rol</label>
                        <select id="user-role" class="w-full p-2 border rounded-md">
                            <option value="Operador">Operador</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="submit" class="flex-1 px-4 py-2 button-success font-semibold rounded-lg shadow-md hover:opacity-90">Guardar</button>
                        <button type="button" id="clear-user-form-button" class="flex-1 px-4 py-2 button-secondary font-semibold rounded-lg shadow-md hover:opacity-90">Limpiar</button>
                    </div>
                </form>`;
            const listBody = `
                <div class="mb-4 relative">
                    <input type="text" id="user-search-input" placeholder="Buscar por nombre o email..." class="w-full p-2 pl-10 border rounded-md">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="overflow-x-auto max-h-[60vh]">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase bg-muted">
                            <tr>
                                <th class="p-4">Email</th>
                                <th class="p-4">Nombre</th>
                                <th class="p-4">Rol</th>
                            </tr>
                        </thead>
                        <tbody id="users-list-admin"></tbody>
                    </table>
                </div>`;
            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">${cardTemplate('USUARIO', formBody)}</div>
                    <div class="lg:col-span-2">${cardTemplate('USUARIOS', listBody)}</div>
                </div>`;
            DOMElements.adminContent.innerHTML = tabContentTemplate('Gestión de Usuarios', content);
            
            renderUsersListAdmin();

            document.getElementById('user-search-input').addEventListener('input', (e) => {
                renderUsersListAdmin(e.target.value);
            });
            document.getElementById('user-form').addEventListener('submit', handleSaveUser);
            document.getElementById('clear-user-form-button').addEventListener('click', clearUserForm);
        };
        function createPlayerElement(player) {
            const el = document.createElement('div');
            el.className = 'player-element flex-grow-0 text-sm font-medium px-3 py-1.5 rounded-full shadow-sm';
            el.dataset.id = player.id;
            el.textContent = player.name;
            return el;
        }
        function setupPlayerInteractions(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const returnPlayerToOrigin = (playerEl) => {
                if (!playerEl) return;
                const playerId = playerEl.dataset.id;
                const player = AppState.players.find(p => p.id == playerId);
                const isEditMode = containerId.includes('edit');

                const suplentesList = document.getElementById(isEditMode ? 'edit-suplentes-players' : 'suplentes-players');
                const titularesList = document.getElementById(isEditMode ? 'edit-titulares-players' : 'titulares-players');
                
                if (player && player.role === 'Suplente') {
                    insertPlayerAlphabetically(playerEl, suplentesList);
                } else if (player) {
                    insertPlayerAlphabetically(playerEl, titularesList);
                }
                if (!isEditMode) updateTeamCounts();
            };

            const onClick = (e) => {
                const playerEl = e.target.closest('.player-element');
                if (!playerEl) return;

                const parentId = playerEl.parentElement.id;
                
                if (parentId.includes('titulares-players') || parentId.includes('suplentes-players')) {
                    showPlayerAssignmentModal(playerEl);
                } 
                else if (parentId.includes('team-claros') || parentId.includes('team-oscuros')) {
                    returnPlayerToOrigin(playerEl);
                }
            };

            container.addEventListener('click', onClick);
        }
        function showPlayerAssignmentModal(playerEl) {
            AppState.activePlayerElement = playerEl;
            DOMElements.assignModalPlayerName.textContent = playerEl.textContent;
            DOMElements.playerAssignmentModal.classList.remove('hidden');
            DOMElements.body.classList.add('modal-open');
        }
        function hidePlayerAssignmentModal() {
            AppState.activePlayerElement = null;
            DOMElements.playerAssignmentModal.classList.add('hidden');
            DOMElements.body.classList.remove('modal-open');
        }
        function movePlayerToTeam(teamId) {
            if (!AppState.activePlayerElement) return;
            
            const isEditMode = !!AppState.activePlayerElement.closest('#edit-match-container');
            const finalTeamId = isEditMode ? `edit-${teamId}` : teamId;
            
            const teamContainer = document.getElementById(finalTeamId);
            if (teamContainer.children.length >= 5) {
                showNotification(`El equipo ${teamId.includes('claros') ? 'Claros' : 'Oscuros'} ya está lleno.`, 'warning');
                return;
            }
            
            teamContainer.appendChild(AppState.activePlayerElement);
            hidePlayerAssignmentModal();
            if (!isEditMode) updateTeamCounts();
        }
        function updateTeamCounts() {
            const clarosCount = document.getElementById('team-claros').children.length;
            const oscurosCount = document.getElementById('team-oscuros').children.length;
            const matchDate = document.getElementById('team-match-date').value;

            document.getElementById('claros-count').textContent = clarosCount;
            document.getElementById('oscuros-count').textContent = oscurosCount;
            document.querySelector('#total-selected-players').textContent = clarosCount + oscurosCount;
            
            document.getElementById('save-teams-button').disabled = !(clarosCount === 5 && oscurosCount === 5 && matchDate);
        }
        
        async function handleSaveTeams() {
            const matchDate = document.getElementById('team-match-date').value;
            if (!matchDate) { 
                showNotification('Por favor, selecciona la fecha del partido.', 'warning');
                return;
            }

            const teamWhitePlayers = Array.from(document.getElementById('team-claros').children).map(el => el.dataset.id);
            const teamDarkPlayers = Array.from(document.getElementById('team-oscuros').children).map(el => el.dataset.id);

            const { error } = await supabase.rpc('create_new_match', {
                match_date_param: matchDate,
                team_white_players_param: teamWhitePlayers,
                team_dark_players_param: teamDarkPlayers
            });

            if (error) {
                showNotification(`Error al crear el partido: ${error.message}`, 'error');
                console.error('Error RPC:', error);
            } else {
                showNotification('Partido creado exitosamente!', 'success');
                await navigateTo('team-formation');
            }
        }

        function populateMatchFilters(prefix) {
            const yearSelect = document.getElementById(`${prefix}-year-select`);
            const monthSelect = document.getElementById(`${prefix}-month-select`);
            
            const years = [...new Set(AppState.matches.map(m => new Date(m.match_date).getUTCFullYear()))].sort((a,b) => b-a);
            yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
            
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            monthSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            
            const mostRecentMatchDate = AppState.matches.length > 0 ? new Date(AppState.matches[0].match_date) : new Date();
            
            if (years.includes(mostRecentMatchDate.getUTCFullYear())) yearSelect.value = mostRecentMatchDate.getUTCFullYear();
            monthSelect.value = mostRecentMatchDate.getUTCMonth();

            const renderList = () => {
                const listContainer = document.getElementById(`${prefix}-list`);
                const selectedYear = yearSelect.value;
                const selectedMonth = monthSelect.value;
                const filteredMatches = AppState.matches.filter(m => {
                    const d = new Date(m.match_date);
                    return d.getUTCFullYear() == selectedYear && d.getUTCMonth() == selectedMonth;
                });
                
                if (filteredMatches.length === 0) {
                    listContainer.innerHTML = '<p class="text-secondary p-2">No hay partidos para este mes.</p>';
                    document.getElementById(`${prefix}-panel-container`).classList.add('hidden');
                    return;
                }
                
                document.getElementById(`${prefix}-panel-container`).classList.remove('hidden');

                filteredMatches.sort((a, b) => new Date(b.match_date) - new Date(a.match_date));
                
                listContainer.innerHTML = filteredMatches.map(match => {
                    const d = new Date(match.match_date);
                    const formattedDate = d.toLocaleDateString('es-AR', {day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC'});
                    return `
                        <div class="match-item border-l-4 p-3 rounded-r-lg cursor-pointer transition" data-match-id="${match.id}">
                            <p class="font-semibold">${formattedDate}</p>
                            <p class="text-xs text-secondary">Resultado: ${match.result || 'Pendiente'}</p>
                        </div>`;
                }).join('');

                listContainer.querySelectorAll('.match-item').forEach(item => {
                    const match = AppState.matches.find(m => m.id == item.dataset.matchId);
                    let hasCompletion = false;

                    if (prefix === 'results') {
                        hasCompletion = !!match.result;
                    } else if (prefix === 'chamigo') {
                        hasCompletion = (match.chamigo_votes && Object.keys(match.chamigo_votes).length > 0);
                    } else if (prefix === 'tt') {
                        hasCompletion = (match.tt_attendees && match.tt_attendees.length > 0);
                    } else {
                        hasCompletion = !!match.result;
                    }

                    item.classList.toggle('has-result', hasCompletion);
                    item.classList.toggle('no-result', !hasCompletion);
                    
                    item.addEventListener('click', (e) => {
                        listContainer.querySelectorAll('.match-item').forEach(i => i.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        handleMatchSelection(e.currentTarget.dataset.matchId, prefix);
                    });
                });

                const firstMatchItem = listContainer.querySelector('.match-item');
                if (firstMatchItem) {
                    firstMatchItem.click(); 
                }
            };
            
            yearSelect.addEventListener('change', renderList);
            monthSelect.addEventListener('change', renderList);
            renderList();
        }
        function handleMatchSelection(matchId, prefix) {
            AppState.selectedMatchId = matchId;
            const match = AppState.matches.find(m => m.id == matchId);
            if (!match) return;
            
            const panelContainer = document.getElementById(`${prefix}-panel-container`);
            panelContainer.classList.remove('hidden');

            const handlerMap = {
                'results': setupResultsPanel,
                'chamigo': setupChamigoPanel,
                'tt': setupTtPanel,
                'edit': setupEditMatchPanel,
            };

            if(handlerMap[prefix]) handlerMap[prefix](panelContainer, match);
        }
        function setupResultsPanel(panel, match) {
            panel.querySelector('#match-date').value = match.match_date;
            panel.querySelector('#match-result').value = match.result || '';
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#register-match-button').addEventListener('click', handleRegisterResult);
                panel.dataset.listenersAdded = 'true';
            }
        }
        function setupChamigoPanel(panel, match) {
            renderChamigoVotingPlayers(match);
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#register-chamigo-button').addEventListener('click', handleRegisterChamigo);
                panel.dataset.listenersAdded = 'true';
            }

            const whatsappPollTextDiv = document.getElementById('whatsapp-poll-text');
            const copyWhatsappPollBtn = document.getElementById('copy-whatsapp-poll');
            const toggleButton = document.getElementById('chamigo-whatsapp-toggle');
            const collapsibleContent = document.getElementById('chamigo-whatsapp-content');

            if (whatsappPollTextDiv && copyWhatsappPollBtn && toggleButton && collapsibleContent) {
                const getPlayerName = id => (AppState.players.find(p => p.id == id) || { name: 'Jugador Desconocido' }).name;

                const clarosPlayersNames = (match.team_white_players || []).map(getPlayerName).join(', ');
                const oscurosPlayersNames = (match.team_dark_players || []).map(getPlayerName).join(', ');

                let pollText = '';
                if (oscurosPlayersNames) {
                    pollText += '*Oscuros*\n' + oscurosPlayersNames + '\n\n';
                }
                if (clarosPlayersNames) {
                    pollText += '*Claros*\n' + clarosPlayersNames;
                }

                whatsappPollTextDiv.textContent = pollText;

                copyWhatsappPollBtn.onclick = () => {
                    const textToCopy = whatsappPollTextDiv.textContent;
                    const el = document.createElement('textarea');
                    el.value = textToCopy;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    showNotification('Texto copiado al portapapeles!', 'success');
                };

                if (!toggleButton.dataset.listenerAdded) {
                    toggleButton.addEventListener('click', () => {
                        collapsibleContent.classList.toggle('hidden');
                        toggleButton.classList.toggle('visible-content');
                        toggleButton.querySelector('.toggle-icon')?.classList.toggle('fa-chevron-up');
                        toggleButton.querySelector('.toggle-icon')?.classList.toggle('fa-chevron-down');
                    });
                    toggleButton.dataset.listenerAdded = 'true';
                }
                collapsibleContent.classList.add('hidden');
                toggleButton.classList.remove('visible-content');
                toggleButton.querySelector('.toggle-icon')?.classList.remove('fa-chevron-up');
                toggleButton.querySelector('.toggle-icon')?.classList.add('fa-chevron-down');
            }
        }
        function setupTtPanel(panel, match) {
            renderTtAttendancePlayers(match);
            if (!panel.dataset.listenersAdded) {
                panel.querySelector('#register-tt-button').addEventListener('click', handleRegisterTt);
                panel.dataset.listenersAdded = 'true';
            }
        }
        function setupEditMatchPanel(panel, match) {
            renderEditMatchPlayers(match);
            
            // CHANGE: Populate the new result dropdown
            panel.querySelector('#edit-match-result').value = match.result || '';
            
            const updateBtn = panel.querySelector('#update-match-button');
            const deleteBtn = panel.querySelector('#delete-match-from-edit-button');

            const newUpdateBtn = updateBtn.cloneNode(true);
            updateBtn.parentNode.replaceChild(newUpdateBtn, updateBtn);
            newUpdateBtn.addEventListener('click', handleUpdateMatch);

            const newDeleteBtn = deleteBtn.cloneNode(true);
            deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
            newDeleteBtn.addEventListener('click', handleDeleteMatchFromEdit);

            panel.querySelector('#edit-match-date').addEventListener('click', function() {
                this.showPicker();
            });
        }
        async function handleRegisterResult() {
            let resultValue = document.getElementById('match-result').value;
            if (resultValue === "") {
                resultValue = null;
            }
            const { error } = await supabase.rpc('update_match_result', {
                match_id_param: AppState.selectedMatchId,
                new_result: resultValue
            });
            if(error) { showNotification('Error al registrar resultado', 'error'); console.error(error); } 
            else {
                 showNotification('Resultado registrado!', 'success');
            }
        }
        async function handleDeleteMatchFromEdit() {
            const confirmed = await showModal('Confirmar Eliminación', '¿Seguro que quieres eliminar este partido? Esta acción no se puede deshacer.');
            if (confirmed) {
                const { error } = await supabase.rpc('delete_match_by_id', {
                    match_id_param: AppState.selectedMatchId
                });
                if(error) { showNotification('Error al eliminar partido', 'error'); console.error(error); } 
                else {
                    showNotification('Partido eliminado.', 'success');
                    document.getElementById('edit-panel-container').classList.add('hidden');
                }
            }
        }
        function renderChamigoVotingPlayers(match) {
            const container = document.getElementById('chamigo-voting-players');
            container.innerHTML = '';
            const playerIDs = [...new Set([...(match.team_white_players||[]), ...(match.team_dark_players||[])])];
            const currentVotes = match.chamigo_votes || {};

            playerIDs.forEach(id => {
                const player = AppState.players.find(p => p.id == id);
                if (!player) return;
                
                const voteCount = currentVotes[id] || 0;
                const playerDiv = document.createElement('div');
                playerDiv.className = 'chamigo-player-item flex items-center justify-between p-2 border border-border-color rounded-lg';
                playerDiv.dataset.id = id;
                playerDiv.innerHTML = `
                    <span class="player-name">${player.name}</span>
                    <div class="chamigo-vote-controls flex items-center gap-2">
                        <button class="chamigo-vote-btn subtract-vote w-8 h-8 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition-colors flex items-center justify-center text-lg font-bold">-</button>
                        <span class="chamigo-vote-counter font-bold w-8 text-center text-lg">${voteCount}</span>
                        <button class="chamigo-vote-btn add-vote w-8 h-8 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition-colors flex items-center justify-center text-lg font-bold">+</button>
                    </div>`;
                
                playerDiv.querySelector('.add-vote').addEventListener('click', () => {
                    const counter = playerDiv.querySelector('.chamigo-vote-counter');
                    counter.textContent = parseInt(counter.textContent) + 1;
                });
                playerDiv.querySelector('.subtract-vote').addEventListener('click', () => {
                    const counter = playerDiv.querySelector('.chamigo-vote-counter');
                    counter.textContent = Math.max(0, parseInt(counter.textContent) - 1);
                });
                container.appendChild(playerDiv);
            });
        }
        
        async function handleRegisterChamigo() {
            const votes = {};
            document.querySelectorAll('.chamigo-player-item').forEach(item => {
                const count = parseInt(item.querySelector('.chamigo-vote-counter').textContent);
                if (count > 0) votes[item.dataset.id] = count;
            });
            
            const chamigoData = Object.keys(votes).length === 0 ? null : votes;

            const { error } = await supabase.rpc('update_chamigo_votes', {
                match_id_param: AppState.selectedMatchId,
                chamigo_votes_param: chamigoData
            });

            if (error) { 
                showNotification('Error al guardar votos de Chamigo', 'error'); 
                console.error('Error RPC (Chamigo):', error);
            } 
            else {
                showNotification('Votos de Chamigo guardados!', 'success');
            }
        }

        function renderTtAttendancePlayers(match) {
            const container = document.getElementById('tt-attendance-players');
            container.innerHTML = '';
            const activePlayers = AppState.players.filter(p => p.status === 'Activo');
            const existingAttendees = match.tt_attendees || [];

            activePlayers.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'tt-player-item p-2 border border-border-color rounded-lg cursor-pointer text-center flex items-center justify-center gap-2';
                if (existingAttendees.includes(player.id)) {
                    playerDiv.classList.add('selected');
                }
                playerDiv.dataset.id = player.id;
                playerDiv.innerHTML = `<i class="fas fa-check-circle hidden"></i><span>${player.name}</span>`;
                
                const icon = playerDiv.querySelector('i');
                icon.style.display = playerDiv.classList.contains('selected') ? 'inline' : 'none';

                playerDiv.addEventListener('click', () => {
                    playerDiv.classList.toggle('selected');
                    icon.style.display = playerDiv.classList.contains('selected') ? 'inline' : 'none';
                });
                container.appendChild(playerDiv);
            });
        }
        
        async function handleRegisterTt() {
            const attendees = Array.from(document.querySelectorAll('#tt-attendance-players .selected')).map(el => el.dataset.id);

            const { error } = await supabase.rpc('update_tt_attendance', {
                match_id_param: AppState.selectedMatchId,
                tt_attendees_param: attendees
            });

            if (error) { 
                showNotification('Error al guardar asistencia a TT', 'error');
                console.error('Error RPC (TT):', error);
            } 
            else {
                showNotification('Asistencia a TT guardada!', 'success');
            }
        }

        function renderPlayersListAdmin(searchTerm = '') {
            const tableBody = document.getElementById('players-list-admin');
            const normalizedSearch = searchTerm.toLowerCase();
            const filteredPlayers = AppState.players.filter(p => 
                p.name.toLowerCase().includes(normalizedSearch)
            );

            tableBody.innerHTML = filteredPlayers.map(p => `
                <tr class="selectable-row border-b border-border-color cursor-pointer" data-player-id="${p.id}">
                    <td class="p-4">${p.id}</td><td class="p-4">${p.name}</td>
                    <td class="p-4">${p.status}</td><td class="p-4">${p.role}</td>
                </tr>`).join('');
            
            tableBody.querySelectorAll('.selectable-row').forEach(row => {
                row.addEventListener('click', () => {
                    tableBody.querySelectorAll('.selectable-row').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    populatePlayerForm(AppState.players.find(p => p.id == row.dataset.playerId));
                });
            });
        }
        function populatePlayerForm(player) {
            document.getElementById('player-id').value = player.id;
            document.getElementById('player-name').value = player.name;
            document.getElementById('player-status').value = player.status;
            document.getElementById('player-role').value = player.role;
        }
        function clearPlayerForm() {
            document.getElementById('player-form').reset();
            document.getElementById('player-id').value = '';
            document.querySelectorAll('#players-list-admin .selectable-row').forEach(r => r.classList.remove('selected'));
        }
        async function handleSavePlayer(e) {
            e.preventDefault();
            const id = document.getElementById('player-id').value;
            const playerData = {
                name: document.getElementById('player-name').value,
                status: document.getElementById('player-status').value,
                role: document.getElementById('player-role').value,
            };

            const { data, error } = id
                ? await supabase.from('players').update(playerData).eq('id', id)
                : await supabase.from('players').insert(playerData);

            if (error) {
                showNotification(`Error al guardar jugador: ${error.message}`, 'error');
            } else {
                showNotification('Jugador guardado exitosamente.', 'success');
                // La UI se actualizará vía Realtime
                clearPlayerForm();
            }
        }
        async function handleDeletePlayer() {
            const id = document.getElementById('player-id').value;
            if (!id) {
                showNotification('Por favor, selecciona un jugador de la lista para eliminarlo.', 'warning');
                return;
            }

            const player = AppState.players.find(p => p.id == id);
            const confirmed = await showModal(
                'Confirmar Eliminación', 
                `¿Estás seguro de que quieres eliminar a ${player ? player.name : 'este jugador'}? Esta acción no se puede deshacer.`
            );

            if (confirmed) {
                const { error } = await supabase.from('players').delete().eq('id', id);

                if (error) {
                    showNotification(`Error al eliminar jugador: ${error.message}`, 'error');
                } else {
                    showNotification('Jugador eliminado exitosamente.', 'success');
                     // La UI se actualizará vía Realtime
                    clearPlayerForm();
                }
            }
        }
        function renderUsersListAdmin(searchTerm = '') {
            const tableBody = document.getElementById('users-list-admin');
            const normalizedSearch = searchTerm.toLowerCase();
            const filteredUsers = AppState.users.filter(u =>
                (u.name && u.name.toLowerCase().includes(normalizedSearch)) ||
                u.email.toLowerCase().includes(normalizedSearch)
            );

            tableBody.innerHTML = filteredUsers.map(u => `
                <tr class="selectable-row border-b border-border-color cursor-pointer" data-user-id="${u.id}">
                    <td class="p-4">${u.email}</td>
                    <td class="p-4">${u.name || 'N/A'}</td>
                    <td class="p-4">${u.role || 'Sin Rol'}</td>
                </tr>`).join('');
            
            tableBody.querySelectorAll('.selectable-row').forEach(row => {
                row.addEventListener('click', () => {
                    tableBody.querySelectorAll('.selectable-row').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    populateUserForm(AppState.users.find(u => u.id === row.dataset.userId));
                });
            });
        }
        function populateUserForm(user) {
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-email').value = user.email;
            document.getElementById('user-name').value = user.name || '';
            document.getElementById('user-role').value = user.role || 'Operador';
        }
        function clearUserForm() {
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.querySelectorAll('#users-list-admin .selectable-row').forEach(r => r.classList.remove('selected'));
        }
        async function handleSaveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            if (!id) { showNotification('Selecciona un usuario de la lista.', 'warning'); return; }
            const userData = {
                name: document.getElementById('user-name').value,
                role: document.getElementById('user-role').value,
            };
            const { error } = await supabase.from('profiles').update(userData).eq('id', id);
            if (error) { showNotification(`Error al guardar usuario: ${error.message}`, 'error'); }
            else {
                showNotification('Usuario guardado.', 'success');
                // El Realtime handler se encargará de actualizar la UI para todos los clientes
                clearUserForm();
            }
        }
        function renderEditMatchPlayers(match) {
            document.getElementById('edit-match-date').value = match.match_date;
            const titularesDiv = document.getElementById('edit-titulares-players');
            const suplentesDiv = document.getElementById('edit-suplentes-players');
            const teamClarosDiv = document.getElementById('edit-team-claros');
            const teamOscurosDiv = document.getElementById('edit-team-oscuros');
            
            [titularesDiv, suplentesDiv, teamClarosDiv, teamOscurosDiv].forEach(div => div.innerHTML = '');

            const matchPlayerIds = new Set([
                ...(match.team_white_players || []).map(String), 
                ...(match.team_dark_players || []).map(String)
            ]);

            AppState.players.filter(p => p.status === 'Activo' && !matchPlayerIds.has(String(p.id)))
                .forEach(p => {
                    const playerEl = createPlayerElement(p);
                    if (p.role === 'Suplente') {
                        suplentesDiv.appendChild(playerEl);
                    } else {
                        titularesDiv.appendChild(playerEl);
                    }
                });

            (match.team_white_players || []).forEach(id => {
                const player = AppState.players.find(p => p.id == id);
                if (player) teamClarosDiv.appendChild(createPlayerElement(player));
            });
            (match.team_dark_players || []).forEach(id => {
                const player = AppState.players.find(p => p.id == id);
                if (player) teamOscurosDiv.appendChild(createPlayerElement(player));
            });
            
            setupPlayerInteractions('edit-match-container');
        }
        async function handleUpdateMatch() {
            const newDate = document.getElementById('edit-match-date').value;
            const newTeamWhite = Array.from(document.getElementById('edit-team-claros').children).map(el => el.dataset.id);
            const newTeamDark = Array.from(document.getElementById('edit-team-oscuros').children).map(el => el.dataset.id);
            let newResult = document.getElementById('edit-match-result').value;
            if (newResult === "") {
                newResult = null;
            }
            
            if (newTeamWhite.length + newTeamDark.length !== 10) {
                showNotification('Deben haber 10 jugadores en total para conformar los equipos.', 'warning');
                return;
            }

            // CHANGE: Run both updates concurrently
            const [teamsResult, resultResult] = await Promise.all([
                supabase.rpc('update_match_teams', {
                    match_id_param: AppState.selectedMatchId,
                    new_date_param: newDate,
                    new_team_white_param: newTeamWhite,
                    new_team_dark_param: newTeamDark
                }),
                supabase.rpc('update_match_result', {
                    match_id_param: AppState.selectedMatchId,
                    new_result: newResult
                })
            ]);

            const error = teamsResult.error || resultResult.error;
            
            if (error) { 
                showNotification(`Error al actualizar el partido: ${error.message}`, 'error');
                console.error('Error RPC (Update Match):', error);
            }
            else {
                showNotification('Partido actualizado.', 'success');
            }
        }
        
        function showNotification(message, type = 'success') {
            const { notificationModal, notificationContent, notificationIcon, notificationMessage } = DOMElements;
            
            notificationMessage.textContent = message;
            notificationContent.classList.remove('bg-success-color', 'bg-danger-color', 'bg-warning-color');
            notificationIcon.classList.remove('fa-check-circle', 'fa-exclamation-triangle', 'fa-times-circle');

            if (type === 'success') {
                notificationContent.classList.add('bg-success-color');
                notificationIcon.classList.add('fa-check-circle');
            } else {
                notificationContent.classList.add('bg-danger-color');
                notificationIcon.classList.add('fa-times-circle');
            }

            notificationModal.classList.remove('hidden');

            const timeoutId = setTimeout(() => {
                notificationModal.classList.add('hidden');
            }, 3000);

            const dismissNotification = (e) => {
                if (!notificationContent.contains(e.target)) {
                    notificationModal.classList.add('hidden');
                    clearTimeout(timeoutId);
                    notificationModal.removeEventListener('click', dismissNotification);
                }
            };
            notificationModal.addEventListener('click', dismissNotification);
        }
        function showModal(title, message) {
            return new Promise(resolve => {
                DOMElements.modalTitle.textContent = title;
                DOMElements.modalMessage.textContent = message;
                DOMElements.modal.classList.remove('hidden');
                DOMElements.body.classList.add('modal-open');
                const confirmHandler = () => { cleanup(); resolve(true); };
                const cancelHandler = () => { cleanup(); resolve(false); };

                const dismissOnOverlayClick = (e) => {
                    if (e.target === DOMElements.modal) {
                        cleanup();
                        resolve(false);
                    }
                };
                
                const cleanup = () => {
                    DOMElements.modal.classList.add('hidden');
                    DOMElements.body.classList.remove('modal-open');
                    DOMElements.modalConfirm.removeEventListener('click', confirmHandler);
                    DOMElements.modalCancel.removeEventListener('click', cancelHandler);
                };
                DOMElements.modalConfirm.addEventListener('click', confirmHandler);
                DOMElements.modalCancel.addEventListener('click', cancelHandler);
            });
        }

        init();
    });
    </script>
</body>
</html>
