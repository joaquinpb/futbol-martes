
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración Fútbol 5</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Carga de Font Awesome para los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Carga de la fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Asegura que html y body ocupen toda la altura para que los porcentajes funcionen */
        html, body {
            height: 100%;
        }

        /* Fuente Inter para una mejor legibilidad */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- ESTILOS BASE (MODO CLARO) --- */
        body {
            background-color: #f0f2f5; /* Un gris claro para el fondo */
        }

        .main-admin-content-container {
            background-color: #ffffff;
            color: #1f2937; /* gray-800 */
        }

        h1, h2, h3, h4, h5, h6 {
            color: #374151; /* gray-700 */
        }

        label, .text-gray-700 {
            color: #374151; /* gray-700 */
        }

        .text-gray-500 {
            color: #6b7280; /* gray-500 */
        }

        input, select {
            background-color: #ffffff;
            border-color: #d1d5db; /* gray-300 */
            color: #1f2937; /* gray-800 */
        }

        input::placeholder {
            color: #9ca3af; /* gray-400 */
        }

        .tab-content, .p-4.border {
            border-color: #e5e7eb; /* gray-200 */
        }

        .match-item {
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
        }

        .match-item.no-result {
            background-color: #fee2e2; /* bg-red-100 pastel */
        }
        .match-item.has-result {
            background-color: #dcfce7; /* bg-green-100 pastel */
        }
        .match-item:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .match-item.selected {
            background-color: #e0e7ff; /* indigo-100 */
            border-color: #6366f1; /* indigo-500 */
        }

        #players-list-admin table {
             background-color: #ffffff;
        }
        #players-list-admin thead tr {
            background-color: #f3f4f6; /* gray-100 */
            color: #374151; /* gray-700 */
        }
        #players-list-admin tbody tr {
            border-color: #e5e7eb; /* gray-200 */
        }
        #players-list-admin tbody tr:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        #players-list-admin tbody td {
            color: #4b5563; /* gray-600 */
        }

        #custom-confirm-modal .bg-white {
            background-color: #ffffff;
        }


        /* --- ESTILOS MODO OSCURO --- */
        html.dark body {
            background-color: #111827; /* gray-900 */
        }

        html.dark .main-admin-content-container {
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
        }

        html.dark h1, html.dark h2, html.dark h3, html.dark h4, html.dark h5, html.dark h6 {
            color: #f9fafb; /* gray-50 */
        }
        
        html.dark .text-indigo-800 {
            color: #a5b4fc; /* indigo-300 */
        }
        
        html.dark .border-indigo-500 {
            border-color: #818cf8; /* indigo-400 */
        }

        html.dark label, html.dark .text-gray-700 {
            color: #d1d5db; /* gray-300 */
        }

        html.dark .text-gray-500 {
            color: #9ca3af; /* gray-400 */
        }
        
        html.dark .text-gray-800 {
             color: #f9fafb; /* gray-50 */
        }

        html.dark input, html.dark select {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
            color: #f9fafb; /* gray-50 */
        }

        html.dark input::placeholder {
            color: #9ca3af; /* gray-400 */
        }

        html.dark .tab-content, html.dark .p-4.border {
            border-color: #4b5563; /* gray-600 */
        }

        html.dark .match-item.no-result {
            background-color: #5c2b2b; /* Darker red */
        }
        html.dark .match-item.has-result {
            background-color: #2a553a; /* Darker green */
        }
        html.dark .match-item:hover {
            background-color: #374151; /* gray-700 */
        }
        html.dark .match-item.selected {
            background-color: #3730a3; /* indigo-800 */
            border-color: #a5b4fc; /* indigo-300 */
        }
        html.dark .match-item p {
            color: #e5e7eb; /* gray-200 */
        }
         html.dark .match-item .text-gray-500 {
            color: #9ca3af; /* gray-400 */
        }


        html.dark #players-list-admin table {
             background-color: #1f2937; /* gray-800 */
        }
        html.dark #players-list-admin thead tr {
            background-color: #374151; /* gray-700 */
            color: #e5e7eb; /* gray-200 */
        }
        html.dark #players-list-admin tbody tr {
            border-color: #4b5563; /* gray-600 */
        }
        html.dark #players-list-admin tbody tr:hover {
            background-color: #374151; /* gray-700 */
        }
        html.dark #players-list-admin tbody td {
            color: #d1d5db; /* gray-300 */
        }
        
        html.dark #titulares-players, html.dark #suplentes-players {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
        }
        
        html.dark #chamigo-match-list, html.dark #tt-match-list, html.dark #results-match-list {
            background-color: #1f2937; /* gray-800 */
            border-color: #4b5563; /* gray-600 */
        }
        
        html.dark #custom-confirm-modal .bg-white {
            background-color: #1f2937; /* gray-800 */
        }

        /* Estilos que NO cambian con el modo oscuro */
        .player-draggable {
            background-color: #ffffff;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 0.25rem;
            cursor: grab;
            display: inline-block !important;
            width: auto !important;
            height: auto !important;
            flex: none !important;
            white-space: nowrap !important;
            color: #000000 !important; /* Texto siempre negro para contraste */
        }

        .player-draggable:active {
            cursor: grabbing;
        }
        
        #team-oscuros .player-draggable {
            background-color: #000000 !important;
            color: #ffffff !important;
        }

        /* El fondo de los contenedores de equipos permanece igual */
        #team-claros {
            background-color: #ffffff !important;
        }

        #team-oscuros {
            background-color: #1a202c !important; /* bg-gray-900 */
        }
        
        /* --- Resto de los estilos --- */

        .player-draggable.dragging-touch {
            opacity: 0.7;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #side-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%; /* CORRECCIÓN CLAVE: Usar 100% en lugar de 100vh */
            width: 256px;
            background-color: #312e81; /* indigo-800 */
            color: white;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 40;
            display: flex;
            flex-direction: column;
        }

        #side-menu.open {
            transform: translateX(0);
        }

        #side-menu.hidden {
            display: none !important;
        }

        #overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            display: none;
        }

        #overlay.open {
            display: block;
        }

        #hamburger-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 50;
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        #side-menu .tab-button, #side-menu .sidebar-link {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            text-align: left;
            width: 100%;
            border-radius: 0;
            margin-bottom: 0.25rem;
            color: white;
            transition: background-color 0.15s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            white-space: nowrap;
             padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        #side-menu .tab-button.active {
            background-color: #4338ca; /* indigo-700 */
        }
        #side-menu .tab-button:hover, #side-menu .sidebar-link:hover {
            background-color: #4f46e5; /* indigo-600 */
        }
        
        .menu-title-container {
            padding: 0.5rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            flex-shrink: 0; 
        }

        .menu-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #dark-mode-toggle {
            background-color: #4338ca; /* indigo-700 */
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.15s ease-in-out;
        }

        #dark-mode-toggle:hover {
            background-color: #4f46e5; /* indigo-600 */
        }

        #sidebar-button-container {
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 1rem; 
        }
        
        .sidebar-footer {
            flex-shrink: 0;
            padding: 1rem;
        }

        .sidebar-footer #signout_button {
            width: 100%;
        }


        @media (min-width: 768px) {
            body {
                flex-direction: row;
                align-items: flex-start;
            }
            #side-menu {
                position: relative;
                transform: translateX(0);
                flex-shrink: 0;
                height: 100vh; /* En desktop, 100vh es seguro */
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            #overlay, #hamburger-button {
                display: none !important;
            }
            .main-admin-content-container {
                flex-grow: 1;
                margin: 2rem;
                padding: 2rem;
                width: auto;
            }
        }
    </style>
</head>
<body class="flex flex-col md:flex-row">
    <!-- Hamburger Button (visible on mobile) -->
    <button id="hamburger-button" class="fixed top-4 left-4 z-50 p-2 rounded-md bg-indigo-600 text-white shadow-lg hidden">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <!-- Side Navigation Menu -->
    <nav id="side-menu" class="hidden">
        <div class="menu-title-container">
            <h2 class="menu-title">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
                MENÚ
            </h2>
            <button id="dark-mode-toggle">
                <i class="fas fa-moon" id="dark-mode-icon"></i>
            </button>
        </div>
        
        <div id="sidebar-button-container">
            <!-- Botones de las pestañas -->
            <button class="tab-button" data-tab="team-formation">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-4.5-7.5l-2.25 2.25m0 0l-2.25 2.25M18 15l-2.25 2.25m0 0l-2.25 2.25M15.75 12a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" /></svg>
                Armar Equipos
            </button>
            <button class="tab-button" data-tab="match-results">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25H2.25A2.25 2.25 0 0 1 0 19.5V12A2.25 2.25 0 0 1 2.25 9.75h19.5A2.25 2.25 0 0 1 24 12v7.5a2.25 2.25 0 0 1-2.25 2.25H16.5" /></svg>
                Resultados
            </button>
            <button class="tab-button" data-tab="chamigo-management">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .472.334l5.64.423a.563.563 0 0 1 .314.976l-4.067 3.323a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.563.563 0 0 0-.582 0l-4.725 2.885a.562.562 0 0 1-.84-.61l1.285-5.385a.563.563 0 0 0-.182-.557L3.92 9.345a.563.563 0 0 1 .313-.976l5.64-.423a.563.563 0 0 0 .472-.334L11.48 3.5Z" /></svg>
                Chamigo
            </button>
            <button class="tab-button" data-tab="tt-attendance">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-beer"><path d="M18 19V2h-1M6 19V2h1M2 19h20v3H2zM12 19V2a4 4 0 0 0-4 4v13" /></svg>
                TT
            </button>
            <button class="tab-button" data-tab="players-management">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                ABM Jugadores
            </button>
            <a href="index.html" target="_blank" rel="noopener noreferrer" class="sidebar-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-line-chart"><path d="M3 3v18h18" /><path d="m18 21-8-8-4 4-3-3" /><path d="m18 14 4-4H18V6" /></svg>
                Estadísticas
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-auto"><path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 18h-8.5A2.25 2.25 0 012 15.25v-8.5C2 4.75 3.25 3.5 4.75 3.5h4a.75.75 0 010 1.5h-4z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M15.75 3a.75.75 0 01.75.75V9a.75.75 0 01-1.5 0V5.06L10.22 10.53a.75.75 0 01-1.06-1.06l5.47-5.47H12a.75.75 0 010-1.5h3.75z" clip-rule="evenodd" /></svg>
            </a>
        </div>
        
        <div class="sidebar-footer">
             <button id="signout_button" class="w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                Cerrar Sesión
            </button>
        </div>
    </nav>

    <!-- Overlay for when side menu is open (visible on mobile only) -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

    <!-- Main Content Area -->
    <main class="main-admin-content-container p-4 md:p-8 rounded-xl shadow-lg w-full max-w-5xl relative mx-auto my-4 md:my-8">
        <h1 class="text-3xl md:text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500">Panel de Administración</h1>

        <!-- Authentication buttons -->
        <div id="auth-container" class="max-w-md mx-auto">
            <div class="p-8 border rounded-lg shadow-sm bg-white dark:bg-gray-800 dark:border-gray-700">
                <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2>
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="email" class="w-full p-2 border rounded-md" placeholder="tu@email.com">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium mb-1">Contraseña</label>
                        <input type="password" id="password" class="w-full p-2 border rounded-md" placeholder="••••••••">
                    </div>
                    <button id="login-button" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                        Entrar
                    </button>
                </div>
                <p id="auth-status" class="text-center text-red-500 mt-4 h-4"></p>
            </div>
        </div>

        <!-- Admin Content -->
        <div id="admin-content" class="hidden">
            <!-- Tab contents go here -->
            <div id="team-formation" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4">Armar Equipos</h2>
                <div class="mb-4">
                    <label for="team-match-date" class="block text-sm font-medium">Fecha del Partido:</label>
                    <input type="date" id="team-match-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <p class="text-gray-500 mb-4">Selecciona 10 jugadores para formar los equipos Claros y Oscuros.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-medium mb-3">Jugadores Disponibles</h3>
                        <div id="titulares-players" class="border border-gray-300 rounded-lg p-4 bg-gray-50 flex flex-wrap gap-1 min-h-[120px]">
                            <p class="text-gray-500">Cargando titulares...</p>
                        </div>
                        <h4 class="font-semibold mb-2 mt-4">Suplentes</h4>
                        <div id="suplentes-players" class="border border-gray-300 rounded-lg p-4 bg-gray-50 flex flex-wrap gap-1 min-h-[120px]">
                            <p class="text-gray-500">Cargando suplentes...</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-3">Jugadores Seleccionados (<span id="total-selected-players">0</span>/10)</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold mb-2">Claros (<span id="claros-count">0</span>)</h4>
                                <div id="team-claros" class="border border-gray-300 rounded-lg p-3 flex flex-wrap content-start gap-1 min-h-[120px]">
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">Oscuros (<span id="oscuros-count">0</span>)</h4>
                                <div id="team-oscuros" class="border border-gray-300 rounded-lg p-3 flex flex-wrap content-start gap-1 min-h-[120px]"></div>
                            </div>
                        </div>
                        <button id="save-teams-button" class="mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 w-full" disabled>
                            Guardar Equipos para Partido
                        </button>
                    </div>
                </div>
            </div>

            <div id="players-management" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4">Gestionar Jugadores</h2>
                <div class="mb-6 p-4 border rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium mb-3">Añadir/Modificar Jugador</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="player-id" class="block text-sm font-medium">ID Jugador (para modificar):</label>
                            <input type="text" id="player-id" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2" placeholder="Dejar vacío para nuevo">
                        </div>
                        <div>
                            <label for="player-name" class="block text-sm font-medium">Nombre:</label>
                            <input type="text" id="player-name" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="player-status" class="block text-sm font-medium">Estado:</label>
                            <select id="player-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                            </select>
                        </div>
                        <div>
                            <label for="player-role" class="block text-sm font-medium">Rol:</label>
                            <select id="player-role" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                <option value="Titular">Titular</option>
                                <option value="Suplente">Suplente</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-3">
                        <button id="save-player-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                            Guardar Jugador
                        </button>
                        <button id="delete-player-button" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                            Eliminar Jugador
                        </button>
                    </div>
                </div>

                <h3 class="text-xl font-medium mb-3">Listado de Jugadores</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="player-list-name-filter" class="block text-sm font-medium">Buscar por Nombre:</label>
                        <input type="text" id="player-list-name-filter" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2" placeholder="Ej: Mati">
                    </div>
                    <div>
                        <label for="player-list-status-filter" class="block text-sm font-medium">Filtrar por Estado:</label>
                        <select id="player-list-status-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                            <option value="Todos">Todos</option>
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                    <div>
                        <label for="player-list-role-filter" class="block text-sm font-medium">Filtrar por Rol:</label>
                        <select id="player-list-role-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                            <option value="Todos">Todos</option>
                            <option value="Titular">Titular</option>
                            <option value="Suplente">Suplente</option>
                        </select>
                    </div>
                </div>

                <div id="players-list-admin" class="overflow-x-auto">
                    <p id="players-loading-message-admin" class="text-center">Cargando jugadores...</p>
                    <table class="min-w-full rounded-lg shadow hidden">
                        <thead>
                            <tr class="uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">ID</th>
                                <th class="py-3 px-6 text-left">Nombre</th>
                                <th class="py-3 px-6 text-left">Estado</th>
                                <th class="py-3 px-6 text-left">Rol</th>
                                <th class="py-3 px-6 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm font-light">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="match-results" class="tab-content hidden">
                 <h2 class="text-2xl font-semibold mb-4">Resultados</h2>
                <div class="mb-6 p-4 border rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium mb-3">Partido Seleccionado</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="match-date" class="block text-sm font-medium">Fecha del Partido:</label>
                            <input type="date" id="match-date" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2" readonly>
                        </div>
                        <div>
                            <label for="match-result" class="block text-sm font-medium">Resultado:</label>
                            <select id="match-result" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                <option value="">Seleccionar resultado</option>
                                <option value="Claros">Claros</option>
                                <option value="Oscuros">Oscuros</option>
                                <option value="Empate">Empate</option>
                                <option value="Suspendido">Suspendido</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button id="register-match-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex-1">
                            Registrar Resultado
                        </button>
                        <button id="delete-match-button" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 flex-1">
                            Eliminar Partido
                        </button>
                    </div>

                    <h3 class="text-xl font-medium mb-3 mt-6">Seleccionar Partido</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="results-match-year-select" class="block text-sm font-medium">Año:</label>
                            <select id="results-match-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                            </select>
                        </div>
                        <div>
                            <label for="results-match-month-select" class="block text-sm font-medium">Mes:</label>
                            <select id="results-match-month-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                                <option value="all">Todos</option>
                                <option value="0">Enero</option>
                                <option value="1">Febrero</option>
                                <option value="2">Marzo</option>
                                <option value="3">Abril</option>
                                <option value="4">Mayo</option>
                                <option value="5">Junio</option>
                                <option value="6">Julio</option>
                                <option value="7">Agosto</option>
                                <option value="8">Septiembre</option>
                                <option value="9">Octubre</option>
                                <option value="10">Noviembre</option>
                                <option value="11">Diciembre</option>
                            </select>
                        </div>
                    </div>
                    <label class="block text-sm font-medium mt-4">Partidos Disponibles:</label>
                    <div id="results-match-list" class="mt-1 border rounded-md shadow-sm max-h-80 overflow-y-auto p-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                        <p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>
                    </div>
                </div>
            </div>

            <div id="chamigo-management" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-4">Chamigo</h2>
                <div class="mb-6 p-4 border rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium mb-3">Registrar Votos de Chamigo</h3>
                    <div id="chamigo-voting-players" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        <p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>
                    </div>
                    <button id="register-chamigo-button" class="px-6 py-3 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-300 w-full">
                        Registrar Chamigo(s)
                    </button>
                </div>

                <h3 class="text-xl font-medium mb-3 mt-6">Seleccionar Partido</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="chamigo-match-year-select" class="block text-sm font-medium">Año:</label>
                        <select id="chamigo-match-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                        </select>
                    </div>
                    <div>
                        <label for="chamigo-match-month-select" class="block text-sm font-medium">Mes:</label>
                        <select id="chamigo-match-month-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                            <option value="all">Todos</option>
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                    </div>
                </div>
                <label class="block text-sm font-medium mt-4">Partidos Disponibles:</label>
                <div id="chamigo-match-list" class="mt-1 border rounded-md shadow-sm max-h-80 overflow-y-auto p-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                    <p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>
                </div>
            </div>

            <div id="tt-attendance" class="tab-content hidden">
                 <h2 class="text-2xl font-semibold mb-4">TT</h2>
                <div class="p-4 border rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium mb-3">Registrar Asistencia TT</h3>
                    <div id="tt-attendance-players" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4">
                        <p class="text-gray-500">Selecciona un partido para cargar los jugadores.</p>
                    </div>
                    <button id="register-tt-button" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 w-full">
                        Registrar Asistencia TT
                    </button>
                </div>

                <h3 class="text-xl font-medium mb-3 mt-6">Seleccionar Partido</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="tt-match-year-select" class="block text-sm font-medium">Año:</label>
                        <select id="tt-match-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                        </select>
                    </div>
                    <div>
                        <label for="tt-match-month-select" class="block text-sm font-medium">Mes:</label>
                        <select id="tt-match-month-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm">
                           <option value="all">Todos</option>
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                    </div>
                </div>
                <label class="block text-sm font-medium mt-4">Partidos Disponibles:</label>
                <div id="tt-match-list" class="mt-1 border rounded-md shadow-sm max-h-80 overflow-y-auto p-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                    <p class="text-gray-500">Selecciona un año y mes para ver los partidos.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Custom Modal for Confirmation -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-semibold mb-4" id="modal-title">Confirmar Acción</h3>
            <p class="mb-6" id="modal-message">¿Estás seguro de que quieres realizar esta acción?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Cancelar</button>
                <button id="modal-confirm-button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Confirmar</button>
            </div>
        </div>
    </div>

        <script>
        // Se ejecuta cuando el HTML está listo. Como el script de Supabase está antes, ya estará cargado.
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuración de Supabase ---
            const SUPABASE_URL = 'https://ezoqqzequstrzemlbsoa.supabase.co'; 
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6b3FxemVxdXN0cnplbWxic29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3Mjc4MzEsImV4cCI6MjA2ODMwMzgzMX0.v_i5kI1dXB4FEt-f8I6Fe5MetcktYnOyt7809un0VlQ'; 
            const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
            // --- Cache de Datos ---
            let allPlayersData = []; 
            let allMatchesData = []; 
    
            // Variables para el drag-and-drop táctil
            let currentDraggedPlayer = null;
            let originalParentOfDraggedPlayer = null;
            
            // --- Elementos del DOM ---
            const authContainer = document.getElementById('auth-container');
            const adminContent = document.getElementById('admin-content');
            const sideMenu = document.getElementById('side-menu');
            const hamburgerButton = document.getElementById('hamburger-button');
            const overlay = document.getElementById('overlay');
            const loginButton = document.getElementById('login-button');
            const signoutButton = document.getElementById('signout_button');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const authStatus = document.getElementById('auth-status');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const customConfirmModal = document.getElementById('custom-confirm-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalCancelButton = document.getElementById('modal-cancel-button');
            const modalConfirmButton = document.getElementById('modal-confirm-button');
            const playerIdInput = document.getElementById('player-id');
            const playerNameInput = document.getElementById('player-name');
            const playerStatusSelect = document.getElementById('player-status');
            const playerRoleSelect = document.getElementById('player-role');
            const savePlayerButton = document.getElementById('save-player-button');
            const deletePlayerButton = document.getElementById('delete-player-button');
            const playersListAdminTableBody = document.querySelector('#players-list-admin table tbody');
            const playersLoadingMessageAdmin = document.getElementById('players-loading-message-admin');
            const playerListNameFilter = document.getElementById('player-list-name-filter');
            const playerListStatusFilter = document.getElementById('player-list-status-filter');
            const playerListRoleFilter = document.getElementById('player-list-role-filter');
            const teamMatchDateInput = document.getElementById('team-match-date');
            const titularesPlayersDiv = document.getElementById('titulares-players');
            const suplentesPlayersDiv = document.getElementById('suplentes-players');
            const teamClarosDiv = document.getElementById('team-claros');
            const teamOscurosDiv = document.getElementById('team-oscuros');
            const clarosCountSpan = document.getElementById('claros-count');
            const oscurosCountSpan = document.getElementById('oscuros-count');
            const saveTeamsButton = document.getElementById('save-teams-button');
            const matchDateInput = document.getElementById('match-date');
            const matchResultSelect = document.getElementById('match-result');
            const resultsMatchYearSelect = document.getElementById('results-match-year-select');
            const resultsMatchMonthSelect = document.getElementById('results-match-month-select');
            const resultsMatchListDiv = document.getElementById('results-match-list');
            const registerMatchButton = document.getElementById('register-match-button');
            const deleteMatchButton = document.getElementById('delete-match-button');
            const chamigoVotingPlayersDiv = document.getElementById('chamigo-voting-players');
            const registerChamigoButton = document.getElementById('register-chamigo-button');
            const chamigoMatchYearSelect = document.getElementById('chamigo-match-year-select');
            const chamigoMatchMonthSelect = document.getElementById('chamigo-match-month-select');
            const chamigoMatchListDiv = document.getElementById('chamigo-match-list');
            const ttAttendancePlayersDiv = document.getElementById('tt-attendance-players');
            const registerTtButton = document.getElementById('register-tt-button');
            const ttMatchYearSelect = document.getElementById('tt-match-year-select');
            const ttMatchMonthSelect = document.getElementById('tt-match-month-select');
            const ttMatchListDiv = document.getElementById('tt-match-list');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const darkModeIcon = document.getElementById('dark-mode-icon');
            const htmlElement = document.documentElement;
    
            // --- Funciones de Autenticación con Supabase ---
            const handleLogin = async () => {
                loginButton.disabled = true;
                loginButton.textContent = "Entrando...";
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                authStatus.textContent = '';
                if (!email || !password) {
                    authStatus.textContent = 'Por favor, ingresa email y contraseña.';
                    loginButton.disabled = false;
                    loginButton.textContent = "Entrar";
                    return;
                }
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    authStatus.textContent = 'Email o contraseña incorrectos.';
                }
                loginButton.disabled = false;
                loginButton.textContent = "Entrar";
            };
    
            const handleSignoutClick = async () => {
                await supabaseClient.auth.signOut();
            };
            
            const handleAuthStateChange = async (event, session) => {
                if (session) {
                    authContainer.classList.add('hidden');
                    adminContent.classList.remove('hidden');
                    updateUIForAuth();
                    await loadAllDataAndDisplayAllContent();
                    setupTabNavigation();
                    const defaultTabButton = document.querySelector('.tab-button[data-tab="team-formation"]');
                    if (defaultTabButton) {
                        defaultTabButton.classList.add('active');
                        document.getElementById(defaultTabButton.dataset.tab).classList.remove('hidden');
                    }
                } else {
                    authContainer.classList.remove('hidden');
                    adminContent.classList.add('hidden');
                    sideMenu.classList.add('hidden');
                    sideMenu.classList.remove('open');
                    hamburgerButton.classList.add('hidden');
                    overlay.classList.remove('open');
                    document.body.classList.remove('overflow-hidden');
                }
            };
    
            function updateUIForAuth() {
                if (window.innerWidth >= 768) {
                    sideMenu.classList.remove('hidden');
                    sideMenu.classList.add('open');
                    hamburgerButton.classList.add('hidden');
                } else {
                    sideMenu.classList.add('hidden');
                    sideMenu.classList.remove('open');
                    hamburgerButton.classList.remove('hidden');
                }
            }
    
            // --- Funciones de UI (Modo Oscuro, Modal, etc.) ---
            function applyTheme(theme) {
                if (theme === 'dark') {
                    htmlElement.classList.add('dark');
                    darkModeIcon.classList.remove('fa-moon');
                    darkModeIcon.classList.add('fa-sun');
                } else {
                    htmlElement.classList.remove('dark');
                    darkModeIcon.classList.remove('fa-sun');
                    darkModeIcon.classList.add('fa-moon');
                }
                localStorage.setItem('theme', theme);
            }
    
            function toggleTheme() {
                const currentTheme = htmlElement.classList.contains('dark') ? 'light' : 'dark';
                applyTheme(currentTheme);
            }
    
            function showCustomConfirm(title, message) {
                return new Promise((resolve) => {
                    modalTitle.textContent = title;
                    modalMessage.textContent = message;
                    customConfirmModal.classList.remove('hidden');
                    modalConfirmButton.onclick = () => {
                        customConfirmModal.classList.add('hidden');
                        resolve(true);
                    };
                    modalCancelButton.onclick = () => {
                        customConfirmModal.classList.add('hidden');
                        resolve(false);
                    };
                });
            }
    
            // --- Funciones de Carga de Datos (AÚN NO FUNCIONALES) ---
            async function loadAllData() {
                console.warn("loadAllData() todavía usa la lógica de Google Sheets. Se reemplazará en el siguiente paso.");
                allPlayersData = [];
                allMatchesData = [];
                return Promise.resolve();
            }
    
            async function loadAllDataAndDisplayAllContent() {
                await loadAllData();
                renderPlayersListAdmin();
                renderAvailablePlayersForTeams();
                populateResultsMatchYearSelect();
                populateChamigoTtMatchYearSelect();
                setInitialFilters();
            }
            
            // --- El resto de tus funciones (UI, Drag & Drop, etc.) ---
            function setInitialFilters() {
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                const selectsToUpdate = [
                    { year: 'results-match-year-select', month: 'results-match-month-select' },
                    { year: 'chamigo-match-year-select', month: 'chamigo-match-month-select' },
                    { year: 'tt-match-year-select', month: 'tt-match-month-select' }
                ];
                selectsToUpdate.forEach(pair => {
                    const yearSelect = document.getElementById(pair.year);
                    const monthSelect = document.getElementById(pair.month);
                    if (Array.from(yearSelect.options).some(opt => opt.value == currentYear)) {
                        yearSelect.value = currentYear;
                    }
                    monthSelect.value = currentMonth;
                    yearSelect.dispatchEvent(new Event('change'));
                    monthSelect.dispatchEvent(new Event('change'));
                });
            }
    
            function setupTabNavigation() {
                tabButtons.forEach(button => {
                    button.addEventListener('click', handleTabButtonClick);
                });
            }
    
            function handleTabButtonClick(event) {
                const clickedButton = event.currentTarget;
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.add('hidden'));
                clickedButton.classList.add('active');
                document.getElementById(clickedButton.dataset.tab).classList.remove('hidden');
                if (window.innerWidth < 768) {
                    toggleSideMenu();
                }
                const tabId = clickedButton.dataset.tab;
                if (tabId === 'players-management') renderPlayersListAdmin();
                if (tabId === 'team-formation') renderAvailablePlayersForTeams();
            }
    
            function toggleSideMenu() {
                if (window.innerWidth < 768) {
                    const isOpen = sideMenu.classList.toggle('open');
                    overlay.classList.toggle('open', isOpen);
                    document.body.classList.toggle('overflow-hidden', isOpen);
                    if (isOpen) {
                        sideMenu.classList.remove('hidden');
                    } else {
                        setTimeout(() => sideMenu.classList.add('hidden'), 300);
                    }
                }
            }
    
            function renderPlayersListAdmin() {
                playersListAdminTableBody.innerHTML = '';
                const table = document.querySelector('#players-list-admin table');
                playersLoadingMessageAdmin.classList.remove('hidden');
                table.classList.add('hidden');
                playersLoadingMessageAdmin.textContent = 'Cargando jugadores...';
                const filteredPlayers = []; 
                if (filteredPlayers.length === 0) {
                    playersLoadingMessageAdmin.textContent = 'Aún no se han cargado jugadores desde Supabase.';
                    return;
                }
            }
    
            savePlayerButton.addEventListener('click', async () => {
                console.warn("Funcionalidad no migrada a Supabase todavía.");
                alert("Funcionalidad no migrada a Supabase todavía.");
            });
    
            deletePlayerButton.addEventListener('click', async () => {
                console.warn("Funcionalidad no migrada a Supabase todavía.");
                alert("Funcionalidad no migrada a Supabase todavía.");
            });
            
            function renderAvailablePlayersForTeams() {
                titularesPlayersDiv.innerHTML = '';
                suplentesPlayersDiv.innerHTML = '';
                const activePlayers = allPlayersData.filter(p => p[2] === 'Activo');
                if (activePlayers.length === 0) {
                    titularesPlayersDiv.innerHTML = '<p class="text-gray-500">No hay jugadores activos.</p>';
                    return;
                }
                activePlayers.forEach(([id, nombre, estado, rol = 'Titular']) => {
                    const playerElement = document.createElement('div');
                    playerElement.className = 'player-draggable';
                    playerElement.draggable = true;
                    playerElement.dataset.id = id;
                    playerElement.dataset.name = nombre;
                    playerElement.textContent = nombre;
                    playerElement.addEventListener('dragstart', handleDragStart);
                    playerElement.addEventListener('touchstart', handleTouchStart, { passive: false });
                    if (rol === 'Titular') {
                        titularesPlayersDiv.appendChild(playerElement);
                    } else {
                        suplentesPlayersDiv.appendChild(playerElement);
                    }
                });
            }
            
            function handleDragStart(e) {
                e.dataTransfer.setData('text/plain', JSON.stringify({
                    id: e.target.dataset.id,
                    name: e.target.dataset.name,
                    source: e.target.parentNode.id
                }));
                e.dataTransfer.effectAllowed = 'move';
            }
    
            function handleTouchStart(e) {
                if (e.touches.length !== 1) return;
                e.preventDefault();
                currentDraggedPlayer = e.target;
                originalParentOfDraggedPlayer = currentDraggedPlayer.parentNode;
                const rect = currentDraggedPlayer.getBoundingClientRect();
                currentDraggedPlayer.style.position = 'fixed';
                currentDraggedPlayer.style.left = `${rect.left}px`;
                currentDraggedPlayer.style.top = `${rect.top}px`;
                currentDraggedPlayer.style.width = `${rect.width}px`;
                currentDraggedPlayer.style.height = `${rect.height}px`;
                currentDraggedPlayer.style.pointerEvents = 'none';
                currentDraggedPlayer.style.zIndex = '1000';
                currentDraggedPlayer.classList.add('dragging-touch');
                document.addEventListener('touchmove', handleTouchMove, { passive: false });
                document.addEventListener('touchend', handleTouchEnd);
            }
    
            function handleTouchMove(e) {
                if (!currentDraggedPlayer) return;
                e.preventDefault();
                const touch = e.touches[0];
                currentDraggedPlayer.style.left = `${touch.clientX - currentDraggedPlayer.offsetWidth / 2}px`;
                currentDraggedPlayer.style.top = `${touch.clientY - currentDraggedPlayer.offsetHeight / 2}px`;
            }
            
            function handleTouchEnd(e) {
                if (!currentDraggedPlayer) return;
                currentDraggedPlayer.style.visibility = 'hidden';
                const touch = e.changedTouches[0];
                const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
                currentDraggedPlayer.style.visibility = 'visible';
                currentDraggedPlayer.style.position = '';
                currentDraggedPlayer.style.left = '';
                currentDraggedPlayer.style.top = '';
                currentDraggedPlayer.style.width = '';
                currentDraggedPlayer.style.height = '';
                currentDraggedPlayer.style.pointerEvents = '';
                currentDraggedPlayer.style.zIndex = '';
                currentDraggedPlayer.classList.remove('dragging-touch');
                const dropZone = dropTarget ? dropTarget.closest('#titulares-players, #suplentes-players, #team-claros, #team-oscuros') : null;
                if (dropZone) {
                    handleDropLogic(currentDraggedPlayer, dropZone);
                } else {
                    originalParentOfDraggedPlayer.appendChild(currentDraggedPlayer);
                }
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
                currentDraggedPlayer = null;
                originalParentOfDraggedPlayer = null;
            }
    
            [titularesPlayersDiv, suplentesPlayersDiv, teamClarosDiv, teamOscurosDiv].forEach(dropZone => {
                dropZone.addEventListener('dragover', (e) => e.preventDefault());
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    const draggedElement = document.querySelector(`[data-id="${data.id}"]`);
                    const dropZone = e.currentTarget;
                    handleDropLogic(draggedElement, dropZone);
                });
            });
            
            function handleDropLogic(draggedElement, dropZone) {
                const sourceId = draggedElement.parentNode.id;
                const targetId = dropZone.id;
                if (sourceId === targetId) return;
                if ((sourceId === 'titulares-players' && targetId === 'suplentes-players') || (sourceId === 'suplentes-players' && targetId === 'titulares-players')) {
                    return;
                }
                if ((targetId === 'team-claros' || targetId === 'team-oscuros') && dropZone.children.length >= 5) {
                    alert(`El equipo ya tiene 5 jugadores.`);
                    if (draggedElement.parentNode !== originalParentOfDraggedPlayer && originalParentOfDraggedPlayer) {
                        originalParentOfDraggedPlayer.appendChild(draggedElement);
                    }
                    return;
                }
                dropZone.appendChild(draggedElement);
                updateTeamCounts();
            }
    
            function updateTeamCounts() {
                const clarosCount = teamClarosDiv.children.length;
                const oscurosCount = teamOscurosDiv.children.length;
                clarosCountSpan.textContent = clarosCount;
                oscurosCountSpan.textContent = oscurosCount;
                document.getElementById('total-selected-players').textContent = clarosCount + oscurosCount;
                saveTeamsButton.disabled = !(clarosCount === 5 && oscurosCount === 5);
            }
            
            function parseDate(dateString) {
                const [day, month, year] = dateString.split('/').map(Number);
                return new Date(year, month - 1, day);
            }
    
            function parseYYYYMMDDToLocalDate(dateString) {
                const [year, month, day] = dateString.split('-').map(Number);
                return new Date(year, month - 1, day);
            }
    
            function formatDateToDDMMYYYY(date) {
                const dd = String(date.getDate()).padStart(2, '0');
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const yyyy = date.getFullYear();
                return `${dd}/${mm}/${yyyy}`;
            }
            
            async function handleResize() {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) return;
                if (window.innerWidth >= 768) {
                    sideMenu.classList.remove('hidden');
                    sideMenu.classList.add('open');
                    hamburgerButton.classList.add('hidden');
                    overlay.classList.remove('open');
                    document.body.classList.remove('overflow-hidden');
                } else {
                    sideMenu.classList.add('hidden');
                    sideMenu.classList.remove('open');
                    hamburgerButton.classList.remove('hidden');
                }
            }
            
            saveTeamsButton.addEventListener('click', async () => {
                 alert("Funcionalidad no migrada a Supabase todavía.");
            });
    
            function populateResultsMatchYearSelect() {
                const years = allMatchesData.length > 0 
                    ? [...new Set(allMatchesData.map(m => new Date(m.match_date).getFullYear()))].sort((a,b) => b-a)
                    : [];
                resultsMatchYearSelect.innerHTML = '';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    resultsMatchYearSelect.appendChild(option);
                });
            }
    
            function populateMatchSelects() {
                const selectedYear = resultsMatchYearSelect.value;
                const selectedMonth = resultsMatchMonthSelect.value;
                resultsMatchListDiv.innerHTML = '';
                const filteredMatches = allMatchesData.filter(match => {
                    const matchDate = new Date(match.match_date);
                    const yearMatch = selectedYear ? matchDate.getFullYear() == selectedYear : true;
                    const monthMatch = selectedMonth !== 'all' ? matchDate.getMonth() == selectedMonth : true;
                    return yearMatch && monthMatch;
                }).sort((a,b) => new Date(b.match_date) - new Date(a.match_date));
                if (filteredMatches.length === 0) {
                    resultsMatchListDiv.innerHTML = '<p class="text-gray-500">No hay partidos para los filtros seleccionados.</p>';
                    return;
                }
                filteredMatches.forEach(match => {
                    const fecha = formatDateToDDMMYYYY(new Date(match.match_date));
                    const matchItem = document.createElement('div');
                    matchItem.className = `match-item p-2 border rounded-md cursor-pointer ${match.result ? 'has-result' : 'no-result'}`;
                    matchItem.dataset.matchId = match.id;
                    matchItem.innerHTML = `<p class="font-semibold">${fecha}</p><p class="text-xs text-gray-500">Resultado: ${match.result || 'Pendiente'}</p>`;
                    resultsMatchListDiv.appendChild(matchItem);
                    matchItem.addEventListener('click', () => {
                        document.querySelectorAll('#results-match-list .match-item').forEach(item => item.classList.remove('selected', 'border-indigo-500'));
                        matchItem.classList.add('selected', 'border-indigo-500');
                        matchDateInput.value = match.match_date;
                        matchResultSelect.value = match.result || '';
                    });
                });
            }
    
            registerMatchButton.addEventListener('click', async () => {
                alert("Funcionalidad no migrada a Supabase todavía.");
            });
    
            deleteMatchButton.addEventListener('click', async () => {
                alert("Funcionalidad no migrada a Supabase todavía.");
            });
            
            function populateChamigoTtMatchYearSelect() {
                 const years = allMatchesData.length > 0 
                    ? [...new Set(allMatchesData.map(m => new Date(m.match_date).getFullYear()))].sort((a,b) => b-a)
                    : [];
                [chamigoMatchYearSelect, ttMatchYearSelect].forEach(select => {
                    select.innerHTML = '';
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        select.appendChild(option);
                    });
                });
            }
            
            function populateChamigoTtMatchLists() {
                populateMatchListForTab(chamigoMatchListDiv, chamigoMatchYearSelect, chamigoMatchMonthSelect, handleChamigoMatchSelection, 'chamigo');
                populateMatchListForTab(ttMatchListDiv, ttMatchYearSelect, ttMatchMonthSelect, handleTtMatchSelection, 'tt');
            }
    
            function populateMatchListForTab(targetListDiv, yearSelect, monthSelect, onMatchClickCallback, tabName) {
                const selectedYear = yearSelect.value;
                const selectedMonth = monthSelect.value;
                targetListDiv.innerHTML = '';
                const filteredMatches = allMatchesData.filter(match => {
                    const matchDate = new Date(match.match_date);
                    const yearMatch = selectedYear ? matchDate.getFullYear() == selectedYear : true;
                    const monthMatch = selectedMonth !== 'all' ? matchDate.getMonth() == selectedMonth : true;
                    return yearMatch && monthMatch;
                }).sort((a,b) => new Date(b.match_date) - new Date(a.match_date));
                if (filteredMatches.length === 0) {
                    targetListDiv.innerHTML = '<p class="text-gray-500">No hay partidos para los filtros seleccionados.</p>';
                    return;
                }
                filteredMatches.forEach(match => {
                    const fecha = formatDateToDDMMYYYY(new Date(match.match_date));
                    const matchItem = document.createElement('div');
                    let isComplete = false;
                    if (tabName === 'chamigo') isComplete = match.chamigo_votes && Object.keys(match.chamigo_votes).length > 0;
                    if (tabName === 'tt') isComplete = match.tt_attendees && match.tt_attendees.length > 0;
                    matchItem.className = `match-item p-2 border rounded-md cursor-pointer ${isComplete ? 'has-result' : 'no-result'}`;
                    matchItem.dataset.matchId = match.id;
                    matchItem.innerHTML = `<p class="font-semibold">${fecha}</p>`;
                    targetListDiv.appendChild(matchItem);
                    matchItem.addEventListener('click', () => {
                        document.querySelectorAll(`#${tabName}-match-list .match-item`).forEach(item => item.classList.remove('selected', 'border-indigo-500'));
                        matchItem.classList.add('selected', 'border-indigo-500');
                        onMatchClickCallback(match.id);
                    });
                });
            }
            
            function handleChamigoMatchSelection(selectedMatchId) {
                chamigoVotingPlayersDiv.innerHTML = '';
                const match = allMatchesData.find(m => m.id === selectedMatchId);
                if (!match) return;
                const playerIDs = [...new Set([...(match.team_white_players||[]), ...(match.team_dark_players||[])])].filter(Boolean);
                const existingVotes = match.chamigo_votes || {};
                playerIDs.forEach(id => {
                    const player = allPlayersData.find(p => p.id === id);
                    if (!player) return;
                    const voteCount = existingVotes[id] || 0;
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'flex items-center space-x-2';
                    playerDiv.innerHTML = `
                        <label class="block text-sm font-medium w-24 truncate" title="${player.name}">${player.name}:</label>
                        <input type="number" data-id="${id}" class="chamigo-vote-input mt-1 block w-20 rounded-md shadow-sm sm:text-sm p-2" value="${voteCount}" min="0">
                    `;
                    chamigoVotingPlayersDiv.appendChild(playerDiv);
                });
            }
            
            registerChamigoButton.addEventListener('click', async () => {
                alert("Funcionalidad no migrada a Supabase todavía.");
            });
            
            function handleTtMatchSelection(selectedMatchId) {
                ttAttendancePlayersDiv.innerHTML = '';
                const match = allMatchesData.find(m => m.id === selectedMatchId);
                if (!match) return;
                const activePlayers = allPlayersData.filter(p => p.status === 'Activo');
                const existingAttendees = match.tt_attendees || [];
                activePlayers.forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'flex items-center space-x-2';
                    playerDiv.innerHTML = `
                        <input type="checkbox" id="tt-player-${player.id}" data-id="${player.id}" class="tt-checkbox h-4 w-4 rounded" ${existingAttendees.includes(player.id) ? 'checked' : ''}>
                        <label for="tt-player-${player.id}" class="text-sm font-medium">${player.name}</label>
                    `;
                    ttAttendancePlayersDiv.appendChild(playerDiv);
                });
            }
            
            registerTtButton.addEventListener('click', async () => {
                alert("Funcionalidad no migrada a Supabase todavía.");
            });
    
            // --- Arranque de la aplicación ---
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
            darkModeToggle.addEventListener('click', toggleTheme);
            loginButton.addEventListener('click', handleLogin);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            signoutButton.addEventListener('click', handleSignoutClick);
            hamburgerButton.addEventListener('click', toggleSideMenu);
            overlay.addEventListener('click', toggleSideMenu);
            playerListNameFilter.addEventListener('input', renderPlayersListAdmin);
            playerListStatusFilter.addEventListener('change', renderPlayersListAdmin);
            playerListRoleFilter.addEventListener('change', renderPlayersListAdmin);
            resultsMatchYearSelect.addEventListener('change', populateMatchSelects);
            resultsMatchMonthSelect.addEventListener('change', populateMatchSelects);
            chamigoMatchYearSelect.addEventListener('change', populateChamigoTtMatchLists);
            chamigoMatchMonthSelect.addEventListener('change', populateChamigoTtMatchLists);
            ttMatchYearSelect.addEventListener('change', populateChamigoTtMatchLists);
            ttMatchMonthSelect.addEventListener('change', populateChamigoTtMatchLists);
            handleResize();
            window.addEventListener('resize', handleResize);
    
            // Escuchar cambios de autenticación para manejar la UI
            supabaseClient.auth.onAuthStateChange(handleAuthStateChange);
        });
    </script>
</body>
</html>
