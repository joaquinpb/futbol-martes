<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas - LA CLANDE</title>
    
    <!-- Dependencias de Estilos y Fuentes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚽</text></svg>">

    <style>
        /* --- Sistema de Diseño y Variables (Heredado de admin.html) --- */
        :root {
            --bg-primary: #f4f7fe;
            --bg-secondary: #ffffff;
            --bg-muted: #f9fafb;
            --sidebar-bg: #111827;
            --sidebar-text: #e5e7eb;
            --sidebar-active-bg: #4f46e5;
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #374151;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --accent-color: #4f46e5;
            --accent-color-hover: #4338ca;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --button-text-color: #ffffff;
            --text-yellow-400: #facc15;
            --player-claros-bg: #ffffff;
            --player-claros-text: #1a202c;
            --player-oscuros-bg: #1a202c;
            --player-oscuros-text: #ffffff;
        }

        html.dark {
            --bg-primary: #030712;
            --bg-secondary: #1f2937;
            --bg-muted: #111827;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --accent-color: #6366f1;
            --accent-color-hover: #818cf8;
            --player-claros-bg: #ffffff;
            --player-claros-text: #1a202c;
            --player-oscuros-bg: #1a202c;
            --player-oscuros-text: #ffffff;
        }

        /* --- Estilos Base --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        body.overflow-hidden { overflow: hidden; }

        /* --- Layout Principal --- */
        @media (min-width: 768px) {
            body { display: flex; }
            main { flex-grow: 1; overflow-y: auto; height: 100vh; }
        }
        
        /* --- Contenedor de Contenido --- */
        .main-content-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,.05), 0 2px 4px -2px rgba(0,0,0,.05);
            padding: 1.5rem; /* p-6 */
        }
        @media (max-width: 767px) {
            .main-content-container { margin-top: 5rem; }
        }

        /* --- Formularios (Select, Input) --- */
        input, select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.375rem; /* rounded-md */
        }
        html.dark input, html.dark select {
             background-color: var(--bg-muted);
        }
        label { color: var(--text-secondary); }

        /* --- Barra Lateral (Side Menu) --- */
        #side-menu {
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            transition: transform 0.3s ease-in-out;
            z-index: 40;
        }
        #side-menu.open { transform: translateX(0); }
        #side-menu .tab-button.active { background-color: var(--sidebar-active-bg); color: var(--sidebar-active-text); font-weight: 600; }
        #side-menu .tab-button:hover:not(.active) { background-color: var(--sidebar-hover-bg); }
        #dark-mode-toggle { background-color: var(--sidebar-hover-bg); }
        #overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 30; }
        #hamburger-button { background-color: var(--accent-color); position: fixed; z-index: 50; }

        @media (min-width: 768px) {
            #side-menu { position: relative; transform: translateX(0); flex-shrink: 0; height: 100vh; border-right: 1px solid var(--border-color); }
            #hamburger-button, #overlay { display: none !important; }
        }

        /* --- Tablas --- */
        .table-container {
            max-height: 70vh; overflow-y: auto; border-radius: 0.5rem; position: relative;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,.05), 0 1px 2px -1px rgba(0,0,0,.05);
            border: 1px solid var(--border-color);
        }
        table { background-color: var(--bg-secondary); width: 100%; border-collapse: collapse; }
        thead th {
            background-color: #111827 !important; 
            color: #ffffff !important;
            text-transform: uppercase; font-size: 0.75rem; position: sticky; top: 0; z-index: 10;
        }
        thead th[data-sort] { cursor: pointer; transition: background-color 0.2s; }
        thead th[data-sort]:hover { background-color: #374151 !important; }

        td { color: var(--text-primary); }
        tbody tr { border-top: 1px solid var(--border-color); transition: background-color 150ms ease-in-out; }
        tbody tr:hover { background-color: var(--bg-muted); }
        tbody tr:first-child { border-top: none; }
        
        /* Columnas Fijas y Scroll */
        #estadisticas-table, #individual-stats-table { min-width: 800px; }
        .sticky-col {
            position: sticky;
            z-index: 5;
            /* FIX: Se establece un color de fondo para evitar la transparencia en el scroll */
            background-color: var(--bg-secondary);
        }
        tbody tr:hover td.sticky-col {
             /* Se asegura que el fondo en hover coincida con el resto de la fila */
            background-color: var(--bg-muted);
        }
        /* FIX: Reglas específicas para que las celdas fijas en filas con colores
           de fondo personalizados en la tabla de historial coincidan con su fila */
        #individual-stats-table tr.font-bold td.sticky-col {
            background-color: var(--accent-color);
        }
        #individual-stats-table tr[data-year] td.sticky-col {
            background-color: var(--bg-muted);
        }

        #estadisticas-table .sticky-col-1, #individual-stats-table .sticky-col-1 { left: 0; }
        #estadisticas-table .sticky-col-2 { left: 45px; }
        #individual-stats-table .sticky-col-2 { left: 90px; }
        thead th.sticky-col { z-index: 15; }
        
        /* --- Títulos y Botones --- */
        .tab-title {
            padding: 1rem;
            border-radius: 0.5rem;
            background: linear-gradient(to right, var(--accent-color), var(--accent-color-hover));
            color: var(--button-text-color);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1);
        }
        .button-primary { background-color: var(--accent-color); color: var(--button-text-color); }
        .button-primary:hover { background-color: var(--accent-color-hover); }
        .collapsible-toggle-button { background: linear-gradient(to right, var(--accent-color), var(--accent-color-hover)); color: var(--button-text-color); }
        .collapsible-toggle-button.visible-content { background: linear-gradient(to right, #e53e3e, var(--danger-color)); }

        /* --- Fixture y Campo de Fútbol --- */
        #soccer-field-container {
            position: relative;
            width: 100%;
            padding-top: 168.75%; /* Proporción 9:16 para vista vertical */
            background-color: #0f8d48;
            border: 2px solid white;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #soccer-field-container::before { /* Línea de medio campo */
            content: ''; position: absolute; top: 50%; left: 0; right: 0;
            height: 2px; background-color: rgba(255,255,255,0.7); transform: translateY(-50%); z-index: 1;
        }
        #soccer-field-container::after { /* Círculo central */
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 20%; padding-top: 20%; border: 2px solid rgba(255,255,255,0.7);
            border-radius: 50%; transform: translate(-50%, -50%); z-index: 1;
        }
        .goal-area, .penalty-area { position: absolute; box-sizing: border-box; border-style: solid; border-color: rgba(255,255,255,0.7); z-index: 1; }
        .goal-area.top { top: 0; left: 35%; width: 30%; height: 8%; border-width: 0 2px 2px 2px; }
        .goal-area.bottom { bottom: 0; left: 35%; width: 30%; height: 8%; border-width: 2px 2px 0 2px; }
        .penalty-area.top { top: 0; left: 20%; width: 60%; height: 18%; border-width: 0 2px 2px 2px; }
        .penalty-area.bottom { bottom: 0; left: 20%; width: 60%; height: 18%; border-width: 2px 2px 0 2px; }
        
        @media (min-width: 768px) {
            #soccer-field-container.horizontal-layout {
                padding-top: 60%; /* Proporción ~5:3 para vista horizontal */
            }
            #soccer-field-container.horizontal-layout::before { top: 0; left: 50%; height: 100%; width: 2px; transform: translateX(-50%); }
            #soccer-field-container.horizontal-layout::after { width: 15%; padding-top: 15%; }
            .goal-area.top.horizontal-layout { top: 35%; left: 0; height: 30%; width: 8%; border-width: 2px 2px 2px 0; }
            .goal-area.bottom.horizontal-layout { top: 35%; right: 0; left: auto; height: 30%; width: 8%; border-width: 2px 0 2px 2px; }
            .penalty-area.top.horizontal-layout { top: 20%; left: 0; height: 60%; width: 18%; border-width: 2px 2px 2px 0; }
            .penalty-area.bottom.horizontal-layout { top: 20%; right: 0; left: auto; height: 60%; width: 18%; border-width: 2px 0 2px 2px; }
        }

        #fixture-details-display { background-color: var(--bg-secondary); border: 1px solid var(--border-color); }
        .fixture-match-item { background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); }
        .fixture-match-item.selected { box-shadow: 0 0 0 2px var(--accent-color); border-color: var(--accent-color); }
        .fixture-match-item.current-match-card { background: linear-gradient(to right, var(--accent-color), var(--accent-color-hover)); color: var(--button-text-color); border-color: transparent;}
        .player-marker { border: 2px solid; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .player-marker.claros { background-color: var(--player-claros-bg); color: var(--player-claros-text); border-color: var(--player-claros-text); }
        .player-marker.oscuros { background-color: var(--player-oscuros-bg); color: var(--player-oscuros-text); border-color: var(--player-oscuros-text); }
        .player-name-label { background-color: var(--bg-secondary); color: var(--text-primary); }
        .winner-trophy { color: var(--text-yellow-400); }

        /* --- Búsqueda Individual --- */
        #individual-player-results { background-color: var(--bg-secondary); border: 1px solid var(--border-color); z-index: 20; }
        #individual-player-results > div:hover { background-color: var(--bg-muted); }
        #individual-player-search { padding-right: 2.5rem !important; }
        #clear-player-search { color: var(--text-muted); }
        
        /* --- Misc --- */
        .loading-spinner { border: 4px solid var(--border-color); border-top: 4px solid var(--accent-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-message { color: var(--text-secondary); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        html.dark ::-webkit-scrollbar-thumb { background: #555; }
        html.dark ::-webkit-scrollbar-thumb:hover { background: #888; }
    </style>
</head>
<body class="antialiased min-h-screen">
    
    <button id="hamburger-button" class="fixed top-4 left-4 p-2 rounded-md text-white shadow-lg md:hidden">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <nav id="side-menu" class="fixed top-0 left-0 h-full w-64 transform -translate-x-full md:transform-none md:relative md:w-64 flex flex-col">
        <div class="p-4 pt-8 md:pt-4 flex items-center justify-center mb-4">
            <h1 class="text-3xl font-extrabold text-white flex items-center gap-2"><span class="text-4xl">⚽</span>LA CLANDE</h1>
        </div>
        <div class="flex items-center justify-between px-6 py-2 mb-1">
            <h2 class="text-lg font-semibold flex items-center gap-2 uppercase tracking-wider text-gray-400">
                <i class="fas fa-bars"></i><span>Menú</span>
            </h2>
            <button id="dark-mode-toggle" class="p-2 w-10 h-10 rounded-full hover:bg-sidebar-hover-bg focus:outline-none transition-colors duration-150 ease-in-out flex items-center justify-center">
                <i class="fas fa-moon text-lg"></i>
            </button>
        </div>
        <div class="flex flex-col flex-1 overflow-y-auto mt-2">
             <button class="tab-button py-3 px-6 text-left font-medium flex items-center gap-3" data-tab="leaderboard-content"><i class="fas fa-trophy w-5 text-center"></i>Tabla de Posiciones</button>
             <button class="tab-button py-3 px-6 text-left font-medium flex items-center gap-3" data-tab="chamigo-content"><i class="fas fa-star w-5 text-center"></i>Chamigo</button>
             <button class="tab-button py-3 px-6 text-left font-medium flex items-center gap-3" data-tab="tt-content"><i class="fas fa-beer w-5 text-center"></i>TT</button>
             <button class="tab-button py-3 px-6 text-left font-medium flex items-center gap-3" data-tab="presentismo-content"><i class="fas fa-check-circle w-5 text-center"></i>Presentismo</button>
             <button class="tab-button py-3 px-6 text-left font-medium flex items-center gap-3" data-tab="ausentismo-content"><i class="fas fa-times-circle w-5 text-center"></i>Ausentismo</button>
             <button class="tab-button py-3 px-6 text-left font-medium flex items-center gap-3" data-tab="estadisticas-content"><i class="fas fa-chart-bar w-5 text-center"></i>Estadísticas</button>
             <button class="tab-button py-3 px-6 text-left font-medium flex items-center gap-3" data-tab="equipos-content"><i class="fas fa-futbol w-5 text-center"></i>Equipos</button>
             <button class="tab-button py-3 px-6 text-left font-medium flex items-center gap-3" data-tab="fixture-content"><i class="fas fa-calendar-alt w-5 text-center"></i>Fixture</button>
             <button class="tab-button py-3 px-6 text-left font-medium flex items-center gap-3" data-tab="individual-stats-content"><i class="fas fa-history w-5 text-center"></i>Histórico</button>
        </div>
    </nav>
    <div id="overlay" class="hidden md:hidden"></div>

    <main class="flex-1 p-4 sm:p-6 lg:p-8">
        <!-- El contenido de las pestañas se renderizará aquí -->
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURACIÓN Y VARIABLES GLOBALES ---
        const SUPABASE_URL = 'https://ezoqqzequstrzemlbsoa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6b3FxemVxdXN0cnplbWxic29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3Mjc4MzEsImV4cCI6MjA2ODMwMzgzMX0.v_i5kI1dXB4FEt-f8I6Fe5MetcktYnOyt7809un0VlQ';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allPlayersData = [];
        let allMatchDates = [];
        let lastSelectedFixtureMatchId = null;
        let currentEstadisticasData = []; // Cache para datos de estadísticas

        let estadisticasSortState = { criterion: 'points', order: 'desc' };

        const DOMElements = {
            body: document.body,
            hamburgerButton: document.getElementById('hamburger-button'),
            sideMenu: document.getElementById('side-menu'),
            overlay: document.getElementById('overlay'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            mainContentArea: document.querySelector('main'),
            tabButtons: document.querySelectorAll('.tab-button'),
        };

        const hashToTabMap = {
            "#leaderboard": "leaderboard-content", "#chamigo": "chamigo-content", "#tt": "tt-content",
            "#presentismo": "presentismo-content", "#ausentismo": "ausentismo-content", "#estadisticas": "estadisticas-content",
            "#equipos": "equipos-content", "#fixture": "fixture-content", "#individual-stats": "individual-stats-content"
        };
        
        // --- LÓGICA DE UI Y TEMA ---
        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            localStorage.setItem('theme', theme);
            const icon = DOMElements.darkModeToggle.querySelector('i');
            if (icon) {
                icon.classList.toggle('fa-sun', theme === 'dark');
                icon.classList.toggle('fa-moon', theme !== 'dark');
            }
            if (document.querySelector('.tab-button.active')?.dataset.tab === 'fixture-content' && lastSelectedFixtureMatchId) {
                renderFixtureDetails(lastSelectedFixtureMatchId);
            }
        }

        function toggleTheme() {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
        }

        function toggleSideMenu() {
            DOMElements.sideMenu.classList.toggle('open');
            DOMElements.overlay.classList.toggle('hidden');
            DOMElements.body.classList.toggle('overflow-hidden');
        }

        function applyInitialResponsiveStyles() {
             if (window.innerWidth >= 768) {
                DOMElements.sideMenu.classList.remove('open');
                DOMElements.overlay.classList.add('hidden');
                DOMElements.body.classList.remove('overflow-hidden');
            }
        }
        
        // --- LÓGICA DE DATOS Y RENDERIZADO ---
        
        function parseDate(dateString) { 
            if (!dateString) return new Date();
            return new Date(dateString + 'T00:00:00'); 
        }

        function populateYearSelects(selectId) {
            const yearSelect = document.getElementById(selectId);
            if (!yearSelect) return;
            const years = [...new Set(allMatchDates.map(match => parseDate(match.match_date).getFullYear()))].sort((a, b) => b - a);
            
            const currentValue = yearSelect.value;
            yearSelect.innerHTML = '<option value="all">Todos los Años</option>';
            years.forEach(year => yearSelect.innerHTML += `<option value="${year}">${year}</option>`);
            if (Array.from(yearSelect.options).some(opt => opt.value === currentValue)) {
                yearSelect.value = currentValue;
            }
        }

        function populateMonthSelects(selectId) {
            const monthSelect = document.getElementById(selectId);
            if (!monthSelect) return;
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const currentValue = monthSelect.value;
            monthSelect.innerHTML = '<option value="all">Todos los Meses</option>';
            months.forEach((month, index) => monthSelect.innerHTML += `<option value="${index + 1}">${month}</option>`);
            if (currentValue) monthSelect.value = currentValue;
        }
        
        function populateAndSetCurrentPeriod(yearSelectId, periodSelectId) {
            populateYearSelects(yearSelectId);
            const yearSelect = document.getElementById(yearSelectId);
            const periodSelect = document.getElementById(periodSelectId);
            if (!periodSelect || !yearSelect) return;
            
            if (!yearSelect.value || yearSelect.value === 'all' || !periodSelect.value) {
                setTodayFilters(yearSelectId.replace('-year-select', ''));
            }
        }

        function setTodayFilters(sectionPrefix, isMonthFilter = false) {
             const today = new Date();
             const yearSelect = document.getElementById(`${sectionPrefix}-year-select`);
             const periodOrMonthSelect = isMonthFilter ? document.getElementById(`${sectionPrefix}-month-select`) : document.getElementById(`${sectionPrefix}-period-select`);
             
             if(yearSelect) yearSelect.value = today.getFullYear();
             if(periodOrMonthSelect) {
                 periodOrMonthSelect.value = isMonthFilter ? today.getMonth() + 1 : (today.getMonth() <= 5 ? 'apertura' : 'clausura');
             }
        }

        async function fetchAndCalculateStatsForPeriod(yearSelectId, periodSelectId) {
            const selectedYear = document.getElementById(yearSelectId)?.value;
            const selectedPeriod = document.getElementById(periodSelectId)?.value;

            let query = supabaseClient.from('matches').select('*');

            if (selectedYear && selectedYear !== 'all') {
                let startDate, endDate;
                if (selectedPeriod === 'apertura') {
                    startDate = `${selectedYear}-01-01`;
                    endDate = `${selectedYear}-06-30`;
                } else if (selectedPeriod === 'clausura') {
                    startDate = `${selectedYear}-07-01`;
                    endDate = `${selectedYear}-12-31`;
                } else { // total
                    startDate = `${selectedYear}-01-01`;
                    endDate = `${selectedYear}-12-31`;
                }
                query = query.gte('match_date', startDate).lte('match_date', endDate);
            }
            
            const { data: filteredMatches, error } = await query;

            if (error) {
                console.error("Error fetching matches:", error);
                return { players: [], teamStats: {}, error };
            }

            const playerStats = {};
            allPlayersData.forEach(player => {
                playerStats[player.id] = { name: player.name, points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: "0.00", chamigos: 0, tt: 0, ausentes: 0, id: player.id };
            });

            let clarosWins = 0, oscurosWins = 0, empates = 0, suspendidos = 0, totalPJMatches = 0;

            (filteredMatches || []).forEach(match => {
                const { team_white_players, team_dark_players, result, chamigo_votes, tt_attendees } = match;
                const allPlayersInMatch = [...new Set([...(team_white_players || []), ...(team_dark_players || [])])];

                if (result !== 'Suspendido') totalPJMatches++;
                else suspendidos++;

                allPlayersInMatch.forEach(pId => {
                    if (playerStats[pId]) {
                        if (result === 'Claros' && (team_white_players || []).includes(pId)) { playerStats[pId].points += 3; playerStats[pId].pg++; }
                        else if (result === 'Oscuros' && (team_dark_players || []).includes(pId)) { playerStats[pId].points += 3; playerStats[pId].pg++; }
                        else if (result === 'Empate') { playerStats[pId].points += 1; playerStats[pId].pe++; }
                        else if (result !== 'Suspendido') { playerStats[pId].pp++; }
                        if (result !== 'Suspendido') playerStats[pId].pj++;
                    }
                });

                if (result === 'Claros') clarosWins++;
                else if (result === 'Oscuros') oscurosWins++;
                else if (result === 'Empate') empates++;

                if (chamigo_votes && Object.keys(chamigo_votes).length > 0) {
                    const votosArray = Object.entries(chamigo_votes).map(([id, votos]) => ({ id, votos }));
                    if (votosArray.length > 0) {
                        const maxVotes = Math.max(...votosArray.map(v => v.votos));
                        votosArray.filter(v => v.votos === maxVotes).forEach(chamigo => {
                            if (playerStats[chamigo.id]) playerStats[chamigo.id].chamigos++;
                        });
                    }
                }

                if (tt_attendees) {
                    tt_attendees.forEach(pId => { if (playerStats[pId]) playerStats[pId].tt++; });
                }
            });

            Object.values(playerStats).forEach(player => {
                const maxPossiblePoints = player.pj * 3;
                let currentEfectividad = (maxPossiblePoints > 0) ? (player.points / maxPossiblePoints) * 100 : 0;
                if (totalPJMatches > 0) {
                    const participationRatio = player.pj / totalPJMatches;
                    player.efectividad = (participationRatio < 0.20) ? (currentEfectividad * participationRatio).toFixed(2) : currentEfectividad.toFixed(2);
                } else {
                    player.efectividad = "0.00";
                }
                player.ausentes = Math.max(0, totalPJMatches - player.pj);
            });

            return {
                players: Object.values(playerStats).filter(p => p.name),
                teamStats: { clarosWins, oscurosWins, empates, suspendidos, totalPJMatches },
                error: null
            };
        }

        async function renderGenericTable(section, filterFn, sortFn, renderRowFn, headers) {
            const table = document.getElementById(`${section}-table`);
            const loadingMessage = document.getElementById(`${section}-loading-message`);
            if (!table || !loadingMessage) return;

            table.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando datos...`;
            
            const { players, error } = await fetchAndCalculateStatsForPeriod(`${section}-year-select`, `${section}-period-select`);
            
            if (error) {
                loadingMessage.innerHTML = 'Error al cargar los datos.';
                return;
            }

            const rankedPlayers = players.filter(filterFn).sort(sortFn);
            if (rankedPlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos disponibles para los filtros seleccionados.`;
                return;
            }
            
            table.innerHTML = `
                <thead><tr>${headers.map(h => `<th class="p-3 text-center">${h}</th>`).join('')}</tr></thead>
                <tbody>${rankedPlayers.map(renderRowFn).join('')}</tbody>`;

            loadingMessage.classList.add('hidden');
            table.classList.remove('hidden');
        }

        function renderLeaderboard() {
            renderGenericTable(
                'leaderboard',
                player => player.pj > 0,
                (a, b) => b.points - a.points,
                (player, index) => `
                    <tr>
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3 text-center">${player.name}</td>
                        <td class="p-3 text-center">${player.points}</td>
                        <td class="p-3 text-center">${player.efectividad}%</td>
                    </tr>`,
                ['#', 'Jugador', 'Puntos', 'Efectividad']
            );
        }

        function renderChamigo() {
            renderGenericTable(
                'chamigo',
                p => p.chamigos > 0,
                (a, b) => b.chamigos - a.chamigos,
                (player, index) => `
                    <tr>
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3 text-center">${player.name}</td>
                        <td class="p-3 text-center">${player.chamigos}</td>
                    </tr>`,
                ['#', 'Jugador', 'Chamigos']
            );
        }
        
        function renderTT() {
            renderGenericTable(
                'tt',
                p => p.tt > 0,
                (a, b) => b.tt - a.tt,
                (player, index) => `
                    <tr>
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3 text-center">${player.name}</td>
                        <td class="p-3 text-center">${player.tt}</td>
                    </tr>`,
                ['#', 'Jugador', 'TT']
            );
        }

        function renderPresentismo() {
            renderGenericTable(
                'presentismo',
                p => p.pj > 0,
                (a, b) => b.pj - a.pj,
                (player, index) => `
                    <tr>
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3 text-center">${player.name}</td>
                        <td class="p-3 text-center">${player.pj}</td>
                    </tr>`,
                ['#', 'Jugador', 'PJ']
            );
        }
        
        function renderAusentismo() {
            renderGenericTable(
                'ausentismo',
                p => p.pj > 0,
                (a, b) => b.ausentes - a.ausentes,
                (player, index) => `
                    <tr>
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3 text-center">${player.name}</td>
                        <td class="p-3 text-center">${player.ausentes}</td>
                    </tr>`,
                ['#', 'Jugador', 'Ausentes']
            );
        }

        async function renderEstadisticas(fromSort = false) {
            const table = document.getElementById('estadisticas-table');
            const loadingMessage = document.getElementById('estadisticas-loading-message');
            if (!table || !loadingMessage) return;
            
            if (!fromSort) {
                table.classList.add('hidden');
                loadingMessage.classList.remove('hidden');
                const { players, error } = await fetchAndCalculateStatsForPeriod('estadisticas-year-select', 'estadisticas-period-select');
                if (error) { loadingMessage.innerHTML = 'Error al cargar los datos.'; return; }
                currentEstadisticasData = players;
            }

            const sortCriterion = estadisticasSortState.criterion;
            const sortOrder = estadisticasSortState.order;
            const rankedPlayers = [...currentEstadisticasData].filter(p => p.pj > 0).sort((a, b) => {
                let valA = parseFloat(a[sortCriterion]) || 0;
                let valB = parseFloat(b[sortCriterion]) || 0;
                return sortOrder === 'asc' ? valA - valB : valB - valA;
            });
            
            if (rankedPlayers.length === 0) { loadingMessage.innerHTML = `No hay datos disponibles.`; return; }

            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="p-2 text-center sticky-col sticky-col-1">#</th>
                        <th class="p-3 text-center sticky-col sticky-col-2">Jugador</th>
                        <th class="p-3 text-center" data-sort="points">Puntos</th>
                        <th class="p-3 text-center" data-sort="pg">PG</th>
                        <th class="p-3 text-center" data-sort="pe">PE</th>
                        <th class="p-3 text-center" data-sort="pp">PP</th>
                        <th class="p-3 text-center" data-sort="pj">PJ</th>
                        <th class="p-3 text-center" data-sort="efectividad">Efectividad</th>
                        <th class="p-3 text-center" data-sort="chamigos">Chamigo</th>
                        <th class="p-3 text-center" data-sort="tt">TT</th>
                        <th class="p-3 text-center" data-sort="ausentes">Ausentismo</th>
                    </tr>
                </thead>
                <tbody>
                    ${rankedPlayers.map((player, index) => `
                    <tr>
                        <td class="p-2 text-center sticky-col sticky-col-1">${index + 1}</td>
                        <td class="p-3 text-center sticky-col sticky-col-2">${player.name}</td>
                        <td class="p-3 text-center">${player.points}</td><td class="p-3 text-center">${player.pg}</td><td class="p-3 text-center">${player.pe}</td>
                        <td class="p-3 text-center">${player.pp}</td><td class="p-3 text-center">${player.pj}</td><td class="p-3 text-center">${player.efectividad}%</td>
                        <td class="p-3 text-center">${player.chamigos}</td><td class="p-3 text-center">${player.tt}</td><td class="p-3 text-center">${player.ausentes}</td>
                    </tr>`).join('')}
                </tbody>`;

            loadingMessage.classList.add('hidden');
            table.classList.remove('hidden');
            
            const activeTh = table.querySelector(`thead th[data-sort="${sortCriterion}"]`);
            if (activeTh) {
                const icon = document.createElement('i');
                icon.className = `fas fa-chevron-${sortOrder === 'desc' ? 'down' : 'up'} ml-2`;
                activeTh.appendChild(icon);
            }
        }

        async function renderEquipos() {
            const statsDisplay = document.getElementById('equipos-stats-display');
            const loadingMessage = document.getElementById('equipos-loading-message');
            if (!statsDisplay || !loadingMessage) return;

            statsDisplay.classList.add('hidden');
            loadingMessage.classList.remove('hidden');

            const { teamStats, error } = await fetchAndCalculateStatsForPeriod('equipos-year-select', 'equipos-period-select');

            if (error) { loadingMessage.innerHTML = 'Error al cargar los datos.'; return; }
            
            const statCard = (value, label, bgColor, textColor = 'var(--button-text-color)') => `
                <div class="p-4 rounded-lg shadow-md flex flex-col items-center justify-center w-full min-h-[120px]" style="background-color: ${bgColor}; color: ${textColor};">
                    <span class="text-3xl font-bold">${value}</span><span class="text-sm uppercase mt-1 font-semibold">${label}</span>
                </div>`;
            
            const clarosBgColor = '#E2E8F0';
            const clarosTextColor = '#1A202C';
            const empatesBgColor = 'var(--warning-color)';

            statsDisplay.innerHTML = 
                statCard(teamStats.oscurosWins, 'Oscuros Ganados', 'var(--sidebar-bg)') +
                statCard(teamStats.clarosWins, 'Claros Ganados', clarosBgColor, clarosTextColor) +
                statCard(teamStats.empates, 'Empates', empatesBgColor) +
                statCard(teamStats.suspendidos, 'Suspendidos', 'var(--danger-color)') +
                statCard(teamStats.totalPJMatches, 'Partidos Jugados', 'var(--accent-color)');

            loadingMessage.classList.add('hidden');
            statsDisplay.classList.remove('hidden');
        }
        
        async function renderFixture(isFilterChange = false) {
            const cardsContainer = document.getElementById('fixture-matches-cards-container');
            const loadingMessage = document.getElementById('fixture-loading-message');
            const year = document.getElementById('fixture-year-select').value;
            const month = document.getElementById('fixture-month-select').value;
            if (!cardsContainer || !loadingMessage) return;

            cardsContainer.innerHTML = '';
            loadingMessage.classList.remove('hidden');

            let query = supabaseClient.from('matches').select('*');
            
            if (year && year !== 'all') {
                if (month && month !== 'all') {
                    const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                    const endDate = new Date(year, month, 0).getDate();
                    query = query.gte('match_date', startDate).lte('match_date', `${year}-${String(month).padStart(2, '0')}-${endDate}`);
                } else {
                    query = query.gte('match_date', `${year}-01-01`).lte('match_date', `${year}-12-31`);
                }
            }

            const { data: filteredMatches, error } = await query;

            if (error) { loadingMessage.innerHTML = `Error al cargar partidos.`; return; }
            if (!filteredMatches || filteredMatches.length === 0) { loadingMessage.innerHTML = `No hay partidos disponibles.`; lastSelectedFixtureMatchId = null; return; }

            filteredMatches.sort((a, b) => new Date(b.match_date) - new Date(a.match_date));
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let currentOrFutureMatchFound = false;

            cardsContainer.innerHTML = filteredMatches.map(match => {
                const matchDateObj = parseDate(match.match_date);
                let isCurrent = !currentOrFutureMatchFound && matchDateObj.getTime() >= today.getTime();
                if(isCurrent) currentOrFutureMatchFound = true;

                return `
                    <div class="fixture-match-item p-2 rounded-lg shadow-sm cursor-pointer transition flex justify-center items-center text-center text-sm font-semibold sm:p-4 sm:shadow-md ${isCurrent ? 'current-match-card' : ''}" data-match-id="${match.id}">
                        ${isCurrent ? 'PARTIDO ACTUAL' : `Partido del ${matchDateObj.toLocaleDateString('es-AR', {timeZone: 'UTC'})}`}
                    </div>`;
            }).join('');

            cardsContainer.querySelectorAll('.fixture-match-item').forEach(card => card.addEventListener('click', (e) => {
                cardsContainer.querySelectorAll('.fixture-match-item').forEach(c => c.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                renderFixtureDetails(e.currentTarget.dataset.matchId, true);
            }));

            loadingMessage.classList.add('hidden');

            if (!isFilterChange) {
                setTimeout(() => {
                    const currentMatchCard = document.querySelector('.current-match-card');
                    const firstCard = cardsContainer.querySelector('[data-match-id]');
                    if (currentMatchCard) {
                        currentMatchCard.classList.add('selected');
                        renderFixtureDetails(currentMatchCard.dataset.matchId, false);
                    } else if (firstCard) {
                        firstCard.classList.add('selected');
                        renderFixtureDetails(firstCard.dataset.matchId, false);
                    }
                }, 100);
            }
        }

        async function renderFixtureDetails(matchId, fromUserClick = false) {
            const { data: match, error } = await supabaseClient.from('matches').select('*').eq('id', matchId).single();
            if (error || !match) { console.error("Error fetching match details:", error); return; }
            
            lastSelectedFixtureMatchId = matchId;
            
            const visualDetailsContainer = document.getElementById('fixture-visual-details-container');
            const soccerFieldContainer = document.getElementById('soccer-field-container');
            const ttAttendeesTableBody = document.querySelector('#tt-attendees-table tbody');
            const collapsibleContent = document.getElementById('fixture-filters-collapsible');
            const filterToggle = document.getElementById('fixture-filter-toggle');
            if (!visualDetailsContainer || !soccerFieldContainer || !ttAttendeesTableBody) return;
            
            soccerFieldContainer.innerHTML = `
                <div class="goal-area top"></div><div class="goal-area bottom"></div>
                <div class="penalty-area top"></div><div class="penalty-area bottom"></div>`;
            ttAttendeesTableBody.innerHTML = '';

            const { team_white_players, team_dark_players, result, chamigo_votes, tt_attendees } = match;
            const getPlayerName = id => (allPlayersData.find(p => p.id === id) || {name: 'ID Desconocido'}).name;
            
            ttAttendeesTableBody.innerHTML = (Array.isArray(tt_attendees) && tt_attendees.length > 0)
                ? tt_attendees.map(id => `<tr><td class="p-2 text-center">${getPlayerName(id)}</td></tr>`).join('')
                : `<tr><td class="p-2 text-center">No hay asistentes al TT.</td></tr>`;

            const isHorizontalField = window.innerWidth >= 768;
            soccerFieldContainer.classList.toggle('horizontal-layout', isHorizontalField);
            soccerFieldContainer.querySelectorAll('.goal-area, .penalty-area').forEach(el => el.classList.toggle('horizontal-layout', isHorizontalField));

            const pos = {
                v: {
                    claros: [{ x: 0.5, y: 0.92 }, { x: 0.25, y: 0.75 }, { x: 0.75, y: 0.75 }, { x: 0.35, y: 0.60 }, { x: 0.65, y: 0.60 }],
                    oscuros: [{ x: 0.5, y: 0.08 }, { x: 0.25, y: 0.25 }, { x: 0.75, y: 0.25 }, { x: 0.35, y: 0.40 }, { x: 0.65, y: 0.40 }]
                },
                h: {
                    claros: [{ x: 0.95, y: 0.50 }, { x: 0.75, y: 0.25 }, { x: 0.75, y: 0.75 }, { x: 0.60, y: 0.35 }, { x: 0.60, y: 0.65 }],
                    oscuros: [{ x: 0.05, y: 0.50 }, { x: 0.25, y: 0.25 }, { x: 0.25, y: 0.75 }, { x: 0.40, y: 0.35 }, { x: 0.40, y: 0.65 }]
                }
            };
            const currentPos = isHorizontalField ? pos.h : pos.v;
            
            let chamigosIds = [];
            if (chamigo_votes && Object.keys(chamigo_votes).length > 0) {
                const votosArray = Object.entries(chamigo_votes).map(([id, votos]) => ({ id, votos }));
                if (votosArray.length > 0) {
                    const maxVotes = Math.max(...votosArray.map(v => v.votos));
                    chamigosIds = votosArray.filter(v => v.votos === maxVotes).map(c => c.id);
                }
            }

            const createPlayerMarker = (playerId, team, index) => {
                const playerWrapper = document.createElement('div');
                playerWrapper.className = `player-wrapper absolute transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-1 z-10`;
                playerWrapper.style.top = `${currentPos[team][index].y * 100}%`;
                playerWrapper.style.left = `${currentPos[team][index].x * 100}%`;
                
                let markerHTML = `<div class="player-marker ${team} relative w-12 h-12 rounded-full flex items-center justify-center text-base font-bold text-center">
                    ${parseInt(playerId.replace('J', ''))}`;
                if (chamigosIds.includes(playerId)) {
                    markerHTML += `<i class="fas fa-star text-yellow-400 absolute -top-2.5 -right-1 text-lg"></i>`;
                }
                markerHTML += `</div><div class="player-name-label text-xs font-bold px-2 py-0.5 rounded-md">${getPlayerName(playerId)}</div>`;
                playerWrapper.innerHTML = markerHTML;
                soccerFieldContainer.appendChild(playerWrapper);
            };

            (team_white_players || []).slice(0, 5).forEach((id, i) => createPlayerMarker(id, 'claros', i));
            (team_dark_players || []).slice(0, 5).forEach((id, i) => createPlayerMarker(id, 'oscuros', i));
            
            if (result && result !== 'Empate' && result !== 'Suspendido') {
                 const trophyDiv = document.createElement('div');
                 trophyDiv.className = 'winner-trophy absolute text-2xl z-20 transform -translate-x-1/2 -translate-y-1/2';
                 trophyDiv.innerHTML = '<i class="fas fa-trophy"></i>';
                 const trophyPos = {
                     h: { Claros: { top: '95%', left: '95%'}, Oscuros: { top: '95%', left: '5%'} },
                     v: { Claros: { top: '95%', left: '95%'}, Oscuros: { top: '95%', left: '5%'} }
                 };
                 Object.assign(trophyDiv.style, (isHorizontalField ? trophyPos.h : trophyPos.v)[result]);
                 soccerFieldContainer.appendChild(trophyDiv);
            }
            
            visualDetailsContainer.classList.remove('hidden');
            if (collapsibleContent && fromUserClick) {
                collapsibleContent.classList.add('hidden');
                filterToggle.classList.remove('visible-content');
                filterToggle.querySelector('.toggle-icon')?.classList.remove('fa-chevron-up');
            }
        }
        
        async function renderIndividualStatsTable() {
            const selectedPlayerId = document.getElementById('selected-player-id').value;
            const table = document.getElementById('individual-stats-table');
            const loadingMessage = document.getElementById('individual-stats-loading-message');
            if (!table || !loadingMessage) return;
            
            table.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            
            if(!selectedPlayerId) {
                loadingMessage.textContent = 'Selecciona un jugador para ver sus estadísticas.';
                return;
            }

            const { data: matches, error } = await supabaseClient.from('matches').select('*').or(`team_white_players.cs.{${selectedPlayerId}},team_dark_players.cs.{${selectedPlayerId}}`);

            if(error) { loadingMessage.textContent = 'Error al cargar el historial del jugador.'; return; }
            if (!matches || matches.length === 0) { loadingMessage.textContent = 'Este jugador no tiene partidos registrados.'; return; }

            const playerStats = calculateIndividualPlayerStats(selectedPlayerId, matches);

            if (!playerStats) { loadingMessage.textContent = 'No se pudieron calcular las estadísticas.'; return; }
            
            let tableHtml = `
                <thead>
                    <tr>
                        <th class="p-3 text-left pl-4 sticky-col sticky-col-1">Año</th>
                        <th class="p-3 text-center sticky-col sticky-col-2">Torneo</th>
                        <th class="p-3 text-center">Puntos</th><th class="p-3 text-center">PG</th><th class="p-3 text-center">PE</th>
                        <th class="p-3 text-center">PP</th><th class="p-3 text-center">PJ</th><th class="p-3 text-center">Efectividad</th>
                        <th class="p-3 text-center">Chamigo</th><th class="p-3 text-center">TT</th><th class="p-3 text-center">Ausentismo</th>
                    </tr>
                </thead>
                <tbody>`;

            tableHtml += `
                <tr class="font-bold" style="background-color: var(--accent-color); color: var(--button-text-color);">
                    <td class="p-3 text-left pl-4 sticky-col sticky-col-1"><b>TOTAL</b></td>
                    <td class="p-3 text-center sticky-col sticky-col-2"></td>
                    <td class="p-3 text-center">${playerStats.overallTotal.points}</td><td class="p-3 text-center">${playerStats.overallTotal.pg}</td>
                    <td class="p-3 text-center">${playerStats.overallTotal.pe}</td><td class="p-3 text-center">${playerStats.overallTotal.pp}</td>
                    <td class="p-3 text-center">${playerStats.overallTotal.pj}</td><td class="p-3 text-center">${playerStats.overallTotal.efectividad}%</td>
                    <td class="p-3 text-center">${playerStats.overallTotal.chamigos}</td><td class="p-3 text-center">${playerStats.overallTotal.tt}</td>
                    <td class="p-3 text-center">${playerStats.overallTotal.ausentes}</td>
                </tr>`;

            Object.keys(playerStats.years).sort((a,b) => b-a).forEach(year => {
                const yearData = playerStats.years[year];
                if(yearData.total.pj > 0) {
                    tableHtml += `
                        <tr class="font-semibold cursor-pointer" style="background-color: var(--bg-muted);" data-year="${year}">
                            <td class="p-3 text-left pl-4 sticky-col sticky-col-1"><i class="fas fa-plus-circle toggle-details mr-2 text-accent-color"></i><b>${year}</b></td>
                            <td class="p-3 text-center sticky-col sticky-col-2"><b>TOTAL AÑO</b></td>
                            <td class="p-3 text-center">${yearData.total.points}</td><td class="p-3 text-center">${yearData.total.pg}</td>
                            <td class="p-3 text-center">${yearData.total.pe}</td><td class="p-3 text-center">${yearData.total.pp}</td>
                            <td class="p-3 text-center">${yearData.total.pj}</td><td class="p-3 text-center">${yearData.total.efectividad}%</td>
                            <td class="p-3 text-center">${yearData.total.chamigos}</td><td class="p-3 text-center">${yearData.total.tt}</td>
                            <td class="p-3 text-center">${yearData.total.ausentes}</td>
                        </tr>
                        <tr class="period-details-row hidden" data-year-parent="${year}">
                            <td class="p-3 text-left pl-12 sticky-col sticky-col-1"></td><td class="p-3 text-center sticky-col sticky-col-2">Clausura</td>
                            <td class="p-3 text-center">${yearData.clausura.points}</td><td class="p-3 text-center">${yearData.clausura.pg}</td>
                            <td class="p-3 text-center">${yearData.clausura.pe}</td><td class="p-3 text-center">${yearData.clausura.pp}</td>
                            <td class="p-3 text-center">${yearData.clausura.pj}</td><td class="p-3 text-center">${yearData.clausura.efectividad}%</td>
                            <td class="p-3 text-center">${yearData.clausura.chamigos}</td><td class="p-3 text-center">${yearData.clausura.tt}</td>
                            <td class="p-3 text-center">${yearData.clausura.ausentes}</td>
                        </tr>
                        <tr class="period-details-row hidden" data-year-parent="${year}">
                            <td class="p-3 text-left pl-12 sticky-col sticky-col-1"></td><td class="p-3 text-center sticky-col sticky-col-2">Apertura</td>
                            <td class="p-3 text-center">${yearData.apertura.points}</td><td class="p-3 text-center">${yearData.apertura.pg}</td>
                            <td class="p-3 text-center">${yearData.apertura.pe}</td><td class="p-3 text-center">${yearData.apertura.pp}</td>
                            <td class="p-3 text-center">${yearData.apertura.pj}</td><td class="p-3 text-center">${yearData.apertura.efectividad}%</td>
                            <td class="p-3 text-center">${yearData.apertura.chamigos}</td><td class="p-3 text-center">${yearData.apertura.tt}</td>
                            <td class="p-3 text-center">${yearData.apertura.ausentes}</td>
                        </tr>`;
                }
            });
            
            table.innerHTML = tableHtml + '</tbody>';
            loadingMessage.classList.add('hidden');
            table.classList.remove('hidden');
            
            table.querySelectorAll('[data-year]').forEach(row => {
                row.addEventListener('click', (e) => {
                    const year = row.dataset.year;
                    const toggleIcon = row.querySelector('.toggle-details');
                    document.querySelectorAll(`.period-details-row[data-year-parent="${year}"]`).forEach(r => r.classList.toggle('hidden'));
                    toggleIcon?.classList.toggle('fa-plus-circle');
                    toggleIcon?.classList.toggle('fa-minus-circle');
                });
            });
        }

        function calculateIndividualPlayerStats(playerId, matches) {
            const playerStats = { years: {}, overallTotal: { name: 'TOTAL', points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: "0.00", chamigos: 0, tt: 0, ausentes: 0 }};
            const allYearsInMatches = [...new Set(matches.map(m => m.match_date ? parseDate(m.match_date).getFullYear() : null).filter(Boolean))];

            allYearsInMatches.forEach(year => {
                playerStats.years[year] = {
                    apertura: { name: 'Apertura', points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: "0.00", chamigos: 0, tt: 0, ausentes: 0 },
                    clausura: { name: 'Clausura', points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: "0.00", chamigos: 0, tt: 0, ausentes: 0 },
                    total: { name: year, points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: "0.00", chamigos: 0, tt: 0, ausentes: 0 }
                };
            });
            
            matches.forEach(match => {
                 const { match_date, team_white_players, team_dark_players, result, chamigo_votes, tt_attendees } = match;
                 if (!match_date) return;

                 const matchDate = parseDate(match_date);
                 const year = matchDate.getFullYear();
                 const period = matchDate.getMonth() <= 5 ? 'apertura' : 'clausura';

                 if (!playerStats.years[year]) return;
                 
                 const playerIsInMatch = (team_white_players || []).includes(playerId) || (team_dark_players || []).includes(playerId);
                 if (!playerIsInMatch) return;

                 const statsToUpdate = [playerStats.years[year][period], playerStats.years[year].total, playerStats.overallTotal];
                 
                 if (result !== 'Suspendido') {
                     statsToUpdate.forEach(s => s.pj++);
                     if (result === 'Claros' && (team_white_players || []).includes(playerId)) statsToUpdate.forEach(s => { s.points += 3; s.pg++; });
                     else if (result === 'Oscuros' && (team_dark_players || []).includes(playerId)) statsToUpdate.forEach(s => { s.points += 3; s.pg++; });
                     else if (result === 'Empate') statsToUpdate.forEach(s => { s.points += 1; s.pe++; });
                     else statsToUpdate.forEach(s => s.pp++);
                 }

                 if (chamigo_votes) {
                     const votosArray = Object.entries(chamigo_votes).map(([id, votos]) => ({ id, votos }));
                     if (votosArray.length > 0) {
                         const maxVotes = Math.max(...votosArray.map(v => v.votos));
                         if (votosArray.some(v => v.id === playerId && v.votos === maxVotes)) {
                             statsToUpdate.forEach(s => s.chamigos++);
                         }
                     }
                 }
                 if (tt_attendees && tt_attendees.includes(playerId)) {
                     statsToUpdate.forEach(s => s.tt++);
                 }
            });

            allYearsInMatches.forEach(year => {
                const yearData = playerStats.years[year];
                ['apertura', 'clausura', 'total'].forEach(periodType => {
                    const stats = yearData[periodType];
                    const totalMatchesInPeriod = matches.filter(m => {
                        if (!m.match_date) return false;
                        const d = parseDate(m.match_date);
                        const p = d.getMonth() <= 5 ? 'apertura' : 'clausura';
                        const y = d.getFullYear();
                        if (periodType === 'total') return y === year && m.result !== 'Suspendido';
                        return y === year && p === periodType && m.result !== 'Suspendido';
                    }).length;

                    const maxPoints = stats.pj * 3;
                    stats.efectividad = maxPoints > 0 ? ((stats.points / maxPoints) * 100).toFixed(2) : "0.00";
                    stats.ausentes = Math.max(0, totalMatchesInPeriod - stats.pj);
                });
            });

            const totalNonSuspendedMatches = matches.filter(m => m.result !== 'Suspendido').length;
            const overall = playerStats.overallTotal;
            const maxTotalPoints = overall.pj * 3;
            overall.efectividad = maxTotalPoints > 0 ? ((overall.points / maxTotalPoints) * 100).toFixed(2) : "0.00";
            overall.ausentes = Math.max(0, totalNonSuspendedMatches - overall.pj);

            return playerStats;
        }

        function setupPlayerSearch() {
            const searchInput = document.getElementById('individual-player-search');
            const resultsDiv = document.getElementById('individual-player-results');
            const selectedIdInput = document.getElementById('selected-player-id');
            const clearButton = document.getElementById('clear-player-search');
            if(!searchInput || !resultsDiv || !selectedIdInput || !clearButton) return;

            const filterAndDisplay = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filtered = allPlayersData.filter(p => p.name.toLowerCase().includes(searchTerm)).sort((a, b) => a.name.localeCompare(b.name));
                resultsDiv.innerHTML = filtered.map(player => `<div class="p-2 cursor-pointer" data-player-id="${player.id}">${player.name}</div>`).join('');
                resultsDiv.classList.remove('hidden');
            };

            resultsDiv.addEventListener('mousedown', (e) => {
                if (e.target.dataset.playerId) {
                    const player = allPlayersData.find(p => p.id === e.target.dataset.playerId);
                    searchInput.value = player.name;
                    selectedIdInput.value = player.id;
                    resultsDiv.classList.add('hidden');
                    renderIndividualStatsTable();
                }
            });

            searchInput.addEventListener('input', filterAndDisplay);
            searchInput.addEventListener('focus', filterAndDisplay);
            searchInput.addEventListener('blur', () => setTimeout(() => resultsDiv.classList.add('hidden'), 150));

            clearButton.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                searchInput.value = '';
                selectedIdInput.value = '';
                document.getElementById('individual-stats-table').innerHTML = '';
                document.getElementById('individual-stats-loading-message').textContent = 'Selecciona un jugador para ver sus estadísticas.';
                searchInput.focus();
                filterAndDisplay(); // Show all players again
            });
            
            if(allPlayersData.length > 0) {
                const defaultPlayer = allPlayersData.find(p => p.id === 'J001') || allPlayersData[0];
                if (defaultPlayer) {
                    searchInput.value = defaultPlayer.name;
                    selectedIdInput.value = defaultPlayer.id;
                }
            }
        }
        
        // --- FLUJO PRINCIPAL Y NAVEGACIÓN ---
        
        function getTabContentHTML(tabId) {
            const titles = {
                'leaderboard-content': 'Tabla de Posiciones', 'chamigo-content': 'Chamigo', 'tt-content': 'Tercer Tiempo (TT)',
                'presentismo-content': 'Presentismo', 'ausentismo-content': 'Ausentismo', 'estadisticas-content': 'Estadísticas',
                'equipos-content': 'Equipos', 'fixture-content': 'Fixture', 'individual-stats-content': 'Histórico'
            };
            const title = titles[tabId] || 'Contenido';
            
            let baseHtml = `<div id="${tabId}" class="main-content-container space-y-6">
                <h2 class="tab-title text-2xl font-bold tracking-tight uppercase text-center">${title}</h2>`;
            
            const prefix = tabId.replace('-content', '');
            
            if (['leaderboard', 'chamigo', 'tt', 'presentismo', 'ausentismo', 'equipos', 'estadisticas'].includes(prefix)) {
                 baseHtml += `
                    <div id="${prefix}-filter-toggle" class="collapsible-toggle-button p-3 rounded-md cursor-pointer flex items-center justify-between font-semibold">
                        <span>Seleccionar Torneo</span><i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div id="${prefix}-filters-collapsible" class="grid grid-cols-2 md:grid-cols-[1fr_2fr_2fr] gap-4 hidden items-end">
                        <button id="${prefix}-hoy-button" class="button-primary col-span-2 md:col-auto px-6 py-2 rounded-md shadow-sm">Torneo Actual</button>
                        <div><label for="${prefix}-year-select" class="block text-sm font-medium mb-1">Año:</label><select id="${prefix}-year-select" class="mt-1 block w-full p-2 text-sm shadow-sm"></select></div>
                        <div><label for="${prefix}-period-select" class="block text-sm font-medium mb-1">Torneo:</label><select id="${prefix}-period-select" class="mt-1 block w-full p-2 text-sm shadow-sm"><option value="apertura">Apertura</option><option value="clausura">Clausura</option><option value="total">Totales</option></select></div>
                    </div>`;
            }
            
            switch(tabId) {
                case 'leaderboard-content': case 'chamigo-content': case 'tt-content': case 'presentismo-content': case 'ausentismo-content':
                    baseHtml += `<div class="table-container">
                                    <p id="${prefix}-loading-message" class="loading-message p-4 flex items-center justify-center gap-2"><span class="loading-spinner"></span>Cargando...</p>
                                    <table id="${prefix}-table" class="hidden"></table>
                                 </div>`;
                    break;
                case 'estadisticas-content':
                     baseHtml += `
                        <div class="table-container overflow-x-auto">
                            <p id="estadisticas-loading-message" class="loading-message p-4 flex items-center justify-center gap-2"><span class="loading-spinner"></span>Cargando...</p>
                            <table id="estadisticas-table" class="hidden"></table>
                        </div>`;
                    break;
                case 'equipos-content':
                    baseHtml += `<p id="equipos-loading-message" class="loading-message p-4 flex items-center justify-center gap-2"><span class="loading-spinner"></span>Cargando...</p>
                                 <div id="equipos-stats-display" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>`;
                    break;
                case 'fixture-content':
                     baseHtml += `
                        <div id="fixture-filter-toggle" class="collapsible-toggle-button p-3 rounded-md cursor-pointer flex items-center justify-between font-semibold">
                            <span>Elegir otro partido</span><i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                        <div id="fixture-filters-collapsible" class="hidden space-y-4 pt-4">
                            <div class="grid grid-cols-2 md:grid-cols-[1fr_2fr_2fr] gap-4 items-end">
                                <button id="fixture-hoy-button" class="button-primary col-span-2 md:col-auto px-6 py-2 rounded-md shadow-sm">Torneo Actual</button>
                                <div><label for="fixture-year-select" class="block text-sm font-medium mb-1">Año:</label><select id="fixture-year-select" class="mt-1 block w-full p-2 text-sm shadow-sm"></select></div>
                                <div><label for="fixture-month-select" class="block text-sm font-medium mb-1">Mes:</label><select id="fixture-month-select" class="mt-1 block w-full p-2 text-sm shadow-sm"></select></div>
                            </div>
                            <p id="fixture-loading-message" class="loading-message p-4 flex items-center justify-center gap-2"><span class="loading-spinner"></span>Cargando partidos...</p>
                            <h3 class="text-xl font-semibold mb-2">Partidos del Mes</h3>
                            <div id="fixture-matches-cards-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2"></div>
                        </div>
                        <div id="fixture-visual-details-container" class="flex flex-col md:flex-row md:space-x-6 mt-6 hidden">
                            <div class="md:w-[65%] min-w-0"><div id="soccer-field-container" class="rounded-lg overflow-hidden"></div></div>
                            <div id="fixture-details-display" class="flex-1 md:w-[35%] p-4 rounded-lg mt-6 md:mt-0">
                                <h3 class="font-semibold text-center mb-2">Asistentes al TT</h3>
                                <div class="overflow-x-auto"><table id="tt-attendees-table" class="w-full"><tbody></tbody></table></div>
                            </div>
                        </div>`;
                    break;
                case 'individual-stats-content':
                    baseHtml += `
                        <div class="mb-6">
                            <label for="individual-player-search" class="block text-sm font-medium mb-1">Buscar Jugador:</label>
                            <div class="relative">
                                <input type="text" id="individual-player-search" placeholder="Escribe para buscar..." class="mt-1 block w-full p-2 shadow-sm">
                                <button id="clear-player-search" class="absolute inset-y-0 right-0 pr-3 flex items-center focus:outline-none"><i class="fas fa-times-circle"></i></button>
                                <div id="individual-player-results" class="absolute z-10 w-full rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
                            </div>
                            <input type="hidden" id="selected-player-id">
                        </div>
                        <div class="table-container overflow-x-auto">
                            <p id="individual-stats-loading-message" class="loading-message p-4 flex items-center justify-center gap-2"><span class="loading-spinner"></span>Cargando...</p>
                            <table id="individual-stats-table" class="hidden"></table>
                        </div>`;
                    break;
            }
            
            baseHtml += `</div>`;
            return baseHtml;
        }

        function activateTab(tabId) {
            const filtersBeforeRender = saveFiltersState();
            DOMElements.mainContentArea.innerHTML = getTabContentHTML(tabId);
            restoreFiltersState(filtersBeforeRender);
            
            DOMElements.tabButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabId);
            });
            
            const renderFunctions = {
                'leaderboard-content': renderLeaderboard, 'chamigo-content': renderChamigo, 'tt-content': renderTT,
                'presentismo-content': renderPresentismo, 'ausentismo-content': renderAusentismo, 'estadisticas-content': renderEstadisticas,
                'equipos-content': renderEquipos, 'fixture-content': renderFixture, 'individual-stats-content': renderIndividualStatsTable
            };

            setupDynamicEventListeners(tabId);
            
            if (renderFunctions[tabId]) {
                renderFunctions[tabId]();
            }
            
            localStorage.setItem('lastActiveTab', tabId);
            const hash = Object.keys(hashToTabMap).find(key => hashToTabMap[key] === tabId);
            if (hash && window.location.hash !== hash) {
                history.pushState(null, '', hash);
            }
        }
        
        function saveFiltersState() {
            const activeFilters = DOMElements.mainContentArea.querySelectorAll('select, input');
            const state = {};
            activeFilters.forEach(el => {
                if (el.id) {
                    state[el.id] = el.value;
                }
            });
            return state;
        }

        function restoreFiltersState(state) {
            Object.keys(state).forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = state[id];
                }
            });
        }

        function setupDynamicEventListeners(tabId) {
            const prefix = tabId.replace('-content', '');
            const renderFn = renderFunctions[tabId];

            const filterToggle = document.getElementById(`${prefix}-filter-toggle`);
            const filtersCollapsible = document.getElementById(`${prefix}-filters-collapsible`);
            
            if(filterToggle && filtersCollapsible) {
                filterToggle.addEventListener('click', () => {
                    filtersCollapsible.classList.toggle('hidden');
                    filterToggle.classList.toggle('visible-content');
                    filterToggle.querySelector('.toggle-icon')?.classList.toggle('fa-chevron-up');
                });
            }

            if (renderFn && !tabId.startsWith('fixture') && !tabId.startsWith('estadisticas')) {
                document.getElementById(`${prefix}-hoy-button`)?.addEventListener('click', () => { setTodayFilters(prefix); renderFn(); });
                document.getElementById(`${prefix}-year-select`)?.addEventListener('change', renderFn);
                document.getElementById(`${prefix}-period-select`)?.addEventListener('change', renderFn);
            }
            if (tabId === 'estadisticas-content') {
                 const resetAndRender = () => { currentEstadisticasData = []; renderEstadisticas(); };
                 document.getElementById('estadisticas-hoy-button')?.addEventListener('click', () => { setTodayFilters('estadisticas'); resetAndRender(); });
                 document.getElementById('estadisticas-year-select')?.addEventListener('change', resetAndRender);
                 document.getElementById('estadisticas-period-select')?.addEventListener('change', resetAndRender);

                 const table = document.getElementById('estadisticas-table');
                 table?.addEventListener('click', (e) => {
                     const th = e.target.closest('th[data-sort]');
                     if (!th) return;
                     const newCriterion = th.dataset.sort;
                     if (estadisticasSortState.criterion === newCriterion) {
                         estadisticasSortState.order = estadisticasSortState.order === 'desc' ? 'asc' : 'desc';
                     } else {
                         estadisticasSortState.criterion = newCriterion;
                         estadisticasSortState.order = 'desc';
                     }
                     renderEstadisticas(true); // Re-render from cache
                 });
            }
            if (tabId === 'fixture-content') {
                populateYearSelects('fixture-year-select');
                populateMonthSelects('fixture-month-select');
                // CORRECCIÓN 1: Se llama a setTodayFilters sin condiciones
                setTodayFilters('fixture', true);
                document.getElementById('fixture-hoy-button')?.addEventListener('click', () => { setTodayFilters('fixture', true); renderFixture(true); });
                document.getElementById('fixture-year-select')?.addEventListener('change', () => renderFixture(true));
                document.getElementById('fixture-month-select')?.addEventListener('change', () => renderFixture(true));
            }
            if (tabId === 'individual-stats-content') {
                setupPlayerSearch();
            }
            if (tabId.includes('content') && !tabId.includes('fixture') && !tabId.includes('individual')) {
                populateAndSetCurrentPeriod(`${prefix}-year-select`, `${prefix}-period-select`);
            }
        }
        
        const renderFunctions = {
            'leaderboard-content': renderLeaderboard, 'chamigo-content': renderChamigo, 'tt-content': renderTT,
            'presentismo-content': renderPresentismo, 'ausentismo-content': renderAusentismo, 'estadisticas-content': renderEstadisticas,
            'equipos-content': renderEquipos, 'fixture-content': renderFixture, 'individual-stats-content': renderIndividualStatsTable
        };

        async function initializeApp() {
            try {
                const { data: players, error: pError } = await supabaseClient.from('players').select('*');
                const { data: matches, error: mError } = await supabaseClient.from('matches').select('match_date');

                if (pError || mError) throw pError || mError;
                
                allPlayersData = players;
                allMatchDates = matches;

                const hash = window.location.hash;
                const storedTabId = localStorage.getItem('lastActiveTab');
                let initialTabId = 'leaderboard-content';

                if (hash && hashToTabMap[hash]) {
                    initialTabId = hashToTabMap[hash];
                } else if (storedTabId && document.querySelector(`.tab-button[data-tab="${storedTabId}"]`)) {
                    initialTabId = storedTabId;
                }
                
                activateTab(initialTabId);

            } catch (error) {
                console.error("Error fatal durante la inicialización:", error);
                DOMElements.mainContentArea.innerHTML = `<div class="main-content-container text-center text-red-500"><p>Error al cargar datos: ${error.message}</p></div>`;
            }
        }

        function init() {
            console.log('Aplicación LA CLANDE cargada y corregida!');
            
            applyTheme(localStorage.getItem('theme') || 'light');
            
            DOMElements.darkModeToggle.addEventListener('click', toggleTheme);
            DOMElements.hamburgerButton.addEventListener('click', toggleSideMenu);
            DOMElements.overlay.addEventListener('click', toggleSideMenu);
            window.addEventListener('resize', applyInitialResponsiveStyles);
            DOMElements.tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    activateTab(e.currentTarget.dataset.tab);
                    if (window.innerWidth < 768) toggleSideMenu();
                });
            });
            window.addEventListener('hashchange', () => {
                const tabId = hashToTabMap[window.location.hash] || 'leaderboard-content';
                activateTab(tabId);
            });

            initializeApp();
        }

        init();
    });
    </script>
</body>
</html>
