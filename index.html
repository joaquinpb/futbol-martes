<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fútbol 5 - Estadísticas y Partidos</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter para una mejor legibilidad */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Un gris claro para el fondo */
        }
        /* Estilos base para tablas */
        table {
            @apply min-w-full bg-white rounded-lg shadow-md;
        }
        th, td {
            @apply py-3 px-6 text-left;
        }
        thead th {
            @apply bg-gray-200 text-gray-700 uppercase text-sm leading-normal;
        }
        tbody tr {
            @apply border-b border-gray-200 hover:bg-gray-100;
        }
        tbody tr:last-child {
            @apply border-b-0;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-6xl my-8">
        <h1 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">Fútbol 5 - Estadísticas</h1>

        <!-- Sección de Jugadores -->
        <section class="mb-10">
            <h2 class="text-3xl font-semibold text-gray-700 mb-6 border-l-4 border-blue-500 pl-4">Jugadores</h2>
            <div id="players-list-container" class="overflow-x-auto">
                <p id="players-loading" class="text-gray-500 text-center py-4">Cargando jugadores...</p>
                <table id="players-table" class="hidden">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Estado</th>
                            <th class="text-center">Puntos Totales</th>
                            <th class="text-center">Partidos Jugados</th>
                            <th class="text-center">Chamigos Ganados</th>
                            <th class="text-center">Asistencias TT</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los jugadores se cargarán aquí dinámicamente -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Sección de Partidos -->
        <section class="mb-10">
            <h2 class="text-3xl font-semibold text-gray-700 mb-6 border-l-4 border-purple-500 pl-4">Partidos</h2>
            <div id="matches-list-container" class="overflow-x-auto">
                <p id="matches-loading" class="text-gray-500 text-center py-4">Cargando partidos...</p>
                <table id="matches-table" class="hidden">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Equipo Claros</th>
                            <th>Equipo Oscuros</th>
                            <th class="text-center">Resultado</th>
                            <th class="text-center">Chamigo Votos</th>
                            <th class="text-center">Asistencia TT</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los partidos se cargarán aquí dinámicamente -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Sección de Pagos (Resumen) -->
        <section>
            <h2 class="text-3xl font-semibold text-gray-700 mb-6 border-l-4 border-yellow-500 pl-4">Resumen de Pagos</h2>
            <div id="payments-summary" class="bg-yellow-50 p-6 rounded-lg shadow-md">
                <p class="text-xl font-medium text-gray-900 mb-2">Total recaudado: <span id="total-recaudado" class="font-bold text-green-700">$0</span></p>
                <p class="text-xl font-medium text-gray-900">Pagos pendientes: <span id="pagos-pendientes" class="font-bold text-red-700">$0</span></p>
                <p class="text-sm text-gray-600 mt-4">Nota: Este resumen es solo ilustrativo. Para la gestión completa de pagos, utiliza el panel de administración.</p>
            </div>
        </section>
    </div>

    <!-- Script de la API de Google -->
    <script async defer src="https://apis.google.com/js/api.js"></script>

    <script>
        // ¡IMPORTANTE! Reemplaza 'TU_ID_DE_HOJA_DE_CALCULO' con el ID de tu Google Sheet
        const SPREADSHEET_ID = '1bpNKl-UVHzbqsow4zOHE7-y5Cunm2xtpgyIodEQBi2E'; // Asegúrate de que esta es tu ID de hoja de cálculo

        let gapiInited = false;

        // Elementos del DOM
        const playersTableBody = document.querySelector('#players-table tbody');
        const matchesTableBody = document.querySelector('#matches-table tbody');
        const playersLoading = document.getElementById('players-loading');
        const matchesLoading = document.getElementById('matches-loading');
        const playersTable = document.getElementById('players-table');
        const matchesTable = document.getElementById('matches-table');
        const totalRecaudadoSpan = document.getElementById('total-recaudado');
        const pagosPendientesSpan = document.getElementById('pagos-pendientes');

        // Función que se ejecuta cuando la librería gapi (API de Google) está cargada
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        // Inicializa el cliente de la API de Google
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: 'TU_API_KEY', // Si tu hoja es pública, puedes usar solo la API Key. Si no, necesitarás OAuth.
                                         // Para esta versión pública, asumo que la hoja tendrá permisos de lectura públicos.
                                         // Si no es pública, esta página no funcionará sin autenticación.
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                gapiInited = true;
                // Cargar datos automáticamente al inicializar
                await listPlayers();
                await listMatches();
                await getPaymentsSummary();
            } catch (err) {
                console.error("Error al inicializar gapi.client:", err);
                playersLoading.textContent = `Error al cargar datos de jugadores: ${err.message || JSON.stringify(err)}`;
                matchesLoading.textContent = `Error al cargar datos de partidos: ${err.message || JSON.stringify(err)}`;
                totalRecaudadoSpan.textContent = `Error`;
                pagosPendientesSpan.textContent = `Error`;
            }
        }

        /**
         * Carga y muestra los jugadores de la hoja de cálculo.
         */
        async function listPlayers() {
            playersLoading.classList.remove('hidden');
            playersTable.classList.add('hidden');
            playersTableBody.innerHTML = ''; // Limpiar tabla

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Jugadores!A:G', // Rango completo de la hoja "Jugadores"
                });
                const range = response.result;
                if (range.values && range.values.length > 1) { // Ignorar la primera fila (encabezados)
                    const players = range.values.slice(1);
                    playersLoading.classList.add('hidden');
                    playersTable.classList.remove('hidden');

                    players.forEach(player => {
                        const [id, nombre, estado, puntosTotales, partidosJugados, chamigosGanados, asistenciasTT] = player;
                        const row = `
                            <tr>
                                <td>${id || ''}</td>
                                <td>${nombre || ''}</td>
                                <td>${estado || ''}</td>
                                <td class="text-center">${puntosTotales || '0'}</td>
                                <td class="text-center">${partidosJugados || '0'}</td>
                                <td class="text-center">${chamigosGanados || '0'}</td>
                                <td class="text-center">${asistenciasTT || '0'}</td>
                            </tr>
                        `;
                        playersTableBody.innerHTML += row;
                    });
                } else {
                    playersLoading.textContent = 'No hay jugadores registrados.';
                }
            } catch (err) {
                playersLoading.textContent = `Error al cargar jugadores: ${err.message}`;
                console.error('Error al cargar jugadores:', err);
            }
        }

        /**
         * Carga y muestra los partidos de la hoja de cálculo.
         */
        async function listMatches() {
            matchesLoading.classList.remove('hidden');
            matchesTable.classList.add('hidden');
            matchesTableBody.innerHTML = ''; // Limpiar tabla

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Partidos!A:G', // Rango completo de la hoja "Partidos"
                });
                const range = response.result;
                if (range.values && range.values.length > 1) { // Ignorar la primera fila (encabezados)
                    const matches = range.values.slice(1);
                    matchesLoading.classList.add('hidden');
                    matchesTable.classList.remove('hidden');

                    matches.forEach(match => {
                        const [id, fecha, clarosIDs, oscurosIDs, resultado, chamigoVotos, asistenciaTTIDs] = match;
                        
                        // Convertir IDs a nombres para Chamigo y TT si es necesario
                        let chamigoDisplay = 'N/A';
                        if (chamigoVotos) {
                            try {
                                const parsedVotes = JSON.parse(chamigoVotos);
                                if (parsedVotes.length > 0) {
                                    const maxVotes = Math.max(...parsedVotes.map(v => v.votos));
                                    const chamigos = parsedVotes.filter(v => v.votos === maxVotes).map(v => {
                                        const player = allPlayersData.find(p => p[0] === v.id);
                                        return player ? player[1] : `ID:${v.id}`;
                                    });
                                    chamigoDisplay = chamigos.join(', ');
                                }
                            } catch (e) {
                                console.warn("Error parsing chamigoVotos:", chamigoVotos, e);
                                chamigoDisplay = 'Error';
                            }
                        }

                        let ttDisplay = 'N/A';
                        if (asistenciaTTIDs) {
                            const ttAttendees = asistenciaTTIDs.split(',').filter(Boolean).map(id => {
                                const player = allPlayersData.find(p => p[0] === id);
                                return player ? player[1] : `ID:${id}`;
                            });
                            ttDisplay = ttAttendees.join(', ');
                        }

                        const row = `
                            <tr>
                                <td>${id || ''}</td>
                                <td>${fecha || ''}</td>
                                <td>${clarosIDs ? clarosIDs.split(',').map(id => {
                                    const player = allPlayersData.find(p => p[0] === id);
                                    return player ? player[1] : `ID:${id}`;
                                }).join(', ') : ''}</td>
                                <td>${oscurosIDs ? oscurosIDs.split(',').map(id => {
                                    const player = allPlayersData.find(p => p[0] === id);
                                    return player ? player[1] : `ID:${id}`;
                                }).join(', ') : ''}</td>
                                <td class="text-center">${resultado || 'Pendiente'}</td>
                                <td class="text-center">${chamigoDisplay}</td>
                                <td class="text-center">${ttDisplay}</td>
                            </tr>
                        `;
                        matchesTableBody.innerHTML += row;
                    });
                } else {
                    matchesLoading.textContent = 'No hay partidos programados.';
                }
            } catch (err) {
                matchesLoading.textContent = `Error al cargar partidos: ${err.message}`;
                console.error('Error al cargar partidos:', err);
            }
        }

        /**
         * Obtiene y muestra el resumen de pagos.
         * Esta función es ilustrativa y necesitaría una hoja de cálculo 'Pagos' real
         * con columnas para 'Monto' y 'Estado' (ej. 'Pagado', 'Pendiente').
         */
        async function getPaymentsSummary() {
            try {
                // Aquí deberías tener una hoja de cálculo 'Pagos' con columnas como 'Monto' y 'Estado'
                // Por simplicidad, usaremos datos simulados o una lógica básica.
                // Si tienes una hoja de 'Pagos', ajusta el rango y la lógica.
                // Ejemplo: Asumimos que los jugadores tienen un estado de pago en su fila (columna F)
                // y cada partido tiene un costo (esto es más complejo de calcular aquí sin una hoja de pagos detallada).

                // Para esta versión pública, simplemente mostraremos un resumen estático o muy básico.
                // Si quieres un resumen real, necesitarías una hoja de pagos dedicada y permisos para leerla.

                // Simulación de datos para el resumen de pagos
                let totalRecaudado = 0;
                let pagosPendientes = 0;

                // Si `allPlayersData` está disponible y tiene la columna de estado de pago (asumimos columna F, índice 5)
                if (window.allPlayersData && window.allPlayersData.length > 0) {
                    window.allPlayersData.forEach(player => {
                        const estadoPago = player[5]; // Asumiendo que la columna F (índice 5) es el estado de pago
                        if (estadoPago === 'Al día') {
                            // Para un cálculo real, necesitarías un "monto a pagar" por jugador o partido
                            // Aquí, solo estamos contando los que están "Al día" vs "Pendiente"
                            totalRecaudado += 100; // Valor de ejemplo por jugador "Al día"
                        } else {
                            pagosPendientes += 100; // Valor de ejemplo por jugador "Pendiente"
                        }
                    });
                } else {
                    // Si no hay datos de jugadores, o no se han cargado, mostrar valores por defecto
                    totalRecaudado = 1200; // Ejemplo
                    pagosPendientes = 300; // Ejemplo
                }


                totalRecaudadoSpan.textContent = `$${totalRecaudado.toFixed(2)}`;
                pagosPendientesSpan.textContent = `$${pagosPendientes.toFixed(2)}`;

            } catch (err) {
                console.error('Error al obtener resumen de pagos:', err);
                totalRecaudadoSpan.textContent = `Error`;
                pagosPendientesSpan.textContent = `Error`;
            }
        }


        // Carga la librería de Google API cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Página pública de Fútbol 5 cargada!');
            gapiLoaded();
        });
    </script>
</body>
</html>
