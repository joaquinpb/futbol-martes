<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fútbol 5 - Estadísticas de Jugadores</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter para una mejor legibilidad */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Un gris claro para el fondo */
        }
        /* Estilos base para tablas */
        table {
            @apply min-w-full bg-white rounded-lg shadow-md;
        }
        th, td {
            @apply py-3 px-6 text-left;
        }
        thead th {
            @apply bg-gray-200 text-gray-700 uppercase text-sm leading-normal;
        }
        tbody tr {
            @apply border-b border-gray-200 hover:bg-gray-100;
        }
        tbody tr:last-child {
            @apply border-b-0;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-6xl my-8">
        <h1 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">Fútbol 5 - Estadísticas de Jugadores</h1>

        <!-- Sección de Jugadores con Estadísticas -->
        <section class="mb-10">
            <h2 class="text-3xl font-semibold text-gray-700 mb-6 border-l-4 border-blue-500 pl-4">Tabla de Posiciones</h2>
            <div id="players-list-container" class="overflow-x-auto">
                <p id="players-loading" class="text-gray-500 text-center py-4">Cargando estadísticas de jugadores...</p>
                <table id="players-stats-table" class="hidden">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th class="text-center">Puntos</th>
                            <th class="text-center">PJ</th>
                            <th class="text-center">Ausente</th>
                            <th class="text-center">Chamigo</th>
                            <th class="text-center">TT</th>
                            <th class="text-center">Efectividad</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Las estadísticas de los jugadores se cargarán aquí dinámicamente -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Script de la API de Google -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

    <script>
        // ¡IMPORTANTE! Reemplaza 'TU_ID_DE_HOJA_DE_CALCULO' con el ID de tu Google Sheet
        const SPREADSHEET_ID = '1bpNKl-UVHzbqsow4zOHE7-y5Cunm2xtpgyIodEQBi2E'; // Asegúrate de que esta es tu ID de hoja de cálculo

        let gapiInited = false;
        let allPlayersData = []; // Cache para datos de jugadores
        let allMatchesData = []; // Cache para datos de partidos

        // Elementos del DOM
        const playersStatsTableBody = document.querySelector('#players-stats-table tbody');
        const playersLoading = document.getElementById('players-loading');
        const playersStatsTable = document.getElementById('players-stats-table');

        // Función que se ejecuta cuando la librería gapi (API de Google) está cargada
        // Esta función ahora es llamada por el atributo 'onload' del script de gapi.js
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        // Inicializa el cliente de la API de Google
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: 'TU_API_KEY', // Si tu hoja es pública, puedes usar solo la API Key. Si no, necesitarás OAuth.
                                         // Para esta versión pública, asumo que la hoja tendrá permisos de lectura públicos.
                                         // Si no es pública, esta página no funcionará sin autenticación.
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                gapiInited = true;
                await loadAllDataAndDisplayStats();
            } catch (err) {
                console.error("Error al inicializar gapi.client:", err);
                playersLoading.textContent = `Error al cargar datos: ${err.message || JSON.stringify(err)}. Asegúrate de que la API Key es correcta y la hoja es pública.`;
            }
        }

        /**
         * Carga todos los datos necesarios (jugadores y partidos) y luego muestra las estadísticas.
         */
        async function loadAllDataAndDisplayStats() {
            playersLoading.classList.remove('hidden');
            playersStatsTable.classList.add('hidden');
            playersStatsTableBody.innerHTML = '';

            try {
                // Cargar datos de Jugadores
                const playersResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Jugadores!A:G', // Rango completo de la hoja "Jugadores"
                });
                allPlayersData = playersResponse.result.values ? playersResponse.result.values.slice(1) : [];

                // Cargar datos de Partidos
                const matchesResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Partidos!A:G', // Rango completo de la hoja "Partidos"
                });
                allMatchesData = matchesResponse.result.values ? matchesResponse.result.values.slice(1) : [];

                if (allPlayersData.length === 0) {
                    playersLoading.textContent = 'No hay jugadores registrados para mostrar estadísticas.';
                    return;
                }

                // Calcular y renderizar estadísticas
                renderPlayerStatsTable();

            } catch (err) {
                playersLoading.textContent = `Error al cargar datos: ${err.message}. Revisa la consola y los permisos de tu Google Sheet.`;
                console.error('Error al cargar datos para estadísticas:', err);
            }
        }

        /**
         * Parsea una cadena de fecha en formato DD/MM/YYYY a un objeto Date.
         * Asume la zona horaria local.
         * @param {string} dateString - La cadena de fecha en formato DD/MM/YYYY.
         * @returns {Date} El objeto Date.
         */
        function parseDate(dateString) {
            const [day, month, year] = dateString.split('/').map(Number);
            return new Date(year, month - 1, day); // month - 1 porque los meses en Date son 0-indexados
        }

        /**
         * Calcula las estadísticas de los jugadores basándose en los partidos filtrados.
         * Incluye cálculo de Efectividad y Ausente.
         */
        function calculatePlayerStatsForPublicLeaderboard(players, matches) {
            const playerStats = {};
            // Filtrar partidos que tienen fecha y no están suspendidos para contar el total de partidos válidos
            const validMatches = matches.filter(match => match[1] && match[1].trim() !== '' && match[4] !== 'Suspendido');
            const totalMatchesInPeriod = validMatches.length; // Total de partidos para calcular ausentismo

            // Inicializar estadísticas para todos los jugadores activos
            players.forEach(player => {
                const [id, nombre, estado] = player;
                if (estado === 'Activo') { // Solo considerar jugadores activos
                    playerStats[id] = {
                        id,
                        nombre,
                        puntos: 0,
                        partidosJugados: 0, // PJ
                        chamigosGanados: 0, // Chamigo
                        asistenciasTT: 0, // TT
                        efectividad: '0.00%',
                        ausente: totalMatchesInPeriod // Inicialmente, ausente en todos los partidos válidos
                    };
                }
            });

            validMatches.forEach(match => { // Iterar solo sobre los partidos válidos
                // Desestructuración con valores por defecto para mayor robustez
                const [
                    idPartido,
                    fecha,
                    equipoClarosIDsStr = '',
                    equipoOscurosIDsStr = '',
                    resultado,
                    chamigoVotosStr = '',
                    asistenciaTTIDsStr = ''
                ] = match;

                const equipoClarosIDs = equipoClarosIDsStr.split(',').filter(Boolean);
                const equipoOscurosIDs = oscurosIDsStr.split(',').filter(Boolean);
                const allPlayersInMatch = new Set([...equipoClarosIDs, ...equipoOscurosIDs]);

                // Contar partidos jugados (PJ) y ajustar Ausente
                allPlayersInMatch.forEach(playerId => {
                    if (playerStats[playerId]) {
                        playerStats[playerId].partidosJugados++;
                        playerStats[playerId].ausente--; // Restar 1 por cada partido jugado
                    }
                });

                // Asignar puntos por resultado
                if (resultado === 'Claros' || resultado === 'Oscuros') {
                    const winningTeam = resultado === 'Claros' ? equipoClarosIDs : equipoOscurosIDs;
                    winningTeam.forEach(playerId => {
                        if (playerStats[playerId]) playerStats[playerId].puntos += 3;
                    });
                } else if (resultado === 'Empate') {
                    allPlayersInMatch.forEach(playerId => {
                        if (playerStats[playerId]) playerStats[playerId].puntos += 1;
                    });
                }

                // Contar Chamigos
                if (chamigoVotosStr) {
                    try {
                        const chamigoVotos = JSON.parse(chamigoVotosStr);
                        if (chamigoVotos.length > 0) {
                            const maxVotes = Math.max(...chamigoVotos.map(v => v.votos));
                            const chamigosDelPartido = chamigoVotos.filter(v => v.votos === maxVotes);
                            chamigosDelPartido.forEach(chamigo => {
                                if (playerStats[chamigo.id]) playerStats[chamigo.id].chamigosGanados++;
                            });
                        }
                    } catch (e) {
                        console.warn('Error al parsear votos de chamigo:', chamigoVotosStr, e);
                    }
                }

                // Contar asistencias a TT
                if (asistenciaTTIDsStr) {
                    const ttAttendees = asistenciaTTIDsStr.split(',').filter(Boolean);
                    ttAttendees.forEach(playerId => {
                        if (playerStats[playerId]) playerStats[playerId].asistenciasTT++;
                    });
                }
            });

            // Calcular Efectividad después de contar todos los puntos y PJ
            Object.values(playerStats).forEach(player => {
                const maxPossiblePoints = player.partidosJugados * 3;
                if (maxPossiblePoints > 0) {
                    player.efectividad = ((player.puntos / maxPossiblePoints) * 100).toFixed(2) + '%';
                } else {
                    player.efectividad = '0.00%';
                }
            });

            // Ordenar por puntos (descendente) para la tabla de posiciones
            return Object.values(playerStats).sort((a, b) => b.puntos - a.puntos);
        }

        /**
         * Renderiza la tabla de estadísticas de jugadores.
         */
        function renderPlayerStatsTable() {
            playersStatsTableBody.innerHTML = ''; // Limpiar tabla
            playersLoading.classList.add('hidden');
            playersStatsTable.classList.remove('hidden');

            const playersWithStats = calculatePlayerStatsForPublicLeaderboard(allPlayersData, allMatchesData);

            if (playersWithStats.length === 0) {
                playersLoading.textContent = 'No hay estadísticas disponibles para mostrar.';
                playersLoading.classList.remove('hidden');
                playersStatsTable.classList.add('hidden');
                return;
            }

            playersWithStats.forEach(player => {
                const row = `
                    <tr>
                        <td>${player.id}</td>
                        <td>${player.nombre}</td>
                        <td class="text-center">${player.puntos}</td>
                        <td class="text-center">${player.partidosJugados}</td>
                        <td class="text-center">${player.ausente}</td>
                        <td class="text-center">${player.chamigosGanados}</td>
                        <td class="text-center">${player.asistenciasTT}</td>
                        <td class="text-center">${player.efectividad}</td>
                    </tr>
                `;
                playersStatsTableBody.innerHTML += row;
            });
        }

        // No es necesario un DOMContentLoaded separado para gapiLoaded
        // ya que el script de gapi.js lo llama directamente.
        // console.log('Página pública de Fútbol 5 cargada!'); // Este log se puede mantener si se desea.
    </script>
</body>
</html>
