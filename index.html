<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA CLANDE</title> <!-- Título de la página actualizado a mayúsculas -->
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Carga de Chart.js para gráficos (aunque no se use directamente para perfiles individuales, se mantiene por si se usa en el futuro) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Fuente Inter para una mejor legibilidad */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Un gris claro para el fondo */
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex; /* Usar flexbox para el layout principal */
        }
        /* Estilos base para tablas */
        table {
            @apply bg-white rounded-lg shadow-md;
            width: 100%; /* Ensure tables take full width */
            border-collapse: collapse; /* For clean borders */
        }
        /* Encabezados de tabla: centrado por defecto */
        th {
            @apply py-3 px-3 text-center; /* Reducido padding para mejor ajuste en pantallas pequeñas */
        }
        /* Celdas de datos: centrado por defecto */
        td {
            @apply py-3 px-3 text-center text-xs sm:text-sm; /* Reducido padding y tamaño de fuente para mobile */
        }
        /* Alineación a la izquierda para la columna Jugador (encabezado y datos) */
        .text-left-player {
            text-align: left !important;
        }
        /* Encabezado de la tabla: fondo negro, texto blanco */
        thead th {
            background-color: #1a202c !important; /* Fondo negro (bg-gray-900) */
            color: #ffffff !important; /* Texto blanco (text-white) */
            text-transform: uppercase;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* leading-normal */
        }
        /* Filas del cuerpo de la tabla: alternar entre dos tonos de gris */
        tbody tr:nth-child(odd) {
            background-color: #f7fafc !important; /* Gris muy claro (bg-gray-100) */
        }
        tbody tr:nth-child(even) {
            background-color: #edf2f7 !important; /* Gris ligeramente más oscuro (bg-gray-200) */
        }
        tbody tr {
            border-bottom: 1px solid #cbd5e0; /* border-gray-300 */
            transition: background-color 150ms ease-in-out; /* transition duration-150 ease-in-out */
        }
        tbody tr:hover {
            background-color: #e2e8f0 !important; /* Tono de gris al pasar el cursor (hover:bg-gray-300) */
        }
        tbody tr:last-child {
            border-bottom: 0; /* Eliminar borde inferior de la última fila */
        }
        tbody td {
            color: #4a5568; /* text-gray-600 */
        }

        /* Custom class to disable horizontal overflow */
        .overflow-x-auto-off {
            overflow-x: hidden;
        }

        /* --- Estilos para el menú lateral responsivo --- */
        #side-menu {
            position: fixed; /* Fixed for mobile sliding effect */
            top: 0;
            left: 0;
            height: 100vh;
            width: 256px; /* w-64 */
            background-color: #312e81; /* indigo-800 */
            color: white;
            transform: translateX(-100%); /* Hidden by default for mobile */
            transition: transform 0.3s ease-in-out;
            z-index: 40;
            display: flex; /* Use flex for vertical layout of tabs */
            flex-direction: column;
            padding-top: 1rem; /* Add some padding at the top */
        }

        /* This class will be applied by JS to make it visible on mobile */
        #side-menu.open {
            transform: translateX(0);
        }

        #overlay {
            position: fixed;
            inset: 0; /* top:0, right:0, bottom:0, left:0 */
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            display: none; /* Hidden by default */
        }

        #overlay.open {
            display: block; /* Show when side menu is open (mobile only) */
        }

        #hamburger-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 50;
            padding: 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
        }

        #close-side-menu-button {
            background: none;
            border: none;
            font-size: 2rem; /* text-2xl */
            color: white;
            cursor: pointer;
            padding: 0.5rem;
        }

        #side-menu .tab-button, #side-menu .sidebar-link {
            padding-left: 1.5rem; /* px-6 */
            padding-right: 1.5rem; /* px-6 */
            text-align: left;
            width: 100%; /* Full width within sidebar */
            border-radius: 0; /* No rounded corners for vertical tabs */
            margin-bottom: 0.25rem; /* mb-1 */
            color: white; /* Text white for dark sidebar */
            transition: background-color 0.15s ease-in-out;
            display: flex; /* Para alinear el texto y el icono */
            align-items: center; /* Para alinear el texto y el icono */
            gap: 0.5rem; /* Espacio entre texto e icono */
        }
        #side-menu .tab-button.active {
            background-color: #4338ca; /* indigo-700 */
        }
        #side-menu .tab-button:hover, #side-menu .sidebar-link:hover {
            background-color: #4f46e5; /* indigo-600 */
        }

        /* Desktop Styles (min-width: 768px) */
        @media (min-width: 768px) {
            #side-menu {
                position: relative; /* Make it part of the normal flow */
                transform: translateX(0) !important; /* Always visible on desktop */
                flex-shrink: 0; /* Prevent shrinking */
                height: auto; /* Let content define height */
                min-height: 100vh; /* Ensure it takes full viewport height */
                border-right: 1px solid #e2e8f0; /* border-gray-200 */
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.06); /* shadow-lg */
                display: flex !important; /* Override hidden class if present */
            }
            #hamburger-button {
                display: none !important; /* Always hide hamburger on desktop */
            }
            #close-side-menu-button {
                display: none !important; /* Hide close button on desktop */
            }
            #overlay {
                display: none !important; /* Hide overlay on desktop */
            }
            .main-content-container {
                flex-grow: 1; /* Take remaining space */
                margin-left: 0 !important; /* Reset margin-left from mobile */
                margin-right: 0 !important; /* Reset margin-right from mobile */
                max-width: none !important; /* Allow it to expand fully */
                width: auto !important; /* Let flexbox control width */
            }
        }

        /* Estadísticas table remains auto layout and overflow-x-auto */
        #estadisticas-table {
            table-layout: auto;
        }

        /* Style for loading messages */
        .loading-message {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: #6b7280; /* gray-500 */
            font-style: italic;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #4f46e5; /* Indigo-600 */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Highlighted class for autocomplete results */
        .highlighted {
            background-color: #e0e7ff; /* indigo-100 */
        }

        /* Styles for the soccer field */
        #soccer-field-container {
            position: relative;
            width: 100%;
            aspect-ratio: 9 / 16; /* Default for portrait mobile */
            background-color: #0f8d48; /* Green field color */
            border: 2px solid white; /* Outer perimeter */
            border-radius: 0.5rem; /* rounded-lg */
            overflow: hidden; /* Ensure players stay within bounds */
            margin-bottom: 1.5rem; /* mb-6 */
            margin-left: auto; /* Center the field */
            margin-right: auto; /* Center the field */
            display: none; /* Hidden by default, controlled by JS */
        }
        #soccer-field-container.field-active {
            display: block; /* Show when active */
        }

        /* Halfway line (vertical for portrait, horizontal for landscape) */
        #soccer-field-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: white;
            transform: translateY(-50%);
        }

        /* Center circle */
        #soccer-field-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 15vw; /* Use vw for consistent circle size on mobile */
            height: 15vw; /* Must be equal to width for a circle */
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Goals */
        .goal {
            position: absolute;
            box-sizing: border-box;
        }
        .goal.top { /* Top goal in portrait, left goal in landscape */
            top: -15px;
            left: 35%;
            width: 30%;
            height: 15px;
            border-left: 2px solid white;
            border-right: 2px solid white;
            border-bottom: 2px solid white;
        }
        .goal.bottom { /* Bottom goal in portrait, right goal in landscape */
            bottom: -15px;
            left: 35%;
            width: 30%;
            height: 15px;
            border-left: 2px solid white;
            border-right: 2px solid white;
            border-top: 2px solid white;
        }

        /* Penalty Areas */
        .penalty-area {
            position: absolute;
            box-sizing: border-box;
            border-color: white;
            border-style: solid;
            border-width: 0;
        }
        .penalty-area.top { /* Top penalty area in portrait, left in landscape */
            top: 0;
            left: 20%;
            width: 60%;
            height: 20%;
            border-width: 0 4px 2px 4px;
        }
        .penalty-area.bottom { /* Bottom penalty area in portrait, right in landscape */
            bottom: 0;
            left: 20%;
            width: 60%;
            height: 20%;
            border-width: 2px 4px 0 4px;
        }

        /* Goal Areas */
        .goal-area {
            position: absolute;
            box-sizing: border-box;
            border-color: white;
            border-style: solid;
            border-width: 0;
        }
        .goal-area.top { /* Top goal area in portrait, left in landscape */
            top: 0;
            left: 35%;
            width: 30%;
            height: 10%;
            border-width: 0 4px 2px 4px;
        }
        .goal-area.bottom { /* Bottom goal area in portrait, right in landscape */
            bottom: 0;
            left: 35%;
            width: 30%;
            height: 10%;
            border-width: 2px 4px 0 4px;
        }

        .player-marker {
            position: absolute;
            width: 40px; /* Tamaño del marcador de jugador */
            height: 40px;
            border-radius: 50%; /* Forma circular */
            display: flex;
            flex-direction: column; /* Allow text and star to stack */
            align-items: center;
            justify-content: center;
            font-size: 0.75rem; /* text-xs */
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transform: translate(-50%, -50%); /* Centrar el marcador en la posición */
            border: 2px solid; /* Border for team color */
            padding: 2px; /* Inner padding for text */
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow text */
        }
        .player-marker .player-name {
            line-height: 1; /* Adjust line height for better fit */
        }
        .player-marker .fa-star {
            font-size: 0.6em; /* Smaller star */
            margin-top: 2px; /* Small margin for separation */
        }

        .player-marker.claros {
            background-color: #ffffff; /* White jersey */
            color: #1a202c; /* Black text */
            border-color: #1a202c; /* Black border */
        }

        .player-marker.oscuros {
            background-color: #1a202c; /* Black jersey */
            color: #ffffff; /* White text */
            border-color: #ffffff; /* White border */
        }

        .winner-trophy {
            position: absolute;
            font-size: 2rem; /* Large trophy icon */
            color: #facc15; /* Yellow/Gold color */
            z-index: 10; /* Ensure it's above other elements */
            transform: translate(-50%, -50%); /* Centrar el icon */
        }

        /* Responsive adjustments for player marker size */
        @media (min-width: 640px) { /* sm breakpoint */
            .player-marker {
                width: 50px;
                height: 50px;
                font-size: 0.875rem; /* text-sm */
            }
            .player-marker .fa-star {
                font-size: 0.7em;
            }
        }

        /* Media query for landscape orientation (mobile landscape and desktop) */
        @media (orientation: landscape) and (max-width: 767px), (min-width: 768px) {
            #soccer-field-container {
                width: 60%; /* Adjust width for horizontal layout */
                aspect-ratio: 16 / 9; /* Landscape aspect ratio */
            }

            /* Adjust TT details width for desktop */
            #fixture-details-display {
                width: 40%; /* Take remaining space (100% - 60%) */
                margin-top: 0; /* Align with the top of the field */
            }

            /* Rotate and reposition field elements for horizontal view */
            #soccer-field-container::before { /* Halfway line */
                top: 0;
                left: 50%;
                height: 100%;
                width: 2px;
                background-color: white;
                transform: translateX(-50%);
            }

            #soccer-field-container::after { /* Center circle */
                width: 8vw; /* Smaller for desktop, adjust as needed */
                height: 8vw;
            }

            /* Goals (now left/right) */
            .goal.top { /* Now left goal */
                top: 35%;
                left: -15px;
                width: 15px;
                height: 30%;
                border-left: none;
                border-right: 2px solid white;
                border-top: 2px solid white;
                border-bottom: 2px solid white;
            }
            .goal.bottom { /* Now right goal */
                top: 35%;
                right: -15px;
                left: auto;
                width: 15px;
                height: 30%;
                border-left: 2px solid white;
                border-right: none;
                border-top: 2px solid white;
                border-bottom: 2px solid white;
            }

            /* Penalty Areas (horizontal) */
            .penalty-area.top { /* Now left penalty area */
                top: 20%;
                left: 0;
                height: 60%;
                width: 20%;
                border-width: 4px 2px 4px 0;
            }
            .penalty-area.bottom { /* Now right penalty area */
                top: 20%;
                right: 0;
                left: auto;
                height: 60%;
                width: 20%;
                border-width: 4px 0 4px 2px;
            }

            /* Goal Areas (horizontal) */
            .goal-area.top { /* Now left goal area */
                top: 35%;
                left: 0;
                height: 30%;
                width: 10%;
                border-width: 4px 2px 4px 0;
            }
            .goal-area.bottom { /* Now right goal area */
                top: 35%;
                right: 0;
                left: auto;
                height: 30%;
                width: 10%;
                border-width: 4px 0 4px 2px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col md:flex-row p-4 md:p-0">
    <!-- Hamburger Button (visible on mobile) -->
    <button id="hamburger-button" class="fixed top-4 left-4 z-50 p-2 rounded-md bg-indigo-600 text-white shadow-lg hidden">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <!-- Side Navigation Menu -->
    <nav id="side-menu" class="fixed top-0 left: 0; h-full w-64 bg-indigo-800 text-white transform -translate-x-full transition-transform duration-300 ease-in-out z-40 hidden">
        <div class="p-4 text-right">
            <button id="close-side-menu-button" class="text-white text-2xl md:hidden">&times;</button>
        </div>
        <div class="flex flex-col p-4 md:p-0 md:space-y-2 flex-1">
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="leaderboard-content"><i class="fas fa-trophy mr-2"></i>Tabla de Posiciones</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="chamigo-content"><i class="fas fa-star mr-2"></i>Chamigo</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="tt-content"><i class="fas fa-beer mr-2"></i>TT</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="presentismo-content"><i class="fas fa-check-circle mr-2"></i>Presentismo</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="ausentismo-content"><i class="fas fa-times-circle mr-2"></i>Ausentismo</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="estadisticas-content"><i class="fas fa-chart-bar mr-2"></i>Estadísticas</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="equipos-content"><i class="fas fa-futbol mr-2"></i>Equipos</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="fixture-content"><i class="fas fa-calendar-alt mr-2"></i>Fixture</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="individual-stats-content"><i class="fas fa-user mr-2"></i>Estadísticas Individuales</button>
        </div>
    </nav>

    <!-- Overlay for when side menu is open (mobile only) -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

    <!-- Main Content Area -->
    <div class="main-content-container bg-white p-8 rounded-xl shadow-lg w-full max-w-5xl mx-auto mt-4 md:mt-8">
        <h1 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">LA CLANDE</h1> <!-- Título principal actualizado a mayúsculas -->

        <!-- Content for Tabla de Posiciones -->
        <div id="leaderboard-content" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tabla de Posiciones</h2>
            <div class="grid grid-cols-2 md:grid-cols-2 gap-4 md:gap-8 mb-6">
                <div>
                    <label for="leaderboard-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="leaderboard-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="leaderboard-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                    <select id="leaderboard-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto-off">
                <p id="leaderboard-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando tabla de posiciones...
                </p>
                <table id="leaderboard-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">#</th>
                            <th class="py-3 px-3 text-left-player">Jugador</th>
                            <th class="py-3 px-3 text-center">Puntos</th>
                            <th class="py-3 px-3 text-center">Efectividad</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <!-- Content for Chamigo -->
        <div id="chamigo-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tabla de Chamigos</h2>
            <div class="grid grid-cols-2 md:grid-cols-2 gap-4 md:gap-8 mb-6">
                <div>
                    <label for="chamigo-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="chamigo-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="chamigo-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                    <select id="chamigo-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto-off">
                <p id="chamigo-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando tabla de Chamigos...
                </p>
                <table id="chamigo-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">#</th>
                            <th class="py-3 px-3 text-left-player">Jugador</th>
                            <th class="py-3 px-3 text-center">Chamigos</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <!-- Content for TT -->
        <div id="tt-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tabla de Asistencia TT</h2>
            <div class="grid grid-cols-2 md:grid-cols-2 gap-4 md:gap-8 mb-6">
                <div>
                    <label for="tt-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="tt-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="tt-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                    <select id="tt-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto-off">
                <p id="tt-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando tabla de Asistencia TT...
                </p>
                <table id="tt-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">#</th>
                            <th class="py-3 px-3 text-left-player">Jugador</th>
                            <th class="py-3 px-3 text-center">TT</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <!-- Content for Presentismo -->
        <div id="presentismo-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tabla de Presentismo (PJ)</h2>
            <div class="grid grid-cols-2 md:grid-cols-2 gap-4 md:gap-8 mb-6">
                <div>
                    <label for="presentismo-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="presentismo-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="presentismo-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                    <select id="presentismo-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto-off">
                <p id="presentismo-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando tabla de Presentismo...
                </p>
                <table id="presentismo-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">#</th>
                            <th class="py-3 px-3 text-left-player">Jugador</th>
                            <th class="py-3 px-3 text-center">PJ</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <!-- Content for Ausentismo -->
        <div id="ausentismo-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tabla de Ausentismo</h2>
            <div class="grid grid-cols-2 md:grid-cols-2 gap-4 md:gap-8 mb-6">
                <div>
                    <label for="ausentismo-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="ausentismo-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="ausentismo-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                    <select id="ausentismo-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto-off">
                <p id="ausentismo-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando tabla de Ausentismo...
                </p>
                <table id="ausentismo-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">#</th>
                            <th class="py-3 px-3 text-left-player">Jugador</th>
                            <th class="py-3 px-3 text-center">Ausentes</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <!-- Content for Estadísticas -->
        <div id="estadisticas-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Estadísticas de Jugadores</h2>
            <div id="estadisticas-filters" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label for="estadisticas-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="estadisticas-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="estadisticas-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                    <select id="estadisticas-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
                <div>
                    <label for="estadisticas-sort-criterion" class="block text-sm font-medium text-gray-700">Ordenar por:</label>
                    <select id="estadisticas-sort-criterion" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="points">Puntos</option>
                        <option value="pg">PG</option>
                        <option value="pe">PE</option>
                        <option value="pp">PP</option>
                        <option value="pj">PJ</option>
                        <option value="efectividad">Efectividad</option>
                        <option value="chamigos">Chamigo</option>
                        <option value="tt">TT</option>
                        <option value="ausentes">Ausentismo</option>
                    </select>
                </div>
                <div>
                    <label for="estadisticas-sort-order" class="block text-sm font-medium text-gray-700">Orden:</label>
                    <select id="estadisticas-sort-order" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="desc">Descendente</option>
                        <option value="asc">Ascendente</option>
                    </select>
                </div>
            </div>
            
            <div id="estadisticas-table-container" class="overflow-x-auto"> <!-- This one keeps overflow-x-auto -->
                <p id="estadisticas-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando estadísticas...
                </p>
                <table id="estadisticas-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">#</th>
                            <th class="py-3 px-3 text-left-player">Jugador</th>
                            <th class="py-3 px-3 text-center">Puntos</th>
                            <th class="py-3 px-3 text-center">PG</th>
                            <th class="py-3 px-3 text-center">PE</th>
                            <th class="py-3 px-3 text-center">PP</th>
                            <th class="py-3 px-3 text-center">PJ</th>
                            <th class="py-3 px-3 text-center">Efectividad</th>
                            <th class="py-3 px-3 text-center">Chamigo</th>
                            <th class="py-3 px-3 text-center">TT</th>
                            <th class="py-3 px-3 text-center">Ausentismo</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <!-- Content for Equipos -->
        <div id="equipos-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Estadísticas de Equipos</h2>
            <div class="grid grid-cols-2 md:grid-cols-2 gap-4 md:gap-8 mb-6">
                <div>
                    <label for="equipos-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="equipos-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="equipos-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                    <select id="equipos-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
            </div>
            <!-- Loading message for Equipos, always present in DOM -->
            <p id="equipos-loading-message" class="loading-message col-span-full">
                <span class="loading-spinner"></span>Cargando estadísticas de equipos...
            </p>
            <div id="equipos-stats-display" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- Estadísticas de equipos se cargarán aquí -->
            </div>
        </div>

        <!-- Content for Fixture -->
        <div id="fixture-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Detalles del Partido</h2>
            
            <!-- Container for field and details side-by-side on desktop -->
            <div class="flex flex-col md:flex-row md:space-x-6">
                <!-- Soccer Field Container -->
                <div id="soccer-field-container"> <!-- Removed hidden md:block -->
                    <!-- Goals -->
                    <div class="goal top"></div>
                    <div class="goal bottom"></div>
                    <!-- Penalty Areas -->
                    <div class="penalty-area top"></div>
                    <div class="penalty-area bottom"></div>
                    <!-- Goal Areas -->
                    <div class="goal-area top"></div>
                    <div class="goal-area bottom"></div>
                    <!-- Trophy will be dynamically added here -->
                </div>

                <!-- Match details will be loaded here -->
                <div id="fixture-details-display" class="grid grid-cols-1 md:grid-cols-1 gap-4 mb-6 hidden"> <!-- Adjusted width for desktop, removed mt-6 -->
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="font-semibold text-gray-700 mb-2">Asistentes al TT</h3>
                        <table id="tt-attendees-table" class="bg-white rounded-lg shadow">
                            <thead>
                                <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                    <th class="py-3 px-3 text-left-player">Jugador</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light">
                                <!-- TT attendees will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <p id="fixture-loading-message" class="loading-message col-span-full">
                <span class="loading-spinner"></span>Cargando partidos...
            </p>

            <h3 class="text-xl font-semibold text-gray-700 mb-4">Partidos del Mes</h3>
            <div id="fixture-matches-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <!-- Match cards will be loaded here -->
            </div>

            <div class="grid grid-cols-2 md:grid-cols-2 gap-4 md:gap-8">
                <div>
                    <label for="fixture-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="fixture-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="fixture-month-select" class="block text-sm font-medium text-gray-700">Mes:</label>
                    <select id="fixture-month-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
            </div>
        </div>

        <!-- Content for Estadísticas Individuales -->
        <div id="individual-stats-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Estadísticas Individuales por Jugador</h2>
            <div class="mb-6">
                <label for="individual-player-search" class="block text-sm font-medium text-gray-700">Buscar Jugador:</label>
                <div class="relative">
                    <input type="text" id="individual-player-search" placeholder="Escribe al menos 3 caracteres..." class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                    <div id="individual-player-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto hidden">
                        <!-- Autocomplete results will go here -->
                    </div>
                </div>
                <input type="hidden" id="selected-player-id"> <!-- To store the actual selected player ID -->
            </div>
            <div class="overflow-x-auto">
                <p id="individual-stats-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando estadísticas individuales...
                </p>
                <table id="individual-stats-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">Año</th>
                            <th class="py-3 px-3 text-center">Torneo</th>
                            <th class="py-3 px-3 text-center">Puntos</th>
                            <th class="py-3 px-3 text-center">PG</th>
                            <th class="py-3 px-3 text-center">PE</th>
                            <th class="py-3 px-3 text-center">PP</th>
                            <th class="py-3 px-3 text-center">PJ</th>
                            <th class="py-3 px-3 text-center">Efectividad</th>
                            <th class="py-3 px-3 text-center">Chamigo</th>
                            <th class="py-3 px-3 text-center">TT</th>
                            <th class="py-3 px-3 text-center">Ausentismo</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Script que contiene las funciones de inicialización de GAPI y carga de datos.
         Se coloca aquí para asegurar que las funciones estén definidas antes de que el script de la API de Google las llame. -->
    <script>
        // ¡IMPORTANTE! Reemplaza 'AIzaSyDNLwReGrX5FKBwjjKsMS9cz-hZNMIvAlM' con tu Clave de API de Google Cloud Console.
        // Esta clave es necesaria para acceder a Google Sheets API para hojas públicas sin autenticación de usuario.
        const API_KEY = 'AIzaSyDNLwReGrX5FKBwjjKsMS9cz-hZNMIvAlM'; 
        
        // ¡IMPORTANTE! Reemplaza 'TU_ID_DE_HOJA_DE_CALCULO' con el ID de tu Google Sheet
        // Asegúrate de que esta hoja de cálculo esté compartida públicamente con "Cualquier persona con el enlace puede ver"
        const SPREADSHEET_ID = '1bpNKl-UVHzbqsow4zOHE7-y5Cunm2xtpgyIodEQBi2E';

        let gapiInited = false;
        let allPlayersData = []; // Cache de todos los jugadores
        let allMatchesData = []; // Cache de todos los partidos

        // Elementos del DOM para el menú lateral
        const hamburgerButton = document.getElementById('hamburger-button');
        const sideMenu = document.getElementById('side-menu');
        const closeSideMenuButton = document.getElementById('close-side-menu-button');
        const overlay = document.getElementById('overlay');
        const tabButtons = document.querySelectorAll('.tab-button');

        // Referencias a los contenedores de contenido
        const leaderboardContent = document.getElementById('leaderboard-content');
        const chamigoContent = document.getElementById('chamigo-content');
        const ttContent = document.getElementById('tt-content');
        const presentismoContent = document.getElementById('presentismo-content');
        const ausentismoContent = document.getElementById('ausentismo-content');
        const estadisticasContent = document.getElementById('estadisticas-content');
        const equiposContent = document.getElementById('equipos-content');
        const fixtureContent = document.getElementById('fixture-content');
        const individualStatsContent = document.getElementById('individual-stats-content'); // New content div
        const soccerFieldContainer = document.getElementById('soccer-field-container'); // Get soccer field container

        // Mapping of hash to tab content ID
        const hashToTabMap = {
            '#leaderboard': 'leaderboard-content',
            '#chamigo': 'chamigo-content',
            '#tt': 'tt-content',
            '#presentismo': 'presentismo-content',
            '#ausentismo': 'ausentismo-content',
            '#estadisticas': 'estadisticas-content',
            '#equipos': 'equipos-content',
            '#fixture': 'fixture-content',
            '#individual-stats': 'individual-stats-content'
        };

        // --- Funciones de Inicialización de Google API y Carga de Datos ---
        // Se definen aquí para asegurar que estén disponibles cuando el script de la API de Google las llame.
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY, // Se usa la clave de API aquí
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                gapiInited = true;
                handleDataLoadSuccess(); // Cargar datos y mostrar contenido
            } catch (err) {
                console.error("Error al inicializar gapi.client:", err);
                // Actualizar todos los mensajes de carga con el error
                let errorDetail;
                if (err && err.message) {
                    errorDetail = err.message;
                } else {
                    try {
                        errorDetail = JSON.stringify(err);
                    } catch (e) {
                        errorDetail = String(e); // Fallback a conversión simple a string
                    }
                }
                const errorMessageText = `Error al inicializar la API de Google: ${errorDetail}. Asegúrate de que la API Key sea correcta y esté habilitada para Google Sheets API.`;

                document.getElementById('leaderboard-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('chamigo-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('tt-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('presentismo-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('ausentismo-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('estadisticas-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('equipos-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('fixture-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('individual-stats-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`; // New
            }
        }

        async function loadAllData() {
            try {
                if (!gapi.client.sheets) {
                    throw new Error("API de Google Sheets no cargada correctamente. Verifica la consola.");
                }

                // Cargar datos de Jugadores
                const playersResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Jugadores!A:H',
                });
                allPlayersData = playersResponse.result.values ? playersResponse.result.values.slice(1) : [];

                // Cargar datos de Partidos
                const matchesResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Partidos!A:G',
                });
                allMatchesData = matchesResponse.result.values ? matchesResponse.result.values.slice(1) : [];

            } catch (err) {
                console.error('Error al cargar todos los datos:', err);
                let userErrorMessage = 'Error desconocido al cargar datos.';
                if (err && err.result && err.result.error && err.result.error.message) {
                    userErrorMessage = `Error al cargar datos: ${err.result.error.message}. Revisa la consola para más detalles.`;
                } else if (err && err.message) {
                    userErrorMessage = `Error al cargar datos: ${err.message}. Revisa la consola para más detalles.`;
                }
                throw new Error(userErrorMessage); // Propagar el error para que handleDataLoadSuccess lo maneje
            }
        }

        async function handleDataLoadSuccess() {
            // Este método se llama cuando la API de Google Sheets está lista para ser usada
            try {
                await loadAllData(); // Cargar todos los datos de la hoja
                
                // Mostrar el menú lateral y el contenido principal
                sideMenu.classList.remove('hidden'); 
                if (window.innerWidth >= 768) {
                    sideMenu.classList.add('open'); // Forzar 'open' en desktop para que sea visible
                    hamburgerButton.classList.add('hidden'); // Ocultar hamburguesa en desktop
                } else {
                    sideMenu.classList.remove('open'); // Asegurarse de que esté cerrado para el estado inicial móvil
                    hamburgerButton.classList.remove('hidden'); // Mostrar hamburguesa en móvil
                }

                // Configurar la navegación por pestañas y renderizar la activa por defecto
                setupTabNavigation();

            } catch (error) {
                console.error("Error al cargar datos iniciales:", error);
                let errorDetail;
                if (error && error.message) {
                    errorDetail = error.message;
                } else {
                    try {
                        errorDetail = JSON.stringify(error);
                    } catch (e) {
                        errorDetail = String(e); // Fallback a conversión simple a string
                    }
                }
                const errorMessageText = `Error al cargar datos: ${errorDetail}. Asegúrate de que la hoja sea accesible.`;
                document.getElementById('leaderboard-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('chamigo-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('tt-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('presentismo-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('ausentismo-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('estadisticas-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('equipos-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('fixture-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('individual-stats-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`; // New
            }
        }


        // --- Funciones de Pestañas ---
        function setupTabNavigation() {
            tabButtons.forEach(button => {
                button.removeEventListener('click', handleTabButtonClick); // Evitar duplicados
                button.addEventListener('click', handleTabButtonClick);
            });

            // Llenar y seleccionar automáticamente año y período/mes para todas las secciones
            populateAndSetCurrentPeriod('leaderboard-year-select', 'leaderboard-period-select', 'leaderboard');
            populateAndSetCurrentPeriod('chamigo-year-select', 'chamigo-period-select', 'chamigo');
            populateAndSetCurrentPeriod('tt-year-select', 'tt-period-select', 'tt');
            populateAndSetCurrentPeriod('presentismo-year-select', 'presentismo-period-select', 'presentismo');
            populateAndSetCurrentPeriod('ausentismo-year-select', 'ausentismo-period-select', 'ausentismo');
            populateAndSetCurrentPeriod('estadisticas-year-select', 'estadisticas-period-select', 'estadisticas');
            populateAndSetCurrentPeriod('equipos-year-select', 'equipos-period-select', 'equipos');
            
            // For fixture, we need to populate months instead of periods
            populateYearSelects('fixture-year-select', 'fixture');
            populateMonthSelects('fixture-month-select', 'fixture');

            // Setup individual player search
            setupPlayerSearch(); // New call

            // Determine which tab to activate based on URL hash
            let initialTabId = 'leaderboard-content'; // Default tab
            const hash = window.location.hash;
            if (hash && hashToTabMap[hash]) {
                initialTabId = hashToTabMap[hash];
            }

            // Activate the initial tab
            activateTab(initialTabId);

            // Add hashchange listener
            window.addEventListener('hashchange', handleHashChange);
        }

        function activateTab(tabId) {
            // Remove 'active' from all buttons and hide all contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            // Hide soccer field if not fixture tab
            if (tabId !== 'fixture-content') {
                soccerFieldContainer.classList.remove('field-active');
            }

            // Add 'active' to the corresponding button and show its content
            const targetButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            document.getElementById(tabId).classList.remove('hidden');

            // Render the specific content of the tab
            if (tabId === 'leaderboard-content') {
                renderLeaderboard();
            } else if (tabId === 'chamigo-content') {
                renderChamigoTable();
            } else if (tabId === 'tt-content') {
                renderTTTable();
            } else if (tabId === 'presentismo-content') {
                renderPresentismoTable();
            } else if (tabId === 'ausentismo-content') {
                renderAusentismoTable();
            } else if (tabId === 'estadisticas-content') {
                renderEstadisticasTable();
            } else if (tabId === 'equipos-content') {
                renderEquiposStats();
            } else if (tabId === 'fixture-content') {
                renderFixtureMatchCards();
                // After rendering cards, select the latest one
                const fixtureMatchesCardsContainer = document.getElementById('fixture-matches-cards-container');
                const latestMatchCard = fixtureMatchesCardsContainer.querySelector('[data-match-id]'); // First one is the latest due to sorting
                if (latestMatchCard) {
                    latestMatchCard.click(); // Simulate click to render details
                }
            } else if (tabId === 'individual-stats-content') {
                renderIndividualStatsTable();
            }
        }

        function handleTabButtonClick(event) {
            const clickedButton = event.currentTarget;
            const targetTabId = clickedButton.dataset.tab;

            // Update URL hash
            const hash = Object.keys(hashToTabMap).find(key => hashToTabMap[key] === targetTabId);
            if (hash && window.location.hash !== hash) {
                window.location.hash = hash;
            } else {
                // If hash is already correct or no hash mapping, just activate the tab
                activateTab(targetTabId);
            }

            // Close the side menu on mobile after selecting a tab
            if (window.innerWidth < 768) {
                toggleSideMenu();
            }
        }

        function handleHashChange() {
            const hash = window.location.hash;
            const targetTabId = hashToTabMap[hash];
            if (targetTabId) {
                activateTab(targetTabId);
            } else {
                // If hash is invalid or empty, default to leaderboard
                activateTab('leaderboard-content');
            }
        }

        // --- Toggle Side Menu Functionality ---
        function toggleSideMenu() {
            const isMobile = window.innerWidth < 768;
            if (isMobile) { // Only toggle on mobile
                sideMenu.classList.toggle('open');
                overlay.classList.toggle('open');
                document.body.classList.toggle('overflow-hidden'); // Evita el scroll del body
                if (sideMenu.classList.contains('open')) {
                    hamburgerButton.classList.add('hidden'); // Hide hamburger when sidebar opens on mobile
                } else {
                    hamburgerButton.classList.remove('hidden'); // Show hamburger when sidebar closes on mobile
                }
            }
        }

        // --- Helper Function: Filter Matches by Year and Period/Month ---
        function getFilteredMatches(yearSelectId, periodOrMonthSelectId, isMonthFilter = false) {
            const selectedYear = document.getElementById(yearSelectId).value;
            const selectedPeriodOrMonth = document.getElementById(periodOrMonthSelectId).value;

            console.log(`[getFilteredMatches] Called with Year: ${selectedYear}, Period/Month: ${selectedPeriodOrMonth}, IsMonthFilter: ${isMonthFilter}`); // Debug log

            return allMatchesData.filter(match => {
                const dateString = match[1]; // Fecha en formato DD/MM/YYYY
                if (!dateString) return false;

                const [day, month, year] = dateString.split('/').map(Number);
                const matchDate = new Date(year, month - 1, day); // Mes es 0-indexedado

                const matchYear = matchDate.getFullYear();
                const matchMonth = matchDate.getMonth(); // 0-11

                const yearMatch = selectedYear === 'all' || matchYear === parseInt(selectedYear);

                let periodOrMonthMatch = false;
                if (isMonthFilter) {
                    // For month filter
                    periodOrMonthMatch = selectedPeriodOrMonth === 'all' || matchMonth === (parseInt(selectedPeriodOrMonth) - 1); // Month is 1-indexed in select, 0-indexed in Date
                } else {
                    // For period filter (apertura, clausura, total)
                    if (selectedPeriodOrMonth === 'total') {
                        periodOrMonthMatch = true; // Todos los meses
                    } else if (selectedPeriodOrMonth === 'apertura') {
                        periodOrMonthMatch = matchMonth >= 0 && matchMonth <= 5; // Enero (0) a Junio (5)
                    } else if (selectedPeriodOrMonth === 'clausura') {
                        periodOrMonthMatch = matchMonth >= 6 && matchMonth <= 11; // Julio (6) a Diciembre (11)
                    }
                }
                return yearMatch && periodOrMonthMatch;
            });
        }

        // --- Centralized Stats Calculation ---
        function calculateStatsForPeriod(yearSelectId, periodSelectId) {
            const filteredMatches = getFilteredMatches(yearSelectId, periodSelectId, false); // Always use period filter here
            console.log(`[calculateStatsForPeriod] Filtered matches count: ${filteredMatches.length}`); // Debug log
            
            const playerStats = {};
            // Initialize all active players
            allPlayersData.filter(p => p[2] === 'Activo').forEach(player => {
                const [id, name] = player;
                playerStats[id] = {
                    name: name,
                    points: 0,
                    pg: 0, // Partidos Ganados
                    pe: 0, // Partidos Empatados
                    pp: 0, // Partidos Perdidos
                    pj: 0, // Partidos Jugados
                    efectividad: 0,
                    chamigos: 0,
                    tt: 0,
                    ausentes: 0,
                    id: id // Keep player ID for chamigo/TT lookup
                };
            });

            // Overall team stats for the period
            let clarosWins = 0;
            let oscurosWins = 0;
            let empates = 0;
            let suspendidos = 0;
            let totalPJMatches = 0; // Total matches played (not suspended)

            filteredMatches.forEach(match => {
                const [matchId, date, clarosIDsStr, oscurosIDsStr, result, chamigoVotosStr, ttAttendeesStr] = match;
                const clarosPlayers = clarosIDsStr.split(',').filter(Boolean);
                const oscurosPlayers = oscurosIDsStr.split(',').filter(Boolean);
                const allPlayersInMatch = [...new Set([...clarosPlayers, ...oscurosPlayers])];

                if (result !== 'Suspendido') {
                    totalPJMatches++;
                } else {
                    suspendidos++;
                }

                // Update player stats
                allPlayersInMatch.forEach(pId => {
                    if (playerStats[pId]) {
                        if (result !== 'Suspendido') {
                            playerStats[pId].pj += 1;
                        }
                    }
                });

                if (result === 'Claros') {
                    clarosWins++;
                    clarosPlayers.forEach(pId => {
                        if (playerStats[pId]) playerStats[pId].points += 3;
                        if (playerStats[pId]) playerStats[pId].pg += 1;
                    });
                    oscurosPlayers.forEach(pId => {
                        if (playerStats[pId]) playerStats[pId].pp += 1;
                    });
                } else if (result === 'Oscuros') {
                    oscurosWins++;
                    oscurosPlayers.forEach(pId => {
                        if (playerStats[pId]) playerStats[pId].points += 3;
                        if (playerStats[pId]) playerStats[pId].pg += 1;
                    });
                    clarosPlayers.forEach(pId => {
                        if (playerStats[pId]) playerStats[pId].pp += 1;
                    });
                } else if (result === 'Empate') {
                    empates++;
                    allPlayersInMatch.forEach(pId => {
                        if (playerStats[pId]) playerStats[pId].points += 1;
                        if (playerStats[pId]) playerStats[pId].pe += 1;
                    });
                }

                // Chamigo counts
                if (chamigoVotosStr) {
                    try {
                        const chamigoVotos = JSON.parse(chamigoVotosStr);
                        if (chamigoVotos.length > 0) {
                            const maxVotes = Math.max(...chamigoVotos.map(v => v.votos));
                            const chamigosDelPartido = chamigoVotos.filter(v => v.votos === maxVotes);
                            chamigosDelPartido.forEach(chamigo => {
                                if (playerStats[chamigo.id]) {
                                    playerStats[chamigo.id].chamigos += 1;
                                }
                            });
                        }
                    } catch (e) {
                        console.warn('Error al parsear votos de chamigo en el partido', matchId, ':', e);
                    }
                }

                // TT counts
                if (ttAttendeesStr) {
                    const ttAttendees = ttAttendeesStr.split(',').filter(Boolean);
                    ttAttendees.forEach(pId => {
                        if (playerStats[pId]) {
                            playerStats[pId].tt += 1;
                        }
                    });
                }
            });

            // Calculate Efectividad and Ausentes
            Object.values(playerStats).forEach(player => {
                // Efectividad
                const maxPossiblePoints = player.pj * 3;
                if (maxPossiblePoints > 0) {
                    player.efectividad = ((player.points / maxPossiblePoints) * 100).toFixed(2);
                } else {
                    player.efectividad = 0;
                }
                
                // Ausentes
                player.ausentes = totalPJMatches - player.pj;
                if (player.ausentes < 0) player.ausentes = 0; // Ensure it's not negative
            });

            const result = {
                players: Object.values(playerStats).filter(player => player.name), // Filter out any invalid player entries
                teamStats: {
                    clarosWins,
                    oscurosWins,
                    empates,
                    suspendidos,
                    totalPJMatches
                }
            };
            console.log('[calculateStatsForPeriod] Calculated Result:', result); // Debug log
            return result;
        }


        // --- Renderizar Tabla de Posiciones ---
        function renderLeaderboard() {
            const leaderboardTable = document.getElementById('leaderboard-table');
            const leaderboardTableBody = leaderboardTable.querySelector('tbody');
            const loadingMessage = document.getElementById('leaderboard-loading-message');

            leaderboardTableBody.innerHTML = '';
            leaderboardTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando tabla de posiciones...`;

            const { players: rankedPlayers } = calculateStatsForPeriod('leaderboard-year-select', 'leaderboard-period-select');

            // Ordenar por puntos (descendente)
            rankedPlayers.sort((a, b) => b.points - a.points);

            if (rankedPlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                leaderboardTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla
            rankedPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-3 text-center">${index + 1}</td>
                    <td class="py-3 px-3 text-left-player">${player.name}</td>
                    <td class="py-3 px-3 text-center">${player.points}</td>
                    <td class="py-3 px-3 text-center">${player.efectividad}%</td>
                `;
                leaderboardTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            leaderboardTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de Chamigo ---
        function renderChamigoTable() {
            const chamigoTable = document.getElementById('chamigo-table');
            const chamigoTableBody = chamigoTable.querySelector('tbody');
            const loadingMessage = document.getElementById('chamigo-loading-message');

            chamigoTableBody.innerHTML = '';
            chamigoTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando tabla de Chamigos...`;

            const { players: rankedChamigoPlayers } = calculateStatsForPeriod('chamigo-year-select', 'chamigo-period-select');

            // Ordenar por cantidad de chamigos (descendente)
            rankedChamigoPlayers.sort((a, b) => b.chamigos - a.chamigos);

            if (rankedChamigoPlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos de Chamigos disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                chamigoTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de Chamigo
            rankedChamigoPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-3 text-center">${index + 1}</td>
                    <td class="py-3 px-3 text-left-player">${player.name}</td>
                    <td class="py-3 px-3 text-center">${player.chamigos}</td>
                `;
                chamigoTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            chamigoTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de TT ---
        function renderTTTable() {
            const ttTable = document.getElementById('tt-table');
            const ttTableBody = ttTable.querySelector('tbody');
            const loadingMessage = document.getElementById('tt-loading-message');

            ttTableBody.innerHTML = '';
            ttTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando tabla de Asistencia TT...`;

            const { players: rankedTTPlayers } = calculateStatsForPeriod('tt-year-select', 'tt-period-select');

            // Ordenar por cantidad de TT (descendente)
            rankedTTPlayers.sort((a, b) => b.tt - a.tt);

            if (rankedTTPlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos de Asistencia TT disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                ttTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de TT
            rankedTTPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-3 text-center">${index + 1}</td>
                    <td class="py-3 px-3 text-left-player">${player.name}</td>
                    <td class="py-3 px-3 text-center">${player.tt}</td>
                `;
                ttTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            ttTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de Presentismo ---
        function renderPresentismoTable() {
            const presentismoTable = document.getElementById('presentismo-table');
            const presentismoTableBody = presentismoTable.querySelector('tbody');
            const loadingMessage = document.getElementById('presentismo-loading-message');

            presentismoTableBody.innerHTML = '';
            presentismoTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando tabla de Presentismo...`;

            const { players: rankedPJPlayers } = calculateStatsForPeriod('presentismo-year-select', 'presentismo-period-select');

            // Ordenar por PJ (descendente)
            rankedPJPlayers.sort((a, b) => b.pj - a.pj);

            if (rankedPJPlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos de Presentismo disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                presentismoTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de Presentismo
            rankedPJPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-3 text-center">${index + 1}</td>
                    <td class="py-3 px-3 text-left-player">${player.name}</td>
                    <td class="py-3 px-3 text-center">${player.pj}</td>
                `;
                presentismoTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            presentismoTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de Ausentismo ---
        function renderAusentismoTable() {
            const ausentismoTable = document.getElementById('ausentismo-table');
            const ausentismoTableBody = ausentismoTable.querySelector('tbody');
            const loadingMessage = document.getElementById('ausentismo-loading-message');

            ausentismoTableBody.innerHTML = '';
            ausentismoTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando tabla de Ausentismo...`;

            const { players: rankedAusentePlayers } = calculateStatsForPeriod('ausentismo-year-select', 'ausentismo-period-select');

            // Ordenar por Ausentes (descendente)
            rankedAusentePlayers.sort((a, b) => b.ausentes - a.ausentes);

            if (rankedAusentePlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos de Ausentismo disponibles para los filtros seleccionados.`;
                loadingMessage.classList.add('hidden');
                ausentismoTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de Ausentismo
            rankedAusentePlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-3 text-center">${index + 1}</td>
                    <td class="py-3 px-3 text-left-player">${player.name}</td>
                    <td class="py-3 px-3 text-center">${player.ausentes}</td>
                `;
                ausentismoTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            ausentismoTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de Estadísticas ---
        function renderEstadisticasTable() {
            const estadisticasTable = document.getElementById('estadisticas-table');
            const estadisticasTableBody = estadisticasTable.querySelector('tbody');
            const loadingMessage = document.getElementById('estadisticas-loading-message');
            const sortCriterionSelect = document.getElementById('estadisticas-sort-criterion');
            const sortOrderSelect = document.getElementById('estadisticas-sort-order');

            estadisticasTableBody.innerHTML = '';
            estadisticasTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando estadísticas...`;

            const { players: rankedEstadisticasPlayers } = calculateStatsForPeriod('estadisticas-year-select', 'estadisticas-period-select');

            // Get selected sort criterion and order
            const sortCriterion = sortCriterionSelect.value;
            const sortOrder = sortOrderSelect.value;

            // Sort players based on selected criterion and order
            rankedEstadisticasPlayers.sort((a, b) => {
                let valA = a[sortCriterion];
                let valB = b[sortCriterion];

                // Special handling for 'efectividad' as it's a string with '%'
                if (sortCriterion === 'efectividad') {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                }

                if (sortOrder === 'asc') {
                    return valA - valB;
                } else {
                    return valB - valA;
                }
            });

            if (rankedEstadisticasPlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos de Estadísticas disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                estadisticasTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de Estadísticas
            rankedEstadisticasPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-3 text-center">${index + 1}</td>
                    <td class="py-3 px-3 text-left-player">${player.name}</td>
                    <td class="py-3 px-3 text-center">${player.points}</td>
                    <td class="py-3 px-3 text-center">${player.pg}</td>
                    <td class="py-3 px-3 text-center">${player.pe}</td>
                    <td class="py-3 px-3 text-center">${player.pp}</td>
                    <td class="py-3 px-3 text-center">${player.pj}</td>
                    <td class="py-3 px-3 text-center">${player.efectividad}%</td>
                    <td class="py-3 px-3 text-center">${player.chamigos}</td>
                    <td class="py-3 px-3 text-center">${player.tt}</td>
                    <td class="py-3 px-3 text-center">${player.ausentes}</td>
                `;
                estadisticasTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            estadisticasTable.classList.remove('hidden');
        }

        // --- Renderizar Estadísticas de Equipos ---
        function renderEquiposStats() {
            const equiposStatsDisplay = document.getElementById('equipos-stats-display');
            const loadingMessage = document.getElementById('equipos-loading-message');

            // 1. Mostrar mensaje de carga y ocultar display de stats
            loadingMessage.classList.remove('hidden');
            equiposStatsDisplay.classList.add('hidden');
            equiposStatsDisplay.innerHTML = ''; // Limpiar contenido anterior
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando estadísticas de equipos...`;

            console.log('[renderEquiposStats] Starting render...'); // Debug log
            const { teamStats } = calculateStatsForPeriod('equipos-year-select', 'equipos-period-select');
            console.log('[renderEquiposStats] Calculated teamStats:', teamStats); // Debug log

            // 2. Ocultar mensaje de carga
            loadingMessage.classList.add('hidden');

            // 3. Siempre construir y mostrar las tarjetas de estadísticas, incluso if los valores son 0
            const statsHtml = `
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                    <span class="text-3xl font-bold">${teamStats.oscurosWins}</span>
                    <span class="text-sm uppercase">Oscuros Ganados</span>
                </div>
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                    <span class="text-3xl font-bold">${teamStats.clarosWins}</span>
                    <span class="text-sm uppercase">Claros Ganados</span>
                </div>
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                    <span class="text-3xl font-bold">${teamStats.empates}</span>
                    <span class="text-sm uppercase">Empates</span>
                </div>
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                    <span class="text-3xl font-bold">${teamStats.suspendidos}</span>
                    <span class="text-sm uppercase">Suspendidos</span>
                </div>
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                    <span class="text-3xl font-bold">${teamStats.totalPJMatches}</span>
                    <span class="text-sm uppercase">Partidos Jugados</span>
                </div>
            `;
            equiposStatsDisplay.innerHTML = statsHtml;
            equiposStatsDisplay.classList.remove('hidden'); // Mostrar el contenedor de stats
            console.log('[renderEquiposStats] Stats rendered successfully.'); // Debug log
        }

        // --- Fixture Functions ---
        function renderFixtureMatchCards() {
            const fixtureMatchesCardsContainer = document.getElementById('fixture-matches-cards-container');
            const fixtureYearSelect = document.getElementById('fixture-year-select');
            const fixtureMonthSelect = document.getElementById('fixture-month-select');
            const loadingMessage = document.getElementById('fixture-loading-message');
            const fixtureDetailsDisplay = document.getElementById('fixture-details-display');
            
            // Hide soccer field and details when re-rendering cards
            soccerFieldContainer.classList.remove('field-active'); // Use new class
            fixtureDetailsDisplay.classList.add('hidden'); 
            soccerFieldContainer.innerHTML = `
                <div class="goal top"></div>
                <div class="goal bottom"></div>
                <div class="penalty-area top"></div>
                <div class="penalty-area bottom"></div>
                <div class="goal-area top"></div>
                <div class="goal-area bottom"></div>
            `; // Reset field elements

            fixtureMatchesCardsContainer.innerHTML = ''; // Clear previous cards
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando partidos...`;

            const filteredMatches = getFilteredMatches(fixtureYearSelect.id, fixtureMonthSelect.id, true); // Use month filter
            console.log(`[renderFixtureMatchCards] Found ${filteredMatches.length} matches for selection.`);

            if (filteredMatches.length === 0) {
                loadingMessage.innerHTML = `No hay partidos disponibles para los filtros seleccionados.`;
                return;
            }

            // Sort matches by date descending (most recent first)
            filteredMatches.sort((a, b) => parseDate(b[1]).getTime() - parseDate(a[1]).getTime());

            filteredMatches.forEach(match => {
                const [matchId, date, clarosIDsStr, oscurosIDsStr, result] = match;
                const cardHtml = `
                    <div class="bg-white p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-100 transition duration-150 ease-in-out" data-match-id="${matchId}">
                        <h4 class="font-semibold text-lg text-indigo-700 mb-2">Partido del ${date}</h4>
                        <p class="text-gray-600">Ganador: ${result || 'No definido'}</p>
                    </div>
                `;
                fixtureMatchesCardsContainer.innerHTML += cardHtml;
            });

            // Add event listeners to each newly created card
            fixtureMatchesCardsContainer.querySelectorAll('[data-match-id]').forEach(card => {
                card.addEventListener('click', (event) => {
                    const matchId = event.currentTarget.dataset.matchId;
                    renderFixtureDetails(matchId);
                });
            });

            loadingMessage.classList.add('hidden');
            fixtureMatchesCardsContainer.classList.remove('hidden'); // Ensure container is visible
        }

        function renderFixtureDetails(matchId) {
            const fixtureDetailsDisplay = document.getElementById('fixture-details-display');
            const loadingMessage = document.getElementById('fixture-loading-message');
            const ttAttendeesTableBody = document.querySelector('#tt-attendees-table tbody');


            loadingMessage.classList.remove('hidden');
            fixtureDetailsDisplay.classList.add('hidden');
            soccerFieldContainer.classList.remove('field-active'); // Hide field while loading
            
            // Clear only player markers and trophy from field
            soccerFieldContainer.querySelectorAll('.player-marker, .winner-trophy').forEach(el => el.remove());
            ttAttendeesTableBody.innerHTML = ''; // Clear previous TT attendees

            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando detalles del partido...`;
            
            const selectedMatch = allMatchesData.find(match => match[0] === matchId);

            if (!selectedMatch) {
                loadingMessage.innerHTML = `Detalles del partido no encontrados.`;
                return;
            }

            const [id, date, clarosIDsStr, oscurosIDsStr, result, chamigoVotosStr, ttAttendeesStr] = selectedMatch;

            // Helper to get player names from IDs
            const getPlayerNames = (idsString) => {
                if (!idsString || idsString.trim() === '') return []; // Return empty array for empty string
                const ids = idsString.split(',').filter(Boolean);
                return ids.map(playerId => {
                    const player = allPlayersData.find(p => p[0] === playerId);
                    return player ? player[1] : `ID Desconocido (${playerId})`;
                }).filter(Boolean); // Filter out any null/undefined names
            };

            const clarosPlayerIDs = clarosIDsStr.split(',').filter(Boolean);
            const oscurosPlayerIDs = oscurosIDsStr.split(',').filter(Boolean);
            const winnerTeam = result || 'No definido';

            let ttAttendees = getPlayerNames(ttAttendeesStr);
            // Populate TT attendees table
            if (ttAttendees.length > 0) {
                ttAttendees.forEach(name => {
                    const rowHTML = `
                        <td class="py-3 px-3 text-left-player">${name}</td>
                    `;
                    ttAttendeesTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
                });
            } else {
                ttAttendeesTableBody.innerHTML = `<tr><td class="py-3 px-3 text-center" colspan="1">No hay asistentes al TT registrados.</td></tr>`;
            }


            let chamigosIds = [];
            if (chamigoVotosStr) {
                try {
                    const chamigoVotos = JSON.parse(chamigoVotosStr);
                    if (chamigoVotos.length > 0) {
                        const maxVotes = Math.max(...chamigoVotos.map(v => v.votos));
                        const chamigosDelPartido = chamigoVotos.filter(v => v.votos === maxVotes);
                        chamigosIds = chamigosDelPartido.map(chamigo => chamigo.id);
                    }
                } catch (e) {
                    console.warn('Error al parsear votos de chamigo en el partido', id, ':', e);
                }
            }

            // Re-add goals and areas to the field (if they were removed, ensuring they are present)
            if (soccerFieldContainer.children.length === 0 || soccerFieldContainer.querySelector('.goal') === null) {
                soccerFieldContainer.innerHTML = `
                    <div class="goal top"></div>
                    <div class="goal bottom"></div>
                    <div class="penalty-area top"></div>
                    <div class="penalty-area bottom"></div>
                    <div class="goal-area top"></div>
                    <div class="goal-area bottom"></div>
                `;
            }

            // Determine field orientation based on its rendered dimensions
            // This is more robust as it reflects how CSS media queries are applied
            const fieldWidth = soccerFieldContainer.offsetWidth;
            const fieldHeight = soccerFieldContainer.offsetHeight;
            const isHorizontalField = fieldWidth > fieldHeight;
            console.log(`[renderFixtureDetails] Field dimensions: ${fieldWidth}x${fieldHeight}, isHorizontalField: ${isHorizontalField}`); // Debug log


            // Normalized positions (0 to 1, relative to field width/height)
            // These are for a vertical field (height > width)
            const clarosNormalizedPositionsPortrait = [
                { x: 0.5, y: 0.88 }, // Goalkeeper
                { x: 0.25, y: 0.75 }, // Defender 1 (moved slightly left)
                { x: 0.75, y: 0.75 }, // Defender 2 (moved slightly right)
                { x: 0.35, y: 0.60 }, // Midfielder/Forward 1 (moved slightly left)
                { x: 0.65, y: 0.60 }   // Midfielder/Forward 2 (moved slightly right)
            ];
            const oscurosNormalizedPositionsPortrait = [
                { x: 0.5, y: 0.12 }, // Goalkeeper
                { x: 0.25, y: 0.25 }, // Defender 1 (moved slightly left)
                { x: 0.75, y: 0.25 }, // Defender 2 (moved slightly right)
                { x: 0.35, y: 0.40 }, // Midfielder/Forward 1 (moved slightly left)
                { x: 0.65, y: 0.40 }  // Midfielder/Forward 2 (moved slightly right)
            ];

            // Normalized positions (0 to 1, relative to field width/height)
            // These are for a horizontal field (width > height)
            const clarosNormalizedPositionsLandscape = [
                { x: 0.90, y: 0.50 }, // Goalkeeper (far right, center)
                { x: 0.75, y: 0.35 }, // Defender 1 (right, slightly above center)
                { x: 0.75, y: 0.65 }, // Defender 2 (right, slightly below center)
                { x: 0.60, y: 0.40 }, // Midfielder/Forward 1 (mid-right, slightly above center)
                { x: 0.60, y: 0.60 }   // Midfielder/Forward 2 (mid-right, slightly below center)
            ];
            const oscurosNormalizedPositionsLandscape = [
                { x: 0.10, y: 0.50 }, // Goalkeeper (far left, center)
                { x: 0.25, y: 0.35 }, // Defender 1 (left, slightly above center)
                { x: 0.25, y: 0.65 }, // Defender 2 (left, slightly below center)
                { x: 0.40, y: 0.40 }, // Midfielder/Forward 1 (mid-left, slightly above center)
                { x: 0.40, y: 0.60 }  // Midfielder/Forward 2 (mid-left, slightly below center)
            ];

            const currentClarosNormalizedPositions = isHorizontalField ? clarosNormalizedPositionsLandscape : clarosNormalizedPositionsPortrait;
            const currentOscurosNormalizedPositions = isHorizontalField ? oscurosNormalizedPositionsLandscape : oscurosNormalizedPositionsPortrait;

            // Add Claros players
            clarosPlayerIDs.slice(0, 5).forEach((playerId, index) => {
                const playerDiv = document.createElement('div');
                const playerName = allPlayersData.find(p => p[0] === playerId)?.[1]; // Get actual player name
                if (!playerName) return; // Skip if player not found

                playerDiv.classList.add('player-marker', 'claros');
                playerDiv.innerHTML = `<span class="player-name">${playerName.split(' ')[0]}</span> ${chamigosIds.includes(playerId) ? '<i class="fas fa-star text-yellow-400"></i>' : ''}`; // Add star if Chamigo
                playerDiv.style.top = `${currentClarosNormalizedPositions[index].y * 100}%`;
                playerDiv.style.left = `${currentClarosNormalizedPositions[index].x * 100}%`;
                soccerFieldContainer.appendChild(playerDiv);
            });

            // Add Oscuros players
            oscurosPlayerIDs.slice(0, 5).forEach((playerId, index) => {
                const playerDiv = document.createElement('div');
                const playerName = allPlayersData.find(p => p[0] === playerId)?.[1]; // Get actual player name
                if (!playerName) return; // Skip if player not found

                playerDiv.classList.add('player-marker', 'oscuros');
                playerDiv.innerHTML = `<span class="player-name">${playerName.split(' ')[0]}</span> ${chamigosIds.includes(playerId) ? '<i class="fas fa-star text-yellow-400"></i>' : ''}`; // Add star if Chamigo
                playerDiv.style.top = `${currentOscurosNormalizedPositions[index].y * 100}%`;
                playerDiv.style.left = `${currentOscurosNormalizedPositions[index].x * 100}%`;
                soccerFieldContainer.appendChild(playerDiv);
            });

            // Add Winner Trophy
            if (winnerTeam !== 'No definido' && winnerTeam !== 'Empate' && winnerTeam !== 'Suspendido') {
                const trophyDiv = document.createElement('div');
                trophyDiv.classList.add('winner-trophy');
                trophyDiv.innerHTML = '<i class="fas fa-trophy"></i>';
                
                // Determine position based on field orientation and winning team
                if (isHorizontalField) { // Desktop or mobile landscape
                    if (winnerTeam === 'Claros') {
                        trophyDiv.style.top = '10%'; // Top-right corner (Claros' side)
                        trophyDiv.style.left = '90%'; 
                    } else if (winnerTeam === 'Oscuros') {
                        trophyDiv.style.top = '10%'; // Top-left corner (Oscuros' side)
                        trophyDiv.style.left = '10%'; 
                    }
                } else { // Mobile portrait
                    if (winnerTeam === 'Claros') {
                        trophyDiv.style.top = '90%'; // Bottom-left
                        trophyDiv.style.left = '10%'; 
                    } else if (winnerTeam === 'Oscuros') {
                        trophyDiv.style.top = '10%'; // Top-right
                        trophyDiv.style.left = '90%'; 
                    }
                }
                soccerFieldContainer.appendChild(trophyDiv);
            }

            // Show soccer field
            soccerFieldContainer.classList.add('field-active'); // Use new class

            loadingMessage.classList.add('hidden');
            fixtureDetailsDisplay.classList.remove('hidden');
        }

        // --- Utilidades ---
        function parseDate(dateString) {
            const [day, month, year] = dateString.split('/').map(Number);
            return new Date(year, month - 1, day);
        }

        function parseYYYYMMDDToLocalDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function formatDateToDDMMYYYY(date) {
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const yyyy = date.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }


        function populateYearSelects(selectId, storageKeyPrefix) {
            const yearSelect = document.getElementById(selectId);
            const years = new Set();
            allMatchesData.forEach(match => {
                const dateString = match[1];
                if (dateString) {
                    const date = parseDate(dateString);
                    years.add(date.getFullYear());
                }
            });

            const sortedYears = Array.from(years).sort((a, b) => b - a);

            yearSelect.innerHTML = '';
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'Todos los Años';
            yearSelect.appendChild(allOption);

            if (sortedYears.length > 0) {
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            }

            // Restore from localStorage
            const storedYear = localStorage.getItem(`${storageKeyPrefix}-year`);
            if (storedYear && Array.from(yearSelect.options).some(option => option.value === storedYear)) {
                yearSelect.value = storedYear;
            } else {
                // Set current year as default if no stored value or invalid
                const today = new Date();
                const currentYear = today.getFullYear();
                const yearOption = Array.from(yearSelect.options).find(option => parseInt(option.value) === currentYear);
                if (yearOption) {
                    yearSelect.value = currentYear;
                } else {
                    yearSelect.value = 'all';
                }
            }

            // Save to localStorage on change
            yearSelect.addEventListener('change', () => {
                localStorage.setItem(`${storageKeyPrefix}-year`, yearSelect.value);
            });
        }

        function populateMonthSelects(selectId, storageKeyPrefix) {
            const monthSelect = document.getElementById(selectId);
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];

            monthSelect.innerHTML = '';
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'Todos los Meses';
            monthSelect.appendChild(allOption);

            months.forEach((monthName, index) => {
                const option = document.createElement('option');
                option.value = index + 1; // Month is 1-indexed for value
                option.textContent = monthName;
                monthSelect.appendChild(option);
            });

            // Restore from localStorage
            const storedMonth = localStorage.getItem(`${storageKeyPrefix}-month`);
            if (storedMonth && Array.from(monthSelect.options).some(option => option.value === storedMonth)) {
                monthSelect.value = storedMonth;
            } else {
                // Set current month as default
                const today = new Date();
                const currentMonth = today.getMonth() + 1; // getMonth is 0-indexed
                const monthOption = Array.from(monthSelect.options).find(option => parseInt(option.value) === currentMonth);
                if (monthOption) {
                    monthSelect.value = currentMonth;
                } else {
                    monthSelect.value = 'all';
                }
            }

            // Save to localStorage on change
            monthSelect.addEventListener('change', () => {
                localStorage.setItem(`${storageKeyPrefix}-month`, monthSelect.value);
            });
        }


        function populateAndSetCurrentPeriod(yearSelectId, periodSelectId, storageKeyPrefix) {
            populateYearSelects(yearSelectId, storageKeyPrefix); // First populate years

            const periodSelect = document.getElementById(periodSelectId);
            
            // Restore from localStorage
            const storedPeriod = localStorage.getItem(`${storageKeyPrefix}-period`);
            if (storedPeriod && Array.from(periodSelect.options).some(option => option.value === storedPeriod)) {
                periodSelect.value = storedPeriod;
            } else {
                // Set current period based on current month if no stored value or invalid
                const today = new Date();
                const currentMonth = today.getMonth(); // 0-indexed
                if (currentMonth >= 0 && currentMonth <= 5) { // January to June (Apertura)
                    periodSelect.value = 'apertura';
                } else if (currentMonth >= 6 && currentMonth <= 11) { // July to December (Clausura)
                    periodSelect.value = 'clausura';
                } else {
                    periodSelect.value = 'total';
                }
            }

            // Save to localStorage on change
            periodSelect.addEventListener('change', () => {
                localStorage.setItem(`${storageKeyPrefix}-period`, periodSelect.value);
            });
        }

        // New function to calculate individual player stats
        function calculateIndividualPlayerStats(playerId) {
            const playerStats = {
                years: {},
                overallTotal: { points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: 0, chamigos: 0, tt: 0, ausentes: 0 }
            };

            const playerInfo = allPlayersData.find(p => p[0] === playerId);
            if (!playerInfo) return null; // Player not found

            const playerName = playerInfo[1];

            // Get all years present in matches data
            const allYearsInMatches = new Set();
            allMatchesData.forEach(match => {
                const dateString = match[1];
                if (dateString) {
                    const [day, month, year] = dateString.split('/').map(Number);
                    allYearsInMatches.add(year);
                }
            });

            // Initialize stats for all years and periods for the selected player
            Array.from(allYearsInMatches).sort().forEach(year => {
                playerStats.years[year] = {
                    apertura: { points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: 0, chamigos: 0, tt: 0, ausentes: 0 },
                    clausura: { points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: 0, chamigos: 0, tt: 0, ausentes: 0 },
                    total: { points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: 0, chamigos: 0, tt: 0, ausentes: 0 }
                };
            });

            // Calculate stats for each match
            allMatchesData.forEach(match => {
                const [matchId, dateString, clarosIDsStr, oscurosIDsStr, result, chamigoVotosStr, ttAttendeesStr] = match;
                if (!dateString) return;

                const [day, month, year] = dateString.split('/').map(Number);
                const matchDate = new Date(year, month - 1, day); // Month is 0-indexed
                const matchYear = matchDate.getFullYear();
                const matchMonth = matchDate.getMonth(); // 0-11

                const period = (matchMonth >= 0 && matchMonth <= 5) ? 'apertura' : 'clausura';

                const clarosPlayers = clarosIDsStr.split(',').filter(Boolean);
                const oscurosPlayers = oscurosIDsStr.split(',').filter(Boolean);
                const allPlayersInMatch = [...new Set([...clarosPlayers, ...oscurosPlayers])];

                const isPlayerInMatch = allPlayersInMatch.includes(playerId);

                if (playerStats.years[matchYear] && isPlayerInMatch) {
                    const currentYearStats = playerStats.years[matchYear];
                    const currentPeriodStats = currentYearStats[period];
                    const currentYearTotalStats = currentYearStats.total;

                    // Update PJ (Partidos Jugados) if match is not suspended
                    if (result !== 'Suspendido') {
                        currentPeriodStats.pj += 1;
                        currentYearTotalStats.pj += 1;
                        playerStats.overallTotal.pj += 1;
                    }

                    // Update points based on match result
                    if (result === 'Claros' && clarosPlayers.includes(playerId)) {
                        currentPeriodStats.points += 3;
                        currentPeriodStats.pg += 1;
                        currentYearTotalStats.points += 3;
                        currentYearTotalStats.pg += 1;
                        playerStats.overallTotal.points += 3;
                        playerStats.overallTotal.pg += 1;
                    } else if (result === 'Oscuros' && oscurosPlayers.includes(playerId)) {
                        currentPeriodStats.points += 3;
                        currentPeriodStats.pg += 1;
                        currentYearTotalStats.points += 3;
                        currentYearTotalStats.pg += 1;
                        playerStats.overallTotal.points += 3;
                        playerStats.overallTotal.pg += 1;
                    } else if (result === 'Empate' && isPlayerInMatch) {
                        currentPeriodStats.points += 1;
                        currentPeriodStats.pe += 1;
                        currentYearTotalStats.points += 1;
                        currentYearTotalStats.pe += 1;
                        playerStats.overallTotal.points += 1;
                        playerStats.overallTotal.pe += 1;
                    } else if (result === 'Claros' && oscurosPlayers.includes(playerId)) { // Player was in losing team
                        currentPeriodStats.pp += 1;
                        currentYearTotalStats.pp += 1;
                        playerStats.overallTotal.pp += 1;
                    } else if (result === 'Oscuros' && clarosPlayers.includes(playerId)) { // Player was in losing team
                        currentPeriodStats.pp += 1;
                        currentYearTotalStats.pp += 1;
                        playerStats.overallTotal.pp += 1;
                    }

                    // Chamigo counts
                    if (chamigoVotosStr) {
                        try {
                            const chamigoVotos = JSON.parse(chamigoVotosStr);
                            if (chamigoVotos.some(v => v.id === playerId && v.votos === Math.max(...chamigoVotos.map(c => c.votos)))) {
                                currentPeriodStats.chamigos += 1;
                                currentYearTotalStats.chamigos += 1;
                                playerStats.overallTotal.chamigos += 1;
                            }
                        } catch (e) {
                            console.warn('Error parsing chamigo votes for match', matchId, ':', e);
                        }
                    }

                    // TT counts
                    if (ttAttendeesStr) {
                        const ttAttendees = ttAttendeesStr.split(',').filter(Boolean);
                        if (ttAttendees.includes(playerId)) {
                            currentPeriodStats.tt += 1;
                            currentYearTotalStats.tt += 1;
                            playerStats.overallTotal.tt += 1;
                        }
                    }
                }
            });

            // Calculate Efectividad and Ausentes for each period, year total, and overall total
            Array.from(allYearsInMatches).sort().forEach(year => {
                const yearStats = playerStats.years[year];
                ['apertura', 'clausura'].forEach(periodType => { // Only iterate through apertura/clausura for individual periods
                    const stats = yearStats[periodType];
                    const maxPossiblePoints = stats.pj * 3;
                    if (maxPossiblePoints > 0) {
                        stats.efectividad = ((stats.points / maxPossiblePoints) * 100).toFixed(2);
                    } else {
                        stats.efectividad = 0;
                    }
                    
                    const totalMatchesInPeriod = allMatchesData.filter(m => {
                        const [d, mo, y] = m[1].split('/').map(Number);
                        const matchDate = new Date(y, mo - 1, d);
                        const mYear = matchDate.getFullYear();
                        const mMonth = matchDate.getMonth();
                        const mPeriod = (mMonth >= 0 && mMonth <= 5) ? 'apertura' : 'clausura';
                        
                        return mYear === year && mPeriod === periodType && m[4] !== 'Suspendido';
                    }).length;

                    stats.ausentes = totalMatchesInPeriod - stats.pj;
                    if (stats.ausentes < 0) stats.ausentes = 0;
                });

                // Calculate for year total
                const yearTotalStats = yearStats.total;
                const yearTotalMaxPossiblePoints = yearTotalStats.pj * 3;
                if (yearTotalMaxPossiblePoints > 0) {
                    yearTotalStats.efectividad = ((yearTotalStats.points / yearTotalMaxPossiblePoints) * 100).toFixed(2);
                } else {
                    yearTotalStats.efectividad = 0;
                }
                const totalMatchesInYear = allMatchesData.filter(m => {
                    const [d, mo, y] = m[1].split('/').map(Number);
                    return y === year && m[4] !== 'Suspendido';
                }).length;
                yearTotalStats.ausentes = totalMatchesInYear - yearTotalStats.pj;
                if (yearTotalStats.ausentes < 0) yearTotalStats.ausentes = 0;
            });

            // Overall total efectividad and ausentes
            const overallMaxPossiblePoints = playerStats.overallTotal.pj * 3;
            if (overallMaxPossiblePoints > 0) {
                playerStats.overallTotal.efectividad = ((playerStats.overallTotal.points / overallMaxPossiblePoints) * 100).toFixed(2);
            } else {
                playerStats.overallTotal.efectividad = 0;
            }
            const totalNonSuspendedMatches = allMatchesData.filter(m => m[4] !== 'Suspendido').length;
            playerStats.overallTotal.ausentes = totalNonSuspendedMatches - playerStats.overallTotal.pj;
            if (playerStats.overallTotal.ausentes < 0) playerStats.overallTotal.ausentes = 0;


            return { playerName, stats: playerStats };
        }

        // New function to set up player search with autocomplete
        function setupPlayerSearch() {
            const playerSearchInput = document.getElementById('individual-player-search');
            const playerResultsDiv = document.getElementById('individual-player-results');
            const selectedPlayerIdInput = document.getElementById('selected-player-id');
            let timeoutId; // To debounce input
            let highlightedIndex = -1; // To keep track of the highlighted item for keyboard navigation

            // Helper to remove highlight from all results
            const removeHighlight = () => {
                playerResultsDiv.querySelectorAll('.highlighted').forEach(item => {
                    item.classList.remove('highlighted');
                });
            };

            // Helper to apply highlight to a specific index
            const highlightResult = (index) => {
                removeHighlight();
                const results = playerResultsDiv.children;
                if (results.length > 0 && index >= 0 && index < results.length) {
                    results[index].classList.add('highlighted');
                    playerSearchInput.value = results[index].textContent; // Update input value
                    highlightedIndex = index;
                }
            };

            // Clear input on focus
            playerSearchInput.addEventListener('focus', () => {
                playerSearchInput.value = '';
                selectedPlayerIdInput.value = '';
                playerResultsDiv.innerHTML = ''; // Clear results when focusing
                playerResultsDiv.classList.add('hidden');
                document.getElementById('individual-stats-table').classList.add('hidden');
                document.getElementById('individual-stats-loading-message').classList.remove('hidden');
                document.getElementById('individual-stats-loading-message').textContent = 'Escribe al menos 3 caracteres para buscar un jugador.';
                highlightedIndex = -1; // Reset highlight
            });

            playerSearchInput.addEventListener('input', () => {
                clearTimeout(timeoutId);
                const searchTerm = playerSearchInput.value.toLowerCase();
                
                removeHighlight(); // Clear highlight on new input
                highlightedIndex = -1; // Reset highlight index

                if (searchTerm.length < 3) {
                    playerResultsDiv.innerHTML = '';
                    playerResultsDiv.classList.add('hidden');
                    selectedPlayerIdInput.value = ''; // Clear selected player if search term is too short
                    document.getElementById('individual-stats-table').classList.add('hidden');
                    document.getElementById('individual-stats-loading-message').classList.remove('hidden');
                    document.getElementById('individual-stats-loading-message').textContent = 'Escribe al menos 3 caracteres para buscar un jugador.';
                    return;
                }

                timeoutId = setTimeout(() => {
                    playerResultsDiv.innerHTML = '';
                    const filteredPlayers = allPlayersData.filter(p => 
                        p[2] === 'Activo' && p[1].toLowerCase().includes(searchTerm)
                    ).sort((a, b) => a[1].localeCompare(b[1]));

                    if (filteredPlayers.length > 0) {
                        filteredPlayers.forEach(player => {
                            const resultItem = document.createElement('div');
                            resultItem.classList.add('p-2', 'cursor-pointer', 'hover:bg-gray-100');
                            resultItem.textContent = player[1];
                            resultItem.dataset.playerId = player[0]; // Store player ID
                            resultItem.addEventListener('click', () => {
                                playerSearchInput.value = player[1];
                                selectedPlayerIdInput.value = resultItem.dataset.playerId; 
                                playerResultsDiv.classList.add('hidden');
                                highlightedIndex = -1; // Reset highlight after selection
                                renderIndividualStatsTable();
                            });
                            playerResultsDiv.appendChild(resultItem);
                        });
                        playerResultsDiv.classList.remove('hidden');
                    } else {
                        playerResultsDiv.classList.add('hidden');
                    }
                }, 300); // Debounce for 300ms
            });

            // Keyboard navigation
            playerSearchInput.addEventListener('keydown', (event) => {
                const results = playerResultsDiv.children;
                if (results.length === 0) return;

                if (event.key === 'ArrowDown') {
                    event.preventDefault(); // Prevent cursor movement in input
                    highlightedIndex = (highlightedIndex + 1) % results.length;
                    highlightResult(highlightedIndex);
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault(); // Prevent cursor movement in input
                    highlightedIndex = (highlightedIndex - 1 + results.length) % results.length;
                    highlightResult(highlightedIndex);
                } else if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent form submission
                    if (highlightedIndex !== -1) {
                        results[highlightedIndex].click(); // Simulate click on highlighted item
                    } else if (results.length > 0) {
                        // If no item is explicitly highlighted, but results are visible, select the first one
                        results[0].click();
                    }
                }
            });

            // Hide results when input loses focus (with a slight delay to allow click on results)
            playerSearchInput.addEventListener('focusout', () => {
                setTimeout(() => {
                    playerResultsDiv.classList.add('hidden');
                }, 200);
            });

            // Initial state: check if a player was previously selected and populate input
            const lastSelectedPlayerId = localStorage.getItem('individual-player-selected');
            if (lastSelectedPlayerId) {
                const lastSelectedPlayer = allPlayersData.find(p => p[0] === lastSelectedPlayerId);
                if (lastSelectedPlayer) {
                    playerSearchInput.value = lastSelectedPlayer[1];
                    selectedPlayerIdInput.value = lastSelectedPlayerId;
                    // renderIndividualStatsTable will be called when the tab is activated
                }
            } else {
                document.getElementById('individual-stats-table').classList.add('hidden');
                document.getElementById('individual-stats-loading-message').classList.remove('hidden');
                document.getElementById('individual-stats-loading-message').textContent = 'Selecciona un jugador para ver sus estadísticas.';
            }
        }

        // Function to render the individual stats table
        function renderIndividualStatsTable() {
            const selectedPlayerId = document.getElementById('selected-player-id').value;
            const individualStatsTable = document.getElementById('individual-stats-table');
            const individualStatsTableBody = individualStatsTable.querySelector('tbody');
            const loadingMessage = document.getElementById('individual-stats-loading-message');

            individualStatsTableBody.innerHTML = ''; // Clear previous content
            individualStatsTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando estadísticas individuales...`;

            if (!selectedPlayerId) {
                loadingMessage.textContent = 'Selecciona un jugador para ver sus estadísticas.';
                return;
            }

            // Save selected player to localStorage
            localStorage.setItem('individual-player-selected', selectedPlayerId);

            const playerStatsData = calculateIndividualPlayerStats(selectedPlayerId);

            if (!playerStatsData || (!Object.keys(playerStatsData.stats.years).length && playerStatsData.stats.overallTotal.pj === 0)) {
                loadingMessage.textContent = 'No hay datos disponibles para el jugador seleccionado.';
                return;
            }

            // Render TOTAL row first, always visible
            const totalStats = playerStatsData.stats.overallTotal;
            individualStatsTableBody.innerHTML += `
                <tr class="bg-indigo-100 font-bold text-indigo-800">
                    <td class="py-3 px-3 text-center">TOTAL</td>
                    <td class="py-3 px-3 text-center">N/A</td>
                    <td class="py-3 px-3 text-center">${totalStats.points}</td>
                    <td class="py-3 px-3 text-center">${totalStats.pg}</td>
                    <td class="py-3 px-3 text-center">${totalStats.pe}</td>
                    <td class="py-3 px-3 text-center">${totalStats.pp}</td>
                    <td class="py-3 px-3 text-center">${totalStats.pj}</td>
                    <td class="py-3 px-3 text-center">${totalStats.efectividad}%</td>
                    <td class="py-3 px-3 text-center">${totalStats.chamigos}</td>
                    <td class="py-3 px-3 text-center">${totalStats.tt}</td>
                    <td class="py-3 px-3 text-center">${totalStats.ausentes}</td>
                </tr>
            `;

            // Render stats grouped by year and period
            const sortedYears = Object.keys(playerStatsData.stats.years).sort((a, b) => b - a); // Descending year

            sortedYears.forEach(year => {
                const yearStats = playerStatsData.stats.years[year];
                
                // Check if the player has any PJ in Apertura or Clausura for this specific year
                const hasAnyPJInYear = yearStats.apertura.pj > 0 || yearStats.clausura.pj > 0;

                if (hasAnyPJInYear) {
                    // Year header row - always visible, acts as toggle
                    individualStatsTableBody.innerHTML += `
                        <tr class="bg-gray-200 font-semibold text-gray-700 cursor-pointer toggle-year-button" data-year="${year}">
                            <td class="py-3 px-3 text-center">${year}</td>
                            <td class="py-3 px-3 text-center" colspan="9"></td> <!-- Spanning columns for year -->
                            <td class="py-3 px-3 text-center"><i class="fas fa-plus-square toggle-icon" data-year="${year}"></i></td>
                        </tr>
                    `;

                    // Apertura row - initially hidden
                    const aperturaStats = yearStats.apertura;
                    individualStatsTableBody.innerHTML += `
                        <tr class="border-b border-gray-200 hover:bg-gray-100 year-detail-row year-${year} hidden">
                            <td class="py-3 px-3 text-center"></td>
                            <td class="py-3 px-3 text-center">Apertura</td>
                            <td class="py-3 px-3 text-center">${aperturaStats.points}</td>
                            <td class="py-3 px-3 text-center">${aperturaStats.pg}</td>
                            <td class="py-3 px-3 text-center">${aperturaStats.pe}</td>
                            <td class="py-3 px-3 text-center">${aperturaStats.pp}</td>
                            <td class="py-3 px-3 text-center">${aperturaStats.pj}</td>
                            <td class="py-3 px-3 text-center">${aperturaStats.efectividad}%</td>
                            <td class="py-3 px-3 text-center">${aperturaStats.chamigos}</td>
                            <td class="py-3 px-3 text-center">${aperturaStats.tt}</td>
                            <td class="py-3 px-3 text-center">${aperturaStats.ausentes}</td>
                        </tr>
                    `;

                    // Clausura row - initially hidden
                    const clausuraStats = yearStats.clausura;
                    individualStatsTableBody.innerHTML += `
                        <tr class="border-b border-gray-200 hover:bg-gray-100 year-detail-row year-${year} hidden">
                            <td class="py-3 px-3 text-center"></td>
                            <td class="py-3 px-3 text-center">Clausura</td>
                            <td class="py-3 px-3 text-center">${clausuraStats.points}</td>
                            <td class="py-3 px-3 text-center">${clausuraStats.pg}</td>
                            <td class="py-3 px-3 text-center">${clausuraStats.pe}</td>
                            <td class="py-3 px-3 text-center">${clausuraStats.pp}</td>
                            <td class="py-3 px-3 text-center">${clausuraStats.pj}</td>
                            <td class="py-3 px-3 text-center">${clausuraStats.efectividad}%</td>
                            <td class="py-3 px-3 text-center">${clausuraStats.chamigos}</td>
                            <td class="py-3 px-3 text-center">${clausuraStats.tt}</td>
                            <td class="py-3 px-3 text-center">${clausuraStats.ausentes}</td>
                        </tr>
                    `;
                }
            });

            loadingMessage.classList.add('hidden');
            individualStatsTable.classList.remove('hidden');

            // Add event listeners for toggle buttons AFTER content is rendered
            document.querySelectorAll('.toggle-year-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const year = event.currentTarget.dataset.year;
                    // Select all detail rows for this year
                    const yearDetailRows = document.querySelectorAll(`.year-detail-row.year-${year}`);
                    const toggleIcon = event.currentTarget.querySelector('.toggle-icon');

                    yearDetailRows.forEach(row => {
                        row.classList.toggle('hidden');
                    });

                    // Toggle icon
                    if (yearDetailRows[0] && yearDetailRows[0].classList.contains('hidden')) {
                        toggleIcon.classList.remove('fa-minus-square');
                        toggleIcon.classList.add('fa-plus-square');
                    } else {
                        toggleIcon.classList.remove('fa-plus-square');
                        toggleIcon.classList.add('fa-minus-square');
                    }
                });
            });
        }


        // --- Event Listeners e Inicialización ---
        document.getElementById('leaderboard-year-select').addEventListener('change', renderLeaderboard);
        document.getElementById('leaderboard-period-select').addEventListener('change', renderLeaderboard);

        document.getElementById('chamigo-year-select').addEventListener('change', renderChamigoTable);
        document.getElementById('chamigo-period-select').addEventListener('change', renderChamigoTable);

        document.getElementById('tt-year-select').addEventListener('change', renderTTTable);
        document.getElementById('tt-period-select').addEventListener('change', renderTTTable);

        document.getElementById('presentismo-year-select').addEventListener('change', renderPresentismoTable);
        document.getElementById('presentismo-period-select').addEventListener('change', renderPresentismoTable);

        document.getElementById('ausentismo-year-select').addEventListener('change', renderAusentismoTable);
        document.getElementById('ausentismo-period-select').addEventListener('change', renderAusentismoTable);
        
        // Event listeners for Estadísticas sorting
        document.getElementById('estadisticas-year-select').addEventListener('change', renderEstadisticasTable);
        document.getElementById('estadisticas-period-select').addEventListener('change', renderEstadisticasTable);
        document.getElementById('estadisticas-sort-criterion').addEventListener('change', renderEstadisticasTable);
        document.getElementById('estadisticas-sort-order').addEventListener('change', renderEstadisticasTable);

        document.getElementById('equipos-year-select').addEventListener('change', renderEquiposStats);
        document.getElementById('equipos-period-select').addEventListener('change', renderEquiposStats);

        // Event listeners for Fixture
        document.getElementById('fixture-year-select').addEventListener('change', renderFixtureMatchCards);
        document.getElementById('fixture-month-select').addEventListener('change', renderFixtureMatchCards);

        hamburgerButton.addEventListener('click', toggleSideMenu);
        closeSideMenuButton.addEventListener('click', toggleSideMenu);
        overlay.addEventListener('click', () => {
            if (window.innerWidth < 768) {
                toggleSideMenu();
            }
        });

        // Evento para manejar el redimensionamiento de la ventana
        window.addEventListener('resize', () => {
            // Re-render fixture details to adjust player positions based on new orientation
            // Only re-render if the fixture tab is currently active
            if (!fixtureContent.classList.contains('hidden')) {
                const currentMatchCard = document.querySelector('#fixture-matches-cards-container > div.bg-gray-100');
                if (currentMatchCard) {
                    const currentMatchId = currentMatchCard.dataset.matchId;
                    renderFixtureDetails(currentMatchId);
                }
            }

            // Handle side menu visibility on resize
            if (window.innerWidth >= 768) {
                // Desktop view: sidebar always open, hamburger hidden
                sideMenu.classList.remove('hidden'); // Ensure it's not display:none
                sideMenu.classList.add('open'); // Ensure it's translated in
                hamburgerButton.classList.add('hidden'); // Hide hamburger
                overlay.classList.remove('open'); // Hide overlay
                document.body.classList.remove('overflow-hidden'); // Allow scrolling
            } else {
                // Mobile view: sidebar initially closed, hamburger visible
                sideMenu.classList.add('hidden'); // Hide sidebar (display:none)
                sideMenu.classList.remove('open'); // Ensure it's translated out
                hamburgerButton.classList.remove('hidden'); // Show hamburger
                overlay.classList.remove('open'); // Hide overlay
                document.body.classList.remove('overflow-hidden'); // Allow scrolling
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Aplicación LA CLANDE cargada!');
            // Asegurarse de que el botón de hamburguesa y el menú lateral estén ocultos al inicio
            hamburgerButton.classList.add('hidden');
            sideMenu.classList.add('hidden'); // Explicitly hide sidebar on load
            sideMenu.classList.remove('open'); // Ensure it's not open
            overlay.classList.add('hidden'); // Ensure overlay is hidden
            document.body.classList.remove('overflow-hidden'); // Ensure no overflow from previous state
        });
    </script>
    <!-- Script de la API de Google. Se carga asíncronamente y llama a gapiLoaded() cuando está listo. -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>
</html>
