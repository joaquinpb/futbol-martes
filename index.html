<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Clande - Los Martes</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter para una mejor legibilidad */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Un gris claro para el fondo */
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex; /* Usar flexbox para el layout principal */
        }
        /* Estilos base para tablas */
        table {
            @apply min-w-full bg-white rounded-lg shadow-md;
        }
        th, td {
            @apply py-3 px-6 text-left;
        }
        /* Encabezado de la tabla: fondo negro, texto blanco */
        thead th {
            background-color: #1a202c !important; /* Fondo negro (bg-gray-900) */
            color: #ffffff !important; /* Texto blanco (text-white) */
            text-transform: uppercase;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* leading-normal */
        }
        /* Filas del cuerpo de la tabla: alternar entre dos tonos de gris */
        tbody tr:nth-child(odd) {
            background-color: #f7fafc !important; /* Gris muy claro (bg-gray-100) */
        }
        tbody tr:nth-child(even) {
            background-color: #edf2f7 !important; /* Gris ligeramente más oscuro (bg-gray-200) */
        }
        tbody tr {
            border-bottom: 1px solid #cbd5e0; /* border-gray-300 */
            transition: background-color 150ms ease-in-out; /* transition duration-150 ease-in-out */
        }
        tbody tr:hover {
            background-color: #e2e8f0 !important; /* Tono de gris al pasar el cursor (hover:bg-gray-300) */
        }
        tbody tr:last-child {
            border-bottom: 0; /* Eliminar borde inferior de la última fila */
        }
        tbody td {
            color: #4a5568; /* text-gray-600 */
        }

        /* --- Estilos para el menú lateral responsivo --- */
        #side-menu {
            position: fixed; /* Fixed for mobile sliding effect */
            top: 0;
            left: 0;
            height: 100vh;
            width: 256px; /* w-64 */
            background-color: #312e81; /* indigo-800 */
            color: white;
            transform: translateX(-100%); /* Hidden by default for mobile */
            transition: transform 0.3s ease-in-out;
            z-index: 40;
            display: flex; /* Use flex for vertical layout of tabs */
            flex-direction: column;
            padding-top: 1rem; /* Add some padding at the top */
        }

        /* This class will be applied by JS to make it visible on mobile */
        #side-menu.open {
            transform: translateX(0);
        }

        #overlay {
            position: fixed;
            inset: 0; /* top:0, right:0, bottom:0, left:0 */
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            display: none; /* Hidden by default */
        }

        #overlay.open {
            display: block; /* Show when side menu is open (mobile only) */
        }

        #hamburger-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 50;
            padding: 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
        }

        #close-side-menu-button {
            background: none;
            border: none;
            font-size: 2rem; /* text-2xl */
            color: white;
            cursor: pointer;
            padding: 0.5rem;
        }

        #side-menu .tab-button, #side-menu .sidebar-link {
            padding-left: 1.5rem; /* px-6 */
            padding-right: 1.5rem; /* px-6 */
            text-align: left;
            width: 100%; /* Full width within sidebar */
            border-radius: 0; /* No rounded corners for vertical tabs */
            margin-bottom: 0.25rem; /* mb-1 */
            color: white; /* Text white for dark sidebar */
            transition: background-color 0.15s ease-in-out;
            display: flex; /* Para alinear el texto y el icono */
            align-items: center; /* Para alinear el texto y el icono */
            gap: 0.5rem; /* Espacio entre texto e icono */
        }
        #side-menu .tab-button.active {
            background-color: #4338ca; /* indigo-700 */
        }
        #side-menu .tab-button:hover, #side-menu .sidebar-link:hover {
            background-color: #4f46e5; /* indigo-600 */
        }

        /* Desktop Styles (min-width: 768px) */
        @media (min-width: 768px) {
            #side-menu {
                position: relative; /* Make it part of the normal flow */
                transform: translateX(0) !important; /* Always visible on desktop */
                flex-shrink: 0; /* Prevent shrinking */
                height: auto; /* Let content define height */
                min-height: 100vh; /* Ensure it takes full viewport height */
                border-right: 1px solid #e2e8f0; /* border-gray-200 */
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.06); /* shadow-lg */
                display: flex !important; /* Override hidden class if present */
            }
            #hamburger-button {
                display: none !important; /* Always hide hamburger on desktop */
            }
            #close-side-menu-button {
                display: none !important; /* Hide close button on desktop */
            }
            #overlay {
                display: none !important; /* Hide overlay on desktop */
            }
            .main-content-container {
                flex-grow: 1; /* Take remaining space */
                margin-left: 0 !important; /* Reset margin-left from mobile */
                margin-right: 0 !important; /* Reset margin-right from mobile */
                max-width: none !important; /* Allow it to expand fully */
                width: auto !important; /* Let flexbox control width */
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col md:flex-row p-4 md:p-0">
    <!-- Hamburger Button (visible on mobile) -->
    <button id="hamburger-button" class="fixed top-4 left-4 z-50 p-2 rounded-md bg-indigo-600 text-white shadow-lg hidden">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <!-- Side Navigation Menu -->
    <nav id="side-menu" class="fixed top-0 left-0 h-full w-64 bg-indigo-800 text-white transform -translate-x-full transition-transform duration-300 ease-in-out z-40 hidden">
        <div class="p-4 text-right">
            <button id="close-side-menu-button" class="text-white text-2xl md:hidden">&times;</button>
        </div>
        <div class="flex flex-col p-4 md:p-0 md:space-y-2 flex-1">
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="leaderboard-content">Tabla de Posiciones</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="chamigo-content">Chamigo</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="tt-content">TT</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="presentismo-content">Presentismo</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="ausentismo-content">Ausentismo</button>
        </div>
    </nav>

    <!-- Overlay for when side menu is open (mobile only) -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

    <!-- Main Content Area -->
    <div class="main-content-container bg-white p-8 rounded-xl shadow-lg w-full max-w-5xl mx-auto mt-4 md:mt-8">
        <h1 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">La Clande - Los Martes</h1>

        <!-- Content for Tabla de Posiciones -->
        <div id="leaderboard-content" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tabla de Posiciones</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="leaderboard-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="leaderboard-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="leaderboard-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                    <select id="leaderboard-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <p id="leaderboard-loading-message" class="text-gray-500 text-center">Cargando tabla de posiciones...</p>
                <table id="leaderboard-table" class="min-w-full bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Posición</th>
                            <th class="py-3 px-6 text-left">Jugador</th>
                            <th class="py-3 px-6 text-left">Puntos</th>
                            <th class="py-3 px-6 text-left">Partidos Jugados</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <!-- Content for Chamigo -->
        <div id="chamigo-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tabla de Chamigos</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="chamigo-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="chamigo-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="chamigo-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                    <select id="chamigo-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <p id="chamigo-loading-message" class="text-gray-500 text-center">Cargando tabla de Chamigos...</p>
                <table id="chamigo-table" class="min-w-full bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Posición</th>
                            <th class="py-3 px-6 text-left">Jugador</th>
                            <th class="py-3 px-6 text-left">Chamigos</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <!-- Content for TT -->
        <div id="tt-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tabla de Asistencia TT</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="tt-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="tt-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="tt-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                    <select id="tt-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <p id="tt-loading-message" class="text-gray-500 text-center">Cargando tabla de Asistencia TT...</p>
                <table id="tt-table" class="min-w-full bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Posición</th>
                            <th class="py-3 px-6 text-left">Jugador</th>
                            <th class="py-3 px-6 text-left">TT</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <!-- Content for Presentismo -->
        <div id="presentismo-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tabla de Presentismo (PJ)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="presentismo-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="presentismo-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="presentismo-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                    <select id="presentismo-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <p id="presentismo-loading-message" class="text-gray-500 text-center">Cargando tabla de Presentismo...</p>
                <table id="presentismo-table" class="min-w-full bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Posición</th>
                            <th class="py-3 px-6 text-left">Jugador</th>
                            <th class="py-3 px-6 text-left">PJ</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <!-- Content for Ausentismo -->
        <div id="ausentismo-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tabla de Ausentismo</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="ausentismo-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="ausentismo-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>
                <div>
                    <label for="ausentismo-period-select" class="block text-sm font-medium text-gray-700">Período:</label>
                    <select id="ausentismo-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <p id="ausentismo-loading-message" class="text-gray-500 text-center">Cargando tabla de Ausentismo...</p>
                <table id="ausentismo-table" class="min-w-full bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Posición</th>
                            <th class="py-3 px-6 text-left">Jugador</th>
                            <th class="py-3 px-6 text-left">Ausentes</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script async defer src="https://apis.google.com/js/api.js"></script>

    <script>
        // ¡IMPORTANTE! Reemplaza 'AIzaSyDNLwReGrX5FKBwjjKsMS9cz-hZNMIvAlM' con tu Clave de API de Google Cloud Console.
        // Esta clave es necesaria para acceder a Google Sheets API para hojas públicas sin autenticación de usuario.
        const API_KEY = 'AIzaSyDNLwReGrX5FKBwjjKsMS9cz-hZNMIvAlM'; 
        
        // ¡IMPORTANTE! Reemplaza 'TU_ID_DE_HOJA_DE_CALCULO' con el ID de tu Google Sheet
        // Asegúrate de que esta hoja de cálculo esté compartida públicamente con "Cualquier persona con el enlace puede ver"
        const SPREADSHEET_ID = '1bpNKl-UVHzbqsow4zOHE7-y5Cunm2xtpgyIodEQBi2E';

        let gapiInited = false;
        let allPlayersData = []; // Cache de todos los jugadores
        let allMatchesData = []; // Cache de todos los partidos

        // Elementos del DOM para el menú lateral
        const hamburgerButton = document.getElementById('hamburger-button');
        const sideMenu = document.getElementById('side-menu');
        const closeSideMenuButton = document.getElementById('close-side-menu-button');
        const overlay = document.getElementById('overlay');
        const tabButtons = document.querySelectorAll('.tab-button');

        // Referencias a los contenedores de contenido
        const leaderboardContent = document.getElementById('leaderboard-content');
        const chamigoContent = document.getElementById('chamigo-content');
        const ttContent = document.getElementById('tt-content');
        const presentismoContent = document.getElementById('presentismo-content');
        const ausentismoContent = document.getElementById('ausentismo-content');

        // --- Funciones de Inicialización de Google API y Carga de Datos ---

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY, // Se usa la clave de API aquí
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                gapiInited = true;
                handleDataLoadSuccess(); // Cargar datos y mostrar contenido
            } catch (err) {
                console.error("Error al inicializar gapi.client:", err);
                // Actualizar todos los mensajes de carga con el error
                document.getElementById('leaderboard-loading-message').textContent = `Error al inicializar la API de Google: ${err.message || JSON.stringify(err)}. Asegúrate de que la API Key sea correcta y esté habilitada para Google Sheets API.`;
                document.getElementById('chamigo-loading-message').textContent = `Error al inicializar la API de Google: ${err.message || JSON.stringify(err)}.`;
                document.getElementById('tt-loading-message').textContent = `Error al inicializar la API de Google: ${err.message || JSON.stringify(err)}.`;
                document.getElementById('presentismo-loading-message').textContent = `Error al inicializar la API de Google: ${err.message || JSON.stringify(err)}.`;
                document.getElementById('ausentismo-loading-message').textContent = `Error al inicializar la API de Google: ${err.message || JSON.stringify(err)}.`;
            }
        }

        async function handleDataLoadSuccess() {
            // Este método se llama cuando la API de Google Sheets está lista para ser usada
            try {
                await loadAllData(); // Cargar todos los datos de la hoja
                
                // Mostrar el menú lateral y el contenido principal
                sideMenu.classList.remove('hidden'); 
                if (window.innerWidth >= 768) {
                    sideMenu.classList.add('open'); // Forzar 'open' en desktop para que sea visible
                    hamburgerButton.classList.add('hidden'); // Ocultar hamburguesa en desktop
                } else {
                    sideMenu.classList.remove('open'); // Asegurarse de que esté cerrado para el estado inicial móvil
                    hamburgerButton.classList.remove('hidden'); // Mostrar hamburguesa en móvil
                }

                // Configurar la navegación por pestañas y renderizar la activa por defecto
                setupTabNavigation();

            } catch (error) {
                console.error("Error al cargar datos iniciales:", error);
                const errorMessage = `Error al cargar datos: ${error.message || JSON.stringify(error)}. Asegúrate de que la hoja sea accesible.`;
                document.getElementById('leaderboard-loading-message').textContent = errorMessage;
                document.getElementById('chamigo-loading-message').textContent = errorMessage;
                document.getElementById('tt-loading-message').textContent = errorMessage;
                document.getElementById('presentismo-loading-message').textContent = errorMessage;
                document.getElementById('ausentismo-loading-message').textContent = errorMessage;
            }
        }

        async function loadAllData() {
            try {
                if (!gapi.client.sheets) {
                    throw new Error("API de Google Sheets no cargada correctamente. Verifica la consola.");
                }

                // Cargar datos de Jugadores
                const playersResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Jugadores!A:H', // [ID, Nombre, Estado, Puntos, PJ, Chamigos, TT, Ausentes]
                });
                allPlayersData = playersResponse.result.values ? playersResponse.result.values.slice(1) : []; // Ignorar encabezados

                // Cargar datos de Partidos
                const matchesResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Partidos!A:G', // [ID, Fecha, ClarosIDs, OscurosIDs, Resultado, ChamigoVotos, TTAgendaIDs]
                });
                allMatchesData = matchesResponse.result.values ? matchesResponse.result.values.slice(1) : []; // Ignorar encabezados

            } catch (err) {
                console.error('Error al cargar todos los datos:', err);
                let userErrorMessage = 'Error desconocido al cargar datos.';
                if (err && err.result && err.result.error && err.result.error.message) {
                    userErrorMessage = `Error al cargar datos: ${err.result.error.message}. Revisa la consola para más detalles.`;
                } else if (err && err.message) {
                    userErrorMessage = `Error al cargar datos: ${err.message}. Revisa la consola para más detalles.`;
                }
                throw new Error(userErrorMessage); // Propagar el error para que handleDataLoadSuccess lo maneje
            }
        }

        // --- Funciones de Pestañas ---
        function setupTabNavigation() {
            tabButtons.forEach(button => {
                button.removeEventListener('click', handleTabButtonClick); // Evitar duplicados
                button.addEventListener('click', handleTabButtonClick);
            });

            // Llenar y seleccionar automáticamente año y período para todas las secciones
            populateAndSetCurrentPeriod('leaderboard-year-select', 'leaderboard-period-select');
            populateAndSetCurrentPeriod('chamigo-year-select', 'chamigo-period-select');
            populateAndSetCurrentPeriod('tt-year-select', 'tt-period-select');
            populateAndSetCurrentPeriod('presentismo-year-select', 'presentismo-period-select');
            populateAndSetCurrentPeriod('ausentismo-year-select', 'ausentismo-period-select');

            // Activar la pestaña por defecto al cargar
            const defaultTabButton = document.querySelector('.tab-button[data-tab="leaderboard-content"]');
            if (defaultTabButton) {
                defaultTabButton.classList.add('active');
                leaderboardContent.classList.remove('hidden');
                // Ocultar todas las demás al inicio
                chamigoContent.classList.add('hidden');
                ttContent.classList.add('hidden');
                presentismoContent.classList.add('hidden');
                ausentismoContent.classList.add('hidden');
            }
            
            // Renderizar el contenido de la pestaña por defecto (leaderboard)
            renderLeaderboard();
        }

        function handleTabButtonClick(event) {
            const clickedButton = event.currentTarget;
            
            // Remover 'active' de todos los botones y ocultar todos los contenidos
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            // Añadir 'active' al botón clicado y mostrar su contenido
            clickedButton.classList.add('active');
            const targetTabId = clickedButton.dataset.tab;
            document.getElementById(targetTabId).classList.remove('hidden');

            // Cerrar el menú lateral en móvil después de seleccionar una pestaña
            if (window.innerWidth < 768) {
                toggleSideMenu();
            }

            // Renderizar el contenido específico de la pestaña
            if (targetTabId === 'leaderboard-content') {
                renderLeaderboard();
            } else if (targetTabId === 'chamigo-content') {
                renderChamigoTable();
            } else if (targetTabId === 'tt-content') {
                renderTTTable();
            } else if (targetTabId === 'presentismo-content') {
                renderPresentismoTable();
            } else if (targetTabId === 'ausentismo-content') {
                renderAusentismoTable();
            }
        }

        // --- Toggle Side Menu Functionality ---
        function toggleSideMenu() {
            const isMobile = window.innerWidth < 768;
            if (isMobile) { // Only toggle on mobile
                sideMenu.classList.toggle('open');
                overlay.classList.toggle('open');
                document.body.classList.toggle('overflow-hidden'); // Evita el scroll del body
                if (sideMenu.classList.contains('open')) {
                    hamburgerButton.classList.add('hidden'); // Hide hamburger when sidebar opens on mobile
                } else {
                    hamburgerButton.classList.remove('hidden'); // Show hamburger when sidebar closes on mobile
                }
            }
        }

        // --- Helper Function: Filter Matches by Year and Period ---
        function getFilteredMatches(yearSelectId, periodSelectId) {
            const selectedYear = document.getElementById(yearSelectId).value;
            const selectedPeriod = document.getElementById(periodSelectId).value;

            return allMatchesData.filter(match => {
                const dateString = match[1]; // Fecha en formato DD/MM/YYYY
                if (!dateString) return false;

                const [day, month, year] = dateString.split('/').map(Number);
                const matchDate = new Date(year, month - 1, day); // Mes es 0-indexado

                const matchYear = matchDate.getFullYear();
                const matchMonth = matchDate.getMonth(); // 0-11

                const yearMatch = selectedYear === 'all' || matchYear === parseInt(selectedYear);

                let periodMatch = false;
                if (selectedPeriod === 'total') {
                    periodMatch = true; // Todos los meses
                } else if (selectedPeriod === 'apertura') {
                    periodMatch = matchMonth >= 0 && matchMonth <= 5; // Enero (0) a Junio (5)
                } else if (selectedPeriod === 'clausura') {
                    periodMatch = matchMonth >= 6 && matchMonth <= 11; // Julio (6) a Diciembre (11)
                }
                return yearMatch && periodMatch;
            });
        }

        // --- Renderizar Tabla de Posiciones ---
        function renderLeaderboard() {
            const leaderboardTable = document.getElementById('leaderboard-table');
            const leaderboardTableBody = leaderboardTable.querySelector('tbody');
            const loadingMessage = document.getElementById('leaderboard-loading-message');

            leaderboardTableBody.innerHTML = '';
            leaderboardTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.textContent = 'Cargando tabla de posiciones...';

            const filteredMatches = getFilteredMatches('leaderboard-year-select', 'leaderboard-period-select');

            const playerStats = {}; // { playerId: { points: 0, games: 0, name: '' } }

            allPlayersData.filter(p => p[2] === 'Activo').forEach(player => {
                const [id, name] = player;
                playerStats[id] = { points: 0, games: 0, name: name };
            });

            filteredMatches.forEach(match => {
                const [id, date, clarosIDsStr, oscurosIDsStr, result] = match;
                const clarosPlayers = clarosIDsStr.split(',').filter(Boolean);
                const oscurosPlayers = oscurosIDsStr.split(',').filter(Boolean);
                const allPlayersInMatch = [...new Set([...clarosPlayers, ...oscurosPlayers])];

                // Contar partidos jugados
                allPlayersInMatch.forEach(pId => {
                    if (playerStats[pId] && result !== 'Suspendido') {
                        playerStats[pId].games += 1;
                    }
                });

                // Asignar puntos
                if (result === 'Claros') {
                    clarosPlayers.forEach(pId => {
                        if (playerStats[pId]) playerStats[pId].points += 3;
                    });
                } else if (result === 'Oscuros') {
                    oscurosPlayers.forEach(pId => {
                        if (playerStats[pId]) playerStats[pId].points += 3;
                    });
                } else if (result === 'Empate') {
                    allPlayersInMatch.forEach(pId => {
                        if (playerStats[pId]) playerStats[pId].points += 1;
                    });
                }
            });

            let rankedPlayers = Object.values(playerStats).filter(player => player.name); // Ensure player has a name

            // Ordenar por puntos (descendente)
            rankedPlayers.sort((a, b) => b.points - a.points);

            if (rankedPlayers.length === 0) {
                loadingMessage.textContent = 'No hay datos disponibles para los filtros seleccionados.';
                loadingMessage.classList.remove('hidden');
                leaderboardTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla
            rankedPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-6">${index + 1}</td>
                    <td class="py-3 px-6 font-medium">${player.name}</td>
                    <td class="py-3 px-6">${player.points}</td>
                    <td class="py-3 px-6">${player.games}</td>
                `;
                leaderboardTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            leaderboardTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de Chamigo ---
        function renderChamigoTable() {
            const chamigoTable = document.getElementById('chamigo-table');
            const chamigoTableBody = chamigoTable.querySelector('tbody');
            const loadingMessage = document.getElementById('chamigo-loading-message');

            chamigoTableBody.innerHTML = '';
            chamigoTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.textContent = 'Cargando tabla de Chamigos...';

            const filteredMatches = getFilteredMatches('chamigo-year-select', 'chamigo-period-select');

            const playerChamigoCounts = {}; // { playerId: { name: '', chamigos: 0 } }

            // Inicializar todos los jugadores activos con 0 chamigos
            allPlayersData.filter(p => p[2] === 'Activo').forEach(player => {
                const [id, name] = player;
                playerChamigoCounts[id] = { name: name, chamigos: 0 };
            });

            // Recorrer los partidos filtrados para sumar los chamigos
            filteredMatches.forEach(match => {
                const chamigoVotosStr = match[5]; // Columna F (índice 5)

                if (chamigoVotosStr) {
                    try {
                        const chamigoVotos = JSON.parse(chamigoVotosStr);
                        // Encontrar el/los jugador(es) con la mayor cantidad de votos en este partido
                        if (chamigoVotos.length > 0) {
                            const maxVotes = Math.max(...chamigoVotos.map(v => v.votos));
                            const chamigosDelPartido = chamigoVotos.filter(v => v.votos === maxVotes);
                            
                            chamigosDelPartido.forEach(chamigo => {
                                if (playerChamigoCounts[chamigo.id]) {
                                    playerChamigoCounts[chamigo.id].chamigos += 1;
                                }
                            });
                        }
                    } catch (e) {
                        console.warn('Error al parsear votos de chamigo en el partido', match[0], ':', e);
                    }
                }
            });

            let rankedChamigoPlayers = Object.values(playerChamigoCounts).filter(player => player.name); // Ensure player has a name

            // Ordenar por cantidad de chamigos (descendente)
            rankedChamigoPlayers.sort((a, b) => b.chamigos - a.chamigos);

            if (rankedChamigoPlayers.length === 0) {
                loadingMessage.textContent = 'No hay datos de Chamigos disponibles para los filtros seleccionados.';
                loadingMessage.classList.remove('hidden');
                chamigoTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de Chamigo
            rankedChamigoPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-6">${index + 1}</td>
                    <td class="py-3 px-6 font-medium">${player.name}</td>
                    <td class="py-3 px-6">${player.chamigos}</td>
                `;
                chamigoTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            chamigoTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de TT ---
        function renderTTTable() {
            const ttTable = document.getElementById('tt-table');
            const ttTableBody = ttTable.querySelector('tbody');
            const loadingMessage = document.getElementById('tt-loading-message');

            ttTableBody.innerHTML = '';
            ttTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.textContent = 'Cargando tabla de Asistencia TT...';

            const filteredMatches = getFilteredMatches('tt-year-select', 'tt-period-select');

            const playerTTCounts = {}; // { playerId: { name: '', tt: 0 } }

            // Inicializar todos los jugadores activos con 0 TT
            allPlayersData.filter(p => p[2] === 'Activo').forEach(player => {
                const [id, name] = player;
                playerTTCounts[id] = { name: name, tt: 0 };
            });

            // Recorrer los partidos filtrados para sumar las asistencias TT
            filteredMatches.forEach(match => {
                const ttAttendeesStr = match[6]; // Columna G (índice 6)

                if (ttAttendeesStr) {
                    const ttAttendees = ttAttendeesStr.split(',').filter(Boolean);
                    ttAttendees.forEach(pId => {
                        if (playerTTCounts[pId]) {
                            playerTTCounts[pId].tt += 1;
                        }
                    });
                }
            });

            let rankedTTPlayers = Object.values(playerTTCounts).filter(player => player.name); // Ensure player has a name

            // Ordenar por cantidad de TT (descendente)
            rankedTTPlayers.sort((a, b) => b.tt - a.tt);

            if (rankedTTPlayers.length === 0) {
                loadingMessage.textContent = 'No hay datos de Asistencia TT disponibles para los filtros seleccionados.';
                loadingMessage.classList.remove('hidden');
                ttTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de TT
            rankedTTPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-6">${index + 1}</td>
                    <td class="py-3 px-6 font-medium">${player.name}</td>
                    <td class="py-3 px-6">${player.tt}</td>
                `;
                ttTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            ttTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de Presentismo ---
        function renderPresentismoTable() {
            const presentismoTable = document.getElementById('presentismo-table');
            const presentismoTableBody = presentismoTable.querySelector('tbody');
            const loadingMessage = document.getElementById('presentismo-loading-message');

            presentismoTableBody.innerHTML = '';
            presentismoTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.textContent = 'Cargando tabla de Presentismo...';

            const filteredMatches = getFilteredMatches('presentismo-year-select', 'presentismo-period-select');

            const playerPJCounts = {}; // { playerId: { name: '', pj: 0 } }

            // Inicializar todos los jugadores activos con 0 PJ
            allPlayersData.filter(p => p[2] === 'Activo').forEach(player => {
                const [id, name] = player;
                playerPJCounts[id] = { name: name, pj: 0 };
            });

            // Recorrer los partidos filtrados para sumar los PJ
            filteredMatches.forEach(match => {
                const clarosIDsStr = match[2];
                const oscurosIDsStr = match[3];
                const result = match[4];

                if (result !== 'Suspendido') {
                    const allPlayersInMatch = [...new Set([...clarosIDsStr.split(',').filter(Boolean), ...oscurosIDsStr.split(',').filter(Boolean)])];
                    allPlayersInMatch.forEach(pId => {
                        if (playerPJCounts[pId]) {
                            playerPJCounts[pId].pj += 1;
                        }
                    });
                }
            });

            let rankedPJPlayers = Object.values(playerPJCounts).filter(player => player.name); // Ensure player has a name

            // Ordenar por PJ (descendente)
            rankedPJPlayers.sort((a, b) => b.pj - a.pj);

            if (rankedPJPlayers.length === 0) {
                loadingMessage.textContent = 'No hay datos de Presentismo disponibles para los filtros seleccionados.';
                loadingMessage.classList.remove('hidden');
                presentismoTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de Presentismo
            rankedPJPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-6">${index + 1}</td>
                    <td class="py-3 px-6 font-medium">${player.name}</td>
                    <td class="py-3 px-6">${player.pj}</td>
                `;
                presentismoTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            presentismoTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de Ausentismo ---
        function renderAusentismoTable() {
            const ausentismoTable = document.getElementById('ausentismo-table');
            const ausentismoTableBody = ausentismoTable.querySelector('tbody');
            const loadingMessage = document.getElementById('ausentismo-loading-message');

            ausentismoTableBody.innerHTML = '';
            ausentismoTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.textContent = 'Cargando tabla de Ausentismo...';

            const filteredMatches = getFilteredMatches('ausentismo-year-select', 'ausentismo-period-select');
            
            // Contar el total de partidos no suspendidos en el período filtrado
            const totalMatchesInPeriod = filteredMatches.filter(match => match[4] !== 'Suspendido').length;

            const playerAusenteCounts = {}; // { playerId: { name: '', ausentes: 0, pj: 0 } }

            // Inicializar todos los jugadores activos
            allPlayersData.filter(p => p[2] === 'Activo').forEach(player => {
                const [id, name] = player;
                playerAusenteCounts[id] = { name: name, ausentes: 0, pj: 0 };
            });

            // Calcular PJ para cada jugador en el período filtrado (similar a Presentismo)
            filteredMatches.forEach(match => {
                const clarosIDsStr = match[2];
                const oscurosIDsStr = match[3];
                const result = match[4];

                if (result !== 'Suspendido') {
                    const allPlayersInMatch = [...new Set([...clarosIDsStr.split(',').filter(Boolean), ...oscurosIDsStr.split(',').filter(Boolean)])];
                    allPlayersInMatch.forEach(pId => {
                        if (playerAusenteCounts[pId]) {
                            playerAusenteCounts[pId].pj += 1;
                        }
                    });
                }
            });

            // Calcular ausentes
            Object.values(playerAusenteCounts).forEach(player => {
                player.ausentes = totalMatchesInPeriod - player.pj;
                if (player.ausentes < 0) player.ausentes = 0; // Asegurarse de que no sea negativo
            });

            let rankedAusentePlayers = Object.values(playerAusenteCounts).filter(player => player.name); // Ensure player has a name

            // Ordenar por Ausentes (descendente)
            rankedAusentePlayers.sort((a, b) => b.ausentes - a.ausentes);

            if (rankedAusentePlayers.length === 0) {
                loadingMessage.textContent = 'No hay datos de Ausentismo disponibles para los filtros seleccionados.';
                loadingMessage.classList.remove('hidden');
                ausentismoTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de Ausentismo
            rankedAusentePlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-6">${index + 1}</td>
                    <td class="py-3 px-6 font-medium">${player.name}</td>
                    <td class="py-3 px-6">${player.ausentes}</td>
                `;
                ausentismoTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            ausentismoTable.classList.remove('hidden');
        }


        // --- Utilidades ---
        function parseDate(dateString) {
            const [day, month, year] = dateString.split('/').map(Number);
            return new Date(year, month - 1, day);
        }

        function populateYearSelects(selectId) {
            const yearSelect = document.getElementById(selectId);
            const years = new Set();
            allMatchesData.forEach(match => {
                const dateString = match[1];
                if (dateString) {
                    const date = parseDate(dateString);
                    years.add(date.getFullYear());
                }
            });

            const sortedYears = Array.from(years).sort((a, b) => b - a);

            yearSelect.innerHTML = '';
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'Todos los Años';
            yearSelect.appendChild(allOption);

            if (sortedYears.length > 0) {
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            }
        }

        function populateAndSetCurrentPeriod(yearSelectId, periodSelectId) {
            populateYearSelects(yearSelectId); // First populate years

            const yearSelect = document.getElementById(yearSelectId);
            const periodSelect = document.getElementById(periodSelectId);

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-indexed

            // Set current year
            const yearOption = Array.from(yearSelect.options).find(option => parseInt(option.value) === currentYear);
            if (yearOption) {
                yearSelect.value = currentYear;
            } else {
                yearSelect.value = 'all'; // Fallback if current year is not in options
            }

            // Set current period
            if (currentMonth >= 0 && currentMonth <= 5) { // January to June (Apertura)
                periodSelect.value = 'apertura';
            } else if (currentMonth >= 6 && currentMonth <= 11) { // July to December (Clausura)
                periodSelect.value = 'clausura';
            } else {
                periodSelect.value = 'total'; // Default to Totales if outside specific periods or for initial load
            }
        }


        // --- Event Listeners e Inicialización ---
        document.getElementById('leaderboard-year-select').addEventListener('change', renderLeaderboard);
        document.getElementById('leaderboard-period-select').addEventListener('change', renderLeaderboard);

        document.getElementById('chamigo-year-select').addEventListener('change', renderChamigoTable);
        document.getElementById('chamigo-period-select').addEventListener('change', renderChamigoTable);

        document.getElementById('tt-year-select').addEventListener('change', renderTTTable);
        document.getElementById('tt-period-select').addEventListener('change', renderTTTable);

        document.getElementById('presentismo-year-select').addEventListener('change', renderPresentismoTable);
        document.getElementById('presentismo-period-select').addEventListener('change', renderPresentismoTable);

        document.getElementById('ausentismo-year-select').addEventListener('change', renderAusentismoTable);
        document.getElementById('ausentismo-period-select').addEventListener('change', renderAusentismoTable);

        hamburgerButton.addEventListener('click', toggleSideMenu);
        closeSideMenuButton.addEventListener('click', toggleSideMenu);
        overlay.addEventListener('click', () => {
            if (window.innerWidth < 768) {
                toggleSideMenu();
            }
        });

        // Evento para manejar el redimensionamiento de la ventana
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                // Si gapi está inicializado, asegurar que la barra lateral esté abierta y la hamburguesa oculta
                if (gapiInited) { 
                    sideMenu.classList.remove('hidden'); 
                    sideMenu.classList.add('open'); 
                    hamburgerButton.classList.add('hidden'); 
                    overlay.classList.remove('open'); 
                    document.body.classList.remove('overflow-hidden'); 
                }
            } else {
                // Si se redimensiona a móvil
                // Si la barra lateral estaba visible (estado de escritorio), ocultarla y mostrar hamburguesa
                if (sideMenu.classList.contains('open')) { 
                    sideMenu.classList.remove('open'); 
                    overlay.classList.remove('open');
                    document.body.classList.remove('overflow-hidden');
                }
                // Mostrar hamburguesa si el menú está cerrado en mobile
                if (!sideMenu.classList.contains('open')) {
                    hamburgerButton.classList.remove('hidden');
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Tabla de Posiciones de Fútbol 5 cargada!');
            // Asegurarse de que el botón de hamburguesa y el menú lateral estén ocultos al inicio
            hamburgerButton.classList.add('hidden');
            sideMenu.classList.add('hidden'); // Explicitly hide sidebar on load
            sideMenu.classList.remove('open'); // Ensure it's not open
            overlay.classList.add('hidden'); // Ensure overlay is hidden
            document.body.classList.remove('overflow-hidden'); // Ensure no overflow from previous state

            // Cargar las librerías de Google
            gapiLoaded();
        });
    </script>
</body>
</html>
