<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA CLANDE - Estadísticas</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚽</text></svg>">

    <style>
        /* --- ESTILOS GLOBALES Y VARIABLES DE TEMA (Inspirado en admin.html) --- */
        :root {
            --bg-primary: #f4f7fe;
            --bg-secondary: #ffffff;
            --bg-muted: #f9fafb;
            --sidebar-bg: #111827;
            --sidebar-text: #e5e7eb;
            --sidebar-active-bg: #4f46e5;
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #374151;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --accent-color: #4f46e5;
            --accent-color-hover: #4338ca;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --table-header-bg: #f9fafb;
            --table-row-odd-bg: #ffffff;
            --table-row-even-bg: #f9fafb;
            --table-row-hover: #f0f2f5;
        }

        html.dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-muted: #111827;
            --sidebar-bg: #111827;
            --sidebar-text: #e5e7eb;
            --sidebar-active-bg: #4f46e5;
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
            --accent-color: #6366f1;
            --accent-color-hover: #818cf8;
            --table-header-bg: #1f2937;
            --table-row-odd-bg: #1f2937;
            --table-row-even-bg: #111827;
            --table-row-hover: #374151;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.overflow-hidden {
            overflow: hidden;
        }

        /* --- COMPONENTES --- */
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        
        input, select {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        html.dark input, html.dark select {
             background-color: var(--bg-muted);
             color: var(--text-primary);
        }
        
        /* --- SIDEBAR Y NAVEGACIÓN --- */
        .nav-link.active {
            background-color: var(--sidebar-active-bg);
            color: var(--sidebar-active-text) !important;
        }
        
        /* --- TABLAS --- */
        .table-container {
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            position: relative;
        }

        .table-container thead th {
            position: sticky;
            top: 0;
            background-color: var(--table-header-bg);
            color: var(--text-secondary);
            z-index: 10;
        }
        
        tbody tr {
            border-bottom: 1px solid var(--border-color);
        }
        tbody tr:last-child {
            border-bottom: 0;
        }
        tbody tr:nth-child(odd) { background-color: var(--table-row-odd-bg); }
        tbody tr:nth-child(even) { background-color: var(--table-row-even-bg); }
        tbody tr:hover { background-color: var(--table-row-hover); }
        
        /* --- COLUMNAS FIJAS (STICKY) --- */
        .sticky-col {
            position: sticky;
            z-index: 5;
            background-color: inherit; /* Hereda el color de la fila */
        }
        
        thead .sticky-col {
            background-color: var(--table-header-bg);
            z-index: 15;
        }

        .sticky-col-1 { left: 0; }
        .sticky-col-2 { left: 50px; } /* Ajustar según ancho de col 1 */
        
        /* --- ESTILOS ESPECÍFICOS DE SECCIONES --- */
        
        /* Títulos */
        .section-title {
            color: var(--text-primary);
        }
        
        /* Filtros */
        .filter-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        
        /* Campo de Fútbol */
        #soccer-field-container {
            background-color: #22c55e; /* Green-500 */
            background-image:
                linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 3rem 3rem;
            border: 2px solid #a3a3a3;
        }
        .player-marker {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .player-marker.claros {
            background-color: #ffffff;
            color: #111827;
            border: 2px solid #111827;
        }
        .player-marker.oscuros {
            background-color: #111827;
            color: #ffffff;
            border: 2px solid #ffffff;
        }
        .player-marker .fa-star {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--bg-secondary);
            border-radius: 50%;
            padding: 2px;
            color: #facc15; /* yellow-400 */
        }
        .player-name-label {
            background-color: rgba(255, 255, 255, 0.8);
            color: #111827;
        }
        html.dark .player-name-label {
            background-color: rgba(17, 24, 39, 0.8);
            color: #f9fafb;
        }
        
        /* Búsqueda de jugador */
        #individual-player-search {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' viewBox='0 0 20 20' fill='%239ca3af'%3E%3Cpath fill-rule='evenodd' d='M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 0.75rem center;
            padding-left: 2.5rem;
        }
        html.dark #individual-player-search {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' viewBox='0 0 20 20' fill='%23d1d5db'%3E%3Cpath fill-rule='evenodd' d='M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z' clip-rule='evenodd' /%3E%3C/svg%3E");
        }

    </style>
</head>
<body class="antialiased">

    <div class="flex h-screen">
        <!-- Sidebar para Desktop -->
        <aside id="sidebar" class="w-64 bg-sidebar-bg text-sidebar-text flex-col hidden md:flex">
            <div class="px-6 py-4 flex items-center">
                <a href="#" class="text-xl font-bold flex items-center gap-2 text-white">
                    <span class="text-2xl">⚽</span>
                    <span>LA CLANDE</span>
                </a>
            </div>
            
            <nav id="main-nav" class="flex-1 px-4 space-y-2 overflow-y-auto">
                <!-- Desktop nav items will be injected by JS -->
            </nav>

            <div class="px-4 py-4 mt-auto">
                 <button id="desktop-dark-mode-toggle" class="w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-sidebar-hover-bg transition-colors duration-200">
                    <i class="fas fa-moon w-5 text-center"></i>
                    <span>Modo Oscuro</span>
                </button>
            </div>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header para Mobile -->
            <header class="flex items-center justify-between p-4 border-b border-border-color bg-secondary md:hidden sticky top-0 z-20">
                <div class="flex-1 text-center">
                    <a href="#" class="text-xl font-bold flex items-center gap-2 justify-center">
                        <span class="text-2xl">⚽</span>
                        <span>LA CLANDE</span>
                    </a>
                </div>
                <div class="w-10 text-right">
                     <button id="mobile-menu-toggle" class="p-2 rounded-md -mr-2">
                        <i class="fas fa-bars text-lg"></i>
                    </button>
                </div>

                <!-- Mobile Dropdown Menu -->
                <div id="mobile-menu" class="hidden absolute top-full left-0 mt-0 w-full bg-secondary shadow-xl border-t border-border-color z-50">
                    <nav class="p-4 space-y-2">
                         <!-- Mobile nav items will be injected by JS -->
                    </nav>
                </div>
            </header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-primary p-4 sm:p-6 lg:p-8">
                <div id="stats-content-area" class="max-w-7xl mx-auto">
                    <!-- Contenido de las pestañas se insertará aquí -->
                     <div class="flex items-center justify-center h-64">
                        <i class="fas fa-spinner fa-spin text-4xl text-accent-color"></i>
                        <p class="ml-4 text-lg text-secondary">Cargando datos iniciales...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black/50 z-10 hidden md:hidden"></div>

    <!-- TEMPLATES PARA EL CONTENIDO DE LAS PESTAÑAS -->
    <template id="template-leaderboard-content">
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <h2 class="text-2xl font-bold tracking-tight section-title">Tabla de Posiciones</h2>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <select id="leaderboard-year-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2"></select>
                    <select id="leaderboard-period-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Anual</option>
                    </select>
                </div>
            </div>
            <div class="card rounded-xl shadow-sm overflow-hidden">
                <div class="table-container">
                    <p id="leaderboard-loading-message" class="p-6 text-center text-secondary">Cargando...</p>
                    <table id="leaderboard-table" class="w-full text-sm text-left hidden">
                        <thead class="text-xs uppercase">
                            <tr>
                                <th scope="col" class="p-4">#</th>
                                <th scope="col" class="p-4">Jugador</th>
                                <th scope="col" class="p-4 text-center">Puntos</th>
                                <th scope="col" class="p-4 text-center">Efectividad</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-chamigo-content">
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <h2 class="text-2xl font-bold tracking-tight section-title">Chamigo</h2>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <select id="chamigo-year-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2"></select>
                    <select id="chamigo-period-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Anual</option>
                    </select>
                </div>
            </div>
            <div class="card rounded-xl shadow-sm overflow-hidden">
                <div class="table-container">
                    <p id="chamigo-loading-message" class="p-6 text-center text-secondary">Cargando...</p>
                    <table id="chamigo-table" class="w-full text-sm text-left hidden">
                        <thead class="text-xs uppercase">
                            <tr>
                                <th scope="col" class="p-4">#</th>
                                <th scope="col" class="p-4">Jugador</th>
                                <th scope="col" class="p-4 text-center">Votos</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-tt-content">
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <h2 class="text-2xl font-bold tracking-tight section-title">Tercer Tiempo (TT)</h2>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <select id="tt-year-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2"></select>
                    <select id="tt-period-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Anual</option>
                    </select>
                </div>
            </div>
            <div class="card rounded-xl shadow-sm overflow-hidden">
                <div class="table-container">
                    <p id="tt-loading-message" class="p-6 text-center text-secondary">Cargando...</p>
                    <table id="tt-table" class="w-full text-sm text-left hidden">
                        <thead class="text-xs uppercase">
                            <tr>
                                <th scope="col" class="p-4">#</th>
                                <th scope="col" class="p-4">Jugador</th>
                                <th scope="col" class="p-4 text-center">Asistencias</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-presentismo-content">
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <h2 class="text-2xl font-bold tracking-tight section-title">Presentismo</h2>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <select id="presentismo-year-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2"></select>
                    <select id="presentismo-period-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Anual</option>
                    </select>
                </div>
            </div>
            <div class="card rounded-xl shadow-sm overflow-hidden">
                <div class="table-container">
                    <p id="presentismo-loading-message" class="p-6 text-center text-secondary">Cargando...</p>
                    <table id="presentismo-table" class="w-full text-sm text-left hidden">
                        <thead class="text-xs uppercase">
                            <tr>
                                <th scope="col" class="p-4">#</th>
                                <th scope="col" class="p-4">Jugador</th>
                                <th scope="col" class="p-4 text-center">Partidos Jugados</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-ausentismo-content">
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <h2 class="text-2xl font-bold tracking-tight section-title">Ausentismo</h2>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <select id="ausentismo-year-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2"></select>
                    <select id="ausentismo-period-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Anual</option>
                    </select>
                </div>
            </div>
            <div class="card rounded-xl shadow-sm overflow-hidden">
                <div class="table-container">
                    <p id="ausentismo-loading-message" class="p-6 text-center text-secondary">Cargando...</p>
                    <table id="ausentismo-table" class="w-full text-sm text-left hidden">
                        <thead class="text-xs uppercase">
                            <tr>
                                <th scope="col" class="p-4">#</th>
                                <th scope="col" class="p-4">Jugador</th>
                                <th scope="col" class="p-4 text-center">Ausencias</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-estadisticas-content">
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <h2 class="text-2xl font-bold tracking-tight section-title">Estadísticas Generales</h2>
                <div class="flex items-center gap-2 w-full md:w-auto flex-wrap">
                    <select id="estadisticas-year-select" class="flex-grow md:flex-grow-0 bg-secondary border-border-color rounded-md shadow-sm p-2"></select>
                    <select id="estadisticas-period-select" class="flex-grow md:flex-grow-0 bg-secondary border-border-color rounded-md shadow-sm p-2">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Anual</option>
                    </select>
                </div>
            </div>
            <div class="card rounded-xl shadow-sm overflow-hidden">
                <div class="table-container">
                    <p id="estadisticas-loading-message" class="p-6 text-center text-secondary">Cargando...</p>
                    <table id="estadisticas-table" class="w-full min-w-[800px] text-sm text-left hidden">
                        <thead class="text-xs uppercase">
                            <tr>
                                <th scope="col" class="p-4 sticky-col sticky-col-1">#</th>
                                <th scope="col" class="p-4 sticky-col sticky-col-2">Jugador</th>
                                <th scope="col" class="p-4 text-center">Puntos</th>
                                <th scope="col" class="p-4 text-center">PG</th>
                                <th scope="col" class="p-4 text-center">PE</th>
                                <th scope="col" class="p-4 text-center">PP</th>
                                <th scope="col" class="p-4 text-center">PJ</th>
                                <th scope="col" class="p-4 text-center">Efectividad</th>
                                <th scope="col" class="p-4 text-center">Chamigo</th>
                                <th scope="col" class="p-4 text-center">TT</th>
                                <th scope="col" class="p-4 text-center">Ausentismo</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-equipos-content">
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <h2 class="text-2xl font-bold tracking-tight section-title">Rendimiento de Equipos</h2>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <select id="equipos-year-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2"></select>
                    <select id="equipos-period-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Anual</option>
                    </select>
                </div>
            </div>
            <p id="equipos-loading-message" class="p-6 text-center text-secondary">Cargando...</p>
            <div id="equipos-stats-display" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 hidden">
                <!-- Stats cards will be injected here -->
            </div>
        </div>
    </template>
    
    <template id="template-fixture-content">
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <h2 class="text-2xl font-bold tracking-tight section-title">Fixture</h2>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <select id="fixture-year-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2"></select>
                    <select id="fixture-month-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm p-2"></select>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 card rounded-xl shadow-sm p-4 h-fit">
                    <h3 class="font-semibold mb-3">Partidos del Mes</h3>
                    <div id="fixture-matches-cards-container" class="space-y-2 max-h-[60vh] overflow-y-auto">
                        <p id="fixture-loading-message" class="p-4 text-center text-secondary">Cargando...</p>
                    </div>
                </div>
                <div class="lg:col-span-2 card rounded-xl shadow-sm p-4">
                    <div id="fixture-details-container" class="hidden">
                        <h3 id="fixture-date-header" class="text-lg font-bold text-center mb-4"></h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div id="soccer-field-container" class="relative w-full aspect-[3/4] rounded-lg overflow-hidden">
                                <!-- Field markings and players will be injected here -->
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold mb-2">🏅 Chamigos del Partido</h4>
                                    <div id="chamigos-display" class="text-secondary">Selecciona un partido.</div>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-2">🍻 Asistentes al TT</h4>
                                    <div id="tt-attendees-display" class="text-secondary">Selecciona un partido.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="fixture-details-placeholder" class="flex items-center justify-center h-full text-secondary">
                        <p>Selecciona un partido de la lista para ver los detalles.</p>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-individual-stats-content">
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <h2 class="text-2xl font-bold tracking-tight section-title">Historial Individual</h2>
                <div class="relative w-full md:w-72">
                    <input type="text" id="individual-player-search" placeholder="Buscar jugador..." class="w-full p-2 bg-secondary border-border-color rounded-md shadow-sm">
                    <div id="individual-player-results" class="absolute z-10 w-full card rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
                </div>
            </div>
             <div class="card rounded-xl shadow-sm overflow-hidden">
                <div class="table-container">
                    <p id="individual-stats-loading-message" class="p-6 text-center text-secondary">Busca y selecciona un jugador para ver su historial.</p>
                    <table id="individual-stats-table" class="w-full min-w-[800px] text-sm text-left hidden">
                        <thead class="text-xs uppercase">
                            <tr>
                                <th scope="col" class="p-4 sticky-col sticky-col-1">Año</th>
                                <th scope="col" class="p-4 sticky-col sticky-col-2">Torneo</th>
                                <th scope="col" class="p-4 text-center">Puntos</th>
                                <th scope="col" class="p-4 text-center">PG</th>
                                <th scope="col" class="p-4 text-center">PE</th>
                                <th scope="col" class="p-4 text-center">PP</th>
                                <th scope="col" class="p-4 text-center">PJ</th>
                                <th scope="col" class="p-4 text-center">Efectividad</th>
                                <th scope="col" class="p-4 text-center">Chamigo</th>
                                <th scope="col" class="p-4 text-center">TT</th>
                                <th scope="col" class="p-4 text-center">Ausentismo</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & STATE ---
        const SUPABASE_URL = 'https://ezoqqzequstrzemlbsoa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6b3FxemVxdXN0cnplbWxic29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3Mjc4MzEsImV4cCI6MjA2ODMwMzgzMX0.v_i5kI1dXB4FEt-f8I6Fe5MetcktYnOyt7809un0VlQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allPlayers = [];
        let allMatches = [];
        let isDataLoaded = false;

        const TABS = [
            { id: 'leaderboard', name: 'Posiciones', icon: 'fa-trophy' },
            { id: 'estadisticas', name: 'Estadísticas', icon: 'fa-chart-bar' },
            { id: 'chamigo', name: 'Chamigo', icon: 'fa-star' },
            { id: 'tt', name: 'Tercer Tiempo', icon: 'fa-beer' },
            { id: 'presentismo', name: 'Presentismo', icon: 'fa-check-circle' },
            { id: 'ausentismo', name: 'Ausentismo', icon: 'fa-times-circle' },
            { id: 'equipos', name: 'Equipos', icon: 'fa-shield-alt' },
            { id: 'fixture', name: 'Fixture', icon: 'fa-calendar-alt' },
            { id: 'individual-stats', name: 'Histórico', icon: 'fa-user' }
        ];

        // --- DOM ELEMENTS ---
        const DOMElements = {
            desktopDarkModeToggle: document.getElementById('desktop-dark-mode-toggle'),
            mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
            mobileMenu: document.getElementById('mobile-menu'),
            mobileMenuOverlay: document.getElementById('mobile-menu-overlay'),
            mainNav: document.getElementById('main-nav'),
            mobileNavContainer: document.getElementById('mobile-menu').querySelector('nav'),
            contentArea: document.getElementById('stats-content-area'),
        };

        // --- INITIALIZATION ---
        async function init() {
            console.log("Iniciando aplicación...");
            setupTheme();
            await loadInitialData(); 
            
            // Only setup the rest if data loading was successful
            if (isDataLoaded) {
                setupNavigation();
                DOMElements.mobileMenuToggle.addEventListener('click', toggleMobileMenu);
                DOMElements.mobileMenuOverlay.addEventListener('click', toggleMobileMenu);
            }
        }

        async function loadInitialData() {
            try {
                console.log("1. Obteniendo datos de Supabase...");
                const [playersRes, matchesRes] = await Promise.all([
                    supabase.from('players').select('*'),
                    supabase.from('matches').select('*').order('match_date', { ascending: false })
                ]);

                console.log("2. Respuesta de Supabase recibida.");

                if (playersRes.error) throw playersRes.error;
                if (matchesRes.error) throw matchesRes.error;

                allPlayers = playersRes.data || [];
                allMatches = matchesRes.data || [];
                isDataLoaded = true;
                
                console.log(`3. Datos cargados: ${allPlayers.length} jugadores, ${allMatches.length} partidos.`);

                if (allPlayers.length === 0 || allMatches.length === 0) {
                    console.warn("Advertencia: Una o ambas tablas (players, matches) están vacías o no se pudo acceder a ellas.");
                     DOMElements.contentArea.innerHTML = `<div class="card p-6 text-center text-warning-color">
                        <h3 class="text-lg font-bold mb-2">No se encontraron datos</h3>
                        <p>Las tablas de jugadores o partidos parecen estar vacías. Si esto es un error, por favor verifica las Políticas de Seguridad (RLS) en tu panel de Supabase para asegurarte de que el rol 'anon' tenga permiso de LECTURA (SELECT) en ambas tablas.</p>
                     </div>`;
                    isDataLoaded = false; // Prevent further execution
                }
            } catch (error) {
                console.error("Error al cargar datos de Supabase:", error);
                DOMElements.contentArea.innerHTML = `<div class="card p-6 text-center text-danger-color">
                    <h3 class="text-lg font-bold mb-2">Error de Conexión</h3>
                    <p>No se pudieron cargar los datos desde Supabase. Revisa la consola para más detalles del error.</p>
                    <p class="mt-2 text-xs">Mensaje: ${error.message}</p>
                </div>`;
                isDataLoaded = false; // Prevent further execution
            }
        }

        // --- UI & THEME ---
        function setupTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
            
            DOMElements.desktopDarkModeToggle.addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                applyTheme(newTheme);
            });
        }

        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            localStorage.setItem('theme', theme);
            updateThemeToggleIcons();
        }

        function updateThemeToggleIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            const toggleButtons = [
                DOMElements.desktopDarkModeToggle, 
                document.getElementById('mobile-dark-mode-toggle')
            ];

            toggleButtons.forEach(btn => {
                if (btn) {
                    const icon = btn.querySelector('i');
                    const text = btn.querySelector('span');
                    icon.classList.toggle('fa-moon', !isDark);
                    icon.classList.toggle('fa-sun', isDark);
                    if(text) text.textContent = isDark ? 'Modo Claro' : 'Modo Oscuro';
                }
            });
        }

        function setupNavigation() {
            DOMElements.mainNav.innerHTML = TABS.map(tab => `
                <a href="#${tab.id}" data-tab="${tab.id}" class="nav-link w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-sidebar-hover-bg transition-colors duration-200">
                    <i class="fas ${tab.icon} w-5 text-center"></i><span>${tab.name}</span>
                </a>`).join('');
            
            DOMElements.mobileNavContainer.innerHTML = TABS.map(tab => `
                <a href="#${tab.id}" data-tab="${tab.id}" class="nav-link block px-4 py-3 text-base font-medium rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fas ${tab.icon} w-5 mr-3"></i>${tab.name}
                </a>`).join('') + `
                <div class="border-t border-border-color my-2"></div>
                <button id="mobile-dark-mode-toggle" class="w-full text-left block px-4 py-3 text-base font-medium rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fas fa-moon w-5 mr-3"></i><span>Modo Oscuro</span>
                </button>
            `;
            
            document.getElementById('mobile-dark-mode-toggle').addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                applyTheme(newTheme);
            });
            
            document.querySelectorAll('.nav-link').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.hash = '#' + e.currentTarget.dataset.tab;
                    if (!DOMElements.mobileMenu.classList.contains('hidden')) {
                        toggleMobileMenu();
                    }
                });
            });
            window.addEventListener('hashchange', handleHashChange);
            updateThemeToggleIcons();
            handleHashChange(); // Initial render
        }
        
        function toggleMobileMenu() {
            const isHidden = DOMElements.mobileMenu.classList.toggle('hidden');
            DOMElements.mobileMenuOverlay.classList.toggle('hidden', isHidden);
            document.body.classList.toggle('overflow-hidden', !isHidden);
        }

        function handleHashChange() {
            if (!isDataLoaded) return;
            const hash = window.location.hash.substring(1) || TABS[0].id;
            
            document.querySelectorAll('.nav-link').forEach(tb => {
                tb.classList.toggle('active', tb.dataset.tab === hash);
            });

            const template = document.getElementById(`template-${hash}-content`);
            if (template) {
                DOMElements.contentArea.innerHTML = '';
                DOMElements.contentArea.appendChild(template.content.cloneNode(true));
                
                const renderFunction = window[`render${hash.charAt(0).toUpperCase() + hash.slice(1).replace(/-/g, '')}`];
                if (typeof renderFunction === 'function') {
                    renderFunction();
                }
            } else {
                DOMElements.contentArea.innerHTML = `<div class="card p-6">Contenido para '${hash}' no encontrado.</div>`;
            }
        }
        
        // --- DATA CALCULATION ---
        function getStatsForPeriod(year, period) {
            try {
                const filteredMatches = allMatches.filter(match => {
                    if (!match.match_date) return false;
                    const matchDate = new Date(match.match_date);
                    if (isNaN(matchDate.getTime())) return false; // Invalid date check
                    
                    const matchYear = matchDate.getUTCFullYear();
                    const matchMonth = matchDate.getUTCMonth(); // 0-11
                    
                    if (matchYear != year) return false;
                    if (period === 'total') return true;
                    if (period === 'apertura') return matchMonth < 6;
                    if (period === 'clausura') return matchMonth >= 6;
                    return false;
                });

                const stats = {};
                allPlayers.forEach(p => {
                    stats[p.id] = { name: p.name, id: p.id, points: 0, pg: 0, pe: 0, pp: 0, pj: 0, chamigos: 0, tt: 0 };
                });

                const totalPlayedMatches = filteredMatches.filter(m => m.result !== 'Suspendido').length;

                filteredMatches.forEach(match => {
                    const playersInMatch = [...new Set([...(match.team_white_players || []), ...(match.team_dark_players || [])])];
                    playersInMatch.forEach(pId => {
                        if (!stats[pId]) return;
                        if (match.result !== 'Suspendido') {
                            stats[pId].pj++;
                            const isWinner = (match.result === 'Claros' && (match.team_white_players || []).includes(pId)) || (match.result === 'Oscuros' && (match.team_dark_players || []).includes(pId));
                            const isTie = match.result === 'Empate';
                            
                            if (isWinner) {
                                stats[pId].points += 3;
                                stats[pId].pg++;
                            } else if (isTie) {
                                stats[pId].points += 1;
                                stats[pId].pe++;
                            }
                        }
                    });

                    if (match.chamigo_votes && Object.keys(match.chamigo_votes).length) {
                        const maxVotes = Math.max(0, ...Object.values(match.chamigo_votes));
                        if(maxVotes > 0) {
                            Object.entries(match.chamigo_votes).forEach(([pIdStr, votes]) => {
                                const pIdNum = parseInt(pIdStr, 10);
                                if (votes === maxVotes && stats[pIdNum]) {
                                    stats[pIdNum].chamigos++;
                                }
                            });
                        }
                    }
                    if (match.tt_attendees) {
                        match.tt_attendees.forEach(pId => { if(stats[pId]) stats[pId].tt++; });
                    }
                });

                return Object.values(stats).map(s => {
                    s.pp = s.pj - s.pg - s.pe;
                    return {
                        ...s,
                        efectividad: s.pj > 0 ? ((s.points / (s.pj * 3)) * 100).toFixed(2) : "0.00",
                        ausentes: Math.max(0, totalPlayedMatches - s.pj)
                    };
                });
            } catch (error) {
                console.error("Error in getStatsForPeriod:", error);
                return null; 
            }
        }

        // --- RENDER FUNCTIONS (one for each tab) ---
        
        function setupFilterListeners(prefix, renderFn) {
            const yearSelect = document.getElementById(`${prefix}-year-select`);
            const periodSelect = document.getElementById(`${prefix}-period-select`);
            
            const years = [...new Set(allMatches
                .map(m => {
                    if (!m.match_date) return null;
                    const date = new Date(m.match_date);
                    return isNaN(date.getTime()) ? null : date.getUTCFullYear();
                })
                .filter(y => y !== null)
            )].sort((a, b) => b - a);

            if (years.length === 0) {
                console.error("No valid years found in match data.");
                yearSelect.innerHTML = `<option>Sin Años</option>`;
                return;
            }

            yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentPeriod = today.getMonth() < 6 ? 'apertura' : 'clausura';
            if (years.includes(currentYear)) yearSelect.value = currentYear;
            periodSelect.value = currentPeriod;
            
            yearSelect.addEventListener('change', renderFn);
            periodSelect.addEventListener('change', renderFn);
        }
        
        function renderLeaderboard() {
            setupFilterListeners('leaderboard', renderLeaderboardContent);
            renderLeaderboardContent();
        }
        function renderLeaderboardContent() {
            const prefix = 'leaderboard';
            const year = document.getElementById(`${prefix}-year-select`).value;
            const period = document.getElementById(`${prefix}-period-select`).value;
            const tableBody = document.querySelector(`#${prefix}-table tbody`);
            const loadingMsg = document.getElementById(`${prefix}-loading-message`);
            const table = document.getElementById(`${prefix}-table`);

            loadingMsg.classList.remove('hidden'); table.classList.add('hidden');
            const stats = getStatsForPeriod(year, period);

            if (stats === null) {
                loadingMsg.textContent = 'Error al procesar los datos.';
                loadingMsg.style.color = 'var(--danger-color)';
                return;
            }
            
            const rankedPlayers = stats.filter(p => p.pj > 0).sort((a, b) => b.points - a.points || b.efectividad - a.efectividad);

            if (rankedPlayers.length === 0) {
                loadingMsg.textContent = 'No hay datos para los filtros seleccionados.';
                return;
            }

            tableBody.innerHTML = rankedPlayers.map((p, i) => `
                <tr class="border-b border-border-color">
                    <td class="p-4 text-secondary">${i + 1}</td>
                    <td class="p-4 font-medium">${p.name}</td>
                    <td class="p-4 text-center font-semibold">${p.points}</td>
                    <td class="p-4 text-center text-secondary">${p.efectividad}%</td>
                </tr>`).join('');

            loadingMsg.classList.add('hidden'); table.classList.remove('hidden');
        }
        
        function renderChamigo() {
            setupFilterListeners('chamigo', renderChamigoContent);
            renderChamigoContent();
        }
        function renderChamigoContent() {
            const prefix = 'chamigo';
            const year = document.getElementById(`${prefix}-year-select`).value;
            const period = document.getElementById(`${prefix}-period-select`).value;
            const tableBody = document.querySelector(`#${prefix}-table tbody`);
            const loadingMsg = document.getElementById(`${prefix}-loading-message`);
            const table = document.getElementById(`${prefix}-table`);

            loadingMsg.classList.remove('hidden'); table.classList.add('hidden');
            const stats = getStatsForPeriod(year, period);

            if (stats === null) { loadingMsg.textContent = 'Error al procesar los datos.'; return; }
            
            const rankedPlayers = stats.filter(p => p.chamigos > 0).sort((a, b) => b.chamigos - a.chamigos);

            if (rankedPlayers.length === 0) { loadingMsg.textContent = 'No hay datos.'; return; }

            tableBody.innerHTML = rankedPlayers.map((p, i) => `
                <tr class="border-b border-border-color">
                    <td class="p-4 text-secondary">${i + 1}</td>
                    <td class="p-4 font-medium">${p.name}</td>
                    <td class="p-4 text-center font-semibold">${p.chamigos}</td>
                </tr>`).join('');
            loadingMsg.classList.add('hidden'); table.classList.remove('hidden');
        }
        
        function renderTt() {
            setupFilterListeners('tt', renderTtContent);
            renderTtContent();
        }
        function renderTtContent() {
            const prefix = 'tt';
            const year = document.getElementById(`${prefix}-year-select`).value;
            const period = document.getElementById(`${prefix}-period-select`).value;
            const tableBody = document.querySelector(`#${prefix}-table tbody`);
            const loadingMsg = document.getElementById(`${prefix}-loading-message`);
            const table = document.getElementById(`${prefix}-table`);

            loadingMsg.classList.remove('hidden'); table.classList.add('hidden');
            const stats = getStatsForPeriod(year, period);

            if (stats === null) { loadingMsg.textContent = 'Error al procesar los datos.'; return; }
            
            const rankedPlayers = stats.filter(p => p.tt > 0).sort((a, b) => b.tt - a.tt);

            if (rankedPlayers.length === 0) { loadingMsg.textContent = 'No hay datos.'; return; }

            tableBody.innerHTML = rankedPlayers.map((p, i) => `
                <tr class="border-b border-border-color">
                    <td class="p-4 text-secondary">${i + 1}</td>
                    <td class="p-4 font-medium">${p.name}</td>
                    <td class="p-4 text-center font-semibold">${p.tt}</td>
                </tr>`).join('');
            loadingMsg.classList.add('hidden'); table.classList.remove('hidden');
        }

        function renderPresentismo() {
            setupFilterListeners('presentismo', renderPresentismoContent);
            renderPresentismoContent();
        }
        function renderPresentismoContent() {
            const prefix = 'presentismo';
            const year = document.getElementById(`${prefix}-year-select`).value;
            const period = document.getElementById(`${prefix}-period-select`).value;
            const tableBody = document.querySelector(`#${prefix}-table tbody`);
            const loadingMsg = document.getElementById(`${prefix}-loading-message`);
            const table = document.getElementById(`${prefix}-table`);

            loadingMsg.classList.remove('hidden'); table.classList.add('hidden');
            const stats = getStatsForPeriod(year, period);

            if (stats === null) { loadingMsg.textContent = 'Error al procesar los datos.'; return; }
            
            const rankedPlayers = stats.filter(p => p.pj > 0).sort((a, b) => b.pj - a.pj);
            
            if (rankedPlayers.length === 0) { loadingMsg.textContent = 'No hay datos.'; return; }

            tableBody.innerHTML = rankedPlayers.map((p, i) => `
                <tr class="border-b border-border-color">
                    <td class="p-4 text-secondary">${i + 1}</td>
                    <td class="p-4 font-medium">${p.name}</td>
                    <td class="p-4 text-center font-semibold">${p.pj}</td>
                </tr>`).join('');
            loadingMsg.classList.add('hidden'); table.classList.remove('hidden');
        }
        
        function renderAusentismo() {
            setupFilterListeners('ausentismo', renderAusentismoContent);
            renderAusentismoContent();
        }
        function renderAusentismoContent() {
            const prefix = 'ausentismo';
            const year = document.getElementById(`${prefix}-year-select`).value;
            const period = document.getElementById(`${prefix}-period-select`).value;
            const tableBody = document.querySelector(`#${prefix}-table tbody`);
            const loadingMsg = document.getElementById(`${prefix}-loading-message`);
            const table = document.getElementById(`${prefix}-table`);

            loadingMsg.classList.remove('hidden'); table.classList.add('hidden');
            const stats = getStatsForPeriod(year, period);

            if (stats === null) { loadingMsg.textContent = 'Error al procesar los datos.'; return; }
            
            const rankedPlayers = stats.filter(p => p.ausentes > 0).sort((a, b) => b.ausentes - a.ausentes);
            
            if (rankedPlayers.length === 0) { loadingMsg.textContent = 'No hay datos.'; return; }

            tableBody.innerHTML = rankedPlayers.map((p, i) => `
                <tr class="border-b border-border-color">
                    <td class="p-4 text-secondary">${i + 1}</td>
                    <td class="p-4 font-medium">${p.name}</td>
                    <td class="p-4 text-center font-semibold">${p.ausentes}</td>
                </tr>`).join('');
            loadingMsg.classList.add('hidden'); table.classList.remove('hidden');
        }

        function renderEstadisticas() {
            setupFilterListeners('estadisticas', renderEstadisticasContent);
            renderEstadisticasContent();
        }
        function renderEstadisticasContent() {
            const year = document.getElementById('estadisticas-year-select').value;
            const period = document.getElementById('estadisticas-period-select').value;
            const tableBody = document.querySelector('#estadisticas-table tbody');
            const loadingMsg = document.getElementById('estadisticas-loading-message');
            const table = document.getElementById('estadisticas-table');

            loadingMsg.classList.remove('hidden'); table.classList.add('hidden');
            const stats = getStatsForPeriod(year, period);
            
            if (stats === null) {
                loadingMsg.textContent = 'Error al procesar los datos.';
                loadingMsg.style.color = 'var(--danger-color)';
                return;
            }

            const rankedPlayers = stats.filter(p => p.pj > 0).sort((a, b) => b.points - a.points);
            
            tableBody.innerHTML = rankedPlayers.map((p, i) => `
                <tr class="border-b border-border-color">
                    <td class="p-4 text-secondary sticky-col sticky-col-1">${i + 1}</td>
                    <td class="p-4 font-medium sticky-col sticky-col-2">${p.name}</td>
                    <td class="p-4 text-center font-semibold">${p.points}</td>
                    <td class="p-4 text-center text-secondary">${p.pg}</td>
                    <td class="p-4 text-center text-secondary">${p.pe}</td>
                    <td class="p-4 text-center text-secondary">${p.pp}</td>
                    <td class="p-4 text-center text-secondary">${p.pj}</td>
                    <td class="p-4 text-center text-secondary">${p.efectividad}%</td>
                    <td class="p-4 text-center text-secondary">${p.chamigos}</td>
                    <td class="p-4 text-center text-secondary">${p.tt}</td>
                    <td class="p-4 text-center text-secondary">${p.ausentes}</td>
                </tr>`).join('');
            loadingMsg.classList.add('hidden'); table.classList.remove('hidden');
        }

        function renderEquipos() {
            setupFilterListeners('equipos', renderEquiposContent);
            renderEquiposContent();
        }
        function renderEquiposContent() {
            const year = document.getElementById('equipos-year-select').value;
            const period = document.getElementById('equipos-period-select').value;
            const display = document.getElementById('equipos-stats-display');
            const loadingMsg = document.getElementById('equipos-loading-message');

            loadingMsg.classList.remove('hidden'); display.classList.add('hidden');
            
            const filteredMatches = allMatches.filter(match => {
                const matchDate = new Date(match.match_date);
                const matchYear = matchDate.getUTCFullYear();
                const matchMonth = matchDate.getUTCMonth();
                if (matchYear != year) return false;
                if (period === 'total') return true;
                if (period === 'apertura') return matchMonth < 6;
                if (period === 'clausura') return matchMonth >= 6;
                return false;
            });
            
            const teamStats = filteredMatches.reduce((acc, match) => {
                if (match.result === 'Claros') acc.clarosWins++;
                else if (match.result === 'Oscuros') acc.oscurosWins++;
                else if (match.result === 'Empate') acc.empates++;
                else if (match.result === 'Suspendido') acc.suspendidos++;
                if (match.result !== 'Suspendido') acc.totalPJ++;
                return acc;
            }, { clarosWins: 0, oscurosWins: 0, empates: 0, suspendidos: 0, totalPJ: 0 });
            
            const statCard = (title, value, color) => `
                <div class="card rounded-lg p-4 text-center shadow-sm">
                    <div class="text-3xl font-bold" style="color:${color};">${value}</div>
                    <div class="text-sm font-medium text-secondary uppercase mt-1">${title}</div>
                </div>`;
            
            display.innerHTML = 
                statCard('Victorias Claros', teamStats.clarosWins, 'var(--accent-color)') +
                statCard('Victorias Oscuros', teamStats.oscurosWins, 'var(--accent-color)') +
                statCard('Empates', teamStats.empates, 'var(--warning-color)') +
                statCard('Suspendidos', teamStats.suspendidos, 'var(--danger-color)') +
                statCard('Partidos Jugados', teamStats.totalPJ, 'var(--text-primary)');

            loadingMsg.classList.add('hidden'); display.classList.remove('hidden');
        }

        function renderFixture() {
            const yearSelect = document.getElementById('fixture-year-select');
            const monthSelect = document.getElementById('fixture-month-select');
            
            const years = [...new Set(allMatches.map(m => new Date(m.match_date).getUTCFullYear()))].sort((a, b) => b - a);
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
            monthSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            
            const today = new Date();
            if (years.includes(today.getFullYear())) yearSelect.value = today.getFullYear();
            monthSelect.value = today.getMonth();

            yearSelect.addEventListener('change', renderFixtureContent);
            monthSelect.addEventListener('change', renderFixtureContent);
            renderFixtureContent();
        }
        function renderFixtureContent() {
            const year = document.getElementById('fixture-year-select').value;
            const month = document.getElementById('fixture-month-select').value;
            const cardsContainer = document.getElementById('fixture-matches-cards-container');
            const loadingMsg = document.getElementById('fixture-loading-message');

            loadingMsg.classList.remove('hidden');
            cardsContainer.innerHTML = '';
            document.getElementById('fixture-details-container').classList.add('hidden');
            document.getElementById('fixture-details-placeholder').classList.remove('hidden');

            const filteredMatches = allMatches.filter(match => {
                const matchDate = new Date(match.match_date);
                return matchDate.getUTCFullYear() == year && matchDate.getUTCMonth() == month;
            });

            if (filteredMatches.length === 0) {
                loadingMsg.textContent = 'No hay partidos para este mes.';
                return;
            }

            cardsContainer.innerHTML = filteredMatches.map(match => {
                const matchDate = new Date(match.match_date);
                const formattedDate = matchDate.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC' });
                let resultText = !match.result ? 'Pendiente' : (match.result === 'Suspendido' ? 'Suspendido' : `Ganó ${match.result}`);
                return `
                    <div class="fixture-match-item p-3 rounded-lg border border-border-color hover:bg-table-row-hover cursor-pointer" data-match-id="${match.id}">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">${formattedDate}</span>
                            <span class="text-xs text-secondary">${resultText}</span>
                        </div>
                    </div>`;
            }).join('');
            
            cardsContainer.querySelectorAll('.fixture-match-item').forEach(card => {
                card.addEventListener('click', (e) => {
                    document.querySelectorAll('.fixture-match-item').forEach(c => c.classList.remove('bg-indigo-50', 'dark:bg-indigo-900/50', 'border-accent-color'));
                    e.currentTarget.classList.add('bg-indigo-50', 'dark:bg-indigo-900/50', 'border-accent-color');
                    renderFixtureDetails(e.currentTarget.dataset.matchId);
                });
            });

            loadingMsg.classList.add('hidden');
        }
        function renderFixtureDetails(matchId) {
            const match = allMatches.find(m => m.id == matchId);
            if (!match) return;

            const getPlayerName = id => (allPlayers.find(p => p.id === id) || {name: '?'}).name;
            
            document.getElementById('fixture-details-placeholder').classList.add('hidden');
            document.getElementById('fixture-details-container').classList.remove('hidden');
            
            const matchDate = new Date(match.match_date).toLocaleDateString('es-AR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
            document.getElementById('fixture-date-header').textContent = matchDate;

            const fieldContainer = document.getElementById('soccer-field-container');
            fieldContainer.innerHTML = '';
            const positions = [{x:'50%',y:'85%'},{x:'25%',y:'65%'},{x:'75%',y:'65%'},{x:'40%',y:'50%'},{x:'60%',y:'50%'}];
            
            const createPlayerMarker = (pId, team, index) => {
                const isChamigo = match.chamigo_votes && Object.keys(match.chamigo_votes).length > 0 && Object.keys(match.chamigo_votes).includes(String(pId));
                const playerEl = document.createElement('div');
                playerEl.className = 'player-wrapper absolute flex flex-col items-center';
                playerEl.style.left = positions[index].x;
                playerEl.style.top = team === 'claros' ? positions[index].y : `${100 - parseInt(positions[index].y)}%`;
                playerEl.style.transform = 'translate(-50%, -50%)';
                playerEl.innerHTML = `
                    <div class="player-marker ${team} w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs relative">
                        ${String(pId).replace('J','')}
                        ${isChamigo ? '<i class="fas fa-star"></i>' : ''}
                    </div>
                    <span class="player-name-label text-xs mt-1 px-1 rounded">${getPlayerName(pId)}</span>`;
                fieldContainer.appendChild(playerEl);
            };

            (match.team_white_players || []).forEach((pId, i) => createPlayerMarker(pId, 'claros', i));
            (match.team_dark_players || []).forEach((pId, i) => createPlayerMarker(pId, 'oscuros', i));

            const chamigosDiv = document.getElementById('chamigos-display');
            if (match.chamigo_votes && Object.keys(match.chamigo_votes).length > 0) {
                const maxVotes = Math.max(0, ...Object.values(match.chamigo_votes));
                const chamigos = Object.entries(match.chamigo_votes).filter(([, votes]) => votes === maxVotes).map(([pId]) => getPlayerName(parseInt(pId)));
                chamigosDiv.innerHTML = `<p>${chamigos.join(', ')}</p>`;
            } else { chamigosDiv.innerHTML = `<p class="text-secondary">Sin votos.</p>`; }
            
            const ttDiv = document.getElementById('tt-attendees-display');
            if (match.tt_attendees && match.tt_attendees.length > 0) {
                ttDiv.innerHTML = `<p>${match.tt_attendees.map(pId => getPlayerName(pId)).join(', ')}</p>`;
            } else { ttDiv.innerHTML = `<p class="text-secondary">Sin asistentes.</p>`; }
        }

        function renderIndividualstats() {
            setupPlayerSearch();
        }
        function setupPlayerSearch() {
            const searchInput = document.getElementById('individual-player-search');
            const resultsDiv = document.getElementById('individual-player-results');

            searchInput.addEventListener('input', () => {
                const term = searchInput.value.toLowerCase();
                if (term.length < 2) {
                    resultsDiv.classList.add('hidden');
                    return;
                }
                const filteredPlayers = allPlayers.filter(p => p.name.toLowerCase().includes(term));
                resultsDiv.innerHTML = filteredPlayers.map(p => 
                    `<div class="p-2 cursor-pointer hover:bg-table-row-hover" data-id="${p.id}" data-name="${p.name}">${p.name}</div>`
                ).join('');
                resultsDiv.classList.remove('hidden');
            });

            resultsDiv.addEventListener('click', (e) => {
                if(e.target.dataset.id) {
                    searchInput.value = e.target.dataset.name;
                    searchInput.dataset.selectedId = e.target.dataset.id;
                    resultsDiv.classList.add('hidden');
                    renderIndividualStatsContent();
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.classList.add('hidden');
                }
            });
        }
        function renderIndividualStatsContent() {
            const tableBody = document.querySelector('#individual-stats-table tbody');
            const loadingMsg = document.getElementById('individual-stats-loading-message');
            const table = document.getElementById('individual-stats-table');
            const playerId = document.getElementById('individual-player-search').dataset.selectedId;

            table.classList.add('hidden');
            loadingMsg.classList.remove('hidden');
            
            const playerMatches = allMatches.filter(m => (m.team_white_players || []).includes(parseInt(playerId)) || (m.team_dark_players || []).includes(parseInt(playerId)));
            
            if (playerMatches.length === 0) {
                loadingMsg.textContent = 'Este jugador no tiene partidos registrados.';
                return;
            }

            const statsByYear = {};
            playerMatches.forEach(match => {
                const year = new Date(match.match_date).getUTCFullYear();
                if (!statsByYear[year]) {
                    statsByYear[year] = { 
                        apertura: null,
                        clausura: null,
                        total: null
                    };
                }
            });
            
            Object.keys(statsByYear).forEach(year => {
                statsByYear[year].apertura = getStatsForPeriod(year, 'apertura').find(p => p.id == playerId) || {pj:0,pg:0,pe:0,pp:0,points:0,chamigos:0,tt:0, ausentes:0, efectividad: "0.00"};
                statsByYear[year].clausura = getStatsForPeriod(year, 'clausura').find(p => p.id == playerId) || {pj:0,pg:0,pe:0,pp:0,points:0,chamigos:0,tt:0, ausentes:0, efectividad: "0.00"};
                statsByYear[year].total = getStatsForPeriod(year, 'total').find(p => p.id == playerId) || {pj:0,pg:0,pe:0,pp:0,points:0,chamigos:0,tt:0, ausentes:0, efectividad: "0.00"};
            });
            
            let html = '';
            const renderRow = (year, period, data) => `
                <tr class="border-b border-border-color">
                    <td class="p-4 font-medium sticky-col sticky-col-1">${year}</td>
                    <td class="p-4 sticky-col sticky-col-2">${period}</td>
                    <td class="p-4 text-center font-semibold">${data.points}</td>
                    <td class="p-4 text-center">${data.pg}</td><td class="p-4 text-center">${data.pe}</td>
                    <td class="p-4 text-center">${data.pp}</td><td class="p-4 text-center">${data.pj}</td>
                    <td class="p-4 text-center">${data.efectividad}%</td><td class="p-4 text-center">${data.chamigos}</td>
                    <td class="p-4 text-center">${data.tt}</td><td class="p-4 text-center">${data.ausentes}</td>
                </tr>`;

            Object.keys(statsByYear).sort((a,b) => b-a).forEach(year => {
                const yearData = statsByYear[year];
                html += renderRow(year, 'Total Anual', yearData.total);
                if (yearData.apertura.pj > 0) html += renderRow('', 'Apertura', yearData.apertura);
                if (yearData.clausura.pj > 0) html += renderRow('', 'Clausura', yearData.clausura);
            });
            
            tableBody.innerHTML = html;
            loadingMsg.classList.add('hidden');
            table.classList.remove('hidden');
        }

        // --- RUN APP ---
        init();
    });
    </script>
</body>
</html>
