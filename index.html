<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas - LA CLANDE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- FORMA CORRECTA DE IMPORTAR GOOGLE FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚽</text></svg>">

    <style>
        :root {
            --bg-primary: #f4f7fe;
            --bg-secondary: #ffffff;
            --bg-muted: #f9fafb;
            --sidebar-bg: #111827;
            --sidebar-text: #e5e7eb;
            --sidebar-active-bg: #4f46e5;
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #374151;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --accent-color: #4f46e5;
            --accent-color-hover: #4338ca;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --button-text-color: #ffffff;
            --text-yellow-400: #facc15;
            --player-claros-bg: #ffffff;
            --player-claros-text: #1a202c;
            --player-oscuros-bg: #1a202c;
            --player-oscuros-text: #ffffff;
        }

        html.dark {
            --bg-primary: #030712;
            --bg-secondary: #1f2937;
            --bg-muted: #111827;
            --sidebar-bg: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --accent-color: #6366f1;
            --accent-color-hover: #818cf8;
        }

        html {
            background-color: var(--bg-primary);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            min-height: 100vh; /* Asegura que el body ocupe al menos toda la altura de la pantalla */
        }
        body.overflow-hidden { overflow: hidden; }

        @media (min-width: 768px) {
            body { display: flex; }
        }
        
        .main-content-container {
            background-color: var(--bg-secondary);
            padding: 1.5rem;
            min-height: 100%; /* CORRECCIÓN FINAL: height -> min-height */
        }
        @media (max-width: 767px) {
            .main-content-container { }
        }

        input, select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.375rem;
        }
        html.dark input, html.dark select {
             background-color: var(--bg-muted);
        }
        label { color: var(--text-secondary); }

        #side-menu {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: transform 0.3s ease-in-out;
            z-index: 40;
            border-right: 1px solid var(--border-color);
        }
        html.dark #side-menu {
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
        }
        
        #side-menu .tab-button.active { background-color: var(--sidebar-active-bg); color: var(--sidebar-active-text); font-weight: 600; }
        
        html:not(.dark) #side-menu .tab-button:hover:not(.active) { background-color: #eef2ff; }
        html.dark #side-menu .tab-button:hover:not(.active) { background-color: var(--sidebar-hover-bg); }

        #overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 30; }
        
        header.md\:hidden {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        html.dark header.md\:hidden {
            background-color: #111827;
        }
        
        @media (min-width: 768px) {
            #side-menu { position: relative; transform: translateX(0); flex-shrink: 0; height: 100vh; }
            #hamburger-button, #overlay { display: none !important; }
            .flex-1.flex.flex-col { height: 100vh; } /* Se aplica la altura solo a desktop */
        }

        .table-container {
            max-height: 70vh;
            overflow-y: auto;
            border-radius: 0.5rem;
            position: relative;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,.05), 0 1px 2px -1px rgba(0,0,0,.05);
            border: 1px solid var(--border-color);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead th {
            background-color: var(--bg-muted);
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.75rem;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--border-color);
        }
        html.dark thead th {
            background-color: #111827;
        }
        thead th[data-sort] { cursor: pointer; transition: background-color 0.2s; }
        thead th[data-sort]:hover { background-color: var(--border-color); }
        html.dark thead th[data-sort]:hover { background-color: var(--sidebar-hover-bg); }
        
        td {
            border-top: 1px solid var(--border-color);
        }
        tbody td {
            color: var(--text-primary);
            transition: background-color 150ms ease-in-out;
        }
        
        tbody tr:nth-child(odd) { background-color: var(--bg-secondary); }
        tbody tr:nth-child(even) { background-color: var(--bg-muted); }
        
        html.dark tbody tr:nth-child(odd) { background-color: #1f2937; }
        html.dark tbody tr:nth-child(even) { background-color: #111827; }

        tbody tr:hover td,
        tbody tr:hover td.sticky-col {
            background-color: #eef2ff;
        }
        html.dark tbody tr:hover td,
        html.dark tbody tr:hover td.sticky-col {
            background-color: var(--sidebar-hover-bg);
        }
        
        #estadisticas-table, #individual-stats-table { min-width: 800px; }
        .sticky-col {
            position: sticky;
            z-index: 5;
            background-color: var(--bg-muted);
        }
        tbody tr:nth-child(odd) .sticky-col {
            background-color: var(--bg-secondary);
        }
        html.dark .sticky-col {
            background-color: #111827;
        }
        html.dark tbody tr:nth-child(odd) .sticky-col {
            background-color: #1f2937;
        }
        
        #individual-stats-table tr.font-bold td,
        #individual-stats-table tr.font-bold td.sticky-col {
            background-color: var(--accent-color) !important;
            color: var(--button-text-color);
        }
        
        #individual-stats-table tr.font-bold:hover td,
        #individual-stats-table tr.font-bold:hover td.sticky-col {
            background-color: var(--accent-color-hover) !important;
        }

        #estadisticas-table .sticky-col-1, #individual-stats-table .sticky-col-1 { left: 0; }
        #estadisticas-table .sticky-col-2 { left: 36px; }
        #individual-stats-table .sticky-col-2 { left: 90px; }
        thead th.sticky-col { z-index: 15; }
        
        .button-primary { background-color: var(--accent-color); color: var(--button-text-color); }
        .button-primary:hover { background-color: var(--accent-color-hover); }
        .collapsible-toggle-button { background: linear-gradient(to right, var(--accent-color), var(--accent-color-hover)); color: var(--button-text-color); }
        .collapsible-toggle-button.visible-content { background: linear-gradient(to right, #e53e3e, var(--danger-color)); }

        #soccer-field-container {
            position: relative;
            width: 100%;
            padding-top: 168.75%;
            background-color: #0f8d48;
            border: 2px solid white;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #soccer-field-container::before {
            content: ''; position: absolute; top: 50%; left: 0; right: 0;
            height: 2px; background-color: rgba(255,255,255,0.7); transform: translateY(-50%); z-index: 1;
        }
        #soccer-field-container::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 20%; padding-top: 20%; border: 2px solid rgba(255,255,255,0.7);
            border-radius: 50%; transform: translate(-50%, -50%); z-index: 1;
        }
        .goal-area, .penalty-area { position: absolute; box-sizing: border-box; border-style: solid; border-color: rgba(255,255,255,0.7); z-index: 1; }
        .goal-area.top { top: 0; left: 35%; width: 30%; height: 8%; border-width: 0 2px 2px 2px; }
        .goal-area.bottom { bottom: 0; left: 35%; width: 30%; height: 8%; border-width: 2px 2px 0 2px; }
        .penalty-area.top { top: 0; left: 20%; width: 60%; height: 18%; border-width: 0 2px 2px 2px; }
        .penalty-area.bottom { bottom: 0; left: 20%; width: 60%; height: 18%; border-width: 2px 2px 0 2px; }
        
        @media (min-width: 768px) {
            #soccer-field-container.horizontal-layout { padding-top: 60%; }
            #soccer-field-container.horizontal-layout::before { top: 0; left: 50%; height: 100%; width: 2px; transform: translateX(-50%); }
            #soccer-field-container.horizontal-layout::after { width: 15%; padding-top: 15%; }
            .goal-area.top.horizontal-layout { top: 35%; left: 0; height: 30%; width: 8%; border-width: 2px 2px 2px 0; }
            .goal-area.bottom.horizontal-layout { top: 35%; right: 0; left: auto; height: 30%; width: 8%; border-width: 2px 0 2px 2px; }
            .penalty-area.top.horizontal-layout { top: 20%; left: 0; height: 60%; width: 18%; border-width: 2px 2px 2px 0; }
            .penalty-area.bottom.horizontal-layout { top: 20%; right: 0; left: auto; height: 60%; width: 18%; border-width: 2px 0 2px 2px; }
        }

        #fixture-details-display { background-color: var(--bg-secondary); border: 1px solid var(--border-color); }
        .fixture-match-item { background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); }
        .fixture-match-item.selected { box-shadow: 0 0 0 2px var(--accent-color); border-color: var(--accent-color); }
        .fixture-match-item.current-match-card { background: linear-gradient(to right, var(--accent-color), var(--accent-color-hover)); color: var(--button-text-color); border-color: transparent;}
        
        .player-marker { border: 2px solid; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .player-marker.claros { background-color: var(--player-claros-bg); color: var(--player-claros-text); border-color: var(--player-claros-text); }
        .player-marker.oscuros { background-color: var(--player-oscuros-bg); color: var(--player-oscuros-text); border-color: var(--player-oscuros-text); }
        .player-name-label { background-color: var(--bg-secondary); color: var(--text-primary); }
        .winner-trophy { color: var(--text-yellow-400); text-shadow: 0 0 5px rgba(0,0,0,0.5); }

        #individual-player-results { background-color: var(--bg-secondary); border: 1px solid var(--border-color); z-index: 20; }
        #individual-player-results > div:hover { background-color: var(--bg-muted); }
        #individual-player-search { padding-right: 2.5rem !important; }
        #clear-player-search { color: var(--text-muted); }
        
        .loading-spinner { border: 4px solid var(--border-color); border-top: 4px solid var(--accent-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-message { color: var(--text-secondary); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        html.dark ::-webkit-scrollbar-thumb { background: #555; }
        html.dark ::-webkit-scrollbar-thumb:hover { background: #888; }
        
        .sidebar-group-header {
            background-color: var(--bg-muted);
            border-bottom: 1px solid var(--border-color);
        }
        html.dark .sidebar-group-header {
            background-color: #111827;
        }
        .fixture-header {
            background-color: var(--warning-color);
            color: var(--button-text-color);
            font-weight: 600;
        }
        .fixture-header:hover {
            opacity: 0.9;
        }
        html.dark .fixture-header {
            background-color: #d97706;
        }
        .fixture-header.active {
             background-color: var(--warning-color) !important;
             opacity: 1 !important;
        }
        html.dark .fixture-header.active {
            background-color: #d97706 !important;
        }
        
        .multi-year-select-button {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.375rem;
            position: relative;
            text-align: left;
            padding-right: 2.5rem;
        }
        html.dark .multi-year-select-button {
             background-color: var(--bg-muted);
        }
        .multi-year-select-dropdown {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        .multi-year-select-dropdown label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            transition: background-color 0.2s;
        }
        .multi-year-select-dropdown label:hover {
            background-color: var(--bg-muted);
        }
        html.dark .multi-year-select-dropdown label:hover {
            background-color: #374151;
        }
        .multi-year-select-dropdown input[type="checkbox"] {
            margin-right: 0.5rem;
        }
    </style>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="antialiased">

    <!-- Header para móvil -->
    <header class="sticky top-0 z-30 flex items-center justify-between p-4 md:hidden">
        <div class="w-10">
            <button id="hamburger-button" class="p-2 rounded-md -ml-2 text-text-primary">
                <i class="fas fa-bars text-lg"></i>
            </button>
        </div>
        <div class="flex-1 text-center">
            <a href="#" class="text-xl font-bold flex items-center gap-2 justify-center">
                <span class="text-2xl">⚽</span>
                <span>LA CLANDE</span>
            </a>
        </div>
        <div class="w-10 flex justify-end items-center">
             <button id="dark-mode-toggle-mobile" class="p-2 rounded-full text-text-primary">
                <i class="fas fa-moon text-lg"></i>
            </button>
        </div>
    </header>
    
    <!-- Menú lateral -->
    <nav id="side-menu" class="fixed top-0 left-0 h-full w-64 transform -translate-x-full transition-transform duration-300 ease-in-out md:transform-none md:relative md:w-64 flex flex-col">
        <div class="px-6 py-4 flex items-center">
            <a href="#" class="text-xl font-bold flex items-center gap-2">
                <span class="text-2xl">⚽</span>
                <span>LA CLANDE</span>
            </a>
        </div>
        
        <div class="flex-1 px-4 space-y-2 overflow-y-auto">
            <!-- Sección Vista Celular -->
            <div>
                <button class="collapsible-trigger sidebar-group-header w-full flex justify-between items-center px-4 py-2.5 text-left font-semibold rounded-lg">
                    <span class="flex items-center gap-3"><i class="fas fa-mobile-alt w-5 text-center"></i>Vista Celular</span>
                    <i class="fas fa-chevron-down transform transition-transform"></i>
                </button>
                <div class="collapsible-content mt-1 space-y-1 pl-4">
                    <a href="#leaderboard" class="tab-button w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200" data-tab="leaderboard-content"><i class="fas fa-trophy w-5 text-center"></i>Posiciones</a>
                    <a href="#chamigo" class="tab-button w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200" data-tab="chamigo-content"><i class="fas fa-star w-5 text-center"></i>Chamigo</a>
                    <a href="#tt" class="tab-button w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200" data-tab="tt-content"><i class="fas fa-beer w-5 text-center"></i>TT</a>
                    <a href="#presentismo" class="tab-button w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200" data-tab="presentismo-content"><i class="fas fa-check-circle w-5 text-center"></i>Presentismo</a>
                    <a href="#ausentismo" class="tab-button w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200" data-tab="ausentismo-content"><i class="fas fa-times-circle w-5 text-center"></i>Ausentismo</a>
                    <a href="#equipos" class="tab-button w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200" data-tab="equipos-content"><i class="fas fa-futbol w-5 text-center"></i>Equipos</a>
                </div>
            </div>

            <!-- Enlace Fixture -->
            <a href="#fixture" class="tab-button fixture-header w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200 mt-2" data-tab="fixture-content"><i class="fas fa-calendar-alt w-5 text-center"></i>Fixture</a>

            <!-- Sección Vista PC -->
            <div class="mt-2">
                <button class="collapsible-trigger sidebar-group-header w-full flex justify-between items-center px-4 py-2.5 text-left font-semibold rounded-lg">
                    <span class="flex items-center gap-3"><i class="fas fa-laptop w-5 text-center"></i>Vista PC</span>
                    <i class="fas fa-chevron-down transform transition-transform"></i>
                </button>
                <div class="collapsible-content hidden mt-1 space-y-1 pl-4">
                    <a href="#estadisticas" class="tab-button w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200" data-tab="estadisticas-content"><i class="fas fa-chart-bar w-5 text-center"></i>Estadísticas</a>
                    <a href="#individual-stats" class="tab-button w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200" data-tab="individual-stats-content"><i class="fas fa-history w-5 text-center"></i>Histórico</a>
                </div>
            </div>
            
            <div class="mt-6">
                <span class="px-4 text-xs font-semibold uppercase text-gray-400">Panel</span>
                <div class="mt-2 space-y-1">
                    <a href="admin.html" target="_blank" rel="noopener noreferrer" class="w-full text-left flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors duration-200">
                        <i class="fas fa-user-shield w-5 text-center"></i><span>Admin</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>
    <div id="overlay" class="hidden md:hidden"></div>

    <!-- Contenedor principal -->
    <div class="flex-1 flex flex-col">
        <!-- Header para Escritorio -->
        <header class="hidden md:flex items-center justify-between p-4 border-b border-border-color bg-gradient-to-r from-indigo-500 to-purple-500 dark:from-indigo-700 dark:to-purple-700 shadow-lg shrink-0">
            <div class="w-10"></div>
            <div class="flex-1 text-center text-2xl font-bold text-white uppercase tracking-wider">
                <span id="desktop-header-title"></span>
            </div>
            <div class="w-10">
                <button id="dark-mode-toggle-desktop" class="p-2 w-10 h-10 rounded-full hover:bg-white/20 text-white">
                   <i class="fas fa-moon text-lg"></i>
               </button>
            </div>
       </header>

        <main class="flex-1 overflow-y-auto">
        </main>
    </div>

    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        if (typeof window.SUPABASE_URL === 'undefined' || typeof window.SUPABASE_ANON_KEY === 'undefined') {
            console.error("Error: Las variables de configuración de Supabase no están definidas. Asegúrate de que config.js se cargue correctamente.");
            document.querySelector('main').innerHTML = `<div class="main-content-container text-center text-red-500"><p>Error de configuración. No se pudo conectar a la base de datos.</p></div>`;
            return;
        }

        const FilterSessionManager = {
            SESSION_KEY: 'laClandeFilterSession',
            TIMEOUT_MS: 10 * 60 * 1000, 

            getSession: function() {
                const sessionData = localStorage.getItem(this.SESSION_KEY);
                if (!sessionData) return null;
                try {
                    return JSON.parse(sessionData);
                } catch (e) {
                    console.error("Error parsing filter session", e);
                    return null;
                }
            },

            isExpired: function(session) {
                if (!session || !session.lastActivity) return true;
                const now = new Date().getTime();
                return (now - session.lastActivity) > this.TIMEOUT_MS;
            },

            startOrResume: function() {
                const session = this.getSession();
                if (this.isExpired(session)) {
                    this.clear();
                    return null;
                }
                return session.filters;
            },

            update: function(filters) {
                if (!filters || Object.keys(filters).length === 0) {
                    const existingSession = this.getSession();
                     if (existingSession) { 
                        const sessionData = {
                            filters: existingSession.filters,
                            lastActivity: new Date().getTime()
                        };
                        localStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
                    }
                    return;
                }
                const sessionData = {
                    filters: filters,
                    lastActivity: new Date().getTime()
                };
                localStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
            },

            clear: function() {
                localStorage.removeItem(this.SESSION_KEY);
            }
        };

        const supabaseClient = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

        let allPlayersData = [];
        let allMatchesData = [];
        let lastSelectedFixtureMatchId = null;
        let currentEstadisticasData = []; 
        let globalFilterState = {}; 
        let statsChannel = null;
        let heartbeatInterval = null;

        let estadisticasSortState = { criterion: 'points', order: 'desc' };

        const renderFunctions = {
            'leaderboard-content': renderLeaderboard, 'chamigo-content': renderChamigo, 'tt-content': renderTT,
            'presentismo-content': renderPresentismo, 'ausentismo-content': renderAusentismo, 'estadisticas-content': renderEstadisticas,
            'equipos-content': renderEquipos, 'fixture-content': renderFixture, 'individual-stats-content': renderIndividualStatsTable
        };

        const DOMElements = {
            body: document.body,
            hamburgerButton: document.getElementById('hamburger-button'),
            sideMenu: document.getElementById('side-menu'),
            overlay: document.getElementById('overlay'),
            darkModeToggleMobile: document.getElementById('dark-mode-toggle-mobile'),
            darkModeToggleDesktop: document.getElementById('dark-mode-toggle-desktop'),
            mainContentArea: document.querySelector('main'),
            tabButtons: document.querySelectorAll('.tab-button'),
            collapsibleTriggers: document.querySelectorAll('.collapsible-trigger'),
        };

        const hashToTabMap = {
            "#leaderboard": "leaderboard-content", "#chamigo": "chamigo-content", "#tt": "tt-content",
            "#presentismo": "presentismo-content", "#ausentismo": "ausentismo-content", "#estadisticas": "estadisticas-content",
            "#equipos": "equipos-content", "#fixture": "fixture-content", "#individual-stats": "individual-stats-content"
        };
        
        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            localStorage.setItem('theme', theme);
            
            const isDark = theme === 'dark';
            const icons = [
                DOMElements.darkModeToggleMobile.querySelector('i'),
                DOMElements.darkModeToggleDesktop.querySelector('i')
            ];
            
            icons.forEach(icon => {
                if (icon) {
                    icon.classList.toggle('fa-sun', isDark);
                    icon.classList.toggle('fa-moon', !isDark);
                }
            });

            if (document.querySelector('.tab-button.active')?.dataset.tab === 'fixture-content' && lastSelectedFixtureMatchId) {
                renderFixtureDetails(lastSelectedFixtureMatchId);
            }
        }

        function toggleTheme() {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
        }
        
        function openSideMenu() {
            DOMElements.overlay.classList.remove('hidden');
            DOMElements.sideMenu.classList.remove('-translate-x-full');
            DOMElements.sideMenu.classList.add('translate-x-0');
            DOMElements.body.classList.add('overflow-hidden');
        }

        function closeSideMenu() {
            DOMElements.sideMenu.classList.add('-translate-x-full');
            DOMElements.sideMenu.classList.remove('translate-x-0');
            DOMElements.overlay.classList.add('hidden');
            DOMElements.body.classList.remove('overflow-hidden');
        }

        function applyInitialResponsiveStyles() {
             if (window.innerWidth >= 768) {
                DOMElements.sideMenu.classList.remove('-translate-x-full', 'translate-x-0');
                DOMElements.overlay.classList.add('hidden');
                DOMElements.body.classList.remove('overflow-hidden');
            } else {
                DOMElements.sideMenu.classList.add('-translate-x-full');
            }
        }
        
        function parseDate(dateString) { 
            if (!dateString) return new Date();
            return new Date(dateString + 'T00:00:00'); 
        }

        function populateMonthSelects(selectId) {
            const monthSelect = document.getElementById(selectId);
            if (!monthSelect) return;
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const currentValue = monthSelect.value;
            monthSelect.innerHTML = '<option value="all">Todos los Meses</option>';
            months.forEach((month, index) => monthSelect.innerHTML += `<option value="${index + 1}">${month}</option>`);
            if (currentValue) monthSelect.value = currentValue;
        }
        
        function setTodayFilters(prefix, isMonthFilter = false) {
             const today = new Date();
             const periodOrMonthSelect = isMonthFilter ? document.getElementById(`${prefix}-month-select`) : document.getElementById(`${prefix}-period-select`);
             
             const yearCheckboxes = document.querySelectorAll(`#${prefix}-year-select-dropdown input[type="checkbox"]`);
             yearCheckboxes.forEach(cb => {
                 cb.checked = (cb.value == today.getFullYear());
             });
             updateMultiYearButtonText(prefix);
             
             if(periodOrMonthSelect) {
                 periodOrMonthSelect.value = isMonthFilter ? today.getMonth() + 1 : (today.getMonth() <= 5 ? 'apertura' : 'clausura');
             }
        }

        function calculateStatsForPeriod(prefix) {
            const selectedYearsCheckboxes = document.querySelectorAll(`#${prefix}-year-select-dropdown input[type="checkbox"]:checked`);
            const selectedYears = Array.from(selectedYearsCheckboxes).map(cb => cb.value);
            const selectedPeriod = document.getElementById(`${prefix}-period-select`)?.value;
        
            let timeFilteredMatches = allMatchesData;

            if (selectedYears.length > 0) {
                timeFilteredMatches = timeFilteredMatches.filter(match => {
                    const matchYear = parseDate(match.match_date).getFullYear();
                    return selectedYears.includes(String(matchYear));
                });
            }
        
            if (selectedPeriod && selectedPeriod !== 'total') {
                timeFilteredMatches = timeFilteredMatches.filter(match => {
                    const month = parseDate(match.match_date).getMonth();
                    const period = (month <= 5) ? 'apertura' : 'clausura';
                    return period === selectedPeriod;
                });
            }
        
            const filteredMatches = timeFilteredMatches.filter(match => match.result);
        
            const playerStats = {};
            allPlayersData.forEach(player => {
                playerStats[player.id] = { name: player.name, points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: "0.00", chamigos: 0, tt: 0, ausentes: 0, id: player.id };
            });
        
            let clarosWins = 0, oscurosWins = 0, empates = 0, suspendidos = 0, totalPJMatches = 0;
            (filteredMatches || []).forEach(match => {
                const { team_white_players, team_dark_players, result, chamigo_votes, tt_attendees } = match;
                const allPlayersInMatch = [...new Set([...(team_white_players || []), ...(team_dark_players || [])])];
                
                if (result !== 'Suspendido') totalPJMatches++;
                else suspendidos++;
        
                allPlayersInMatch.forEach(pId => {
                    if (playerStats[pId]) {
                        if (result === 'Claros' && (team_white_players || []).includes(pId)) { playerStats[pId].points += 3; playerStats[pId].pg++; }
                        else if (result === 'Oscuros' && (team_dark_players || []).includes(pId)) { playerStats[pId].points += 3; playerStats[pId].pg++; }
                        else if (result === 'Empate') { playerStats[pId].points += 1; playerStats[pId].pe++; }
                        else if (result !== 'Suspendido') { playerStats[pId].pp++; }
                        if (result !== 'Suspendido') playerStats[pId].pj++;
                    }
                });
                if (result === 'Claros') clarosWins++;
                else if (result === 'Oscuros') oscurosWins++;
                else if (result === 'Empate') empates++;
                if (chamigo_votes && Object.keys(chamigo_votes).length > 0) {
                    const votosArray = Object.entries(chamigo_votes).map(([id, votos]) => ({ id, votos }));
                    if (votosArray.length > 0) {
                        const maxVotes = Math.max(...votosArray.map(v => v.votos));
                        votosArray.filter(v => v.votos === maxVotes).forEach(chamigo => {
                            if (playerStats[chamigo.id]) playerStats[chamigo.id].chamigos++;
                        });
                    }
                }
                if (tt_attendees) {
                    tt_attendees.forEach(pId => { if (playerStats[pId]) playerStats[pId].tt++; });
                }
            });
            Object.values(playerStats).forEach(player => {
                const maxPossiblePoints = player.pj * 3;
                let currentEfectividad = (maxPossiblePoints > 0) ? (player.points / maxPossiblePoints) * 100 : 0;
                if (totalPJMatches > 0) {
                    const participationRatio = player.pj / totalPJMatches;
                    player.efectividad = (participationRatio < 0.20) ? (currentEfectividad * participationRatio).toFixed(2) : currentEfectividad.toFixed(2);
                } else {
                    player.efectividad = "0.00";
                }
                player.ausentes = Math.max(0, totalPJMatches - player.pj);
            });
        
            let playersToShow;
            if (selectedYears.length > 0) {
                const yearlyPlayerIds = new Set();
                timeFilteredMatches.forEach(match => {
                    (match.team_white_players || []).forEach(id => yearlyPlayerIds.add(id));
                    (match.team_dark_players || []).forEach(id => yearlyPlayerIds.add(id));
                });
                playersToShow = Object.values(playerStats).filter(p => yearlyPlayerIds.has(p.id));
            } else {
                playersToShow = Object.values(playerStats).filter(p => p.pj > 0);
            }
        
            return {
                players: playersToShow,
                teamStats: { clarosWins, oscurosWins, empates, suspendidos, totalPJMatches },
                error: null
            };
        }

        function renderGenericTable(section, filterFn, sortFn, renderRowFn, headers) {
            const table = document.getElementById(`${section}-table`);
            const loadingMessage = document.getElementById(`${section}-loading-message`);
            if (!table || !loadingMessage) return;

            table.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Calculando...`;
            
            const { players, error } = calculateStatsForPeriod(section);
            
            if (error) {
                loadingMessage.innerHTML = 'Error al calcular los datos.';
                return;
            }

            const rankedPlayers = players.filter(filterFn).sort(sortFn);
            if (rankedPlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos disponibles para los filtros seleccionados.`;
                return;
            }
            
            table.innerHTML = `
                <thead><tr>${headers.map(h => `<th class="p-3 text-center">${h}</th>`).join('')}</tr></thead>
                <tbody>${rankedPlayers.map(renderRowFn).join('')}</tbody>`;

            loadingMessage.classList.add('hidden');
            table.classList.remove('hidden');
        }

        function renderLeaderboard() {
            renderGenericTable(
                'leaderboard',
                () => true,
                (a, b) => b.points - a.points,
                (player, index) => `
                    <tr>
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3 text-center">${player.name}</td>
                        <td class="p-3 text-center">${player.points}</td>
                        <td class="p-3 text-center">${player.efectividad}%</td>
                    </tr>`,
                ['#', 'Jugador', 'Puntos', 'Efectividad']
            );
        }

        function renderChamigo() {
            renderGenericTable(
                'chamigo',
                p => p.chamigos > 0,
                (a, b) => b.chamigos - a.chamigos,
                (player, index) => `
                    <tr>
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3 text-center">${player.name}</td>
                        <td class="p-3 text-center">${player.chamigos}</td>
                    </tr>`,
                ['#', 'Jugador', 'Chamigos']
            );
        }
        
        function renderTT() {
            renderGenericTable(
                'tt',
                p => p.tt > 0,
                (a, b) => b.tt - a.tt,
                (player, index) => `
                    <tr>
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3 text-center">${player.name}</td>
                        <td class="p-3 text-center">${player.tt}</td>
                    </tr>`,
                ['#', 'Jugador', 'TT']
            );
        }

        function renderPresentismo() {
            renderGenericTable(
                'presentismo',
                () => true,
                (a, b) => b.pj - a.pj,
                (player, index) => `
                    <tr>
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3 text-center">${player.name}</td>
                        <td class="p-3 text-center">${player.pj}</td>
                    </tr>`,
                ['#', 'Jugador', 'PJ']
            );
        }
        
        function renderAusentismo() {
            renderGenericTable(
                'ausentismo',
                () => true,
                (a, b) => b.ausentes - a.ausentes,
                (player, index) => `
                    <tr>
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3 text-center">${player.name}</td>
                        <td class="p-3 text-center">${player.ausentes}</td>
                    </tr>`,
                ['#', 'Jugador', 'Ausentes']
            );
        }

        function renderEstadisticas(fromSort = false) {
            const table = document.getElementById('estadisticas-table');
            const loadingMessage = document.getElementById('estadisticas-loading-message');
            if (!table || !loadingMessage) return;
            
            if (!fromSort) {
                table.classList.add('hidden');
                loadingMessage.classList.remove('hidden');
                const { players, error } = calculateStatsForPeriod('estadisticas');
                if (error) { loadingMessage.innerHTML = 'Error al cargar los datos.'; return; }
                currentEstadisticasData = players;
            }

            const sortCriterion = estadisticasSortState.criterion;
            const sortOrder = estadisticasSortState.order;
            const rankedPlayers = [...currentEstadisticasData].sort((a, b) => {
                let valA = parseFloat(a[sortCriterion]) || 0;
                let valB = parseFloat(b[sortCriterion]) || 0;
                return sortOrder === 'asc' ? valA - valB : valB - valA;
            });
            
            if (rankedPlayers.length === 0) { loadingMessage.innerHTML = `No hay datos disponibles.`; return; }

            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="p-2 text-center sticky-col sticky-col-1">#</th>
                        <th class="p-3 text-center sticky-col sticky-col-2">Jugador</th>
                        <th class="p-3 text-center" data-sort="points">Puntos</th>
                        <th class="p-3 text-center" data-sort="pg">PG</th>
                        <th class="p-3 text-center" data-sort="pe">PE</th>
                        <th class="p-3 text-center" data-sort="pp">PP</th>
                        <th class="p-3 text-center" data-sort="pj">PJ</th>
                        <th class="p-3 text-center" data-sort="efectividad">Efectividad</th>
                        <th class="p-3 text-center" data-sort="chamigos">Chamigo</th>
                        <th class="p-3 text-center" data-sort="tt">TT</th>
                        <th class="p-3 text-center" data-sort="ausentes">Ausentismo</th>
                    </tr>
                </thead>
                <tbody>
                    ${rankedPlayers.map((player, index) => `
                    <tr>
                        <td class="p-2 text-center sticky-col sticky-col-1">${index + 1}</td>
                        <td class="p-3 text-center sticky-col sticky-col-2">${player.name}</td>
                        <td class="p-3 text-center">${player.points}</td><td class="p-3 text-center">${player.pg}</td><td class="p-3 text-center">${player.pe}</td>
                        <td class="p-3 text-center">${player.pp}</td><td class="p-3 text-center">${player.pj}</td><td class="p-3 text-center">${player.efectividad}%</td>
                        <td class="p-3 text-center">${player.chamigos}</td><td class="p-3 text-center">${player.tt}</td><td class="p-3 text-center">${player.ausentes}</td>
                    </tr>`).join('')}
                </tbody>`;

            loadingMessage.classList.add('hidden');
            table.classList.remove('hidden');
            
            const activeTh = table.querySelector(`thead th[data-sort="${sortCriterion}"]`);
            if (activeTh) {
                const icon = document.createElement('i');
                icon.className = `fas fa-chevron-${sortOrder === 'desc' ? 'down' : 'up'} ml-2`;
                activeTh.appendChild(icon);
            }
        }

        function renderEquipos() {
            const statsDisplay = document.getElementById('equipos-stats-display');
            const loadingMessage = document.getElementById('equipos-loading-message');
            if (!statsDisplay || !loadingMessage) return;

            statsDisplay.classList.add('hidden');
            loadingMessage.classList.remove('hidden');

            const { teamStats, error } = calculateStatsForPeriod('equipos');

            if (error) { loadingMessage.innerHTML = 'Error al cargar los datos.'; return; }
            
            const statCard = (value, label, bgColor, textColor = 'var(--button-text-color)') => `
                <div class="p-4 rounded-lg shadow-md flex flex-col items-center justify-center w-full min-h-[120px]" style="background-color: ${bgColor}; color: ${textColor};">
                    <span class="text-3xl font-bold">${value}</span><span class="text-sm uppercase mt-1 font-semibold">${label}</span>
                </div>`;
            
            const clarosBgColor = '#E2E8F0';
            const clarosTextColor = '#1A202C';
            const empatesBgColor = 'var(--warning-color)';

            statsDisplay.innerHTML = 
                statCard(teamStats.oscurosWins, 'Oscuros Ganados', '#1a202c') +
                statCard(teamStats.clarosWins, 'Claros Ganados', clarosBgColor, clarosTextColor) +
                statCard(teamStats.empates, 'Empates', empatesBgColor) +
                statCard(teamStats.suspendidos, 'Suspendidos', 'var(--danger-color)') +
                statCard(teamStats.totalPJMatches, 'Partidos Jugados', 'var(--accent-color)');

            loadingMessage.classList.add('hidden');
            statsDisplay.classList.remove('hidden');
        }
        
        function renderFixture(isFilterChange = false) {
            const cardsContainer = document.getElementById('fixture-matches-cards-container');
            const loadingMessage = document.getElementById('fixture-loading-message');
            
            const selectedYearsCheckboxes = document.querySelectorAll(`#fixture-year-select-dropdown input[type="checkbox"]:checked`);
            const selectedYears = Array.from(selectedYearsCheckboxes).map(cb => cb.value);
            const month = document.getElementById('fixture-month-select').value;
            
            if (!cardsContainer || !loadingMessage) return;

            cardsContainer.innerHTML = '';
            loadingMessage.classList.remove('hidden');

            let filteredMatches = allMatchesData;
            if (selectedYears.length > 0) {
                filteredMatches = filteredMatches.filter(m => selectedYears.includes(String(parseDate(m.match_date).getFullYear())));
            }
            if (month && month !== 'all') {
                filteredMatches = filteredMatches.filter(m => parseDate(m.match_date).getMonth() + 1 == month);
            }

            if (!filteredMatches || filteredMatches.length === 0) { loadingMessage.innerHTML = `No hay partidos disponibles.`; lastSelectedFixtureMatchId = null; return; }

            filteredMatches.sort((a, b) => new Date(b.match_date) - new Date(a.match_date));
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let currentOrFutureMatchFound = false;

            cardsContainer.innerHTML = filteredMatches.map(match => {
                const matchDateObj = parseDate(match.match_date);
                let isCurrent = !currentOrFutureMatchFound && matchDateObj.getTime() >= today.getTime();
                if(isCurrent) currentOrFutureMatchFound = true;

                return `
                    <div class="fixture-match-item p-2 rounded-lg shadow-sm cursor-pointer transition flex justify-center items-center text-center text-sm font-semibold sm:p-4 sm:shadow-md ${isCurrent ? 'current-match-card' : ''}" data-match-id="${match.id}">
                        ${isCurrent ? 'PARTIDO ACTUAL' : `${matchDateObj.toLocaleDateString('es-AR', {timeZone: 'UTC'})}`}
                    </div>`;
            }).join('');

            cardsContainer.querySelectorAll('.fixture-match-item').forEach(card => card.addEventListener('click', (e) => {
                cardsContainer.querySelectorAll('.fixture-match-item').forEach(c => c.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                renderFixtureDetails(e.currentTarget.dataset.matchId, true);
            }));

            loadingMessage.classList.add('hidden');

            if (!isFilterChange) {
                setTimeout(() => {
                    const currentMatchCard = document.querySelector('.current-match-card');
                    const firstCard = cardsContainer.querySelector('[data-match-id]');
                    if (currentMatchCard) {
                        currentMatchCard.classList.add('selected');
                        renderFixtureDetails(currentMatchCard.dataset.matchId, false);
                    } else if (firstCard) {
                        firstCard.classList.add('selected');
                        renderFixtureDetails(firstCard.dataset.matchId, false);
                    }
                }, 100);
            }
        }

        function renderFixtureDetails(matchId, fromUserClick = false) {
            const match = allMatchesData.find(m => m.id == matchId);
            if (!match) {
                console.error("Detalles del partido no encontrados localmente para el ID:", matchId);
                return;
            }

            lastSelectedFixtureMatchId = matchId;

            const visualDetailsContainer = document.getElementById('fixture-visual-details-container');
            const soccerFieldContainer = document.getElementById('soccer-field-container');
            const ttAttendeesTableBody = document.querySelector('#tt-attendees-table tbody');
            const collapsibleContent = document.getElementById('fixture-filters-collapsible');
            const filterToggle = document.getElementById('fixture-filter-toggle');

            if (!visualDetailsContainer || !soccerFieldContainer || !ttAttendeesTableBody) return;

            soccerFieldContainer.innerHTML = `
                <div class="goal-area top"></div><div class="goal-area bottom"></div>
                <div class="penalty-area top"></div><div class="penalty-area bottom"></div>`;

            const { team_white_players, team_dark_players, result, chamigo_votes, tt_attendees } = match;
            const getPlayerName = id => (allPlayersData.find(p => p.id === id) || { name: 'ID Desconocido' }).name;

            ttAttendeesTableBody.innerHTML = (Array.isArray(tt_attendees) && tt_attendees.length > 0)
                ? tt_attendees.map(id => `
                    <tr><td class="p-3 text-center">${getPlayerName(id)}</td></tr>`
                  ).join('')
                : `<tr><td class="p-4 text-center text-gray-500" colspan="1">No hay asistentes al TT.</td></tr>`;

            const isHorizontalField = window.innerWidth >= 768;
            soccerFieldContainer.classList.toggle('horizontal-layout', isHorizontalField);
            soccerFieldContainer.querySelectorAll('.goal-area, .penalty-area').forEach(el => el.classList.toggle('horizontal-layout', isHorizontalField));

            const playerPositions = {
                vertical: {
                    claros:  [{ x: 0.5, y: 0.94 }, { x: 0.25, y: 0.78 }, { x: 0.75, y: 0.78 }, { x: 0.35, y: 0.62 }, { x: 0.65, y: 0.57 }],
                    oscuros: [{ x: 0.5, y: 0.06 }, { x: 0.25, y: 0.22 }, { x: 0.75, y: 0.22 }, { x: 0.35, y: 0.38 }, { x: 0.65, y: 0.43 }]
                },
                horizontal: {
                    claros:  [{ x: 0.90, y: 0.50 }, { x: 0.80, y: 0.25 }, { x: 0.80, y: 0.75 }, { x: 0.62, y: 0.35 }, { x: 0.57, y: 0.65 }],
                    oscuros: [{ x: 0.10, y: 0.50 }, { x: 0.20, y: 0.25 }, { x: 0.20, y: 0.75 }, { x: 0.38, y: 0.35 }, { x: 0.43, y: 0.65 }]
                }
            };
            const currentPositions = isHorizontalField ? playerPositions.horizontal : playerPositions.vertical;

            let chamigoPlayerIds = [];
            if (chamigo_votes && Object.keys(chamigo_votes).length > 0) {
                const votesArray = Object.values(chamigo_votes);
                const maxVotes = Math.max(...votesArray);
                if (maxVotes > 0) {
                    chamigoPlayerIds = Object.keys(chamigo_votes).filter(id => chamigo_votes[id] === maxVotes);
                }
            }

            const createPlayerMarker = (playerId, team, index) => {
                const playerWrapper = document.createElement('div');
                playerWrapper.className = `player-wrapper absolute transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-1 z-10`;
                playerWrapper.style.top = `${currentPositions[team][index].y * 100}%`;
                playerWrapper.style.left = `${currentPositions[team][index].x * 100}%`;

                const playerNumber = Number(playerId.replace('J', ''));
                const isChamigo = chamigoPlayerIds.includes(playerId);

                let markerHTML = `
                    <div class="player-marker ${team} relative w-10 h-10 md:w-16 md:h-16 rounded-full flex items-center justify-center text-sm md:text-xl font-bold text-center">
                        ${playerNumber}
                        ${isChamigo ? '<i class="fas fa-star text-yellow-400 absolute -top-3 -right-2 text-lg md:text-2xl"></i>' : ''}
                    </div>
                    <div class="player-name-label text-xs font-bold px-2 py-0.5 rounded-md">${getPlayerName(playerId)}</div>`;
                
                playerWrapper.innerHTML = markerHTML;
                soccerFieldContainer.appendChild(playerWrapper);
            };

            (team_white_players || []).slice(0, 5).forEach((id, i) => createPlayerMarker(id, 'claros', i));
            (team_dark_players || []).slice(0, 5).forEach((id, i) => createPlayerMarker(id, 'oscuros', i));

            if (result && result !== 'Empate' && result !== 'Suspendido') {
                const trophyDiv = document.createElement('div');
                trophyDiv.className = 'winner-trophy absolute text-3xl md:text-5xl z-20 transform -translate-x-1/2 -translate-y-1/2';
                trophyDiv.innerHTML = '<i class="fas fa-trophy"></i>';

                const trophyPositions = {
                    horizontal: {
                        Claros:  { top: '92%', left: '95%' },
                        Oscuros: { top: '92%', left: '5%' }
                    },
                    vertical: {
                        Claros:  { top: '95%', left: '92%' },
                        Oscuros: { top: '5%', left: '92%' }
                    }
                };

                const currentTrophyPosition = isHorizontalField ? trophyPositions.horizontal[result] : trophyPositions.vertical[result];
                
                if (currentTrophyPosition) {
                    Object.assign(trophyDiv.style, currentTrophyPosition);
                    soccerFieldContainer.appendChild(trophyDiv);
                }
            }

            visualDetailsContainer.classList.remove('hidden');
            
            if (collapsibleContent && fromUserClick && !collapsibleContent.classList.contains('hidden')) {
                collapsibleContent.classList.add('hidden');
                filterToggle.classList.remove('visible-content');
                filterToggle.querySelector('.toggle-icon')?.classList.remove('fa-chevron-up');
                filterToggle.querySelector('.toggle-icon')?.classList.add('fa-chevron-down');
            }
        }
        
        async function renderIndividualStatsTable() {
            const selectedPlayerId = document.getElementById('selected-player-id').value;
            const table = document.getElementById('individual-stats-table');
            const loadingMessage = document.getElementById('individual-stats-loading-message');
            if (!table || !loadingMessage) return;
            
            table.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            
            if(!selectedPlayerId) {
                loadingMessage.textContent = 'Selecciona un jugador para ver sus estadísticas.';
                return;
            }

            const { data: matches, error } = await supabaseClient.rpc('get_player_matches', { player_id_to_find: selectedPlayerId });

            if(error) { 
                console.error("Error fetching player matches:", error);
                loadingMessage.textContent = 'Error al cargar el historial del jugador.'; 
                return; 
            }
            if (!matches || matches.length === 0) { loadingMessage.textContent = 'Este jugador no tiene partidos registrados.'; return; }

            const playerStats = calculateIndividualPlayerStats(selectedPlayerId, matches);

            if (!playerStats) { loadingMessage.textContent = 'No se pudieron calcular las estadísticas.'; return; }
            
            let tableHtml = `
                <thead>
                    <tr>
                        <th class="p-3 text-left pl-4 sticky-col sticky-col-1">Año</th>
                        <th class="p-3 text-center sticky-col sticky-col-2">Torneo</th>
                        <th class="p-3 text-center">Puntos</th><th class="p-3 text-center">PG</th><th class="p-3 text-center">PE</th>
                        <th class="p-3 text-center">PP</th><th class="p-3 text-center">PJ</th><th class="p-3 text-center">Efectividad</th>
                        <th class="p-3 text-center">Chamigo</th><th class="p-3 text-center">TT</th><th class="p-3 text-center">Ausentismo</th>
                    </tr>
                </thead>
                <tbody>`;

            tableHtml += `
                <tr class="font-bold">
                    <td class="p-3 text-left pl-4 sticky-col sticky-col-1"><b>TOTAL</b></td>
                    <td class="p-3 text-center sticky-col sticky-col-2"></td>
                    <td class="p-3 text-center">${playerStats.overallTotal.points}</td><td class="p-3 text-center">${playerStats.overallTotal.pg}</td>
                    <td class="p-3 text-center">${playerStats.overallTotal.pe}</td><td class="p-3 text-center">${playerStats.overallTotal.pp}</td>
                    <td class="p-3 text-center">${playerStats.overallTotal.pj}</td><td class="p-3 text-center">${playerStats.overallTotal.efectividad}%</td>
                    <td class="p-3 text-center">${playerStats.overallTotal.chamigos}</td><td class="p-3 text-center">${playerStats.overallTotal.tt}</td>
                    <td class="p-3 text-center">${playerStats.overallTotal.ausentes}</td>
                </tr>`;

            Object.keys(playerStats.years).sort((a,b) => b-a).forEach(year => {
                const yearData = playerStats.years[year];
                if(yearData.total.pj > 0) {
                    tableHtml += `
                        <tr class="font-semibold cursor-pointer" data-year="${year}">
                            <td class="p-3 text-left pl-4 sticky-col sticky-col-1"><i class="fas fa-plus-circle toggle-details mr-2 text-accent-color"></i><b>${year}</b></td>
                            <td class="p-3 text-center sticky-col sticky-col-2"><b>TOTAL AÑO</b></td>
                            <td class="p-3 text-center">${yearData.total.points}</td><td class="p-3 text-center">${yearData.total.pg}</td>
                            <td class="p-3 text-center">${yearData.total.pe}</td><td class="p-3 text-center">${yearData.total.pp}</td>
                            <td class="p-3 text-center">${yearData.total.pj}</td><td class="p-3 text-center">${yearData.total.efectividad}%</td>
                            <td class="p-3 text-center">${yearData.total.chamigos}</td><td class="p-3 text-center">${yearData.total.tt}</td>
                            <td class="p-3 text-center">${yearData.total.ausentes}</td>
                        </tr>
                        <tr class="period-details-row hidden" data-year-parent="${year}">
                            <td class="p-3 text-left pl-12 sticky-col sticky-col-1"></td><td class="p-3 text-center sticky-col sticky-col-2">Clausura</td>
                            <td class="p-3 text-center">${yearData.clausura.points}</td><td class="p-3 text-center">${yearData.clausura.pg}</td>
                            <td class="p-3 text-center">${yearData.clausura.pe}</td><td class="p-3 text-center">${yearData.clausura.pp}</td>
                            <td class="p-3 text-center">${yearData.clausura.pj}</td><td class="p-3 text-center">${yearData.clausura.efectividad}%</td>
                            <td class="p-3 text-center">${yearData.clausura.chamigos}</td><td class="p-3 text-center">${yearData.clausura.tt}</td>
                            <td class="p-3 text-center">${yearData.clausura.ausentes}</td>
                        </tr>
                        <tr class="period-details-row hidden" data-year-parent="${year}">
                            <td class="p-3 text-left pl-12 sticky-col sticky-col-1"></td><td class="p-3 text-center sticky-col sticky-col-2">Apertura</td>
                            <td class="p-3 text-center">${yearData.apertura.points}</td><td class="p-3 text-center">${yearData.apertura.pg}</td>
                            <td class="p-3 text-center">${yearData.apertura.pe}</td><td class="p-3 text-center">${yearData.apertura.pp}</td>
                            <td class="p-3 text-center">${yearData.apertura.pj}</td><td class="p-3 text-center">${yearData.apertura.efectividad}%</td>
                            <td class="p-3 text-center">${yearData.apertura.chamigos}</td><td class="p-3 text-center">${yearData.apertura.tt}</td>
                            <td class="p-3 text-center">${yearData.apertura.ausentes}</td>
                        </tr>`;
                }
            });
            
            table.innerHTML = tableHtml + '</tbody>';
            loadingMessage.classList.add('hidden');
            table.classList.remove('hidden');
            
            table.querySelectorAll('[data-year]').forEach(row => {
                row.addEventListener('click', (e) => {
                    const year = row.dataset.year;
                    const toggleIcon = row.querySelector('.toggle-details');
                    document.querySelectorAll(`.period-details-row[data-year-parent="${year}"]`).forEach(r => r.classList.toggle('hidden'));
                    toggleIcon?.classList.toggle('fa-plus-circle');
                    toggleIcon?.classList.toggle('fa-minus-circle');
                });
            });
        }

        function calculateIndividualPlayerStats(playerId, allPlayerMatches) {
            const playerStats = { years: {}, overallTotal: { name: 'TOTAL', points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: "0.00", chamigos: 0, tt: 0, ausentes: 0 }};
            const allYearsInMatches = [...new Set(allPlayerMatches.map(m => m.match_date ? parseDate(m.match_date).getFullYear() : null).filter(Boolean))];
        
            allYearsInMatches.forEach(year => {
                playerStats.years[year] = {
                    apertura: { name: 'Apertura', points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: "0.00", chamigos: 0, tt: 0, ausentes: 0 },
                    clausura: { name: 'Clausura', points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: "0.00", chamigos: 0, tt: 0, ausentes: 0 },
                    total: { name: year, points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: "0.00", chamigos: 0, tt: 0, ausentes: 0 }
                };
            });
            
            allPlayerMatches.forEach(match => {
                 const { match_date, team_white_players, team_dark_players, result, chamigo_votes, tt_attendees } = match;
                 if (!result || !match_date) return;
        
                 const matchDate = parseDate(match_date);
                 const year = matchDate.getFullYear();
                 const period = matchDate.getMonth() <= 5 ? 'apertura' : 'clausura';
        
                 if (!playerStats.years[year]) return;
                 
                 const playerIsInMatch = (team_white_players || []).includes(playerId) || (team_dark_players || []).includes(playerId);
                 if (!playerIsInMatch) return;
        
                 const statsToUpdate = [playerStats.years[year][period], playerStats.years[year].total, playerStats.overallTotal];
                 
                 if (result !== 'Suspendido') {
                     statsToUpdate.forEach(s => s.pj++);
                     if (result === 'Claros' && (team_white_players || []).includes(playerId)) statsToUpdate.forEach(s => { s.points += 3; s.pg++; });
                     else if (result === 'Oscuros' && (team_dark_players || []).includes(playerId)) statsToUpdate.forEach(s => { s.points += 3; s.pg++; });
                     else if (result === 'Empate') statsToUpdate.forEach(s => { s.points += 1; s.pe++; });
                     else statsToUpdate.forEach(s => s.pp++);
                 }
        
                 if (chamigo_votes) {
                     const votosArray = Object.entries(chamigo_votes).map(([id, votos]) => ({ id, votos }));
                     if (votosArray.length > 0) {
                         const maxVotes = Math.max(...votosArray.map(v => v.votos));
                         if (votosArray.some(v => v.id === playerId && v.votos === maxVotes)) {
                             statsToUpdate.forEach(s => s.chamigos++);
                         }
                     }
                 }
                 if (tt_attendees && tt_attendees.includes(playerId)) {
                     statsToUpdate.forEach(s => s.tt++);
                 }
            });
        
            allYearsInMatches.forEach(year => {
                const yearData = playerStats.years[year];
                ['apertura', 'clausura', 'total'].forEach(periodType => {
                    const stats = yearData[periodType];
                    const totalMatchesInPeriod = allPlayerMatches.filter(m => {
                        if (!m.match_date || !m.result || m.result === 'Suspendido') return false;
                        const d = parseDate(m.match_date);
                        const p = d.getMonth() <= 5 ? 'apertura' : 'clausura';
                        const y = d.getFullYear();
                        if (periodType === 'total') return y === year;
                        return y === year && p === periodType;
                    }).length;
        
                    const maxPoints = stats.pj * 3;
                    stats.efectividad = maxPoints > 0 ? ((stats.points / maxPoints) * 100).toFixed(2) : "0.00";
                    stats.ausentes = Math.max(0, totalMatchesInPeriod - stats.pj);
                });
            });
        
            const totalNonSuspendedMatches = allPlayerMatches.filter(m => m.result && m.result !== 'Suspendido').length;
            const overall = playerStats.overallTotal;
            const maxTotalPoints = overall.pj * 3;
            overall.efectividad = maxTotalPoints > 0 ? ((overall.points / maxTotalPoints) * 100).toFixed(2) : "0.00";
            overall.ausentes = Math.max(0, totalNonSuspendedMatches - overall.pj);
        
            return playerStats;
        }

        function setupPlayerSearch() {
            const searchInput = document.getElementById('individual-player-search');
            const resultsDiv = document.getElementById('individual-player-results');
            const selectedIdInput = document.getElementById('selected-player-id');
            const clearButton = document.getElementById('clear-player-search');
            if(!searchInput || !resultsDiv || !selectedIdInput || !clearButton) return;

            const filterAndDisplay = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filtered = allPlayersData.filter(p => p.name.toLowerCase().includes(searchTerm)).sort((a, b) => a.name.localeCompare(b.name));
                resultsDiv.innerHTML = filtered.map(player => `<div class="p-2 cursor-pointer" data-player-id="${player.id}">${player.name}</div>`).join('');
                resultsDiv.classList.remove('hidden');
            };

            resultsDiv.addEventListener('mousedown', (e) => {
                if (e.target.dataset.playerId) {
                    const player = allPlayersData.find(p => p.id == e.target.dataset.playerId);
                    searchInput.value = player.name;
                    selectedIdInput.value = player.id;
                    resultsDiv.classList.add('hidden');
                    renderIndividualStatsTable();
                }
            });

            searchInput.addEventListener('input', filterAndDisplay);
            searchInput.addEventListener('focus', filterAndDisplay);
            searchInput.addEventListener('blur', () => setTimeout(() => resultsDiv.classList.add('hidden'), 150));

            clearButton.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                searchInput.value = '';
                selectedIdInput.value = '';
                document.getElementById('individual-stats-table').innerHTML = '';
                document.getElementById('individual-stats-loading-message').textContent = 'Selecciona un jugador para ver sus estadísticas.';
                searchInput.focus();
                filterAndDisplay();
            });
            
            if(allPlayersData.length > 0) {
                const defaultPlayer = allPlayersData.find(p => p.id === 'J001') || allPlayersData[0];
                if (defaultPlayer) {
                    searchInput.value = defaultPlayer.name;
                    selectedIdInput.value = defaultPlayer.id;
                }
            }
        }
        
        function getTabContentHTML(tabId) {
            const titles = {
                'leaderboard-content': 'Posiciones', 'chamigo-content': 'Chamigo', 'tt-content': 'Tercer Tiempo (TT)',
                'presentismo-content': 'Presentismo', 'ausentismo-content': 'Ausentismo', 'estadisticas-content': 'Estadísticas',
                'equipos-content': 'Equipos', 'fixture-content': 'Fixture', 'individual-stats-content': 'Histórico'
            };
            const title = titles[tabId] || 'Contenido';
            
            let baseHtml = `<div id="${tabId}" class="main-content-container space-y-6">
                <div class="relative flex md:hidden items-center justify-center p-4 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 dark:from-indigo-700 dark:to-purple-700 shadow-lg">
                    <h1 class="flex-1 text-2xl font-bold tracking-tight uppercase text-center text-white">${title}</h1>
                </div>`;
            
            const prefix = tabId.replace('-content', '');
            
            if (['leaderboard', 'chamigo', 'tt', 'presentismo', 'ausentismo', 'equipos', 'estadisticas', 'fixture'].includes(prefix)) {
                 const yearFilterHTML = `
                    <div>
                        <label for="${prefix}-year-select-button" class="block text-sm font-medium mb-1">Año(s):</label>
                        <div class="relative">
                            <button id="${prefix}-year-select-button" class="multi-year-select-button mt-1 block w-full p-2 text-sm shadow-sm">
                                <span class="truncate">Seleccionar Años</span>
                                <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </button>
                            <div id="${prefix}-year-select-dropdown" class="multi-year-select-dropdown absolute z-20 w-full rounded-md shadow-lg mt-1 hidden max-h-60 overflow-y-auto">
                            </div>
                        </div>
                    </div>
                 `;
                 
                 const periodOrMonthFilterHTML = prefix === 'fixture' ? `
                    <div>
                        <label for="fixture-month-select" class="block text-sm font-medium mb-1">Mes:</label>
                        <select id="fixture-month-select" class="mt-1 block w-full p-2 text-sm shadow-sm"></select>
                    </div>` : `
                    <div>
                        <label for="${prefix}-period-select" class="block text-sm font-medium mb-1">Torneo:</label>
                        <select id="${prefix}-period-select" class="mt-1 block w-full p-2 text-sm shadow-sm">
                            <option value="apertura">Apertura</option>
                            <option value="clausura">Clausura</option>
                            <option value="total">Totales</option>
                        </select>
                    </div>
                 `;

                 baseHtml += `
                    <div id="${prefix}-filter-toggle" class="collapsible-toggle-button p-3 rounded-md cursor-pointer flex items-center justify-between font-semibold">
                        <span>Seleccionar Torneo</span><i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div id="${prefix}-filters-collapsible" class="grid grid-cols-2 md:grid-cols-[1fr_2fr_2fr] gap-4 hidden items-end">
                        <button id="${prefix}-hoy-button" class="button-primary col-span-2 md:col-auto px-6 py-2 rounded-md shadow-sm">Torneo Actual</button>
                        ${yearFilterHTML}
                        ${periodOrMonthFilterHTML}
                    </div>`;
            }
            
            switch(tabId) {
                case 'leaderboard-content': case 'chamigo-content': case 'tt-content': case 'presentismo-content': case 'ausentismo-content':
                    baseHtml += `<div class="table-container">
                                    <p id="${prefix}-loading-message" class="loading-message p-4 flex items-center justify-center gap-2"><span class="loading-spinner"></span>Cargando...</p>
                                    <table id="${prefix}-table" class="hidden"></table>
                                 </div>`;
                    break;
                case 'estadisticas-content':
                     baseHtml += `
                        <div class="table-container overflow-x-auto">
                            <p id="estadisticas-loading-message" class="loading-message p-4 flex items-center justify-center gap-2"><span class="loading-spinner"></span>Cargando...</p>
                            <table id="estadisticas-table" class="hidden"></table>
                        </div>`;
                    break;
                case 'equipos-content':
                    baseHtml += `<p id="equipos-loading-message" class="loading-message p-4 flex items-center justify-center gap-2"><span class="loading-spinner"></span>Cargando...</p>
                                 <div id="equipos-stats-display" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>`;
                    break;
                case 'fixture-content':
                     baseHtml += `
                        <p id="fixture-loading-message" class="loading-message p-4 flex items-center justify-center gap-2"><span class="loading-spinner"></span>Cargando partidos...</p>
                        <h3 class="text-xl font-semibold mb-2">Partidos del Mes</h3>
                        <div id="fixture-matches-cards-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2"></div>
                        <div id="fixture-visual-details-container" class="flex flex-col md:flex-row md:space-x-6 mt-6 hidden">
                            <div class="md:w-[65%] min-w-0"><div id="soccer-field-container" class="rounded-lg overflow-hidden"></div></div>
                            <div id="fixture-details-display" class="flex-1 md:w-[35%] p-4 rounded-lg mt-6 md:mt-0">
                                <h3 class="font-semibold text-center mb-2">Asistentes al TT</h3>
                                <div class="table-container overflow-y-auto rounded-lg border shadow-sm">
                                    <table id="tt-attendees-table">
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>`;
                    break;
                case 'individual-stats-content':
                    baseHtml += `
                        <div class="mb-6">
                            <label for="individual-player-search" class="block text-sm font-medium mb-1">Buscar Jugador:</label>
                            <div class="relative">
                                <input type="text" id="individual-player-search" placeholder="Escribe para buscar..." class="mt-1 block w-full p-2 shadow-sm">
                                <button id="clear-player-search" class="absolute inset-y-0 right-0 pr-3 flex items-center focus:outline-none"><i class="fas fa-times-circle"></i></button>
                                <div id="individual-player-results" class="absolute z-10 w-full rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
                            </div>
                            <input type="hidden" id="selected-player-id">
                        </div>
                        <div class="table-container overflow-x-auto">
                            <p id="individual-stats-loading-message" class="loading-message p-4 flex items-center justify-center gap-2"><span class="loading-spinner"></span>Cargando...</p>
                            <table id="individual-stats-table" class="hidden"></table>
                        </div>`;
                    break;
            }
            
            baseHtml += `</div>`;
            return baseHtml;
        }

        function activateTab(tabId) {
            const titles = {
                'leaderboard-content': 'Posiciones', 'chamigo-content': 'Chamigo', 'tt-content': 'Tercer Tiempo (TT)',
                'presentismo-content': 'Presentismo', 'ausentismo-content': 'Ausentismo', 'estadisticas-content': 'Estadísticas',
                'equipos-content': 'Equipos', 'fixture-content': 'Fixture', 'individual-stats-content': 'Histórico'
            };
            const desktopTitleEl = document.getElementById('desktop-header-title');
            if (desktopTitleEl) {
                desktopTitleEl.textContent = titles[tabId] || 'Estadísticas';
            }

            DOMElements.mainContentArea.innerHTML = getTabContentHTML(tabId);
            
            DOMElements.tabButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabId);
            });
            
            setupDynamicEventListeners(tabId);
            
            if (renderFunctions[tabId]) {
                renderFunctions[tabId]();
            }
            
            localStorage.setItem('lastActiveTab', tabId);
            const hash = Object.keys(hashToTabMap).find(key => hashToTabMap[key] === tabId);
            if (hash && window.location.hash !== hash) {
                history.pushState(null, '', hash);
            }
        }
        
        function updateMultiYearButtonText(prefix) {
            const button = document.getElementById(`${prefix}-year-select-button`);
            if (!button) return;
            const buttonSpan = button.querySelector('span');
            const checked = document.querySelectorAll(`#${prefix}-year-select-dropdown input:checked`);
            const allYears = document.querySelectorAll(`#${prefix}-year-select-dropdown input[value]`);

            if (checked.length === 0 || checked.length === allYears.length) {
                buttonSpan.textContent = 'Todos los Años';
            } else if (checked.length === 1) {
                buttonSpan.textContent = checked[0].value;
            } else {
                buttonSpan.textContent = `${checked.length} Años seleccionados`;
            }
        }

        function populateMultiYearSelect(prefix, changeCallback) {
            const dropdown = document.getElementById(`${prefix}-year-select-dropdown`);
            const button = document.getElementById(`${prefix}-year-select-button`);
            if (!dropdown || !button) return;

            const years = [...new Set(allMatchesData.map(match => parseDate(match.match_date).getFullYear()))].sort((a, b) => b - a);
            
            dropdown.innerHTML = years.map(year => `
                <label>
                    <input type="checkbox" value="${year}" class="year-checkbox">
                    <span>${year}</span>
                </label>
            `).join('');

            // Restore state
            const savedYears = globalFilterState.years || [];
            if (savedYears.length > 0) {
                dropdown.querySelectorAll('input').forEach(cb => {
                    if (savedYears.includes(cb.value)) {
                        cb.checked = true;
                    }
                });
            } else {
                // Default to current year if no selection is saved
                const currentYear = new Date().getFullYear().toString();
                const currentYearCb = dropdown.querySelector(`input[value="${currentYear}"]`);
                if (currentYearCb) currentYearCb.checked = true;
            }
            updateMultiYearButtonText(prefix);

            dropdown.addEventListener('change', () => {
                updateMultiYearButtonText(prefix);
                changeCallback();
            });

            button.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
            });
        }

        function setupDynamicEventListeners(tabId) {
            const prefix = tabId.replace('-content', '');
            const renderFn = renderFunctions[tabId];

            const filterToggle = document.getElementById(`${prefix}-filter-toggle`);
            const filtersCollapsible = document.getElementById(`${prefix}-filters-collapsible`);
            
            if(filterToggle && filtersCollapsible) {
                filterToggle.addEventListener('click', () => {
                    filtersCollapsible.classList.toggle('hidden');
                    filterToggle.classList.toggle('visible-content');
                    filterToggle.querySelector('.toggle-icon')?.classList.toggle('fa-chevron-up');
                });
            }

            const handleFilterChange = () => {
                const selectedYears = Array.from(document.querySelectorAll(`#${prefix}-year-select-dropdown input[type=checkbox]:checked`)).map(cb => cb.value);
                const periodSelect = document.getElementById(`${prefix}-period-select`);
                const monthSelect = document.getElementById(`${prefix}-month-select`);

                globalFilterState.years = selectedYears;
                if (periodSelect) globalFilterState.period = periodSelect.value;
                if (monthSelect) globalFilterState.month = monthSelect.value;
                
                FilterSessionManager.update(globalFilterState);

                if (renderFn) {
                    if (prefix === 'estadisticas') {
                        currentEstadisticasData = [];
                        renderEstadisticas();
                    } else if (prefix === 'fixture') {
                        renderFixture(true);
                    } else {
                        renderFn();
                    }
                }
            };
            
            if (tabId.includes('content') && !tabId.includes('individual')) {
                 populateMultiYearSelect(prefix, handleFilterChange);
            }

            document.getElementById(`${prefix}-period-select`)?.addEventListener('change', handleFilterChange);
            document.getElementById(`${prefix}-month-select`)?.addEventListener('change', handleFilterChange);

            document.getElementById(`${prefix}-hoy-button`)?.addEventListener('click', () => {
                const isMonthFilter = prefix === 'fixture';
                setTodayFilters(prefix, isMonthFilter);
                handleFilterChange();
            });

            if (tabId === 'estadisticas-content') {
                 const table = document.getElementById('estadisticas-table');
                 table?.addEventListener('click', (e) => {
                     const th = e.target.closest('th[data-sort]');
                     if (!th) return;
                     const newCriterion = th.dataset.sort;
                     if (estadisticasSortState.criterion === newCriterion) {
                         estadisticasSortState.order = estadisticasSortState.order === 'desc' ? 'asc' : 'desc';
                     } else {
                         estadisticasSortState.criterion = newCriterion;
                         estadisticasSortState.order = 'desc';
                     }
                     renderEstadisticas(true);
                 });
            }
            
            if (tabId.includes('content') && !tabId.includes('individual')) {
                const isMonthFilter = prefix === 'fixture';
                if (isMonthFilter) {
                    populateMonthSelects('fixture-month-select');
                    if (globalFilterState.month) {
                         document.getElementById('fixture-month-select').value = globalFilterState.month;
                    }
                } else {
                    if (globalFilterState.period) {
                        document.getElementById(`${prefix}-period-select`).value = globalFilterState.period;
                    }
                }
            }
            
            if (tabId === 'individual-stats-content') {
                setupPlayerSearch();
            }
        }
        
        function setupRealtimeSubscriptions() {
            if (statsChannel) {
                supabaseClient.removeChannel(statsChannel);
                statsChannel = null;
            }
            clearInterval(heartbeatInterval);
            
            console.log('Setting up Realtime subscriptions for stats page...');
            
            const handleChanges = (payload) => {
                console.log('Change received on stats page!', payload);
                const { table, eventType, new: newRecord, old: oldRecord } = payload;
                
                let dataArray;
                let sortNeeded = false;

                switch(table) {
                    case 'players': dataArray = allPlayersData; break;
                    case 'matches': dataArray = allMatchesData; sortNeeded = true; break;
                    default: return;
                }

                if (eventType === 'INSERT') {
                    if (!dataArray.some(item => item.id === newRecord.id)) {
                       dataArray.push(newRecord);
                    }
                }
                else if (eventType === 'UPDATE') {
                    const index = dataArray.findIndex(item => item.id === newRecord.id);
                    if (index !== -1) dataArray[index] = newRecord;
                }
                else if (eventType === 'DELETE') {
                    const idToDelete = oldRecord.id;
                    const index = dataArray.findIndex(item => item.id === idToDelete);
                    if (index !== -1) dataArray.splice(index, 1);
                }
                
                if (sortNeeded) {
                    allMatchesData.sort((a, b) => new Date(b.match_date) - new Date(a.match_date));
                }

                const activeTabButton = document.querySelector('.tab-button.active');
                if (activeTabButton) {
                    const tabId = activeTabButton.dataset.tab;
                    activateTab(tabId);
                }
            };

            statsChannel = supabaseClient.channel('public:stats_changes', {
                config: {
                    broadcast: { ack: true }
                }
            });

            const startHeartbeat = () => {
                clearInterval(heartbeatInterval); 
                heartbeatInterval = setInterval(() => {
                    if (statsChannel.state === 'joined') {
                        statsChannel.send({
                            type: 'broadcast',
                            event: 'heartbeat',
                            payload: { message: 'alive' },
                        });
                        console.log('Stats page heartbeat sent.');
                    }
                }, 30000); 
            };

            const stopHeartbeat = () => {
                clearInterval(heartbeatInterval);
            };

            statsChannel
                .on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, handleChanges)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, handleChanges)
                .subscribe((status, err) => {
                    console.log(`Stats page Realtime status: ${status}`);
                    if (status === 'SUBSCRIBED') {
                        console.log('Stats page subscribed to Realtime channel!');
                        startHeartbeat(); 
                    } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                        console.error(`Stats page Realtime issue: ${status}`, err);
                        stopHeartbeat();
                        setTimeout(setupRealtimeSubscriptions, 5000);
                    } else if (status === 'CLOSED') {
                        console.warn('Stats page Realtime channel closed.');
                        stopHeartbeat();
                    }
                });
        }

        async function initializeApp() {
            try {
                const { data: players, error: pError } = await supabaseClient.from('players').select('*');
                const { data: matches, error: mError } = await supabaseClient.from('matches').select('*');

                if (pError || mError) throw pError || mError;
                
                allPlayersData = players;
                allMatchesData = matches.sort((a, b) => new Date(b.match_date) - new Date(a.match_date));

                setupRealtimeSubscriptions();

                const hash = window.location.hash;
                const storedTabId = localStorage.getItem('lastActiveTab');
                let initialTabId = 'leaderboard-content';

                if (hash && hashToTabMap[hash]) {
                    initialTabId = hashToTabMap[hash];
                } else if (storedTabId && document.querySelector(`.tab-button[data-tab="${storedTabId}"]`)) {
                    initialTabId = storedTabId;
                }
                
                activateTab(initialTabId);

            } catch (error) {
                console.error("Error fatal durante la inicialización:", error);
                DOMElements.mainContentArea.innerHTML = `<div class="main-content-container text-center text-red-500"><p>Error al cargar datos: ${error.message}</p></div>`;
            }
        }

        function init() {
            const sessionFilters = FilterSessionManager.startOrResume();
            if (sessionFilters) {
                globalFilterState = sessionFilters;
            }

            ['click', 'scroll', 'keydown'].forEach(eventType => {
                window.addEventListener(eventType, () => {
                    FilterSessionManager.update(globalFilterState); 
                }, true);
            });
            
            applyInitialResponsiveStyles();
            applyTheme(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
            DOMElements.darkModeToggleMobile.addEventListener('click', toggleTheme);
            DOMElements.darkModeToggleDesktop.addEventListener('click', toggleTheme);
            
            DOMElements.hamburgerButton.addEventListener('click', openSideMenu);
            DOMElements.overlay.addEventListener('click', closeSideMenu);
            window.addEventListener('resize', applyInitialResponsiveStyles);
            
            DOMElements.tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tabId = e.currentTarget.dataset.tab;
                    if (tabId) { 
                        activateTab(tabId);
                        if (window.innerWidth < 768) closeSideMenu();
                    }
                });
            });
            window.addEventListener('hashchange', () => {
                const tabId = hashToTabMap[window.location.hash] || 'leaderboard-content';
                activateTab(tabId);
            });

            DOMElements.collapsibleTriggers.forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const content = trigger.nextElementSibling;
                    const icon = trigger.querySelector('i.fa-chevron-down');
                    content.classList.toggle('hidden');
                    icon?.classList.toggle('rotate-180');
                });
            });
            
            document.addEventListener('click', (e) => {
                document.querySelectorAll('.multi-year-select-dropdown:not(.hidden)').forEach(dropdown => {
                    const button = document.getElementById(dropdown.id.replace('-dropdown', '-button'));
                    if (!dropdown.contains(e.target) && e.target !== button) {
                        dropdown.classList.add('hidden');
                    }
                });
            });

            const celularTrigger = DOMElements.collapsibleTriggers[0];
            if (celularTrigger) {
                const content = celularTrigger.nextElementSibling;
                const icon = celularTrigger.querySelector('i.fa-chevron-down');
                
                if (content && icon) {
                    content.classList.remove('hidden');
                    icon.classList.add('rotate-180');
                }
            }

            initializeApp();
        }

        init();
    });
    </script>
</body>
</html>
