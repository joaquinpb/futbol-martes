<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA CLANDE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Definición de variables CSS para colores */
        :root {
            --bg-body: #f0f2f5;
            --bg-main-content: #ffffff;
            --text-default: #1a202c;
            --text-secondary: #4a5568;
            --border-default: #cbd5e0;
            --bg-table-header: #1a202c;
            --text-table-header: #ffffff;
            --bg-table-row-odd: #f7fafc;
            --bg-table-row-even: #edf2f7;
            --bg-table-row-hover: #e2e8f0;
            --bg-indigo-800: #312e81;
            --bg-indigo-700: #4338ca;
            --bg-indigo-600: #4f46e5;
            --bg-blue-600: #2563eb;
            --bg-green-500: #10b981;
            --bg-red-500: #ef4444;
            --text-indigo-800: #312e81;
            --text-indigo-700: #4338ca;
            --text-gray-700: #4a5568;
            --text-gray-600: #4a5568;
            --text-gray-500: #6b7280;
            --text-yellow-400: #facc15;
            --bg-blue-200: #bfdbfe;

            /* Variables para colores de jugadores estáticos (Claros: blanco, Oscuros: negro) */
            --player-claros-bg: #ffffff; /* Claros (blanco) */
            --player-claros-text: #1a202c; /* Texto negro para Claros */
            --player-oscuros-bg: #1a202c; /* Oscuros (negro) */
            --player-oscuros-text: #ffffff; /* Texto blanco para Oscuros */
        }

        /* Modo oscuro */
        body.dark-mode {
            --bg-body: #1a202c; /* Fondo oscuro */
            --bg-main-content: #2d3748; /* Fondo de contenido más oscuro */
            --text-default: #e2e8f0; /* Texto claro */
            --text-secondary: #a0aec0; /* Texto secundario más claro */
            --border-default: #4a5568; /* Bordes más oscuros */
            --bg-table-header: #4a5568; /* Fondo de encabezado de tabla más oscuro */
            --text-table-header: #ffffff; /* Texto de encabezado de tabla blanco */
            --bg-table-row-odd: #2d3748; /* Filas impares más oscuras */
            --bg-table-row-even: #4a5568; /* Filas pares más oscuras */
            --bg-table-row-hover: #1a202c; /* Hover de filas más oscuro */
            --bg-indigo-800: #1f2937; /* Indigo oscuro para sidebar */
            --bg-indigo-700: #374151; /* Indigo oscuro para hover de sidebar */
            --bg-indigo-600: #4b5563; /* Indigo oscuro para botones */
            --bg-blue-600: #3b82f6; /* Azul para gradientes */
            --bg-green-500: #16a34a; /* Verde para botones */
            --bg-red-500: #dc2626; /* Rojo para botones */
            --text-indigo-800: #93c5fd; /* Texto índigo más claro */
            --text-indigo-700: #60a5fa; /* Texto índigo más claro */
            --text-gray-700: #e2e8f0; /* Texto gris más claro */
            --text-gray-600: #a0aec0; /* Texto gris más claro */
            --text-gray-500: #cbd5e0; /* Texto gris más claro */
            --text-yellow-400: #facc15; /* Amarillo sigue igual */
            --bg-blue-200: #1e3a8a; /* Azul oscuro para total en tabla */

            /* Variables para colores de jugadores estáticos en modo oscuro (Claros: blanco, Oscuros: negro) */
            --player-claros-bg: #ffffff; /* Claros (blanco) */
            --player-claros-text: #1a202c; /* Texto negro para Claros */
            --player-oscuros-bg: #1a202c; /* Oscuros (negro) */
            --player-oscuros-text: #ffffff; /* Texto blanco para Oscuros */
        }

        /* Eliminar height: 100% de html y body. Permitir que el body se desplace. */
        html {
            overflow-x: hidden; /* Mantener para evitar scroll horizontal */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body); /* Usar variable */
            margin: 0; /* Elimina el margen predeterminado del body */
            padding: 0; /* Elimina el padding predeterminado del body */
            color: var(--text-default); /* Usar variable para el color de texto por defecto */
            transition: background-color 0.3s ease, color 0.3s ease; /* Transición suave para el modo oscuro */
            overflow-x: hidden; /* Evita el desbordamiento horizontal en móvil */
            overflow-y: auto; /* Permite desplazamiento vertical en todo el body */
            -webkit-overflow-scrolling: touch; /* Para un desplazamiento más suave en iOS */
            /* padding-top: 5rem; REMOVED: Ahora se maneja con margin-top en main-content-container */
        }
        /* Estilos base para tablas */
        table {
            @apply rounded-lg shadow-md;
            background-color: var(--bg-main-content); /* Usar variable */
            width: 100%; /* Asegura que las tablas tomen todo el ancho */
            border-collapse: collapse; /* Para bordes limpios */
        }
        /* Encabezados de tabla: centrado por defecto */
        th {
            @apply py-3 px-3 text-center; /* Reducido padding para mejor ajuste en pantallas pequeñas */
        }
        /* Celdas de datos: centrado por defecto */
        td {
            @apply py-3 px-3 text-center text-xs sm:text-sm; /* Reducido padding y tamaño de fuente para mobile */
        }
        /* Alineación a la izquierda para la columna Jugador (encabezado y datos) */
        .text-left-player {
            text-align: left !important;
        }
        /* Encabezado de la tabla: fondo negro, texto blanco */
        thead th {
            background-color: var(--bg-table-header) !important; /* Usar variable */
            color: var(--text-table-header) !important; /* Usar variable */
            text-transform: uppercase;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* leading-normal */
        }
        /* Filas del cuerpo de la tabla: alternar entre dos tonos de gris */
        tbody tr:nth-child(odd) {
            background-color: var(--bg-table-row-odd) !important; /* Usar variable */
        }
        tbody tr:nth-child(even) {
            background-color: var(--bg-table-row-even) !important; /* Usar variable */
        }
        tbody tr {
            border-bottom: 1px solid var(--border-default); /* Usar variable */
            transition: background-color 150ms ease-in-out; /* transition duration-150 ease-in-out */
        }
        tbody tr:last-child {
            border-bottom: 0; /* Eliminar borde inferior de la última fila */
        }
        tbody td {
            color: var(--text-secondary); /* Usar variable */
        }

        /* Clase personalizada para deshabilitar el desbordamiento horizontal */
        .overflow-x-auto-off {
            overflow-x: hidden;
        }

        /* --- Estilos para el menú lateral responsivo --- */
        #side-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 256px; /* w-64 */
            background-color: var(--bg-indigo-800); /* Usar variable */
            color: var(--text-table-header); /* Usar variable */
            transform: translateX(-100%); /* Oculto por defecto */
            transition: transform 0.3s ease-in-out, visibility 0.3s ease; /* Añadida visibilidad para una transición más suave */
            z-index: 40;
            display: flex; /* Cambiado a flex para control interno */
            flex-direction: column;
            padding-top: 1rem; /* Añadir algo de padding en la parte superior */
            overflow-y: auto; /* Permite desplazamiento interno si el contenido del menú es muy largo */
        }

        /* Esta clase será aplicada por JS para hacerlo visible */
        #side-menu.open {
            transform: translateX(0);
            visibility: visible; /* Hace el menú visible */
        }
        
        /* Ocultar por defecto en móvil si no está abierto */
        #side-menu:not(.open) {
            visibility: hidden;
        }


        #overlay {
            position: fixed;
            inset: 0; /* top:0, right:0, bottom:0, left:0 */
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            display: none; /* Oculto por defecto */
        }

        #overlay.open {
            display: block; /* Mostrar cuando el menú lateral esté abierto (solo móvil) */
        }

        #hamburger-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 50;
            padding: 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            background-color: var(--bg-indigo-600); /* Usar variable */
            color: var(--text-table-header); /* Usar variable */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            display: block; /* Visible por defecto en móvil */
        }

        #close-side-menu-button {
            display: none !important; /* El botón de cerrar menú lateral (la cruz) ahora estará oculto por defecto y siempre */
        }

        /* Estilos para el título MENÚ en el sidebar */
        #side-menu .menu-title-container {
            padding: 0.5rem 1.5rem; /* py-2 px-6 */
            display: flex; /* Make it a flex container */
            align-items: center; /* Align items vertically */
            justify-content: space-between; /* Space between title and toggle */
            margin-bottom: 0.25rem; /* mb-1 para separar de los botones de abajo */
        }
        #side-menu .menu-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: bold; /* font-bold */
            color: white; /* text-white */
            display: flex;
            align-items: center;
            gap: 0.5rem; /* gap-2 */
            margin-left: 0; 
        }


        #side-menu .tab-button, #side-menu .sidebar-link {
            padding-left: 1.5rem; /* px-6 */
            padding-right: 1.5rem; /* px-6 */
            text-align: left;
            width: 100%; /* Ancho completo dentro del sidebar */
            border-radius: 0; /* Sin esquinas redondeadas para las pestañas verticales */
            margin-bottom: 0.25rem; /* mb-1 */
            color: var(--text-table-header); /* Usar variable */
            transition: background-color 0.15s ease-in-out;
            display: flex; /* Para alinear el texto y el icono */
            align-items: center; /* Para alinear el texto y el icono */
            gap: 0.5rem; /* Espacio entre texto e icono */
            white-space: nowrap; /* Asegura que el texto y el icono no se envuelvan */
        }
        #side-menu .tab-button.active {
            background-color: var(--bg-indigo-700); /* Usar variable */
        }
        #side-menu .tab-button:hover, #side-menu .sidebar-link:hover {
            background-color: var(--bg-indigo-600); /* Usar variable */
        }

        /* Estilos de escritorio (min-width: 768px) */
        @media (min-width: 768px) {
            body {
                display: flex; /* Hacemos el body un contenedor flex en escritorio */
                flex-direction: row; /* Elementos en fila en escritorio */
                padding-top: 0; /* Sin padding superior en escritorio */
            }
            #side-menu {
                position: relative; /* Parte del flujo normal */
                transform: translateX(0); /* Siempre visible en escritorio, sin !important */
                flex-shrink: 0; /* Evita que se encoja */
                height: auto; /* Deja que el contenido defina la altura */
                min-height: 100vh; /* Asegura que ocupe toda la altura del viewport */
                border-right: 1px solid var(--border-default); /* Usar variable */
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
                visibility: visible !important; /* Siempre visible en escritorio */
            }
            #hamburger-button {
                display: none !important; /* Siempre oculta la hamburguesa en escritorio */
            }
            #close-side-menu-button {
                display: none !important;
            }
            #overlay {
                display: none !important;
            }
            .main-content-container {
                flex-grow: 1; /* Ocupa el espacio restante */
                margin-left: 2rem; /* Restablece el margin-left del móvil */
                margin-right: 2rem; /* Restablece el margin-right del móvil */
                max-width: none !important; /* Permite que se expanda completamente */
                width: auto !important; /* Deja que flexbox controle el ancho */
                margin-top: 2rem; /* md:mt-8 */
            }
        }

        /* La tabla de estadísticas mantiene el diseño automático y el desbordamiento horizontal automático */
        #estadisticas-table {
            table-layout: auto;
        }

        /* Estilo para los mensajes de carga */
        .loading-message {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-gray-500); /* Usar variable */
            font-style: italic;
        }
        .loading-spinner {
            border: 4px solid var(--border-default); /* Usar variable */
            border-top: 4px solid var(--bg-indigo-600); /* Usar variable */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Clase resaltada para los resultados de autocompletado */
        .highlighted {
            background-color: var(--bg-table-row-hover); /* Usar variable */
        }

        /* Estilos para el campo de fútbol (móvil por defecto - vertical) */
        #soccer-field-container {
            position: relative;
            width: 100%; /* Ancho móvil: coincide con el ancho de la tabla TT */
            padding-top: 168.75%; /* Altura reducida en 10% (187.5% * 0.9) */
            background-color: #0f8d48; /* Color del campo verde */
            border: 2px solid white; /* Perímetro exterior */
            border-radius: 0.5rem; /* rounded-lg */
            overflow: hidden; /* Asegura que los jugadores permanezcan dentro de los límites */
            margin-bottom: 1.5rem; /* mb-6 */
            margin-left: auto; /* Centra el campo */
            margin-right: auto; /* Centra el campo */
        }

        /* Línea de medio campo (vertical para móvil) */
        #soccer-field-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: white;
            transform: translateY(-50%);
            z-index: 2; /* z-index de las líneas del campo */
        }

        /* Círculo central (vertical para móvil) */
        #soccer-field-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 15vw; /* Usar vw para un tamaño de círculo consistente en móvil */
            height: 15vw; /* Debe ser igual al ancho para un círculo */
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 2; /* z-index de las líneas del campo */
        }

        /* Goles (fuera del área verde - vertical para móvil) */
        .goal {
            position: absolute;
            width: 30%; /* Ancho del gol */
            height: 15px; /* Profundidad de la estructura del gol */
            box-sizing: border-box;
            border-left: 2px solid white;
            border-right: 2px solid white;
            z-index: 2; /* z-index de las líneas del campo */
        }
        .goal.top {
            top: -15px; /* Posición fuera del borde superior */
            left: 35%;
            border-bottom: 2px solid white; /* Travesaño */
        }
        .goal.bottom {
            bottom: -15px; /* Posición fuera del borde inferior */
            left: 35%;
            border-top: 2px solid white; /* Travesaño */
        }

        /* Áreas de penalti (vertical para móvil) - relación 2:1 para las líneas */
        .penalty-area {
            position: absolute;
            width: 60%; /* Ancho del área de penalti */
            height: 20%; /* Profundidad desde la línea de gol */
            box-sizing: border-box;
            border-color: white;
            border-style: solid;
            border-width: 0; /* Reiniciar por defecto */
            z-index: 2; /* z-index de las líneas del campo */
        }
        .penalty-area.top {
            top: 0;
            left: 20%;
            border-width: 0 4px 2px 4px; /* Arriba:0, Derecha:4px, Abajo:2px, Izquierda:4px */
        }
        .penalty-area.bottom {
            bottom: 0;
            left: 20%;
            border-width: 2px 4px 0 4px; /* Arriba:2px, Derecha:4px, Abajo:0, Izquierda:4px */
        }

        /* Áreas de gol (caja más pequeña dentro del área de penalti - vertical para móvil) - relación 2:1 para las líneas */
        .goal-area {
            position: absolute;
            width: 30%; /* Ancho del área de gol */
            height: 10%; /* Profundidad desde la línea de gol */
            box-sizing: border-box;
            border-color: white;
            border-style: solid;
            border-width: 0; /* Reiniciar por defecto */
            z-index: 2; /* z-index de las líneas del campo */
        }
        .goal-area.top {
            top: 0;
            left: 35%;
            border-width: 0 4px 2px 4px; /* Arriba:0, Derecha:4px, Abajo:2px, Izquierda:4px */
        }
        .goal-area.bottom {
            bottom: 0;
            left: 35%;
            border-width: 2px 4px 0 4px; /* Arriba:2px, Derecha:4px, Abajo:0, Izquierda:4px */
        }

        /* Contenedor del jugador: posiciona toda la unidad del jugador (marcador + nombre) */
        .player-wrapper {
            position: absolute;
            /* Centra el contenedor en su punto de origen */
            transform: translate(-50%, -50%); 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem; /* Espacio entre el marcador y el nombre */
            z-index: 3; /* z-index de los jugadores */
        }

        /* Marcador del jugador: la parte circular */
        .player-marker {
            width: 55px; /* Tamaño del marcador de jugador */
            height: 55px;
            border-radius: 50%; /* Forma circular */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem; /* Tamaño de la inicial */
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 2px solid; /* Borde para el color del equipo */
            color: var(--text-default); /* Usar variable */
        }
        .player-marker .fa-star {
            font-size: 1.2em; /* Duplicado el tamaño */
            margin-top: 2px;
            position: absolute;
            bottom: 72px; /* Posición ajustada */
            right: 0px; /* Posición ajustada */
            z-index: 4; /* z-index de la estrella */
        }

        /* Usar variables estáticas para los colores de los jugadores */
        .player-marker.claros {
            background-color: var(--player-claros-bg);
            border-color: var(--player-claros-text);
            color: var(--player-claros-text); /* Color del número en el círculo */
        }

        /* Usar variables estáticas para los colores de los jugadores */
        .player-marker.oscuros {
            background-color: var(--player-oscuros-bg);
            color: var(--player-oscuros-text); /* Color del número en el círculo */
            border-color: var(--player-oscuros-text);
        }

        /* Etiqueta del nombre del jugador: el texto debajo del marcador */
        .player-name-label {
            font-size: 0.90rem; /* Tamaño de fuente para el nombre */
            font-weight: bold; /* Ahora en negrita */
            white-space: nowrap; /* Evita que el texto se envuelva */
            text-align: center;
            padding: 0.3rem 0.6rem; /* Aumentado el padding para un área de sombreado más grande */
            border-radius: 0.25rem; /* Esquinas ligeramente redondeadas para el fondo */
        }

        /* Establecer el color de fondo y texto para los nombres de los jugadores "claros" */
        .player-marker.claros + .player-name-label {
            background-color: var(--player-claros-bg); /* Fondo blanco para jugadores del equipo claro */
            color: var(--player-claros-text); /* Texto negro para jugadores del equipo claro */
        }

        /* Establecer el color de fondo y texto para los nombres de los jugadores "oscuros" */
        .player-marker.oscuros + .player-name-label {
            background-color: var(--player-oscuros-bg); /* Fondo negro para jugadores del equipo oscuro */
            color: var(--player-oscuros-text); /* Texto blanco para jugadores del equipo oscuro */
        }

        .winner-trophy {
            position: absolute;
            font-size: 2rem; /* Icono de trofeo grande */
            color: var(--text-yellow-400); /* Usar variable */
            z-index: 10; /* Asegura que esté por encima de otros elementos */
            transform: translate(-50%, -50%); /* Centrar el icono */
        }

        /* Ajustes responsivos para el tamaño del marcador del jugador */
        @media (min-width: 640px) { /* breakpoint sm */
            .player-marker {
                width: 50px;
                height: 50px;
                font-size: 1rem;
            }
            .player-marker .fa-star {
                font-size: 1.2em; /* Aplica el tamaño duplicado también al breakpoint responsivo */
            }
            .player-name-label {
                font-size: 0.75rem;
                max-width: none; /* Asegura el nombre completo también en pantallas más pequeñas */
            }
        }
        @media (min-width: 768px) { /* breakpoint md */
            .player-marker {
                width: 60px;
                height: 60px;
                font-size: 1.1rem;
            }
            .player-marker .fa-star {
                font-size: 1.2em; /* Aplica el tamaño duplicado también al breakpoint responsivo */
            }
            .player-name-label {
                font-size: 0.85rem;
                max-width: none; /* Asegura el nombre completo también en escritorio */
            }

            /* Estilos específicos de escritorio para campo horizontal */
            /* NOTA: Estos estilos ahora se aplican condicionalmente en JS para la pestaña Fixture */
            #soccer-field-container.horizontal-layout {
                width: 65%; /* Ajustado para un mejor equilibrio con la tabla TT */
                padding-top: 29.54%; /* Mantiene la relación de aspecto (original 1:2.2, así que 65% / 2.2 = 29.54%) */
            }

            /* Ajustar el ancho de los detalles TT para escritorio */
            #fixture-details-display {
                width: 35%; /* Ocupa el espacio restante (100% - 65%) */
                margin-top: 0; /* Alinea con la parte superior del campo */
            }


            /* Rotar y reposicionar elementos del campo para vista horizontal */
            #soccer-field-container.horizontal-layout::before { /* Línea de medio campo */
                top: 0;
                left: 50%;
                height: 100%;
                width: 2px;
                background-color: white;
                transform: translateX(-50%);
            }

            #soccer-field-container.horizontal-layout::after { /* Círculo central */
                width: 8vw; /* Más pequeño para escritorio, ajustar según sea necesario */
                height: 8vw;
            }

            .goal.top.horizontal-layout { /* Ahora gol izquierdo */
                top: 35%;
                left: -15px; /* Posición fuera del borde izquierdo */
                border-bottom: none;
                border-right: 2px solid white; /* Travesaño */
                border-top: none; /* Eliminar borde superior */
                border-left: none; /* Eliminar borde izquierdo */
                width: 15px; /* Profundidad de la estructura del gol */
                height: 30%; /* Ancho del gol */
            }
            .goal.bottom.horizontal-layout { /* Ahora gol derecho */
                top: 35%;
                right: -15px; /* Posición fuera del borde derecho */
                left: auto; /* Reiniciar izquierda */
                border-top: none;
                border-left: 2px solid white; /* Travesaño */
                border-bottom: none; /* Eliminar borde inferior */
                border-right: none; /* Eliminar borde derecho */
                width: 15px; /* Profundidad de la estructura del gol */
                height: 30%; /* Ancho del gol */
            }

            /* Áreas de penalti (horizontal) - relación 2:1 para las líneas */
            .penalty-area.top.horizontal-layout { /* Ahora área de penalti izquierda */
                top: 20%;
                left: 0;
                height: 60%; /* Ancho del área de penalti */
                width: 20%; /* Profundidad desde la línea de gol */
                border-width: 4px 2px 4px 0; /* Arriba:4px, Derecha:2px, Abajo:4px, Izquierda:0 */
            }
            .penalty-area.bottom.horizontal-layout { /* Ahora área de penalti derecha */
                top: 20%;
                right: 0;
                left: auto; /* Reiniciar izquierda */
                height: 60%; /* Ancho del área de penalti */
                width: 20%; /* Profundidad desde la línea de gol */
                border-width: 4px 0 4px 2px; /* Arriba:4px, Derecha:0, Abajo:4px, Izquierda:2px */
            }

            /* Áreas de gol (horizontal) - relación 2:1 para las líneas */
            .goal-area.top.horizontal-layout { /* Ahora área de gol izquierda */
                top: 35%;
                left: 0;
                height: 30%; /* Ancho del área de gol */
                width: 10%; /* Profundidad desde la línea de gol */
                border-width: 4px 2px 4px 0; /* Arriba:4px, Derecha:2px, Abajo:4px, Izquierda:0 */
            }
            .goal-area.bottom.horizontal-layout { /* Ahora área de gol derecha */
                top: 35%;
                right: 0;
                left: auto; /* Reiniciar izquierda */
                height: 30%; /* Ancho del área de gol */
                width: 10%; /* Profundidad desde la línea de gol */
                border-width: 4px 0 4px 2px; /* Arriba:4px, Derecha:0, Abajo:4px, Izquierda:2px */
            }

            /* Posiciones de los jugadores para campo horizontal */
            /* Claros (Mitad derecha) - 1 Portero, 2 Defensores, 2 Centrocampistas/Delanteros */
            .player-wrapper.claros.horizontal-layout:nth-child(1) { top: 50%; left: 90%; } /* Portero */
            .player-wrapper.claros.horizontal-layout:nth-child(2) { top: 30%; left: 75%; } /* Defensor 1 */
            .player-wrapper.claros.horizontal-layout:nth-child(3) { top: 70%; left: 75%; } /* Defensor 2 */
            .player-wrapper.claros.horizontal-layout:nth-child(4) { top: 40%; left: 60%; } /* Centrocampista/Delantero 1 (Ajustado verticalmente) */
            .player-wrapper.claros.horizontal-layout:nth-child(5) { top: 60%; left: 60%; }    /* Centrocampista/Delantero 2 (Ajustado verticalmente) */

            /* Oscuros (Mitad izquierda) - 1 Portero, 2 Defensores, 2 Centrocampistas/Delanteros */
            .player-wrapper.oscuros.horizontal-layout:nth-child(1) { top: 50%; left: 10%; } /* Portero */
            .player-wrapper.oscuros.horizontal-layout:nth-child(2) { top: 30%; left: 25%; } /* Defensor 1 */
            .player-wrapper.oscuros.horizontal-layout:nth-child(3) { top: 70%; left: 25%; } /* Defensor 2 */
            .player-wrapper.oscuros.horizontal-layout:nth-child(4) { top: 40%; left: 40%; } /* Centrocampista/Delantero 1 (Ajustado verticalmente) */
            .player-wrapper.oscuros.horizontal-layout:nth-child(5) { top: 60%; left: 40%; }  /* Centrocampista/Delantero 2 (Ajustado verticalmente) */

            /* Posiciones de trofeo para escritorio */
            .winner-trophy.claros.horizontal-layout { top: 95%; left: 94%; } /* Abajo a la derecha */
            .winner-trophy.oscuros.horizontal-layout { top: 95%; left: 6%; } /* Abajo a la izquierda */
        }

        /* Estilo específico para el texto del botón "PARTIDO ACTUAL" para asegurar el color blanco */
        .current-match-card-text {
            color: var(--text-table-header) !important; /* Usar variable */
        }

        /* Estilo para el estado seleccionado de cualquier tarjeta de partido */
        .fixture-match-item.selected {
            box-shadow: 0 0 0 3px rgba(67, 56, 202, 0.5); /* Anillo de enfoque azul índigo */
            border: 1px solid var(--bg-indigo-700); /* Usar variable */
        }

        /* Estilo para el estado seleccionado de una tarjeta de partido normal (no "PARTIDO ACTUAL") */
        .fixture-match-item:not(.current-match-card).selected {
            background-color: var(--bg-table-row-hover) !important; /* Usar variable */
        }

        /* Estilo para el estado seleccionado de una tarjeta "PARTIDO ACTUAL" */
        .current-match-card.selected {
            background: linear-gradient(to right, var(--bg-blue-600), var(--bg-indigo-700)) !important; /* Usar variables */
        }

        /* Estilos para los botones de toggle de las secciones colapsables */
        .collapsible-toggle-button.hidden-content {
            background-color: var(--bg-green-500); /* Usar variable */
            color: var(--text-table-header); /* Usar variable */
        }
        .collapsible-toggle-button.visible-content {
            background-color: var(--bg-red-500); /* Usar variable */
            color: var(--text-table-header); /* Usar variable */
        }

        /* NEW: Styles for the new circular dark mode toggle button */
        #dark-mode-toggle {
            background-color: var(--bg-indigo-700); /* Use variable for background */
            color: var(--text-table-header); /* Use variable for icon color */
            border: none; /* Remove default button border */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px; /* Fixed size for circular button */
            height: 40px; /* Fixed size for circular button */
            border-radius: 50%; /* Make it circular */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Small shadow */
            transition: background-color 0.15s ease-in-out; /* Smooth transition */
        }

        #dark-mode-toggle:hover {
            background-color: var(--bg-indigo-600); /* Darker on hover */
        }

        /* Ensure icon color changes with theme */
        body.dark-mode #dark-mode-toggle i {
            color: var(--text-table-header); /* Should always be white/light in dark mode sidebar */
        }
        
        /* Estilos para la tabla de asistentes al TT en Fixture en modo oscuro */
        #fixture-details-display { /* Aplicar el fondo a todo el contenedor de detalles del fixture */
            background-color: var(--bg-main-content);
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }
        #fixture-details-display h3 { /* Color para el título "Asistentes al TT" */
            color: var(--text-default);
        }
        #tt-attendees-table {
            background-color: var(--bg-main-content); /* Fondo de la tabla */
        }
        #tt-attendees-table thead th {
            background-color: var(--bg-table-header) !important;
            color: var(--text-table-header) !important;
        }
        #tt-attendees-table tbody tr:nth-child(odd) {
            background-color: var(--bg-table-row-odd) !important;
        }
        #tt-attendees-table tbody tr:nth-child(even) {
            background-color: var(--bg-table-row-even) !important;
        }
        #tt-attendees-table tbody tr:hover {
            background-color: var(--bg-table-row-hover) !important;
        }
        #tt-attendees-table tbody td {
            color: var(--text-secondary);
        }

        /* Estilos para las etiquetas de los filtros */
        body.dark-mode label {
            color: var(--text-default); /* Color de texto para las etiquetas de los filtros */
        }

        /* Estilos para la lista de autocompletado de jugadores en modo oscuro */
        body.dark-mode #individual-player-results {
            background-color: var(--bg-main-content);
            border-color: var(--border-default);
        }

        body.dark-mode #individual-player-results > div {
            color: var(--text-default); /* Color de texto para los elementos de la lista */
        }

        body.dark-mode #individual-player-results > div:hover,
        body.dark-mode #individual-player-results > div.highlighted {
            background-color: var(--bg-table-row-hover); /* Color de fondo al pasar el ratón y para el elemento resaltado en modo oscuro */
        }

        /* Ensure the flex-1 div within side-menu scrolls if content overflows */
        #side-menu .flex-col.p-4.md\:p-0.md\:space-y-2.flex-1 {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
        }

        /* Main content container styling, removed flex-grow, overflow-y-auto, min-h-0 */
        .main-content-container {
            padding: 2rem; /* p-8 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            width: 100%;
            max-width: 80rem; /* Adjusted from max-w-5xl for better desktop use */
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 2rem; /* Add some bottom margin */
            background-color: var(--bg-main-content); /* Apply background color here */
        }

        /* NEW: Mobile-specific margin-top for main content to clear fixed hamburger button */
        @media (max-width: 767px) {
            .main-content-container {
                margin-top: 5rem; /* Adjust this value if the hamburger button height changes */
            }
        }

        /* NEW: Dark mode specific styles for h2 titles and their borders */
        body.dark-mode h2.text-indigo-800 {
            color: var(--text-table-header) !important; /* Force white text for titles in dark mode */
            border-color: var(--text-table-header) !important; /* Force white border for titles in dark mode */
        }

        /* Estilos específicos para la caja de búsqueda de jugador individual en modo oscuro */
        body.dark-mode #individual-player-search {
            background-color: #FFFFFF !important; /* Fondo blanco para el input de búsqueda */
            color: #1A202C !important; /* Texto oscuro para el input de búsqueda */
            border-color: var(--border-default) !important; /* Mantiene el color del borde de las variables */
        }
        
        /* Estilo para el placeholder de la caja de búsqueda en modo oscuro */
        body.dark-mode #individual-player-search::placeholder {
            color: #A0AEC0 !important; /* Color gris claro para el placeholder sobre fondo blanco */
        }

        /* Ocultar el botón de limpiar de búsqueda nativo del navegador */
        #individual-player-search::-webkit-search-cancel-button {
            -webkit-appearance: none;
            display: none;
        }
        #individual-player-search::-ms-clear {
            display: none;
        }
        
        /* Estilo para la caja de búsqueda de jugador individual en modo CLARO (verde con letras blancas) */
        #individual-player-search {
            background-color: var(--bg-green-500) !important; /* Fondo verde */
            color: var(--text-table-header) !important; /* Letras blancas */
            border-color: var(--text-table-header) !important; /* Borde blanco */
            padding-right: 2rem !important; /* Añadir padding para la cruz personalizada */
            position: relative; /* Necesario para posicionar la cruz personalizada */
            
            /* --- MODIFICAR ESTAS LÍNEAS PARA EL SIGUIENTE TAMAÑO DE LETRA Y AJUSTE --- */
            font-size: 1.1rem !important; /* Tamaño de letra equivalente a text-base (16px) */
            padding-top: 0.6rem !important; /* Ajusta el padding superior */
            padding-bottom: 0.6rem !important; /* Ajusta el padding inferior */
            /* ---------------------------------------------------------------------- */
        }
        
        /* Ajustar el color del placeholder para la caja de búsqueda en modo claro */
        #individual-player-search::placeholder {
            color: rgba(255, 255, 255, 0.7) !important; /* Un blanco semitransparente para el placeholder */
        }
        
        /* Sobrescribir el estilo del input de búsqueda en modo oscuro para que sea blanco */
        body.dark-mode #individual-player-search {
            background-color: #FFFFFF !important; /* Fondo blanco */
            color: #1A202C !important; /* Texto oscuro para legibilidad */
            border-color: var(--border-default) !important; /* Mantiene el color del borde de las variables */
        }
        
        /* Ajustar el color del placeholder para la caja de búsqueda en modo oscuro */
        body.dark-mode #individual-player-search::placeholder {
            color: #A0AEC0 !important; /* Un gris claro para que se vea bien sobre el fondo blanco */
        }
        
        /* Estilo para la cruz personalizada del botón de limpiar */
        /* Esta regla es para el botón contenedor de la cruz */
        #clear-player-search {
            background-color: transparent !important; /* Asegura que el fondo del botón sea transparente */
            border: none !important; /* Elimina cualquier borde que Tailwind pueda aplicar */
            outline: none !important; /* Elimina el contorno al enfocar */
            padding-right: 0.75rem !important; /* Ajusta este padding si el icono se ve muy cerca del borde */
        }
        
        /* Estilo del ícono de la cruz en modo CLARO */
        #clear-player-search i.fas.fa-times-circle {
            color: white !important; /* Color BLANCO para la cruz en modo claro */
            -webkit-text-stroke: 1px black !important; /* Contorno negro para WebKit/Blink (Chrome, Safari, Edge) */
            text-shadow: -1px -1px 0 black, 1px -1px 0 black, -1px 1px 0 black, 1px 1px 0 black !important; /* Contorno negro para otros navegadores (Firefox) */
        }
        
        /* Estilo del ícono de la cruz en modo OSCURO */
        body.dark-mode #clear-player-search i.fas.fa-times-circle {
            color: var(--text-gray-400) !important; /* Usar un color gris oscuro para la cruz en modo oscuro */
            -webkit-text-stroke: 0.5px var(--text-default) !important; /* Contorno más sutil en modo oscuro */
            text-shadow: none !important; /* Asegúrate de que no haya sombras que interfieran con el color */
        }
        
        /* Estilos para los select en modo oscuro: Fondo BLANCO, Texto NEGRO */
        body.dark-mode select {
            background-color: #FFFFFF !important; /* Fondo BLANCO para la caja del select */
            color: #1A202C !important; /* Texto NEGRO para el contenido del select */
            border-color: var(--border-default) !important; /* Mantener el borde oscuro */
        }
        
        /* Estilos para las etiquetas de los filtros en modo oscuro: Texto BLANCO */
        body.dark-mode label {
            color: white !important; /* Texto BLANCO para las etiquetas */
        }
    </style>
</head>
<body class="min-h-screen">
    <button id="hamburger-button" class="fixed top-4 left-4 z-50 p-2 rounded-md bg-indigo-600 text-white shadow-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <nav id="side-menu" class="fixed top-0 left-0 h-full w-64 bg-indigo-800 text-white transform -translate-x-full transition-transform duration-300 ease-in-out z-40">
        <!-- Título principal de la aplicación en el menú lateral -->
        <div class="p-4 pt-16 flex items-center justify-center mb-4">
            <h1 class="text-3xl font-extrabold text-white">LA CLANDE</h1>
        </div>
        <!-- Título del menú lateral y botón de modo oscuro -->
        <div class="menu-title-container flex items-center justify-between px-6 py-2 mb-1">
            <h2 class="menu-title">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
                MENÚ
            </h2>
            <!-- NEW: Botón de modo oscuro/claro movido aquí -->
            <button id="dark-mode-toggle" class="p-2 rounded-full bg-indigo-700 hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-white transition-colors duration-150 ease-in-out">
                <i class="fas fa-moon text-white" id="dark-mode-icon"></i>
            </button>
        </div>
        <div class="flex flex-col p-4 md:p-0 md:space-y-2 flex-1">
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="leaderboard-content"><i class="fas fa-trophy mr-2"></i>Tabla de Posiciones</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="chamigo-content"><i class="fas fa-star mr-2"></i>Chamigo</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="tt-content"><i class="fas fa-beer mr-2"></i>TT</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="presentismo-content"><i class="fas fa-check-circle mr-2"></i>Presentismo</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="ausentismo-content"><i class="fas fa-times-circle mr-2"></i>Ausentismo</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="estadisticas-content"><i class="fas fa-chart-bar mr-2"></i>Estadísticas</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="equipos-content"><i class="fas fa-futbol mr-2"></i>Equipos</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="fixture-content"><i class="fas fa-calendar-alt mr-2"></i>Fixture</button>
            <button class="tab-button py-2 px-4 text-white font-medium hover:bg-indigo-700" data-tab="individual-stats-content"><i class="fas fa-history mr-2"></i>Histórico</button>
        </div>
    </nav>

    <div id="overlay" class="fixed inset-0 bg-black bg-opacity50 z-30 hidden"></div>

    <div class="main-content-container p-8 rounded-xl shadow-lg w-full max-w-5xl mx-auto mt-4 md:mt-8">
        <div id="leaderboard-content" class="tab-content">
            <h2 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">TABLA DE POSICIONES</h2>
            
            <!-- Botón/Encabezado para colapsar/expandir los filtros -->
            <div id="leaderboard-filter-toggle" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-3 rounded-md cursor-pointer flex items-center justify-between mb-4 collapsible-toggle-button hidden-content">
                <span class="font-semibold">Seleccionar Torneo</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>

            <!-- Contenedor de filtros colapsable -->
            <div id="leaderboard-filters-collapsible" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6 hidden">
                <div class="flex flex-col">
                    <label for="leaderboard-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="leaderboard-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm"></select>
                </div>
                <div class="flex flex-col">
                    <label for="leaderboard-period-select" class="block text-sm font-medium text-gray-700">Torneo:</label>
                    <select id="leaderboard-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
                <div class="col-span-full flex justify-center mt-4">
                    <button id="leaderboard-hoy-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 transition-colors duration-150 ease-in-out">HOY</button>
                </div>
            </div>

            <div class="overflow-x-auto-off">
                <p id="leaderboard-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando tabla de posiciones...
                </p>
                <table id="leaderboard-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">#</th>
                            <th class="py-3 px-3 text-left-player">Jugador</th>
                            <th class="py-3 px-3 text-center">Puntos</th>
                            <th class="py-3 px-3 text-center">Efectividad</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="chamigo-content" class="tab-content hidden">
            <h2 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">CHAMIGO</h2>
            <!-- Botón/Encabezado para colapsar/expandir los filtros -->
            <div id="chamigo-filter-toggle" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-3 rounded-md cursor-pointer flex items-center justify-between mb-4 collapsible-toggle-button hidden-content">
                <span class="font-semibold">Seleccionar Torneo</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <!-- Contenedor de filtros colapsable -->
            <div id="chamigo-filters-collapsible" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6 hidden">
                <div class="flex flex-col">
                    <label for="chamigo-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="chamigo-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm"></select>
                </div>
                <div class="flex flex-col">
                    <label for="chamigo-period-select" class="block text-sm font-medium text-gray-700">Torneo:</label>
                    <select id="chamigo-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
                <div class="col-span-full flex justify-center mt-4">
                    <button id="chamigo-hoy-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 transition-colors duration-150 ease-in-out">HOY</button>
                </div>
            </div>
            <div class="overflow-x-auto-off">
                <p id="chamigo-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando tabla de Chamigos...
                </p>
                <table id="chamigo-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">#</th>
                            <th class="py-3 px-3 text-left-player">Jugador</th>
                            <th class="py-3 px-3 text-center">Chamigos</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="tt-content" class="tab-content hidden">
            <h2 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">TERCER TIEMPO (TT)</h2>
            <!-- Botón/Encabezado para colapsar/expandir los filtros -->
            <div id="tt-filter-toggle" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-3 rounded-md cursor-pointer flex items-center justify-between mb-4 collapsible-toggle-button hidden-content">
                <span class="font-semibold">Seleccionar Torneo</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <!-- Contenedor de filtros colapsable -->
            <div id="tt-filters-collapsible" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6 hidden">
                <div class="flex flex-col">
                    <label for="tt-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="tt-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm"></select>
                </div>
                <div class="flex flex-col">
                    <label for="tt-period-select" class="block text-sm font-medium text-gray-700">Torneo:</label>
                    <select id="tt-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
                <div class="col-span-full flex justify-center mt-4">
                    <button id="tt-hoy-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 transition-colors duration-150 ease-in-out">HOY</button>
                </div>
            </div>
            <div class="overflow-x-auto-off">
                <p id="tt-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando tabla de Asistencia TT...
                </p>
                <table id="tt-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">#</th>
                            <th class="py-3 px-3 text-left-player">Jugador</th>
                            <th class="py-3 px-3 text-center">TT</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="presentismo-content" class="tab-content hidden">
            <h2 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">PRESENTISMO</h2>
            <!-- Botón/Encabezado para colapsar/expandir los filtros -->
            <div id="presentismo-filter-toggle" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-3 rounded-md cursor-pointer flex items-center justify-between mb-4 collapsible-toggle-button hidden-content">
                <span class="font-semibold">Seleccionar Torneo</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <!-- Contenedor de filtros colapsable -->
            <div id="presentismo-filters-collapsible" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6 hidden">
                <div class="flex flex-col">
                    <label for="presentismo-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="presentismo-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm"></select>
                </div>
                <div class="flex flex-col">
                    <label for="presentismo-period-select" class="block text-sm font-medium text-gray-700">Torneo:</label>
                    <select id="presentismo-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
                <div class="col-span-full flex justify-center mt-4">
                    <button id="presentismo-hoy-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 transition-colors duration-150 ease-in-out">HOY</button>
                </div>
            </div>
            <div class="overflow-x-auto-off">
                <p id="presentismo-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando tabla de Presentismo...
                </p>
                <table id="presentismo-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">#</th>
                            <th class="py-3 px-3 text-left-player">Jugador</th>
                            <th class="py-3 px-3 text-center">PJ</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="ausentismo-content" class="tab-content hidden">
            <h2 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">AUSENTISMO</h2>
            <!-- Botón/Encabezado para colapsar/expandir los filtros -->
            <div id="ausentismo-filter-toggle" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-3 rounded-md cursor-pointer flex items-center justify-between mb-4 collapsible-toggle-button hidden-content">
                <span class="font-semibold">Seleccionar Torneo</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <!-- Contenedor de filtros colapsable -->
            <div id="ausentismo-filters-collapsible" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6 hidden">
                <div class="flex flex-col">
                    <label for="ausentismo-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="ausentismo-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm"></select>
                </div>
                <div class="flex flex-col">
                    <label for="ausentismo-period-select" class="block text-sm font-medium text-gray-700">Torneo:</label>
                    <select id="ausentismo-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
                <div class="col-span-full flex justify-center mt-4">
                    <button id="ausentismo-hoy-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 transition-colors duration-150 ease-in-out">HOY</button>
                </div>
            </div>
            <p id="ausentismo-loading-message" class="loading-message">
                <span class="loading-spinner"></span>Cargando tabla de Ausentismo...
            </p>
            <table id="ausentismo-table" class="bg-white rounded-lg shadow hidden">
                <thead>
                    <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                        <th class="py-3 px-3 text-center">#</th>
                        <th class="py-3 px-3 text-left-player">Jugador</th>
                        <th class="py-3 px-3 text-center">Ausentes</th>
                    </tr>
                </thead>
                <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
            </table>
        </div>

        <div id="estadisticas-content" class="tab-content hidden">
            <h2 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">ESTADÍSTICAS</h2>
            <!-- Botón/Encabezado para colapsar/expandir los filtros -->
            <div id="estadisticas-filter-toggle" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-3 rounded-md cursor-pointer flex items-center justify-between mb-4 collapsible-toggle-button hidden-content">
                <span class="font-semibold">Cambiar orden y/o filtros</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <!-- Contenedor de filtros colapsable -->
            <div id="estadisticas-filters-collapsible" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 hidden">
                <div class="flex flex-col col-span-full md:col-span-2"> <!-- Abarca 2 columnas en desktop para los selects -->
                    <label for="estadisticas-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="estadisticas-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm"></select>
                </div>
                <div class="flex flex-col col-span-full md:col-span-2"> <!-- Abarca 2 columnas en desktop para los selects -->
                    <label for="estadisticas-period-select" class="block text-sm font-medium text-gray-700">Torneo:</label>
                    <select id="estadisticas-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
                <div class="col-span-full flex justify-center mt-4"> <!-- Botón HOY abarcando todas las columnas -->
                    <button id="estadisticas-hoy-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 transition-colors duration-150 ease-in-out">HOY</button>
                </div>
                <div class="flex flex-col col-span-full md:col-span-2"> <!-- Ordenar por -->
                    <label for="estadisticas-sort-criterion" class="block text-sm font-medium text-gray-700">Ordenar por:</label>
                    <select id="estadisticas-sort-criterion" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="points">Puntos</option>
                        <option value="pg">PG</option>
                        <option value="pe">PE</option>
                        <option value="pp">PP</option>
                        <option value="pj">PJ</option>
                        <option value="efectividad">Efectividad</option>
                        <option value="chamigos">Chamigo</option>
                        <option value="tt">TT</option>
                        <option value="ausentes">Ausentismo</option>
                    </select>
                </div>
                <div class="flex flex-col col-span-full md:col-span-2"> <!-- Orden -->
                    <label for="estadisticas-sort-order" class="block text-sm font-medium text-gray-700">Orden:</label>
                    <select id="estadisticas-sort-order" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="desc">Descendente</option>
                        <option value="asc">Ascendente</option>
                    </select>
                </div>
            </div>
            
            <div id="estadisticas-table-container" class="overflow-x-auto">
                <p id="estadisticas-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando estadísticas...
                </p>
                <table id="estadisticas-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">#</th>
                            <th class="py-3 px-3 text-left-player">Jugador</th>
                            <th class="py-3 px-3 text-center">Puntos</th>
                            <th class="py-3 px-3 text-center">PG</th>
                            <th class="py-3 px-3 text-center">PE</th>
                            <th class="py-3 px-3 text-center">PP</th>
                            <th class="py-3 px-3 text-center">PJ</th>
                            <th class="py-3 px-3 text-center">Efectividad</th>
                            <th class="py-3 px-3 text-center">Chamigo</th>
                            <th class="py-3 px-3 text-center">TT</th>
                            <th class="py-3 px-3 text-center">Ausentismo</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="equipos-content" class="tab-content hidden">
            <h2 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">EQUIPOS</h2>
            <div id="equipos-filter-toggle" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-3 rounded-md cursor-pointer flex items-center justify-between mb-4 collapsible-toggle-button hidden-content">
                <span class="font-semibold">Seleccionar Torneo</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <div id="equipos-filters-collapsible" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6 hidden">
                <div class="flex flex-col">
                    <label for="equipos-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                    <select id="equipos-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm"></select>
                </div>
                <div class="flex flex-col">
                    <label for="equipos-period-select" class="block text-sm font-medium text-gray-700">Torneo:</label>
                    <select id="equipos-period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Totales</option>
                    </select>
                </div>
                <div class="col-span-full flex justify-center mt-4">
                    <button id="equipos-hoy-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 transition-colors duration-150 ease-in-out">HOY</button>
                </div>
            </div>
            <p id="equipos-loading-message" class="loading-message col-span-full">
                <span class="loading-spinner"></span>Cargando estadísticas de equipos...
            </p>
            <div id="equipos-stats-display" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden justify-items-center mx-auto">
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center w-full min-h-[120px]">
                    <span class="text-3xl font-bold" id="oscuros-wins">${teamStats.oscurosWins}</span>
                    <span class="text-sm uppercase">Oscuros Ganados</span>
                </div>
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center w-full min-h-[120px]">
                    <span class="text-3xl font-bold" id="claros-wins">${teamStats.clarosWins}</span>
                    <span class="text-sm uppercase">Claros Ganados</span>
                </div>
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center w-full min-h-[120px]">
                    <span class="text-3xl font-bold" id="empates">${teamStats.empates}</span>
                    <span class="text-sm uppercase">Empates</span>
                </div>
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center w-full min-h-[120px]">
                    <span class="text-3xl font-bold" id="suspendidos">${teamStats.suspendidos}</span>
                    <span class="text-sm uppercase">Suspendidos</span>
                </div>
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center w-full min-h-[120px]">
                    <span class="text-3xl font-bold" id="total-pj-matches">${teamStats.totalPJMatches}</span>
                    <span class="text-sm uppercase">Partidos Jugados</span>
                </div>
            </div>
        </div>

        <div id="fixture-content" class="tab-content hidden">
            <h2 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">FIXTURE</h2>
            
            <!-- Botón/Encabezado para colapsar/expandir los filtros y el listado de partidos -->
            <div id="fixture-filter-toggle" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-3 rounded-md cursor-pointer flex items-center justify-between mb-4 collapsible-toggle-button hidden-content">
                <span class="font-semibold">Elegir otro partido</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <!-- Contenedor de filtros y listado de partidos colapsable -->
            <div id="fixture-collapsible-content" class="hidden">
                <!-- Contenedor para los filtros de año y mes de Fixture -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6">
                    <div class="flex flex-col">
                        <label for="fixture-year-select" class="block text-sm font-medium text-gray-700">Año:</label>
                        <select id="fixture-year-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm"></select>
                    </div>
                    <div class="flex flex-col">
                        <label for="fixture-month-select" class="block text-sm font-medium text-gray-700">Mes:</label>
                        <select id="fixture-month-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm"></select>
                    </div>
                    <div class="col-span-full flex justify-center mt-4">
                        <button id="fixture-hoy-button" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 transition-colors duration-150 ease-in-out">HOY</button>
                    </div>
                </div>

                <p id="fixture-loading-message" class="loading-message col-span-full">
                    <span class="loading-spinner"></span>Cargando partidos...
                </p>

                <h3 class="text-xl font-semibold text-gray-700 mb-4">Partidos del Mes</h3>
                <!-- Modificado: grid-cols-2 para móvil, sm:grid-cols-3, lg:grid-cols-4 para escritorio -->
                <div id="fixture-matches-cards-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 mb-6">
                    <!-- Las tarjetas/elementos de lista de partidos se renderizarán aquí por JS -->
                </div>
            </div>

            <!-- Contenedor para el campo de juego y la tabla de asistentes, que se mostrará al seleccionar un partido -->
            <div id="fixture-visual-details-container" class="flex flex-col md:flex-row md:space-x-6 mt-6 hidden">
                <div id="soccer-field-container" class="flex-1 min-w-0">
                    <div class="goal top"></div>
                    <div class="goal bottom"></div>
                    <div class="penalty-area top"></div>
                    <div class="penalty-area bottom"></div>
                    <div class="goal-area top"></div>
                    <div class="goal-area bottom"></div>
                </div>

                <div id="fixture-details-display" class="flex-1 min-w-0 bg-white p-4 rounded-lg shadow-md mt-6 md:mt-0">
                    <h3 class="font-semibold text-gray-700 mb-2">Asistentes al TT</h3>
                    <div class="overflow-x-auto">
                        <table id="tt-attendees-table" class="bg-white rounded-lg shadow">
                            <thead>
                                <!-- Encabezado de la tabla vacío o eliminado -->
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="individual-stats-content" class="tab-content hidden">
            <h2 class="text-5xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-4 border-indigo-500 shadow-text-sm">HISTÓRICO</h2>
            <div class="mb-6">
                <label for="individual-player-search" class="block text-sm font-medium text-gray-700">Buscar Jugador:</label>
                <div class="relative">
                    <input type="text" id="individual-player-search" placeholder="Escribe al menos 1 carácter..." class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs sm:text-sm rounded-md shadow-sm">
                    <!-- Botón para limpiar el input -->
                    <button id="clear-player-search" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none">
                        <i class="fas fa-times-circle"></i>
                    </button>
                    <div id="individual-player-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto hidden">
                        </div>
                </div>
                <input type="hidden" id="selected-player-id"> </div>
            <div class="overflow-x-auto">
                <p id="individual-stats-loading-message" class="loading-message">
                    <span class="loading-spinner"></span>Cargando estadísticas individuales...
                </p>
                <table id="individual-stats-table" class="bg-white rounded-lg shadow hidden">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-3 text-center">Año</th>
                            <th class="py-3 px-3 text-center">Torneo</th>
                            <th class="py-3 px-3 text-center">Puntos</th>
                            <th class="py-3 px-3 text-center">PG</th>
                            <th class="py-3 px-3 text-center">PE</th>
                            <th class="py-3 px-3 text-center">PP</th>
                            <th class="py-3 px-3 text-center">PJ</th>
                            <th class="py-3 px-3 text-center">Efectividad</th>
                            <th class="py-3 px-3 text-center">Chamigo</th>
                            <th class="py-3 px-3 text-center">TT</th>
                            <th class="py-3 px-3 text-center">Ausentismo</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // ¡IMPORTANTE! Reemplaza 'AIzaSyDNLwReGrX5FKBwjjKsMS9cz-hZNMIvAlM' con tu Clave de API de Google Cloud Console.
        // Esta clave es necesaria para acceder a Google Sheets API para hojas públicas sin autenticación de usuario.
        const API_KEY = 'AIzaSyDNLwReGrX5FKBwjjKsMS9cz-hZNMIvAlM';
        
        // ¡IMPORTANTE! Reemplaza 'TU_ID_DE_HOJA_DE_CALCULO' con el ID de tu Google Sheet
        // Asegúrate de que esta hoja de cálculo esté compartida públicamente con "Cualquier persona con el enlace puede ver"
        const SPREADSHEET_ID = '1bpNKl-UVHzbqsow4zOHE7-y5Cunm2xtpgyIodEQBi2E';

        let gapiInited = false;
        let allPlayersData = []; // Cache de todos los jugadores
        let allMatchesData = []; // Cache de todos los partidos
        let lastSelectedFixtureMatchId = null; // Para almacenar el ID del último partido de fixture seleccionado

        // Elementos del DOM para el menú lateral
        const hamburgerButton = document.getElementById('hamburger-button');
        const sideMenu = document.getElementById('side-menu');
        const overlay = document.getElementById('overlay');
        const tabButtons = document.querySelectorAll('.tab-button');

        // Referencias a los contenedores de contenido
        const leaderboardContent = document.getElementById('leaderboard-content');
        const chamigoContent = document.getElementById('chamigo-content');
        const ttContent = document.getElementById('tt-content');
        const presentismoContent = document.getElementById('presentismo-content');
        const ausentismoContent = document.getElementById('ausentismo-content');
        const estadisticasContent = document.getElementById('estadisticas-content');
        const equiposContent = document.getElementById('equipos-content');
        const fixtureContent = document.getElementById('fixture-content');
        const individualStatsContent = document.getElementById('individual-stats-content');
        const soccerFieldContainer = document.getElementById('soccer-field-container');
        const fixtureVisualDetailsContainer = document.getElementById('fixture-visual-details-container');


        // Mapeo de hash a ID de contenido de pestaña
        const hashToTabMap = {
            "#leaderboard": "leaderboard-content",
            "#chamigo": "chamigo-content",
            "#tt": "tt-content",
            "#presentismo": "presentismo-content",
            "#ausentismo": "ausentismo-content",
            "#estadisticas": "estadisticas-content",
            "#equipos": "equipos-content",
            "#fixture": "fixture-content",
            "#individual-stats": "individual-stats-content"
        };

        // --- Funciones de Carga de Datos (MOVIDAS AQUÍ) ---
        async function loadAllData() {
            try {
                if (!gapi.client.sheets) {
                    throw new Error("API de Google Sheets no cargada correctamente. Verifica la consola.");
                }

                // Cargar datos de Jugadores
                const playersResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Jugadores!A:D',
                });
                allPlayersData = playersResponse.result.values ? playersResponse.result.values.slice(1) : [];

                // Cargar datos de Partidos
                const matchesResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Partidos!A:G',
                });
                allMatchesData = matchesResponse.result.values ? matchesResponse.result.values.slice(1) : [];

            } catch (err) {
                console.error('Error al cargar todos los datos:', err);
                let userErrorMessage = 'Error desconocido al cargar datos.';
                if (err && err.result && err.result.error && err.result.error.message) {
                    userErrorMessage = `Error al cargar datos: ${err.result.error.message}. Revisa la consola para más detalles.`;
                } else if (err && err.message) {
                    userErrorMessage = `Error al cargar datos: ${err.message}. Revisa la consola para más detalles.`;
                    console.log("Error object:", err); // Log the full error object for debugging
                }
                throw new Error(userErrorMessage); // Propagar el error para que handleDataLoadSuccess lo maneje
            }
        }

        function handleDataLoadSuccess() {
            // Ocultar todos los mensajes de carga
            document.getElementById('leaderboard-loading-message').classList.add('hidden');
            document.getElementById('chamigo-loading-message').classList.add('hidden');
            document.getElementById('tt-loading-message').classList.add('hidden');
            document.getElementById('presentismo-loading-message').classList.add('hidden');
            document.getElementById('ausentismo-loading-message').classList.add('hidden');
            document.getElementById('estadisticas-loading-message').classList.add('hidden');
            document.getElementById('equipos-loading-message').classList.add('hidden');
            document.getElementById('fixture-loading-message').classList.add('hidden');
            document.getElementById('individual-stats-loading-message').classList.add('hidden'); // Nuevo

            // Mostrar todas las tablas (inicialmente ocultas por CSS)
            document.getElementById('leaderboard-table').classList.remove('hidden');
            document.getElementById('chamigo-table').classList.remove('hidden');
            document.getElementById('tt-table').classList.remove('hidden');
            document.getElementById('presentismo-table').classList.remove('hidden');
            document.getElementById('ausentismo-table').classList.remove('hidden');
            document.getElementById('estadisticas-table').classList.remove('hidden');
            document.getElementById('equipos-stats-display').classList.remove('hidden');
            document.getElementById('fixture-matches-cards-container').classList.remove('hidden');
            document.getElementById('individual-stats-table').classList.remove('hidden'); // Nuevo

            loadAllData().then(() => {
                setupTabNavigation();
            }).catch(error => {
                console.error("Error al cargar datos después de la inicialización de GAPI:", error);
                const errorMessageText = `Error al cargar datos: ${error.message}. Asegúrate de que el ID de la hoja de cálculo sea correcto y esté compartida públicamente.`;
                document.getElementById('leaderboard-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('chamigo-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('tt-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('presentismo-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('ausentismo-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('estadisticas-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('equipos-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('fixture-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('individual-stats-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`; // Nuevo
            });
        }

        // --- Funciones de Inicialización de Google API y Carga de Datos ---
        // Se definen aquí para asegurar que estén disponibles cuando el script de la API de Google las llame.
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY, // Se usa la clave de API aquí
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                gapiInited = true;
                handleDataLoadSuccess(); // Cargar datos y mostrar contenido
            } catch (err) {
                console.error("Error al inicializar gapi.client:", err);
                // Actualizar todos los mensajes de carga con el error
                let errorDetail;
                if (err && err.result && err.result.error && err.result.error.message) {
                    errorDetail = err.message;
                } else {
                    try {
                        errorDetail = JSON.stringify(err);
                    } catch (e) {
                        errorDetail = String(e); // Fallback a conversión simple a string
                    }
                }
                const errorMessageText = `Error al inicializar la API de Google: ${errorDetail}. Asegúrate de que la API Key sea correcta y esté habilitada para Google Sheets API.`;

                document.getElementById('leaderboard-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('chamigo-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('tt-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('presentismo-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('ausentismo-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('estadisticas-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('equipos-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('fixture-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`;
                document.getElementById('individual-stats-loading-message').innerHTML = `<span class="loading-spinner"></span>${errorMessageText}`; // Nuevo
            }
        }

        // --- Funciones de Pestañas ---
        function setupTabNavigation() {
            tabButtons.forEach(button => {
                button.removeEventListener('click', handleTabButtonClick); // Evitar duplicados
                button.addEventListener('click', handleTabButtonClick);
            });

            // Llenar y seleccionar automáticamente año y período/mes para todas las secciones
            populateAndSetCurrentPeriod('leaderboard-year-select', 'leaderboard-period-select', 'leaderboard');
            populateAndSetCurrentPeriod('chamigo-year-select', 'chamigo-period-select', 'chamigo');
            populateAndSetCurrentPeriod('tt-year-select', 'tt-period-select', 'tt');
            populateAndSetCurrentPeriod('presentismo-year-select', 'presentismo-period-select', 'presentismo');
            populateAndSetCurrentPeriod('ausentismo-year-select', 'ausentismo-period-select', 'ausentismo');
            populateAndSetCurrentPeriod('estadisticas-year-select', 'estadisticas-period-select', 'estadisticas');
            populateAndSetCurrentPeriod('equipos-year-select', 'equipos-period-select', 'equipos');
            
            // Para fixture, necesitamos poblar meses en lugar de períodos
            populateYearSelects('fixture-year-select', 'fixture');
            populateMonthSelects('fixture-month-select', 'fixture');

            // Configurar la búsqueda de jugador individual
            setupPlayerSearch(); // Nueva llamada

            // Determinar qué pestaña activar según el hash de la URL
            let initialTabId = 'leaderboard-content'; // Pestaña predeterminada
            const hash = window.location.hash;
            if (hash && hashToTabMap[hash]) {
                initialTabId = hashToTabMap[hash];
            } else {
                // Si no hay hash o es inválido, intentar cargar desde localStorage
                const storedTabId = localStorage.getItem('lastActiveTab');
                if (storedTabId && document.getElementById(storedTabId)) {
                    initialTabId = storedTabId;
                }
            }

            // Activar la pestaña inicial
            activateTab(initialTabId);

            // Añadir listener para hashchange
            window.addEventListener('hashchange', handleHashChange);
        }

        function activateTab(tabId) {
            // Eliminar 'active' de todos los botones y ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            tabButtons.forEach(btn => btn.classList.remove('active'));


            // Añadir 'active' al botón correspondiente y mostrar su contenido
            const targetButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            document.getElementById(tabId).classList.remove('hidden');

            // Renderizar el contenido específico de la pestaña
            if (tabId === 'leaderboard-content') {
                renderLeaderboard();
            } else if (tabId === 'chamigo-content') {
                renderChamigoTable();
            } else if (tabId === 'tt-content') {
                renderTTTable();
            } else if (tabId === 'presentismo-content') {
                renderPresentismoTable();
            } else if (tabId === 'ausentismo-content') {
                renderAusentismoTable();
            } else if (tabId === 'estadisticas-content') {
                renderEstadisticasTable();
            } else if (tabId === 'equipos-content') {
                renderEquiposStats();
            } else if (tabId === 'fixture-content') {
                renderFixtureMatchCards();
                // Después de renderizar las tarjetas, seleccionar la más reciente
                const fixtureMatchesCardsContainer = document.getElementById('fixture-matches-cards-container');
                // Usar setTimeout para asegurar que el DOM se haya actualizado y las tarjetas estén renderizadas
                setTimeout(() => {
                    // Buscar primero la tarjeta 'PARTIDO ACTUAL'
                    const currentMatchCard = fixtureMatchesCardsContainer.querySelector('.current-match-card');
                    if (currentMatchCard) {
                        currentMatchCard.click(); // Simular clic para renderizar detalles
                    } else {
                        // Si no hay 'PARTIDO ACTUAL', seleccionar la más reciente (primera en la lista ordenada)
                        const latestMatchCard = fixtureMatchesCardsContainer.querySelector('[data-match-id]');
                        if (latestMatchCard) {
                            latestMatchCard.click(); // Simular clic para renderizar detalles
                        }
                    }
                }, 100); // Pequeño retraso para permitir que el DOM se renderice
            } else if (tabId === 'individual-stats-content') {
                renderIndividualStatsTable();
            }
        }

        function handleTabButtonClick(event) {
            const clickedButton = event.currentTarget;
            const targetTabId = clickedButton.dataset.tab;

            // Siempre activa la pestaña inmediatamente
            activateTab(targetTabId);

            // Actualiza el hash de la URL después de activar la pestaña para una URL consistente
            const hash = Object.keys(hashToTabMap).find(key => hashToTabMap[key] === targetTabId);
            if (hash && window.location.hash !== hash) {
                window.location.hash = hash;
            }

            // Guarda la pestaña activa en localStorage
            localStorage.setItem('lastActiveTab', targetTabId);

            // Cierra el menú lateral en móvil después de seleccionar una pestaña
            if (window.innerWidth < 768) {
                toggleSideMenu();
            }
        }

        function handleHashChange() {
            const hash = window.location.hash;
            const targetTabId = hashToTabMap[hash];
            if (targetTabId) {
                activateTab(targetTabId);
            } else {
                // Si el hash es inválido o está vacío, por defecto a leaderboard
                activateTab('leaderboard-content');
            }
        }

        // --- Funcionalidad de Toggle del Menú Lateral ---
        function toggleSideMenu() {
            const isMobile = window.innerWidth < 768;
            if (isMobile) {
                sideMenu.classList.toggle('open');
                overlay.classList.toggle('open');
                document.body.classList.toggle('overflow-hidden'); // Evita el scroll del body
                
                // Ajustar la visibilidad del botón de hamburguesa solo si es en móvil
                if (sideMenu.classList.contains('open')) {
                    hamburgerButton.classList.add('hidden'); // Oculta la hamburguesa cuando la barra lateral se abre en móvil
                } else {
                    hamburgerButton.classList.remove('hidden'); // Muestra la hamburguesa cuando la barra lateral se cierra en móvil
                }
            }
        }

        // --- Función de Ayuda: Filtrar Partidos por Año y Período/Mes ---
        function getFilteredMatches(yearSelectId, periodOrMonthSelectId, isMonthFilter = false) {
            const selectedYear = document.getElementById(yearSelectId).value;
            const selectedPeriodOrMonth = document.getElementById(periodOrMonthSelectId).value;    

            console.log(`[getFilteredMatches] Called with Year: ${selectedYear}, Period/Month: ${selectedPeriodOrMonth}, IsMonthFilter: ${isMonthFilter}`);

            return allMatchesData.filter(match => {
                const dateString = match[1]; // Fecha en formato DD/MM/YYYY
                if (!dateString) return false;

                const [day, month, year] = dateString.split('/').map(Number);
                const matchDate = new Date(year, month - 1, day); // Mes es 0-indexedado

                const matchYear = matchDate.getFullYear();
                const matchMonth = matchDate.getMonth(); // 0-11

                const yearMatch = selectedYear === 'all' || matchYear === parseInt(selectedYear);

                let periodOrMonthMatch = false;
                if (isMonthFilter) {
                    // Para filtro de mes
                    periodOrMonthMatch = selectedPeriodOrMonth === 'all' || matchMonth === (parseInt(selectedPeriodOrMonth) - 1); // El mes es 1-indexed en select, 0-indexed en Date
                } else {
                    // Para filtro de período (apertura, clausura, total)
                    if (selectedPeriodOrMonth === 'total') {
                        periodOrMonthMatch = true; // Todos los meses
                    } else if (selectedPeriodOrMonth === 'apertura') {
                        periodOrMonthMatch = matchMonth >= 0 && matchMonth <= 5; // Enero (0) a Junio (5)
                    } else if (selectedPeriodOrMonth === 'clausura') {
                        periodOrMonthMatch = matchMonth >= 6 && matchMonth <= 11; // Julio (6) a Diciembre (11)
                    }
                }
                return yearMatch && periodOrMonthMatch;
            });
        }

        // --- Cálculo Centralizado de Estadísticas ---
        function calculateStatsForPeriod(yearSelectId, periodSelectId) {
            const filteredMatches = getFilteredMatches(yearSelectId, periodSelectId, false);
            console.log(`[calculateStatsForPeriod] Filtered matches count: ${filteredMatches.length}`);
            
            const playerStats = {};
            // Inicializar todos los jugadores (activos e inactivos)
            allPlayersData.forEach(player => {
                const [id, name] = player;
                playerStats[id] = {
                    name: name,
                    points: 0,
                    pg: 0, // Partidos Ganados
                    pe: 0, // Partidos Empatados
                    pp: 0, // Partidos Perdidos
                    pj: 0, // Partidos Jugados
                    efectividad: 0,
                    chamigos: 0,
                    tt: 0,
                    ausentes: 0,
                    id: id
                };
            });

            // Estadísticas generales del equipo para el período
            let clarosWins = 0;
            let oscurosWins = 0;
            let empates = 0;
            let suspendidos = 0;
            let totalPJMatches = 0; // Total de partidos jugados (no suspendidos)

            filteredMatches.forEach(match => {
                const [matchId, date, clarosIDsStr, oscurosIDsStr, result, chamigoVotosStr, ttAttendeesStr] = match;
                const clarosPlayers = clarosIDsStr.split(',').filter(Boolean);
                const oscurosPlayers = oscurosIDsStr.split(',').filter(Boolean);
                const allPlayersInMatch = [...new Set([...clarosPlayers, ...oscurosPlayers])];

                if (result !== 'Suspendido') {
                    totalPJMatches++;
                } else {
                    suspendidos++;
                }

                // Actualizar estadísticas del jugador
                allPlayersInMatch.forEach(pId => {
                    if (playerStats[pId]) {
                        if (result === 'Claros' && clarosPlayers.includes(pId)) {
                            playerStats[pId].points += 3;
                            playerStats[pId].pg += 1;
                        } else if (result === 'Oscuros' && oscurosPlayers.includes(pId)) {
                            playerStats[pId].points += 3;
                            playerStats[pId].pg += 1;
                        } else if (result === 'Empate' && allPlayersInMatch.includes(pId)) {
                            playerStats[pId].points += 1;
                            playerStats[pId].pe += 1;
                        } else if (result !== 'Suspendido' && allPlayersInMatch.includes(pId)) { // Si el jugador estaba en el equipo perdedor
                            playerStats[pId].pp += 1;
                        }
                        // Incrementar PJ solo si el partido no fue suspendido y el jugador estuvo presente
                        if (result !== 'Suspendido') {
                            playerStats[pId].pj += 1;
                        }
                    }
                });

                if (result === 'Claros') {
                    clarosWins++;
                } else if (result === 'Oscuros') {
                    oscurosWins++;
                } else if (result === 'Empate') {
                    empates++;
                }

                // Conteo de Chamigo
                if (chamigoVotosStr) {
                    try {
                        console.log(`[Chamigo Debug] Processing match ${matchId}. chamigoVotosStr: ${chamigoVotosStr}`);
                        const chamigoVotos = JSON.parse(chamigoVotosStr);
                        console.log(`[Chamigo Debug] Parsed chamigoVotos:`, chamigoVotos);
                        if (chamigoVotos.length > 0) {
                            const maxVotes = Math.max(...chamigoVotos.map(v => v.votos));
                            console.log(`[Chamigo Debug] maxVotes: ${maxVotes}`);
                            const chamigosDelPartido = chamigoVotos.filter(v => v.votos === maxVotes);
                            console.log(`[Chamigo Debug] chamigosDelPartido:`, chamigosDelPartido);
                            chamigosDelPartido.forEach(chamigo => {
                                if (playerStats[chamigo.id]) {
                                    playerStats[chamigo.id].chamigos += 1;
                                    console.log(`[Chamigo Debug] Player ${playerStats[chamigo.id].name} chamigos count: ${playerStats[chamigo.id].chamigos}`);
                                }
                            });
                        }
                    } catch (e) {
                        console.warn('Error al parsear votos de chamigo en el partido', matchId, ':', e);
                    }
                }

                // Conteo de TT
                if (ttAttendeesStr) {
                    const ttAttendees = ttAttendeesStr.split(',').filter(Boolean);
                    ttAttendees.forEach(pId => {
                        if (playerStats[pId]) {
                            playerStats[pId].tt += 1;
                        }
                    });
                }
            });

            // Calcular Efectividad y Ausentes
            Object.values(playerStats).forEach(player => {
                // Efectividad
                const maxPossiblePoints = player.pj * 3;
                let currentEfectividad = 0; // Efectividad base sin ajustar por participación

                if (maxPossiblePoints > 0) {
                    currentEfectividad = (player.points / maxPossiblePoints) * 100;
                }

                // **********************************************
                // CAMBIO CLAVE PARA EL CÁLCULO DE EFECTIVIDAD
                // **********************************************
                if (totalPJMatches > 0) { // Asegurarse de que haya partidos en el período
                    const participationRatio = player.pj / totalPJMatches;
                    const MIN_PARTICIPATION_RATIO = 0.20; // 20%

                    if (participationRatio < MIN_PARTICIPATION_RATIO) {
                        player.efectividad = (currentEfectividad * participationRatio).toFixed(2);
                    } else {
                        player.efectividad = currentEfectividad.toFixed(2);
                    }
                } else {
                    player.efectividad = 0; // Si no hay partidos, la efectividad es 0
                }
                // **********************************************
                // FIN DEL CAMBIO
                // **********************************************
                
                // Ausentes
                player.ausentes = totalPJMatches - player.pj;
                if (player.ausentes < 0) player.ausentes = 0; // Asegura que no sea negativo
            });

            const result = {
                players: Object.values(playerStats).filter(player => player.name), // Filtrar cualquier entrada de jugador inválida
                teamStats: {
                    clarosWins,
                    oscurosWins,
                    empates,
                    suspendidos,
                    totalPJMatches
                }
            };
            console.log('[calculateStatsForPeriod] Calculated Result:', result);
            return result;
        }


        // --- Renderizar Tabla de Posiciones ---
        function renderLeaderboard() {
            const leaderboardTable = document.getElementById('leaderboard-table');
            const leaderboardTableBody = leaderboardTable.querySelector('tbody');
            const loadingMessage = document.getElementById('leaderboard-loading-message');

            leaderboardTableBody.innerHTML = '';
            leaderboardTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando tabla de posiciones...`;

            const { players: rawRankedPlayers } = calculateStatsForPeriod('leaderboard-year-select', 'leaderboard-period-select');

            // FILTRADO: Solo jugadores con PJ > 0
            const rankedPlayers = rawRankedPlayers.filter(player => player.pj > 0);

            // Ordenar por puntos (descendente)
            rankedPlayers.sort((a, b) => b.points - a.points);

            if (rankedPlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                leaderboardTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla
            rankedPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-3 text-center">${index + 1}</td>
                    <td class="py-3 px-3 text-left-player">${player.name}</td>
                    <td class="py-3 px-3 text-center">${player.points}</td>
                    <td class="py-3 px-3 text-center">${player.efectividad}%</td>
                `;
                leaderboardTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            leaderboardTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de Chamigo ---
        function renderChamigoTable() {
            const chamigoTable = document.getElementById('chamigo-table');
            const chamigoTableBody = chamigoTable.querySelector('tbody');
            const loadingMessage = document.getElementById('chamigo-loading-message');

            chamigoTableBody.innerHTML = '';
            chamigoTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando tabla de Chamigos...`;

            const { players: rawRankedChamigoPlayers } = calculateStatsForPeriod('chamigo-year-select', 'chamigo-period-select');

            // FILTRADO: Solo jugadores con Chamigos > 0
            const rankedChamigoPlayers = rawRankedChamigoPlayers.filter(player => player.chamigos > 0);

            // Ordenar por cantidad de chamigos (descendente)
            rankedChamigoPlayers.sort((a, b) => b.chamigos - a.chamigos);

            if (rankedChamigoPlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos de Chamigos disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                chamigoTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de Chamigo
            rankedChamigoPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-3 text-center">${index + 1}</td>
                    <td class="py-3 px-3 text-left-player">${player.name}</td>
                    <td class="py-3 px-3 text-center">${player.chamigos}</td>
                `;
                chamigoTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            chamigoTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de TT ---
        function renderTTTable() {
            const ttTable = document.getElementById('tt-table');
            const ttTableBody = ttTable.querySelector('tbody');
            const loadingMessage = document.getElementById('tt-loading-message');

            ttTableBody.innerHTML = '';
            ttTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando tabla de Asistencia TT...`;

            const { players: rawRankedTTPlayers } = calculateStatsForPeriod('tt-year-select', 'tt-period-select');

            // FILTRADO: Solo jugadores con TT > 0
            const rankedTTPlayers = rawRankedTTPlayers.filter(player => player.tt > 0);

            // Ordenar por cantidad de TT (descendente)
            rankedTTPlayers.sort((a, b) => b.tt - a.tt);

            if (rankedTTPlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos de Asistencia TT disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                ttTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de TT
            rankedTTPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-3 text-center">${index + 1}</td>
                    <td class="py-3 px-3 text-left-player">${player.name}</td>
                    <td class="py-3 px-3 text-center">${player.tt}</td>
                `;
                ttTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            ttTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de Presentismo ---
        function renderPresentismoTable() {
            const presentismoTable = document.getElementById('presentismo-table');
            const presentismoTableBody = presentismoTable.querySelector('tbody');
            const loadingMessage = document.getElementById('presentismo-loading-message');

            presentismoTableBody.innerHTML = '';
            presentismoTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando tabla de Presentismo...`;

            const { players: rawRankedPJPlayers } = calculateStatsForPeriod('presentismo-year-select', 'presentismo-period-select');

            // MODIFICADO: FILTRADO: Solo jugadores con PJ > 0 (al menos un partido jugado)
            const rankedPJPlayers = rawRankedPJPlayers.filter(player => player.pj > 0);

            // Ordenar por PJ (descendente)
            rankedPJPlayers.sort((a, b) => b.pj - a.pj);

            if (rankedPJPlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos de Presentismo disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                presentismoTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de Presentismo
            rankedPJPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-3 text-center">${index + 1}</td>
                    <td class="py-3 px-3 text-left-player">${player.name}</td>
                    <td class="py-3 px-3 text-center">${player.pj}</td>
                `;
                presentismoTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            presentismoTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de Ausentismo ---
        function renderAusentismoTable() {
            const ausentismoTable = document.getElementById('ausentismo-table');
            const ausentismoTableBody = ausentismoTable.querySelector('tbody');
            const loadingMessage = document.getElementById('ausentismo-loading-message');

            ausentismoTableBody.innerHTML = '';
            ausentismoTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando tabla de Ausentismo...`;

            const { players: rawRankedAusentePlayers } = calculateStatsForPeriod('ausentismo-year-select', 'ausentismo-period-select');

            // MODIFICADO: FILTRADO: Solo jugadores con PJ > 0 (al menos un partido jugado)
            const rankedAusentePlayers = rawRankedAusentePlayers.filter(player => player.pj > 0);

            // Ordenar por Ausentes (descendente)
            rankedAusentePlayers.sort((a, b) => b.ausentes - a.ausentes);

            if (rankedAusentePlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos de Ausentismo disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                ausentismoTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de Ausentismo
            rankedAusentePlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-3 text-center">${index + 1}</td>
                    <td class="py-3 px-3 text-left-player">${player.name}</td>
                    <td class="py-3 px-3 text-center">${player.ausentes}</td>
                `;
                ausentismoTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            ausentismoTable.classList.remove('hidden');
        }

        // --- Renderizar Tabla de Estadísticas ---
        function renderEstadisticasTable() {
            const estadisticasTable = document.getElementById('estadisticas-table');
            const estadisticasTableBody = estadisticasTable.querySelector('tbody');
            const loadingMessage = document.getElementById('estadisticas-loading-message');
            const sortCriterionSelect = document.getElementById('estadisticas-sort-criterion');
            const sortOrderSelect = document.getElementById('estadisticas-sort-order');

            estadisticasTableBody.innerHTML = '';
            estadisticasTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando estadísticas...`;

            const { players: rawRankedEstadisticasPlayers } = calculateStatsForPeriod('estadisticas-year-select', 'estadisticas-period-select');

            // FILTRADO: Solo jugadores con PJ > 0
            const rankedEstadisticasPlayers = rawRankedEstadisticasPlayers.filter(player => player.pj > 0);

            // Obtener el criterio y orden de clasificación seleccionados
            const sortCriterion = sortCriterionSelect.value;
            const sortOrder = sortOrderSelect.value;

            // Ordenar jugadores según el criterio y orden seleccionados
            rankedEstadisticasPlayers.sort((a, b) => {
                let valA = a[sortCriterion];
                let valB = b[sortCriterion];

                // Manejo especial para 'efectividad' ya que es una cadena con '%'
                if (sortCriterion === 'efectividad') {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                }

                if (sortOrder === 'asc') {
                    return valA - valB;
                } else {
                    return valB - valA;
                }
            });

            if (rankedEstadisticasPlayers.length === 0) {
                loadingMessage.innerHTML = `No hay datos de Estadísticas disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                estadisticasTable.classList.add('hidden');
                return;
            }

            // Renderizar la tabla de Estadísticas
            rankedEstadisticasPlayers.forEach((player, index) => {
                const rowHTML = `
                    <td class="py-3 px-3 text-center">${index + 1}</td>
                    <td class="py-3 px-3 text-left-player">${player.name}</td>
                    <td class="py-3 px-3 text-center">${player.points}</td>
                    <td class="py-3 px-3 text-center">${player.pg}</td>
                    <td class="py-3 px-3 text-center">${player.pe}</td>
                    <td class="py-3 px-3 text-center">${player.pp}</td>
                    <td class="py-3 px-3 text-center">${player.pj}</td>
                    <td class="py-3 px-3 text-center">${player.efectividad}%</td>
                    <td class="py-3 px-3 text-center">${player.chamigos}</td>
                    <td class="py-3 px-3 text-center">${player.tt}</td>
                    <td class="py-3 px-3 text-center">${player.ausentes}</td>
                `;
                estadisticasTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
            });

            loadingMessage.classList.add('hidden');
            estadisticasTable.classList.remove('hidden');
        }

        // --- Renderizar Estadísticas de Equipos ---
        function renderEquiposStats() {
            const equiposStatsDisplay = document.getElementById('equipos-stats-display');
            const loadingMessage = document.getElementById('equipos-loading-message');

            // 1. Mostrar mensaje de carga y ocultar display de stats
            loadingMessage.classList.remove('hidden');
            equiposStatsDisplay.classList.add('hidden');
            equiposStatsDisplay.innerHTML = ''; // Limpiar contenido anterior
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando estadísticas de equipos...`;

            console.log('[renderEquiposStats] Starting render...'); // Debug log
            const { teamStats } = calculateStatsForPeriod('equipos-year-select', 'equipos-period-select');
            console.log('[renderEquiposStats] Calculated teamStats:', teamStats); // Debug log

            // 2. Ocultar mensaje de carga
            loadingMessage.classList.add('hidden');

            // Comprobar si hay algún partido para los filtros seleccionados
            if (teamStats.totalPJMatches === 0 && teamStats.suspendidos === 0) {
                loadingMessage.innerHTML = `No hay datos de Equipos disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                equiposStatsDisplay.classList.add('hidden');
                return;
            }

            // 3. Siempre construir y mostrar las tarjetas de estadísticas, incluso si los valores son 0
            // Aseguramos que los cuadros tengan el mismo tamaño y se distribuyan
            equiposStatsDisplay.innerHTML = `
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center w-full min-h-[120px]">
                    <span class="text-3xl font-bold" id="oscuros-wins">${teamStats.oscurosWins}</span>
                    <span class="text-sm uppercase">Oscuros Ganados</span>
                </div>
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center w-full min-h-[120px]">
                    <span class="text-3xl font-bold" id="claros-wins">${teamStats.clarosWins}</span>
                    <span class="text-sm uppercase">Claros Ganados</span>
                </div>
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center w-full min-h-[120px]">
                    <span class="text-3xl font-bold" id="empates">${teamStats.empates}</span>
                    <span class="text-sm uppercase">Empates</span>
                </div>
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center w-full min-h-[120px]">
                    <span class="text-3xl font-bold" id="suspendidos">${teamStats.suspendidos}</span>
                    <span class="text-sm uppercase">Suspendidos</span>
                </div>
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center w-full min-h-[120px]">
                    <span class="text-3xl font-bold" id="total-pj-matches">${teamStats.totalPJMatches}</span>
                    <span class="text-sm uppercase">Partidos Jugados</span>
                </div>
            `;
            equiposStatsDisplay.classList.remove('hidden'); // Mostrar el contenedor de stats
            console.log('[renderEquiposStats] Stats rendered successfully.'); // Debug log
        }

        // --- Funciones de Fixture ---
        function renderFixtureMatchCards() {
            const fixtureMatchesCardsContainer = document.getElementById('fixture-matches-cards-container');
            const fixtureYearSelect = document.getElementById('fixture-year-select');
            const fixtureMonthSelect = document.getElementById('fixture-month-select');
            const loadingMessage = document.getElementById('fixture-loading-message');
            const fixtureVisualDetailsContainer = document.getElementById('fixture-visual-details-container');
            const soccerFieldContainer = document.getElementById('soccer-field-container');
            const ttAttendeesTableBody = document.querySelector('#tt-attendees-table tbody');

            // Obtener referencias a los elementos del botón de alternancia del fixture
            const fixtureFilterToggle = document.getElementById('fixture-filter-toggle');
            const fixtureCollapsibleContent = document.getElementById('fixture-collapsible-content');
            const fixtureToggleIcon = fixtureFilterToggle.querySelector('.toggle-icon');
            const fixtureToggleSpan = fixtureFilterToggle.querySelector('span');


            fixtureMatchesCardsContainer.innerHTML = ''; // Limpiar tarjetas anteriores
            fixtureVisualDetailsContainer.classList.add('hidden'); // Ocultar el contenedor de detalles visuales al volver a renderizar las tarjetas
            soccerFieldContainer.querySelectorAll('.player-wrapper, .winner-trophy').forEach(el => el.remove()); // Limpiar elementos dinámicos del campo
            ttAttendeesTableBody.innerHTML = ''; // Limpiar asistentes TT anteriores

            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando partidos...`;

            const filteredMatches = getFilteredMatches(fixtureYearSelect.id, fixtureMonthSelect.id, true);
            console.log(`[renderFixtureMatchCards] Found ${filteredMatches.length} matches for selection.`);

            if (filteredMatches.length === 0) {
                loadingMessage.innerHTML = `No hay partidos disponibles para los filtros seleccionados.`;
                loadingMessage.classList.remove('hidden');
                // Asegura que el texto del botón sea el predeterminado cuando no se encuentran partidos
                fixtureToggleSpan.textContent = 'Elegir otro partido';
                fixtureFilterToggle.classList.add('visible-content');
                fixtureFilterToggle.classList.remove('hidden-content');
                fixtureToggleIcon.classList.remove('fa-chevron-down');
                fixtureToggleIcon.classList.add('fa-chevron-up');
                fixtureCollapsibleContent.classList.remove('hidden'); // Asegura que el contenedor de tarjetas sea visible
                lastSelectedFixtureMatchId = null; // No hay partido seleccionado si no hay datos
                return;
            }

            // Ordenar partidos por fecha descendente (más reciente primero)
            filteredMatches.sort((a, b) => parseDate(b[1]).getTime() - parseDate(a[1]).getTime());

            // Obtener la fecha de hoy a medianoche para la comparación
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let currentOrFutureMatchFound = false;

            filteredMatches.forEach(match => {
                const [matchId, date] = match;
                const matchDateObj = parseDate(date);
                matchDateObj.setHours(0, 0, 0, 0); // Establecer a medianoche para una comparación de fecha precisa

                let displayDateText = `Partido del ${date}`;
                let bgColorClasses = 'bg-white'; // Fondo predeterminado para partidos no actuales
                let textColorClasses = 'text-indigo-700'; // Color de texto predeterminado para partidos no actuales
                let identifierClass = ''; // Para marcar el partido actual

                // Comprobar si es un partido actual o futuro
                if (matchDateObj.getTime() >= today.getTime() && !currentOrFutureMatchFound) {
                    displayDateText = 'PARTIDO ACTUAL';
                    bgColorClasses = 'bg-gradient-to-r from-blue-600 to-indigo-700'; // Fondo degradado
                    textColorClasses = 'current-match-card-text'; // Usar clase específica para texto blanco
                    identifierClass = 'current-match-card';
                    currentOrFutureMatchFound = true;
                }

                // Clases base para todos los elementos de partido
                const matchItemBaseClasses = `
                    p-2 rounded-lg shadow-sm cursor-pointer
                    transition duration-150 ease-in-out
                    flex justify-center items-center text-sm font-semibold
                    sm:p-4 sm:shadow-md sm:text-base
                `;

                // Combinar todas las clases
                const finalMatchItemClasses = `${matchItemBaseClasses} ${bgColorClasses} ${textColorClasses} ${identifierClass}`;
                
                const cardHtml = `
                    <div class="fixture-match-item ${finalMatchItemClasses}" data-match-id="${matchId}">
                        ${displayDateText}
                    </div>
                `;
                fixtureMatchesCardsContainer.innerHTML += cardHtml;
            });

            // Añadir event listeners a cada tarjeta recién creada
            fixtureMatchesCardsContainer.querySelectorAll('.fixture-match-item').forEach(card => { // Apuntar a la clase específica
                card.addEventListener('click', (event) => {
                    // Eliminar la clase 'selected' de TODAS las tarjetas
                    fixtureMatchesCardsContainer.querySelectorAll('.fixture-match-item').forEach(selectedCard => {
                        selectedCard.classList.remove('selected');
                        // Restaurar el fondo original para las tarjetas previamente seleccionadas
                        if (selectedCard.classList.contains('current-match-card')) {
                            selectedCard.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-indigo-700');
                        } else {
                            selectedCard.classList.add('bg-white');
                        }
                    });

                    // Añadir la clase 'selected' a la tarjeta clicada
                    event.currentTarget.classList.add('selected');
                    // Las reglas CSS para .fixture-match-item.selected y .current-match-card.selected manejarán el estilo
                    // No es necesario añadir colores de fondo específicos aquí, CSS se encarga de ello.

                    const matchId = event.currentTarget.dataset.matchId;
                    renderFixtureDetails(matchId); // Llamar a la función para renderizar detalles
                });
            });

            loadingMessage.classList.add('hidden');
            fixtureMatchesCardsContainer.classList.remove('hidden'); // Asegura que el contenedor sea visible
        }

        function renderFixtureDetails(matchId) {
            const loadingMessage = document.getElementById('fixture-loading-message');
            const fixtureVisualDetailsContainer = document.getElementById('fixture-visual-details-container');    
            const soccerFieldContainer = document.getElementById('soccer-field-container');
            const fixtureDetailsDisplay = document.getElementById('fixture-details-display');
            const ttAttendeesTableBody = document.querySelector('#tt-attendees-table tbody');

            // Obtener referencias a los elementos del botón de alternancia del fixture
            const fixtureFilterToggle = document.getElementById('fixture-filter-toggle');
            const fixtureCollapsibleContent = document.getElementById('fixture-collapsible-content');
            const fixtureToggleIcon = fixtureFilterToggle.querySelector('.toggle-icon');
            const fixtureToggleSpan = fixtureFilterToggle.querySelector('span');

            loadingMessage.classList.remove('hidden');
            fixtureVisualDetailsContainer.classList.add('hidden'); // Ocultar el contenedor mientras se carga
            
            // Limpiar solo los marcadores de jugador y el trofeo del campo
            soccerFieldContainer.querySelectorAll('.player-wrapper, .winner-trophy').forEach(el => el.remove());    
            ttAttendeesTableBody.innerHTML = ''; // Limpiar asistentes TT anteriores

            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando detalles del partido...`;
            
            const selectedMatch = allMatchesData.find(match => match[0] === matchId);

            if (!selectedMatch) {
                loadingMessage.innerHTML = `Detalles del partido no encontrados.`;
                lastSelectedFixtureMatchId = null; // Limpiar partido seleccionado si no se encuentra
                return;
            }

            // Almacenar el ID del partido seleccionado
            lastSelectedFixtureMatchId = matchId;

            const [id, date, clarosIDsStr, oscurosIDsStr, result, chamigoVotosStr, ttAttendeesStr] = selectedMatch;

            // Función de ayuda para obtener nombres de jugadores a partir de IDs
            const getPlayerNames = (idsString) => {
                if (!idsString || idsString.trim() === '') return []; // Devolver array vacío para cadena vacía
                const ids = idsString.split(',').filter(Boolean);
                return ids.map(playerId => {
                    const player = allPlayersData.find(p => p[0] === playerId);
                    return player ? player[1] : `ID Desconocido (${playerId})`;
                }).filter(Boolean); // Filtrar cualquier nombre nulo/indefinido
            };

            const clarosPlayerIDs = clarosIDsStr.split(',').filter(Boolean);
            const oscurosPlayerIDs = oscurosIDsStr.split(',').filter(Boolean);
            const winnerTeam = result || 'No definido';

            let chamigosIds = [];
            if (chamigoVotosStr) {
                try {
                    const chamigoVotos = JSON.parse(chamigoVotosStr);
                    if (chamigoVotos.length > 0) {
                        const maxVotes = Math.max(...chamigoVotos.map(v => v.votos));
                        const chamigosDelPartido = chamigoVotos.filter(v => v.votos === maxVotes);
                        chamigosIds = chamigosDelPartido.map(chamigo => chamigo.id);
                    }
                } catch (e) {
                    console.warn('Error al parsear votos de chamigo en el partido', id, ':', e);
                }
            }
            
            let ttAttendees = getPlayerNames(ttAttendeesStr);
            // Poblar tabla de asistentes TT
            if (ttAttendees.length > 0) {
                ttAttendees.forEach(name => {
                    const rowHTML = `
                        <td class="py-3 px-3 text-center">${name}</td> `;
                    ttAttendeesTableBody.innerHTML += `<tr class="border-b border-gray-200 hover:bg-gray-100">${rowHTML}</tr>`;
                });
            } else {
                ttAttendeesTableBody.innerHTML = `<tr><td class="py-3 px-3 text-center" colspan="1">No hay asistentes al TT registrados.</td></tr>`;
            }


            // Volver a añadir los goles y áreas al campo (si fueron eliminados, asegurando que estén presentes)
            if (soccerFieldContainer.children.length === 0 || soccerFieldContainer.querySelector('.goal') === null) {
                soccerFieldContainer.innerHTML = `
                    <div class="goal top"></div>
                    <div class="goal bottom"></div>
                    <div class="penalty-area top"></div>
                    <div class="penalty-area bottom"></div>
                    <div class="goal-area top"></div>
                    <div class="goal-area bottom"></div>
                `;
            }

            // Determinar la orientación del campo según el ancho de la pantalla
            // Forzando el Fixture a ser siempre vertical en móvil, horizontal en escritorio
            const isHorizontalField = window.innerWidth >= 768; // Breakpoint de escritorio

            // Aplicar/eliminar la clase horizontal-layout según isHorizontalField
            if (isHorizontalField) {
                soccerFieldContainer.classList.add('horizontal-layout');
                soccerFieldContainer.querySelectorAll('.goal').forEach(el => el.classList.add('horizontal-layout'));
                soccerFieldContainer.querySelectorAll('.penalty-area').forEach(el => el.classList.add('horizontal-layout'));
                soccerFieldContainer.querySelectorAll('.goal-area').forEach(el => el.classList.add('horizontal-layout'));
            } else {
                soccerFieldContainer.classList.remove('horizontal-layout');
                soccerFieldContainer.querySelectorAll('.goal').forEach(el => el.classList.remove('horizontal-layout'));
                soccerFieldContainer.querySelectorAll('.penalty-area').forEach(el => el.classList.remove('horizontal-layout'));
                soccerFieldContainer.querySelectorAll('.goal-area').forEach(el => el.classList.remove('horizontal-layout'));
            }

            // Posiciones normalizadas (0 a 1, relativas al ancho/alto del campo)
            // Estas son para un campo vertical (altura > ancho)
            const clarosNormalizedPositionsVertical = [
                { x: 0.5, y: 0.93 }, // Portero
                { x: 0.3, y: 0.79 }, // Defensor 1
                { x: 0.7, y: 0.79 }, // Defensor 2
                { x: 0.35, y: 0.63 }, // Centrocampista/Delantero 1
                { x: 0.65, y: 0.58 }    // Centrocampista/Delantero 2
            ];
            const oscurosNormalizedPositionsVertical = [
                { x: 0.5, y: 0.07 }, // Portero
                { x: 0.3, y: 0.21 }, // Defensor 1
                { x: 0.7, y: 0.21 }, // Defensor 2
                { x: 0.35, y: 0.42 }, // Centrocampista/Delantero 1
                { x: 0.65, y: 0.37 }    // Centrocampista/Delantero 2
            ];

            // Posiciones normalizadas (0 a 1, relativas al ancho/alto del campo)
            // Estas son para un campo horizontal (ancho > alto)
            const clarosNormalizedPositionsHorizontal = [
                { x: 0.92, y: 0.50 }, // Portero
                { x: 0.79, y: 0.20 }, // Defensor 1
                { x: 0.79, y: 0.80 }, // Defensor 2
                { x: 0.60, y: 0.32 }, // Centrocampista/Delantero 1 (Ajustado verticalmente)
                { x: 0.64, y: 0.68 }    // Centrocampista/Delantero 2 (Ajustado verticalmente)
            ];
            const oscurosNormalizedPositionsHorizontal = [
                { x: 0.08, y: 0.50 }, // Portero
                { x: 0.21, y: 0.20 }, // Defensor 1
                { x: 0.21, y: 0.80 }, // Defensor 2
                { x: 0.42, y: 0.32 }, // Centrocampista/Delantero 1 (Ajustado verticalmente)
                { x: 0.38, y: 0.68 }    // Centrocampista/Delantero 2 (Ajustado verticalmente)
            ];

            const currentClarosNormalizedPositions = isHorizontalField ? clarosNormalizedPositionsHorizontal : clarosNormalizedPositionsVertical;
            const currentOscurosNormalizedPositions = isHorizontalField ? oscurosNormalizedPositionsHorizontal : oscurosNormalizedPositionsVertical;

            // Añadir jugadores Claros
            clarosPlayerIDs.slice(0, 5).forEach((playerId, index) => {
                const playerWrapper = document.createElement('div');
                playerWrapper.classList.add('player-wrapper', 'claros');
                if (isHorizontalField) playerWrapper.classList.add('horizontal-layout'); // Añadir clase para escritorio

                const playerMarker = document.createElement('div');
                playerMarker.classList.add('player-marker', 'claros');
                // Usar el número del ID sin ceros iniciales
                playerMarker.textContent = parseInt(playerId.replace('J', '')).toString();    
                if (chamigosIds.includes(playerId)) {
                    const starIcon = document.createElement('i');
                    starIcon.classList.add('fas', 'fa-star', 'text-yellow-400');
                    playerMarker.appendChild(starIcon);
                }

                const playerNameLabel = document.createElement('div');
                playerNameLabel.classList.add('player-name-label');
                playerNameLabel.textContent = allPlayersData.find(p => p[0] === playerId)?.[1] || ''; // Nombre completo

                playerWrapper.appendChild(playerMarker);
                playerWrapper.appendChild(playerNameLabel);

                playerWrapper.style.top = `${currentClarosNormalizedPositions[index].y * 100}%`;
                playerWrapper.style.left = `${currentClarosNormalizedPositions[index].x * 100}%`;
                soccerFieldContainer.appendChild(playerWrapper);
            });

            // Añadir jugadores Oscuros
            oscurosPlayerIDs.slice(0, 5).forEach((playerId, index) => {
                const playerWrapper = document.createElement('div');
                playerWrapper.classList.add('player-wrapper', 'oscuros');
                if (isHorizontalField) playerWrapper.classList.add('horizontal-layout'); // Añadir clase para escritorio

                const playerMarker = document.createElement('div');
                playerMarker.classList.add('player-marker', 'oscuros');
                // Usar el número del ID sin ceros iniciales
                playerMarker.textContent = parseInt(playerId.replace('J', '')).toString();    
                if (chamigosIds.includes(playerId)) {
                    const starIcon = document.createElement('i');
                    starIcon.classList.add('fas', 'fa-star', 'text-yellow-400');
                    starIcon.style.color = 'var(--text-yellow-400)'; // Asegurar el color de la estrella
                    playerMarker.appendChild(starIcon);
                }

                const playerNameLabel = document.createElement('div');
                playerNameLabel.classList.add('player-name-label');
                playerNameLabel.textContent = allPlayersData.find(p => p[0] === playerId)?.[1] || ''; // Nombre completo

                playerWrapper.appendChild(playerMarker);
                playerWrapper.appendChild(playerNameLabel);

                playerWrapper.style.top = `${currentOscurosNormalizedPositions[index].y * 100}%`;
                playerWrapper.style.left = `${currentOscurosNormalizedPositions[index].x * 100}%`;
                soccerFieldContainer.appendChild(playerWrapper);
            });

            // Añadir Trofeo del Ganador
            if (winnerTeam !== 'No definido' && winnerTeam !== 'Empate' && winnerTeam !== 'Suspendido') {
                const trophyDiv = document.createElement('div');
                trophyDiv.classList.add('winner-trophy');
                if (isHorizontalField) trophyDiv.classList.add('horizontal-layout'); // Añadir clase para escritorio
                trophyDiv.innerHTML = '<i class="fas fa-trophy"></i>';
                
                // Determinar la posición según la orientación del campo y el equipo ganador
                if (isHorizontalField) { // Escritorio o móvil horizontal
                    if (winnerTeam === 'Claros') {
                        trophyDiv.style.top = '95%'; // Abajo a la derecha (lado Claros en horizontal)
                        trophyDiv.style.left = '94%';
                    } else if (winnerTeam === 'Oscuros') {
                        trophyDiv.style.top = '95%'; // Abajo a la izquierda (lado Oscuros en horizontal)
                        trophyDiv.style.left = '6%';
                    }
                } else { // Móvil vertical
                    if (winnerTeam === 'Claros') {
                        trophyDiv.style.top = '96%'; // Abajo a la derecha (lado Claros en vertical)
                        trophyDiv.style.left = '94%';
                    } else if (winnerTeam === 'Oscuros') {
                        trophyDiv.style.top = '6%'; // Arriba a la derecha (lado Oscuros en vertical)
                        trophyDiv.style.left = '94%';
                    }
                }
                soccerFieldContainer.appendChild(trophyDiv);
            }

            // Mostrar tanto el campo de fútbol como el contenedor de detalles
            fixtureVisualDetailsContainer.classList.remove('hidden'); // Mostrar el contenedor general
            fixtureCollapsibleContent.classList.add('hidden'); // Ocultar tarjetas de partidos
            fixtureFilterToggle.classList.add('hidden-content'); // Establecer el estilo del botón para el estado de "contenido oculto"
            fixtureFilterToggle.classList.remove('visible-content');
            fixtureToggleIcon.classList.remove('fa-chevron-up');
            fixtureToggleIcon.classList.add('fa-chevron-down');

            // Actualizar el texto del botón de alternancia del fixture
            const selectedMatchCard = document.querySelector(`.fixture-match-item[data-match-id="${matchId}"]`);
            let buttonText = `Partido del ${date}`;
            if (selectedMatchCard && selectedMatchCard.classList.contains('current-match-card')) {
                buttonText = 'PARTIDO ACTUAL';
            }
            fixtureToggleSpan.textContent = buttonText; // Actualizar el texto del botón

            loadingMessage.classList.add('hidden');
        }

        // --- Utilidades ---
        function parseDate(dateString) {
            const [day, month, year] = dateString.split('/').map(Number);
            return new Date(year, month - 1, day);
        }

        function populateYearSelects(selectId, storageKeyPrefix) {
            const yearSelect = document.getElementById(selectId);
            const years = new Set();
            allMatchesData.forEach(match => {
                const dateString = match[1];
                if (dateString) {
                    const date = parseDate(dateString);
                    years.add(date.getFullYear());
                }
            });

            const sortedYears = Array.from(years).sort((a, b) => b - a);

            yearSelect.innerHTML = '';
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'Todos los Años';
            yearSelect.appendChild(allOption);

            if (sortedYears.length > 0) {
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            }

            // Establecer el año actual como predeterminado
            const today = new Date();
            const currentYear = today.getFullYear();
            const yearOption = Array.from(yearSelect.options).find(option => parseInt(option.value) === currentYear);
            if (yearOption) {
                yearSelect.value = currentYear;
            } else {
                yearSelect.value = 'all';
            }
        }

        function populateMonthSelects(selectId, storageKeyPrefix) {
            const monthSelect = document.getElementById(selectId);
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];

            monthSelect.innerHTML = '';
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'Todos los Meses';
            monthSelect.appendChild(allOption);

            months.forEach((monthName, index) => {
                const option = document.createElement('option');
                option.value = index + 1; // El mes es 1-indexed para el valor
                option.textContent = monthName;
                monthSelect.appendChild(option);
            });

            // Establecer el mes actual como predeterminado
            const today = new Date();
            const currentMonth = today.getMonth() + 1; // getMonth es 0-indexed
            const monthOption = Array.from(monthSelect.options).find(option => parseInt(option.value) === currentMonth);
            if (monthOption) {
                monthSelect.value = currentMonth;
            } else {
                monthSelect.value = 'all';
            }
        }


        function populateAndSetCurrentPeriod(yearSelectId, periodSelectId, storageKeyPrefix) {
            populateYearSelects(yearSelectId, storageKeyPrefix); // Primero poblar años

            const periodSelect = document.getElementById(periodSelectId);
            
            // Establecer el período actual según el mes actual
            const today = new Date();
            const currentMonth = today.getMonth(); // 0-indexed
            let currentPeriodValue;
            if (currentMonth >= 0 && currentMonth <= 5) { // Enero a Junio (Apertura)
                currentPeriodValue = 'apertura';
            } else if (currentMonth >= 6 && currentMonth <= 11) { // Julio a Diciembre (Clausura)
                currentPeriodValue = 'clausura';
            } else {
                currentPeriodValue = 'total';
            }
            periodSelect.value = currentPeriodValue;
        }

        // Función para calcular estadísticas de jugador individual
        function calculateIndividualPlayerStats(playerId) {
            const playerStats = {
                years: {},
                overallTotal: { points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: 0, chamigos: 0, tt: 0, ausentes: 0 }
            };

            const playerInfo = allPlayersData.find(p => p[0] === playerId);
            if (!playerInfo) return null; // Jugador no encontrado

            const playerName = playerInfo[1];

            // Obtener todos los años presentes en los datos de partidos
            const allYearsInMatches = new Set();
            allMatchesData.forEach(match => {
                const dateString = match[1];
                if (dateString) {
                    const [day, month, year] = dateString.split('/').map(Number);
                    allYearsInMatches.add(year);
                }
            });

            // Inicializar estadísticas para todos los años y períodos para el jugador seleccionado
            Array.from(allYearsInMatches).sort().forEach(year => {
                playerStats.years[year] = {
                    apertura: { points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: 0, chamigos: 0, tt: 0, ausentes: 0 },
                    clausura: { points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: 0, chamigos: 0, tt: 0, ausentes: 0 },
                    total: { points: 0, pg: 0, pe: 0, pp: 0, pj: 0, efectividad: 0, chamigos: 0, tt: 0, ausentes: 0 }
                };
            });

            // Calcular estadísticas para cada partido
            allMatchesData.forEach(match => {
                const [matchId, dateString, clarosIDsStr, oscurosIDsStr, result, chamigoVotosStr, ttAttendeesStr] = match;
                if (!dateString) return;

                const [day, month, year] = dateString.split('/').map(Number);
                const matchDate = new Date(year, month - 1, day); // El mes es 0-indexed
                const matchYear = matchDate.getFullYear();
                const matchMonth = matchDate.getMonth(); // 0-11

                const period = (matchMonth >= 0 && matchMonth <= 5) ? 'apertura' : 'clausura';

                const clarosPlayers = clarosIDsStr.split(',').filter(Boolean);
                const oscurosPlayers = oscurosIDsStr.split(',').filter(Boolean);
                const allPlayersInMatch = [...new Set([...clarosPlayers, ...oscurosPlayers])];

                const isPlayerInMatch = allPlayersInMatch.includes(playerId);

                if (playerStats.years[matchYear]) { // Comprobar si el año existe en la estructura de estadísticas
                    const currentYearStats = playerStats.years[matchYear];
                    const currentPeriodStats = currentYearStats[period];
                    const currentYearTotalStats = currentYearStats.total;

                    // Actualizar PJ (Partidos Jugados) si el jugador estuvo en el partido y el partido no fue suspendido
                    if (isPlayerInMatch && result !== 'Suspendido') {
                        currentPeriodStats.pj += 1;
                        currentYearTotalStats.pj += 1;
                        playerStats.overallTotal.pj += 1;
                    }

                    // Actualizar puntos según el resultado del partido si el jugador estuvo en el partido
                    if (isPlayerInMatch) {
                        if (result === 'Claros' && clarosPlayers.includes(playerId)) {
                            currentPeriodStats.points += 3;
                            currentPeriodStats.pg += 1;
                            currentYearTotalStats.points += 3;
                            currentYearTotalStats.pg += 1;
                            playerStats.overallTotal.points += 3;
                            playerStats.overallTotal.pg += 1;
                        } else if (result === 'Oscuros' && oscurosPlayers.includes(playerId)) {
                            currentPeriodStats.points += 3;
                            currentPeriodStats.pg += 1;
                            currentYearTotalStats.points += 3;
                            currentYearTotalStats.pg += 1;
                            playerStats.overallTotal.points += 3;
                            playerStats.overallTotal.pg += 1;
                        } else if (result === 'Empate') { // Si el jugador estuvo en el partido y fue un empate
                            currentPeriodStats.points += 1;
                            currentPeriodStats.pe += 1;
                            currentYearTotalStats.points += 1;
                            currentYearTotalStats.pe += 1;
                            playerStats.overallTotal.points += 1;
                            playerStats.overallTotal.pe += 1;
                        } else if (result !== 'Suspendido') { // Si el jugador estuvo en el partido y fue una derrota
                            currentPeriodStats.pp += 1;
                            currentYearTotalStats.pp += 1;
                            playerStats.overallTotal.pp += 1;
                        }

                        // Conteo de Chamigo para el jugador específico
                        if (chamigoVotosStr) {
                            try {
                                const chamigoVotos = JSON.parse(chamigoVotosStr);
                                if (chamigoVotos.length > 0) {
                                    const maxVotes = Math.max(...chamigoVotos.map(v => v.votos));
                                    const chamigosDelPartido = chamigoVotos.filter(v => v.votos === maxVotes);
                                    if (chamigosDelPartido.some(c => c.id === playerId)) {
                                        currentPeriodStats.chamigos += 1;
                                        currentYearTotalStats.chamigos += 1;
                                        playerStats.overallTotal.chamigos += 1;
                                    }
                                }
                            } catch (e) {
                                console.warn('Error al parsear votos de chamigo en el partido', matchId, ':', e);
                            }
                        }

                        // Conteo de TT para el jugador específico
                        if (ttAttendeesStr) {
                            const ttAttendees = ttAttendeesStr.split(',').filter(Boolean);
                            if (ttAttendees.includes(playerId)) {
                                currentPeriodStats.tt += 1;
                                currentYearTotalStats.tt += 1;
                                playerStats.overallTotal.tt += 1;
                            }
                        }
                    }
                }
            });

            // Calcular Efectividad y Ausentes para cada período, total del año y total general
            Array.from(allYearsInMatches).sort().forEach(year => {
                const yearStats = playerStats.years[year];
                ['apertura', 'clausura'].forEach(periodType => { // Solo iterar a través de apertura/clausura para períodos individuales
                    const stats = yearStats[periodType];
                    const maxPossiblePoints = stats.pj * 3;
                    if (maxPossiblePoints > 0) {
                        stats.efectividad = ((stats.points / maxPossiblePoints) * 100).toFixed(2);
                    } else {
                        stats.efectividad = 0;
                    }
                    
                    // Calcular el total de partidos no suspendidos para este período/año para ausentes precisos
                    const totalMatchesInPeriod = allMatchesData.filter(m => {
                        const [d, mo, y] = m[1].split('/').map(Number);
                        const matchDate = new Date(y, mo - 1, d);
                        const mYear = matchDate.getFullYear();
                        const mMonth = matchDate.getMonth();
                        const mPeriod = (mMonth >= 0 && mMonth <= 5) ? 'apertura' : 'clausura';
                        
                        return mYear === year && mPeriod === periodType && m[4] !== 'Suspendido';
                    }).length;

                    stats.ausentes = totalMatchesInPeriod - stats.pj;
                    if (stats.ausentes < 0) stats.ausentes = 0;
                });

                // Calcular para el total del año
                const yearTotalStats = yearStats.total;
                const yearTotalMaxPossiblePoints = yearTotalStats.pj * 3;
                if (yearTotalMaxPossiblePoints > 0) {
                    yearTotalStats.efectividad = ((yearTotalStats.points / yearTotalMaxPossiblePoints) * 100).toFixed(2);
                } else {
                    yearTotalStats.efectividad = 0;
                }
                const totalMatchesInYear = allMatchesData.filter(m => {
                    const [d, mo, y] = m[1].split('/').map(Number);
                    return y === year && m[4] !== 'Suspendido';
                }).length;
                yearTotalStats.ausentes = totalMatchesInYear - yearTotalStats.pj;
                if (yearTotalStats.ausentes < 0) yearTotalStats.ausentes = 0;
            });

            // Efectividad y ausentes totales
            const overallMaxPossiblePoints = playerStats.overallTotal.pj * 3;
            if (overallMaxPossiblePoints > 0) {
                playerStats.overallTotal.efectividad = ((playerStats.overallTotal.points / overallMaxPossiblePoints) * 100).toFixed(2);
            } else {
                playerStats.overallTotal.efectividad = 0;
            }
            const totalNonSuspendedMatches = allMatchesData.filter(m => m[4] !== 'Suspendido').length;
            playerStats.overallTotal.ausentes = totalNonSuspendedMatches - playerStats.overallTotal.pj;
            if (playerStats.overallTotal.ausentes < 0) playerStats.overallTotal.ausentes = 0;


            return { playerName, stats: playerStats };
        }

        // Función para configurar la búsqueda de jugadores con autocompletado
        function setupPlayerSearch() {
            const playerSearchInput = document.getElementById('individual-player-search');
            const playerResultsDiv = document.getElementById('individual-player-results');
            const selectedPlayerIdInput = document.getElementById('selected-player-id');
            const clearSearchButton = document.getElementById('clear-player-search'); // Obtener el botón de limpiar
            let timeoutId; // Para el debounce del input
            let highlightedIndex = -1; // Para seguir el elemento resaltado para la navegación con teclado
            let isClearing = false; // Bandera para el botón de limpiar

            // Función de ayuda para eliminar el resaltado de todos los resultados
            const removeHighlight = () => {
                playerResultsDiv.querySelectorAll('.highlighted').forEach(item => {
                    item.classList.remove('highlighted');
                });
            };

            // Función de ayuda para aplicar el resaltado a un índice específico
            const highlightResult = (index) => {
                removeHighlight();
                const results = playerResultsDiv.children;
                if (results.length > 0 && index >= 0 && index < results.length) {
                    results[index].classList.add('highlighted');
                    playerSearchInput.value = results[index].textContent; // Actualizar el valor del input
                    // Desplazar el elemento resaltado a la vista
                    results[index].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    highlightedIndex = index;
                }
            };

            // Función para filtrar y mostrar jugadores (reutilizable)
            const filterAndDisplayPlayers = () => {
                playerResultsDiv.innerHTML = '';
                const searchTerm = playerSearchInput.value.toLowerCase();

                // Filtrar jugadores (incluyendo los inactivos, según el cambio anterior)
                // Mostrar todos los jugadores si searchTerm está vacío
                const filteredPlayers = allPlayersData.filter(p => 
                    p[1].toLowerCase().includes(searchTerm)
                ).sort((a, b) => a[1].localeCompare(b[1]));

                if (filteredPlayers.length > 0) {
                    filteredPlayers.forEach(player => {
                        const resultItem = document.createElement('div');
                        resultItem.classList.add('p-2', 'cursor-pointer', 'hover:bg-gray-100');
                        resultItem.textContent = player[1];
                        resultItem.dataset.playerId = player[0]; // Almacenar el ID del jugador
                        resultItem.addEventListener('click', () => {
                            playerSearchInput.value = player[1];
                            selectedPlayerIdInput.value = resultItem.dataset.playerId;
                            playerResultsDiv.classList.add('hidden');
                            highlightedIndex = -1; // Reiniciar el resaltado después de la selección
                            renderIndividualStatsTable();
                        });
                        playerResultsDiv.appendChild(resultItem);
                    });
                    playerResultsDiv.classList.remove('hidden'); // Asegura que los resultados sean visibles
                } else {
                    playerResultsDiv.classList.add('hidden');
                }
            };

            // Limpiar input al enfocar - MODIFICADO para ser más amigable
            playerSearchInput.addEventListener('focus', () => {
                // Si no hay jugador seleccionado, o el input está vacío, mostrar todos los jugadores
                if (selectedPlayerIdInput.value === '' || playerSearchInput.value === '') {
                    selectedPlayerIdInput.value = ''; // Limpiar el ID seleccionado para asegurar una búsqueda nueva
                    document.getElementById('individual-stats-table').classList.add('hidden');
                    document.getElementById('individual-stats-loading-message').classList.remove('hidden');
                    document.getElementById('individual-stats-loading-message').textContent = 'Escribe al menos 1 carácter para buscar un jugador.';
                    filterAndDisplayPlayers(); // Mostrar todos los jugadores al enfocar
                }
                highlightedIndex = -1; // Reiniciar el resaltado
            });

            playerSearchInput.addEventListener('input', () => {
                clearTimeout(timeoutId);
                const searchTerm = playerSearchInput.value.toLowerCase();
                
                removeHighlight(); // Limpiar el resaltado en la nueva entrada
                highlightedIndex = -1; // Reiniciar el índice de resaltado

                // Filtrar desde 1 carácter
                if (searchTerm.length < 1) { // Cambiado de 3 a 1
                    playerResultsDiv.innerHTML = '';
                    playerResultsDiv.classList.remove('hidden'); // Mantener visible para mostrar "Escribe al menos 1 carácter"
                    selectedPlayerIdInput.value = ''; // Limpiar el jugador seleccionado si el término de búsqueda es demasiado corto
                    document.getElementById('individual-stats-table').classList.add('hidden');
                    document.getElementById('individual-stats-loading-message').classList.remove('hidden');
                    document.getElementById('individual-stats-loading-message').textContent = 'Escribe al menos 1 carácter para buscar un jugador.';
                    filterAndDisplayPlayers(); // Mostrar todos los jugadores cuando el input está vacío
                    return;
                }

                timeoutId = setTimeout(() => {
                    filterAndDisplayPlayers(); // Llamar a la función reutilizable
                }, 300); // Debounce de 300ms
            });

            // Funcionalidad del botón de limpiar
            clearSearchButton.addEventListener('click', () => {
                isClearing = true; // Establecer bandera
                playerSearchInput.value = ''; // Limpiar input
                selectedPlayerIdInput.value = ''; // Limpiar ID seleccionado
                playerResultsDiv.innerHTML = ''; // Limpiar resultados
                playerResultsDiv.classList.remove('hidden'); // Asegura que los resultados sean visibles
                document.getElementById('individual-stats-table').classList.add('hidden'); // Ocultar tabla de estadísticas
                document.getElementById('individual-stats-loading-message').classList.remove('hidden'); // Mostrar mensaje
                document.getElementById('individual-stats-loading-message').textContent = 'Escribe al menos 1 carácter para buscar un jugador.';
                highlightedIndex = -1; // Reiniciar el resaltado
                playerSearchInput.focus(); // Volver a enfocar el input
                filterAndDisplayPlayers(); // Mostrar todos los jugadores en autocompletado
                setTimeout(() => { isClearing = false; }, 200); // Reiniciar bandera después de un breve retraso
            });


            // Navegación con teclado
            playerSearchInput.addEventListener('keydown', (event) => {
                const results = playerResultsDiv.children;
                if (results.length === 0) return;

                if (event.key === 'ArrowDown') {
                    event.preventDefault(); // Evitar el movimiento del cursor en el input
                    highlightedIndex = (highlightedIndex + 1) % results.length;
                    highlightResult(highlightedIndex);
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault(); // Evitar el movimiento del cursor en el input
                    highlightedIndex = (highlightedIndex - 1 + results.length) % results.length;
                    highlightResult(highlightedIndex);
                } else if (event.key === 'Enter') {
                    event.preventDefault(); // Evitar el envío del formulario
                    if (highlightedIndex !== -1) {
                        results[highlightedIndex].click(); // Simular clic en el elemento resaltado
                    } else if (results.length > 0) {
                        // Si no hay ningún elemento resaltado explícitamente, pero los resultados están visibles, seleccionar el primero
                        results[0].click();
                    }
                }
            });

            // Ocultar resultados cuando el input pierde el foco (con un pequeño retraso para permitir el clic en los resultados)
            playerSearchInput.addEventListener('focusout', (event) => {
                // Solo ocultar si no se está limpiando actualmente (para evitar la re-ocultación inmediata después de hacer clic en el botón de limpiar)
                // y si el foco se está moviendo fuera del input de búsqueda y el contenedor de resultados.
                const isClickingInsideSearchArea = playerResultsDiv.contains(event.relatedTarget) || event.relatedTarget === playerSearchInput || clearSearchButton.contains(event.relatedTarget);
                if (!isClearing && !isClickingInsideSearchArea) {
                    setTimeout(() => {
                        playerResultsDiv.classList.add('hidden');
                    }, 100); // Pequeño retraso para permitir que los eventos de clic en los resultados se disparen
                }
            });

            // Estado inicial: comprobar si un jugador fue seleccionado previamente y poblar el input
            const lastSelectedPlayerId = localStorage.getItem('lastSelectedIndividualPlayerId'); // Leer desde localStorage
            if (lastSelectedPlayerId) {
                const lastSelectedPlayer = allPlayersData.find(p => p[0] === lastSelectedPlayerId);
                if (lastSelectedPlayer) {
                    playerSearchInput.value = lastSelectedPlayer[1];
                    selectedPlayerIdInput.value = lastSelectedPlayer[0];
                    // Renderizar estadísticas si un jugador está preseleccionado
                    renderIndividualStatsTable();
                } else {
                    // Si el jugador almacenado no se encuentra (ej. eliminado), por defecto a J001 o sin selección
                    // Intentar encontrar J001 o por defecto al primer jugador si está disponible
                    const defaultPlayer = allPlayersData.find(p => p[0] === 'J001') || allPlayersData[0];
                    if (defaultPlayer) {
                        playerSearchInput.value = defaultPlayer[1];
                        selectedPlayerIdInput.value = defaultPlayer[0];
                        localStorage.setItem('lastSelectedIndividualPlayerId', defaultPlayer[0]); // Guardar por defecto
                        renderIndividualStatsTable();
                    } else {
                        document.getElementById('individual-stats-table').classList.add('hidden');
                        document.getElementById('individual-stats-loading-message').classList.remove('hidden');
                        document.getElementById('individual-stats-loading-message').textContent = 'Selecciona un jugador para ver sus estadísticas.';
                    }
                }
            } else {
                // Si no hay jugador almacenado, por defecto a J001 o al primer jugador disponible
                const defaultPlayer = allPlayersData.find(p => p[0] === 'J001') || allPlayersData[0];
                if (defaultPlayer) {
                    playerSearchInput.value = defaultPlayer[1];
                    selectedPlayerIdInput.value = defaultPlayer[0];
                    localStorage.setItem('lastSelectedIndividualPlayerId', defaultPlayer[0]); // Guardar por defecto
                    renderIndividualStatsTable();
                } else {
                    document.getElementById('individual-stats-table').classList.add('hidden');
                    document.getElementById('individual-stats-loading-message').classList.remove('hidden');
                    document.getElementById('individual-stats-loading-message').textContent = 'Selecciona un jugador para ver sus estadísticas.';
                }
            }
        }

        // Función para renderizar la tabla de estadísticas individuales
        function renderIndividualStatsTable() {
            const selectedPlayerId = document.getElementById('selected-player-id').value;
            const individualStatsTable = document.getElementById('individual-stats-table');
            const individualStatsTableBody = individualStatsTable.querySelector('tbody');
            const loadingMessage = document.getElementById('individual-stats-loading-message');

            individualStatsTableBody.innerHTML = ''; // Limpiar contenido anterior
            individualStatsTable.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = `<span class="loading-spinner"></span>Cargando estadísticas individuales...`;

            if (!selectedPlayerId) {
                loadingMessage.textContent = 'Selecciona un jugador para ver sus estadísticas.';
                return;
            }

            // Guardar el jugador seleccionado en localStorage
            localStorage.setItem('lastSelectedIndividualPlayerId', selectedPlayerId); // Guardar en localStorage

            const playerStatsData = calculateIndividualPlayerStats(selectedPlayerId);

            if (!playerStatsData || (!Object.keys(playerStatsData.stats.years).length && playerStatsData.stats.overallTotal.pj === 0)) {
                loadingMessage.textContent = 'No hay datos disponibles para el jugador seleccionado.';
                return;
            }

            // Renderizar la fila TOTAL primero, siempre visible
            const totalStats = playerStatsData.stats.overallTotal;
            individualStatsTableBody.innerHTML += `
                <tr class="bg-blue-200 font-bold text-indigo-800">
                    <td class="py-3 px-3 text-center">TOTAL</td>
                    <td class="py-3 px-3 text-center"></td> <!-- Columna Torneo vacía para el total general -->
                    <td class="py-3 px-3 text-center">${totalStats.points}</td>
                    <td class="py-3 px-3 text-center">${totalStats.pg}</td>
                    <td class="py-3 px-3 text-center">${totalStats.pe}</td>
                    <td class="py-3 px-3 text-center">${totalStats.pp}</td>
                    <td class="py-3 px-3 text-center">${totalStats.pj}</td>
                    <td class="py-3 px-3 text-center">${totalStats.efectividad}%</td>
                    <td class="py-3 px-3 text-center">${totalStats.chamigos}</td>
                    <td class="py-3 px-3 text-center">${totalStats.tt}</td>
                    <td class="py-3 px-3 text-center">${totalStats.ausentes}</td>
                </tr>
            `;

            // Renderizar estadísticas agrupadas por año y período
            const sortedYears = Object.keys(playerStatsData.stats.years).sort((a, b) => b - a); // Año descendente

            sortedYears.forEach(year => {
                const yearStats = playerStatsData.stats.years[year];
                
                // Siempre renderizar la fila total del año, incluso si PJ es 0 para el año
                // Esta fila ahora es un resumen, no un toggle
                individualStatsTableBody.innerHTML += `
                    <tr class="bg-gray-300 font-semibold text-gray-700 cursor-pointer toggle-year-button" data-year="${year}">
                        <td class="py-3 px-3 text-center flex items-center justify-center gap-1">
                            <i class="fas fa-plus-square toggle-icon" data-year="${year}"></i>
                            <span>${year}</span>
                        </td>
                        <td class="py-3 px-3 text-center"></td> <!-- Columna Torneo vacía para la fila del año -->
                        <td class="py-3 px-3 text-center">${yearStats.total.points}</td>
                        <td class="py-3 px-3 text-center">${yearStats.total.pg}</td>
                        <td class="py-3 px-3 text-center">${yearStats.total.pe}</td>
                        <td class="py-3 px-3 text-center">${yearStats.total.pp}</td>
                        <td class="py-3 px-3 text-center">${yearStats.total.pj}</td>
                        <td class="py-3 px-3 text-center">${yearStats.total.efectividad}%</td>
                        <td class="py-3 px-3 text-center">${yearStats.total.chamigos}</td>
                        <td class="py-3 px-3 text-center">${yearStats.total.tt}</td>
                        <td class="py-3 px-3 text-center">${yearStats.total.ausentes}</td>
                    </tr>
                `;

                // Fila de Clausura - siempre renderizar si existen datos, incluso si PJ es 0
                const clausuraStats = yearStats.clausura;
                individualStatsTableBody.innerHTML += `
                    <tr class="border-b border-gray-200 hover:bg-gray-100 year-detail-row year-${year} hidden">
                        <td class="py-3 px-3 text-center"></td>
                        <td class="py-3 px-3 text-center">Clausura</td>
                        <td class="py-3 px-3 text-center">${clausuraStats.points}</td>
                        <td class="py-3 px-3 text-center">${clausuraStats.pg}</td>
                        <td class="py-3 px-3 text-center">${clausuraStats.pe}</td>
                        <td class="py-3 px-3 text-center">${clausuraStats.pp}</td>
                        <td class="py-3 px-3 text-center">${clausuraStats.pj}</td>
                        <td class="py-3 px-3 text-center">${clausuraStats.efectividad}%</td>
                        <td class="py-3 px-3 text-center">${clausuraStats.chamigos}</td>
                        <td class="py-3 px-3 text-center">${clausuraStats.tt}</td>
                        <td class="py-3 px-3 text-center">${clausuraStats.ausentes}</td>
                    </tr>
                `;

                // Fila de Apertura - siempre renderizar si existen datos, incluso si PJ es 0
                const aperturaStats = yearStats.apertura;
                individualStatsTableBody.innerHTML += `
                    <tr class="border-b border-gray-200 hover:bg-gray-100 year-detail-row year-${year} hidden">
                        <td class="py-3 px-3 text-center"></td>
                        <td class="py-3 px-3 text-center">Apertura</td>
                        <td class="py-3 px-3 text-center">${aperturaStats.points}</td>
                        <td class="py-3 px-3 text-center">${aperturaStats.pg}</td>
                        <td class="py-3 px-3 text-center">${aperturaStats.pe}</td>
                        <td class="py-3 px-3 text-center">${aperturaStats.pp}</td>
                        <td class="py-3 px-3 text-center">${aperturaStats.pj}</td>
                        <td class="py-3 px-3 text-center">${aperturaStats.efectividad}%</td>
                        <td class="py-3 px-3 text-center">${aperturaStats.chamigos}</td>
                        <td class="py-3 px-3 text-center">${aperturaStats.tt}</td>
                        <td class="py-3 px-3 text-center">${aperturaStats.ausentes}</td>
                    </tr>
                `;
            });

            loadingMessage.classList.add('hidden');
            individualStatsTable.classList.remove('hidden');

            // Añadir event listeners para los botones de alternancia DESPUÉS de que el contenido se renderice
            document.querySelectorAll('.toggle-year-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const year = event.currentTarget.dataset.year;
                    // Seleccionar todas las filas de detalle para este año
                    const yearDetailRows = document.querySelectorAll(`.year-detail-row.year-${year}`);
                    const toggleIcon = event.currentTarget.querySelector('.toggle-icon');

                    yearDetailRows.forEach(row => {
                        row.classList.toggle('hidden');
                    });

                    // Alternar icono
                    if (yearDetailRows[0] && yearDetailRows[0].classList.contains('hidden')) {
                        toggleIcon.classList.remove('fa-minus-square');
                        toggleIcon.classList.add('fa-plus-square');
                    } else {
                        toggleIcon.classList.remove('fa-plus-square');
                        toggleIcon.classList.add('fa-minus-square');
                    }
                });
            });
        }


        // --- Event Listeners e Inicialización ---
        document.getElementById('leaderboard-year-select').addEventListener('change', renderLeaderboard);
        document.getElementById('leaderboard-period-select').addEventListener('change', renderLeaderboard);

        document.getElementById('chamigo-year-select').addEventListener('change', renderChamigoTable);
        document.getElementById('chamigo-period-select').addEventListener('change', renderChamigoTable);

        document.getElementById('tt-year-select').addEventListener('change', renderTTTable);
        document.getElementById('tt-period-select').addEventListener('change', renderTTTable);

        document.getElementById('presentismo-year-select').addEventListener('change', renderPresentismoTable);
        document.getElementById('presentismo-period-select').addEventListener('change', renderPresentismoTable);

        document.getElementById('ausentismo-year-select').addEventListener('change', renderAusentismoTable);
        document.getElementById('ausentismo-period-select').addEventListener('change', renderAusentismoTable);
        
        // Event listeners para la clasificación de Estadísticas
        document.getElementById('estadisticas-year-select').addEventListener('change', renderEstadisticasTable);
        document.getElementById('estadisticas-period-select').addEventListener('change', renderEstadisticasTable);
        document.getElementById('estadisticas-sort-criterion').addEventListener('change', renderEstadisticasTable);
        document.getElementById('estadisticas-sort-order').addEventListener('change', renderEstadisticasTable);

        document.getElementById('equipos-year-select').addEventListener('change', renderEquiposStats);
        document.getElementById('equipos-period-select').addEventListener('change', renderEquiposStats);

        // Event listeners para Fixture
        document.getElementById('fixture-year-select').addEventListener('change', renderFixtureMatchCards);
        document.getElementById('fixture-month-select').addEventListener('change', renderFixtureMatchCards);

        hamburgerButton.addEventListener('click', toggleSideMenu);
        overlay.addEventListener('click', () => {
            if (window.innerWidth < 768) {
                toggleSideMenu();
            }
        });

        // Función para aplicar estilos responsivos iniciales
        function applyInitialResponsiveStyles() {
            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                // Vista móvil: barra lateral inicialmente cerrada, hamburguesa visible
                sideMenu.classList.remove('open'); // Asegura que esté traducido hacia afuera
                // No es necesario añadir 'hidden' a sideMenu aquí, su CSS por defecto maneja el estado oculto a través de transform/visibility
                hamburgerButton.classList.remove('hidden'); // Muestra la hamburguesa
                overlay.classList.remove('open'); // Oculta el overlay
                document.body.classList.remove('overflow-hidden'); // Permite el scroll
            } else {
                // Vista de escritorio: barra lateral siempre abierta, hamburguesa oculta
                sideMenu.classList.add('open'); // Asegura que esté traducido hacia adentro y visible
                hamburgerButton.classList.add('hidden'); // Oculta la hamburguesa
                overlay.classList.remove('open'); // Oculta el overlay
                document.body.classList.remove('overflow-hidden'); // Permite el scroll
            }
        }

        // Evento para manejar el redimensionamiento de la ventana
        window.addEventListener('resize', () => {
            // Volver a renderizar los detalles del fixture solo si la pestaña del fixture está activa
            const currentActiveTab = document.querySelector('.tab-button.active');
            if (currentActiveTab && currentActiveTab.dataset.tab === 'fixture-content') {
                const currentMatchCard = document.querySelector('#fixture-matches-cards-container > div.selected');    
                if (currentMatchCard) {
                    const currentMatchId = currentMatchCard.dataset.matchId;
                    renderFixtureDetails(currentMatchId); // Volver a renderizar con la nueva orientación
                } else {
                    // Si no hay partido seleccionado, y es la pestaña del fixture, asegura que el campo se restablezca a la configuración predeterminada del móvil
                    // y los detalles estén ocultos
                    document.getElementById('soccer-field-container').classList.remove('horizontal-layout');
                    document.getElementById('soccer-field-container').querySelectorAll('.goal, .penalty-area, .goal-area').forEach(el => el.classList.remove('horizontal-layout'));
                    document.getElementById('fixture-visual-details-container').classList.add('hidden');
                }
            }
            
            // Siempre aplicar estilos responsivos iniciales al redimensionar para manejar el diseño general y la barra lateral
            applyInitialResponsiveStyles();
        });

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Aplicación LA CLANDE cargada!');
            // Aplicar estilos responsivos iniciales al cargar el DOM
            applyInitialResponsiveStyles();
            
            // Cargar las bibliotecas de Google API. gapiLoaded() se llama cuando https://apis.google.com/js/api.js termina de cargar.
            // Para asegurar el orden y evitar conflictos, es buena práctica que https://apis.google.com/js/api.js sea el primero.
            // La inicialización de la carga de datos comenzará desde gapiLoaded -> initializeGapiClient -> handleDataLoadSuccess.
        });

        // --- Lógica de Colapsado/Expandido para "Seleccionar Torneo" ---
        const setupCollapsibleToggle = (toggleId, collapsibleId, defaultText, visibleTextOverride = null) => {
            const toggleButton = document.getElementById(toggleId);
            const collapsibleContent = document.getElementById(collapsibleId);
            const toggleIcon = toggleButton.querySelector('.toggle-icon');
            const toggleSpan = toggleButton.querySelector('span');

            // Establecer el estado inicial según la clase 'hidden'
            if (collapsibleContent.classList.contains('hidden')) {
                toggleButton.classList.add('hidden-content');
                toggleButton.classList.remove('visible-content');
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
                // Solo establecer defaultText si NO es el toggle del fixture
                if (toggleId !== 'fixture-filter-toggle') {
                    toggleSpan.textContent = defaultText;
                }
            } else {
                toggleButton.classList.add('visible-content');
                toggleButton.classList.remove('hidden-content');
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
                // Solo establecer visibleTextOverride si NO es el toggle del fixture
                if (toggleId !== 'fixture-filter-toggle') {
                    toggleSpan.textContent = visibleTextOverride || `Ocultar ${defaultText}`;
                }
            }

            toggleButton.addEventListener('click', () => {
                // Manejar la lógica de alternancia del fixture específicamente
                if (toggleId === 'fixture-filter-toggle') {
                    // Comprobar si el contenedor de tarjetas de partido está actualmente visible (lo que significa que los detalles están ocultos)
                    if (!collapsibleContent.classList.contains('hidden')) {
                        // El usuario hizo clic para ocultar las tarjetas de partido y mostrar los detalles (si hay un partido seleccionado)
                        collapsibleContent.classList.add('hidden'); // Ocultar tarjetas de partido
                        if (lastSelectedFixtureMatchId) {
                            renderFixtureDetails(lastSelectedFixtureMatchId); // Volver a renderizar el último partido seleccionado
                            fixtureVisualDetailsContainer.classList.remove('hidden'); // Mostrar detalles
                            // El texto y el icono del botón son establecidos por renderFixtureDetails
                        } else {
                            // Si no se seleccionó ningún partido, simplemente mantener los detalles ocultos y mostrar un mensaje
                            fixtureVisualDetailsContainer.classList.add('hidden'); // Asegura que los detalles estén ocultos
                            // Actualizar el texto del botón para indicar que no hay partido seleccionado, pero el contenido está "oculto"
                            toggleSpan.textContent = 'Elegir otro partido';
                            toggleButton.classList.add('hidden-content');
                            toggleButton.classList.remove('visible-content');
                            toggleIcon.classList.remove('fa-chevron-up');
                            toggleIcon.classList.add('fa-chevron-down');
                        }
                    } else {
                        // El usuario hizo clic para ocultar los detalles y mostrar las tarjetas de partido
                        fixtureVisualDetailsContainer.classList.add('hidden'); // Ocultar detalles
                        collapsibleContent.classList.remove('hidden'); // Mostrar tarjetas de partido
                        
                        toggleSpan.textContent = 'Elegir otro partido'; // Restablecer el texto para la vista de lista de partidos
                        toggleButton.classList.add('visible-content'); // El botón indica que el contenido está expandido (tarjetas de partido)
                        toggleButton.classList.remove('hidden-content');
                        toggleIcon.classList.remove('fa-chevron-down');
                        toggleIcon.classList.add('fa-chevron-up');
                    }
                } else { // Lógica original para otras secciones colapsables
                    collapsibleContent.classList.toggle('hidden');
                    if (collapsibleContent.classList.contains('hidden')) {
                        toggleButton.classList.add('hidden-content');
                        toggleButton.classList.remove('visible-content');
                        toggleIcon.classList.remove('fa-chevron-up');
                        toggleIcon.classList.add('fa-chevron-down');
                        toggleSpan.textContent = defaultText;
                    } else {
                        toggleButton.classList.add('visible-content');
                        toggleButton.classList.remove('hidden-content');
                        toggleIcon.classList.remove('fa-chevron-down');
                        toggleIcon.classList.add('fa-chevron-up');
                        toggleSpan.textContent = visibleTextOverride || `Ocultar ${defaultText}`;
                    }
                }
            });

            // Eliminar las clases de degradado existentes del botón, ya que estamos usando colores personalizados
            toggleButton.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-indigo-700');
        };

        // Inicializar todas las secciones colapsables
        setupCollapsibleToggle('leaderboard-filter-toggle', 'leaderboard-filters-collapsible', 'Seleccionar Torneo');
        setupCollapsibleToggle('chamigo-filter-toggle', 'chamigo-filters-collapsible', 'Seleccionar Torneo');
        setupCollapsibleToggle('tt-filter-toggle', 'tt-filters-collapsible', 'Seleccionar Torneo');
        setupCollapsibleToggle('presentismo-filter-toggle', 'presentismo-filters-collapsible', 'Seleccionar Torneo');
        setupCollapsibleToggle('ausentismo-filter-toggle', 'ausentismo-filters-collapsible', 'Seleccionar Torneo');
        setupCollapsibleToggle('estadisticas-filter-toggle', 'estadisticas-filters-collapsible', 'Seleccionar Torneo / Cambiar Orden', 'Seleccionar Torneo / Cambiar Orden');
        setupCollapsibleToggle('equipos-filter-toggle', 'equipos-filters-collapsible', 'Seleccionar Torneo');
        // RE-ADDED y MODIFICADO: Configuración para el toggle del fixture, pero su texto e icono son gestionados por renderFixtureMatchCards/renderFixtureDetails
        setupCollapsibleToggle('fixture-filter-toggle', 'fixture-collapsible-content', 'Elegir otro partido', 'Elegir otro partido');

        // Lógica de Toggle de Modo Oscuro
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const darkModeIcon = document.getElementById('dark-mode-icon');
        // REMOVED: const darkModeText = darkModeToggle.querySelector('span'); // No longer needed as text is removed

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                darkModeIcon.classList.remove('fa-moon');
                darkModeIcon.classList.add('fa-sun');
                // REMOVED: darkModeText.textContent = 'Modo Claro';
            } else {
                document.body.classList.remove('dark-mode');
                darkModeIcon.classList.remove('fa-sun');
                darkModeIcon.classList.add('fa-moon');
                // REMOVED: darkModeText.textContent = 'Modo Oscuro';
            }
            localStorage.setItem('theme', theme);
        }

        // Inicializar tema al cargar
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            // Por defecto a la preferencia del sistema si no hay tema guardado
            applyTheme('dark');
        } else {
            applyTheme('light'); // Por defecto a modo claro
        }

        // Event listener para el botón de alternancia de modo oscuro
        darkModeToggle.addEventListener('click', () => {
            const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            if (currentTheme === 'dark') {
                applyTheme('light');
            } else {
                applyTheme('dark');
            }
        });

    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>
</html>
