<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA CLANDE - Estad√≠sticas de F√∫tbol</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚öΩ</text></svg>">
    
    <style>
        :root {
            --bg-primary: #f4f7fe;
            --bg-secondary: #ffffff;
            --bg-nav: #ffffff;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --accent-color: #4f46e5;
            --accent-color-hover: #4338ca;
            --table-header-bg: #f9fafb;
            --table-row-hover: #f0f2f5;
        }

        html.dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-nav: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
            --accent-color: #6366f1;
            --accent-color-hover: #818cf8;
            --table-header-bg: #1f2937;
            --table-row-hover: #374151;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .table-container {
            max-height: 65vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
        }

        .table-container thead th {
            position: sticky;
            top: 0;
            background-color: var(--table-header-bg);
            z-index: 10;
        }
        
        /* Sticky Columns Styling */
        .sticky-col {
            position: sticky;
            z-index: 5;
            background-color: var(--bg-secondary);
        }
        
        thead .sticky-col {
            background-color: var(--table-header-bg);
            z-index: 15;
        }

        .sticky-col-1 { left: 0; }
        .sticky-col-2 { left: 50px; } /* Adjust based on width of col 1 */

        tbody tr:hover .sticky-col {
            background-color: var(--table-row-hover);
        }

        /* Player search input styling */
        #individual-player-search {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' viewBox='0 0 20 20' fill='%239ca3af'%3E%3Cpath fill-rule='evenodd' d='M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 0.75rem center;
            padding-left: 2.5rem;
        }

        /* Soccer Field Styling */
        #soccer-field-container {
            background-color: #22c55e; /* Green-500 */
            background-image:
                linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 3rem 3rem;
            border: 2px solid #a3a3a3;
        }

        .player-marker {
            transition: all 0.2s ease-in-out;
        }
        .player-marker.claros {
            background-color: #ffffff;
            color: #111827;
            border: 2px solid #111827;
        }
        .player-marker.oscuros {
            background-color: #111827;
            color: #ffffff;
            border: 2px solid #ffffff;
        }
        .player-marker .fa-star {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--bg-secondary);
            border-radius: 50%;
            padding: 2px;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header Navigation -->
    <header class="bg-nav shadow-md sticky top-0 z-30 border-b border-border-color">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <span class="text-2xl">‚öΩ</span>
                    <h1 class="text-xl font-bold text-primary">LA CLANDE</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <nav id="desktop-nav" class="hidden md:flex space-x-2">
                        <!-- Desktop navigation buttons will be injected here by JS -->
                    </nav>
                    <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-moon text-lg text-secondary"></i>
                    </button>
                    <div class="md:hidden">
                        <button id="mobile-menu-button" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-bars text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden border-t border-border-color">
            <nav class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                 <!-- Mobile navigation buttons will be injected here by JS -->
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Tab: Tabla de Posiciones -->
        <div id="leaderboard-content" class="tab-content">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
                <h2 class="text-2xl font-bold tracking-tight">Tabla de Posiciones</h2>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <select id="leaderboard-year-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm"></select>
                    <select id="leaderboard-period-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Anual</option>
                    </select>
                </div>
            </div>
            <div class="card rounded-xl shadow-sm overflow-hidden">
                <div class="table-container">
                    <p id="leaderboard-loading-message" class="p-6 text-center text-secondary">Cargando...</p>
                    <table id="leaderboard-table" class="w-full text-sm text-left hidden">
                        <thead class="text-xs uppercase">
                            <tr>
                                <th scope="col" class="p-4">#</th>
                                <th scope="col" class="p-4">Jugador</th>
                                <th scope="col" class="p-4 text-center">Puntos</th>
                                <th scope="col" class="p-4 text-center">Efectividad</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Estad√≠sticas Generales -->
        <div id="estadisticas-content" class="tab-content hidden">
             <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
                <h2 class="text-2xl font-bold tracking-tight">Estad√≠sticas Generales</h2>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <select id="estadisticas-year-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm"></select>
                    <select id="estadisticas-period-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm">
                        <option value="apertura">Apertura</option>
                        <option value="clausura">Clausura</option>
                        <option value="total">Anual</option>
                    </select>
                </div>
            </div>
            <div class="card rounded-xl shadow-sm overflow-hidden">
                <div class="table-container">
                    <p id="estadisticas-loading-message" class="p-6 text-center text-secondary">Cargando...</p>
                    <table id="estadisticas-table" class="w-full min-w-[800px] text-sm text-left hidden">
                        <thead class="text-xs uppercase">
                            <tr>
                                <th scope="col" class="p-4 sticky-col sticky-col-1">#</th>
                                <th scope="col" class="p-4 sticky-col sticky-col-2">Jugador</th>
                                <th scope="col" class="p-4 text-center">Puntos</th>
                                <th scope="col" class="p-4 text-center">PG</th>
                                <th scope="col" class="p-4 text-center">PE</th>
                                <th scope="col" class="p-4 text-center">PP</th>
                                <th scope="col" class="p-4 text-center">PJ</th>
                                <th scope="col" class="p-4 text-center">Efectividad</th>
                                <th scope="col" class="p-4 text-center">Chamigo</th>
                                <th scope="col" class="p-4 text-center">TT</th>
                                <th scope="col" class="p-4 text-center">Ausentismo</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Tab: Fixture -->
        <div id="fixture-content" class="tab-content hidden">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
                <h2 class="text-2xl font-bold tracking-tight">Fixture</h2>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <select id="fixture-year-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm"></select>
                    <select id="fixture-month-select" class="w-full md:w-auto bg-secondary border-border-color rounded-md shadow-sm"></select>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 card rounded-xl shadow-sm p-4 h-fit">
                    <h3 class="font-semibold mb-3">Partidos del Mes</h3>
                    <div id="fixture-matches-cards-container" class="space-y-2 max-h-[60vh] overflow-y-auto">
                        <p id="fixture-loading-message" class="p-6 text-center text-secondary">Cargando...</p>
                    </div>
                </div>
                <div class="lg:col-span-2 card rounded-xl shadow-sm p-4">
                    <div id="fixture-details-container" class="hidden">
                        <h3 id="fixture-date-header" class="text-lg font-bold text-center mb-4"></h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div id="soccer-field-container" class="relative w-full aspect-[3/4] rounded-lg overflow-hidden">
                                <!-- Field markings will be CSS based -->
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold mb-2">üèÖ Chamigos del Partido</h4>
                                    <div id="chamigos-display" class="text-secondary">Selecciona un partido.</div>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-2">üçª Asistentes al TT</h4>
                                    <div id="tt-attendees-display" class="text-secondary">Selecciona un partido.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="fixture-details-placeholder" class="flex items-center justify-center h-full text-secondary">
                        <p>Selecciona un partido de la lista para ver los detalles.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Historial Individual -->
        <div id="individual-stats-content" class="tab-content hidden">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
                <h2 class="text-2xl font-bold tracking-tight">Historial Individual</h2>
                <div class="relative w-full md:w-72">
                    <input type="text" id="individual-player-search" placeholder="Buscar jugador..." class="w-full bg-secondary border-border-color rounded-md shadow-sm">
                    <div id="individual-player-results" class="absolute z-10 w-full bg-secondary border border-border-color rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
                </div>
            </div>
             <div class="card rounded-xl shadow-sm overflow-hidden">
                <div class="table-container">
                    <p id="individual-stats-loading-message" class="p-6 text-center text-secondary">Busca y selecciona un jugador para ver su historial.</p>
                    <table id="individual-stats-table" class="w-full min-w-[800px] text-sm text-left hidden">
                        <thead class="text-xs uppercase">
                            <tr>
                                <th scope="col" class="p-4 sticky-col sticky-col-1">A√±o</th>
                                <th scope="col" class="p-4 sticky-col sticky-col-2">Torneo</th>
                                <th scope="col" class="p-4 text-center">Puntos</th>
                                <th scope="col" class="p-4 text-center">PG</th>
                                <th scope="col" class="p-4 text-center">PE</th>
                                <th scope="col" class="p-4 text-center">PP</th>
                                <th scope="col" class="p-4 text-center">PJ</th>
                                <th scope="col" class="p-4 text-center">Efectividad</th>
                                <th scope="col" class="p-4 text-center">Chamigo</th>
                                <th scope="col" class="p-4 text-center">TT</th>
                                <th scope="col" class="p-4 text-center">Ausentismo</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & STATE ---
        const SUPABASE_URL = 'https://ezoqqzequstrzemlbsoa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6b3FxemVxdXN0cnplbWxic29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3Mjc4MzEsImV4cCI6MjA2ODMwMzgzMX0.v_i5kI1dXB4FEt-f8I6Fe5MetcktYnOyt7809un0VlQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allPlayers = [];
        let allMatches = [];

        const TABS = [
            { id: 'leaderboard-content', name: 'Posiciones', icon: 'fa-trophy' },
            { id: 'estadisticas-content', name: 'Estad√≠sticas', icon: 'fa-chart-bar' },
            { id: 'fixture-content', name: 'Fixture', icon: 'fa-calendar-alt' },
            { id: 'individual-stats-content', name: 'Hist√≥rico', icon: 'fa-user' }
        ];

        // --- DOM ELEMENTS ---
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const desktopNav = document.getElementById('desktop-nav');
        const mobileNavContainer = mobileMenu.querySelector('nav');

        // --- INITIALIZATION ---
        function init() {
            setupTheme();
            setupNavigation();
            setupEventListeners();
            loadInitialData();
        }

        async function loadInitialData() {
            try {
                const [playersRes, matchesRes] = await Promise.all([
                    supabase.from('players').select('*'),
                    supabase.from('matches').select('*').order('match_date', { ascending: false })
                ]);

                if (playersRes.error) throw playersRes.error;
                if (matchesRes.error) throw matchesRes.error;

                allPlayers = playersRes.data;
                allMatches = matchesRes.data;
                
                populateGlobalFilters();
                handleHashChange(); // Load data for the initial or hashed tab

            } catch (error) {
                console.error("Error loading initial data:", error);
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.querySelector('[id$="-loading-message"]').textContent = 'Error al cargar los datos. Intente recargar la p√°gina.';
                });
            }
        }

        // --- UI & THEME ---
        function setupTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            darkModeToggle.addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                applyTheme(newTheme);
            });
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                darkModeToggle.querySelector('i').classList.replace('fa-moon', 'fa-sun');
            } else {
                document.documentElement.classList.remove('dark');
                darkModeToggle.querySelector('i').classList.replace('fa-sun', 'fa-moon');
            }
            localStorage.setItem('theme', theme);
        }

        function setupNavigation() {
            // Populate nav bars
            desktopNav.innerHTML = TABS.map(tab => `
                <a href="#${tab.id}" data-tab="${tab.id}" class="tab-button px-3 py-2 rounded-md text-sm font-medium">${tab.name}</a>
            `).join('');
            mobileNavContainer.innerHTML = TABS.map(tab => `
                <a href="#${tab.id}" data-tab="${tab.id}" class="tab-button block px-3 py-2 rounded-md text-base font-medium"><i class="fas ${tab.icon} w-5 mr-2"></i>${tab.name}</a>
            `).join('');
            
            // Mobile menu toggle
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });

            // Tab switching logic
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = e.currentTarget.dataset.tab;
                    window.location.hash = '#' + tabId;
                    if (!mobileMenu.classList.contains('hidden')) {
                        mobileMenu.classList.add('hidden');
                    }
                });
            });
            window.addEventListener('hashchange', handleHashChange);
        }

        function handleHashChange() {
            const hash = window.location.hash.substring(1) || TABS[0].id;
            
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.add('hidden'));
            const activeContent = document.getElementById(hash);
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }

            document.querySelectorAll('.tab-button').forEach(tb => {
                tb.classList.toggle('bg-gray-100', tb.dataset.tab === hash);
                tb.classList.toggle('dark:bg-gray-700', tb.dataset.tab === hash);
            });
            
            // Trigger data rendering for the active tab
            const renderFunction = window[`render${hash.charAt(0).toUpperCase() + hash.slice(1).replace('-content', '')}`];
            if (typeof renderFunction === 'function') {
                renderFunction();
            }
        }

        // --- FILTERS & EVENT LISTENERS ---
        function setupEventListeners() {
            document.querySelectorAll('select[id$="-year-select"], select[id$="-period-select"], select[id$="-month-select"]').forEach(select => {
                select.addEventListener('change', () => {
                    const tabId = select.closest('.tab-content').id;
                    const renderFunction = window[`render${tabId.charAt(0).toUpperCase() + tabId.slice(1).replace('-content', '')}`];
                    if (typeof renderFunction === 'function') {
                        renderFunction();
                    }
                });
            });
            setupPlayerSearch();
        }

        function populateGlobalFilters() {
            const years = [...new Set(allMatches.map(m => new Date(m.match_date).getFullYear()))].sort((a, b) => b - a);
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            document.querySelectorAll('select[id$="-year-select"]').forEach(select => {
                select.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
            });
            
            const fixtureMonthSelect = document.getElementById('fixture-month-select');
            fixtureMonthSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');

            // Set to current period by default
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-11
            const currentPeriod = currentMonth < 6 ? 'apertura' : 'clausura';

            document.querySelectorAll('select[id$="-year-select"]').forEach(s => { if(s.querySelector(`option[value="${currentYear}"]`)) s.value = currentYear; });
            document.querySelectorAll('select[id$="-period-select"]').forEach(s => s.value = currentPeriod);
            fixtureMonthSelect.value = currentMonth;
        }

        // --- DATA CALCULATION ---
        function getStatsForPeriod(year, period) {
            const filteredMatches = allMatches.filter(match => {
                const matchDate = new Date(match.match_date);
                const matchYear = matchDate.getFullYear();
                const matchMonth = matchDate.getMonth(); // 0-11
                
                if (matchYear != year) return false;
                if (period === 'total') return true;
                if (period === 'apertura') return matchMonth < 6;
                if (period === 'clausura') return matchMonth >= 6;
                return false;
            });

            const stats = {};
            allPlayers.forEach(p => {
                stats[p.id] = { name: p.name, id: p.id, points: 0, pg: 0, pe: 0, pp: 0, pj: 0, chamigos: 0, tt: 0 };
            });

            const totalPlayedMatches = filteredMatches.filter(m => m.result !== 'Suspendido').length;

            filteredMatches.forEach(match => {
                const playersInMatch = [...(match.team_white_players || []), ...(match.team_dark_players || [])];
                playersInMatch.forEach(pId => {
                    if (!stats[pId]) return;
                    if (match.result !== 'Suspendido') {
                        stats[pId].pj++;
                        if ((match.result === 'Claros' && match.team_white_players.includes(pId)) || (match.result === 'Oscuros' && match.team_dark_players.includes(pId))) {
                            stats[pId].points += 3;
                            stats[pId].pg++;
                        } else if (match.result === 'Empate') {
                            stats[pId].points += 1;
                            stats[pId].pe++;
                        } else {
                            stats[pId].pp++;
                        }
                    }
                });

                if (match.chamigo_votes) {
                    const maxVotes = Math.max(...Object.values(match.chamigo_votes));
                    Object.entries(match.chamigo_votes).forEach(([pId, votes]) => {
                        if (votes === maxVotes && stats[pId]) stats[pId].chamigos++;
                    });
                }
                if (match.tt_attendees) {
                    match.tt_attendees.forEach(pId => { if(stats[pId]) stats[pId].tt++; });
                }
            });

            return Object.values(stats).map(s => ({
                ...s,
                efectividad: s.pj > 0 ? ((s.points / (s.pj * 3)) * 100).toFixed(2) : "0.00",
                ausentes: totalPlayedMatches - s.pj
            }));
        }

        // --- RENDER FUNCTIONS ---
        function renderLeaderboard() {
            const year = document.getElementById('leaderboard-year-select').value;
            const period = document.getElementById('leaderboard-period-select').value;
            const tableBody = document.querySelector('#leaderboard-table tbody');
            const loadingMsg = document.getElementById('leaderboard-loading-message');
            const table = document.getElementById('leaderboard-table');
            
            loadingMsg.classList.remove('hidden');
            table.classList.add('hidden');

            const stats = getStatsForPeriod(year, period);
            const rankedPlayers = stats.filter(p => p.pj > 0).sort((a, b) => b.points - a.points || b.efectividad - a.efectividad);

            tableBody.innerHTML = rankedPlayers.map((p, i) => `
                <tr class="border-b border-border-color hover:bg-table-row-hover">
                    <td class="p-4 text-secondary">${i + 1}</td>
                    <td class="p-4 font-medium">${p.name}</td>
                    <td class="p-4 text-center font-semibold">${p.points}</td>
                    <td class="p-4 text-center text-secondary">${p.efectividad}%</td>
                </tr>
            `).join('');

            loadingMsg.classList.add('hidden');
            table.classList.remove('hidden');
        }

        function renderEstadisticas() {
            const year = document.getElementById('estadisticas-year-select').value;
            const period = document.getElementById('estadisticas-period-select').value;
            const tableBody = document.querySelector('#estadisticas-table tbody');
            const loadingMsg = document.getElementById('estadisticas-loading-message');
            const table = document.getElementById('estadisticas-table');

            loadingMsg.classList.remove('hidden');
            table.classList.add('hidden');

            const stats = getStatsForPeriod(year, period);
            const rankedPlayers = stats.filter(p => p.pj > 0).sort((a, b) => b.points - a.points);
            
            tableBody.innerHTML = rankedPlayers.map((p, i) => `
                <tr class="border-b border-border-color hover:bg-table-row-hover">
                    <td class="p-4 text-secondary sticky-col sticky-col-1">${i + 1}</td>
                    <td class="p-4 font-medium sticky-col sticky-col-2">${p.name}</td>
                    <td class="p-4 text-center font-semibold">${p.points}</td>
                    <td class="p-4 text-center text-secondary">${p.pg}</td>
                    <td class="p-4 text-center text-secondary">${p.pe}</td>
                    <td class="p-4 text-center text-secondary">${p.pp}</td>
                    <td class="p-4 text-center text-secondary">${p.pj}</td>
                    <td class="p-4 text-center text-secondary">${p.efectividad}%</td>
                    <td class="p-4 text-center text-secondary">${p.chamigos}</td>
                    <td class="p-4 text-center text-secondary">${p.tt}</td>
                    <td class="p-4 text-center text-secondary">${p.ausentes}</td>
                </tr>
            `).join('');

            loadingMsg.classList.add('hidden');
            table.classList.remove('hidden');
        }

        function renderFixture() {
            const year = document.getElementById('fixture-year-select').value;
            const month = document.getElementById('fixture-month-select').value;
            const cardsContainer = document.getElementById('fixture-matches-cards-container');
            const loadingMsg = document.getElementById('fixture-loading-message');

            loadingMsg.classList.remove('hidden');
            cardsContainer.innerHTML = '';
            document.getElementById('fixture-details-container').classList.add('hidden');
            document.getElementById('fixture-details-placeholder').classList.remove('hidden');

            const filteredMatches = allMatches.filter(match => {
                const matchDate = new Date(match.match_date);
                return matchDate.getFullYear() == year && matchDate.getMonth() == month;
            });

            if (filteredMatches.length === 0) {
                loadingMsg.textContent = 'No hay partidos para este mes.';
                return;
            }

            cardsContainer.innerHTML = filteredMatches.map(match => {
                const matchDate = new Date(match.match_date);
                const formattedDate = matchDate.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC' });
                let resultText = '';
                if (match.result === 'Suspendido') {
                    resultText = `<span class="text-xs text-red-500">Suspendido</span>`;
                } else if (match.result) {
                    resultText = `<span class="text-xs font-bold">Gan√≥ ${match.result}</span>`;
                } else {
                    resultText = `<span class="text-xs text-secondary">Pendiente</span>`;
                }
                return `
                    <div class="fixture-match-item p-3 rounded-lg border border-border-color hover:bg-table-row-hover cursor-pointer" data-match-id="${match.id}">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">${formattedDate}</span>
                            ${resultText}
                        </div>
                    </div>
                `;
            }).join('');
            
            cardsContainer.querySelectorAll('.fixture-match-item').forEach(card => {
                card.addEventListener('click', (e) => {
                    document.querySelectorAll('.fixture-match-item').forEach(c => c.classList.remove('bg-indigo-50', 'dark:bg-indigo-900/50', 'border-accent-color'));
                    e.currentTarget.classList.add('bg-indigo-50', 'dark:bg-indigo-900/50', 'border-accent-color');
                    renderFixtureDetails(e.currentTarget.dataset.matchId);
                });
            });

            loadingMsg.classList.add('hidden');
        }

        function renderFixtureDetails(matchId) {
            const match = allMatches.find(m => m.id == matchId);
            if (!match) return;

            const getPlayerName = id => (allPlayers.find(p => p.id === id) || {name: '?'}).name;
            
            document.getElementById('fixture-details-placeholder').classList.add('hidden');
            document.getElementById('fixture-details-container').classList.remove('hidden');
            
            const matchDate = new Date(match.match_date).toLocaleDateString('es-AR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
            document.getElementById('fixture-date-header').textContent = matchDate;

            // Render field
            const fieldContainer = document.getElementById('soccer-field-container');
            fieldContainer.innerHTML = ''; // Clear previous
            const positions = [{x:'50%',y:'85%'},{x:'25%',y:'65%'},{x:'75%',y:'65%'},{x:'40%',y:'50%'},{x:'60%',y:'50%'}];
            
            (match.team_white_players || []).forEach((pId, i) => {
                const playerEl = document.createElement('div');
                playerEl.className = 'player-wrapper absolute flex flex-col items-center';
                playerEl.style.left = positions[i].x;
                playerEl.style.top = positions[i].y;
                playerEl.style.transform = 'translate(-50%, -50%)';
                playerEl.innerHTML = `
                    <div class="player-marker claros w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs shadow-lg relative">
                        ${pId.replace('J','')}
                        ${(match.chamigo_votes && Object.keys(match.chamigo_votes).includes(pId)) ? '<i class="fas fa-star text-yellow-400"></i>' : ''}
                    </div>
                    <span class="text-xs mt-1 bg-white/80 dark:bg-black/80 px-1 rounded">${getPlayerName(pId)}</span>`;
                fieldContainer.appendChild(playerEl);
            });
            (match.team_dark_players || []).forEach((pId, i) => {
                const playerEl = document.createElement('div');
                playerEl.className = 'player-wrapper absolute flex flex-col items-center';
                playerEl.style.left = positions[i].x;
                playerEl.style.top = `${100 - parseInt(positions[i].y)}%`;
                playerEl.style.transform = 'translate(-50%, -50%)';
                playerEl.innerHTML = `
                    <div class="player-marker oscuros w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs shadow-lg relative">
                        ${pId.replace('J','')}
                        ${(match.chamigo_votes && Object.keys(match.chamigo_votes).includes(pId)) ? '<i class="fas fa-star text-yellow-400"></i>' : ''}
                    </div>
                    <span class="text-xs mt-1 bg-white/80 dark:bg-black/80 px-1 rounded">${getPlayerName(pId)}</span>`;
                fieldContainer.appendChild(playerEl);
            });

            // Render Chamigos & TT
            const chamigosDiv = document.getElementById('chamigos-display');
            if (match.chamigo_votes && Object.keys(match.chamigo_votes).length > 0) {
                const maxVotes = Math.max(...Object.values(match.chamigo_votes));
                const chamigos = Object.entries(match.chamigo_votes).filter(([, votes]) => votes === maxVotes).map(([pId]) => getPlayerName(pId));
                chamigosDiv.innerHTML = `<p>${chamigos.join(', ')}</p>`;
            } else {
                chamigosDiv.innerHTML = `<p class="text-secondary">Sin votos registrados.</p>`;
            }
            
            const ttDiv = document.getElementById('tt-attendees-display');
            if (match.tt_attendees && match.tt_attendees.length > 0) {
                ttDiv.innerHTML = `<p>${match.tt_attendees.map(pId => getPlayerName(pId)).join(', ')}</p>`;
            } else {
                ttDiv.innerHTML = `<p class="text-secondary">Sin asistentes registrados.</p>`;
            }
        }

        function renderIndividualStats() {
            const tableBody = document.querySelector('#individual-stats-table tbody');
            const loadingMsg = document.getElementById('individual-stats-loading-message');
            const table = document.getElementById('individual-stats-table');
            const playerId = document.getElementById('individual-player-search').dataset.selectedId;

            table.classList.add('hidden');
            if (!playerId) {
                loadingMsg.textContent = 'Busca y selecciona un jugador para ver su historial.';
                loadingMsg.classList.remove('hidden');
                return;
            }
            loadingMsg.classList.remove('hidden');
            
            const playerMatches = allMatches.filter(m => (m.team_white_players || []).includes(playerId) || (m.team_dark_players || []).includes(playerId));
            
            const statsByYear = {};
            playerMatches.forEach(match => {
                const year = new Date(match.match_date).getFullYear();
                const period = new Date(match.match_date).getMonth() < 6 ? 'apertura' : 'clausura';
                if (!statsByYear[year]) {
                    statsByYear[year] = { 
                        apertura: {pj:0,pg:0,pe:0,pp:0,points:0,chamigos:0,tt:0},
                        clausura: {pj:0,pg:0,pe:0,pp:0,points:0,chamigos:0,tt:0}
                    };
                }
                const periodStats = statsByYear[year][period];
                // Simplified stat calculation for individual view
                if(match.result !== 'Suspendido') {
                    periodStats.pj++;
                    if ((match.result === 'Claros' && match.team_white_players.includes(playerId)) || (match.result === 'Oscuros' && match.team_dark_players.includes(playerId))) {
                        periodStats.points += 3; periodStats.pg++;
                    } else if (match.result === 'Empate') {
                        periodStats.points += 1; periodStats.pe++;
                    } else {
                        periodStats.pp++;
                    }
                }
            });

            let html = '';
            Object.keys(statsByYear).sort((a,b) => b-a).forEach(year => {
                const yearData = statsByYear[year];
                // Render rows for apertura, clausura, and total for the year
                // This part can be expanded to show full details
                 html += `
                    <tr class="border-b border-border-color hover:bg-table-row-hover">
                        <td class="p-4 font-medium sticky-col sticky-col-1">${year}</td>
                        <td class="p-4 sticky-col sticky-col-2">Apertura</td>
                        <td class="p-4 text-center">${yearData.apertura.points}</td>
                        <td class="p-4 text-center">${yearData.apertura.pg}</td>
                        <td class="p-4 text-center">${yearData.apertura.pe}</td>
                        <td class="p-4 text-center">${yearData.apertura.pp}</td>
                        <td class="p-4 text-center">${yearData.apertura.pj}</td>
                        <td class="p-4 text-center">...</td>
                        <td class="p-4 text-center">...</td>
                        <td class="p-4 text-center">...</td>
                        <td class="p-4 text-center">...</td>
                    </tr>
                     <tr class="border-b border-border-color hover:bg-table-row-hover">
                        <td class="p-4 font-medium sticky-col sticky-col-1">${year}</td>
                        <td class="p-4 sticky-col sticky-col-2">Clausura</td>
                        <td class="p-4 text-center">${yearData.clausura.points}</td>
                        <td class="p-4 text-center">${yearData.clausura.pg}</td>
                        <td class="p-4 text-center">${yearData.clausura.pe}</td>
                        <td class="p-4 text-center">${yearData.clausura.pp}</td>
                        <td class="p-4 text-center">${yearData.clausura.pj}</td>
                        <td class="p-4 text-center">...</td>
                        <td class="p-4 text-center">...</td>
                        <td class="p-4 text-center">...</td>
                        <td class="p-4 text-center">...</td>
                    </tr>
                 `;
            });
            
            tableBody.innerHTML = html;
            loadingMsg.classList.add('hidden');
            table.classList.remove('hidden');
        }

        function setupPlayerSearch() {
            const searchInput = document.getElementById('individual-player-search');
            const resultsDiv = document.getElementById('individual-player-results');

            searchInput.addEventListener('input', () => {
                const term = searchInput.value.toLowerCase();
                if (term.length < 2) {
                    resultsDiv.classList.add('hidden');
                    return;
                }
                const filteredPlayers = allPlayers.filter(p => p.name.toLowerCase().includes(term));
                resultsDiv.innerHTML = filteredPlayers.map(p => 
                    `<div class="p-2 cursor-pointer hover:bg-table-row-hover" data-id="${p.id}" data-name="${p.name}">${p.name}</div>`
                ).join('');
                resultsDiv.classList.remove('hidden');
            });

            resultsDiv.addEventListener('click', (e) => {
                if(e.target.dataset.id) {
                    searchInput.value = e.target.dataset.name;
                    searchInput.dataset.selectedId = e.target.dataset.id;
                    resultsDiv.classList.add('hidden');
                    renderIndividualStats();
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.classList.add('hidden');
                }
            });
        }

        // --- RUN APP ---
        init();
    });
    </script>
</body>
</html>
